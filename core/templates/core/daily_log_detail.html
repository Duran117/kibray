{% extends "core/base_modern.html" %}
{% load static i18n %}

{% block extra_css %}
<style>
  .premium-header {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
  }
  .info-card {
    background: white;
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,0.04);
    box-shadow: 0 4px 24px -4px rgba(0,0,0,0.08);
    overflow: hidden;
    margin-bottom: 1.5rem;
  }
  .info-card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.04);
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .info-card-body {
    padding: 1.5rem;
  }
  .stat-box {
    background: #f8fafc;
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
    transition: all 0.2s ease;
  }
  .stat-box:hover {
    background: #f1f5f9;
  }
  .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.75rem;
    font-size: 1.25rem;
  }
  .photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
  }
  .photo-item {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    aspect-ratio: 4/3;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .photo-item:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  }
  .photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .photo-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    padding: 1rem 0.75rem 0.75rem;
    color: white;
  }
  .status-badge {
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 0.8125rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .status-published {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
  }
  .status-draft {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
  }
  .section-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #64748b;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .alert-section {
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
  }
  .alert-danger-soft {
    background: #fef2f2;
    border: 1px solid #fecaca;
  }
  .alert-warning-soft {
    background: #fffbeb;
    border: 1px solid #fde68a;
  }
  .alert-info-soft {
    background: #eff6ff;
    border: 1px solid #bfdbfe;
  }
  .btn-back {
    background: white;
    border: 1px solid #e2e8f0;
    color: #475569;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-weight: 500;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .btn-back:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
    color: #1e293b;
  }
  .btn-delete {
    background: white;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-weight: 500;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .btn-delete:hover {
    background: #fef2f2;
    border-color: #f87171;
    color: #b91c1c;
  }
  .meta-item {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f1f5f9;
  }
  .meta-item:last-child {
    border-bottom: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="max-width: 1400px;">
  
  <!-- Premium Header -->
  <div class="premium-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
      <div>
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb" class="mb-3">
          <ol class="breadcrumb mb-0" style="font-size: 0.875rem;">
            {% if request.user.profile.role == 'client' %}
            <li class="breadcrumb-item"><a href="{% url 'dashboard_client' %}?project_id={{ project.id }}" class="text-slate-400 text-decoration-none">{% trans "My Projects" %}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'client_project_view' project.id %}" class="text-slate-400 text-decoration-none">{{ project.name }}</a></li>
            {% else %}
            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}" class="text-slate-400 text-decoration-none">{% trans "Dashboard" %}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'project_overview' project.id %}" class="text-slate-400 text-decoration-none">{{ project.name }}</a></li>
            {% endif %}
            <li class="breadcrumb-item"><a href="{% url 'daily_log' project.id %}" class="text-slate-400 text-decoration-none">{% trans "Daily Logs" %}</a></li>
            <li class="breadcrumb-item text-white">{{ log.date|date:"M d, Y" }}</li>
          </ol>
        </nav>
        <h1 class="text-white mb-2" style="font-size: 1.75rem; font-weight: 600;">
          <i class="bi bi-journal-text me-2 opacity-75"></i>{% trans "Daily Log" %}
        </h1>
        <p class="text-slate-300 mb-0" style="font-size: 1.125rem;">{{ log.date|date:"l, F j, Y" }}</p>
      </div>
      {% if log.is_published %}
      <span class="status-badge status-published">
        <i class="bi bi-check-circle-fill"></i> {% trans "Published" %}
      </span>
      {% else %}
      <span class="status-badge status-draft">
        <i class="bi bi-eye-slash-fill"></i> {% trans "Draft" %}
      </span>
      {% endif %}
    </div>
  </div>

  <div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
      
      <!-- Stats Row -->
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="stat-box">
            <div class="stat-icon bg-sky-100 text-sky-600">
              <i class="bi bi-cloud-sun-fill"></i>
            </div>
            <p class="text-slate-500 mb-1" style="font-size: 0.75rem;">{% trans "Weather" %}</p>
            <p class="fw-semibold text-slate-800 mb-0">{{ log.weather|default:"Not specified" }}</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-box">
            <div class="stat-icon bg-blue-100 text-blue-600">
              <i class="bi bi-people-fill"></i>
            </div>
            <p class="text-slate-500 mb-1" style="font-size: 0.75rem;">{% trans "Crew" %}</p>
            <p class="fw-semibold text-slate-800 mb-0">{{ log.crew_count }} {% trans "person" %}{{ log.crew_count|pluralize }}</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-box">
            <div class="stat-icon bg-emerald-100 text-emerald-600">
              <i class="bi bi-person-circle"></i>
            </div>
            <p class="text-slate-500 mb-1" style="font-size: 0.75rem;">{% trans "Created by" %}</p>
            <p class="fw-semibold text-slate-800 mb-0">{{ log.created_by.username }}</p>
          </div>
        </div>
      </div>

      <!-- Progress Notes -->
      {% if log.progress_notes %}
      <div class="info-card">
        <div class="info-card-header">
          <i class="bi bi-clipboard-check text-slate-500"></i>
          <h3 class="mb-0" style="font-size: 1rem; font-weight: 600;">{% trans "Progress Notes" %}</h3>
        </div>
        <div class="info-card-body">
          <p style="white-space: pre-wrap; color: #334155; line-height: 1.7;">{{ log.progress_notes }}</p>
        </div>
      </div>
      {% endif %}

      <!-- Accomplishments -->
      {% if log.accomplishments %}
      <div class="info-card">
        <div class="info-card-header" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
          <i class="bi bi-trophy-fill text-amber-600"></i>
          <h3 class="mb-0 text-amber-900" style="font-size: 1rem; font-weight: 600;">{% trans "Today's Accomplishments" %}</h3>
        </div>
        <div class="info-card-body">
          <p style="white-space: pre-wrap; color: #334155; line-height: 1.7;">{{ log.accomplishments }}</p>
        </div>
      </div>
      {% endif %}

      <!-- Schedule Progress (Legacy single item) -->
      {% if log.schedule_progress_percent %}
      <div class="info-card">
        <div class="info-card-header">
          <i class="bi bi-graph-up-arrow text-emerald-500"></i>
          <h3 class="mb-0" style="font-size: 1rem; font-weight: 600;">{% trans "Schedule Progress" %}</h3>
        </div>
        <div class="info-card-body">
          {% if log.schedule_item %}
          <p class="text-slate-600 mb-3">{{ log.schedule_item.title }}</p>
          {% endif %}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-slate-600">{% trans "Progress" %}</span>
            <span class="fw-bold text-emerald-600" style="font-size: 1.5rem;">{{ log.schedule_progress_percent|floatformat:0 }}%</span>
          </div>
          <div class="progress" style="height: 10px; border-radius: 5px; background: #e2e8f0;">
            <div class="progress-bar" role="progressbar" 
                 style="width: {{ log.schedule_progress_percent }}%; background: linear-gradient(90deg, #10b981 0%, #059669 100%); border-radius: 5px;">
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Multiple Schedule Progress (V2) -->
      {% if schedule_progress_entries %}
      <div class="info-card">
        <div class="info-card-header" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);">
          <i class="bi bi-kanban-fill text-emerald-600"></i>
          <h3 class="mb-0 text-emerald-800" style="font-size: 1rem; font-weight: 600;">{% trans "Activities Progress" %}</h3>
          <span class="badge bg-emerald-100 text-emerald-700 ms-auto" style="font-size: 0.75rem;">{{ schedule_progress_entries|length }}</span>
        </div>
        <div class="info-card-body p-0">
          {% for entry in schedule_progress_entries %}
          <div class="px-4 py-3 {% if not forloop.last %}border-bottom{% endif %}" style="border-color: #f1f5f9 !important;">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-slate-100 text-slate-600" style="font-size: 0.6875rem;">
                  {% if entry.schedule_item.phase %}{{ entry.schedule_item.phase.name }}{% endif %}
                </span>
                <span class="fw-semibold text-slate-800">{{ entry.schedule_item.name }}</span>
              </div>
              <span class="fw-bold {% if entry.progress_percent >= 100 %}text-emerald-600{% elif entry.progress_percent >= 50 %}text-amber-600{% else %}text-slate-600{% endif %}" style="font-size: 1.125rem;">
                {{ entry.progress_percent|default:0 }}%
              </span>
            </div>
            <div class="progress mb-2" style="height: 6px; border-radius: 3px; background: #e2e8f0;">
              <div class="progress-bar" role="progressbar" 
                   style="width: {{ entry.progress_percent|default:0 }}%; background: {% if entry.progress_percent >= 100 %}linear-gradient(90deg, #10b981, #059669){% elif entry.progress_percent >= 50 %}linear-gradient(90deg, #f59e0b, #d97706){% else %}linear-gradient(90deg, #6366f1, #4f46e5){% endif %}; border-radius: 3px;">
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              {% if entry.hours_worked %}
              <span class="text-slate-500" style="font-size: 0.8125rem;">
                <i class="bi bi-clock me-1"></i>{{ entry.hours_worked }} {% trans "hours" %}
              </span>
              {% endif %}
              {% if entry.notes %}
              <span class="text-slate-500" style="font-size: 0.8125rem;" title="{{ entry.notes }}">
                <i class="bi bi-chat-text me-1"></i>{{ entry.notes|truncatechars:30 }}
              </span>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Photos Gallery -->
      {% if log.photos.count > 0 %}
      <div class="info-card">
        <div class="info-card-header">
          <i class="bi bi-camera-fill text-purple-500"></i>
          <h3 class="mb-0" style="font-size: 1rem; font-weight: 600;">{% trans "Photos" %}</h3>
          <span class="badge bg-purple-100 text-purple-700 ms-auto" style="font-size: 0.75rem;">{{ log.photos.count }}</span>
        </div>
        <div class="info-card-body">
          <div class="photo-grid">
            {% for photo in log.photos.all %}
            <div class="photo-item" data-photo-index="{{ forloop.counter0 }}" style="cursor: pointer;">
              <img src="{{ photo.image.url }}" alt="{{ photo.caption|default:'Photo' }}">
              <div class="photo-overlay">
                <p class="mb-0" style="font-size: 0.75rem;">
                  <i class="bi bi-clock me-1"></i>{{ photo.uploaded_at|date:"h:i A" }}
                  {% if photo.uploaded_by %} Â· {{ photo.uploaded_by.username }}{% endif %}
                </p>
              </div>
            </div>
            {% endfor %}
          </div>

          <!-- Add More Photos Form -->
          {% if can_edit %}
          <hr class="my-4" style="border-color: #e2e8f0;">
          <p class="section-title"><i class="bi bi-plus-circle"></i> {% trans "Add More Photos" %}</p>
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row g-2">
              <div class="col-md-6">
                <input type="file" name="photos" class="form-control" accept="image/*" multiple required 
                       style="border-radius: 8px; border-color: #e2e8f0;">
              </div>
              <div class="col-md-4">
                <input type="text" name="caption" class="form-control" placeholder="{% trans 'Description...' %}"
                       style="border-radius: 8px; border-color: #e2e8f0;">
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn w-100" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; border-radius: 8px;">
                  <i class="bi bi-upload"></i>
                </button>
              </div>
            </div>
          </form>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Completed Tasks -->
      {% if log.completed_tasks.count > 0 %}
      <div class="info-card">
        <div class="info-card-header">
          <i class="bi bi-check2-square text-blue-500"></i>
          <h3 class="mb-0" style="font-size: 1rem; font-weight: 600;">{% trans "Completed Tasks" %}</h3>
          <span class="badge bg-blue-100 text-blue-700 ms-auto" style="font-size: 0.75rem;">{{ log.completed_tasks.count }}</span>
        </div>
        <div class="info-card-body p-0">
          {% for task in log.completed_tasks.all %}
          <div class="d-flex justify-content-between align-items-center px-4 py-3 {% if not forloop.last %}border-bottom{% endif %}" style="border-color: #f1f5f9 !important;">
            <div class="d-flex align-items-center gap-3">
              <div class="rounded-circle bg-emerald-100 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                <i class="bi bi-check-lg text-emerald-600"></i>
              </div>
              <div>
                <p class="mb-0 fw-medium text-slate-800">{{ task.title }}</p>
                {% if task.assigned_to %}
                <p class="mb-0 text-slate-500" style="font-size: 0.8125rem;">{{ task.assigned_to }}</p>
                {% endif %}
              </div>
            </div>
            <span class="badge {% if task.status == 'completed' %}bg-emerald-100 text-emerald-700{% elif task.status == 'in_progress' %}bg-amber-100 text-amber-700{% else %}bg-slate-100 text-slate-600{% endif %}" style="font-size: 0.75rem;">
              {{ task.get_status_display }}
            </span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      
      <!-- Safety Incidents -->
      {% if log.safety_incidents %}
      <div class="alert-section alert-danger-soft mb-4">
        <p class="section-title text-red-700 mb-2">
          <i class="bi bi-exclamation-triangle-fill"></i> {% trans "Safety Incidents" %}
        </p>
        <p class="mb-0 text-red-800" style="white-space: pre-wrap; line-height: 1.6;">{{ log.safety_incidents }}</p>
      </div>
      {% endif %}

      <!-- Delays -->
      {% if log.delays %}
      <div class="alert-section alert-warning-soft mb-4">
        <p class="section-title text-amber-700 mb-2">
          <i class="bi bi-clock-history"></i> {% trans "Delays or Issues" %}
        </p>
        <p class="mb-0 text-amber-800" style="white-space: pre-wrap; line-height: 1.6;">{{ log.delays }}</p>
      </div>
      {% endif %}

      <!-- Next Day Plan -->
      {% if log.next_day_plan %}
      <div class="alert-section alert-info-soft mb-4">
        <p class="section-title text-blue-700 mb-2">
          <i class="bi bi-calendar-plus"></i> {% trans "Plan for Tomorrow" %}
        </p>
        <p class="mb-0 text-blue-800" style="white-space: pre-wrap; line-height: 1.6;">{{ log.next_day_plan }}</p>
      </div>
      {% endif %}

      <!-- Metadata Card - Show details for staff, simplified for clients -->
      {% if request.user.profile.role != 'client' %}
      <div class="info-card">
        <div class="info-card-header">
          <i class="bi bi-info-circle text-slate-500"></i>
          <h3 class="mb-0" style="font-size: 1rem; font-weight: 600;">{% trans "Information" %}</h3>
        </div>
        <div class="info-card-body py-2">
          <div class="meta-item">
            <span class="text-slate-500">{% trans "Created" %}</span>
            <span class="text-slate-800">{{ log.created_at|date:"M d, Y h:i A" }}</span>
          </div>
          <div class="meta-item">
            <span class="text-slate-500">{% trans "Last update" %}</span>
            <span class="text-slate-800">{{ log.updated_at|date:"M d, Y h:i A" }}</span>
          </div>
          <div class="meta-item">
            <span class="text-slate-500">{% trans "Status" %}</span>
            {% if log.is_published %}
            <span class="badge bg-emerald-100 text-emerald-700" style="font-size: 0.75rem;">{% trans "Visible to Client/Owner" %}</span>
            {% else %}
            <span class="badge bg-amber-100 text-amber-700" style="font-size: 0.75rem;">{% trans "Only visible to PM/Staff" %}</span>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Actions -->
      <div class="d-grid gap-2 mt-4">
        <a href="{% url 'daily_log' project.id %}" class="btn-back">
          <i class="bi bi-arrow-left"></i> {% trans "Dashboard" %}
        </a>
        {% if can_edit %}
        <a href="{% url 'daily_log_delete' log.id %}" class="btn-delete">
          <i class="bi bi-trash3"></i> {% trans "Delete Daily Log" %}
        </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Premium Photo Gallery Modal -->
{% if log.photos.count > 0 %}
<div class="modal fade" id="photoGalleryModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content" style="background: rgba(0,0,0,0.95);">
      
      <!-- Header -->
      <div class="modal-header border-0 position-absolute w-100" style="z-index: 10; background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);">
        <div class="d-flex align-items-center gap-3">
          <span class="text-white fw-medium" id="galleryTitle">Photo</span>
          <span class="badge bg-white bg-opacity-25 text-white" id="galleryCounter">1 / {{ log.photos.count }}</span>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Main Image Container -->
      <div class="modal-body d-flex align-items-center justify-content-center p-0 position-relative">
        
        <!-- Previous Button -->
        <button type="button" class="btn position-absolute start-0 top-50 translate-middle-y ms-3 gallery-nav-btn" id="prevPhoto" style="z-index: 10;">
          <i class="bi bi-chevron-left text-white" style="font-size: 2rem;"></i>
        </button>

        <!-- Image Container with Pan/Drag -->
        <div id="imageContainer" class="text-center position-relative" style="max-width: 90vw; max-height: 85vh; overflow: hidden; cursor: grab;">
          <img id="galleryImage" src="" alt="" class="gallery-main-image" 
               style="max-width: 100%; max-height: 85vh; object-fit: contain; transition: transform 0.15s ease; transform-origin: center center; user-select: none; -webkit-user-drag: none;">
        </div>

        <!-- Next Button -->
        <button type="button" class="btn position-absolute end-0 top-50 translate-middle-y me-3 gallery-nav-btn" id="nextPhoto" style="z-index: 10;">
          <i class="bi bi-chevron-right text-white" style="font-size: 2rem;"></i>
        </button>
      </div>

      <!-- Bottom Controls -->
      <div class="modal-footer border-0 position-absolute bottom-0 w-100 justify-content-center gap-3" style="z-index: 10; background: linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 100%); padding: 1.5rem;">
        
        <!-- Zoom Controls -->
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-outline-light btn-sm" id="zoomOut" title="Zoom Out">
            <i class="bi bi-zoom-out"></i>
          </button>
          <button type="button" class="btn btn-outline-light btn-sm" id="zoomReset" title="Reset Zoom">
            <span style="font-size: 0.75rem;">100%</span>
          </button>
          <button type="button" class="btn btn-outline-light btn-sm" id="zoomIn" title="Zoom In">
            <i class="bi bi-zoom-in"></i>
          </button>
        </div>

        <!-- Thumbnails -->
        <div class="d-flex gap-2 overflow-auto py-2" id="galleryThumbnails" style="max-width: 60vw;">
          {% for photo in log.photos.all %}
          <img src="{{ photo.image.url }}" 
               class="gallery-thumbnail rounded" 
               data-index="{{ forloop.counter0 }}"
               data-src="{{ photo.image.url }}"
               data-caption="{{ photo.caption|default:'Photo' }}"
               style="width: 60px; height: 45px; object-fit: cover; cursor: pointer; opacity: 0.5; transition: all 0.2s ease; border: 2px solid transparent;">
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .gallery-nav-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    transition: all 0.2s ease;
  }
  .gallery-nav-btn:hover {
    background: rgba(255,255,255,0.2);
    transform: scale(1.1);
  }
  .gallery-thumbnail:hover {
    opacity: 1 !important;
    border-color: white !important;
  }
  .gallery-thumbnail.active {
    opacity: 1 !important;
    border-color: #6366f1 !important;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const photos = [
    {% for photo in log.photos.all %}
    { src: "{{ photo.image.url }}", caption: "{{ photo.caption|default:'Photo'|escapejs }}" }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  
  let currentIndex = 0;
  let currentZoom = 1;
  const zoomStep = 0.25;
  const maxZoom = 3;
  const minZoom = 0.5;
  
  // Pan/Drag variables
  let isPanning = false;
  let startX = 0, startY = 0;
  let panX = 0, panY = 0;
  let lastPanX = 0, lastPanY = 0;
  
  const modal = document.getElementById('photoGalleryModal');
  const image = document.getElementById('galleryImage');
  const imageContainer = document.getElementById('imageContainer');
  const title = document.getElementById('galleryTitle');
  const counter = document.getElementById('galleryCounter');
  const thumbnails = document.querySelectorAll('.gallery-thumbnail');
  const zoomResetBtn = document.getElementById('zoomReset');
  
  function showPhoto(index) {
    if (index < 0) index = photos.length - 1;
    if (index >= photos.length) index = 0;
    currentIndex = index;
    
    image.src = photos[index].src;
    title.textContent = photos[index].caption;
    counter.textContent = (index + 1) + ' / ' + photos.length;
    
    // Reset zoom and pan
    currentZoom = 1;
    panX = 0;
    panY = 0;
    lastPanX = 0;
    lastPanY = 0;
    updateTransform();
    
    // Update thumbnails
    thumbnails.forEach((thumb, i) => {
      thumb.classList.toggle('active', i === index);
    });
  }
  
  function updateTransform() {
    image.style.transform = `scale(${currentZoom}) translate(${panX / currentZoom}px, ${panY / currentZoom}px)`;
    zoomResetBtn.textContent = Math.round(currentZoom * 100) + '%';
    
    // Update cursor
    if (currentZoom > 1) {
      imageContainer.style.cursor = isPanning ? 'grabbing' : 'grab';
    } else {
      imageContainer.style.cursor = 'default';
    }
  }
  
  // Mouse Pan/Drag events
  imageContainer.addEventListener('mousedown', (e) => {
    if (currentZoom > 1) {
      isPanning = true;
      startX = e.clientX - lastPanX;
      startY = e.clientY - lastPanY;
      imageContainer.style.cursor = 'grabbing';
      e.preventDefault();
    }
  });
  
  document.addEventListener('mousemove', (e) => {
    if (isPanning && currentZoom > 1) {
      panX = e.clientX - startX;
      panY = e.clientY - startY;
      updateTransform();
    }
  });
  
  document.addEventListener('mouseup', () => {
    if (isPanning) {
      isPanning = false;
      lastPanX = panX;
      lastPanY = panY;
      if (currentZoom > 1) {
        imageContainer.style.cursor = 'grab';
      }
    }
  });
  
  // Touch Pan/Drag events (for mobile)
  imageContainer.addEventListener('touchstart', (e) => {
    if (currentZoom > 1 && e.touches.length === 1) {
      isPanning = true;
      startX = e.touches[0].clientX - lastPanX;
      startY = e.touches[0].clientY - lastPanY;
      e.preventDefault();
    }
  }, { passive: false });
  
  imageContainer.addEventListener('touchmove', (e) => {
    if (isPanning && currentZoom > 1 && e.touches.length === 1) {
      panX = e.touches[0].clientX - startX;
      panY = e.touches[0].clientY - startY;
      updateTransform();
      e.preventDefault();
    }
  }, { passive: false });
  
  imageContainer.addEventListener('touchend', () => {
    if (isPanning) {
      isPanning = false;
      lastPanX = panX;
      lastPanY = panY;
    }
  });
  
  // Double-click to zoom
  imageContainer.addEventListener('dblclick', (e) => {
    if (currentZoom === 1) {
      currentZoom = 2;
    } else {
      currentZoom = 1;
      panX = 0;
      panY = 0;
      lastPanX = 0;
      lastPanY = 0;
    }
    updateTransform();
  });
  
  // Navigation
  document.getElementById('prevPhoto').addEventListener('click', () => showPhoto(currentIndex - 1));
  document.getElementById('nextPhoto').addEventListener('click', () => showPhoto(currentIndex + 1));
  
  // Zoom controls
  document.getElementById('zoomIn').addEventListener('click', () => {
    if (currentZoom < maxZoom) {
      currentZoom += zoomStep;
      updateTransform();
    }
  });
  
  document.getElementById('zoomOut').addEventListener('click', () => {
    if (currentZoom > minZoom) {
      currentZoom -= zoomStep;
      // Reduce pan if zoom decreased
      if (currentZoom <= 1) {
        panX = 0;
        panY = 0;
        lastPanX = 0;
        lastPanY = 0;
      }
      updateTransform();
    }
  });
  
  document.getElementById('zoomReset').addEventListener('click', () => {
    currentZoom = 1;
    panX = 0;
    panY = 0;
    lastPanX = 0;
    lastPanY = 0;
    updateTransform();
  });
  
  // Thumbnail clicks
  thumbnails.forEach(thumb => {
    thumb.addEventListener('click', () => {
      showPhoto(parseInt(thumb.dataset.index));
    });
  });
  
  // Keyboard navigation
  modal.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') showPhoto(currentIndex - 1);
    if (e.key === 'ArrowRight') showPhoto(currentIndex + 1);
    if (e.key === '+' || e.key === '=') document.getElementById('zoomIn').click();
    if (e.key === '-') document.getElementById('zoomOut').click();
    if (e.key === '0') document.getElementById('zoomReset').click();
  });
  
  // Open gallery from photo items
  document.querySelectorAll('.photo-item').forEach((item, index) => {
    item.setAttribute('data-bs-toggle', 'modal');
    item.setAttribute('data-bs-target', '#photoGalleryModal');
    item.addEventListener('click', () => {
      setTimeout(() => showPhoto(index), 100);
    });
  });
  
  // Initialize first photo when modal opens
  modal.addEventListener('show.bs.modal', () => {
    if (photos.length > 0 && !image.src) {
      showPhoto(0);
    }
  });
  
  // Reset pan when modal closes
  modal.addEventListener('hidden.bs.modal', () => {
    currentZoom = 1;
    panX = 0;
    panY = 0;
    lastPanX = 0;
    lastPanY = 0;
  });
});
</script>
{% endif %}

{% endblock %}
