{% extends "core/base_modern.html" %}
{% load i18n static %}

{% block title %}{% trans "Project Photos" %} - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
.premium-header {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 2rem;
}
.btn-back {
  background: rgba(255,255,255,0.1);
  color: white;
  border: 1px solid rgba(255,255,255,0.2);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  text-decoration: none;
  font-size: 0.875rem;
  transition: all 0.2s;
}
.btn-back:hover {
  background: rgba(255,255,255,0.2);
  color: white;
}
.btn-add {
  background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
  color: white;
  border: none;
  padding: 0.625rem 1.25rem;
  border-radius: 10px;
  font-weight: 500;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s;
}
.btn-add:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
  color: white;
}
.filter-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}
.filter-tab {
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 500;
  text-decoration: none;
  transition: all 0.2s;
}
.filter-tab.all { background: #e0e7ff; color: #4f46e5; }
.filter-tab.all.active, .filter-tab.all:hover { background: #4f46e5; color: white; }
.filter-tab.before { background: #fee2e2; color: #dc2626; }
.filter-tab.before.active, .filter-tab.before:hover { background: #dc2626; color: white; }
.filter-tab.progress { background: #fef3c7; color: #d97706; }
.filter-tab.progress.active, .filter-tab.progress:hover { background: #d97706; color: white; }
.filter-tab.after { background: #d1fae5; color: #059669; }
.filter-tab.after.active, .filter-tab.after:hover { background: #059669; color: white; }
.filter-tab.defect { background: #fecaca; color: #b91c1c; }
.filter-tab.defect.active, .filter-tab.defect:hover { background: #b91c1c; color: white; }
.filter-tab.reference { background: #dbeafe; color: #2563eb; }
.filter-tab.reference.active, .filter-tab.reference:hover { background: #2563eb; color: white; }
.photo-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1.5rem;
}
.photo-card {
  background: white;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  cursor: pointer;
}
.photo-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 24px rgba(0,0,0,0.15);
}
.photo-image-wrapper {
  position: relative;
  height: 200px;
  overflow: hidden;
}
.photo-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}
.photo-card:hover .photo-image {
  transform: scale(1.05);
}
.photo-type-badge {
  position: absolute;
  top: 0.75rem;
  left: 0.75rem;
  padding: 0.25rem 0.625rem;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}
.photo-type-badge.before { background: rgba(220, 38, 38, 0.9); color: white; }
.photo-type-badge.progress { background: rgba(217, 119, 6, 0.9); color: white; }
.photo-type-badge.after { background: rgba(5, 150, 105, 0.9); color: white; }
.photo-type-badge.defect { background: rgba(185, 28, 28, 0.9); color: white; }
.photo-type-badge.reference { background: rgba(37, 99, 235, 0.9); color: white; }
.photo-info { padding: 1rem; }
.photo-room { font-weight: 600; font-size: 0.9375rem; color: #1e293b; margin-bottom: 0.25rem; }
.photo-wall { font-size: 0.8125rem; color: #64748b; margin-bottom: 0.5rem; }
.photo-color-info { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8fafc; border-radius: 8px; font-size: 0.8125rem; }
.color-swatch { width: 24px; height: 24px; border-radius: 4px; border: 1px solid #e2e8f0; }
.photo-date { font-size: 0.75rem; color: #94a3b8; margin-top: 0.5rem; }
.empty-state { text-align: center; padding: 4rem 2rem; background: #f8fafc; border-radius: 16px; color: #64748b; }
.empty-state i { font-size: 4rem; color: #cbd5e1; margin-bottom: 1rem; }
.gallery-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; }
.gallery-modal.active { display: flex; }
.gallery-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: white; font-size: 2rem; cursor: pointer; z-index: 10001; }
.gallery-image-container { position: relative; max-width: 90vw; max-height: 90vh; display: flex; justify-content: center; align-items: center; }
.gallery-image { max-width: 90vw; max-height: 85vh; object-fit: contain; transition: transform 0.3s ease; cursor: grab; }
.gallery-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2rem; padding: 1rem 0.75rem; cursor: pointer; border-radius: 8px; transition: background 0.2s; }
.gallery-nav:hover { background: rgba(255,255,255,0.3); }
.gallery-prev { left: 1rem; }
.gallery-next { right: 1rem; }
.gallery-info { position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-align: center; max-width: 80%; }
.gallery-counter { position: absolute; top: 1rem; left: 1rem; background: rgba(0,0,0,0.5); color: white; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="premium-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <a href="{% url 'project_overview' project.id %}" class="btn-back mb-2 d-inline-block">
          <i class="fas fa-arrow-left"></i> {% trans "Back to Project" %}
        </a>
        <h1 class="text-white mb-1 h3"><i class="fas fa-camera me-2"></i>{% trans "Project Photos" %}</h1>
        <p class="text-white-50 mb-0">{{ project.name }}</p>
      </div>
      {% if not is_client_user %}
      <a href="{% url 'site_photo_create' project.id %}" class="btn-add"><i class="fas fa-plus"></i> {% trans "Add Photo" %}</a>
      {% endif %}
    </div>
  </div>

  <div class="filter-tabs">
    <a href="?type=" class="filter-tab all {% if not filter_type %}active{% endif %}"><i class="fas fa-images me-1"></i> {% trans "All" %} ({{ total_count|default:0 }})</a>
    <a href="?type=before" class="filter-tab before {% if filter_type == 'before' %}active{% endif %}">{% trans "Before" %} ({{ before_count|default:0 }})</a>
    <a href="?type=progress" class="filter-tab progress {% if filter_type == 'progress' %}active{% endif %}">{% trans "Progress" %} ({{ progress_count|default:0 }})</a>
    <a href="?type=after" class="filter-tab after {% if filter_type == 'after' %}active{% endif %}">{% trans "After" %} ({{ after_count|default:0 }})</a>
    <a href="?type=defect" class="filter-tab defect {% if filter_type == 'defect' %}active{% endif %}">{% trans "Defects" %} ({{ defect_count|default:0 }})</a>
    <a href="?type=reference" class="filter-tab reference {% if filter_type == 'reference' %}active{% endif %}">{% trans "Reference" %} ({{ reference_count|default:0 }})</a>
  </div>

  {% if photos %}
  <div class="photo-grid">
    {% for photo in photos %}
    <div class="photo-card" onclick="openGallery({{ forloop.counter0 }})">
      <div class="photo-image-wrapper">
        <img src="{{ photo.image.url }}" alt="{{ photo.room }}" class="photo-image" loading="lazy">
        <span class="photo-type-badge {{ photo.photo_type }}">{{ photo.get_photo_type_display }}</span>
      </div>
      <div class="photo-info">
        <div class="photo-room">{{ photo.room|default:"—" }}</div>
        {% if photo.wall_ref %}<div class="photo-wall"><i class="fas fa-map-marker-alt me-1"></i>{{ photo.wall_ref }}</div>{% endif %}
        {% if photo.color_text %}
        <div class="photo-color-info">
          {% if photo.hex_color %}<span class="color-swatch" style="background-color: {{ photo.hex_color }};"></span>{% endif %}
          <span>{{ photo.color_text }}</span>{% if photo.brand %}<span class="text-muted">- {{ photo.brand }}</span>{% endif %}
        </div>
        {% endif %}
        <div class="photo-date"><i class="far fa-calendar me-1"></i>{{ photo.created_at|date:"M d, Y" }}</div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <i class="fas fa-camera"></i>
    <h4>{% trans "No photos yet" %}</h4>
    <p>{% trans "Start adding photos to document this project" %}</p>
    {% if not is_client_user %}
    <a href="{% url 'site_photo_create' project.id %}" class="btn-add mt-3"><i class="fas fa-plus"></i> {% trans "Add First Photo" %}</a>
    {% endif %}
  </div>
  {% endif %}
</div>

<div class="gallery-modal" id="galleryModal">
  <button class="gallery-close" onclick="closeGallery()"><i class="fas fa-times"></i></button>
  <span class="gallery-counter" id="galleryCounter">1 / {{ photos|length }}</span>
  <button class="gallery-nav gallery-prev" onclick="prevImage()"><i class="fas fa-chevron-left"></i></button>
  <div class="gallery-image-container"><img src="" alt="" class="gallery-image" id="galleryImage"></div>
  <button class="gallery-nav gallery-next" onclick="nextImage()"><i class="fas fa-chevron-right"></i></button>
  <div class="gallery-info" id="galleryInfo"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
var photos = [{% for photo in photos %}{url:"{{ photo.image.url }}",room:"{{ photo.room|default:'—'|escapejs }}",type:"{{ photo.get_photo_type_display|escapejs }}",wall:"{{ photo.wall_ref|default:''|escapejs }}",color:"{{ photo.color_text|default:''|escapejs }}",date:"{{ photo.created_at|date:'M d, Y' }}",detailUrl:"{% url 'site_photo_detail' photo.id %}"}{% if not forloop.last %},{% endif %}{% endfor %}];
var currentIndex=0,scale=1,translateX=0,translateY=0,isDragging=false,startX,startY;
function openGallery(i){currentIndex=i;updateGalleryImage();document.getElementById('galleryModal').classList.add('active');document.body.style.overflow='hidden';}
function closeGallery(){document.getElementById('galleryModal').classList.remove('active');document.body.style.overflow='';resetZoom();}
function updateGalleryImage(){if(photos.length===0)return;var p=photos[currentIndex],img=document.getElementById('galleryImage');img.src=p.url;document.getElementById('galleryCounter').textContent=(currentIndex+1)+' / '+photos.length;var info='<strong>'+p.room+'</strong>';if(p.type)info+=' <span class="badge bg-light text-dark">'+p.type+'</span>';if(p.wall)info+='<br><small><i class="fas fa-map-marker-alt"></i> '+p.wall+'</small>';if(p.color)info+='<br><small><i class="fas fa-palette"></i> '+p.color+'</small>';info+='<br><small>'+p.date+'</small>';info+='<br><a href="'+p.detailUrl+'" class="btn btn-sm btn-light mt-2"><i class="fas fa-info-circle"></i> Ver Detalles</a>';document.getElementById('galleryInfo').innerHTML=info;resetZoom();}
function nextImage(){currentIndex=(currentIndex+1)%photos.length;updateGalleryImage();}
function prevImage(){currentIndex=(currentIndex-1+photos.length)%photos.length;updateGalleryImage();}
function resetZoom(){scale=1;translateX=0;translateY=0;applyTransform();}
function applyTransform(){document.getElementById('galleryImage').style.transform='translate('+translateX+'px,'+translateY+'px) scale('+scale+')';}
document.addEventListener('keydown',function(e){if(!document.getElementById('galleryModal').classList.contains('active'))return;if(e.key==='Escape')closeGallery();if(e.key==='ArrowRight')nextImage();if(e.key==='ArrowLeft')prevImage();if(e.key==='+'||e.key==='='){scale=Math.min(scale*1.2,5);applyTransform();}if(e.key==='-'){scale=Math.max(scale/1.2,0.5);applyTransform();}if(e.key==='0')resetZoom();});
document.getElementById('galleryModal').addEventListener('wheel',function(e){e.preventDefault();scale=e.deltaY<0?Math.min(scale*1.1,5):Math.max(scale/1.1,0.5);applyTransform();});
var galleryImage=document.getElementById('galleryImage');
galleryImage.addEventListener('mousedown',function(e){if(scale<=1)return;isDragging=true;startX=e.clientX-translateX;startY=e.clientY-translateY;galleryImage.style.cursor='grabbing';});
document.addEventListener('mousemove',function(e){if(!isDragging)return;translateX=e.clientX-startX;translateY=e.clientY-startY;applyTransform();});
document.addEventListener('mouseup',function(){isDragging=false;galleryImage.style.cursor='grab';});
document.getElementById('galleryModal').addEventListener('click',function(e){if(e.target===this)closeGallery();});
</script>
{% endblock %}
