{% extends "core/base_modern.html" %}
{% load i18n %}
{% load static %}

{% block title %}{{ session.project.name }} - {% trans "Strategic Plan" %}{% endblock %}

{% block content %}
<div class="h-[calc(100vh-8rem)] flex flex-col">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-200 px-3 py-3 sm:px-6 sm:py-4 mb-2 sm:mb-4 rounded-lg">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
            <div class="flex-1 min-w-0">
                <div class="flex items-center flex-wrap gap-2">
                    <h1 class="text-lg sm:text-xl font-bold text-gray-900 truncate">{{ session.project.name }}</h1>
                    {% if session.status == 'DRAFT' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">{% trans "Draft" %}</span>
                    {% elif session.status == 'IN_REVIEW' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">{% trans "In Review" %}</span>
                    {% elif session.status == 'APPROVED' %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">{% trans "Approved" %}</span>
                    {% endif %}
                    
                    {% if session.exported_to_daily_plan %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">{% trans "Exported" %}</span>
                    {% endif %}
                </div>
                <p class="text-xs sm:text-sm text-gray-500 mt-1">
                    {{ session.date_range_start|date:"M d" }} - {{ session.date_range_end|date:"M d, Y" }}
                    <span class="mx-2">â€¢</span>
                    {{ session.days.count }} {% trans "Days" %}
                </p>
            </div>
            <div class="flex flex-wrap gap-2">
                <a href="{% url 'strategic_planning_dashboard' %}" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-xs sm:text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none">
                    <i class="bi bi-arrow-left mr-1 sm:mr-2"></i> <span class="hidden sm:inline">{% trans "Back" %}</span>
                </a>
                
                <a href="{% url 'materials_request' session.project.id %}" class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-xs sm:text-sm leading-4 font-medium rounded-md text-white bg-amber-600 hover:bg-amber-700 focus:outline-none">
                    <i class="bi bi-box-seam mr-1 sm:mr-2"></i> <span class="hidden sm:inline">{% trans "Request Materials" %}</span><span class="sm:hidden">{% trans "Materials" %}</span>
                </a>
                
                {% if session.status == 'DRAFT' %}
                <button onclick="updateStatus('IN_REVIEW')" class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-xs sm:text-sm leading-4 font-medium rounded-md text-white bg-kibray-600 hover:bg-kibray-700 focus:outline-none">
                    <i class="bi bi-check2-circle mr-1 sm:mr-2"></i> <span class="hidden sm:inline">{% trans "Submit for Review" %}</span><span class="sm:hidden">{% trans "Submit" %}</span>
                </button>
                {% endif %}

                {% if session.status == 'IN_REVIEW' %}
                <button onclick="updateStatus('APPROVED')" class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-xs sm:text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none">
                    <i class="bi bi-check-circle mr-1 sm:mr-2"></i> <span class="hidden sm:inline">{% trans "Approve Plan" %}</span><span class="sm:hidden">{% trans "Approve" %}</span>
                </button>
                {% endif %}
                
                {% if session.status == 'APPROVED' and not session.exported_to_daily_plan %}
                <button onclick="exportToDailyPlan()" class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-xs sm:text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none">
                    <i class="bi bi-box-arrow-up-right mr-1 sm:mr-2"></i> <span class="hidden sm:inline">{% trans "Export to Daily Plan" %}</span><span class="sm:hidden">{% trans "Export" %}</span>
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- View Toggle -->
    <div class="bg-white shadow-sm border-b border-gray-200 px-3 py-2 sm:px-6 mb-2 sm:mb-4 rounded-lg flex justify-between items-center">
        <div class="flex space-x-2">
            <button onclick="switchView('board')" id="btn-board" class="px-2 sm:px-3 py-1 text-xs sm:text-sm font-medium rounded-md bg-kibray-100 text-kibray-700">
                <i class="bi bi-kanban mr-1"></i> <span class="hidden sm:inline">{% trans "Board View" %}</span><span class="sm:hidden">{% trans "Board" %}</span>
            </button>
            <button onclick="switchView('gantt')" id="btn-gantt" class="px-2 sm:px-3 py-1 text-xs sm:text-sm font-medium rounded-md text-gray-500 hover:text-gray-700">
                <i class="bi bi-calendar-range mr-1"></i> <span class="hidden sm:inline">{% trans "Gantt View" %}</span><span class="sm:hidden">{% trans "Gantt" %}</span>
            </button>
        </div>
    </div>

    <!-- Board Area (Horizontal Scroll) -->
    <div id="view-board" class="flex-1 overflow-x-auto overflow-y-hidden bg-gray-100 rounded-lg p-2 sm:p-4">
        <div class="flex gap-2 sm:gap-4 h-full" style="min-width: min-content;">
            {% for day in session.days.all %}
            <!-- Day Column -->
            <div class="w-72 sm:w-80 flex-shrink-0 flex flex-col bg-gray-50 rounded-lg border border-gray-200 shadow-sm h-full">
                <!-- Day Header -->
                <div class="p-2 sm:p-3 border-b border-gray-200 bg-white rounded-t-lg sticky top-0 z-10">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="font-bold text-gray-900 text-sm sm:text-base">{{ day.target_date|date:"l" }}</h3>
                        <span class="text-xs font-medium text-gray-500">{{ day.estimated_total_hours }}h</span>
                    </div>
                    <div class="text-xs sm:text-sm text-gray-500">{{ day.target_date|date:"M d" }}</div>
                </div>

                <!-- Items List (Vertical Scroll) -->
                <div class="flex-1 overflow-y-auto p-2 space-y-2 sm:space-y-3 custom-scrollbar item-container" data-day-id="{{ day.id }}">
                    {% for item in day.items.all %}
                    <div class="p-2 sm:p-3 rounded border shadow-sm hover:shadow-md transition-all cursor-pointer group 
                        {% if item.material_requirements.exists %}
                            bg-orange-50 border-orange-300
                        {% else %}
                            bg-white border-gray-200
                        {% endif %}"
                        data-item-id="{{ item.id }}">
                        
                        <!-- Title with Edit -->
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs sm:text-sm font-medium 
                                {% if item.material_requirements.exists %}
                                    text-orange-900
                                {% else %}
                                    text-gray-900
                                {% endif %}">
                                {{ item.title }}
                            </span>
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="text-gray-400 hover:text-kibray-600"><i class="bi bi-pencil"></i></button>
                            </div>
                        </div>
                        
                        <!-- Location & Assignments -->
                        <div class="mb-2 flex flex-wrap gap-1 items-center">
                            {% if item.location_area %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                    <i class="bi bi-geo-alt mr-1"></i> {{ item.location_area }}
                                </span>
                            {% endif %}
                            
                            <!-- Assignees - Clickeable para reasignar -->
                            {% if item.assigned_to.exists %}
                                <button onclick="openReassignModal('{{ item.id }}', '{{ item.title|escapejs }}')" 
                                    class="flex -space-x-1 overflow-hidden hover:scale-110 transition-transform"
                                    title="{% trans 'Click to reassign' %}">
                                    {% for emp in item.assigned_to.all %}
                                        <div class="inline-block h-5 w-5 rounded-full ring-2 ring-white bg-kibray-100 flex items-center justify-center text-[10px] font-bold text-kibray-700">
                                            {{ emp.first_name|first }}{{ emp.last_name|first }}
                                        </div>
                                    {% endfor %}
                                </button>
                            {% else %}
                                <button onclick="openReassignModal('{{ item.id }}', '{{ item.title|escapejs }}')" 
                                    class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600 hover:bg-kibray-100 hover:text-kibray-700 transition-colors"
                                    title="{% trans 'Click to assign' %}">
                                    <i class="bi bi-person-plus mr-1"></i> {% trans "Assign" %}
                                </button>
                            {% endif %}
                            
                            <!-- Material Request Button - Always visible inside card -->
                            <button onclick="openMaterialRequestForItem('{{ item.id }}', '{{ item.title|escapejs }}')" 
                                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium transition-colors
                                    {% if item.material_requirements.exists %}
                                        bg-orange-200 text-orange-800 hover:bg-orange-300
                                    {% else %}
                                        bg-amber-100 text-amber-700 hover:bg-amber-200
                                    {% endif %}"
                                title="{% if item.material_requirements.exists %}{% trans 'View/Add materials' %}{% else %}{% trans 'Request materials' %}{% endif %}">
                                <i class="bi bi-box-seam mr-1"></i>
                                {% if item.material_requirements.exists %}
                                    {{ item.material_requirements.count }}
                                {% else %}
                                    {% trans "Materials" %}
                                {% endif %}
                            </button>
                        </div>
                        
                        <!-- Tasks Preview -->
                        {% if item.tasks.exists %}
                        <div class="mt-2 pt-2 border-t border-gray-100">
                            <div class="text-xs text-gray-500 mb-1">{{ item.tasks.count }} {% trans "Tasks" %}</div>
                            <div class="space-y-1">
                                {% for task in item.tasks.all|slice:":2" %}
                                <div class="flex items-center text-xs text-gray-600">
                                    <i class="bi bi-check-circle mr-1 text-gray-400"></i>
                                    <span class="truncate">{{ task.description }}</span>
                                </div>
                                {% endfor %}
                                {% if item.tasks.count > 2 %}
                                <div class="text-xs text-gray-400 pl-4">+{{ item.tasks.count|add:"-2" }} more</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    
                    <!-- Add Item Button -->
                    <button onclick="openAddItemModal('{{ day.id }}')" class="w-full mt-2 py-2 border-2 border-dashed border-gray-300 rounded-lg text-xs sm:text-sm font-medium text-gray-500 hover:border-kibray-500 hover:text-kibray-600 transition-colors">
                        <i class="bi bi-plus-lg mr-1"></i> {% trans "Add Item" %}
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Gantt View Area -->
    <div id="view-gantt" class="hidden flex-1 bg-white rounded-lg shadow-sm overflow-hidden flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">{% trans "Timeline" %}</h3>
            <div class="flex space-x-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="ganttZoomOut()"><i class="bi bi-zoom-out"></i></button>
                <button class="btn btn-sm btn-outline-secondary" onclick="ganttZoomIn()"><i class="bi bi-zoom-in"></i></button>
            </div>
        </div>
        <div class="flex-1 overflow-auto relative" id="gantt-container">
            <!-- Gantt Header -->
            <div class="flex border-b border-gray-200 sticky top-0 bg-white z-10" id="gantt-header">
                <!-- Generated by JS -->
            </div>
            <!-- Gantt Body -->
            <div class="relative" id="gantt-body" style="min-height: 400px;">
                <!-- Generated by JS -->
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div id="addItemModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeAddItemModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">{% trans "Add Item to" %} <span id="modalDateDisplay"></span></h3>
                <form id="addItemForm">
                    <input type="hidden" id="dayId" name="strategic_day">
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">{% trans "Item Name" %}</label>
                        <input type="text" name="title" class="mt-1 block w-full shadow-sm focus:ring-kibray-500 focus:border-kibray-500 sm:text-sm border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">{% trans "Estimated Hours" %}</label>
                        <input type="number" name="estimated_hours" step="0.5" class="mt-1 block w-full shadow-sm focus:ring-kibray-500 focus:border-kibray-500 sm:text-sm border-gray-300 rounded-md" value="1.0">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">{% trans "Location / Area" %}</label>
                        <input type="text" name="location_area" class="mt-1 block w-full shadow-sm focus:ring-kibray-500 focus:border-kibray-500 sm:text-sm border-gray-300 rounded-md" placeholder="e.g. Kitchen, Exterior">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">{% trans "Assign To" %}</label>
                        <select name="assigned_to" multiple class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-kibray-500 focus:border-kibray-500 sm:text-sm rounded-md h-24">
                            {% for emp in employees %}
                                <option value="{{ emp.id }}">{{ emp.first_name }} {{ emp.last_name }}</option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-xs text-gray-500">{% trans "Hold Ctrl/Cmd to select multiple" %}</p>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">{% trans "Priority" %}</label>
                        <select name="priority" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-kibray-500 focus:border-kibray-500 sm:text-sm rounded-md">
                            <option value="MEDIUM">{% trans "Medium" %}</option>
                            <option value="HIGH">{% trans "High" %}</option>
                            <option value="CRITICAL">{% trans "Critical" %}</option>
                            <option value="LOW">{% trans "Low" %}</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitAddItem()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-kibray-600 text-base font-medium text-white hover:bg-kibray-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    {% trans "Add Item" %}
                </button>
                <button type="button" onclick="closeAddItemModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    {% trans "Cancel" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div id="addTaskModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeAddTaskModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">{% trans "Add Task to" %} <span id="taskModalItemName"></span></h3>
                <form id="addTaskForm">
                    <input type="hidden" id="taskItemId" name="strategic_item">
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">{% trans "Task Name" %}</label>
                        <input type="text" name="description" class="mt-1 block w-full shadow-sm focus:ring-kibray-500 focus:border-kibray-500 sm:text-sm border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">{% trans "Estimated Hours" %}</label>
                        <input type="number" name="estimated_hours" step="0.25" class="mt-1 block w-full shadow-sm focus:ring-kibray-500 focus:border-kibray-500 sm:text-sm border-gray-300 rounded-md" value="0.5">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">{% trans "Assign To (Override)" %}</label>
                        <select name="assigned_to" multiple class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-kibray-500 focus:border-kibray-500 sm:text-sm rounded-md h-24">
                            {% for emp in employees %}
                                <option value="{{ emp.id }}">{{ emp.first_name }} {{ emp.last_name }}</option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 text-xs text-gray-500">{% trans "Optional: Override item assignment" %}</p>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitAddTask()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-kibray-600 text-base font-medium text-white hover:bg-kibray-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    {% trans "Add Task" %}
                </button>
                <button type="button" onclick="closeAddTaskModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    {% trans "Cancel" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Material Modal -->
<div id="addMaterialModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeAddMaterialModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">{% trans "Add Material to" %} <span id="materialModalItemName"></span></h3>
                <form id="addMaterialForm">
                    <input type="hidden" id="materialItemId" name="strategic_item">
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">{% trans "Material Name" %}</label>
                        <input type="text" name="name" class="mt-1 block w-full shadow-sm focus:ring-kibray-500 focus:border-kibray-500 sm:text-sm border-gray-300 rounded-md" required placeholder="e.g. Cement, 2x4 Lumber">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">{% trans "Quantity" %}</label>
                            <input type="number" name="quantity" step="0.01" class="mt-1 block w-full shadow-sm focus:ring-kibray-500 focus:border-kibray-500 sm:text-sm border-gray-300 rounded-md" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">{% trans "Unit" %}</label>
                            <input type="text" name="unit" class="mt-1 block w-full shadow-sm focus:ring-kibray-500 focus:border-kibray-500 sm:text-sm border-gray-300 rounded-md" required placeholder="e.g. kg, pcs, m">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700">{% trans "Notes" %}</label>
                        <textarea name="notes" rows="2" class="mt-1 block w-full shadow-sm focus:ring-kibray-500 focus:border-kibray-500 sm:text-sm border-gray-300 rounded-md"></textarea>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitAddMaterial()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-kibray-600 text-base font-medium text-white hover:bg-kibray-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    {% trans "Add Material" %}
                </button>
                <button type="button" onclick="closeAddMaterialModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    {% trans "Cancel" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reassign Modal -->
<div id="reassignModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeReassignModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                    <i class="bi bi-people text-kibray-600 mr-2"></i>
                    {% trans "Assign/Reassign" %}: <span id="reassignModalItemName" class="font-bold"></span>
                </h3>
                <form id="reassignForm">
                    <input type="hidden" id="reassignItemId">
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {% trans "Select Team Members" %}
                        </label>
                        <select id="reassignEmployees" name="assigned_to" multiple 
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-kibray-500 focus:border-kibray-500 sm:text-sm rounded-md h-48">
                            {% for emp in employees %}
                                <option value="{{ emp.id }}">{{ emp.first_name }} {{ emp.last_name }}</option>
                            {% endfor %}
                        </select>
                        <p class="mt-2 text-xs text-gray-500">
                            <i class="bi bi-info-circle mr-1"></i>
                            {% trans "Hold Ctrl/Cmd to select multiple people" %}
                        </p>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitReassign()" 
                    class="w-full inline-flex justify-center items-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-kibray-600 text-base font-medium text-white hover:bg-kibray-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    <i class="bi bi-check-circle mr-2"></i>{% trans "Update Assignment" %}
                </button>
                <button type="button" onclick="closeReassignModal()" 
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    {% trans "Cancel" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    const SESSION_ID = "{{ session.id }}";
    
    function updateStatus(status) {
        if(!confirm('{% trans "Are you sure you want to change the status?" %}')) return;
        
        fetch(`/api/v1/strategic/sessions/${SESSION_ID}/update_status/`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf-token]').content
            },
            body: JSON.stringify({ status: status })
        }).then(() => window.location.reload());
    }

    function exportToDailyPlan() {
        if(!confirm('{% trans "This will create Daily Plans for all days in this session. Continue?" %}')) return;
        
        fetch(`/api/v1/strategic/sessions/${SESSION_ID}/export/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf-token]').content
            }
        })
        .then(response => {
            if(response.ok) {
                alert('{% trans "Export successful!" %}');
                window.location.reload();
            } else {
                alert('{% trans "Export failed." %}');
            }
        });
    }

    function openAddItemModal(dayId, dateStr) {
        document.getElementById('dayId').value = dayId;
        document.getElementById('modalDateDisplay').textContent = dateStr;
        document.getElementById('addItemModal').classList.remove('hidden');
    }

    function closeAddItemModal() {
        document.getElementById('addItemModal').classList.add('hidden');
        document.getElementById('addItemForm').reset();
    }

    function submitAddItem() {
        const form = document.getElementById('addItemForm');
        const formData = new FormData(form);
        
        // Handle multi-select for assigned_to
        const assignedToSelect = form.querySelector('select[name="assigned_to"]');
        const assignedToValues = Array.from(assignedToSelect.selectedOptions).map(option => option.value);
        
        const data = Object.fromEntries(formData.entries());
        data.assigned_to = assignedToValues; // Override with array
        
        fetch('/api/v1/strategic/items/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf-token]').content
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if(response.ok) {
                window.location.reload();
            } else {
                alert('Error adding item');
            }
        });
    }

    function openAddTaskModal(itemId, itemName) {
        document.getElementById('taskItemId').value = itemId;
        document.getElementById('taskModalItemName').textContent = itemName;
        document.getElementById('addTaskModal').classList.remove('hidden');
    }

    function closeAddTaskModal() {
        document.getElementById('addTaskModal').classList.add('hidden');
        document.getElementById('addTaskForm').reset();
    }

    function submitAddTask() {
        const form = document.getElementById('addTaskForm');
        const formData = new FormData(form);
        
        // Handle multi-select for assigned_to
        const assignedToSelect = form.querySelector('select[name="assigned_to"]');
        const assignedToValues = Array.from(assignedToSelect.selectedOptions).map(option => option.value);
        
        const data = Object.fromEntries(formData.entries());
        data.assigned_to = assignedToValues; // Override with array
        
        fetch('/api/v1/strategic/tasks/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf-token]').content
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if(response.ok) {
                window.location.reload();
            } else {
                alert('Error adding task');
            }
        });
    }

    function openAddMaterialModal(itemId, itemName) {
        document.getElementById('materialItemId').value = itemId;
        document.getElementById('materialModalItemName').textContent = itemName;
        document.getElementById('addMaterialModal').classList.remove('hidden');
    }

    function closeAddMaterialModal() {
        document.getElementById('addMaterialModal').classList.add('hidden');
        document.getElementById('addMaterialForm').reset();
    }

    // Reassign Modal Functions
    function openReassignModal(itemId, itemName) {
        document.getElementById('reassignItemId').value = itemId;
        document.getElementById('reassignModalItemName').textContent = itemName;
        
        // Pre-select current assignments
        const itemCard = document.querySelector(`[data-item-id="${itemId}"]`);
        const currentAssignments = Array.from(itemCard.querySelectorAll('.bg-kibray-100'))
            .map(badge => badge.getAttribute('title'))
            .filter(title => title);
        
        // Clear and set selections
        const select = document.getElementById('reassignEmployees');
        Array.from(select.options).forEach(option => {
            option.selected = currentAssignments.some(name => option.textContent.includes(name));
        });
        
        document.getElementById('reassignModal').classList.remove('hidden');
    }

    function closeReassignModal() {
        document.getElementById('reassignModal').classList.add('hidden');
        document.getElementById('reassignForm').reset();
    }

    function submitReassign() {
        const itemId = document.getElementById('reassignItemId').value;
        const select = document.getElementById('reassignEmployees');
        const assignedToValues = Array.from(select.selectedOptions).map(option => option.value);
        
        fetch(`/api/v1/strategic/items/${itemId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf-token]').content
            },
            body: JSON.stringify({ assigned_to: assignedToValues })
        })
        .then(response => {
            if(response.ok) {
                window.location.reload();
            } else {
                alert('{% trans "Error updating assignment" %}');
            }
        });
    }

    // Material Request for Item
    function openMaterialRequestForItem(itemId, itemName) {
        // Redirect to material request wizard with item context
        window.location.href = `/projects/{{ session.project.id }}/materials/request/new/?strategic_item=${itemId}&item_name=${encodeURIComponent(itemName)}`;
    }

    function submitAddMaterial() {
        const form = document.getElementById('addMaterialForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        // Ensure strategic_item is an integer
        data.strategic_item = parseInt(data.strategic_item);
        
        fetch('/api/v1/strategic/materials/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf-token]').content
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if(response.ok) {
                window.location.reload();
            } else {
                response.json().then(data => alert('Error: ' + JSON.stringify(data)));
            }
        });
    }

    // Gantt View Logic
    let ganttZoom = 100; // px per day
    const ganttItems = {{ gantt_items_json|safe|default:"[]" }};
    const dayMap = {{ day_map_json|safe|default:"{}" }};
    const sessionStart = new Date("{{ session.date_range_start|date:'Y-m-d' }}");
    const sessionEnd = new Date("{{ session.date_range_end|date:'Y-m-d' }}");
    const totalDays = Math.ceil((sessionEnd - sessionStart) / (1000 * 60 * 60 * 24)) + 1;

    function switchView(view) {
        if (view === 'board') {
            document.getElementById('view-board').classList.remove('hidden');
            document.getElementById('view-gantt').classList.add('hidden');
            document.getElementById('btn-board').classList.add('bg-kibray-100', 'text-kibray-700');
            document.getElementById('btn-board').classList.remove('text-gray-500');
            document.getElementById('btn-gantt').classList.remove('bg-kibray-100', 'text-kibray-700');
            document.getElementById('btn-gantt').classList.add('text-gray-500');
        } else {
            document.getElementById('view-board').classList.add('hidden');
            document.getElementById('view-gantt').classList.remove('hidden');
            document.getElementById('btn-gantt').classList.add('bg-kibray-100', 'text-kibray-700');
            document.getElementById('btn-gantt').classList.remove('text-gray-500');
            document.getElementById('btn-board').classList.remove('bg-kibray-100', 'text-kibray-700');
            document.getElementById('btn-board').classList.add('text-gray-500');
            renderGantt();
        }
    }

    function ganttZoomIn() {
        if (ganttZoom < 300) {
            ganttZoom += 50;
            renderGantt();
        }
    }

    function ganttZoomOut() {
        if (ganttZoom > 50) {
            ganttZoom -= 50;
            renderGantt();
        }
    }

    function renderGantt() {
        const header = document.getElementById('gantt-header');
        const body = document.getElementById('gantt-body');
        header.innerHTML = '';
        body.innerHTML = '';

        // Render Header Days
        for (let i = 0; i < totalDays; i++) {
            const d = new Date(sessionStart);
            d.setDate(sessionStart.getDate() + i);
            
            const dayDiv = document.createElement('div');
            dayDiv.style.flex = `0 0 ${ganttZoom}px`;
            dayDiv.className = 'border-r border-gray-200 p-2 text-center text-sm font-medium text-gray-700';
            dayDiv.innerHTML = `<div>${d.toLocaleDateString('en-US', {weekday: 'short'})}</div><div class="text-xs text-gray-500">${d.getDate()}</div>`;
            header.appendChild(dayDiv);
            
            // Grid lines in body
            const line = document.createElement('div');
            line.className = 'absolute top-0 bottom-0 border-r border-gray-100';
            line.style.left = `${(i + 1) * ganttZoom}px`;
            line.style.zIndex = 0;
            body.appendChild(line);
        }

        // Render Items
        ganttItems.forEach((item, index) => {
            const itemStart = new Date(item.start_date);
            // Calculate offset days from session start
            const diffTime = Math.abs(itemStart - sessionStart);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            const left = diffDays * ganttZoom;
            const width = (item.duration || 1) * ganttZoom;
            
            const bar = document.createElement('div');
            bar.className = 'absolute h-8 rounded shadow-sm text-xs flex items-center px-2 cursor-move hover:shadow-md transition-shadow';
            bar.style.left = `${left}px`;
            bar.style.width = `${width - 10}px`; // Gap
            bar.style.top = `${index * 40 + 10}px`;
            bar.style.backgroundColor = getPriorityColor(item.priority);
            bar.style.color = 'white';
            bar.style.zIndex = 10;
            bar.innerText = item.title;
            bar.title = `${item.title} (${item.duration || 1} days)`;
            
            // Drag Logic (Simplified)
            let isDragging = false;
            let startX;
            let originalLeft;
            
            bar.onmousedown = function(e) {
                e.preventDefault();
                isDragging = true;
                startX = e.clientX;
                originalLeft = parseFloat(bar.style.left);
                bar.style.zIndex = 20;
                
                document.onmousemove = function(e) {
                    if (!isDragging) return;
                    const dx = e.clientX - startX;
                    bar.style.left = `${originalLeft + dx}px`;
                };
                
                document.onmouseup = function(e) {
                    if (!isDragging) return;
                    isDragging = false;
                    document.onmousemove = null;
                    document.onmouseup = null;
                    bar.style.zIndex = 10;
                    
                    // Snap to grid
                    const currentLeft = parseFloat(bar.style.left);
                    const newDayIndex = Math.round(currentLeft / ganttZoom);
                    const snappedLeft = newDayIndex * ganttZoom;
                    
                    if (newDayIndex >= 0 && newDayIndex < totalDays) {
                        bar.style.left = `${snappedLeft}px`;
                        
                        // Calculate new date
                        const newDate = new Date(sessionStart);
                        newDate.setDate(sessionStart.getDate() + newDayIndex);
                        const newDateStr = newDate.toISOString().split('T')[0];
                        
                        updateItemDate(item.id, newDateStr);
                    } else {
                        // Revert
                        bar.style.left = `${originalLeft}px`;
                    }
                };
            };
            
            body.appendChild(bar);
        });
        
        // Set body height
        body.style.height = `${ganttItems.length * 40 + 50}px`;
    }

    function getPriorityColor(priority) {
        switch(priority) {
            case 'CRITICAL': return '#ef4444'; // red-500
            case 'HIGH': return '#f97316'; // orange-500
            case 'MEDIUM': return '#3b82f6'; // blue-500
            case 'LOW': return '#10b981'; // green-500
            default: return '#6b7280'; // gray-500
        }
    }

    function updateItemDate(itemId, newDateStr) {
        const newDayId = dayMap[newDateStr];
        if (!newDayId) {
            alert('Cannot move item to this date (outside session range or invalid)');
            return;
        }
        
        fetch(`/api/v1/strategic/items/${itemId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf-token]').content
            },
            body: JSON.stringify({
                strategic_day: newDayId
            })
        }).then(response => {
            if(response.ok) {
                window.location.reload();
            } else {
                alert('Failed to move item');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const containers = document.querySelectorAll('.item-container');
        containers.forEach(container => {
            new Sortable(container, {
                group: 'shared', // set both lists to same group
                animation: 150,
                draggable: '.group', // Target the item card class
                onEnd: function (evt) {
                    const itemEl = evt.item;
                    const newDayId = evt.to.getAttribute('data-day-id');
                    const itemId = itemEl.getAttribute('data-item-id');
                    const newIndex = evt.newIndex;
                    
                    // Only update if changed
                    if (evt.to !== evt.from || evt.newIndex !== evt.oldIndex) {
                        updateItemLocation(itemId, newDayId, newIndex);
                    }
                }
            });
        });
    });

    function updateItemLocation(itemId, dayId, order) {
        fetch(`/api/v1/strategic/items/${itemId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf-token]').content
            },
            body: JSON.stringify({
                strategic_day: dayId,
                order: order
            })
        }).then(response => {
            if(!response.ok) {
                console.error('Failed to move item');
                // Optional: Revert UI or show toast
            }
        });
    }

    function switchView(view) {
        const board = document.getElementById('view-board');
        const gantt = document.getElementById('view-gantt');
        const btnBoard = document.getElementById('btn-board');
        const btnGantt = document.getElementById('btn-gantt');
        
        if(view === 'gantt') {
            board.classList.add('hidden');
            gantt.classList.remove('hidden');
            btnBoard.classList.remove('bg-kibray-100', 'text-kibray-700');
            btnGantt.classList.add('bg-kibray-100', 'text-kibray-700');
            loadGanttChart();
        } else {
            board.classList.remove('hidden');
            gantt.classList.add('hidden');
            btnBoard.classList.add('bg-kibray-100', 'text-kibray-700');
            btnGantt.classList.remove('bg-kibray-100', 'text-kibray-700');
        }
    }

    function loadGanttChart() {
        // Clear existing Gantt chart
        document.getElementById('gantt-header').innerHTML = '';
        document.getElementById('gantt-body').innerHTML = '';
        
        // Prepare data
        const items = [];
        const itemElements = document.querySelectorAll('.item-container .group');
        itemElements.forEach(itemEl => {
            const itemId = itemEl.getAttribute('data-item-id');
            const title = itemEl.querySelector('.font-medium').innerText;
            const startDate = itemEl.closest('[data-day-id]').getAttribute('data-day-id');
            const endDate = startDate; // Default to start date
            const assignedTo = Array.from(itemEl.querySelectorAll('[data-emp-id]')).map(empEl => empEl.getAttribute('data-emp-id'));
            
            items.push({ id: itemId, title, startDate, endDate, assignedTo });
        });
        
        // Generate Gantt chart HTML
        const headers = generateGanttHeaders(items);
        const body = generateGanttBody(items);
        
        document.getElementById('gantt-header').innerHTML = headers;
        document.getElementById('gantt-body').innerHTML = body;
    }

    function generateGanttHeaders(items) {
        // Generate date headers for Gantt chart
        const dates = Array.from(new Set(items.flatMap(item => [item.startDate, item.endDate]))).sort();
        let html = '<div class="flex">';
        html += '<div class="w-1/4 p-2 font-medium text-gray-700">{% trans "Task" %}</div>';
        
        dates.forEach(date => {
            html += `<div class="flex-1 p-2 text-center text-xs font-medium text-gray-500">${date}</div>`;
        });
        
        html += '</div>';
        return html;
    }

    function generateGanttBody(items) {
        // Generate body rows for Gantt chart
        let html = '';
        
        items.forEach(item => {
            const startIndex = item.startDate;
            const endIndex = item.endDate;
            const duration = Object.keys(dateRanges).length;
            
            html += `<div class="flex items-center border-b border-gray-200">`;
            html += `<div class="w-1/4 p-2 text-gray-900">${item.title}</div>`;
            
            for(let i = 0; i < duration; i++) {
                const date = Object.keys(dateRanges)[i];
                const isStart = date === startIndex;
                const isEnd = date === endIndex;
                const inRange = date > startIndex && date < endIndex;
                
                if(isStart) {
                    html += `<div class="flex-1 p-2 text-center bg-green-100 border-l border-green-600" style="position: relative;">`;
                    html += `<div class="absolute inset-0 bg-green-500 opacity-50" style="border-radius: 0.375rem;"></div>`;
                    html += `<div class="relative z-10 text-green-800 font-medium">${item.estimated_hours}h</div>`;
                    html += `</div>`;
                } else if(isEnd) {
                    html += `<div class="flex-1 p-2 text-center bg-red-100 border-l border-red-600" style="position: relative;">`;
                    html += `<div class="absolute inset-0 bg-red-500 opacity-50" style="border-radius: 0.375rem;"></div>`;
                    html += `<div class="relative z-10 text-red-800 font-medium">${item.estimated_hours}h</div>`;
                    html += `</div>`;
                } else if(inRange) {
                    html += `<div class="flex-1 p-2 text-center bg-blue-100" style="border-left: 2px solid #3b82f6;"></div>`;
                } else {
                    html += `<div class="flex-1 p-2"></div>`;
                }
            }
            
            html += `</div>`;
        });
        
        return html;
    }
</script>
{% endblock %}
