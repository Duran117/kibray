{% extends "core/base_modern.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Quick Planning" %} - Kibray{% endblock %}

{% block extra_css %}
<style>
    .quick-planner {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .mode-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 3rem;
    }
    
    .mode-card {
        background: white;
        border: 3px solid #e0e0e0;
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .mode-card:hover {
        border-color: #667eea;
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
    }
    
    .mode-card.selected {
        border-color: #28a745;
        background: #f0f9f4;
    }
    
    .mode-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    .mode-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .mode-description {
        color: #666;
        font-size: 0.95rem;
    }
    
    .quick-wizard {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    
    .step-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .step-number {
        display: inline-block;
        width: 40px;
        height: 40px;
        line-height: 40px;
        background: #667eea;
        color: white;
        border-radius: 50%;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    .chat-container {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 2rem;
        min-height: 400px;
        max-height: 500px;
        overflow-y: auto;
        margin-bottom: 1.5rem;
    }
    
    .chat-message {
        margin-bottom: 1.5rem;
        display: flex;
        gap: 1rem;
    }
    
    .chat-message.ai {
        justify-content: flex-start;
    }
    
    .chat-message.user {
        justify-content: flex-end;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.2rem;
    }
    
    .message-avatar.user {
        background: #28a745;
    }
    
    .message-content {
        flex: 1;
        max-width: 70%;
    }
    
    .message-bubble {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .chat-message.user .message-bubble {
        background: #28a745;
        color: white;
    }
    
    .chat-input-area {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    
    .chat-input-area textarea {
        flex: 1;
        padding: 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 1rem;
        resize: none;
        font-family: inherit;
    }
    
    .chat-input-area textarea:focus {
        border-color: #667eea;
        outline: none;
    }
    
    .send-btn {
        padding: 1rem 2rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .send-btn:hover {
        background: #5568d3;
        transform: translateY(-2px);
    }
    
    .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }
    
    .task-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .task-item {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .task-item:hover {
        border-color: #667eea;
        transform: translateX(4px);
    }
    
    .task-item.frog {
        border-color: #28a745;
        background: #f0f9f4;
        box-shadow: 0 4px 16px rgba(40, 167, 69, 0.2);
    }
    
    .task-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: #ffc107;
        color: #856404;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .task-badge.frog {
        background: #28a745;
        color: white;
    }
    
    .ai-reasoning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    
    .loading {
        text-align: center;
        padding: 2rem;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .energy-slider-container {
        margin: 2rem 0;
    }
    
    .energy-slider {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: linear-gradient(to right, #dc3545, #ffc107, #28a745);
        outline: none;
    }
    
    .energy-value {
        text-align: center;
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
        margin-top: 1rem;
    }
    
    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }
    
    .btn-primary {
        padding: 1rem 2rem;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
    }
    
    .btn-secondary {
        padding: 1rem 2rem;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
    }
    
    .btn-success {
        padding: 1rem 2rem;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-success:hover {
        background: #218838;
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="quick-planner">
    <div id="modeSelector" class="mode-selector">
        <div class="mode-card" data-mode="quick">
            <div class="mode-icon">‚ö°</div>
            <div class="mode-title">{% trans "Quick Mode" %}</div>
            <div class="mode-description">
                {% trans "AI-assisted planning in 3 simple steps" %}<br>
                <strong>~5 minutes</strong>
            </div>
        </div>
        
        <div class="mode-card" data-mode="full">
            <div class="mode-icon">üßò</div>
            <div class="mode-title">{% trans "Full Ritual" %}</div>
            <div class="mode-description">
                {% trans "Complete 8-step mindfulness ritual" %}<br>
                <strong>~15 minutes</strong>
            </div>
        </div>
    </div>
    
    <div id="quickWizard" style="display: none;">
        <!-- Step 1: Energy Check -->
        <div id="step1" class="quick-wizard" style="display: none;">
            <div class="step-header">
                <div class="step-number">1</div>
                <h2>{% trans "How's your energy today?" %}</h2>
                <p class="text-muted">{% trans "This helps AI suggest the best time blocks" %}</p>
            </div>
            
            <div class="energy-slider-container">
                <label style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; display: block;">
                    {% trans "Current Energy Level:" %}
                </label>
                <input type="range" min="1" max="10" value="5" class="energy-slider" id="energySlider">
                <div class="energy-value" id="energyValue">5</div>
            </div>
            
            <div class="action-buttons">
                <button type="button" class="btn-primary" onclick="nextStep()">
                    {% trans "Next" %} ‚Üí
                </button>
            </div>
        </div>
        
        <!-- Step 2: AI Brain Dump -->
        <div id="step2" class="quick-wizard" style="display: none;">
            <div class="step-header">
                <div class="step-number">2</div>
                <h2>{% trans "What's on your mind today?" %}</h2>
                <p class="text-muted">{% trans "AI will help you prioritize" %}</p>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="chat-message ai">
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            {% trans "Hi! Tell me everything you think you need to do today. Don't filter - just dump it all here." %}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <textarea id="brainDumpInput" rows="3" 
                    placeholder="{% trans 'Example: Review financial reports, call new client, update project schedule, team meeting...' %}"></textarea>
                <button type="button" class="send-btn" id="sendBtn" onclick="processBrainDump()">
                    ‚ö° {% trans "Process" %}
                </button>
            </div>
            
            <div class="action-buttons" style="margin-top: 1rem;">
                <button type="button" class="btn-secondary" onclick="prevStep()">
                    ‚Üê {% trans "Back" %}
                </button>
            </div>
        </div>
        
        <!-- Step 3: Review & Commit -->
        <div id="step3" class="quick-wizard" style="display: none;">
            <div class="step-header">
                <div class="step-number">3</div>
                <h2>{% trans "Your Strategic Plan" %}</h2>
                <p class="text-muted">{% trans "AI has prioritized your tasks" %}</p>
            </div>
            
            <div id="aiResults">
                <!-- AI results will be injected here -->
            </div>
            
            <div class="action-buttons">
                <button type="button" class="btn-secondary" onclick="prevStep()">
                    ‚Üê {% trans "Back" %}
                </button>
                <button type="button" class="btn-success" onclick="commitPlan()">
                    ‚úì {% trans "Commit to Plan" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentStep = 0;
let plannerData = {
    mode: null,
    energy_level: 5,
    brain_dump: '',
    ai_result: null
};

// Mode Selection
document.querySelectorAll('.mode-card').forEach(card => {
    card.addEventListener('click', function() {
        const mode = this.dataset.mode;
        plannerData.mode = mode;
        
        if (mode === 'full') {
            window.location.href = '{% url "strategic_planner" %}';
        } else {
            document.getElementById('modeSelector').style.display = 'none';
            document.getElementById('quickWizard').style.display = 'block';
            currentStep = 1;
            showStep(1);
        }
    });
});

// Energy Slider
document.getElementById('energySlider').addEventListener('input', function() {
    const value = this.value;
    document.getElementById('energyValue').textContent = value;
    plannerData.energy_level = parseInt(value);
});

function showStep(step) {
    for (let i = 1; i <= 3; i++) {
        document.getElementById(`step${i}`).style.display = i === step ? 'block' : 'none';
    }
}

function nextStep() {
    if (currentStep < 3) {
        currentStep++;
        showStep(currentStep);
    }
}

function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
    }
}

async function processBrainDump() {
    const input = document.getElementById('brainDumpInput');
    const text = input.value.trim();
    
    if (!text) {
        alert('{% trans "Please write something first" %}');
        return;
    }
    
    plannerData.brain_dump = text;
    
    // Add user message to chat
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.innerHTML += `
        <div class="chat-message user">
            <div class="message-content">
                <div class="message-bubble">${text}</div>
            </div>
            <div class="message-avatar user">üë§</div>
        </div>
    `;
    
    // Show loading
    chatContainer.innerHTML += `
        <div class="chat-message ai loading-msg">
            <div class="message-avatar">ü§ñ</div>
            <div class="message-content">
                <div class="message-bubble">
                    <div class="loading-spinner"></div>
                    {% trans "Processing with AI..." %}
                </div>
            </div>
        </div>
    `;
    
    input.value = '';
    document.getElementById('sendBtn').disabled = true;
    
    try {
        const response = await fetch('/api/v1/planner/ai/process-dump/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                text: text,
                energy_level: plannerData.energy_level
            })
        });
        
        const result = await response.json();
        plannerData.ai_result = result;
        
        // Remove loading message
        document.querySelector('.loading-msg').remove();
        
        // Add AI response
        chatContainer.innerHTML += `
            <div class="chat-message ai">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-content">
                    <div class="message-bubble">
                        ‚úì {% trans "Great! I've analyzed your tasks." %}<br>
                        <strong>${result.high_impact.length}</strong> {% trans "high-impact actions" %}<br>
                        <strong>${result.noise.length}</strong> {% trans "lower-priority items" %}<br><br>
                        {% trans "Let me show you the plan..." %}
                    </div>
                </div>
            </div>
        `;
        
        // Wait a moment then go to next step
        setTimeout(() => {
            renderResults(result);
            nextStep();
        }, 1500);
        
    } catch (error) {
        console.error('Error:', error);
        document.querySelector('.loading-msg').remove();
        alert('{% trans "Error processing your tasks. Please try again." %}');
        document.getElementById('sendBtn').disabled = false;
    }
}

async function renderResults(result) {
    const container = document.getElementById('aiResults');
    
    // Get AI frog suggestion
    let frogSuggestion = null;
    if (result.high_impact.length > 0) {
        const frogResponse = await fetch('/api/v1/planner/ai/suggest-frog/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                high_impact_items: result.high_impact,
                energy_level: plannerData.energy_level
            })
        });
        frogSuggestion = await frogResponse.json();
    }
    
    let html = `
        <div style="margin-bottom: 2rem;">
            <h4>{% trans "AI Analysis:" %}</h4>
            <p>${result.summary}</p>
        </div>
    `;
    
    if (result.high_impact.length > 0) {
        html += `<h4>‚ö° {% trans "High-Impact Actions (80/20 Rule):" %}</h4>`;
        html += `<div class="task-list">`;
        
        result.high_impact.forEach((item, idx) => {
            const isFrog = frogSuggestion && idx === frogSuggestion.recommended_index;
            html += `
                <div class="task-item ${isFrog ? 'frog' : ''}">
                    <span class="task-badge ${isFrog ? 'frog' : ''}">
                        ${isFrog ? 'üê∏ THE FROG' : '‚ö° High Impact'}
                    </span>
                    <h5>${item.text}</h5>
                    <p style="color: #666; margin: 0.5rem 0 0;">${item.reason}</p>
                    ${isFrog && frogSuggestion ? `
                        <div class="ai-reasoning">
                            <strong>{% trans "Why this is your Frog:" %}</strong><br>
                            ${frogSuggestion.reasoning}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        html += `</div>`;
    }
    
    if (result.noise.length > 0) {
        html += `
            <details style="margin-top: 2rem;">
                <summary style="cursor: pointer; font-weight: 600; color: #666;">
                    üå´Ô∏è {% trans "Lower Priority Items" %} (${result.noise.length})
                </summary>
                <div class="task-list" style="margin-top: 1rem;">
        `;
        
        result.noise.forEach(item => {
            html += `
                <div class="task-item">
                    <p style="margin: 0;">${item.text}</p>
                </div>
            `;
        });
        
        html += `</div></details>`;
    }
    
    container.innerHTML = html;
    plannerData.frog_suggestion = frogSuggestion;
}

async function commitPlan() {
    if (!plannerData.ai_result) {
        alert('{% trans "No plan to commit" %}');
        return;
    }
    
    try {
        // Get micro-steps for the frog
        const frogTask = plannerData.ai_result.high_impact[plannerData.frog_suggestion.recommended_index];
        
        const stepsResponse = await fetch('/api/v1/planner/ai/generate-steps/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                frog_title: frogTask.text,
                context: frogTask.reason
            })
        });
        
        const stepsResult = await stepsResponse.json();
        
        // Get time block suggestion
        const timeResponse = await fetch('/api/v1/planner/ai/suggest-time/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                frog_title: frogTask.text,
                energy_level: plannerData.energy_level,
                micro_steps: stepsResult.micro_steps
            })
        });
        
        const timeResult = await timeResponse.json();
        
        // Prepare data for ritual completion
        const ritualData = {
            physiology_check: true,
            energy_level: plannerData.energy_level,
            gratitude: ['AI-assisted planning', 'Clear priorities', 'Strategic focus'],
            daily_intention: 'Execute the Frog with focus',
            habits: [],
            brain_dump: plannerData.brain_dump,
            noise_items: plannerData.ai_result.noise,
            impact_items: plannerData.ai_result.high_impact,
            frog_id: `item-${plannerData.frog_suggestion.recommended_index}`,
            micro_steps: stepsResult.micro_steps,
            frog_start: timeResult.suggested_start,
            frog_end: timeResult.suggested_end
        };
        
        // Submit ritual
        const response = await fetch('/api/v1/planner/ritual/complete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(ritualData)
        });
        
        if (response.ok) {
            alert('{% trans "‚úì Your day is planned! Good luck with your Frog!" %}');
            window.location.href = '{% url "dashboard" %}';
        } else {
            alert('{% trans "Error saving plan. Please try again." %}');
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('{% trans "Error committing plan. Please try again." %}');
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
