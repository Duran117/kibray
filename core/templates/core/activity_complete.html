{% extends "core/base_modern.html" %}
{% load i18n %}

{% block title %}{% trans "Complete Activity" %}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="bi bi-check-circle"></i> {% trans "Complete Activity" %}</h4>
                </div>
                
                <div class="card-body">
                    <!-- Activity Info -->
                    <div class="alert alert-info">
                        <h5>{{ activity.title }}</h5>
                        <p class="mb-1"><strong>{% trans "Project:" %}</strong> {{ activity.daily_plan.project.name }}</p>
                        <p class="mb-0"><strong>{% trans "Date:" %}</strong> {{ activity.daily_plan.plan_date }}</p>
                    </div>
                    
                    {% if activity.description %}
                    <div class="mb-3">
                        <h6>{% trans "Description" %}</h6>
                        <p class="text-muted">{{ activity.description }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- Completion Form -->
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label class="form-label"><strong>{% trans "Progress Percentage" %} *</strong></label>
                            <div class="row align-items-center">
                                <div class="col-md-10">
                                    <input type="range" 
                                           class="form-range" 
                                           name="progress" 
                                           id="progressRange" 
                                           min="0" 
                                           max="100" 
                                           step="10" 
                                           value="100">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" 
                                           class="form-control" 
                                           id="progressValue" 
                                           value="100" 
                                           min="0" 
                                           max="100" 
                                           readonly>
                                </div>
                            </div>
                            <div class="progress mt-2" style="height: 30px;">
                                <div class="progress-bar bg-success" 
                                     id="progressBar" 
                                     role="progressbar" 
                                     style="width: 100%;">
                                    <span id="progressText">100%</span>
                                </div>
                            </div>
                            <small class="text-muted">
                                {% trans "Select the completion percentage for this activity" %}
                            </small>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label"><strong>{% trans "Upload Photos" %}</strong></label>
                            <input type="file" 
                                   class="form-control" 
                                   name="photos" 
                                   accept="image/*" 
                                   multiple>
                            <small class="text-muted">
                                {% trans "Upload photos showing the completed work. You can select multiple files." %}
                            </small>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label"><strong>{% trans "Internal Notes" %}</strong> <small class="text-muted">({% trans "Optional - Not shown to client" %})</small></label>
                            <textarea name="notes" 
                                      class="form-control" 
                                      rows="4" 
                                      placeholder="{% trans "Add any notes about this activity (in Spanish, for internal use only)" %}"></textarea>
                            <small class="text-muted">
                                {% trans "These notes are for internal use only and will not be shown to the client" %}
                            </small>
                        </div>
                        
                        <!-- Activity Checklist (if SOP exists) -->
                        {% if activity.activity_template and activity.activity_template.steps %}
                        <div class="mb-4">
                            <h6>{% trans "Checklist" %} - {{ activity.activity_template.name }}</h6>
                            <div class="card bg-light">
                                <div class="card-body">
                                    {% for step in activity.activity_template.steps %}
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="step{{ forloop.counter }}">
                                        <label class="form-check-label" for="step{{ forloop.counter }}">
                                            {{ step }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <small class="text-muted">
                                {% trans "Verify that all steps have been completed before submitting" %}
                            </small>
                        </div>
                        {% endif %}
                        
                        <!-- Submit buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle-fill"></i> {% trans "Mark as Complete" %}
                            </button>
                            <a href="{% url 'employee_morning_dashboard' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> {% trans "Cancel" %}
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Help Card -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6><i class="bi bi-info-circle"></i> {% trans "Important Information" %}</h6>
                    <ul class="mb-0 small">
                        <li>{% trans "Photos help document the quality of work for the client" %}</li>
                        <li>{% trans "Internal notes can include issues encountered, materials used, or time taken" %}</li>
                        <li>{% trans "If you can't complete 100%, indicate the percentage achieved" %}</li>
                        <li>{% trans "Contact your supervisor if you encounter any problems" %}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Sync range slider with number input and progress bar
const progressRange = document.getElementById('progressRange');
const progressValue = document.getElementById('progressValue');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');

function updateProgress() {
    const value = progressRange.value;
    progressValue.value = value;
    progressBar.style.width = value + '%';
    progressText.textContent = value + '%';
    
    // Change color based on progress
    if (value == 100) {
        progressBar.className = 'progress-bar bg-success';
    } else if (value >= 80) {
        progressBar.className = 'progress-bar bg-info';
    } else if (value >= 50) {
        progressBar.className = 'progress-bar bg-warning';
    } else {
        progressBar.className = 'progress-bar bg-danger';
    }
}

progressRange.addEventListener('input', updateProgress);
</script>

{% endblock %}
