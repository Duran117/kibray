{% extends "core/base_modern.html" %}
{% load static i18n %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">{% trans "Dashboard" %}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'project_list' %}">{% trans "Projects" %}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'project_overview' project.id %}">{{ project.name }}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'daily_log' project.id %}">{% trans "Daily Logs" %}</a></li>
      <li class="breadcrumb-item active">{% trans "Create" %}</li>
    </ol>
  </nav>

  <h2 class="mb-4"><i class="bi bi-journal-plus"></i> {% trans "Create Daily Log" %}</h2>

  <form method="post" enctype="multipart/form-data" id="dailyLogForm">
    {% csrf_token %}
    
    <div class="row">
      <!-- Left Column: Main Info -->
      <div class="col-lg-8">
        <!-- Basic Info Card -->
        <div class="card mb-4 border-0 shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-calendar-day"></i> {% trans "Basic Information" %}</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">{% trans "Date" %} <span class="text-danger">*</span></label>
                {{ form.date }}
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">{% trans "Weather" %}</label>
                {{ form.weather }}
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">{% trans "People Working" %}</label>
                {{ form.crew_count }}
              </div>
            </div>
          </div>
        </div>

        <!-- Schedule Progress Card -->
        <div class="card mb-4 border-0 shadow-sm">
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-bar-chart-line"></i> {% trans "Schedule Progress" %}</h5>
          </div>
          <div class="card-body">
            <p class="text-muted small">
              <i class="bi bi-info-circle"></i>
              {% trans "Select the main calendar activity worked on today (e.g.: Cover and Prep = 10% of total project)" %}
            </p>
            <div class="row">
              <div class="col-md-8 mb-3">
                <label class="form-label">{% trans "Schedule Activity" %}</label>
                {{ form.schedule_item }}
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">{% trans "Progress (%)" %}</label>
                {{ form.schedule_progress_percent }}
              </div>
            </div>

            <!-- Active Schedules Reference -->
            {% if active_schedules %}
            <div class="mt-3">
              <h6 class="small text-muted">{% trans "Recent Activities:" %}</h6>
              <div class="list-group list-group-flush">
                {% for sched in active_schedules|slice:":5" %}
                <div class="list-group-item px-0 py-2 small">
                  <i class="bi bi-calendar-event"></i> <strong>{{ sched.title }}</strong>
                  <span class="text-muted">- {{ sched.start_datetime|date:"M d" }}</span>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Completed Tasks Card -->
        <div class="card mb-4 border-0 shadow-sm">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-check2-square"></i> {% trans "Tasks Completed Today" %}</h5>
          </div>
          <div class="card-body">
            <p class="text-muted small">
              <i class="bi bi-info-circle"></i>
              {% trans "Select tasks that were completed or significantly progressed today." %}
            </p>
            
            <div class="mb-3">
              {{ form.completed_tasks }}
            </div>

            <!-- Pending Tasks Reference -->
            {% if pending_tasks %}
            <div class="mt-3">
              <h6 class="small text-muted">{% trans "Active Project Tasks:" %}</h6>
              <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                {% for task in pending_tasks|slice:":10" %}
                <div class="list-group-item px-0 py-2 small">
                  <i class="bi bi-circle{% if task.status == 'in_progress' %}-half text-warning{% else %} text-secondary{% endif %}"></i>
                  <strong>{{ task.title }}</strong>
                  {% if task.assigned_to %}
                  <span class="text-muted">- {{ task.assigned_to }}</span>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Photos Card -->
        <div class="card mb-4 border-0 shadow-sm">
          <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-camera"></i> {% trans "Photos" %}</h5>
          </div>
          <div class="card-body">
            <p class="text-muted small">
              <i class="bi bi-info-circle"></i>
              {% trans "Upload photos of today's progress. You can select multiple files." %}
            </p>
            <div class="mb-3">
              <label class="form-label">{% trans "Photos" %}</label>
              <input type="file" name="photos" class="form-control" accept="image/*" multiple>
            </div>
            <div class="mb-3">
              <label class="form-label">{% trans "Photo Description" %}</label>
              <input type="text" name="photo_caption" class="form-control" placeholder="{% trans 'General description of the photos...' %}">
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Notes & Details -->
      <div class="col-lg-4">
        <!-- Accomplishments Card -->
        <div class="card mb-4 border-0 shadow-sm">
          <div class="card-header bg-white border-bottom">
            <h6 class="mb-0"><i class="bi bi-trophy"></i> {% trans "Today's Accomplishments" %}</h6>
          </div>
          <div class="card-body">
            {{ form.accomplishments }}
          </div>
        </div>

        <!-- Progress Notes Card -->
        <div class="card mb-4 border-0 shadow-sm">
          <div class="card-header bg-white border-bottom">
            <h6 class="mb-0"><i class="bi bi-clipboard-check"></i> {% trans "Progress Notes" %}</h6>
          </div>
          <div class="card-body">
            {{ form.progress_notes }}
          </div>
        </div>

        <!-- Safety & Issues Card -->
        <div class="card mb-4 border-0 shadow-sm">
          <div class="card-header bg-white border-bottom">
            <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> {% trans "Safety & Incidents" %}</h6>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label small">{% trans "Safety Incidents" %}</label>
              {{ form.safety_incidents }}
            </div>
            <div class="mb-0">
              <label class="form-label small">{% trans "Delays or Issues" %}</label>
              {{ form.delays }}
            </div>
          </div>
        </div>

        <!-- Next Day Plan Card -->
        <div class="card mb-4 border-0 shadow-sm">
          <div class="card-header bg-white border-bottom">
            <h6 class="mb-0"><i class="bi bi-calendar-plus"></i> {% trans "Plan for Tomorrow" %}</h6>
          </div>
          <div class="card-body">
            {{ form.next_day_plan }}
          </div>
        </div>

        <!-- Publish Options Card -->
        <div class="card mb-4 border-0 shadow-sm">
          <div class="card-header bg-white border-bottom">
            <h6 class="mb-0"><i class="bi bi-eye"></i> {% trans "Visibility" %}</h6>
          </div>
          <div class="card-body">
            <div class="form-check">
              {{ form.is_published }}
              <label class="form-check-label" for="{{ form.is_published.id_for_label }}">
                {% trans "Publish for client/owner" %}
              </label>
            </div>
            <small class="text-muted d-block mt-2">
              {% trans "If not checked, only PM and staff will see this log." %}
            </small>
          </div>
        </div>

        <!-- Submit Buttons -->
        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-check-lg"></i> {% trans "Create Daily Log" %}
          </button>
          <a href="{% url 'daily_log' project.id %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-lg"></i> {% trans "Cancel" %}
          </a>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %}
