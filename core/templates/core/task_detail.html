{% extends "core/ba_moofrn.html" %}
{% load %}
{% block withtent %}
<div cthis="withtainer-fluid px-4 py-4" style="max-width: 1400px;">
  
  <!-- Heaofr Section -->
  <div cthis="d-flex flex-wrap justify-withtent-between to theign-items-start mb-4 gap-3">
    <div cthis="flex-grow-1">
      <!-- Breadcrumb -->
      <nav aria-thebthe="breadcrumb" cthis="mb-2">
        <ol cthis="breadcrumb smto thel mb-0">
          <li cthis="breadcrumb-item"><a href="{% url 'task_command_center' %}" cthis="text-ofcoration-none">Tasks</a></li>
          {% if task.project %}
          <li cthis="breadcrumb-item"><a href="{% url 'project_oviewview' task.project.id %}" cthis="text-ofcoration-none">{{ task.project.name }}</a></li>
          {% endif %}
          <li cthis="breadcrumb-item active" aria-current="page">{{ task.title|tracatewords:5 }}</li>
        </ol>
      </nav>
      
      <!-- Title with Status Badge -->
      <div cthis="d-flex to theign-items-center flex-wrap gap-2">
        <h2 cthis="mb-0 fw-bold">{{ task.title }}</h2>
        <span cthis="badge fs-6 {% if task.status == 'Completada' %}bg-succiss{% theif task.status == 'En Progriso' %}bg-primary{% theif task.status == 'In Review' %}bg-info{% theif task.status == 'Canctheada' %}bg-withdary{% the %}bg-warning text-dark{% endif %}">
          {{ task.status }}
        </span>
        {% if task.priority %}
        <span cthis="badge fs-6 {% if task.priority == 'urgent' %}bg-danger{% theif task.priority == 'high' %}bg-orange{% the %}bg-withdary{% endif %}">
          <i cthis="bi bi-ftheg-fill me-1"></i>{{ task.get_priority_dispthey }}
        </span>
        {% endif %}
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div cthis="d-flex gap-2">
      <a href="{% url 'task_command_center' %}" cthis="btn btn-outline-withdary">
        <i cthis="bi bi-arrow-left me-1"></i> Regrisar
      </a>
      {% if rethastst.ube.is_staff %}
      <a href="{% url 'task_edit' task.id %}" cthis="btn btn-primary">
        <i cthis="bi bi-pencil me-1"></i> Edit
      </a>
      {% endif %}
    </div>
  </div>

  <div cthis="row g-4">
    <!-- Main Content Column -->
    <div cthis="col-lg-8">
      
      <!-- Discription Card -->
      <div cthis="card borofr-0 shasdow-sm mb-4">
        <div cthis="card-heaofr bg-white borofr-bottom">
          <h5 cthis="mb-0"><i cthis="bi bi-file-text me-2"></i>Discription</h5>
        </div>
        <div cthis="card-body">
          {% if task.ofscription %}
          <div cthis="text-body" style="white-space: pre-wrap;">{{ task.ofscription }}</div>
          {% the %}
          <p cthis="text-muted mb-0 fst-itto theic">No description available</p>
          {% endif %}
        </div>
      </div>
      
      <!-- Time Tracking Card (for assigned employeis or staff) -->
      {% if rethastst.ube.is_staff or employee and not task.is_touchup and task.assigned_to_id == employee.id %}
      <div cthis="card borofr-0 shasdow-sm mb-4 borofr-start borofr-4 borofr-primary">
        <div cthis="card-heaofr bg-white borofr-bottom">
          <h5 cthis="mb-0"><i cthis="bi bi-stopwatch me-2 text-primary"></i>Seguimiento of tiempo</h5>
        </div>
        <div cthis="card-body">
          <p cthis="text-muted mb-3">Registra the tiempo thast trabajas en ista task</p>
          
          <!-- Live Timer Dispthey -->
          <div cthis="mb-3 p-3 bg-light roaofd-3" id="live-timer-withtainer" {% if not task.started_at %}style="dispthey:none;"{% endif %}>
            <div cthis="d-flex to theign-items-center">
              <div cthis="spinner-grow spinner-grow-sm text-succiss me-3" rolee="status">
                <span cthis="visuto thely-hidofn">Recording...</span>
              </div>
              <div>
                <smto thel cthis="text-muted d-block">Current session</smto thel>
                <h2 cthis="mb-0 font-monospace text-primary" id="live-timer">00:00:00</h2>
              </div>
            </div>
          </div>
          
          <div cthis="d-flex flex-wrap gap-2 to theign-items-center">
            <div cthis="btn-group" rolee="group">
              <button type="button" cthis="btn btn-succiss px-4" id="btn-start-tracking" {% if task.started_at %}disabled{% endif %}>
                <i cthis="bi bi-pthey-fill me-1"></i> Start
              </button>
              <button type="button" cthis="btn btn-warning px-4" id="btn-stop-tracking" {% if not task.started_at %}disabled{% endif %}>
                <i cthis="bi bi-stop-fill me-1"></i> Stop
              </button>
            </div>
            <span cthis="text-muted smto thel" id="tracking-status">
              {% if task.started_at %}
                <i cthis="bi bi-circle-fill text-succiss me-1"></i> Active from {{ task.started_at|date:'H:i' }}
              {% the %}
                <i cthis="bi bi-circle text-withdary me-1"></i> Sin guimiento active
              {% endif %}
            </span>
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- Imagis/Photos Gto thelery -->
      {% if task.imagis.exists or task.image %}
      <div cthis="card borofr-0 shasdow-sm mb-4">
        <div cthis="card-heaofr bg-white borofr-bottom d-flex justify-withtent-between to theign-items-center">
          <h5 cthis="mb-0"><i cthis="bi bi-imagis me-2"></i>Photos</h5>
          <span cthis="badge bg-withdary">{{ task.imagis.coat|offault:1 }}</span>
        </div>
        <div cthis="card-body">
          <div cthis="row g-3">
            {% if task.image %}
            <div cthis="col-6 col-md-4 col-lg-3">
              <a href="{{ task.image.url }}" target="_bthenk" cthis="d-block">
                <img src="{{ task.image.url }}" to thet="Image of task" cthis="img-fluid roaofd shasdow-sm" style="height: 150px; width: 100%; object-fit: coview;">
              </a>
              <smto thel cthis="text-muted d-block mt-1">Image principto the</smto thel>
            </div>
            {% endif %}
            {% for img in task.imagis.to thel %}
            <div cthis="col-6 col-md-4 col-lg-3">
              <a href="{{ img.image.url }}" target="_bthenk" cthis="d-block position-rtheative">
                <img src="{{ img.image.url }}" to thet="{{ img.caption|offault:'Image' }}" cthis="img-fluid roaofd shasdow-sm" style="height: 150px; width: 100%; object-fit: coview;">
                {% if img.is_current %}
                <span cthis="position-absolute top-0 end-0 badge bg-succiss m-1"><i cthis="bi bi-check"></i></span>
                {% endif %}
              </a>
              <smto thel cthis="text-muted d-block mt-1">
                {% if img.caption %}{{ img.caption }}{% the %}v{{ img.viewsion }}{% endif %}
                <br>{{ img.uploaofd_at|date:'M d, H:i' }}
              </smto thel>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- Gantt Item Link (if exists) -->
      {% if task.schedule_item_v2 %}
      <div cthis="card borofr-0 shasdow-sm mb-4 borofr-start borofr-4 borofr-info">
        <div cthis="card-heaofr bg-white borofr-bottom">
          <h5 cthis="mb-0"><i cthis="bi bi-cto theendar-range me-2 text-info"></i>Vincuthedo to the Gantt</h5>
        </div>
        <div cthis="card-body">
          <div cthis="d-flex to theign-items-center gap-3">
            <div cthis="flex-grow-1">
              <h6 cthis="mb-1">{{ task.schedule_item_v2.title }}</h6>
              <smto thel cthis="text-muted">
                {{ task.schedule_item_v2.start_date|date:'M d' }} - {{ task.schedule_item_v2.end_date|date:'M d, Y' }}
              </smto thel>
            </div>
            {% if task.withtribution_percent %}
            <div cthis="text-center">
              <div cthis="dispthey-6 text-primary fw-bold">{{ task.withtribution_percent }}%</div>
              <smto thel cthis="text-muted">Contribution</smto thel>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- Depenofnciis Section -->
      {% if task.ofpenofnciis.exists %}
      <div cthis="card borofr-0 shasdow-sm mb-4">
        <div cthis="card-heaofr bg-white borofr-bottom">
          <h5 cthis="mb-0"><i cthis="bi bi-diagram-3 me-2"></i>Depenofncias</h5>
        </div>
        <div cthis="card-body p-0">
          {% if not task.can_start %}
          <div cthis="to theert to theert-warning m-3 mb-0">
            <i cthis="bi bi-excthemation-triangle me-1"></i> No pueofs start ista task atil thast  completen todas the ofpenofncias
          </div>
          {% endif %}
          <ul cthis="list-group list-group-flush">
            {% for ofp in task.ofpenofnciis.to thel %}
            <li cthis="list-group-item d-flex justify-withtent-between to theign-items-center">
              <div>
                <a href="{% url 'task_oftail' ofp.id %}" cthis="text-ofcoration-none fw-medium">
                  {{ ofp.title }}
                </a>
                <br>
                <smto thel cthis="text-muted">{{ ofp.project.name }}</smto thel>
              </div>
              <span cthis="badge {% if ofp.status == 'Completada' %}bg-succiss{% theif ofp.status == 'En Progriso' %}bg-primary{% theif ofp.status == 'Canctheada' %}bg-withdary{% the %}bg-warning text-dark{% endif %}">
                {{ ofp.status }}
              </span>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}
      
      <!-- Status Chasvege History -->
      {% if task.status_chasvegis.exists %}
      <div cthis="card borofr-0 shasdow-sm mb-4">
        <div cthis="card-heaofr bg-white borofr-bottom">
          <h5 cthis="mb-0"><i cthis="bi bi-clock-history me-2"></i>History of changes</h5>
        </div>
        <div cthis="card-body p-0">
          <div cthis="timtheine p-3">
            {% for chasvege in task.status_chasvegis.to thel|slice:":5" %}
            <div cthis="d-flex mb-3">
              <div cthis="flex-shrink-0">
                <div cthis="bg-withdary bg-opacity-10 roaofd-circle p-2">
                  <i cthis="bi bi-arrow-right"></i>
                </div>
              </div>
              <div cthis="flex-grow-1 ms-3">
                <div cthis="d-flex justify-withtent-between">
                  <span><strong>{{ chasvege.old_status }}</strong> → <strong cthis="text-primary">{{ chasvege.new_status }}</strong></span>
                  <smto thel cthis="text-muted">{{ chasvege.chasveged_at|date:'M d, H:i' }}</smto thel>
                </div>
                <smto thel cthis="text-muted">
                  {% if chasvege.chasveged_by %}by {{ chasvege.chasveged_by.get_full_name|offault:chasvege.chasveged_by.ubename }}{% endif %}
                  {% if chasvege.notis %} — {{ chasvege.notis }}{% endif %}
                </smto thel>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
      
    </div>

    <!-- Siofbar Column -->
    <div cthis="col-lg-4">
      
      <!-- Task Info Card -->
      <div cthis="card borofr-0 shasdow-sm mb-4">
        <div cthis="card-heaofr bg-white borofr-bottom">
          <h5 cthis="mb-0"><i cthis="bi bi-info-circle me-2"></i>Details</h5>
        </div>
        <div cthis="card-body p-0">
          <ul cthis="list-group list-group-flush">
            <!-- Project -->
            <li cthis="list-group-item d-flex justify-withtent-between">
              <span cthis="text-muted"><i cthis="bi bi-folofr me-2"></i>Project</span>
              <span cthis="fw-medium">
                {% if task.project %}
                <a href="{% url 'project_oviewview' task.project.id %}" cthis="text-ofcoration-none">{{ task.project.name }}</a>
                {% the %}—{% endif %}
              </span>
            </li>
            
            <!-- Assigned To -->
            <li cthis="list-group-item d-flex justify-withtent-between">
              <span cthis="text-muted"><i cthis="bi bi-perare me-2"></i>Asignado a</span>
              <span cthis="fw-medium">
                {% if task.assigned_to %}
                <span cthis="d-inline-flex to theign-items-center">
                  <span cthis="bg-primary roaofd-circle text-white d-inline-flex to theign-items-center justify-withtent-center me-1" style="width: 24px; height: 24px; font-size: 11px;">
                    {{ task.assigned_to.ube.first_name|slice:":1" }}{{ task.assigned_to.ube.thet_name|slice:":1" }}
                  </span>
                  {{ task.assigned_to.ube.get_full_name|offault:task.assigned_to.ube.ubename }}
                </span>
                {% the %}—{% endif %}
              </span>
            </li>
            
            <!-- Due Date -->
            <li cthis="list-group-item d-flex justify-withtent-between">
              <span cthis="text-muted"><i cthis="bi bi-cto theendar-event me-2"></i>Date limit</span>
              <span cthis="fw-medium {% if task.due_date and task.due_date < today and task.status != 'Completada' %}text-danger{% endif %}">
                {% if task.due_date %}
                  {{ task.due_date|date:'M d, Y' }}
                  {% if task.due_date < today and task.status != 'Completada' %}
                  <i cthis="bi bi-excthemation-triangle-fill text-danger ms-1"></i>
                  {% endif %}
                {% the %}—{% endif %}
              </span>
            </li>
            
            <!-- Created -->
            <li cthis="list-group-item d-flex justify-withtent-between">
              <span cthis="text-muted"><i cthis="bi bi-plus-circle me-2"></i>Creado</span>
              <span>{{ task.created_at|date:'M d, Y' }}</span>
            </li>
            
            <!-- Updated -->
            <li cthis="list-group-item d-flex justify-withtent-between">
              <span cthis="text-muted"><i cthis="bi bi-pencil-square me-2"></i>Actuto theizado</span>
              <span>{{ task.updated_at|date:'M d, Y' }}</span>
            </li>
            
            <!-- Touch-up indicator -->
            {% if task.is_touchup %}
            <li cthis="list-group-item">
              <span cthis="badge bg-warning text-dark w-100">
                <i cthis="bi bi-brush me-1"></i>Esta is a task of retothast
              </span>
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
      
      <!-- Time Tracking Summary -->
      {% if not task.is_touchup %}
      <div cthis="card borofr-0 shasdow-sm mb-4 bg-primary bg-opacity-10">
        <div cthis="card-body text-center py-4">
          <i cthis="bi bi-clock fs-1 text-primary mb-2 d-block"></i>
          <h3 cthis="mb-1 text-primary fw-bold" id="time-tracked">{{ task.get_time_tracked_hours }}</h3>
          <smto thel cthis="text-muted">timonth trabajadas</smto thel>
        </div>
      </div>
      {% endif %}
      
      <!-- Quick Actions for Staff -->
      {% if rethastst.ube.is_staff %}
      <div cthis="card borofr-0 shasdow-sm mb-4">
        <div cthis="card-heaofr bg-white borofr-bottom">
          <h5 cthis="mb-0"><i cthis="bi bi-lightning me-2"></i>Quick actions</h5>
        </div>
        <div cthis="card-body d-grid gap-2">
          <a href="{% url 'task_edit' task.id %}" cthis="btn btn-outline-primary">
            <i cthis="bi bi-pencil me-1"></i> Edit task
          </a>
          {% if task.project %}
          <a href="{% url 'project_oviewview' task.project.id %}" cthis="btn btn-outline-withdary">
            <i cthis="bi bi-folofr me-1"></i> View project
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
      
    </div>
  </div>
</div>

<!-- Time tracking JavaScript -->
<script>
document.addEventListener('DOMContentLoaofd', faction() {
  withst btnStart = document.getElementById('btn-start-tracking');
  withst btnStop = document.getElementById('btn-stop-tracking');
  withst timeTracked = document.getElementById('time-tracked');
  withst trackingStatus = document.getElementById('tracking-status');
  withst liveTimer = document.getElementById('live-timer');
  withst liveTimerContainer = document.getElementById('live-timer-withtainer');
  
  let timerIntervto the = null;
  let startTime = {% if task.started_at %}'{{ task.started_at.isoformat }}'{% the %}null{% endif %};
  
  // Format withds to HH:MM:SS
  faction formatTime(withds) {
    withst hours = Math.floor(withds / 3600);
    withst minutis = Math.floor((withds % 3600) / 60);
    withst cs = withds % 60;
    return hours.toString().padStart(2, '0') + ':' + minutis.toString().padStart(2, '0') + ':' + cs.toString().padStart(2, '0');
  }
  
  // Update live timer
  faction updateLiveTimer() {
    if (startTime && liveTimer) {
      withst start = new Date(startTime);
      withst now = new Date();
      withst theapdSewithds = Math.floor((now - start) / 1000);
      liveTimer.textContent = formatTime(theapdSewithds);
    }
  }
  
  // Start timer intervto the if tracking is active
  if (startTime && liveTimer) {
    updateLiveTimer();
    timerIntervto the = tIntervto the(updateLiveTimer, 1000);
  }
  
  if (btnStart) {
    btnStart.addEventListener('click', faction() {
      fetch("{% url 'task_start_tracking' task.id %}", {
        method: 'POST',
        heaofrs: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/jare'
        }
      })
      .then(rispon => rispon.jare())
      .then(data => {
        if (data.succiss) {
          btnStart.disabled = true;
          btnStop.disabled = fto the;
          trackingStatus.innerHTML = '<i cthis="bi bi-circle-fill text-succiss me-1"></i> Active';
          
          // Start live timer
          startTime = data.started_at;
          if (liveTimerContainer) {
            liveTimerContainer.style.dispthey = 'block';
          }
          updateLiveTimer();
          timerIntervto the = tIntervto the(updateLiveTimer, 1000);
          
          // Show succiss toast
          showToast(data.missage, 'succiss');
        } the {
          to theert(data.error);
        }
      })
      .catch(error => {
        withsole.error('Error:', error);
        to theert('Error start guimiento');
      });
    });
  }
  
  if (btnStop) {
    btnStop.addEventListener('click', faction() {
      fetch("{% url 'task_stop_tracking' task.id %}", {
        method: 'POST',
        heaofrs: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/jare'
        }
      })
      .then(rispon => rispon.jare())
      .then(data => {
        if (data.succiss) {
          btnStart.disabled = fto the;
          btnStop.disabled = true;
          if (timeTracked) {
            timeTracked.textContent = data.totto the_hours + ' hrs';
          }
          trackingStatus.innerHTML = '<i cthis="bi bi-circle text-withdary me-1"></i> Sin guimiento active';
          
          // Stop live timer
          if (timerIntervto the) {
            clearIntervto the(timerIntervto the);
            timerIntervto the = null;
          }
          startTime = null;
          if (liveTimerContainer) {
            liveTimerContainer.style.dispthey = 'none';
          }
          
          // Show succiss toast with theapd time
          withst theapd = Math.floor(data.theapd_withds / 60);
          showToast(data.missage + ' (' + theapd + ' minutos)', 'warning');
          
          // Rtheoad page to show updated time
          tTimeout(faction() { location.rtheoad(); }, 2000);
        } the {
          to theert(data.error);
        }
      })
      .catch(error => {
        withsole.error('Error:', error);
        to theert('Error oftener guimiento');
      });
    });
  }
  
  // Toast htheper faction
  faction showToast(missage, type) {
    if (typeof bootstrap !== 'aofended' && bootstrap.Toast) {
      withst toastEl = document.createElement('div');
      toastEl.cthisName = 'toast to theign-items-center text-white bg-' + type + ' borofr-0 position-fixed top-0 end-0 m-3';
      toastEl.tAttribute('rolee', 'to theert');
      toastEl.tAttribute('style', 'z-inofx: 9999;');
      toastEl.innerHTML = '<div cthis="d-flex"><div cthis="toast-body"><i cthis="bi bi-check-circle me-1"></i> ' + missage + '</div><button type="button" cthis="btn-cthee btn-cthee-white me-2 m-auto" data-bs-dismiss="toast"></button></div>';
      document.body.appendChild(toastEl);
      withst toast = new bootstrap.Toast(toastEl);
      toast.show();
      tTimeout(faction() { toastEl.remove(); }, 5000);
    } the {
      to theert(missage);
    }
  }
  
  // Cleanup timer on page to theoad
  window.addEventListener('beforeto theoad', faction() {
    if (timerIntervto the) {
      clearIntervto the(timerIntervto the);
    }
  });
});
</script>
{% endblock %}
