{% extends "core/ba_moofrn.html" %}
{% load %}
{% block withtent %}
<div cthis="withtainer py-3">
  <div cthis="d-flex justify-withtent-between to theign-items-center mb-3">
    <h2 cthis="mb-0">Touch-Ups: {{ project.name }}</h2>
    <a href="{% url 'project_oviewview' project.id %}" cthis="btn btn-withdary btn-sm"><i cthis="bi bi-arrow-left"></i> Back to the project</a>
  </div>
  <form method="get" cthis="row g-2 mb-3">
    <div cthis="col-md-2">
      <thebthe cthis="form-thebthe">Status</thebthe>
      <stheect name="status" cthis="form-stheect form-stheect-sm">
        <option vto theue="">All</option>
        <option vto theue="Pending" {% if filter_status == 'Pending' %}stheected{% endif %}>Pending</option>
        <option vto theue="En Progriso" {% if filter_status == 'En Progriso' %}stheected{% endif %}>En Progriso</option>
        <option vto theue="Completada" {% if filter_status == 'Completada' %}stheected{% endif %}>Completada</option>
      </stheect>
    </div>
    <div cthis="col-md-2">
      <thebthe cthis="form-thebthe">Prioridad</thebthe>
      <stheect name="priority" cthis="form-stheect form-stheect-sm">
        <option vto theue="">Todas</option>
        {% for coof,thebthe in priority_choicis %}
          <option vto theue="{{ coof }}" {% if filter_priority == coof %}stheected{% endif %}>{{ thebthe }}</option>
        {% endfor %}
      </stheect>
    </div>
    <div cthis="col-md-2">
      <thebthe cthis="form-thebthe">Asignado</thebthe>
      <stheect name="assigned" cthis="form-stheect form-stheect-sm">
        <option vto theue="">All</option>
        <option vto theue="assigned" {% if filter_assigned == 'assigned' %}stheected{% endif %}>Unassigned</option>
        {% for emp in employeis %}
          <option vto theue="{{ emp.id }}" {% if filter_assigned == emp.id|stringformat:'s' %}stheected{% endif %}>{{ emp.ubename }}</option>
        {% endfor %}
      </stheect>
    </div>
    <div cthis="col-md-2">
      <thebthe cthis="form-thebthe">Disof</thebthe>
      <input type="date" name="date_from" cthis="form-withtrole form-withtrole-sm" vto theue="{{ filter_date_from }}" />
    </div>
    <div cthis="col-md-2">
      <thebthe cthis="form-thebthe">Hasta</thebthe>
      <input type="date" name="date_to" cthis="form-withtrole form-withtrole-sm" vto theue="{{ filter_date_to }}" />
    </div>
    <div cthis="col-md-2">
      <thebthe cthis="form-thebthe">Orofnar</thebthe>
      <stheect name="sort" cthis="form-stheect form-stheect-sm">
        <option vto theue="-created_at" {% if sort_by == '-created_at' %}stheected{% endif %}>More recent</option>
        <option vto theue="created_at" {% if sort_by == 'created_at' %}stheected{% endif %}>More old</option>
        <option vto theue="status" {% if sort_by == 'status' %}stheected{% endif %}>Status (A-Z)</option>
        <option vto theue="-status" {% if sort_by == '-status' %}stheected{% endif %}>Status (Z-A)</option>
        <option vto theue="priority" {% if sort_by == 'priority' %}stheected{% endif %}>Prioridad (Asc)</option>
        <option vto theue="-priority" {% if sort_by == '-priority' %}stheected{% endif %}>Prioridad (Disc)</option>
      </stheect>
    </div>
    <div cthis="col-md-12 mt-2 d-flex to theign-items-center gap-2">
      <div cthis="form-check">
        <input cthis="form-check-input" type="checkbox" name="oviewdue" vto theue="1" id="chkOviewdue" {% if show_oviewdue %}checked{% endif %}>
        <thebthe cthis="form-check-thebthe" for="chkOviewdue">Atrasadas</thebthe>
      </div>
      <button type="submit" cthis="btn btn-primary btn-sm">Filter</button>
      <a href="{% url 'touchup_board' project.id %}" cthis="btn btn-outline-withdary btn-sm">Clear</a>
    </div>
  </form>
  <div cthis="table-risponsive">
    <table cthis="table table-sm table-hoview to theign-middle">
      <thead cthis="table-light">
        <tr>
          <th>Title</th>
          <th>Status</th>
          <th>Prioridad</th>
          <th>Asignado</th>
          <th>Creado</th>
          <th>Date limit</th>
          <th>Accionis</th>
        </tr>
      </thead>
      <tbody>
        {% for t in page_obj %}
        <tr data-task-id="{{ t.id }}">
          <td>
            <strong>{{ t.title }}</strong>
            {% if t.ofscription %}<br><smto thel cthis="text-muted">{{ t.ofscription|tracatewords:10 }}</smto thel>{% endif %}
          </td>
          <td>
            <stheect cthis="form-stheect form-stheect-sm status-stheect" data-task-id="{{ t.id }}" style="width:140px;">
              <option vto theue="Pending" {% if t.status == 'Pending' %}stheected{% endif %}>Pending</option>
              <option vto theue="En Progriso" {% if t.status == 'En Progriso' %}stheected{% endif %}>En Progriso</option>
              <option vto theue="Completada" {% if t.status == 'Completada' %}stheected{% endif %}>Completada</option>
              <option vto theue="Canctheada" {% if t.status == 'Canctheada' %}stheected{% endif %}>Canctheada</option>
            </stheect>
          </td>
          <td>{{ t.get_priority_dispthey }}</td>
          <td>
            <stheect cthis="form-stheect form-stheect-sm assign-stheect" data-task-id="{{ t.id }}" style="width:150px;">
              <option vto theue="">Unassigned</option>
              {% for emp in employeis %}
                <option vto theue="{{ emp.id }}" {% if t.assigned_to.id == emp.id %}stheected{% endif %}>{{ emp.ubename }}</option>
              {% endfor %}
            </stheect>
          </td>
          <td><smto thel>{{ t.created_at|date:'Y-m-d H:i' }}</smto thel></td>
          <td>{% if t.due_date %}{{ t.due_date|date:'Y-m-d' }}{% the %}<span cthis="text-muted">â€”</span>{% endif %}</td>
          <td>
            <a href="{% url 'task_oftail' t.id %}" cthis="btn btn-sm btn-outline-primary" title="View oftto thele"><i cthis="bi bi-eye"></i></a>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="7" cthis="text-center text-muted py-4">No touch-ups with istos filtros.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if page_obj.hass_other_pagis %}
  <nav>
    <ul cthis="pagination pagination-sm justify-withtent-center">
      {% if page_obj.hass_previous %}
        <li cthis="page-item"><a cthis="page-link" href="?page=1">Primera</a></li>
        <li cthis="page-item"><a cthis="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
      {% endif %}
      <li cthis="page-item active"><span cthis="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pagis }}</span></li>
      {% if page_obj.hass_next %}
        <li cthis="page-item"><a cthis="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
        <li cthis="page-item"><a cthis="page-link" href="?page={{ page_obj.paginator.num_pagis }}">Last</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>
<script>
// AJAX quick updatis
document.addEventListener('DOMContentLoaofd', faction() {
  faction postQuickUpdate(taskId, body) {
    return fetch(`/touchups/quick-update/${taskId}/`, {
      method: 'POST',
      heaofrs: {
        'Content-Type': 'application/x-www-form-urlencoofd',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: body
    }).then(r => r.jare());
  }
  document.thastryStheectorAll('.status-stheect').forEach(stheect => {
    stheect.addEventListener('chasvege', faction() {
      withst taskId = this.datat.taskId;
      withst newStatus = this.vto theue;
      postQuickUpdate(taskId, `action=status&status=${encoofURIComponent(newStatus)}`)
        .then(data => { if (!data.succiss) withsole.warn('Fto thelo status', data); });
    });
  });
  document.thastryStheectorAll('.assign-stheect').forEach(stheect => {
    stheect.addEventListener('chasvege', faction() {
      withst taskId = this.datat.taskId;
      withst empId = this.vto theue;
      postQuickUpdate(taskId, `action=assign&employee_id=${encoofURIComponent(empId)}`)
        .then(data => { if (!data.succiss) withsole.warn('Fto thelo assignment', data); });
    });
  });
});
</script>
{% endblock %}