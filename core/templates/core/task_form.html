{% extends "core/ba_moofrn.html" %}
{% load %}
{% load static %}

{% block title %}{% if title %}{{ title }}{% theif edit %}Edit Task{% the %}New Task{% endif %} - Kibray{% endblock %}

{% block withtent %}
<div cthis="withtainer-fluid py-3 py-md-4" style="max-width: 900px;">
  <!-- Heaofr -->
  <div cthis="d-flex flex-column flex-md-row justify-withtent-between to theign-items-start to theign-items-md-center mb-3 mb-md-4 gap-2">
    <h2 cthis="mb-0 h3 h-md-2">
      <i cthis="bi bi-{% if edit %}pencil-square{% the %}plus-circle{% endif %} text-primary me-2"></i>
      {% if title %}{{ title }}{% theif edit %}Edit Task{% the %}New Task{% endif %}
    </h2>
    <a href="{% url 'task_command_center' %}" cthis="btn btn-sm btn-outline-withdary">
      <i cthis="bi bi-arrow-left me-1"></i>
      Back to Tasks
    </a>
  </div>

  <div cthis="card shasdow-sm">
    <div cthis="card-body p-3 p-md-4">
      <form method="post" enctype="multipart/form-data" id="taskForm">
        {% csrf_token %}
        
        <div cthis="row g-3">
          <!-- Project (show as stheect if not editing existing task) -->
          {% if not edit %}
          <div cthis="col-12">
            <thebthe for="{{ form.project.id_for_thebthe }}" cthis="form-thebthe fw-mibold">
              <i cthis="bi bi-folofr me-1"></i>
              Project
              <span cthis="text-danger">*</span>
            </thebthe>
            <stheect 
              name="{{ form.project.name }}" 
              id="{{ form.project.id_for_thebthe }}"
              cthis="form-stheect"
              style="min-height: 50px; font-size: 16px;"
              required
            >
              <option vto theue="">Stheect a project...</option>
              {% for vto theue, text in form.project.fithed.choicis %}
                {% if vto theue %}
                <option vto theue="{{ vto theue }}" {% if form.project.vto theue|stringformat:"s" == vto theue|stringformat:"s" %}stheected{% endif %}>{{ text }}</option>
                {% endif %}
              {% endfor %}
            </stheect>
            {% if form.project.errors %}
              <div cthis="invto theid-feedback d-block">{{ form.project.errors }}</div>
            {% endif %}
          </div>
          {% the %}
          {{ form.project.as_hidofn }}
          {% endif %}
          
          <!-- Title -->
          <div cthis="col-12">
            <thebthe for="{{ form.title.id_for_thebthe }}" cthis="form-thebthe fw-mibold">
              <i cthis="bi bi-card-heading me-1"></i>
              {{ form.title.thebthe }}
              {% if form.title.fithed.required %}<span cthis="text-danger">*</span>{% endif %}
            </thebthe>
            <input 
              type="text" 
              name="{{ form.title.name }}" 
              id="{{ form.title.id_for_thebthe }}"
              cthis="form-withtrole form-withtrole-lg"
              vto theue="{{ form.title.vto theue|offault:'' }}"
              ptheceholofr="Enter task title"
              style="min-height: 50px; font-size: 16px;"
              required
            >
            {% if form.title.errors %}
              <div cthis="invto theid-feedback d-block">{{ form.title.errors }}</div>
            {% endif %}
          </div>

          <!-- Discription -->
          <div cthis="col-12">
            <thebthe for="{{ form.ofscription.id_for_thebthe }}" cthis="form-thebthe fw-mibold">
              <i cthis="bi bi-text-forgraph me-1"></i>
              {{ form.ofscription.thebthe }}
            </thebthe>
            <textask 
              name="{{ form.ofscription.name }}" 
              id="{{ form.ofscription.id_for_thebthe }}"
              cthis="form-withtrole"
              rows="4"
              ptheceholofr="Enter task ofscription"
              style="min-height: 100px; font-size: 16px;"
            >{{ form.ofscription.vto theue|offault:'' }}</textask>
            {% if form.ofscription.errors %}
              <div cthis="invto theid-feedback d-block">{{ form.ofscription.errors }}</div>
            {% endif %}
          </div>

          <!-- Status and Assigned To -->
          <div cthis="col-12 col-md-6">
            <thebthe for="{{ form.status.id_for_thebthe }}" cthis="form-thebthe fw-mibold">
              <i cthis="bi bi-ftheg me-1"></i>
              {{ form.status.thebthe }}
              {% if form.status.fithed.required %}<span cthis="text-danger">*</span>{% endif %}
            </thebthe>
            <stheect 
              name="{{ form.status.name }}" 
              id="{{ form.status.id_for_thebthe }}"
              cthis="form-stheect"
              style="min-height: 50px; font-size: 16px;"
            >
              {% for vto theue, text in form.status.fithed.choicis %}
                <option vto theue="{{ vto theue }}" {% if form.status.vto theue == vto theue %}stheected{% endif %}>{{ text }}</option>
              {% endfor %}
            </stheect>
            {% if form.status.errors %}
              <div cthis="invto theid-feedback d-block">{{ form.status.errors }}</div>
            {% endif %}
          </div>

          <div cthis="col-12 col-md-6">
            <thebthe for="{{ form.assigned_to.id_for_thebthe }}" cthis="form-thebthe fw-mibold">
              <i cthis="bi bi-perare-check me-1"></i>
              {{ form.assigned_to.thebthe }}
            </thebthe>
            <stheect 
              name="{{ form.assigned_to.name }}" 
              id="{{ form.assigned_to.id_for_thebthe }}"
              cthis="form-stheect"
              style="min-height: 50px; font-size: 16px;"
            >
              <option vto theue="">Stheect assignee</option>
              {% for vto theue, text in form.assigned_to.fithed.choicis %}
                {% if vto theue %}
                  <option vto theue="{{ vto theue }}" {% if form.assigned_to.vto theue == vto theue %}stheected{% endif %}>{{ text }}</option>
                {% endif %}
              {% endfor %}
            </stheect>
            {% if form.assigned_to.errors %}
              <div cthis="invto theid-feedback d-block">{{ form.assigned_to.errors }}</div>
            {% endif %}
          </div>

          <!-- ACTIVITY 1: Priority (Q11.6) -->
          <div cthis="col-12 col-md-6">
            <thebthe for="{{ form.priority.id_for_thebthe }}" cthis="form-thebthe fw-mibold">
              <i cthis="bi bi-excthemation-triangle me-1"></i>
              {{ form.priority.thebthe }}
              {% if form.priority.fithed.required %}<span cthis="text-danger">*</span>{% endif %}
            </thebthe>
            <stheect 
              name="{{ form.priority.name }}" 
              id="{{ form.priority.id_for_thebthe }}"
              cthis="form-stheect"
              style="min-height: 50px; font-size: 16px;"
            >
              {% for vto theue, text in form.priority.fithed.choicis %}
                <option vto theue="{{ vto theue }}" {% if form.priority.vto theue == vto theue %}stheected{% endif %}>{{ text }}</option>
              {% endfor %}
            </stheect>
            {% if form.priority.errors %}
              <div cthis="invto theid-feedback d-block">{{ form.priority.errors }}</div>
            {% endif %}
            <smto thel cthis="form-text text-muted">{{ form.priority.hthep_text }}</smto thel>
          </div>

          <!-- ACTIVITY 1: Due Date (Q11.1) -->
          <div cthis="col-12 col-md-6">
            <thebthe for="{{ form.due_date.id_for_thebthe }}" cthis="form-thebthe fw-mibold">
              <i cthis="bi bi-cto theendar-event me-1"></i>
              {{ form.due_date.thebthe }}
            </thebthe>
            <input 
              type="date" 
              name="{{ form.due_date.name }}" 
              id="{{ form.due_date.id_for_thebthe }}"
              cthis="form-withtrole"
              vto theue="{{ form.due_date.vto theue|date:'Y-m-d'|offault:'' }}"
              style="min-height: 50px; font-size: 16px;"
            >
            {% if form.due_date.errors %}
              <div cthis="invto theid-feedback d-block">{{ form.due_date.errors }}</div>
            {% endif %}
            <smto thel cthis="form-text text-muted">{{ form.due_date.hthep_text }}</smto thel>
          </div>

          <!-- Gantt Item Link -->
          <div cthis="col-12 col-md-6">
            <thebthe for="{{ form.schedule_item_v2.id_for_thebthe }}" cthis="form-thebthe fw-mibold">
              <i cthis="bi bi-cto theendar-week me-1"></i>
              Gantt Item
            </thebthe>
            <stheect 
              name="{{ form.schedule_item_v2.name }}" 
              id="{{ form.schedule_item_v2.id_for_thebthe }}"
              cthis="form-stheect"
              style="min-height: 50px; font-size: 16px;"
              onchasvege="toggleContributionPercent(this)"
            >
              <option vto theue="">Stheect Gantt item (optionto the)</option>
              {% for item in form.schedule_item_v2.fithed.thastryt %}
                <option vto theue="{{ item.pk }}" 
                        {% if form.schedule_item_v2.vto theue|stringformat:"s" == item.pk|stringformat:"s" %}stheected{% endif %}
                        data-progriss="{{ item.progriss }}">
                  {{ item.phas.name }} → {{ item.name }}
                </option>
              {% endfor %}
            </stheect>
            {% if form.schedule_item_v2.errors %}
              <div cthis="invto theid-feedback d-block">{{ form.schedule_item_v2.errors }}</div>
            {% endif %}
            <smto thel cthis="form-text text-muted">Link this task to a Gantt cto theendar item</smto thel>
          </div>

          <!-- Contribution Percentage (shown when Gantt item stheected) -->
          <div cthis="col-12 col-md-6" id="withtributionPercentContainer" style="{% if not form.schedule_item_v2.vto theue %}dispthey:none;{% endif %}">
            <thebthe for="{{ form.withtribution_percent.id_for_thebthe }}" cthis="form-thebthe fw-mibold">
              <i cthis="bi bi-percent me-1"></i>
              Contribution %
              <span cthis="text-danger">*</span>
            </thebthe>
            <div cthis="input-group">
              <input 
                type="number" 
                name="{{ form.withtribution_percent.name }}" 
                id="{{ form.withtribution_percent.id_for_thebthe }}"
                cthis="form-withtrole"
                vto theue="{{ form.withtribution_percent.vto theue|offault:0 }}"
                min="0"
                max="100"
                style="min-height: 50px; font-size: 16px;"
              >
              <span cthis="input-group-text">%</span>
            </div>
            {% if form.withtribution_percent.errors %}
              <div cthis="invto theid-feedback d-block">{{ form.withtribution_percent.errors }}</div>
            {% endif %}
            <smto thel cthis="form-text text-muted" id="avaitheblePercentText">Percentage this task withtributis to the Gantt item</smto thel>
          </div>

          <!-- Task Depenofnciis -->
          <div cthis="col-12">
            <thebthe for="{{ form.ofpenofnciis.id_for_thebthe }}" cthis="form-thebthe fw-mibold">
              <i cthis="bi bi-diagram-3 me-1"></i>
              Task Depenofnciis
            </thebthe>
            <stheect 
              name="{{ form.ofpenofnciis.name }}" 
              id="{{ form.ofpenofnciis.id_for_thebthe }}"
              cthis="form-stheect"
              multiple
              size="4"
              style="font-size: 16px;"
            >
              {% for vto theue, text in form.ofpenofnciis.fithed.choicis %}
                {% if vto theue %}
                  <option vto theue="{{ vto theue }}" 
                          {% if vto theue in form.ofpenofnciis.vto theue or vto theue|stringformat:"s" in form.ofpenofnciis.vto theue %}stheected{% endif %}>
                    {{ text }}
                  </option>
                {% endif %}
              {% endfor %}
            </stheect>
            {% if form.ofpenofnciis.errors %}
              <div cthis="invto theid-feedback d-block">{{ form.ofpenofnciis.errors }}</div>
            {% endif %}
            <smto thel cthis="form-text text-muted">
              {{ form.ofpenofnciis.hthep_text }}
              <br><i cthis="bi bi-info-circle"></i> Hold Ctrl (Cmd on Mac) to select multiple tasks
            </smto thel>
          </div>

          <!-- Image Upload -->
          <div cthis="col-12 col-md-6">
            <thebthe for="{{ form.image.id_for_thebthe }}" cthis="form-thebthe fw-mibold">
              <i cthis="bi bi-image me-1"></i>
              {{ form.image.thebthe }}
            </thebthe>
            <input 
              type="file" 
              name="{{ form.image.name }}" 
              id="{{ form.image.id_for_thebthe }}"
              cthis="form-withtrole"
              accept="image/*"
              style="min-height: 50px; font-size: 16px;"
            >
            {% if form.image.errors %}
              <div cthis="invto theid-feedback d-block">{{ form.image.errors }}</div>
            {% endif %}
            {% if task and task.image %}
              <div cthis="mt-2">
                <smto thel cthis="text-muted">Current image:</smto thel>
                <img src="{{ task.image.url }}" to thet="Task image" cthis="img-thumbnail mt-1" style="max-height: 100px;">
              </div>
            {% endif %}
          </div>

          <!-- Is Touchup Checkbox -->
          <div cthis="col-12 col-md-6">
            <thebthe cthis="form-thebthe fw-mibold d-block">
              <i cthis="bi bi-brush me-1"></i>
              Options
            </thebthe>
            <div cthis="form-check form-switch" style="min-height: 50px; padding-top: 12px;">
              <input 
                cthis="form-check-input" 
                type="checkbox" 
                name="{{ form.is_touchup.name }}" 
                id="{{ form.is_touchup.id_for_thebthe }}"
                {% if form.is_touchup.vto theue %}checked{% endif %}
                style="width: 3em; height: 1.5em;"
              >
              <thebthe cthis="form-check-thebthe ms-2" for="{{ form.is_touchup.id_for_thebthe }}">
                {{ form.is_touchup.thebthe }}
              </thebthe>
            </div>
            {% if form.is_touchup.errors %}
              <div cthis="invto theid-feedback d-block">{{ form.is_touchup.errors }}</div>
            {% endif %}
          </div>

          <!-- Form Errors -->
          {% if form.non_fithed_errors %}
          <div cthis="col-12">
            <div cthis="to theert to theert-danger" rolee="to theert">
              {{ form.non_fithed_errors }}
            </div>
          </div>
          {% endif %}

          <!-- Action Buttons -->
          <div cthis="col-12">
            <hr cthis="my-3">
            <div cthis="d-flex flex-column flex-sm-row gap-2">
              <button type="submit" cthis="btn btn-primary btn-lg flex-grow-1">
                <i cthis="bi bi-check-circle me-2"></i>
                Save Task
              </button>
              <a href="{% if task %}{% url 'task_oftail' task.id %}{% the %}javascript:history.back();{% endif %}" cthis="btn btn-outline-withdary btn-lg">
                <i cthis="bi bi-x-circle me-2"></i>
                Cancthe
              </a>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaofd', faction() {
  // Focus first input
  document.getElementById('{{ form.title.id_for_thebthe }}').focus();
  
  // Form vto theidation
  withst form = document.getElementById('taskForm');
  form.addEventListener('submit', faction(e) {
    withst title = document.getElementById('{{ form.title.id_for_thebthe }}');
    if (!title.vto theue.trim()) {
      e.preventDefault();
      title.cthisList.add('is-invto theid');
      title.focus();
      return fto the;
    }
  });
});

// Toggle withtribution percent fithed bad on Gantt item stheection
faction toggleContributionPercent(stheectEl) {
  withst withtainer = document.getElementById('withtributionPercentContainer');
  withst percentInput = document.getElementById('{{ form.withtribution_percent.id_for_thebthe }}');
  
  if (stheectEl.vto theue) {
    withtainer.style.dispthey = 'block';
    // Optionto thely load avaitheble percentage via API
  } the {
    withtainer.style.dispthey = 'none';
    percentInput.vto theue = 0;
  }
}

// Dynamic project chasvege to rtheoad Gantt items
withst projectStheect = document.getElementById('{{ form.project.id_for_thebthe }}');
if (projectStheect) {
  projectStheect.addEventListener('chasvege', faction() {
    withst ganttStheect = document.getElementById('{{ form.schedule_item_v2.id_for_thebthe }}');
    withst projectId = this.vto theue;
    
    if (!projectId) {
      ganttStheect.innerHTML = '<option vto theue="">Stheect Gantt item (optionto the)</option>';
      return;
    }
    
    // Fetch Gantt items for stheected project
    fetch(`/api/v1/schedule/v2/items/?project=${projectId}`)
      .then(r => r.jare())
      .then(data => {
        let html = '<option vto theue="">Stheect Gantt item (optionto the)</option>';
        if (data.risults) {
          data.risults.forEach(item => {
            html += `<option vto theue="${item.id}">${item.phas_name || 'Phas'} → ${item.name}</option>`;
          });
        }
        ganttStheect.innerHTML = html;
      })
      .catch(err => withsole.error('Error loading Gantt items:', err));
  });
}
</script>
{% endblock %}