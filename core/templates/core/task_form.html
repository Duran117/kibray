{% extends "core/base_modern.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% if title %}{{ title }}{% elif edit %}Edit Task{% else %}New Task{% endif %} - Kibray{% endblock %}

{% block content %}
<div class="container-fluid py-3 py-md-4" style="max-width: 900px;">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 mb-md-4 gap-2">
    <h2 class="mb-0 h3 h-md-2">
      <i class="bi bi-{% if edit %}pencil-square{% else %}plus-circle{% endif %} text-primary me-2"></i>
      {% if title %}{{ title }}{% elif edit %}Edit Task{% else %}New Task{% endif %}
    </h2>
    <a href="{% url 'task_command_center' %}" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>
      Back to Tasks
    </a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-3 p-md-4">
      <form method="post" enctype="multipart/form-data" id="taskForm">
        {% csrf_token %}
        
        <div class="row g-3">
          {% if not edit %}
          <div class="col-12">
            <label for="{{ form.project.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-folder me-1"></i>
              Project
              <span class="text-danger">*</span>
            </label>
            <select 
              name="{{ form.project.name }}" 
              id="{{ form.project.id_for_label }}"
              class="form-select"
              style="min-height: 50px; font-size: 16px;"
              required
            >
              <option value="">Select a project...</option>
              {% for value, text in form.project.field.choices %}
                {% if value %}
                <option value="{{ value }}" {% if form.project.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ text }}</option>
                {% endif %}
              {% endfor %}
            </select>
            {% if form.project.errors %}
              <div class="invalid-feedback d-block">{{ form.project.errors }}</div>
            {% endif %}
          </div>
          {% else %}
          {{ form.project.as_hidden }}
          {% endif %}
          
          <div class="col-12">
            <label for="{{ form.title.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-card-heading me-1"></i>
              Title
              <span class="text-danger">*</span>
            </label>
            <input 
              type="text" 
              name="{{ form.title.name }}" 
              id="{{ form.title.id_for_label }}"
              class="form-control form-control-lg"
              value="{{ form.title.value|default:'' }}"
              placeholder="Enter task title"
              style="min-height: 50px; font-size: 16px;"
              required
            >
            {% if form.title.errors %}
              <div class="invalid-feedback d-block">{{ form.title.errors }}</div>
            {% endif %}
          </div>

          <div class="col-12">
            <label for="{{ form.description.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-text-paragraph me-1"></i>
              Description
            </label>
            <textarea 
              name="{{ form.description.name }}" 
              id="{{ form.description.id_for_label }}"
              class="form-control"
              rows="4"
              placeholder="Enter task description"
              style="min-height: 100px; font-size: 16px;"
            >{{ form.description.value|default:'' }}</textarea>
            {% if form.description.errors %}
              <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
            {% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label for="{{ form.status.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-flag me-1"></i>
              Status
            </label>
            <select 
              name="{{ form.status.name }}" 
              id="{{ form.status.id_for_label }}"
              class="form-select"
              style="min-height: 50px; font-size: 16px;"
            >
              {% for value, text in form.status.field.choices %}
                <option value="{{ value }}" {% if form.status.value == value %}selected{% endif %}>{{ text }}</option>
              {% endfor %}
            </select>
            {% if form.status.errors %}
              <div class="invalid-feedback d-block">{{ form.status.errors }}</div>
            {% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label for="{{ form.assigned_to.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-person-check me-1"></i>
              Assigned To
            </label>
            <select 
              name="{{ form.assigned_to.name }}" 
              id="{{ form.assigned_to.id_for_label }}"
              class="form-select"
              style="min-height: 50px; font-size: 16px;"
            >
              <option value="">Select assignee</option>
              {% for value, text in form.assigned_to.field.choices %}
                {% if value %}
                  <option value="{{ value }}" {% if form.assigned_to.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ text }}</option>
                {% endif %}
              {% endfor %}
            </select>
            {% if form.assigned_to.errors %}
              <div class="invalid-feedback d-block">{{ form.assigned_to.errors }}</div>
            {% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label for="{{ form.priority.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-exclamation-triangle me-1"></i>
              Priority
            </label>
            <select 
              name="{{ form.priority.name }}" 
              id="{{ form.priority.id_for_label }}"
              class="form-select"
              style="min-height: 50px; font-size: 16px;"
            >
              {% for value, text in form.priority.field.choices %}
                <option value="{{ value }}" {% if form.priority.value == value %}selected{% endif %}>{{ text }}</option>
              {% endfor %}
            </select>
            {% if form.priority.errors %}
              <div class="invalid-feedback d-block">{{ form.priority.errors }}</div>
            {% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label for="{{ form.due_date.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-calendar-event me-1"></i>
              Due Date
            </label>
            <input 
              type="date" 
              name="{{ form.due_date.name }}" 
              id="{{ form.due_date.id_for_label }}"
              class="form-control"
              value="{{ form.due_date.value|date:'Y-m-d'|default:'' }}"
              style="min-height: 50px; font-size: 16px;"
            >
            {% if form.due_date.errors %}
              <div class="invalid-feedback d-block">{{ form.due_date.errors }}</div>
            {% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label for="{{ form.schedule_item_v2.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-calendar-week me-1"></i>
              Gantt Item
            </label>
            <select 
              name="{{ form.schedule_item_v2.name }}" 
              id="{{ form.schedule_item_v2.id_for_label }}"
              class="form-select"
              style="min-height: 50px; font-size: 16px;"
              onchange="toggleContributionPercent(this)"
            >
              <option value="">Select Gantt item (optional)</option>
              {% for item in form.schedule_item_v2.field.queryset %}
                <option value="{{ item.pk }}" 
                        {% if form.schedule_item_v2.value|stringformat:"s" == item.pk|stringformat:"s" %}selected{% endif %}
                        data-progress="{{ item.progress }}">
                  {{ item.phase.name }} → {{ item.name }}
                </option>
              {% endfor %}
            </select>
            {% if form.schedule_item_v2.errors %}
              <div class="invalid-feedback d-block">{{ form.schedule_item_v2.errors }}</div>
            {% endif %}
            <small class="form-text text-muted">Link this task to a Gantt calendar item</small>
          </div>

          <div class="col-12 col-md-6" id="contributionPercentContainer" style="{% if not form.schedule_item_v2.value %}display:none;{% endif %}">
            <label for="{{ form.contribution_percent.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-percent me-1"></i>
              Contribution %
            </label>
            <div class="input-group">
              <input 
                type="number" 
                name="{{ form.contribution_percent.name }}" 
                id="{{ form.contribution_percent.id_for_label }}"
                class="form-control"
                value="{{ form.contribution_percent.value|default:0 }}"
                min="0"
                max="100"
                style="min-height: 50px; font-size: 16px;"
              >
              <span class="input-group-text">%</span>
            </div>
            {% if form.contribution_percent.errors %}
              <div class="invalid-feedback d-block">{{ form.contribution_percent.errors }}</div>
            {% endif %}
          </div>

          <div class="col-12">
            <label for="{{ form.dependencies.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-diagram-3 me-1"></i>
              Task Dependencies
            </label>
            <select 
              name="{{ form.dependencies.name }}" 
              id="{{ form.dependencies.id_for_label }}"
              class="form-select"
              multiple
              size="4"
              style="font-size: 16px;"
            >
              {% for value, text in form.dependencies.field.choices %}
                {% if value %}
                  <option value="{{ value }}" 
                          {% if value in form.dependencies.value %}selected{% endif %}>
                    {{ text }}
                  </option>
                {% endif %}
              {% endfor %}
            </select>
            {% if form.dependencies.errors %}
              <div class="invalid-feedback d-block">{{ form.dependencies.errors }}</div>
            {% endif %}
            <small class="form-text text-muted">
              Tasks that must be completed before this one. Hold Ctrl (Cmd on Mac) to select multiple.
            </small>
          </div>

          <div class="col-12 col-md-6">
            <label for="{{ form.image.id_for_label }}" class="form-label fw-semibold">
              <i class="bi bi-image me-1"></i>
              Image
            </label>
            <input 
              type="file" 
              name="{{ form.image.name }}" 
              id="{{ form.image.id_for_label }}"
              class="form-control"
              accept="image/*"
              style="min-height: 50px; font-size: 16px;"
            >
            {% if form.image.errors %}
              <div class="invalid-feedback d-block">{{ form.image.errors }}</div>
            {% endif %}
            {% if task and task.image %}
              <div class="mt-2">
                <small class="text-muted">Current image:</small>
                <img src="{{ task.image.url }}" alt="Task image" class="img-thumbnail mt-1" style="max-height: 100px;">
              </div>
            {% endif %}
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold d-block">
              <i class="bi bi-brush me-1"></i>
              Options
            </label>
            <div class="form-check form-switch" style="min-height: 50px; padding-top: 12px;">
              <input 
                class="form-check-input" 
                type="checkbox" 
                name="{{ form.is_touchup.name }}" 
                id="{{ form.is_touchup.id_for_label }}"
                {% if form.is_touchup.value %}checked{% endif %}
                style="width: 3em; height: 1.5em;"
              >
              <label class="form-check-label ms-2" for="{{ form.is_touchup.id_for_label }}">
                Mark as Touch-up
              </label>
            </div>
            {% if form.is_touchup.errors %}
              <div class="invalid-feedback d-block">{{ form.is_touchup.errors }}</div>
            {% endif %}
          </div>

          {% if form.non_field_errors %}
          <div class="col-12">
            <div class="alert alert-danger" role="alert">
              {{ form.non_field_errors }}
            </div>
          </div>
          {% endif %}

          <div class="col-12">
            <hr class="my-3">
            <div class="d-flex flex-column flex-sm-row gap-2">
              <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                <i class="bi bi-check-circle me-2"></i>
                Save Task
              </button>
              <a href="{% if task %}{% url 'task_detail' task.id %}{% else %}javascript:history.back();{% endif %}" class="btn btn-outline-secondary btn-lg">
                <i class="bi bi-x-circle me-2"></i>
                Cancel
              </a>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('{{ form.title.id_for_label }}').focus();
  
  const form = document.getElementById('taskForm');
  form.addEventListener('submit', function(e) {
    const title = document.getElementById('{{ form.title.id_for_label }}');
    if (!title.value.trim()) {
      e.preventDefault();
      title.classList.add('is-invalid');
      title.focus();
      return false;
    }
  });
});

function toggleContributionPercent(selectEl) {
  const container = document.getElementById('contributionPercentContainer');
  const percentInput = document.getElementById('{{ form.contribution_percent.id_for_label }}');
  
  if (selectEl.value) {
    container.style.display = 'block';
  } else {
    container.style.display = 'none';
    percentInput.value = 0;
  }
}

const projectSelect = document.getElementById('{{ form.project.id_for_label }}');
if (projectSelect) {
  projectSelect.addEventListener('change', function() {
    const ganttSelect = document.getElementById('{{ form.schedule_item_v2.id_for_label }}');
    const projectId = this.value;
    
    if (!projectId) {
      ganttSelect.innerHTML = '<option value="">Select Gantt item (optional)</option>';
      return;
    }
    
    fetch(`/api/v1/schedule/v2/items/?project=${projectId}`)
      .then(r => r.json())
      .then(data => {
        let html = '<option value="">Select Gantt item (optional)</option>';
        if (data.results) {
          data.results.forEach(item => {
            html += `<option value="${item.id}">${item.phase_name || 'Phase'} → ${item.name}</option>`;
          });
        }
        ganttSelect.innerHTML = html;
      })
      .catch(err => console.error('Error loading Gantt items:', err));
  });
}
</script>
{% endblock %}
