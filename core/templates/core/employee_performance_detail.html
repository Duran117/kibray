{% extends "core/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Performance Review" %} - {{ employee.first_name }} {{ employee.last_name }}{% endblock %}

{% block extra_css %}
<style>
    .review-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .employee-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 40px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .employee-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: white;
        color: #667eea;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 16px;
    }
    
    .section-card {
        background: white;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 24px;
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 24px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .metric-row {
        display: flex;
        justify-content: space-between;
        padding: 16px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .metric-row:last-child {
        border-bottom: none;
    }
    
    .metric-label {
        font-weight: 600;
        color: #6b7280;
    }
    
    .metric-value {
        font-size: 1.2rem;
        font-weight: 700;
    }
    
    .rating-input {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .star-btn {
        font-size: 1.8rem;
        background: none;
        border: none;
        color: #d1d5db;
        cursor: pointer;
        transition: color 0.2s;
    }
    
    .star-btn:hover,
    .star-btn.active {
        color: #fbbf24;
    }
    
    .overall-score-display {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-radius: 12px;
        padding: 32px;
        text-align: center;
        margin-bottom: 24px;
    }
    
    .score-circle {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: white;
        color: #10b981;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="review-container mt-4">
    <!-- Employee Banner -->
    <div class="employee-banner">
        <div class="employee-avatar">
            {{ employee.first_name|slice:":1" }}{{ employee.last_name|slice:":1" }}
        </div>
        <h1>{{ employee.first_name }} {{ employee.last_name }}</h1>
        <p class="mb-0">{{ employee.position|default:"Employee" }} â€¢ {% trans "Performance Review" %} {{ year }}</p>
    </div>
    
    <!-- Overall Score -->
    <div class="overall-score-display">
        <div class="score-circle">
            {{ metric.overall_score|floatformat:0 }}
        </div>
        <h3>{% trans "Overall Performance Score" %}</h3>
        <p class="mb-0">
            {% if metric.overall_score >= 85 %}
                {% trans "Exceptional Performance" %}
            {% elif metric.overall_score >= 70 %}
                {% trans "Strong Performance" %}
            {% elif metric.overall_score >= 50 %}
                {% trans "Satisfactory Performance" %}
            {% else %}
                {% trans "Needs Improvement" %}
            {% endif %}
        </p>
    </div>
    
    <!-- Auto-Calculated Metrics -->
    <div class="section-card">
        <div class="section-title">
            <i class="bi bi-calculator"></i> {% trans "Calculated Metrics" %}
        </div>
        
        <div class="metric-row">
            <div class="metric-label">{% trans "Total Hours Worked" %}</div>
            <div class="metric-value">{{ metric.total_hours_worked|floatformat:1 }}h</div>
        </div>
        
        <div class="metric-row">
            <div class="metric-label">{% trans "Billable Hours" %}</div>
            <div class="metric-value text-success">{{ metric.billable_hours|floatformat:1 }}h</div>
        </div>
        
        <div class="metric-row">
            <div class="metric-label">{% trans "Productivity Rate" %}</div>
            <div class="metric-value {% if metric.productivity_rate >= 80 %}text-success{% elif metric.productivity_rate >= 60 %}text-warning{% else %}text-danger{% endif %}">
                {{ metric.productivity_rate|floatformat:1 }}%
            </div>
        </div>
        
        <div class="metric-row">
            <div class="metric-label">{% trans "Days Worked" %}</div>
            <div class="metric-value">{{ metric.days_worked }}</div>
        </div>
        
        <div class="metric-row">
            <div class="metric-label">{% trans "Days Late" %}</div>
            <div class="metric-value {% if metric.days_late > 0 %}text-warning{% endif %}">{{ metric.days_late }}</div>
        </div>
        
        <div class="metric-row">
            <div class="metric-label">{% trans "Tasks Completed" %}</div>
            <div class="metric-value">{{ metric.tasks_completed }}</div>
        </div>
        
        <div class="metric-row">
            <div class="metric-label">{% trans "Defects Created" %}</div>
            <div class="metric-value {% if metric.defects_created > 0 %}text-danger{% endif %}">
                {{ metric.defects_created }}
            </div>
        </div>
    </div>
    
    <!-- Manual Ratings Form -->
    <div class="section-card">
        <div class="section-title">
            <i class="bi bi-star"></i> {% trans "Manual Ratings" %}
        </div>
        
        <form method="post">
            {% csrf_token %}
            
            <!-- Quality Rating -->
            <div class="mb-4">
                <label class="form-label"><strong>{% trans "Quality of Work" %}</strong></label>
                <p class="text-muted small">{% trans "Rate the overall quality and attention to detail" %}</p>
                <div class="rating-input">
                    <input type="hidden" name="quality_rating" id="quality_rating" value="{{ metric.quality_rating|default:'0' }}">
                    {% for i in "12345" %}
                        <button type="button" class="star-btn quality-star" data-value="{{ forloop.counter }}">
                            <i class="bi bi-star-fill"></i>
                        </button>
                    {% endfor %}
                    <span class="ms-3 text-muted" id="quality_text"></span>
                </div>
            </div>
            
            <!-- Attitude Rating -->
            <div class="mb-4">
                <label class="form-label"><strong>{% trans "Attitude & Professionalism" %}</strong></label>
                <p class="text-muted small">{% trans "Rate the employee's attitude, reliability, and work ethic" %}</p>
                <div class="rating-input">
                    <input type="hidden" name="attitude_rating" id="attitude_rating" value="{{ metric.attitude_rating|default:'0' }}">
                    {% for i in "12345" %}
                        <button type="button" class="star-btn attitude-star" data-value="{{ forloop.counter }}">
                            <i class="bi bi-star-fill"></i>
                        </button>
                    {% endfor %}
                    <span class="ms-3 text-muted" id="attitude_text"></span>
                </div>
            </div>
            
            <!-- Teamwork Rating -->
            <div class="mb-4">
                <label class="form-label"><strong>{% trans "Teamwork & Communication" %}</strong></label>
                <p class="text-muted small">{% trans "Rate collaboration skills and communication with team" %}</p>
                <div class="rating-input">
                    <input type="hidden" name="teamwork_rating" id="teamwork_rating" value="{{ metric.teamwork_rating|default:'0' }}">
                    {% for i in "12345" %}
                        <button type="button" class="star-btn teamwork-star" data-value="{{ forloop.counter }}">
                            <i class="bi bi-star-fill"></i>
                        </button>
                    {% endfor %}
                    <span class="ms-3 text-muted" id="teamwork_text"></span>
                </div>
            </div>
            
            <!-- Bonus Amount -->
            <div class="mb-4">
                <label class="form-label"><strong>{% trans "Bonus Amount" %}</strong></label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" 
                           class="form-control form-control-lg" 
                           name="bonus_amount" 
                           step="0.01"
                           value="{{ metric.bonus_amount|default:'' }}"
                           placeholder="0.00">
                </div>
            </div>
            
            <!-- Bonus Notes -->
            <div class="mb-4">
                <label class="form-label"><strong>{% trans "Bonus Justification / Notes" %}</strong></label>
                <textarea class="form-control" 
                          name="bonus_notes" 
                          rows="4"
                          placeholder="{% trans 'Explain why this bonus amount was chosen. Mention specific achievements, improvements, or reasons for appreciation.' %}">{{ metric.bonus_notes|default:'' }}</textarea>
            </div>
            
            <!-- Submit Buttons -->
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-save"></i> {% trans "Save Performance Review" %}
                </button>
                <a href="{% url 'employee_performance_list' %}?year={{ year }}" class="btn btn-secondary btn-lg">
                    <i class="bi bi-x-circle"></i> {% trans "Cancel" %}
                </a>
            </div>
        </form>
    </div>
    
    <!-- Score Breakdown Explanation -->
    <div class="section-card">
        <div class="section-title">
            <i class="bi bi-info-circle"></i> {% trans "How Overall Score is Calculated" %}
        </div>
        <ul class="list-unstyled">
            <li class="mb-2"><strong>30%</strong> - {% trans "Productivity Rate" %} ({{ metric.productivity_rate|floatformat:1 }}%)</li>
            <li class="mb-2"><strong>25%</strong> - {% trans "Quality Rating" %} ({{ metric.quality_rating|default:"Not rated" }})</li>
            <li class="mb-2"><strong>25%</strong> - {% trans "Attitude Rating" %} ({{ metric.attitude_rating|default:"Not rated" }})</li>
            <li class="mb-2"><strong>20%</strong> - {% trans "Attendance" %} ({{ metric.days_worked }} days worked, {{ metric.days_late }} late)</li>
        </ul>
        <p class="text-muted mb-0">
            <small>
                <i class="bi bi-lightbulb"></i> 
                {% trans "The overall score is automatically calculated based on these weighted factors. You can use this score as guidance, but the final bonus decision is yours based on your knowledge of the employee's complete performance." %}
            </small>
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Star Rating System
function initStarRating(category) {
    const stars = document.querySelectorAll(`.${category}-star`);
    const input = document.getElementById(`${category}_rating`);
    const text = document.getElementById(`${category}_text`);
    
    const labels = {
        1: "{% trans 'Poor' %}",
        2: "{% trans 'Fair' %}",
        3: "{% trans 'Good' %}",
        4: "{% trans 'Very Good' %}",
        5: "{% trans 'Excellent' %}"
    };
    
    // Set initial state
    const currentValue = parseInt(input.value) || 0;
    updateStars(currentValue);
    
    function updateStars(value) {
        stars.forEach((star, index) => {
            if (index < value) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
        if (value > 0) {
            text.textContent = labels[value];
        } else {
            text.textContent = '';
        }
    }
    
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const value = parseInt(this.dataset.value);
            input.value = value;
            updateStars(value);
        });
    });
}

// Initialize all rating categories
initStarRating('quality');
initStarRating('attitude');
initStarRating('teamwork');
</script>
{% endblock %}
