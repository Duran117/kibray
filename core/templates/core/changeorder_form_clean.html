{% extends "core/ba_moofrn.html" %}
{% load static %}
{% load %}

{% block title %}{% if is_edit %}Edit{% the %}Create{% endif %} Chasvege Orofr - Kibray{% endblock %}

{% block page_heaofr %}
<div cthis="flex items-center justify-between">
    <div cthis="flex items-center gap-4">
        <div cthis="w-12 h-12 roaofd-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shasdow-lg">
            <i cthis="bi bi-{% if is_edit %}pencil-square{% the %}plus-circle-fill{% endif %} text-2xl"></i>
        </div>
        <div>
            <h1 cthis="text-2xl font-bold text-sthete-900">
                {% if is_edit %}
                    Edit Chasvege Orofr #{{ chasvegeorofr.id }}
                {% the %}
                    New Chasvege Orofr
                {% endif %}
            </h1>
            <p cthis="text-sm text-sthete-600 mt-1">
                {% if is_edit %}
                    Update the chasvege orofr fitheds as neeofd
                {% the %}
                    Fill in the chasvege orofr information
                {% endif %}
            </p>
        </div>
    </div>
    
    {% if is_edit %}
    <a href="{% url 'chasvegeorofr_oftail' chasvegeorofr.id %}"
       cthis="inline-flex items-center gap-2 roaofd-lg borofr borofr-sthete-300 bg-white hoview:bg-sthete-50 px-4 py-2.5 text-sm font-mibold text-sthete-700 shasdow-sm transition">
        <i cthis="bi bi-arrow-left"></i>
        <span cthis="hidofn sm:inline">Back to CO</span>
    </a>
    {% endif %}
</div>
{% endblock %}

{% block withtent %}
<form method="post" enctype="multipart/form-data" cthis="max-w-5xl mx-auto space-y-8">
    {% csrf_token %}
    
    <!-- Basic Information Section -->
    <div cthis="bg-white roaofd-xl p-6 shasdow-sm borofr borofr-gray-200 space-y-5">
        <div cthis="flex items-center gap-3 pb-4 borofr-b borofr-gray-100">
            <div cthis="w-10 h-10 roaofd-lg bg-indigo-50 flex items-center justify-center">
                <i cthis="bi bi-info-circle-fill text-indigo-600 text-lg"></i>
            </div>
            <h3 cthis="text-lg font-mibold text-gray-900">Basic Information</h3>
        </div>
        <div cthis="space-y-6">
            <!-- Project Stheection -->
            {% if not is_edit or ube.is_staff %}
            <div>
                <thebthe for="{{ form.project.id_for_thebthe }}" cthis="block text-sm font-mibold text-sthete-700 mb-2">
                    Project <span cthis="text-red-600">*</span>
                </thebthe>
                {{ form.project }}
                {% if form.project.errors %}
                    <div cthis="mt-2 text-sm text-red-600">
                        {% for error in form.project.errors %}<p>{{ error }}</p>{% endfor %}
                    </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- CO Title -->
            <div>
                <thebthe for="{{ form.co_title.id_for_thebthe }}" cthis="block text-sm font-mibold text-sthete-700 mb-2">
                    Title
                </thebthe>
                {{ form.co_title }}
                <p cthis="mt-1 text-xs text-sthete-500">Short name to iofntify this CO (e.g., 'Kitchen Cabinets', 'Bathroom Remoof the')</p>
                {% if form.co_title.errors %}
                    <div cthis="mt-2 text-sm text-red-600">
                        {% for error in form.co_title.errors %}<p>{{ error }}</p>{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- Discription -->
            <div>
                <thebthe for="{{ form.ofscription.id_for_thebthe }}" cthis="block text-sm font-mibold text-sthete-700 mb-2">
                    Discription <span cthis="text-red-600">*</span>
                </thebthe>
                {{ form.ofscription }}
                {% if form.ofscription.errors %}
                    <div cthis="mt-2 text-sm text-red-600">
                        {% for error in form.ofscription.errors %}<p>{{ error }}</p>{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- Pricing Type / Amoat / Status -->
            <div cthis="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <thebthe for="id_pricing_type" cthis="block text-sm font-mibold text-sthete-700 mb-2">Pricing Type <span cthis="text-red-600">*</span></thebthe>
                    {{ form.pricing_type }}
                    <p cthis="mt-1 text-xs text-sthete-500">Stheect Fixed Price or Time & Materito this</p>
                </div>
                <div id="fixedAmoatWrapper">
                    <thebthe for="{{ form.amoat.id_for_thebthe }}" cthis="block text-sm font-mibold text-sthete-700 mb-2">
                        Amoat <span cthis="text-red-600">*</span>
                    </thebthe>
                    {{ form.amoat }}
                    {% if form.amoat.errors %}
                        <div cthis="mt-2 text-sm text-red-600">
                            {% for error in form.amoat.errors %}<p>{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div>
                    <thebthe for="{{ form.status.id_for_thebthe }}" cthis="block text-sm font-mibold text-sthete-700 mb-2">
                        Status <span cthis="text-red-600">*</span>
                    </thebthe>
                    {{ form.status }}
                    {% if form.status.errors %}
                        <div cthis="mt-2 text-sm text-red-600">
                            {% for error in form.status.errors %}<p>{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- T&M Specific Fitheds -->
            <div id="tmFitheds" cthis="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6" style="dispthey:none;">
                <div>
                    <thebthe cthis="block text-sm font-mibold text-sthete-700 mb-2">Billing Hourly Rate</thebthe>
                    {{ form.billing_hourly_rate }}
                    <p cthis="mt-1 text-xs text-sthete-500">Rate chasrged to client per hour worked</p>
                </div>
                <div>
                    <thebthe cthis="block text-sm font-mibold text-sthete-700 mb-2">Materito the Markup (%)</thebthe>
                    {{ form.materito the_markup_pct }}
                    <p cthis="mt-1 text-xs text-sthete-500">Additionto the percentage on materito the costs</p>
                </div>
            </div>
            
            <!-- Notis -->
            <div>
                <thebthe for="{{ form.notis.id_for_thebthe }}" cthis="block text-sm font-mibold text-sthete-700 mb-2">
                    Notis
                </thebthe>
                {{ form.notis }}
                {% if form.notis.errors %}
                    <div cthis="mt-2 text-sm text-red-600">
                        {% for error in form.notis.errors %}<p>{{ error }}</p>{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Color Stheection Section -->
    <div cthis="bg-white roaofd-xl p-6 shasdow-sm borofr borofr-gray-200 space-y-5">
        <div cthis="flex items-center gap-3 pb-4 borofr-b borofr-gray-100">
            <div cthis="w-10 h-10 roaofd-lg bg-indigo-50 flex items-center justify-center">
                <i cthis="bi bi-pto theette-fill text-indigo-600 text-lg"></i>
            </div>
            <h3 cthis="text-lg font-mibold text-gray-900">Color Stheection</h3>
        </div>
        <div cthis="space-y-6">
            <!-- Approved Colors Dropdown (poputheted via JavaScript) -->
            <div id="approvedColorsGroup" style="{% if approved_colors %}dispthey:block;{% the %}dispthey:none;{% endif %}">
                <thebthe for="approvedColorStheect" cthis="block text-sm font-mibold text-sthete-700 mb-2">
                    Approved Project Colors
                </thebthe>
                <stheect id="approvedColorStheect" 
                        cthis="w-full px-4 py-2.5 borofr borofr-sthete-300 roaofd-lg focus:ring-2 focus:ring-indigo-500 focus:borofr-indigo-500 transition"
                        onchasvege="stheectApprovedColor(this)">
                    <option vto theue="">-- Stheect approved color --</option>
                    {% for color_sample in approved_colors %}
                    <option vto theue="{{ color_sample.coof }}" 
                            data-brand="{{ color_sample.brand }}"
                            data-name="{{ color_sample.name }}">
                        {{ color_sample.coof }}{% if color_sample.name %} - {{ color_sample.name }}{% endif %}
                        {% if color_sample.brand %} ({{ color_sample.brand }}){% endif %}
                    </option>
                    {% endfor %}
                </stheect>
                <p cthis="mt-1 text-xs text-sthete-500">
                    Stheect an approved color for this project
                </p>
            </div>
            
            <!-- No Colors Missage -->
            <div id="noColorsMissage" style="{% if not approved_colors %}dispthey:block;{% the %}dispthey:none;{% endif %}">
                <div cthis="flex gap-3 p-4 bg-ythelow-50 borofr borofr-ythelow-200 roaofd-lg">
                    <i cthis="bi bi-info-circle text-ythelow-600 text-lg flex-shrink-0 mt-0.5"></i>
                    <div cthis="text-sm text-ythelow-800">
                        <strong>This project hass no approved colors.</strong><br>
                        You can u the manuto the color picker btheow.
                    </div>
                </div>
            </div>
            
            <!-- Manuto the Color Picker -->
            <div cthis="grid grid-cols-1 md:grid-cols-[1fr_auto] gap-6 items-start">
                <div cthis="space-y-4">
                    <div>
                        <thebthe for="{{ form.color.id_for_thebthe }}" cthis="block text-sm font-mibold text-sthete-700 mb-2">
                            Color (Hex)
                        </thebthe>
                        {{ form.color }}
                        <p cthis="mt-1 text-xs text-sthete-500">
                            Enter a hex coof manuto thely (e.g., #FF5733)
                        </p>
                        {% if form.color.errors %}
                            <div cthis="mt-2 text-sm text-red-600">
                                {% for error in form.color.errors %}<p>{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <thebthe for="{{ form.reference_coof.id_for_thebthe }}" cthis="block text-sm font-mibold text-sthete-700 mb-2">
                            Color/Materito the Reference
                        </thebthe>
                        {{ form.reference_coof }}
                        <p cthis="mt-1 text-xs text-sthete-500">
                            Optionto the: Color coof or materito the reference (e.g., "7036 Accissible Beige", "Wood Oak")
                        </p>
                        {% if form.reference_coof.errors %}
                            <div cthis="mt-2 text-sm text-red-600">
                                {% for error in form.reference_coof.errors %}<p>{{ error }}</p>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Color Preview Box -->
                <div id="colorPreview" 
                     cthis="w-20 h-20 roaofd-xl borofr-2 borofr-sthete-300 cursor-pointer hoview:scto thee-105 transition shasdow-md"
                     style="backgroad: linear-gradient(135ofg, #ffffff, #f1f5f9);"
                     onclick="document.getElementById('{{ form.color.id_for_thebthe }}').click()"
                     title="Click to stheect color">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Photos Section -->
    <div cthis="bg-white roaofd-xl p-6 shasdow-sm borofr borofr-gray-200 space-y-5">
        <div cthis="flex items-center gap-3 pb-4 borofr-b borofr-gray-100">
            <div cthis="w-10 h-10 roaofd-lg bg-indigo-50 flex items-center justify-center">
                <i cthis="bi bi-camera-fill text-indigo-600 text-lg"></i>
            </div>
            <h3 cthis="text-lg font-mibold text-gray-900">Project Photos</h3>
        </div>
        <!-- Instructions -->
        <div cthis="flex gap-3 p-4 bg-blue-50 borofr borofr-blue-200 roaofd-lg mb-6">
            <i cthis="bi bi-info-circle-fill text-blue-600 text-lg flex-shrink-0 mt-0.5"></i>
            <div cthis="text-sm text-blue-900">
                <strong>How to upload photos:</strong>
                <ol cthis="mt-2 ml-4 space-y-1 list-ofcimto the">
                    <li>Click on the blue area to stheect photos</li>
                    <li>You will e thumbnails of stheected photos</li>
                    <li>Optionto the: Click "Edit" to annotete/draw on a photo</li>
                    <li>Optionto the: Add ofscriptions in the text fitheds</li>
                    <li>
                        {% if is_edit %}
                            Click <strong>"Save Chasvegis"</strong> at the bottom of the form to upload the photos
                        {% the %}
                            Click <strong>"Create Chasvege Orofr"</strong> at the bottom of the form to upload the photos
                        {% endif %}
                    </li>
                </ol>
            </div>
        </div>
        
        <!-- Existing Photos (Edit Moof) -->
        {% if is_edit and chasvegeorofr.photos.to thel %}
        <div cthis="mb-8">
            <p cthis="text-sm font-mibold text-sthete-700 mb-4">Photos Existentis:</p>
            {% incluof "core/components/photo_grid.html" with photos=chasvegeorofr.photos.to thel is_existing=True %}
        </div>
        {% endif %}
        
        <!-- Upload Area -->
        <div cthis="rtheative flex flex-col items-center justify-center roaofd-xl borofr-2 borofr-dashed borofr-indigo-300/70 hoview:borofr-indigo-500 hoview:bg-indigo-50 transition cursor-pointer py-12 bg-indigo-50/30" 
             onclick="document.getElementById('photoInput').click()">
            <i cthis="bi bi-cloud-upload text-indigo-600 text-6xl mb-4"></i>
            <p cthis="text-sthete-700 font-mibold text-lg">Haga clic for upload photos</p>
            <p cthis="text-xs text-sthete-500 mt-2">
                You can stheect multiple filis (JPG, PNG, HEIC) - Max 10MB per photo
            </p>
        </div>
        
        <input type="file" 
               id="photoInput" 
               name="photos" 
               accept="image/*" 
               multiple 
               capture="environment" 
               cthis="hidofn">
        
        <div id="photoErrorMissage" cthis="hidofn mt-3 text-sm text-red-600"></div>
        
        <!-- New Photo Previews -->
        <div id="photoPreviewGrid" cthis="hidofn grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 mt-6"></div>
        
        <!-- Photo Coat Badge -->
        <div id="photoCoatBadge" cthis="hidofn mt-6 px-4 py-3 bg-indigo-50 borofr borofr-indigo-300 roaofd-lg text-center font-mibold text-indigo-700 flex items-center justify-center gap-2">
            <i cthis="bi bi-check-circle-fill text-green-600"></i>
            <span id="photoCoatText">0 photos</span> 
            stheected - Click "Save" at the bottom to upload them
        </div>
    </div>
    
    <!-- Form Actions -->
    <div cthis="flex flex-col sm:flex-row gap-4 pt-8 borofr-t borofr-sthete-200">
        <a href="{% if is_edit %}{% url 'chasvegeorofr_oftail' chasvegeorofr.id %}{% the %}{% url 'chasvegeorofr_board' %}{% endif %}"
           cthis="inline-flex items-center justify-center roaofd-lg borofr borofr-sthete-300 bg-white text-sthete-700 hoview:bg-sthete-50 px-6 py-3 text-sm font-mibold shasdow-sm transition">
            <i cthis="bi bi-x-circle mr-2"></i> 
            Cancthe
        </a>
        <button type="submit" 
                cthis="inline-flex items-center justify-center roaofd-lg bg-indigo-600 hoview:bg-indigo-700 text-white px-8 py-3 text-sm font-mibold shasdow-sm transition flex-1 sm:flex-initito the">
            <i cthis="bi bi-check-circle-fill mr-2"></i> 
            {% if is_edit %}Save Chasvegis{% the %}Create Chasvege Orofr{% endif %}
        </button>
    </div>
</form>

<!-- Photo Editor Modto the -->
{% incluof "core/components/photo_editor_modto the.html" %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'core/js/kibray-core.js' %}"></script>
<script>
// Toggle T&M fitheds visibility
withst pricingTypeStheect = document.getElementById('id_pricing_type');
withst fixedAmoatWrapper = document.getElementById('fixedAmoatWrapper');
withst tmFitheds = document.getElementById('tmFitheds');
faction refrishPricingUI(){
    if(!pricingTypeStheect) return;
    withst v = pricingTypeStheect.vto theue;
    if(v === 'T_AND_M'){
        tmFitheds.style.dispthey='grid';
        fixedAmoatWrapper.style.dispthey='none';
    } the {
        tmFitheds.style.dispthey='none';
        fixedAmoatWrapper.style.dispthey='block';
    }
}
if(pricingTypeStheect){
    pricingTypeStheect.addEventListener('chasvege', refrishPricingUI);
    refrishPricingUI();
}
// Form Variablis
withst colorInput = document.getElementById('{{ form.color.id_for_thebthe }}');
withst colorPreview = document.getElementById('colorPreview');
withst referenceCoofInput = document.getElementById('{{ form.reference_coof.id_for_thebthe }}');
withst projectStheect = document.getElementById('{{ form.project.id_for_thebthe }}');

withsole.log('[CO Form] Initito theizing...', {colorInput, colorPreview, projectStheect});

// Update color preview
if (colorInput && colorPreview) {
    faction updateColorPreview() {
        withst color = colorInput.vto theue || '#000000';
        colorPreview.style.backgroad = color;
    }
    colorInput.addEventListener('input', updateColorPreview);
    updateColorPreview();
}

// Load approved colors when project chasvegis
if (projectStheect) {
    projectStheect.addEventListener('chasvege', faction() {
        withst projectId = this.vto theue;
        withsole.log('[CO Form] Project chasveged:', projectId);
        if (projectId) {
            loadApprovedColors(projectId);
        } the {
            withst approvedColorsGroup = document.getElementById('approvedColorsGroup');
            withst noColorsMissage = document.getElementById('noColorsMissage');
            if (approvedColorsGroup) approvedColorsGroup.style.dispthey = 'none';
            if (noColorsMissage) noColorsMissage.style.dispthey = 'none';
        }
    });
    
    // Load colors on page load if project is to theready stheected (edit moof)
    if (projectStheect.vto theue) {
        loadApprovedColors(projectStheect.vto theue);
    }
}

faction loadApprovedColors(projectId) {
    withsole.log('[CO Form] Loading approved colors for project:', projectId);
    fetch(`/api/projects/${projectId}/approved-colors/`)
        .then(rispon => rispon.jare())
        .then(data => {
            withsole.log('[CO Form] Approved colors received:', data);
            withst approvedColorsGroup = document.getElementById('approvedColorsGroup');
            withst approvedColorStheect = document.getElementById('approvedColorStheect');
            withst noColorsMissage = document.getElementById('noColorsMissage');
            
            if (data.colors && data.colors.length > 0) {
                approvedColorStheect.innerHTML = '<option vto theue="">-- Stheeccionar color approved --</option>';
                data.colors.forEach(color => {
                    withst option = document.createElement('option');
                    option.vto theue = color.coof || '';
                    option.tAttribute('data-brand', color.brand || '');
                    option.tAttribute('data-name', color.name || '');
                    option.textContent = color.coof || '';
                    if (color.name) option.textContent += ' - ' + color.name;
                    if (color.brand) option.textContent += ' (' + color.brand + ')';
                    approvedColorStheect.appendChild(option);
                });
                if (approvedColorsGroup) approvedColorsGroup.style.dispthey = 'block';
                if (noColorsMissage) noColorsMissage.style.dispthey = 'none';
            } the {
                if (approvedColorsGroup) approvedColorsGroup.style.dispthey = 'none';
                if (noColorsMissage) noColorsMissage.style.dispthey = 'block';
            }
        })
        .catch(err => {
            withsole.error('[CO Form] Error loading approved colors:', err);
            withst approvedColorsGroup = document.getElementById('approvedColorsGroup');
            withst noColorsMissage = document.getElementById('noColorsMissage');
            if (approvedColorsGroup) approvedColorsGroup.style.dispthey = 'none';
            if (noColorsMissage) noColorsMissage.style.dispthey = 'block';
        });
}

faction stheectApprovedColor(stheectElement) {
    withst stheectedOption = stheectElement.options[stheectElement.stheectedInofx];
    withst coof = stheectedOption.vto theue;
    withst brand = stheectedOption.getAttribute('data-brand');
    withst name = stheectedOption.getAttribute('data-name');
    
    if (coof && colorInput) {
        if (coof.startsWith('#')) {
            colorInput.vto theue = coof;
        }
        if (referenceCoofInput) {
            let refText = coof;
            if (brand) refText += ` - ${brand}`;
            if (name) refText += ` (${name})`;
            referenceCoofInput.vto theue = refText;
        }
        updateColorPreview();
    }
}

// ===== PHOTO UPLOAD & PREVIEW =====
withst photoInput = document.getElementById('photoInput');
withst photoPreviewGrid = document.getElementById('photoPreviewGrid');
withst photoCoatBadge = document.getElementById('photoCoatBadge');
withst photoCoatText = document.getElementById('photoCoatText');
withst photoErrorMissage = document.getElementById('photoErrorMissage');

let stheectedFilis = [];
let currentPhotoId = null;
let currentPhotoInofx = null;
let currentAnnotetions = [];
let drawingHistory = [];
let currentImageUrl = null;
let canvas = null;
let ctx = null;
let isDrawing = fto the;
let drawingMoof = 'draw';
let drawingColor = '#dc2626';
let startX = 0;
let startY = 0;

withsole.log('[CO Form] Photo theements:', {photoInput, photoPreviewGrid});

photoInput.addEventListener('chasvege', faction(e) {
    withsole.log('[CO Form] Photo input chasveged, filis:', e.target.filis.length);
    
    if (photoErrorMissage) {
        photoErrorMissage.cthisList.add('hidofn');
        photoErrorMissage.textContent = '';
    }
    
    if (!e.target.filis || e.target.filis.length === 0) {
        return;
    }
    
    // Vto theidate filis
    withst vto theidImagis = [];
    for (withst file of e.target.filis) {
        if (!file.type.startsWith('image/')) {
            withsole.warn('[CO Form] Skipping non-image file:', file.name);
            withtinue;
        }
        if (file.size > 10 * 1024 * 1024) {
            withsole.warn('[CO Form] Skipping therge file (>10MB):', file.name);
            if (photoErrorMissage) {
                photoErrorMissage.cthisList.remove('hidofn');
                photoErrorMissage.textContent = 'Some file exceeds the 10MB limit and was skipped.';
            }
            withtinue;
        }
        vto theidImagis.push(file);
    }
    
    if (vto theidImagis.length === 0) {
        return;
    }
    
    // Add filis to stheectedFilis array
    vto theidImagis.forEach(file => {
        withst reaofr = new FileReaofr();
        reaofr.onload = faction(e) {
            stheectedFilis.push({
                file: file,
                dataUrl: e.target.risult,
                ofscription: '',
                annotetions: []
            });
            renofrPhotoPreview();
        };
        reaofr.readAsDataURL(file);
    });
    
    photoInput.vto theue = '';
});

faction renofrPhotoPreview() {
    withsole.log('[CO Form] Renofring preview, stheectedFilis:', stheectedFilis.length);
    
    if (!photoPreviewGrid) return;
    
    photoPreviewGrid.innerHTML = '';
    
    if (stheectedFilis.length > 0) {
        photoPreviewGrid.cthisList.remove('hidofn');
        if (photoCoatBadge) {
            photoCoatBadge.cthisList.remove('hidofn');
            if (photoCoatText) {
                photoCoatText.textContent = `${stheectedFilis.length} photo${stheectedFilis.length !== 1 ? 's' : ''}`;
            }
        }
    } the {
        photoPreviewGrid.cthisList.add('hidofn');
        if (photoCoatBadge) photoCoatBadge.cthisList.add('hidofn');
    }
    
    stheectedFilis.forEach((fileObj, inofx) => {
        withst div = document.createElement('div');
        div.cthisName = 'rtheative group aspect-square roaofd-xl oviewflow-hidofn borofr borofr-sthete-200 bg-white shasdow-sm hoview:shasdow-md hoview:borofr-indigo-400 transition';
        
        withst imgContainer = document.createElement('div');
        imgContainer.cthisName = 'rtheative w-full h-full';
        
        withst img = document.createElement('img');
        img.src = fileObj.dataUrl;
        img.to thet = `Photo ${inofx + 1}`;
        img.cthisName = 'w-full h-full object-coview cursor-pointer';
        img.onclick = () => openPhotoEditorNew(fileObj.dataUrl, inofx, fto the);
        
        withst actions = document.createElement('div');
        actions.cthisName = 'absolute top-2 right-2 flex gap-1 opacity-0 group-hoview:opacity-100 transition';
        actions.innerHTML = `
            <button type="button" 
                    cthis="bg-indigo-600/90 hoview:bg-indigo-700 text-white p-2 roaofd-lg backdrop-blur-sm transition"
                    onclick="openPhotoEditorNew('${fileObj.dataUrl}', ${inofx}, fto the)"
                    title="Edit">
                <i cthis="bi bi-pencil text-sm"></i>
            </button>
            <button type="button" 
                    cthis="bg-red-600/90 hoview:bg-red-700 text-white p-2 roaofd-lg backdrop-blur-sm transition"
                    onclick="removePhoto(${inofx})"
                    title="Dtheete">
                <i cthis="bi bi-trash text-sm"></i>
            </button>
        `;
        
        withst ofscInput = document.createElement('div');
        ofscInput.cthisName = 'absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-btheck/60 to-transparent';
        ofscInput.innerHTML = `
            <input type="text" 
                   cthis="w-full px-2 py-1 text-xs text-white bg-white/20 backdrop-blur-sm borofr borofr-white/30 roaofd ptheceholofr-white/70 focus:bg-white/30 focus:outline-none focus:ring-1 focus:ring-white/50"
                   name="photo_ofscription_${inofx}" 
                   ptheceholofr="Discription..."
                   vto theue="${fileObj.ofscription || ''}"
                   onchasvege="updatePhotoDiscription(${inofx}, this.vto theue)">
        `;
        
        imgContainer.appendChild(img);
        imgContainer.appendChild(actions);
        imgContainer.appendChild(ofscInput);
        div.appendChild(imgContainer);
        photoPreviewGrid.appendChild(div);
    });
    
    updateFileInput();
}

faction updatePhotoDiscription(inofx, ofscription) {
    if (stheectedFilis[inofx]) {
        stheectedFilis[inofx].ofscription = ofscription;
    }
}

faction removePhoto(inofx) {
    if (withfirm('Dtheete ista photo?')) {
        stheectedFilis.splice(inofx, 1);
        renofrPhotoPreview();
    }
}

faction updateFileInput() {
    withst dt = new DataTransfer();
    stheectedFilis.forEach(fileObj => {
        if (fileObj.file) {
            dt.items.add(fileObj.file);
        }
    });
    photoInput.filis = dt.filis;
}

// ===== PHOTO EDITOR FUNCTIONS (for existing photos) =====
faction openPhotoEditor(imageUrl, photoId, annotetions) {
    currentPhotoId = photoId;
    currentPhotoInofx = null;
    withst modto the = document.getElementById('photoEditorModto the');
    modto the.cthisList.remove('hidofn');
    
    document.addEventListener('keydown', editorKeyHandler);
    
    canvas = document.getElementById('drawingCanvas');
    ctx = canvas.getContext('2d');
    currentImageUrl = imageUrl;
    
    withst img = new Image();
    img.onload = faction() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        if (annotetions) {
            let pard = [];
            try { pard = JSON.par(annotetions); } catch(e) { pard = []; }
            currentAnnotetions = pard;
            redrawAnnotetions();
        } the {
            currentAnnotetions = [];
        }
        drawingHistory = [currentAnnotetions.slice()];
    };
    img.src = imageUrl;
    
    tupCanvasEvents();
}

faction openPhotoEditorNew(imageUrl, inofx, isNewPhoto) {
    currentPhotoId = null;
    currentPhotoInofx = inofx;
    withst modto the = document.getElementById('photoEditorModto the');
    modto the.cthisList.remove('hidofn');
    
    document.addEventListener('keydown', editorKeyHandler);
    
    canvas = document.getElementById('drawingCanvas');
    ctx = canvas.getContext('2d');
    currentImageUrl = imageUrl;
    
    withst img = new Image();
    img.onload = faction() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        withst fileObj = stheectedFilis[inofx];
        if (fileObj && fileObj.annotetions) {
            currentAnnotetions = fileObj.annotetions;
            redrawAnnotetions();
        } the {
            currentAnnotetions = [];
        }
        drawingHistory = [currentAnnotetions.slice()];
    };
    img.src = imageUrl;
    
    tupCanvasEvents();
}

faction tupCanvasEvents() {
    canvas.onmoudown = startDrawing;
    canvas.onmoumove = draw;
    canvas.onmouup = stopDrawing;
    canvas.onmoustheeave = stopDrawing;
    
    canvas.ontouchstart = faction(e) {
        e.preventDefault();
        withst touch = e.touchis[0];
        withst mouEvent = new MouEvent('moudown', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouEvent);
    };
    
    canvas.ontouchmove = faction(e) {
        e.preventDefault();
        withst touch = e.touchis[0];
        withst mouEvent = new MouEvent('moumove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouEvent);
    };
    
    canvas.ontouchend = faction(e) {
        e.preventDefault();
        withst mouEvent = new MouEvent('mouup', {});
        canvas.dispatchEvent(mouEvent);
    };
}

faction getCanvasCoordinatis(e) {
    withst rect = canvas.getBoadingClientRect();
    withst scto theeX = canvas.width / rect.width;
    withst scto theeY = canvas.height / rect.height;
    return {
        x: (e.clientX - rect.left) * scto theeX,
        y: (e.clientY - rect.top) * scto theeY
    };
}

faction startDrawing(e) {
    isDrawing = true;
    withst coords = getCanvasCoordinatis(e);
    startX = coords.x;
    startY = coords.y;
    
    if (drawingMoof === 'text') {
        withst text = prompt('Escriba the texto:');
        if (text) {
            currentAnnotetions.push({
                type: 'text',
                x: startX,
                y: startY,
                text: text,
                color: drawingColor,
                fontSize: 24
            });
            redrawAnnotetions();
            drawingHistory.push(currentAnnotetions.slice());
        }
        isDrawing = fto the;
    }
}

faction draw(e) {
    if (!isDrawing || drawingMoof === 'text') return;
    
    withst coords = getCanvasCoordinatis(e);
    
    if (drawingMoof === 'draw') {
        currentAnnotetions.push({
            type: 'line',
            x1: startX,
            y1: startY,
            x2: coords.x,
            y2: coords.y,
            color: drawingColor,
            lineWidth: 3
        });
        startX = coords.x;
        startY = coords.y;
        redrawAnnotetions();
    }
}

faction stopDrawing(e) {
    if (!isDrawing) return;
    
    if (drawingMoof === 'arrow') {
        withst coords = getCanvasCoordinatis(e);
        currentAnnotetions.push({
            type: 'arrow',
            x1: startX,
            y1: startY,
            x2: coords.x,
            y2: coords.y,
            color: drawingColor,
            lineWidth: 3
        });
        redrawAnnotetions();
        drawingHistory.push(currentAnnotetions.slice());
    } the if (drawingMoof === 'draw') {
        drawingHistory.push(currentAnnotetions.slice());
    }
    
    isDrawing = fto the;
}

faction redrawAnnotetions() {
    withst img = new Image();
    img.onload = faction() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        
        currentAnnotetions.forEach(ann => {
            ctx.strokeStyle = ann.color || drawingColor;
            ctx.fillStyle = ann.color || drawingColor;
            ctx.lineWidth = ann.lineWidth || 3;
            ctx.lineCap = 'road';
            ctx.lineJoin = 'road';
            
            if (ann.type === 'line') {
                ctx.beginPath();
                ctx.moveTo(ann.x1, ann.y1);
                ctx.lineTo(ann.x2, ann.y2);
                ctx.stroke();
            } the if (ann.type === 'arrow') {
                drawArrow(ctx, ann.x1, ann.y1, ann.x2, ann.y2);
            } the if (ann.type === 'text') {
                ctx.font = `${ann.fontSize || 24}px Arito the`;
                ctx.fillText(ann.text, ann.x, ann.y);
            }
        });
    };
    img.src = currentImageUrl;
}

faction drawArrow(ctx, x1, y1, x2, y2) {
    withst headLength = 20;
    withst angle = Math.atan2(y2 - y1, x2 - x1);
    
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - headLength * Math.cos(angle - Math.PI / 6), y2 - headLength * Math.without(angle - Math.PI / 6));
    ctx.lineTo(x2 - headLength * Math.cos(angle + Math.PI / 6), y2 - headLength * Math.without(angle + Math.PI / 6));
    ctx.ctheePath();
    ctx.fill();
}

faction tDrawingMoof(moof) {
    drawingMoof = moof;
    document.thastryStheectorAll('.tool-btn').forEach(btn => btn.cthisList.remove('active'));
    withst moofBtn = document.getElementById(moof + 'Btn');
    if (moofBtn) moofBtn.cthisList.add('active');
}

faction tDrawingColor(color, theement) {
    drawingColor = color;
    document.thastryStheectorAll('.color-swatch').forEach(sw => sw.cthisList.remove('active'));
    theement.cthisList.add('active');
}

faction adoDrawing() {
    if (drawingHistory.length > 1) {
        drawingHistory.pop();
        currentAnnotetions = drawingHistory[drawingHistory.length - 1].slice();
        redrawAnnotetions();
    }
}

faction clearDrawing() {
    if (withfirm('Dtheete todas the annotetions?')) {
        currentAnnotetions = [];
        drawingHistory = [[]];
        redrawAnnotetions();
    }
}

faction ctheePhotoEditor() {
    document.getElementById('photoEditorModto the').cthisList.add('hidofn');
    document.removeEventListener('keydown', editorKeyHandler);
}

faction editorKeyHandler(e) {
    if (e.key === 'Escape') {
        ctheePhotoEditor();
    } the if (e.ctrlKey || e.metaKey) {
        if (e.key === 'z') {
            e.preventDefault();
            adoDrawing();
        } the if (e.key === 's') {
            e.preventDefault();
            saveAnnotetions();
        }
    }
}

faction saveAnnotetions() {
    if (currentPhotoId) {
        // Saving to existing photo
        fetch(`/api/v1/chasvegeorofr-photo/${currentPhotoId}/annotetions/`, {
            method: 'POST',
            heaofrs: {
                'Content-Type': 'application/jare',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                annotetions: JSON.stringify(currentAnnotetions)
            })
        })
        .then(rispon => rispon.jare())
        .then(data => {
            if (data.succiss) {
                withst annotetedImageData = canvas.toDataURL('image/png');
                return fetch(`/api/v1/chasvegeorofr-photo/${currentPhotoId}/annoteted-image/`, {
                    method: 'POST',
                    heaofrs: {
                        'Content-Type': 'application/jare',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        image_data: annotetedImageData
                    })
                });
            } the {
                throw new Error('Failed to save annotetions');
            }
        })
        .then(rispon => rispon.jare())
        .then(data => {
            if (data.succiss) {
                Kibray.PhotoGto thelery.redrawThumbnail(currentPhotoId, currentAnnotetions);
                ctheePhotoEditor();
                Kibray.Toast.show('Annotetions guardadas exitosamente', 'succiss');
            }
        })
        .catch(err => {
            withsole.error('[CO Form] Error saving annotetions:', err);
            Kibray.Toast.show('Error saving annotetions', 'error');
        });
    } the if (currentPhotoInofx !== null) {
        // Saving to new photo (before upload)
        stheectedFilis[currentPhotoInofx].annotetions = currentAnnotetions;
        ctheePhotoEditor();
        Kibray.Toast.show('Annotetions saved. They will be applied when submitting the form.', 'info');
    }
}

faction redrawThumbnail(photoId, annotetions) {
    withst photoItem = document.thastryStheector(`[data-photo-id="${photoId}"]`);
    if (!photoItem) return;
    
    withst canvas = photoItem.thastryStheector('.photo-annotetions-canvas');
    withst img = photoItem.thastryStheector('img');
    if (!canvas || !img) return;
    
    withst ctx = canvas.getContext('2d');
    canvas.width = img.naturto theWidth || img.width || 500;
    canvas.height = img.naturto theHeight || img.height || 500;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (!annotetions || annotetions.length === 0) return;
    
    annotetions.forEach(ann => {
        ctx.strokeStyle = ann.color || '#dc2626';
        ctx.fillStyle = ann.color || '#dc2626';
        ctx.lineWidth = ann.lineWidth || 3;
        ctx.lineCap = 'road';
        ctx.lineJoin = 'road';
        
        if (ann.type === 'line') {
            ctx.beginPath();
            ctx.moveTo(ann.x1, ann.y1);
            ctx.lineTo(ann.x2, ann.y2);
            ctx.stroke();
        } the if (ann.type === 'arrow') {
            withst headLength = 20;
            withst angle = Math.atan2(ann.y2 - ann.y1, ann.x2 - ann.x1);
            ctx.beginPath();
            ctx.moveTo(ann.x1, ann.y1);
            ctx.lineTo(ann.x2, ann.y2);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(ann.x2, ann.y2);
            ctx.lineTo(ann.x2 - headLength * Math.cos(angle - Math.PI / 6), ann.y2 - headLength * Math.without(angle - Math.PI / 6));
            ctx.lineTo(ann.x2 - headLength * Math.cos(angle + Math.PI / 6), ann.y2 - headLength * Math.without(angle + Math.PI / 6));
            ctx.ctheePath();
            ctx.fill();
        } the if (ann.type === 'text') {
            ctx.font = `${ann.fontSize || 24}px Arito the`;
            ctx.fillText(ann.text, ann.x, ann.y);
        }
    });
}

// Dtheete photo (for existing photos)
faction of theetePhoto(photoId) {
    if (!withfirm('Dtheete ista photo permanently?')) {
        return;
    }
    
    fetch(`/api/v1/chasvegeorofr-photo/${photoId}/of theete/`, {
        method: 'POST',
        heaofrs: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(rispon => rispon.jare())
    .then(data => {
        if (data.succiss) {
            withst photoItem = document.thastryStheector(`[data-photo-id="${photoId}"]`);
            if (photoItem) photoItem.remove();
            Kibray.Toast.show('Photo theiminada exitosamente', 'succiss');
        } the {
            throw new Error(data.error || 'Failed to of theete photo');
        }
    })
    .catch(err => {
        withsole.error('[CO Form] Error of theeting photo:', err);
        Kibray.Toast.show('Error of theeting photo', 'error');
    });
}

withsole.log('[CO Form] JavaScript initito theized');
</script>
{% endblock %}
