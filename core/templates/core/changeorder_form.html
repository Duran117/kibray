{% extends "core/base_modern.html" %}
{% load i18n %}

{% block title %}{% if is_edit %}{% trans "Edit" %}{% else %}{% trans "Create" %}{% endif %} Change Order - Kibray{% endblock %}

{% block extra_css %}
<style>
    .co-form-container {
        padding: 24px;
        max-width: 800px;
        margin: 0 auto;
    }
    
    /* Hero Header */
    .co-form-hero {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
        border-radius: 20px;
        padding: 32px 40px;
        margin-bottom: 32px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(245, 158, 11, 0.3);
    }
    .co-form-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -30%;
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, rgba(255,255,255,0.12) 0%, transparent 70%);
        border-radius: 50%;
    }
    .co-form-hero h1 {
        font-size: 1.75rem;
        font-weight: 800;
        color: white;
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        gap: 16px;
        position: relative;
    }
    .co-form-hero p {
        color: rgba(255,255,255,0.85);
        font-size: 1rem;
        margin: 0;
        position: relative;
    }
    .hero-icon {
        width: 52px;
        height: 52px;
        background: rgba(255,255,255,0.2);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        backdrop-filter: blur(10px);
    }
    
    /* Form Card */
    .co-form-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        overflow: hidden;
    }
    
    .form-section {
        padding: 28px 32px;
    }
    
    .form-section:not(:last-child) {
        border-bottom: 1px solid #f1f5f9;
    }
    
    .section-title {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #9ca3af;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .form-group {
        margin-bottom: 24px;
    }
    
    .form-group:last-child {
        margin-bottom: 0;
    }
    
    .form-group label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }
    
    .form-group label .icon {
        width: 28px;
        height: 28px;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.85rem;
    }
    
    .form-group label .required {
        color: #ef4444;
        margin-left: auto;
        font-size: 0.75rem;
    }
    
    .form-control {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        background: white;
    }
    
    .form-control:hover {
        border-color: #d1d5db;
        background: #f9fafb;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #f59e0b;
        background: white;
        box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1);
    }
    
    textarea.form-control {
        resize: vertical;
        min-height: 120px;
        line-height: 1.6;
    }
    
    select.form-control {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        background-size: 18px;
        padding-right: 48px;
    }
    
    /* Currency Input */
    .currency-wrapper {
        position: relative;
    }
    .currency-wrapper .currency-symbol {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1rem;
        font-weight: 600;
        color: #6b7280;
    }
    .currency-wrapper input {
        padding-left: 40px;
    }
    
    /* Status Pills Preview */
    .status-preview {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }
    .status-pill {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        opacity: 0.4;
        transition: all 0.2s ease;
    }
    .status-pill.active {
        opacity: 1;
        transform: scale(1.05);
    }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-approved { background: #d1fae5; color: #065f46; }
    .status-rejected { background: #fee2e2; color: #991b1b; }
    
    /* Form Actions */
    .form-actions {
        display: flex;
        gap: 16px;
        padding: 24px 32px;
        background: #f9fafb;
        border-top: 1px solid #e5e7eb;
    }
    
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px 28px;
        font-size: 0.95rem;
        font-weight: 600;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        flex: 1;
    }
    
    .btn-cancel {
        background: white;
        color: #6b7280;
        border: 2px solid #e5e7eb;
    }
    .btn-cancel:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        color: #374151;
    }
    
    .btn-submit {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        box-shadow: 0 4px 16px rgba(245, 158, 11, 0.35);
    }
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 24px rgba(245, 158, 11, 0.45);
    }
    
    /* Errors */
    .errorlist {
        list-style: none;
        padding: 0;
        margin: 10px 0 0 0;
    }
    .errorlist li {
        color: #ef4444;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .errorlist li::before {
        content: 'âš ';
    }
    
    /* Responsive */
    @media (max-width: 640px) {
        .co-form-container { padding: 16px; }
        .co-form-hero { padding: 24px; }
        .co-form-hero h1 { font-size: 1.35rem; }
        .form-section { padding: 20px; }
        .form-actions { flex-direction: column; }
    }
</style>
{% endblock %}

{% block content %}
<div class="co-form-container">
    <!-- Hero Header -->
    <div class="co-form-hero">
        <h1>
            <span class="hero-icon">
                <i class="bi bi-{% if is_edit %}pencil-square{% else %}file-earmark-plus{% endif %}"></i>
            </span>
            {% if is_edit %}
                {% trans "Edit Change Order" %} #{{ changeorder.id }}
            {% else %}
                {% trans "Create New Change Order" %}
            {% endif %}
        </h1>
        <p>
            {% if is_edit %}
                {% trans "Update the details of this change order" %}
            {% else %}
                {% trans "Fill in the details to create a new change order for the project" %}
            {% endif %}
        </p>
    </div>
    
    <!-- Form Card -->
    <div class="co-form-card">
        <form method="post" id="changeOrderForm">
            {% csrf_token %}
            
            <!-- Project Section -->
            <div class="form-section">
                <div class="section-title">
                    <i class="bi bi-building"></i> {% trans "Project Information" %}
                </div>
                <div class="form-group">
                    <label for="{{ form.project.id_for_label }}">
                        <span class="icon"><i class="bi bi-folder2-open"></i></span>
                        {% trans "Project" %}
                        <span class="required">{% trans "Required" %}</span>
                    </label>
                    {{ form.project }}
                    {% if form.project.errors %}
                        <ul class="errorlist">
                            {% for error in form.project.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
            
            <!-- Description Section -->
            <div class="form-section">
                <div class="section-title">
                    <i class="bi bi-file-text"></i> {% trans "Change Details" %}
                </div>
                <div class="form-group">
                    <label for="{{ form.description.id_for_label }}">
                        <span class="icon"><i class="bi bi-text-paragraph"></i></span>
                        {% trans "Description" %}
                        <span class="required">{% trans "Required" %}</span>
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <ul class="errorlist">
                            {% for error in form.description.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.notes.id_for_label }}">
                        <span class="icon"><i class="bi bi-sticky"></i></span>
                        {% trans "Additional Notes" %}
                    </label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <ul class="errorlist">
                            {% for error in form.notes.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
            
            <!-- Financial Section -->
            <div class="form-section">
                <div class="section-title">
                    <i class="bi bi-currency-dollar"></i> {% trans "Financial" %}
                </div>
                <div class="form-group">
                    <label for="{{ form.amount.id_for_label }}">
                        <span class="icon"><i class="bi bi-cash-stack"></i></span>
                        {% trans "Amount" %}
                        <span class="required">{% trans "Required" %}</span>
                    </label>
                    <div class="currency-wrapper">
                        <span class="currency-symbol">$</span>
                        {{ form.amount }}
                    </div>
                    {% if form.amount.errors %}
                        <ul class="errorlist">
                            {% for error in form.amount.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
            
            <!-- Status Section -->
            <div class="form-section">
                <div class="section-title">
                    <i class="bi bi-flag"></i> {% trans "Status" %}
                </div>
                <div class="form-group">
                    <label for="{{ form.status.id_for_label }}">
                        <span class="icon"><i class="bi bi-check2-square"></i></span>
                        {% trans "Status" %}
                        <span class="required">{% trans "Required" %}</span>
                    </label>
                    {{ form.status }}
                    <div class="status-preview" id="statusPreview">
                        <span class="status-pill status-pending" data-status="Pendiente">{% trans "Pending" %}</span>
                        <span class="status-pill status-approved" data-status="Aprobada">{% trans "Approved" %}</span>
                        <span class="status-pill status-rejected" data-status="Rechazada">{% trans "Rejected" %}</span>
                    </div>
                    {% if form.status.errors %}
                        <ul class="errorlist">
                            {% for error in form.status.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="form-actions">
                <a href="{% url 'changeorder_board' %}" class="btn btn-cancel">
                    <i class="bi bi-x-lg"></i>
                    {% trans "Cancel" %}
                </a>
                <button type="submit" class="btn btn-submit">
                    <i class="bi bi-check2-circle"></i>
                    {% if is_edit %}{% trans "Update" %}{% else %}{% trans "Create" %}{% endif %} Change Order
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Status preview highlight
    const statusSelect = document.getElementById('{{ form.status.id_for_label }}');
    const statusPills = document.querySelectorAll('.status-pill');
    
    function updateStatusPreview() {
        const selectedValue = statusSelect.value;
        statusPills.forEach(pill => {
            pill.classList.remove('active');
            if (pill.dataset.status === selectedValue) {
                pill.classList.add('active');
            }
        });
    }
    
    if (statusSelect) {
        statusSelect.addEventListener('change', updateStatusPreview);
        updateStatusPreview();
    }
    
    // Currency formatting
    const amountInput = document.getElementById('{{ form.amount.id_for_label }}');
    if (amountInput) {
        amountInput.addEventListener('blur', function() {
            let value = parseFloat(this.value.replace(/[^\d.]/g, ''));
            if (!isNaN(value)) {
                this.value = value.toFixed(2);
            }
        });
    }
});
</script>
{% endblock %}
