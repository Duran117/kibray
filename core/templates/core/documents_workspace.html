{% extends "core/base_modern.html" %}
{% load static %}
{% load i18n %}
{% load core_extras %}

{% block extra_css %}
<style>
/* ============================================
   DOCUMENT WORKSPACE - Clean Asana-inspired
   with congruent color accents
   ============================================ */

:root {
  --doc-bg: #fafbfc;
  --doc-sidebar-bg: #ffffff;
  --doc-card-bg: #ffffff;
  --doc-border: #e8ecf0;
  --doc-text: #1a1d21;
  --doc-text-secondary: #6b7280;
  --doc-accent: #5046e5;
  --doc-accent-light: #eef2ff;
  --doc-success: #059669;
  --doc-warning: #d97706;
  --doc-danger: #dc2626;
  --doc-hover: #f8fafc;
  --doc-selected: #eef2ff;
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  --transition: all 0.15s ease;
}

/* Layout */
.doc-workspace {
  display: grid;
  grid-template-columns: 280px 1fr 320px;
  gap: 0;
  height: calc(100vh - 64px);
  background: var(--doc-bg);
  overflow: hidden;
}

.doc-workspace.panel-collapsed {
  grid-template-columns: 280px 1fr 0;
}

/* ============================================
   SIDEBAR - Folder Tree
   ============================================ */
.doc-sidebar {
  background: var(--doc-sidebar-bg);
  border-right: 1px solid var(--doc-border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.doc-sidebar-header {
  padding: 20px;
  border-bottom: 1px solid var(--doc-border);
}

.doc-sidebar-title {
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--doc-text-secondary);
  margin-bottom: 12px;
}

.doc-search {
  position: relative;
}

.doc-search input {
  width: 100%;
  padding: 10px 12px 10px 36px;
  border: 1px solid var(--doc-border);
  border-radius: var(--radius-md);
  font-size: 14px;
  background: var(--doc-bg);
  transition: var(--transition);
}

.doc-search input:focus {
  outline: none;
  border-color: var(--doc-accent);
  box-shadow: 0 0 0 3px var(--doc-accent-light);
}

.doc-search i {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--doc-text-secondary);
  font-size: 14px;
}

/* Folder Tree */
.doc-tree {
  flex: 1;
  overflow-y: auto;
  padding: 12px 0;
}

.doc-tree::-webkit-scrollbar {
  width: 6px;
}

.doc-tree::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 3px;
}

.doc-folder {
  user-select: none;
}

.doc-folder-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px 8px 20px;
  cursor: pointer;
  transition: var(--transition);
  border-left: 3px solid transparent;
  color: var(--doc-text);
  font-size: 14px;
}

.doc-folder-item:hover {
  background: var(--doc-hover);
}

.doc-folder-item.active {
  background: var(--doc-selected);
  border-left-color: var(--doc-accent);
  font-weight: 500;
}

.doc-folder-item.nested-1 { padding-left: 36px; }
.doc-folder-item.nested-2 { padding-left: 52px; }
.doc-folder-item.nested-3 { padding-left: 68px; }

.doc-folder-icon {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

.doc-folder-icon.folder { color: #f59e0b; }
.doc-folder-icon.documents { color: #3b82f6; }
.doc-folder-icon.photos { color: #8b5cf6; }
.doc-folder-icon.contracts { color: #ef4444; }
.doc-folder-icon.invoices { color: #10b981; }

.doc-folder-name {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.doc-folder-count {
  font-size: 12px;
  color: var(--doc-text-secondary);
  background: var(--doc-bg);
  padding: 2px 8px;
  border-radius: 10px;
}

.doc-folder-toggle {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--doc-text-secondary);
  transition: transform 0.2s;
}

.doc-folder-toggle.expanded {
  transform: rotate(90deg);
}

/* Add Folder Button */
.doc-add-folder {
  margin: 12px 16px;
  padding: 10px;
  border: 2px dashed var(--doc-border);
  border-radius: var(--radius-md);
  text-align: center;
  color: var(--doc-text-secondary);
  font-size: 13px;
  cursor: pointer;
  transition: var(--transition);
}

.doc-add-folder:hover {
  border-color: var(--doc-accent);
  color: var(--doc-accent);
  background: var(--doc-accent-light);
}

/* ============================================
   MAIN CONTENT - File Grid/List
   ============================================ */
.doc-main {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--doc-bg);
}

.doc-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  background: var(--doc-card-bg);
  border-bottom: 1px solid var(--doc-border);
  gap: 16px;
}

.doc-breadcrumbs {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: var(--doc-text-secondary);
}

.doc-breadcrumbs a {
  color: var(--doc-text-secondary);
  text-decoration: none;
  transition: var(--transition);
}

.doc-breadcrumbs a:hover {
  color: var(--doc-accent);
}

.doc-breadcrumbs .current {
  color: var(--doc-text);
  font-weight: 500;
}

.doc-toolbar-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}

.doc-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  border: none;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}

.doc-btn-primary {
  background: var(--doc-accent);
  color: white;
}

.doc-btn-primary:hover {
  background: #4338ca;
}

.doc-btn-secondary {
  background: var(--doc-card-bg);
  color: var(--doc-text);
  border: 1px solid var(--doc-border);
}

.doc-btn-secondary:hover {
  background: var(--doc-hover);
  border-color: #d1d5db;
}

.doc-btn-icon {
  padding: 8px;
  background: transparent;
  color: var(--doc-text-secondary);
  border: 1px solid transparent;
}

.doc-btn-icon:hover {
  background: var(--doc-hover);
  color: var(--doc-text);
}

.doc-btn-icon.active {
  background: var(--doc-accent-light);
  color: var(--doc-accent);
}

/* View Toggle */
.doc-view-toggle {
  display: flex;
  background: var(--doc-bg);
  border-radius: var(--radius-md);
  padding: 2px;
}

.doc-view-toggle button {
  padding: 6px 10px;
  border: none;
  background: transparent;
  color: var(--doc-text-secondary);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
}

.doc-view-toggle button.active {
  background: var(--doc-card-bg);
  color: var(--doc-text);
  box-shadow: var(--shadow-sm);
}

/* Files Container */
.doc-files-container {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

/* Grid View */
.doc-files-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 16px;
}

.doc-file-card {
  background: var(--doc-card-bg);
  border: 1px solid var(--doc-border);
  border-radius: var(--radius-lg);
  padding: 16px;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
}

.doc-file-card:hover {
  border-color: var(--doc-accent);
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.doc-file-card.selected {
  border-color: var(--doc-accent);
  background: var(--doc-accent-light);
}

.doc-file-thumb {
  width: 100%;
  height: 100px;
  background: var(--doc-bg);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 12px;
  overflow: hidden;
}

.doc-file-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.doc-file-thumb i {
  font-size: 40px;
}

.doc-file-thumb i.bi-file-pdf { color: #ef4444; }
.doc-file-thumb i.bi-file-image { color: #8b5cf6; }
.doc-file-thumb i.bi-file-spreadsheet { color: #10b981; }
.doc-file-thumb i.bi-file-word { color: #3b82f6; }
.doc-file-thumb i.bi-file-ruled { color: #f59e0b; }
.doc-file-thumb i.bi-file-play { color: #ec4899; }
.doc-file-thumb i.bi-file-earmark { color: #6b7280; }

.doc-file-name {
  font-size: 13px;
  font-weight: 500;
  color: var(--doc-text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 4px;
}

.doc-file-meta {
  font-size: 12px;
  color: var(--doc-text-secondary);
}

.doc-file-favorite {
  position: absolute;
  top: 12px;
  right: 12px;
  color: #d1d5db;
  cursor: pointer;
  transition: var(--transition);
}

.doc-file-favorite:hover,
.doc-file-favorite.active {
  color: #f59e0b;
}

/* List View */
.doc-files-list {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.doc-file-row {
  display: grid;
  grid-template-columns: auto 1fr auto auto auto auto;
  align-items: center;
  gap: 16px;
  padding: 12px 16px;
  background: var(--doc-card-bg);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: var(--transition);
}

.doc-file-row:hover {
  background: var(--doc-hover);
}

.doc-file-row.selected {
  background: var(--doc-selected);
}

.doc-file-row-icon {
  width: 36px;
  height: 36px;
  background: var(--doc-bg);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

.doc-file-row-name {
  font-size: 14px;
  color: var(--doc-text);
}

.doc-file-row-tags {
  display: flex;
  gap: 4px;
}

.doc-file-row-size,
.doc-file-row-date {
  font-size: 13px;
  color: var(--doc-text-secondary);
  white-space: nowrap;
}

.doc-file-row-actions {
  display: flex;
  gap: 4px;
  opacity: 0;
  transition: var(--transition);
}

.doc-file-row:hover .doc-file-row-actions {
  opacity: 1;
}

/* Tags */
.doc-tag {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 500;
}

.doc-tag-red { background: #fef2f2; color: #dc2626; }
.doc-tag-orange { background: #fff7ed; color: #ea580c; }
.doc-tag-yellow { background: #fefce8; color: #ca8a04; }
.doc-tag-green { background: #f0fdf4; color: #16a34a; }
.doc-tag-cyan { background: #ecfeff; color: #0891b2; }
.doc-tag-blue { background: #eff6ff; color: #2563eb; }
.doc-tag-indigo { background: #eef2ff; color: #4f46e5; }
.doc-tag-purple { background: #faf5ff; color: #9333ea; }
.doc-tag-pink { background: #fdf2f8; color: #db2777; }
.doc-tag-slate { background: #f8fafc; color: #475569; }

/* Empty State */
.doc-empty {
  text-align: center;
  padding: 60px 20px;
  color: var(--doc-text-secondary);
}

.doc-empty i {
  font-size: 64px;
  color: #d1d5db;
  margin-bottom: 16px;
}

.doc-empty h3 {
  font-size: 16px;
  font-weight: 500;
  color: var(--doc-text);
  margin-bottom: 8px;
}

.doc-empty p {
  font-size: 14px;
  margin-bottom: 20px;
}

/* ============================================
   DETAIL PANEL - Right Side
   ============================================ */
.doc-panel {
  background: var(--doc-card-bg);
  border-left: 1px solid var(--doc-border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: width 0.2s;
}

.doc-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid var(--doc-border);
}

.doc-panel-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--doc-text);
}

.doc-panel-close {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-sm);
  cursor: pointer;
  color: var(--doc-text-secondary);
  transition: var(--transition);
}

.doc-panel-close:hover {
  background: var(--doc-hover);
  color: var(--doc-text);
}

.doc-panel-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.doc-panel-preview {
  background: var(--doc-bg);
  border-radius: var(--radius-lg);
  padding: 32px;
  text-align: center;
  margin-bottom: 20px;
}

.doc-panel-preview img {
  max-width: 100%;
  max-height: 200px;
  border-radius: var(--radius-md);
}

.doc-panel-preview i {
  font-size: 72px;
}

.doc-panel-filename {
  font-size: 16px;
  font-weight: 600;
  color: var(--doc-text);
  margin-bottom: 4px;
  word-break: break-word;
}

.doc-panel-section {
  margin-bottom: 24px;
}

.doc-panel-section-title {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--doc-text-secondary);
  margin-bottom: 12px;
}

.doc-panel-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  font-size: 13px;
  border-bottom: 1px solid var(--doc-border);
}

.doc-panel-row:last-child {
  border-bottom: none;
}

.doc-panel-row-label {
  color: var(--doc-text-secondary);
}

.doc-panel-row-value {
  color: var(--doc-text);
  font-weight: 500;
}

.doc-panel-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.doc-panel-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  padding: 16px 20px;
  border-top: 1px solid var(--doc-border);
}

/* ============================================
   UPLOAD ZONE
   ============================================ */
.doc-upload-zone {
  border: 2px dashed var(--doc-border);
  border-radius: var(--radius-lg);
  padding: 40px 20px;
  text-align: center;
  transition: var(--transition);
  cursor: pointer;
  margin: 16px;
  background: var(--doc-bg);
}

.doc-upload-zone:hover,
.doc-upload-zone.dragover {
  border-color: var(--doc-accent);
  background: var(--doc-accent-light);
}

.doc-upload-zone i {
  font-size: 40px;
  color: var(--doc-accent);
  margin-bottom: 12px;
}

.doc-upload-zone h4 {
  font-size: 14px;
  font-weight: 500;
  color: var(--doc-text);
  margin-bottom: 4px;
}

.doc-upload-zone p {
  font-size: 13px;
  color: var(--doc-text-secondary);
}

/* ============================================
   MODALS
   ============================================ */
.doc-modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: var(--transition);
}

.doc-modal-backdrop.active {
  opacity: 1;
  visibility: visible;
}

.doc-modal {
  background: var(--doc-card-bg);
  border-radius: var(--radius-lg);
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  transform: translateY(20px);
  transition: var(--transition);
}

.doc-modal-backdrop.active .doc-modal {
  transform: translateY(0);
}

.doc-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  border-bottom: 1px solid var(--doc-border);
}

.doc-modal-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--doc-text);
}

.doc-modal-body {
  padding: 24px;
  overflow-y: auto;
}

.doc-modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding: 16px 24px;
  border-top: 1px solid var(--doc-border);
  background: var(--doc-bg);
}

/* Form Elements */
.doc-form-group {
  margin-bottom: 20px;
}

.doc-form-label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: var(--doc-text);
  margin-bottom: 6px;
}

.doc-form-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--doc-border);
  border-radius: var(--radius-md);
  font-size: 14px;
  transition: var(--transition);
}

.doc-form-input:focus {
  outline: none;
  border-color: var(--doc-accent);
  box-shadow: 0 0 0 3px var(--doc-accent-light);
}

/* ============================================
   MOBILE RESPONSIVE
   ============================================ */
@media (max-width: 1024px) {
  .doc-workspace {
    grid-template-columns: 1fr;
  }
  
  .doc-sidebar {
    position: fixed;
    left: -280px;
    top: 64px;
    bottom: 0;
    width: 280px;
    z-index: 100;
    transition: left 0.3s;
  }
  
  .doc-sidebar.open {
    left: 0;
    box-shadow: var(--shadow-md);
  }
  
  .doc-panel {
    position: fixed;
    right: -320px;
    top: 64px;
    bottom: 0;
    width: 320px;
    z-index: 100;
    transition: right 0.3s;
  }
  
  .doc-panel.open {
    right: 0;
    box-shadow: var(--shadow-md);
  }
  
  .doc-files-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }
}

@media (max-width: 640px) {
  .doc-toolbar {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }
  
  .doc-toolbar-actions {
    justify-content: space-between;
  }
  
  .doc-files-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  
  .doc-file-card {
    padding: 12px;
  }
  
  .doc-file-thumb {
    height: 80px;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="doc-workspace" id="docWorkspace">
  <!-- ============================================
       SIDEBAR - Folder Tree
       ============================================ -->
  <aside class="doc-sidebar" id="docSidebar">
    <div class="doc-sidebar-header">
      <div class="doc-sidebar-title">{% trans "Workspaces" %}</div>
      <div class="doc-search">
        <i class="bi bi-search"></i>
        <input type="text" placeholder="{% trans 'Buscar archivos...' %}" id="searchInput">
      </div>
    </div>
    
    <nav class="doc-tree" id="folderTree">
      <!-- All Files -->
      <div class="doc-folder-item {% if not selected_category_id %}active{% endif %}" 
           data-category="all"
           onclick="selectFolder(null)">
        <span class="doc-folder-icon"><i class="bi bi-grid-3x3-gap"></i></span>
        <span class="doc-folder-name">{% trans "Todos los archivos" %}</span>
        <span class="doc-folder-count">{{ total_files }}</span>
      </div>
      
      <!-- Favorites -->
      <div class="doc-folder-item" data-category="favorites" onclick="selectFolder('favorites')">
        <span class="doc-folder-icon"><i class="bi bi-star" style="color: #f59e0b;"></i></span>
        <span class="doc-folder-name">{% trans "Favoritos" %}</span>
        <span class="doc-folder-count">{{ favorites_count }}</span>
      </div>
      
      <hr style="margin: 12px 16px; border: none; border-top: 1px solid var(--doc-border);">
      
      <!-- Folder Categories -->
      {% for category in categories %}
      <div class="doc-folder">
        <div class="doc-folder-item {% if selected_category_id == category.id|stringformat:'s' %}active{% endif %}"
             data-category="{{ category.id }}"
             onclick="selectFolder({{ category.id }})">
          {% if category.children.exists %}
          <span class="doc-folder-toggle" onclick="event.stopPropagation(); toggleFolder(this)">
            <i class="bi bi-chevron-right"></i>
          </span>
          {% endif %}
          <span class="doc-folder-icon folder"><i class="{{ category.icon }}"></i></span>
          <span class="doc-folder-name">{{ category.name }}</span>
          <span class="doc-folder-count">{{ category.file_count }}</span>
        </div>
        
        {% if category.children.exists %}
        <div class="doc-folder-children" style="display: none;">
          {% for child in category.children.all %}
          <div class="doc-folder-item nested-1" 
               data-category="{{ child.id }}"
               onclick="selectFolder({{ child.id }})">
            <span class="doc-folder-icon folder"><i class="{{ child.icon }}"></i></span>
            <span class="doc-folder-name">{{ child.name }}</span>
            <span class="doc-folder-count">{{ child.file_count }}</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </nav>
    
    <!-- Add Folder -->
    <div class="doc-add-folder" onclick="openModal('createFolderModal')">
      <i class="bi bi-plus-lg"></i> {% trans "Nueva Carpeta" %}
    </div>
  </aside>
  
  <!-- ============================================
       MAIN CONTENT - Files
       ============================================ -->
  <main class="doc-main">
    <!-- Toolbar -->
    <div class="doc-toolbar">
      <div class="doc-breadcrumbs">
        <button class="doc-btn-icon d-lg-none" onclick="toggleSidebar()">
          <i class="bi bi-list"></i>
        </button>
        <a href="{% url 'project_overview' project.id %}">{{ project.name }}</a>
        <i class="bi bi-chevron-right"></i>
        <a href="{% url 'project_files' project.id %}">{% trans "Documentos" %}</a>
        {% if selected_category %}
        <i class="bi bi-chevron-right"></i>
        <span class="current">{{ selected_category.name }}</span>
        {% endif %}
      </div>
      
      <div class="doc-toolbar-actions">
        <!-- View Toggle -->
        <div class="doc-view-toggle">
          <button class="active" onclick="setView('grid')" title="Vista cuadr√≠cula">
            <i class="bi bi-grid-3x3-gap"></i>
          </button>
          <button onclick="setView('list')" title="Vista lista">
            <i class="bi bi-list-ul"></i>
          </button>
        </div>
        
        <!-- Filter by Tags -->
        <div class="dropdown">
          <button class="doc-btn doc-btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="bi bi-tag"></i> {% trans "Tags" %}
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            {% for tag in all_tags %}
            <li>
              <a class="dropdown-item" href="?tag={{ tag.id }}{% if selected_category_id %}&category={{ selected_category_id }}{% endif %}">
                <span class="doc-tag doc-tag-{{ tag.color }}">{{ tag.name }}</span>
              </a>
            </li>
            {% empty %}
            <li><span class="dropdown-item text-muted">{% trans "Sin tags" %}</span></li>
            {% endfor %}
          </ul>
        </div>
        
        <!-- Upload Button -->
        <button class="doc-btn doc-btn-primary" onclick="openModal('uploadModal')">
          <i class="bi bi-cloud-upload"></i>
          <span class="d-none d-sm-inline">{% trans "Subir" %}</span>
        </button>
      </div>
    </div>
    
    <!-- Files Container -->
    <div class="doc-files-container" id="filesContainer">
      {% if files %}
      <!-- Grid View (default) -->
      <div class="doc-files-grid" id="gridView">
        {% for file in files %}
        <div class="doc-file-card" data-file-id="{{ file.id }}" onclick="selectFile({{ file.id }})">
          <i class="bi bi-star{% if file.is_favorited %}-fill{% endif %} doc-file-favorite {% if file.is_favorited %}active{% endif %}"
             onclick="event.stopPropagation(); toggleFavorite({{ file.id }})"></i>
          
          <div class="doc-file-thumb">
            {% if file.file_type == 'image' %}
            <img src="{{ file.file.url }}" alt="{{ file.name }}" loading="lazy">
            {% else %}
            <i class="{{ file.get_icon }}"></i>
            {% endif %}
          </div>
          
          <div class="doc-file-name" title="{{ file.name }}">{{ file.name }}</div>
          <div class="doc-file-meta">{{ file.get_size_display }} ¬∑ {{ file.uploaded_at|date:"d M" }}</div>
          
          {% if file.document_tags.exists %}
          <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
            {% for tag in file.document_tags.all|slice:":2" %}
            <span class="doc-tag doc-tag-{{ tag.color }}">{{ tag.name }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      
      <!-- List View (hidden by default) -->
      <div class="doc-files-list" id="listView" style="display: none;">
        {% for file in files %}
        <div class="doc-file-row" data-file-id="{{ file.id }}" onclick="selectFile({{ file.id }})">
          <div class="doc-file-row-icon">
            <i class="{{ file.get_icon }}" style="color: {% if file.file_type == 'pdf' %}#ef4444{% elif file.file_type == 'image' %}#8b5cf6{% elif file.file_type == 'spreadsheet' %}#10b981{% elif file.file_type == 'word' %}#3b82f6{% else %}#6b7280{% endif %};"></i>
          </div>
          <div class="doc-file-row-name">{{ file.name }}</div>
          <div class="doc-file-row-tags">
            {% for tag in file.document_tags.all|slice:":3" %}
            <span class="doc-tag doc-tag-{{ tag.color }}">{{ tag.name }}</span>
            {% endfor %}
          </div>
          <div class="doc-file-row-size">{{ file.get_size_display }}</div>
          <div class="doc-file-row-date">{{ file.uploaded_at|date:"d/m/Y" }}</div>
          <div class="doc-file-row-actions">
            <button class="doc-btn-icon" onclick="event.stopPropagation(); downloadFile({{ file.id }})" title="{% trans 'Descargar' %}">
              <i class="bi bi-download"></i>
            </button>
            <button class="doc-btn-icon" onclick="event.stopPropagation(); toggleFavorite({{ file.id }})" title="{% trans 'Favorito' %}">
              <i class="bi bi-star{% if file.is_favorited %}-fill{% endif %}"></i>
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
      
      {% else %}
      <!-- Empty State -->
      <div class="doc-empty">
        <i class="bi bi-folder2-open"></i>
        <h3>{% trans "No hay archivos aqu√≠" %}</h3>
        <p>{% trans "Sube tu primer archivo o arrastra archivos a esta carpeta" %}</p>
        <button class="doc-btn doc-btn-primary" onclick="openModal('uploadModal')">
          <i class="bi bi-cloud-upload"></i> {% trans "Subir Archivo" %}
        </button>
      </div>
      {% endif %}
      
      <!-- Drop Zone (shown on drag) -->
      <div class="doc-upload-zone" id="dropZone" style="display: none;">
        <i class="bi bi-cloud-arrow-up"></i>
        <h4>{% trans "Suelta los archivos aqu√≠" %}</h4>
        <p>{% trans "para subirlos a esta carpeta" %}</p>
      </div>
    </div>
  </main>
  
  <!-- ============================================
       DETAIL PANEL - Right Side
       ============================================ -->
  <aside class="doc-panel" id="docPanel">
    <div class="doc-panel-header">
      <span class="doc-panel-title">{% trans "Detalles" %}</span>
      <span class="doc-panel-close" onclick="closePanel()">
        <i class="bi bi-x-lg"></i>
      </span>
    </div>
    
    <div class="doc-panel-content" id="panelContent">
      <!-- Content loaded dynamically -->
      <div class="doc-empty" style="padding: 40px 0;">
        <i class="bi bi-cursor" style="font-size: 48px;"></i>
        <p>{% trans "Selecciona un archivo para ver sus detalles" %}</p>
      </div>
    </div>
  </aside>
</div>

<!-- ============================================
     UPLOAD MODAL
     ============================================ -->
<div class="doc-modal-backdrop" id="uploadModal">
  <div class="doc-modal">
    <div class="doc-modal-header">
      <h3><i class="bi bi-cloud-upload"></i> {% trans "Subir Archivos" %}</h3>
      <span class="doc-panel-close" onclick="closeModal('uploadModal')">
        <i class="bi bi-x-lg"></i>
      </span>
    </div>
    <form method="post" action="{% url 'file_upload' project.id selected_category.id|default:0 %}" enctype="multipart/form-data" id="uploadForm">
      {% csrf_token %}
      <div class="doc-modal-body">
        <div class="doc-upload-zone" id="modalDropZone">
          <i class="bi bi-cloud-arrow-up"></i>
          <h4>{% trans "Arrastra archivos aqu√≠" %}</h4>
          <p>{% trans "o haz clic para seleccionar" %}</p>
          <input type="file" name="file" id="fileInput" multiple style="display: none;">
        </div>
        
        <div id="filesList" style="margin-top: 16px;"></div>
        
        <div class="doc-form-group" style="margin-top: 20px;">
          <label class="doc-form-label">{% trans "Tags" %}</label>
          <select name="tags" class="doc-form-input" multiple id="tagSelect">
            {% for tag in all_tags %}
            <option value="{{ tag.id }}">{{ tag.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="doc-modal-footer">
        <button type="button" class="doc-btn doc-btn-secondary" onclick="closeModal('uploadModal')">
          {% trans "Cancelar" %}
        </button>
        <button type="submit" class="doc-btn doc-btn-primary">
          <i class="bi bi-upload"></i> {% trans "Subir" %}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ============================================
     CREATE FOLDER MODAL
     ============================================ -->
<div class="doc-modal-backdrop" id="createFolderModal">
  <div class="doc-modal">
    <div class="doc-modal-header">
      <h3><i class="bi bi-folder-plus"></i> {% trans "Nueva Carpeta" %}</h3>
      <span class="doc-panel-close" onclick="closeModal('createFolderModal')">
        <i class="bi bi-x-lg"></i>
      </span>
    </div>
    <form method="post" action="{% url 'file_category_create' project.id %}">
      {% csrf_token %}
      <div class="doc-modal-body">
        <div class="doc-form-group">
          <label class="doc-form-label">{% trans "Nombre de la carpeta" %}</label>
          <input type="text" name="name" class="doc-form-input" required placeholder="{% trans 'Ej: Contratos 2025' %}">
        </div>
        
        <div class="doc-form-group">
          <label class="doc-form-label">{% trans "Carpeta padre" %} <span style="color: var(--doc-text-secondary);">({% trans "opcional" %})</span></label>
          <select name="parent" class="doc-form-input">
            <option value="">{% trans "Ninguna (carpeta ra√≠z)" %}</option>
            {% for cat in categories %}
            <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="doc-form-group">
          <label class="doc-form-label">{% trans "Icono" %}</label>
          <select name="icon" class="doc-form-input">
            <option value="bi-folder">üìÅ Carpeta</option>
            <option value="bi-file-earmark-text">üìÑ Documentos</option>
            <option value="bi-images">üñºÔ∏è Fotos</option>
            <option value="bi-receipt">üßæ Facturas</option>
            <option value="bi-file-earmark-ruled">üìê Planos</option>
            <option value="bi-shield-check">üõ°Ô∏è Contratos</option>
          </select>
        </div>
      </div>
      <div class="doc-modal-footer">
        <button type="button" class="doc-btn doc-btn-secondary" onclick="closeModal('createFolderModal')">
          {% trans "Cancelar" %}
        </button>
        <button type="submit" class="doc-btn doc-btn-primary">
          <i class="bi bi-plus-lg"></i> {% trans "Crear" %}
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// State
let currentView = 'grid';
let selectedFileId = null;

// View Toggle
function setView(view) {
  currentView = view;
  const gridView = document.getElementById('gridView');
  const listView = document.getElementById('listView');
  const buttons = document.querySelectorAll('.doc-view-toggle button');
  
  buttons.forEach(btn => btn.classList.remove('active'));
  
  if (view === 'grid') {
    gridView.style.display = 'grid';
    listView.style.display = 'none';
    buttons[0].classList.add('active');
  } else {
    gridView.style.display = 'none';
    listView.style.display = 'flex';
    buttons[1].classList.add('active');
  }
  
  localStorage.setItem('docView', view);
}

// Folder Selection
function selectFolder(categoryId) {
  const url = new URL(window.location);
  if (categoryId === null) {
    url.searchParams.delete('category');
  } else if (categoryId === 'favorites') {
    url.searchParams.set('favorites', '1');
    url.searchParams.delete('category');
  } else {
    url.searchParams.set('category', categoryId);
    url.searchParams.delete('favorites');
  }
  window.location = url;
}

// Toggle Folder Expand
function toggleFolder(toggle) {
  const folder = toggle.closest('.doc-folder');
  const children = folder.querySelector('.doc-folder-children');
  const icon = toggle.querySelector('i');
  
  if (children.style.display === 'none') {
    children.style.display = 'block';
    toggle.classList.add('expanded');
  } else {
    children.style.display = 'none';
    toggle.classList.remove('expanded');
  }
}

// File Selection
function selectFile(fileId) {
  selectedFileId = fileId;
  
  // Update UI selection
  document.querySelectorAll('.doc-file-card, .doc-file-row').forEach(el => {
    el.classList.remove('selected');
  });
  document.querySelectorAll(`[data-file-id="${fileId}"]`).forEach(el => {
    el.classList.add('selected');
  });
  
  // Load file details
  loadFileDetails(fileId);
  
  // Open panel on mobile
  if (window.innerWidth < 1024) {
    document.getElementById('docPanel').classList.add('open');
  }
}

// Load File Details
function loadFileDetails(fileId) {
  fetch(`/api/files/${fileId}/details/`)
    .then(r => r.json())
    .then(data => {
      const panel = document.getElementById('panelContent');
      panel.innerHTML = `
        <div class="doc-panel-preview">
          ${data.file_type === 'image' 
            ? `<img src="${data.file_url}" alt="${data.name}">`
            : `<i class="${data.icon}" style="color: ${data.icon_color};"></i>`
          }
        </div>
        
        <div class="doc-panel-filename">${data.name}</div>
        
        <div class="doc-panel-section">
          <div class="doc-panel-section-title">{% trans "Informaci√≥n" %}</div>
          <div class="doc-panel-row">
            <span class="doc-panel-row-label">{% trans "Tama√±o" %}</span>
            <span class="doc-panel-row-value">${data.size}</span>
          </div>
          <div class="doc-panel-row">
            <span class="doc-panel-row-label">{% trans "Tipo" %}</span>
            <span class="doc-panel-row-value">${data.file_type}</span>
          </div>
          <div class="doc-panel-row">
            <span class="doc-panel-row-label">{% trans "Subido" %}</span>
            <span class="doc-panel-row-value">${data.uploaded_at}</span>
          </div>
          <div class="doc-panel-row">
            <span class="doc-panel-row-label">{% trans "Por" %}</span>
            <span class="doc-panel-row-value">${data.uploaded_by}</span>
          </div>
          ${data.version ? `
          <div class="doc-panel-row">
            <span class="doc-panel-row-label">{% trans "Versi√≥n" %}</span>
            <span class="doc-panel-row-value">${data.version}</span>
          </div>
          ` : ''}
        </div>
        
        ${data.tags.length > 0 ? `
        <div class="doc-panel-section">
          <div class="doc-panel-section-title">{% trans "Tags" %}</div>
          <div class="doc-panel-tags">
            ${data.tags.map(t => `<span class="doc-tag doc-tag-${t.color}">${t.name}</span>`).join('')}
          </div>
        </div>
        ` : ''}
        
        ${data.description ? `
        <div class="doc-panel-section">
          <div class="doc-panel-section-title">{% trans "Descripci√≥n" %}</div>
          <p style="font-size: 13px; color: var(--doc-text);">${data.description}</p>
        </div>
        ` : ''}
        
        <div class="doc-panel-section" id="workflowSection">
          <div class="doc-panel-section-title">
            <i class="bi bi-diagram-3"></i> {% trans "Workflow" %}
          </div>
          <div id="workflowContent">
            <div style="text-align: center; padding: 10px; color: var(--doc-text-secondary);">
              <i class="bi bi-arrow-repeat spin" style="font-size: 16px;"></i>
            </div>
          </div>
        </div>
      `;
      
      // Load workflow status
      loadWorkflowStatus(fileId);
    })
    .catch(() => {
      // Fallback if API not available
    });
}

// Load Workflow Status
function loadWorkflowStatus(fileId) {
  fetch(`/api/files/${fileId}/workflow/`)
    .then(r => r.json())
    .then(data => {
      const container = document.getElementById('workflowContent');
      if (!data.has_workflow) {
        container.innerHTML = `
          <div style="text-align: center; padding: 12px;">
            <p style="font-size: 13px; color: var(--doc-text-secondary); margin-bottom: 12px;">
              {% trans "Sin workflow activo" %}
            </p>
            <button class="doc-btn doc-btn-secondary" onclick="startWorkflow(${fileId})" style="width: 100%;">
              <i class="bi bi-play-circle"></i> {% trans "Iniciar Aprobaci√≥n" %}
            </button>
          </div>
        `;
      } else {
        const statusColors = {
          'pending': '#f59e0b',
          'in_progress': '#3b82f6',
          'approved': '#22c55e',
          'rejected': '#ef4444',
          'cancelled': '#6b7280'
        };
        const statusIcons = {
          'pending': 'bi-clock',
          'in_progress': 'bi-arrow-repeat',
          'approved': 'bi-check-circle-fill',
          'rejected': 'bi-x-circle-fill',
          'cancelled': 'bi-slash-circle'
        };
        container.innerHTML = `
          <div style="padding: 8px 0;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <i class="${statusIcons[data.status]}" style="color: ${statusColors[data.status]}; font-size: 18px;"></i>
              <span style="font-weight: 500; color: ${statusColors[data.status]};">${data.status_display}</span>
            </div>
            
            <div style="background: var(--doc-bg); border-radius: 6px; height: 8px; overflow: hidden; margin-bottom: 12px;">
              <div style="background: ${statusColors[data.status]}; height: 100%; width: ${data.progress}%; transition: width 0.3s;"></div>
            </div>
            
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--doc-text-secondary);">
              <span>${data.progress}% {% trans "completado" %}</span>
            </div>
            
            ${data.status === 'in_progress' ? `
            <div style="margin-top: 16px; display: flex; gap: 8px;">
              <button class="doc-btn doc-btn-primary" onclick="approveWorkflow(${data.workflow_id})" style="flex: 1;">
                <i class="bi bi-check-lg"></i> {% trans "Aprobar" %}
              </button>
              <button class="doc-btn doc-btn-secondary" onclick="rejectWorkflow(${data.workflow_id})" style="flex: 1; border-color: #ef4444; color: #ef4444;">
                <i class="bi bi-x-lg"></i> {% trans "Rechazar" %}
              </button>
            </div>
            ` : ''}
            
            ${data.can_start && data.status !== 'in_progress' && data.status !== 'pending' ? `
            <button class="doc-btn doc-btn-secondary" onclick="startWorkflow(${fileId})" style="width: 100%; margin-top: 12px;">
              <i class="bi bi-arrow-clockwise"></i> {% trans "Nuevo Workflow" %}
            </button>
            ` : ''}
            
            <button class="doc-btn doc-btn-icon" onclick="viewWorkflowDetails(${data.workflow_id})" style="width: 100%; margin-top: 8px; font-size: 12px;">
              <i class="bi bi-eye"></i> {% trans "Ver Detalles" %}
            </button>
          </div>
        `;
      }
    })
    .catch(() => {
      document.getElementById('workflowContent').innerHTML = `
        <p style="font-size: 12px; color: var(--doc-text-secondary); text-align: center;">
          {% trans "No disponible" %}
        </p>
      `;
    });
}

// Workflow Actions
function startWorkflow(fileId) {
  fetch(`/api/files/${fileId}/workflow/start/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
      'Content-Type': 'application/json'
    }
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      loadWorkflowStatus(fileId);
      showToast(data.message, 'success');
    } else {
      showToast(data.error, 'error');
    }
  });
}

function approveWorkflow(workflowId) {
  const comment = prompt('{% trans "Comentario (opcional):" %}', '');
  fetch(`/api/workflows/${workflowId}/action/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ action: 'approved', comment: comment || '' })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      loadWorkflowStatus(selectedFileId);
      showToast(data.message, 'success');
    } else {
      showToast(data.error, 'error');
    }
  });
}

function rejectWorkflow(workflowId) {
  const comment = prompt('{% trans "Motivo del rechazo:" %}', '');
  if (comment === null) return;
  fetch(`/api/workflows/${workflowId}/action/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ action: 'rejected', comment: comment })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      loadWorkflowStatus(selectedFileId);
      showToast(data.message, 'success');
    } else {
      showToast(data.error, 'error');
    }
  });
}

function viewWorkflowDetails(workflowId) {
  fetch(`/api/workflows/${workflowId}/`)
    .then(r => r.json())
    .then(data => {
      let stepsHtml = data.steps.map(step => {
        const statusIcon = step.is_completed ? 'bi-check-circle-fill text-success' : 
                          step.is_current ? 'bi-circle-fill text-primary' : 'bi-circle text-muted';
        return `
          <div style="display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--doc-border);">
            <i class="bi ${statusIcon}" style="font-size: 14px; margin-top: 2px;"></i>
            <div style="flex: 1;">
              <div style="font-weight: 500; font-size: 13px;">${step.name}</div>
              <div style="font-size: 11px; color: var(--doc-text-secondary);">${step.type}</div>
              ${step.actions.length > 0 ? step.actions.map(a => `
                <div style="font-size: 11px; color: var(--doc-text-secondary); margin-top: 4px;">
                  ${a.action} por ${a.performed_by} - ${new Date(a.performed_at).toLocaleDateString()}
                </div>
              `).join('') : ''}
            </div>
          </div>
        `;
      }).join('');
      
      // Show in modal
      const modal = document.createElement('div');
      modal.className = 'doc-modal-backdrop active';
      modal.innerHTML = `
        <div class="doc-modal" style="max-width: 400px;">
          <div class="doc-modal-header">
            <h3><i class="bi bi-diagram-3"></i> {% trans "Detalles del Workflow" %}</h3>
            <span class="doc-panel-close" onclick="this.closest('.doc-modal-backdrop').remove()">
              <i class="bi bi-x-lg"></i>
            </span>
          </div>
          <div class="doc-modal-body" style="max-height: 400px; overflow-y: auto;">
            <div style="margin-bottom: 16px;">
              <div style="font-size: 12px; color: var(--doc-text-secondary);">{% trans "Archivo" %}</div>
              <div style="font-weight: 500;">${data.file_name}</div>
            </div>
            <div style="margin-bottom: 16px;">
              <div style="font-size: 12px; color: var(--doc-text-secondary);">{% trans "Iniciado por" %}</div>
              <div>${data.initiated_by || '-'}</div>
            </div>
            <div style="margin-bottom: 16px;">
              <div style="font-size: 12px; color: var(--doc-text-secondary);">{% trans "Pasos" %}</div>
              ${stepsHtml}
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    });
}

// Toast notifications
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 20px;
    background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
    color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 9999;
    animation: slideIn 0.3s ease;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

// Toggle Favorite
function toggleFavorite(fileId) {
  fetch(`/api/files/${fileId}/favorite/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
    }
  })
  .then(r => r.json())
  .then(data => {
    const icons = document.querySelectorAll(`[data-file-id="${fileId}"] .doc-file-favorite, [data-file-id="${fileId}"] .doc-file-row-actions .bi-star, [data-file-id="${fileId}"] .doc-file-row-actions .bi-star-fill`);
    icons.forEach(icon => {
      if (data.favorited) {
        icon.classList.remove('bi-star');
        icon.classList.add('bi-star-fill', 'active');
      } else {
        icon.classList.remove('bi-star-fill', 'active');
        icon.classList.add('bi-star');
      }
    });
  });
}

// Download File
function downloadFile(fileId) {
  window.location = `/files/${fileId}/download/`;
}

// Modal Functions
function openModal(modalId) {
  document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

// Close panel
function closePanel() {
  document.getElementById('docPanel').classList.remove('open');
  selectedFileId = null;
  document.querySelectorAll('.doc-file-card, .doc-file-row').forEach(el => {
    el.classList.remove('selected');
  });
}

// Toggle Sidebar (mobile)
function toggleSidebar() {
  document.getElementById('docSidebar').classList.toggle('open');
}

// Drag & Drop
const dropZone = document.getElementById('dropZone');
const filesContainer = document.getElementById('filesContainer');
const modalDropZone = document.getElementById('modalDropZone');
const fileInput = document.getElementById('fileInput');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  filesContainer.addEventListener(eventName, e => {
    e.preventDefault();
    e.stopPropagation();
  });
});

filesContainer.addEventListener('dragenter', () => {
  dropZone.style.display = 'block';
});

filesContainer.addEventListener('dragleave', e => {
  if (!filesContainer.contains(e.relatedTarget)) {
    dropZone.style.display = 'none';
  }
});

filesContainer.addEventListener('drop', e => {
  dropZone.style.display = 'none';
  const files = e.dataTransfer.files;
  if (files.length) {
    handleFiles(files);
  }
});

// Modal drop zone
modalDropZone.addEventListener('click', () => fileInput.click());
modalDropZone.addEventListener('dragover', e => {
  e.preventDefault();
  modalDropZone.classList.add('dragover');
});
modalDropZone.addEventListener('dragleave', () => {
  modalDropZone.classList.remove('dragover');
});
modalDropZone.addEventListener('drop', e => {
  e.preventDefault();
  modalDropZone.classList.remove('dragover');
  fileInput.files = e.dataTransfer.files;
  showSelectedFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', e => {
  showSelectedFiles(e.target.files);
});

function showSelectedFiles(files) {
  const list = document.getElementById('filesList');
  list.innerHTML = Array.from(files).map(f => `
    <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--doc-bg); border-radius: var(--radius-md); margin-bottom: 4px;">
      <i class="bi bi-file-earmark" style="color: var(--doc-text-secondary);"></i>
      <span style="flex: 1; font-size: 13px;">${f.name}</span>
      <span style="font-size: 12px; color: var(--doc-text-secondary);">${(f.size / 1024 / 1024).toFixed(2)} MB</span>
    </div>
  `).join('');
}

function handleFiles(files) {
  // Quick upload via drag & drop
  const formData = new FormData();
  Array.from(files).forEach(f => formData.append('files', f));
  formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]')?.value || '');
  
  // Show upload modal with files
  openModal('uploadModal');
  fileInput.files = files;
  showSelectedFiles(files);
}

// Search
const searchInput = document.getElementById('searchInput');
let searchTimeout;
searchInput.addEventListener('input', e => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    const url = new URL(window.location);
    if (e.target.value) {
      url.searchParams.set('q', e.target.value);
    } else {
      url.searchParams.delete('q');
    }
    window.location = url;
  }, 500);
});

// Init
document.addEventListener('DOMContentLoaded', () => {
  const savedView = localStorage.getItem('docView');
  if (savedView) setView(savedView);
  
  // Close modals on backdrop click
  document.querySelectorAll('.doc-modal-backdrop').forEach(modal => {
    modal.addEventListener('click', e => {
      if (e.target === modal) closeModal(modal.id);
    });
  });
  
  // Close sidebar/panel on outside click (mobile)
  document.addEventListener('click', e => {
    if (window.innerWidth < 1024) {
      const sidebar = document.getElementById('docSidebar');
      const panel = document.getElementById('docPanel');
      
      if (!sidebar.contains(e.target) && !e.target.closest('[onclick*="toggleSidebar"]')) {
        sidebar.classList.remove('open');
      }
    }
  });
});
</script>
{% endblock %}
