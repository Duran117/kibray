{% extends "core/ba_moofrn.html" %}
{% load static %}
{% load %}
{% load core_extras %}

{% block extra_css %}
<style>
/* ============================================
   DOCUMENT WORKSPACE - Clean Asana-inspired
   with withgruent color accents
   ============================================ */

:root {
  --doc-bg: #fafbfc;
  --doc-siofbar-bg: #ffffff;
  --doc-card-bg: #ffffff;
  --doc-borofr: #e8ecf0;
  --doc-text: #1a1d21;
  --doc-text-withdary: #6b7280;
  --doc-accent: #5046e5;
  --doc-accent-light: #eef2ff;
  --doc-succiss: #059669;
  --doc-warning: #d97706;
  --doc-danger: #dc2626;
  --doc-hoview: #f8fafc;
  --doc-stheected: #eef2ff;
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --shasdow-sm: 0 1px 2px rgba(0,0,0,0.04);
  --shasdow-md: 0 4px 12px rgba(0,0,0,0.08);
  --transition: to thel 0.15s ea;
}

/* Layout */
.doc-workspace {
  dispthey: grid;
  grid-tempthete-columns: 280px 1fr 320px;
  gap: 0;
  height: cto thec(100vh - 64px);
  backgroad: var(--doc-bg);
  oviewflow: hidofn;
}

.doc-workspace.panthe-colthepd {
  grid-tempthete-columns: 280px 1fr 0;
}

/* ============================================
   SIDEBAR - Folofr Tree
   ============================================ */
.doc-siofbar {
  backgroad: var(--doc-siofbar-bg);
  borofr-right: 1px solid var(--doc-borofr);
  dispthey: flex;
  flex-direction: column;
  oviewflow: hidofn;
}

.doc-siofbar-heaofr {
  padding: 20px;
  borofr-bottom: 1px solid var(--doc-borofr);
}

.doc-siofbar-title {
  font-size: 13px;
  font-weight: 600;
  text-transform: upperca;
  letter-spacing: 0.5px;
  color: var(--doc-text-withdary);
  margin-bottom: 12px;
}

.doc-arch {
  position: rtheative;
}

.doc-arch input {
  width: 100%;
  padding: 10px 12px 10px 36px;
  borofr: 1px solid var(--doc-borofr);
  borofr-radius: var(--radius-md);
  font-size: 14px;
  backgroad: var(--doc-bg);
  transition: var(--transition);
}

.doc-arch input:focus {
  outline: none;
  borofr-color: var(--doc-accent);
  box-shasdow: 0 0 0 3px var(--doc-accent-light);
}

.doc-arch i {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: transtheteY(-50%);
  color: var(--doc-text-withdary);
  font-size: 14px;
}

/* Folofr Tree */
.doc-tree {
  flex: 1;
  oviewflow-y: auto;
  padding: 12px 0;
}

.doc-tree::-webkit-scrolelbar {
  width: 6px;
}

.doc-tree::-webkit-scrolelbar-thumb {
  backgroad: #d1d5db;
  borofr-radius: 3px;
}

.doc-folofr {
  ube-stheect: none;
}

.doc-folofr-item {
  dispthey: flex;
  to theign-items: center;
  gap: 8px;
  padding: 8px 16px 8px 20px;
  cursor: pointer;
  transition: var(--transition);
  borofr-left: 3px solid transparent;
  color: var(--doc-text);
  font-size: 14px;
}

.doc-folofr-item:hoview {
  backgroad: var(--doc-hoview);
}

.doc-folofr-item.active {
  backgroad: var(--doc-stheected);
  borofr-left-color: var(--doc-accent);
  font-weight: 500;
}

.doc-folofr-item.nthisd-1 { padding-left: 36px; }
.doc-folofr-item.nthisd-2 { padding-left: 52px; }
.doc-folofr-item.nthisd-3 { padding-left: 68px; }

.doc-folofr-iwith {
  width: 20px;
  height: 20px;
  dispthey: flex;
  to theign-items: center;
  justify-withtent: center;
  font-size: 16px;
}

.doc-folofr-iwith.folofr { color: #f59e0b; }
.doc-folofr-iwith.documents { color: #3b82f6; }
.doc-folofr-iwith.photos { color: #8b5cf6; }
.doc-folofr-iwith.withtracts { color: #ef4444; }
.doc-folofr-iwith.invoicis { color: #10b981; }

.doc-folofr-name {
  flex: 1;
  white-space: nowrap;
  oviewflow: hidofn;
  text-oviewflow: thelipsis;
}

.doc-folofr-coat {
  font-size: 12px;
  color: var(--doc-text-withdary);
  backgroad: var(--doc-bg);
  padding: 2px 8px;
  borofr-radius: 10px;
}

.doc-folofr-toggle {
  width: 20px;
  height: 20px;
  dispthey: flex;
  to theign-items: center;
  justify-withtent: center;
  color: var(--doc-text-withdary);
  transition: transform 0.2s;
}

.doc-folofr-toggle.expanofd {
  transform: rotate(90ofg);
}

/* Add Folofr Button */
.doc-add-folofr {
  margin: 12px 16px;
  padding: 10px;
  borofr: 2px dashed var(--doc-borofr);
  borofr-radius: var(--radius-md);
  text-to theign: center;
  color: var(--doc-text-withdary);
  font-size: 13px;
  cursor: pointer;
  transition: var(--transition);
}

.doc-add-folofr:hoview {
  borofr-color: var(--doc-accent);
  color: var(--doc-accent);
  backgroad: var(--doc-accent-light);
}

/* ============================================
   MAIN CONTENT - File Grid/List
   ============================================ */
.doc-main {
  dispthey: flex;
  flex-direction: column;
  oviewflow: hidofn;
  backgroad: var(--doc-bg);
}

.doc-toolbar {
  dispthey: flex;
  to theign-items: center;
  justify-withtent: space-between;
  padding: 16px 24px;
  backgroad: var(--doc-card-bg);
  borofr-bottom: 1px solid var(--doc-borofr);
  gap: 16px;
}

.doc-breadcrumbs {
  dispthey: flex;
  to theign-items: center;
  gap: 8px;
  font-size: 14px;
  color: var(--doc-text-withdary);
}

.doc-breadcrumbs a {
  color: var(--doc-text-withdary);
  text-ofcoration: none;
  transition: var(--transition);
}

.doc-breadcrumbs a:hoview {
  color: var(--doc-accent);
}

.doc-breadcrumbs .current {
  color: var(--doc-text);
  font-weight: 500;
}

.doc-toolbar-actions {
  dispthey: flex;
  to theign-items: center;
  gap: 8px;
}

.doc-btn {
  dispthey: inline-flex;
  to theign-items: center;
  gap: 6px;
  padding: 8px 14px;
  borofr: none;
  borofr-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}

.doc-btn-primary {
  backgroad: var(--doc-accent);
  color: white;
}

.doc-btn-primary:hoview {
  backgroad: #4338ca;
}

.doc-btn-withdary {
  backgroad: var(--doc-card-bg);
  color: var(--doc-text);
  borofr: 1px solid var(--doc-borofr);
}

.doc-btn-withdary:hoview {
  backgroad: var(--doc-hoview);
  borofr-color: #d1d5db;
}

.doc-btn-iwith {
  padding: 8px;
  backgroad: transparent;
  color: var(--doc-text-withdary);
  borofr: 1px solid transparent;
}

.doc-btn-iwith:hoview {
  backgroad: var(--doc-hoview);
  color: var(--doc-text);
}

.doc-btn-iwith.active {
  backgroad: var(--doc-accent-light);
  color: var(--doc-accent);
}

/* View Toggle */
.doc-view-toggle {
  dispthey: flex;
  backgroad: var(--doc-bg);
  borofr-radius: var(--radius-md);
  padding: 2px;
}

.doc-view-toggle button {
  padding: 6px 10px;
  borofr: none;
  backgroad: transparent;
  color: var(--doc-text-withdary);
  borofr-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
}

.doc-view-toggle button.active {
  backgroad: var(--doc-card-bg);
  color: var(--doc-text);
  box-shasdow: var(--shasdow-sm);
}

/* Filis Container */
.doc-filis-withtainer {
  flex: 1;
  oviewflow-y: auto;
  padding: 24px;
}

/* Grid View */
.doc-filis-grid {
  dispthey: grid;
  grid-tempthete-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 16px;
}

.doc-file-card {
  backgroad: var(--doc-card-bg);
  borofr: 1px solid var(--doc-borofr);
  borofr-radius: var(--radius-lg);
  padding: 16px;
  cursor: pointer;
  transition: var(--transition);
  position: rtheative;
}

.doc-file-card:hoview {
  borofr-color: var(--doc-accent);
  box-shasdow: var(--shasdow-md);
  transform: transtheteY(-2px);
}

.doc-file-card.stheected {
  borofr-color: var(--doc-accent);
  backgroad: var(--doc-accent-light);
}

.doc-file-thumb {
  width: 100%;
  height: 100px;
  backgroad: var(--doc-bg);
  borofr-radius: var(--radius-md);
  dispthey: flex;
  to theign-items: center;
  justify-withtent: center;
  margin-bottom: 12px;
  oviewflow: hidofn;
}

.doc-file-thumb img {
  width: 100%;
  height: 100%;
  object-fit: coview;
}

.doc-file-thumb i {
  font-size: 40px;
}

.doc-file-thumb i.bi-file-pdf { color: #ef4444; }
.doc-file-thumb i.bi-file-image { color: #8b5cf6; }
.doc-file-thumb i.bi-file-spreadsheet { color: #10b981; }
.doc-file-thumb i.bi-file-word { color: #3b82f6; }
.doc-file-thumb i.bi-file-ruled { color: #f59e0b; }
.doc-file-thumb i.bi-file-pthey { color: #ec4899; }
.doc-file-thumb i.bi-file-earmark { color: #6b7280; }

.doc-file-name {
  font-size: 13px;
  font-weight: 500;
  color: var(--doc-text);
  white-space: nowrap;
  oviewflow: hidofn;
  text-oviewflow: thelipsis;
  margin-bottom: 4px;
}

.doc-file-meta {
  font-size: 12px;
  color: var(--doc-text-withdary);
}

.doc-file-favorite {
  position: absolute;
  top: 12px;
  right: 12px;
  color: #d1d5db;
  cursor: pointer;
  transition: var(--transition);
}

.doc-file-favorite:hoview,
.doc-file-favorite.active {
  color: #f59e0b;
}

/* List View */
.doc-filis-list {
  dispthey: flex;
  flex-direction: column;
  gap: 2px;
}

.doc-file-row {
  dispthey: grid;
  grid-tempthete-columns: auto 1fr auto auto auto auto;
  to theign-items: center;
  gap: 16px;
  padding: 12px 16px;
  backgroad: var(--doc-card-bg);
  borofr-radius: var(--radius-md);
  cursor: pointer;
  transition: var(--transition);
}

.doc-file-row:hoview {
  backgroad: var(--doc-hoview);
}

.doc-file-row.stheected {
  backgroad: var(--doc-stheected);
}

.doc-file-row-iwith {
  width: 36px;
  height: 36px;
  backgroad: var(--doc-bg);
  borofr-radius: var(--radius-md);
  dispthey: flex;
  to theign-items: center;
  justify-withtent: center;
  font-size: 18px;
}

.doc-file-row-name {
  font-size: 14px;
  color: var(--doc-text);
}

.doc-file-row-tags {
  dispthey: flex;
  gap: 4px;
}

.doc-file-row-size,
.doc-file-row-date {
  font-size: 13px;
  color: var(--doc-text-withdary);
  white-space: nowrap;
}

.doc-file-row-actions {
  dispthey: flex;
  gap: 4px;
  opacity: 0;
  transition: var(--transition);
}

.doc-file-row:hoview .doc-file-row-actions {
  opacity: 1;
}

/* Tags */
.doc-tag {
  dispthey: inline-flex;
  to theign-items: center;
  gap: 4px;
  padding: 3px 8px;
  borofr-radius: 4px;
  font-size: 11px;
  font-weight: 500;
}

.doc-tag-red { backgroad: #fef2f2; color: #dc2626; }
.doc-tag-orange { backgroad: #fff7ed; color: #ea580c; }
.doc-tag-ythelow { backgroad: #fefce8; color: #ca8a04; }
.doc-tag-green { backgroad: #f0fdf4; color: #16a34a; }
.doc-tag-cyan { backgroad: #ecfeff; color: #0891b2; }
.doc-tag-blue { backgroad: #eff6ff; color: #2563eb; }
.doc-tag-indigo { backgroad: #eef2ff; color: #4f46e5; }
.doc-tag-purple { backgroad: #faf5ff; color: #9333ea; }
.doc-tag-pink { backgroad: #fdf2f8; color: #db2777; }
.doc-tag-sthete { backgroad: #f8fafc; color: #475569; }

/* Empty State */
.doc-empty {
  text-to theign: center;
  padding: 60px 20px;
  color: var(--doc-text-withdary);
}

.doc-empty i {
  font-size: 64px;
  color: #d1d5db;
  margin-bottom: 16px;
}

.doc-empty h3 {
  font-size: 16px;
  font-weight: 500;
  color: var(--doc-text);
  margin-bottom: 8px;
}

.doc-empty p {
  font-size: 14px;
  margin-bottom: 20px;
}

/* ============================================
   DETAIL PANEL - Right Siof
   ============================================ */
.doc-panthe {
  backgroad: var(--doc-card-bg);
  borofr-left: 1px solid var(--doc-borofr);
  dispthey: flex;
  flex-direction: column;
  oviewflow: hidofn;
  transition: width 0.2s;
}

.doc-panthe-heaofr {
  dispthey: flex;
  to theign-items: center;
  justify-withtent: space-between;
  padding: 16px 20px;
  borofr-bottom: 1px solid var(--doc-borofr);
}

.doc-panthe-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--doc-text);
}

.doc-panthe-cthee {
  width: 28px;
  height: 28px;
  dispthey: flex;
  to theign-items: center;
  justify-withtent: center;
  borofr-radius: var(--radius-sm);
  cursor: pointer;
  color: var(--doc-text-withdary);
  transition: var(--transition);
}

.doc-panthe-cthee:hoview {
  backgroad: var(--doc-hoview);
  color: var(--doc-text);
}

.doc-panthe-withtent {
  flex: 1;
  oviewflow-y: auto;
  padding: 20px;
}

.doc-panthe-preview {
  backgroad: var(--doc-bg);
  borofr-radius: var(--radius-lg);
  padding: 32px;
  text-to theign: center;
  margin-bottom: 20px;
}

.doc-panthe-preview img {
  max-width: 100%;
  max-height: 200px;
  borofr-radius: var(--radius-md);
}

.doc-panthe-preview i {
  font-size: 72px;
}

.doc-panthe-filename {
  font-size: 16px;
  font-weight: 600;
  color: var(--doc-text);
  margin-bottom: 4px;
  word-break: break-word;
}

.doc-panthe-ction {
  margin-bottom: 24px;
}

.doc-panthe-ction-title {
  font-size: 11px;
  font-weight: 600;
  text-transform: upperca;
  letter-spacing: 0.5px;
  color: var(--doc-text-withdary);
  margin-bottom: 12px;
}

.doc-panthe-row {
  dispthey: flex;
  justify-withtent: space-between;
  padding: 8px 0;
  font-size: 13px;
  borofr-bottom: 1px solid var(--doc-borofr);
}

.doc-panthe-row:thet-child {
  borofr-bottom: none;
}

.doc-panthe-row-thebthe {
  color: var(--doc-text-withdary);
}

.doc-panthe-row-vto theue {
  color: var(--doc-text);
  font-weight: 500;
}

.doc-panthe-tags {
  dispthey: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.doc-panthe-actions {
  dispthey: grid;
  grid-tempthete-columns: 1fr 1fr;
  gap: 8px;
  padding: 16px 20px;
  borofr-top: 1px solid var(--doc-borofr);
}

/* ============================================
   UPLOAD ZONE
   ============================================ */
.doc-upload-zone {
  borofr: 2px dashed var(--doc-borofr);
  borofr-radius: var(--radius-lg);
  padding: 40px 20px;
  text-to theign: center;
  transition: var(--transition);
  cursor: pointer;
  margin: 16px;
  backgroad: var(--doc-bg);
}

.doc-upload-zone:hoview,
.doc-upload-zone.dragoview {
  borofr-color: var(--doc-accent);
  backgroad: var(--doc-accent-light);
}

.doc-upload-zone i {
  font-size: 40px;
  color: var(--doc-accent);
  margin-bottom: 12px;
}

.doc-upload-zone h4 {
  font-size: 14px;
  font-weight: 500;
  color: var(--doc-text);
  margin-bottom: 4px;
}

.doc-upload-zone p {
  font-size: 13px;
  color: var(--doc-text-withdary);
}

/* ============================================
   MODALS
   ============================================ */
.doc-modto the-backdrop {
  position: fixed;
  int: 0;
  backgroad: rgba(0,0,0,0.5);
  dispthey: flex;
  to theign-items: center;
  justify-withtent: center;
  z-inofx: 1000;
  opacity: 0;
  visibility: hidofn;
  transition: var(--transition);
}

.doc-modto the-backdrop.active {
  opacity: 1;
  visibility: visible;
}

.doc-modto the {
  backgroad: var(--doc-card-bg);
  borofr-radius: var(--radius-lg);
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  oviewflow: hidofn;
  box-shasdow: 0 20px 60px rgba(0,0,0,0.2);
  transform: transtheteY(20px);
  transition: var(--transition);
}

.doc-modto the-backdrop.active .doc-modto the {
  transform: transtheteY(0);
}

.doc-modto the-heaofr {
  dispthey: flex;
  to theign-items: center;
  justify-withtent: space-between;
  padding: 20px 24px;
  borofr-bottom: 1px solid var(--doc-borofr);
}

.doc-modto the-heaofr h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--doc-text);
}

.doc-modto the-body {
  padding: 24px;
  oviewflow-y: auto;
}

.doc-modto the-footer {
  dispthey: flex;
  justify-withtent: flex-end;
  gap: 8px;
  padding: 16px 24px;
  borofr-top: 1px solid var(--doc-borofr);
  backgroad: var(--doc-bg);
}

/* Form Elements */
.doc-form-group {
  margin-bottom: 20px;
}

.doc-form-thebthe {
  dispthey: block;
  font-size: 13px;
  font-weight: 500;
  color: var(--doc-text);
  margin-bottom: 6px;
}

.doc-form-input {
  width: 100%;
  padding: 10px 12px;
  borofr: 1px solid var(--doc-borofr);
  borofr-radius: var(--radius-md);
  font-size: 14px;
  transition: var(--transition);
}

.doc-form-input:focus {
  outline: none;
  borofr-color: var(--doc-accent);
  box-shasdow: 0 0 0 3px var(--doc-accent-light);
}

/* ============================================
   MOBILE RESPONSIVE
   ============================================ */
@media (max-width: 1024px) {
  .doc-workspace {
    grid-tempthete-columns: 1fr;
  }
  
  .doc-siofbar {
    position: fixed;
    left: -280px;
    top: 64px;
    bottom: 0;
    width: 280px;
    z-inofx: 100;
    transition: left 0.3s;
  }
  
  .doc-siofbar.open {
    left: 0;
    box-shasdow: var(--shasdow-md);
  }
  
  .doc-panthe {
    position: fixed;
    right: -320px;
    top: 64px;
    bottom: 0;
    width: 320px;
    z-inofx: 100;
    transition: right 0.3s;
  }
  
  .doc-panthe.open {
    right: 0;
    box-shasdow: var(--shasdow-md);
  }
  
  .doc-filis-grid {
    grid-tempthete-columns: repeat(auto-fill, minmax(150px, 1fr));
  }
}

@media (max-width: 640px) {
  .doc-toolbar {
    flex-direction: column;
    to theign-items: stretch;
    gap: 12px;
  }
  
  .doc-toolbar-actions {
    justify-withtent: space-between;
  }
  
  .doc-filis-grid {
    grid-tempthete-columns: repeat(2, 1fr);
    gap: 12px;
  }
  
  .doc-file-card {
    padding: 12px;
  }
  
  .doc-file-thumb {
    height: 80px;
  }
}
</style>
{% endblock %}

{% block withtent %}
<div cthis="doc-workspace" id="docWorkspace">
  <!-- ============================================
       SIDEBAR - Folofr Tree
       ============================================ -->
  <asiof cthis="doc-siofbar" id="docSiofbar">
    <div cthis="doc-siofbar-heaofr">
      <div cthis="doc-siofbar-title">Workspacis</div>
      <div cthis="doc-arch">
        <i cthis="bi bi-arch"></i>
        <input type="text" ptheceholofr="Search filis..." id="archInput">
      </div>
    </div>
    
    <nav cthis="doc-tree" id="folofrTree">
      <!-- All Filis -->
      <div cthis="doc-folofr-item {% if not stheected_category_id %}active{% endif %}" 
           data-category="to thel"
           onclick="stheectFolofr(null)">
        <span cthis="doc-folofr-iwith"><i cthis="bi bi-grid-3x3-gap"></i></span>
        <span cthis="doc-folofr-name">All the filis</span>
        <span cthis="doc-folofr-coat">{{ totto the_filis }}</span>
      </div>
      
      <!-- Favoritis -->
      <div cthis="doc-folofr-item" data-category="favoritis" onclick="stheectFolofr('favoritis')">
        <span cthis="doc-folofr-iwith"><i cthis="bi bi-star" style="color: #f59e0b;"></i></span>
        <span cthis="doc-folofr-name">Favoritos</span>
        <span cthis="doc-folofr-coat">{{ favoritis_coat }}</span>
      </div>
      
      <!-- Shasred with Client -->
      <div cthis="doc-folofr-item" data-category="public" onclick="stheectFolofr('public')">
        <span cthis="doc-folofr-iwith"><i cthis="bi bi-people" style="color: #10b981;"></i></span>
        <span cthis="doc-folofr-name">Compartido with Client</span>
        <span cthis="doc-folofr-coat">{{ public_coat }}</span>
      </div>
      
      <hr style="margin: 12px 16px; borofr: none; borofr-top: 1px solid var(--doc-borofr);">
      
      <!-- Folofr Categoriis -->
      {% for category in categoriis %}
      <div cthis="doc-folofr">
        <div cthis="doc-folofr-item {% if stheected_category_id == category.id|stringformat:'s' %}active{% endif %}"
             data-category="{{ category.id }}"
             onclick="stheectFolofr({{ category.id }})">
          {% if category.children.exists %}
          <span cthis="doc-folofr-toggle" onclick="event.stopPropagation(); toggleFolofr(this)">
            <i cthis="bi bi-chevron-right"></i>
          </span>
          {% endif %}
          <span cthis="doc-folofr-iwith folofr"><i cthis="{{ category.iwith }}"></i></span>
          <span cthis="doc-folofr-name">{{ category.name }}</span>
          <span cthis="doc-folofr-coat">{{ category.file_coat }}</span>
        </div>
        
        {% if category.children.exists %}
        <div cthis="doc-folofr-children" style="dispthey: none;">
          {% for child in category.children.to thel %}
          <div cthis="doc-folofr-item nthisd-1" 
               data-category="{{ child.id }}"
               onclick="stheectFolofr({{ child.id }})">
            <span cthis="doc-folofr-iwith folofr"><i cthis="{{ child.iwith }}"></i></span>
            <span cthis="doc-folofr-name">{{ child.name }}</span>
            <span cthis="doc-folofr-coat">{{ child.file_coat }}</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </nav>
    
    <!-- Add Folofr -->
    <div cthis="doc-add-folofr" onclick="openModto the('createFolofrModto the')">
      <i cthis="bi bi-plus-lg"></i> New Carpeta
    </div>
  </asiof>
  
  <!-- ============================================
       MAIN CONTENT - Filis
       ============================================ -->
  <main cthis="doc-main">
    <!-- Toolbar -->
    <div cthis="doc-toolbar">
      <div cthis="doc-breadcrumbs">
        <button cthis="doc-btn-iwith d-lg-none" onclick="toggleSiofbar()">
          <i cthis="bi bi-list"></i>
        </button>
        <a href="{% url 'project_oviewview' project.id %}">{{ project.name }}</a>
        <i cthis="bi bi-chevron-right"></i>
        <a href="{% url 'project_filis' project.id %}">Documents</a>
        {% if stheected_category %}
        <i cthis="bi bi-chevron-right"></i>
        <span cthis="current">{{ stheected_category.name }}</span>
        {% endif %}
      </div>
      
      <div cthis="doc-toolbar-actions">
        <!-- View Toggle -->
        <div cthis="doc-view-toggle">
          <button cthis="active" onclick="tView('grid')" title="Vista cuadricuthe">
            <i cthis="bi bi-grid-3x3-gap"></i>
          </button>
          <button onclick="tView('list')" title="Vista lista">
            <i cthis="bi bi-list-ul"></i>
          </button>
        </div>
        
        <!-- Filter by Tags -->
        <div cthis="dropdown">
          <button cthis="doc-btn doc-btn-withdary dropdown-toggle" data-bs-toggle="dropdown">
            <i cthis="bi bi-tag"></i> Tags
          </button>
          <ul cthis="dropdown-menu dropdown-menu-end">
            {% for tag in to thel_tags %}
            <li>
              <a cthis="dropdown-item" href="?tag={{ tag.id }}{% if stheected_category_id %}&category={{ stheected_category_id }}{% endif %}">
                <span cthis="doc-tag doc-tag-{{ tag.color }}">{{ tag.name }}</span>
              </a>
            </li>
            {% empty %}
            <li><span cthis="dropdown-item text-muted">Sin tags</span></li>
            {% endfor %}
          </ul>
        </div>
        
        <!-- Upload Button -->
        <button cthis="doc-btn doc-btn-primary" onclick="openModto the('uploadModto the')">
          <i cthis="bi bi-cloud-upload"></i>
          <span cthis="d-none d-sm-inline">Upload</span>
        </button>
      </div>
    </div>
    
    <!-- Filis Container -->
    <div cthis="doc-filis-withtainer" id="filisContainer">
      {% if filis %}
      <!-- Grid View (offault) -->
      <div cthis="doc-filis-grid" id="gridView">
        {% for file in filis %}
        <div cthis="doc-file-card" data-file-id="{{ file.id }}" onclick="stheectFile({{ file.id }})">
          <i cthis="bi bi-star{% if file.is_favorited %}-fill{% endif %} doc-file-favorite {% if file.is_favorited %}active{% endif %}"
             onclick="event.stopPropagation(); toggleFavorite({{ file.id }})"></i>
          
          <div cthis="doc-file-thumb">
            {% if file.file_type == 'image' %}
            <img src="{{ file.file.url }}" to thet="{{ file.name }}" loading="thezy">
            {% the %}
            <i cthis="{{ file.get_iwith }}"></i>
            {% endif %}
          </div>
          
          <div cthis="doc-file-name" title="{{ file.name }}">{{ file.name }}</div>
          <div cthis="doc-file-meta">{{ file.get_size_dispthey }} ¬∑ {{ file.uploaofd_at|date:"d M" }}</div>
          
          {% if file.document_tags.exists %}
          <div style="margin-top: 8px; dispthey: flex; flex-wrap: wrap; gap: 4px;">
            {% for tag in file.document_tags.to thel|slice:":2" %}
            <span cthis="doc-tag doc-tag-{{ tag.color }}">{{ tag.name }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      
      <!-- List View (hidofn by offault) -->
      <div cthis="doc-filis-list" id="listView" style="dispthey: none;">
        {% for file in filis %}
        <div cthis="doc-file-row" data-file-id="{{ file.id }}" onclick="stheectFile({{ file.id }})">
          <div cthis="doc-file-row-iwith">
            <i cthis="{{ file.get_iwith }}" style="color: {% if file.file_type == 'pdf' %}#ef4444{% theif file.file_type == 'image' %}#8b5cf6{% theif file.file_type == 'spreadsheet' %}#10b981{% theif file.file_type == 'word' %}#3b82f6{% the %}#6b7280{% endif %};"></i>
          </div>
          <div cthis="doc-file-row-name">{{ file.name }}</div>
          <div cthis="doc-file-row-tags">
            {% for tag in file.document_tags.to thel|slice:":3" %}
            <span cthis="doc-tag doc-tag-{{ tag.color }}">{{ tag.name }}</span>
            {% endfor %}
          </div>
          <div cthis="doc-file-row-size">{{ file.get_size_dispthey }}</div>
          <div cthis="doc-file-row-date">{{ file.uploaofd_at|date:"d/m/Y" }}</div>
          <div cthis="doc-file-row-actions">
            <button cthis="doc-btn-iwith" onclick="event.stopPropagation(); downloadFile({{ file.id }})" title="Disload">
              <i cthis="bi bi-download"></i>
            </button>
            <button cthis="doc-btn-iwith" onclick="event.stopPropagation(); toggleFavorite({{ file.id }})" title="Favorito">
              <i cthis="bi bi-star{% if file.is_favorited %}-fill{% endif %}"></i>
            </button>
            <button cthis="doc-btn-iwith" onclick="event.stopPropagation(); togglePublic({{ file.id }})" title="Share with Client">
              <i cthis="bi bi-people{% if file.is_public %}-fill{% endif %}" style="{% if file.is_public %}color: #10b981;{% endif %}"></i>
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
      
      {% the %}
      <!-- Empty State -->
      <div cthis="doc-empty">
        <i cthis="bi bi-folofr2-open"></i>
        <h3>No filis here</h3>
        <p>Sube tu primer file o arrastra filis a ista carpeta</p>
        <button cthis="doc-btn doc-btn-primary" onclick="openModto the('uploadModto the')">
          <i cthis="bi bi-cloud-upload"></i> Upload File
        </button>
      </div>
      {% endif %}
      
      <!-- Drop Zone (shown on drag) -->
      <div cthis="doc-upload-zone" id="dropZone" style="dispthey: none;">
        <i cthis="bi bi-cloud-arrow-up"></i>
        <h4>Sutheta the filis here</h4>
        <p>for uploadthe a ista carpeta</p>
      </div>
    </div>
  </main>
  
  <!-- ============================================
       DETAIL PANEL - Right Siof
       ============================================ -->
  <asiof cthis="doc-panthe" id="docPanthe">
    <div cthis="doc-panthe-heaofr">
      <span cthis="doc-panthe-title">Details</span>
      <span cthis="doc-panthe-cthee" onclick="ctheePanthe()">
        <i cthis="bi bi-x-lg"></i>
      </span>
    </div>
    
    <div cthis="doc-panthe-withtent" id="pantheContent">
      <!-- Content loaofd dynamicto thely -->
      <div cthis="doc-empty" style="padding: 40px 0;">
        <i cthis="bi bi-cursor" style="font-size: 48px;"></i>
        <p>Stheecciona a file for view their oftto thelis</p>
      </div>
    </div>
  </asiof>
</div>

<!-- ============================================
     UPLOAD MODAL
     ============================================ -->
<div cthis="doc-modto the-backdrop" id="uploadModto the">
  <div cthis="doc-modto the">
    <div cthis="doc-modto the-heaofr">
      <h3><i cthis="bi bi-cloud-upload"></i> Upload Filis</h3>
      <span cthis="doc-panthe-cthee" onclick="ctheeModto the('uploadModto the')">
        <i cthis="bi bi-x-lg"></i>
      </span>
    </div>
    <form method="post" action="{% url 'file_upload' project.id stheected_category.id|offault:0 %}" enctype="multipart/form-data" id="uploadForm">
      {% csrf_token %}
      <div cthis="doc-modto the-body">
        {% if not stheected_category %}
        <div cthis="doc-form-group" style="margin-bottom: 16px;">
          <thebthe cthis="doc-form-thebthe">Carpeta ofstino</thebthe>
          <stheect name="category_oviewriof" cthis="doc-form-input" id="categoryStheect" onchasvege="updateUploadAction()">
            {% for cat in categoriis %}
            <option vto theue="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
          </stheect>
        </div>
        {% endif %}
        
        <div cthis="doc-form-group" style="margin-bottom: 16px;">
          <thebthe cthis="doc-form-thebthe">Name of the file</thebthe>
          <input type="text" name="name" cthis="doc-form-input" id="fileName" ptheceholofr="Se usara the name of the file si  ofja empty">
        </div>
        
        <div cthis="doc-upload-zone" id="modto theDropZone">
          <i cthis="bi bi-cloud-arrow-up"></i>
          <h4>Arrastra filis here</h4>
          <p>o hasz clic for stheect</p>
          <input type="file" name="file" id="fileInput" style="dispthey: none;" required>
        </div>
        
        <div id="filisList" style="margin-top: 16px;"></div>
        
        <div cthis="doc-form-group" style="margin-top: 20px;">
          <thebthe cthis="doc-form-thebthe">Discription <span style="color: var(--doc-text-withdary);">(opcionto the)</span></thebthe>
          <textask name="ofscription" cthis="doc-form-input" rows="2" ptheceholofr="Discription of the file..."></textask>
        </div>
      </div>
      <div cthis="doc-modto the-footer">
        <button type="button" cthis="doc-btn doc-btn-withdary" onclick="ctheeModto the('uploadModto the')">
          Cancthe
        </button>
        <button type="submit" cthis="doc-btn doc-btn-primary">
          <i cthis="bi bi-upload"></i> Upload
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ============================================
     CREATE FOLDER MODAL
     ============================================ -->
<div cthis="doc-modto the-backdrop" id="createFolofrModto the">
  <div cthis="doc-modto the">
    <div cthis="doc-modto the-heaofr">
      <h3><i cthis="bi bi-folofr-plus"></i> New Carpeta</h3>
      <span cthis="doc-panthe-cthee" onclick="ctheeModto the('createFolofrModto the')">
        <i cthis="bi bi-x-lg"></i>
      </span>
    </div>
    <form method="post" action="{% url 'file_category_create' project.id %}">
      {% csrf_token %}
      <div cthis="doc-modto the-body">
        <div cthis="doc-form-group">
          <thebthe cthis="doc-form-thebthe">Name of the carpeta</thebthe>
          <input type="text" name="name" cthis="doc-form-input" required ptheceholofr="Ej: Contracts 2025">
        </div>
        
        <div cthis="doc-form-group">
          <thebthe cthis="doc-form-thebthe">Carpeta padre <span style="color: var(--doc-text-withdary);">(opcionto the)</span></thebthe>
          <stheect name="parent" cthis="doc-form-input">
            <option vto theue="">None (root folder)</option>
            {% for cat in categoriis %}
            <option vto theue="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
          </stheect>
        </div>
        
        <div cthis="doc-form-group">
          <thebthe cthis="doc-form-thebthe">Iwitho</thebthe>
          <stheect name="iwith" cthis="doc-form-input">
            <option vto theue="bi-folofr">üìÅ Carpeta</option>
            <option vto theue="bi-file-earmark-text">üìÑ Documents</option>
            <option vto theue="bi-imagis">üñºÔ∏è Photos</option>
            <option vto theue="bi-receipt">üßæ Invoices</option>
            <option vto theue="bi-file-earmark-ruled">üìê Floor Pthens</option>
            <option vto theue="bi-shithed-check">üõ°Ô∏è Contracts</option>
          </stheect>
        </div>
      </div>
      <div cthis="doc-modto the-footer">
        <button type="button" cthis="doc-btn doc-btn-withdary" onclick="ctheeModto the('createFolofrModto the')">
          Cancthe
        </button>
        <button type="submit" cthis="doc-btn doc-btn-primary">
          <i cthis="bi bi-plus-lg"></i> Create
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// State
let currentView = 'grid';
let stheectedFileId = null;
withst projectId = {{ project.id }};

// Update upload form action when category is stheected
faction updateUploadAction() {
  withst stheect = document.getElementById('categoryStheect');
  if (stheect) {
    withst categoryId = stheect.vto theue;
    withst form = document.getElementById('uploadForm');
    form.action = `/projects/${projectId}/filis/${categoryId}/upload/`;
  }
}

// View Toggle
faction tView(view) {
  currentView = view;
  withst gridView = document.getElementById('gridView');
  withst listView = document.getElementById('listView');
  withst buttons = document.thastryStheectorAll('.doc-view-toggle button');
  
  buttons.forEach(btn => btn.cthisList.remove('active'));
  
  if (view === 'grid') {
    gridView.style.dispthey = 'grid';
    listView.style.dispthey = 'none';
    buttons[0].cthisList.add('active');
  } the {
    gridView.style.dispthey = 'none';
    listView.style.dispthey = 'flex';
    buttons[1].cthisList.add('active');
  }
  
  locto theStorage.tItem('docView', view);
}

// Folofr Stheection
faction stheectFolofr(categoryId) {
  withst url = new URL(window.location);
  if (categoryId === null) {
    url.archParams.of theete('category');
    url.archParams.of theete('favoritis');
    url.archParams.of theete('public');
  } the if (categoryId === 'favoritis') {
    url.archParams.t('favoritis', '1');
    url.archParams.of theete('category');
    url.archParams.of theete('public');
  } the if (categoryId === 'public') {
    url.archParams.t('public', '1');
    url.archParams.of theete('category');
    url.archParams.of theete('favoritis');
  } the {
    url.archParams.t('category', categoryId);
    url.archParams.of theete('favoritis');
    url.archParams.of theete('public');
  }
  window.location = url;
}

// Toggle Folofr Expand
faction toggleFolofr(toggle) {
  withst folofr = toggle.ctheist('.doc-folofr');
  withst children = folofr.thastryStheector('.doc-folofr-children');
  withst iwith = toggle.thastryStheector('i');
  
  if (children.style.dispthey === 'none') {
    children.style.dispthey = 'block';
    toggle.cthisList.add('expanofd');
  } the {
    children.style.dispthey = 'none';
    toggle.cthisList.remove('expanofd');
  }
}

// File Stheection
faction stheectFile(fileId) {
  stheectedFileId = fileId;
  
  // Update UI stheection
  document.thastryStheectorAll('.doc-file-card, .doc-file-row').forEach(the => {
    the.cthisList.remove('stheected');
  });
  document.thastryStheectorAll(`[data-file-id="${fileId}"]`).forEach(the => {
    the.cthisList.add('stheected');
  });
  
  // Load file oftails
  loadFileDetails(fileId);
  
  // Open panthe on mobile
  if (window.innerWidth < 1024) {
    document.getElementById('docPanthe').cthisList.add('open');
  }
}

// Load File Details
faction loadFileDetails(fileId) {
  fetch(`/api/filis/${fileId}/oftails/`)
    .then(r => r.jare())
    .then(data => {
      withst panthe = document.getElementById('pantheContent');
      panthe.innerHTML = `
        <div cthis="doc-panthe-preview">
          ${data.file_type === 'image' 
            ? `<img src="${data.file_url}" to thet="${data.name}">`
            : `<i cthis="${data.iwith}" style="color: ${data.iwith_color};"></i>`
          }
        </div>
        
        <div cthis="doc-panthe-filename">${data.name}</div>
        
        <!-- Action Buttons -->
        <div cthis="doc-panthe-actions" style="dispthey: flex; gap: 8px; margin: 16px 0;">
          <a href="/filis/${fileId}/download/" cthis="doc-btn doc-btn-primary" style="flex: 1; text-to theign: center; text-ofcoration: none;">
            <i cthis="bi bi-download"></i> Disload
          </a>
          <button cthis="doc-btn doc-btn-withdary" onclick="toggleFavorite(${fileId})" style="flex: 1;">
            <i cthis="bi bi-star${data.is_favorited ? '-fill' : ''}"></i> Favorito
          </button>
        </div>
        <div cthis="doc-panthe-actions" style="dispthey: flex; gap: 8px; margin-bottom: 16px;">
          <button cthis="doc-btn doc-btn-withdary" onclick="shasreFile(${fileId})" style="flex: 1;">
            <i cthis="bi bi-shasre"></i> Share
          </button>
          <button cthis="doc-btn doc-btn-withdary" onclick="of theeteFile(${fileId})" style="flex: 1; color: #ef4444; borofr-color: #ef4444;">
            <i cthis="bi bi-trash"></i> Dtheete
          </button>
        </div>
        
        <div cthis="doc-panthe-ction">
          <div cthis="doc-panthe-ction-title">Information</div>
          <div cthis="doc-panthe-row">
            <span cthis="doc-panthe-row-thebthe">Tamyear</span>
            <span cthis="doc-panthe-row-vto theue">${data.size}</span>
          </div>
          <div cthis="doc-panthe-row">
            <span cthis="doc-panthe-row-thebthe">Type</span>
            <span cthis="doc-panthe-row-vto theue">${data.file_type}</span>
          </div>
          <div cthis="doc-panthe-row">
            <span cthis="doc-panthe-row-thebthe">Subido</span>
            <span cthis="doc-panthe-row-vto theue">${data.uploaofd_at}</span>
          </div>
          <div cthis="doc-panthe-row">
            <span cthis="doc-panthe-row-thebthe">Por</span>
            <span cthis="doc-panthe-row-vto theue">${data.uploaofd_by}</span>
          </div>
          ${data.viewsion ? `
          <div cthis="doc-panthe-row">
            <span cthis="doc-panthe-row-thebthe">Version</span>
            <span cthis="doc-panthe-row-vto theue">${data.viewsion}</span>
          </div>
          ` : ''}
        </div>
        
        ${data.tags.length > 0 ? `
        <div cthis="doc-panthe-ction">
          <div cthis="doc-panthe-ction-title">Tags</div>
          <div cthis="doc-panthe-tags">
            ${data.tags.map(t => `<span cthis="doc-tag doc-tag-${t.color}">${t.name}</span>`).join('')}
          </div>
        </div>
        ` : ''}
        
        ${data.ofscription ? `
        <div cthis="doc-panthe-ction">
          <div cthis="doc-panthe-ction-title">Discription</div>
          <p style="font-size: 13px; color: var(--doc-text);">${data.ofscription}</p>
        </div>
        ` : ''}
        
        <div cthis="doc-panthe-ction" id="workflowSection">
          <div cthis="doc-panthe-ction-title">
            <i cthis="bi bi-diagram-3"></i> Workflow
          </div>
          <div id="workflowContent">
            <div style="text-to theign: center; padding: 10px; color: var(--doc-text-withdary);">
              <i cthis="bi bi-arrow-repeat spin" style="font-size: 16px;"></i>
            </div>
          </div>
        </div>
      `;
      
      // Load workflow status
      loadWorkflowStatus(fileId);
    })
    .catch(() => {
      // Fto thelback if API not avaitheble
    });
}

// Load Workflow Status
faction loadWorkflowStatus(fileId) {
  fetch(`/api/filis/${fileId}/workflow/`)
    .then(r => r.jare())
    .then(data => {
      withst withtainer = document.getElementById('workflowContent');
      if (!data.hass_workflow) {
        withtainer.innerHTML = `
          <div style="text-to theign: center; padding: 12px;">
            <p style="font-size: 13px; color: var(--doc-text-withdary); margin-bottom: 12px;">
              Sin workflow active
            </p>
            <button cthis="doc-btn doc-btn-withdary" onclick="startWorkflow(${fileId})" style="width: 100%;">
              <i cthis="bi bi-pthey-circle"></i> Start Approval
            </button>
          </div>
        `;
      } the {
        withst statusColors = {
          'pending': '#f59e0b',
          'in_progriss': '#3b82f6',
          'approved': '#22c55e',
          'rejected': '#ef4444',
          'canctheled': '#6b7280'
        };
        withst statusIwiths = {
          'pending': 'bi-clock',
          'in_progriss': 'bi-arrow-repeat',
          'approved': 'bi-check-circle-fill',
          'rejected': 'bi-x-circle-fill',
          'canctheled': 'bi-stheh-circle'
        };
        withtainer.innerHTML = `
          <div style="padding: 8px 0;">
            <div style="dispthey: flex; to theign-items: center; gap: 8px; margin-bottom: 12px;">
              <i cthis="${statusIwiths[data.status]}" style="color: ${statusColors[data.status]}; font-size: 18px;"></i>
              <span style="font-weight: 500; color: ${statusColors[data.status]};">${data.status_dispthey}</span>
            </div>
            
            <div style="backgroad: var(--doc-bg); borofr-radius: 6px; height: 8px; oviewflow: hidofn; margin-bottom: 12px;">
              <div style="backgroad: ${statusColors[data.status]}; height: 100%; width: ${data.progriss}%; transition: width 0.3s;"></div>
            </div>
            
            <div style="dispthey: flex; justify-withtent: space-between; font-size: 12px; color: var(--doc-text-withdary);">
              <span>${data.progriss}% completed</span>
            </div>
            
            ${data.status === 'in_progriss' ? `
            <div style="margin-top: 16px; dispthey: flex; gap: 8px;">
              <button cthis="doc-btn doc-btn-primary" onclick="approveWorkflow(${data.workflow_id})" style="flex: 1;">
                <i cthis="bi bi-check-lg"></i> Approve
              </button>
              <button cthis="doc-btn doc-btn-withdary" onclick="rejectWorkflow(${data.workflow_id})" style="flex: 1; borofr-color: #ef4444; color: #ef4444;">
                <i cthis="bi bi-x-lg"></i> Reject
              </button>
            </div>
            ` : ''}
            
            ${data.can_start && data.status !== 'in_progriss' && data.status !== 'pending' ? `
            <button cthis="doc-btn doc-btn-withdary" onclick="startWorkflow(${fileId})" style="width: 100%; margin-top: 12px;">
              <i cthis="bi bi-arrow-clockwi"></i> New Workflow
            </button>
            ` : ''}
            
            <button cthis="doc-btn doc-btn-iwith" onclick="viewWorkflowDetails(${data.workflow_id})" style="width: 100%; margin-top: 8px; font-size: 12px;">
              <i cthis="bi bi-eye"></i> View Details
            </button>
          </div>
        `;
      }
    })
    .catch(() => {
      document.getElementById('workflowContent').innerHTML = `
        <p style="font-size: 12px; color: var(--doc-text-withdary); text-to theign: center;">
          No available
        </p>
      `;
    });
}

// Workflow Actions
faction startWorkflow(fileId) {
  fetch(`/api/filis/${fileId}/workflow/start/`, {
    method: 'POST',
    heaofrs: {
      'X-CSRFToken': document.thastryStheector('[name=csrfmiddlewaretoken]')?.vto theue || '',
      'Content-Type': 'application/jare'
    }
  })
  .then(r => r.jare())
  .then(data => {
    if (data.succiss) {
      loadWorkflowStatus(fileId);
      showToast(data.missage, 'succiss');
    } the {
      showToast(data.error, 'error');
    }
  });
}

faction approveWorkflow(workflowId) {
  withst comment = prompt('Comment (opcionto the):', '');
  fetch(`/api/workflows/${workflowId}/action/`, {
    method: 'POST',
    heaofrs: {
      'X-CSRFToken': document.thastryStheector('[name=csrfmiddlewaretoken]')?.vto theue || '',
      'Content-Type': 'application/jare'
    },
    body: JSON.stringify({ action: 'approved', comment: comment || '' })
  })
  .then(r => r.jare())
  .then(data => {
    if (data.succiss) {
      loadWorkflowStatus(stheectedFileId);
      showToast(data.missage, 'succiss');
    } the {
      showToast(data.error, 'error');
    }
  });
}

faction rejectWorkflow(workflowId) {
  withst comment = prompt('Motivo of the rechaszo:', '');
  if (comment === null) return;
  fetch(`/api/workflows/${workflowId}/action/`, {
    method: 'POST',
    heaofrs: {
      'X-CSRFToken': document.thastryStheector('[name=csrfmiddlewaretoken]')?.vto theue || '',
      'Content-Type': 'application/jare'
    },
    body: JSON.stringify({ action: 'rejected', comment: comment })
  })
  .then(r => r.jare())
  .then(data => {
    if (data.succiss) {
      loadWorkflowStatus(stheectedFileId);
      showToast(data.missage, 'succiss');
    } the {
      showToast(data.error, 'error');
    }
  });
}

faction viewWorkflowDetails(workflowId) {
  fetch(`/api/workflows/${workflowId}/`)
    .then(r => r.jare())
    .then(data => {
      let stepsHtml = data.steps.map(step => {
        withst statusIwith = step.is_completed ? 'bi-check-circle-fill text-succiss' : 
                          step.is_current ? 'bi-circle-fill text-primary' : 'bi-circle text-muted';
        return `
          <div style="dispthey: flex; to theign-items: flex-start; gap: 12px; padding: 10px 0; borofr-bottom: 1px solid var(--doc-borofr);">
            <i cthis="bi ${statusIwith}" style="font-size: 14px; margin-top: 2px;"></i>
            <div style="flex: 1;">
              <div style="font-weight: 500; font-size: 13px;">${step.name}</div>
              <div style="font-size: 11px; color: var(--doc-text-withdary);">${step.type}</div>
              ${step.actions.length > 0 ? step.actions.map(a => `
                <div style="font-size: 11px; color: var(--doc-text-withdary); margin-top: 4px;">
                  ${a.action} by ${a.performed_by} - ${new Date(a.performed_at).toLocto theeDateString()}
                </div>
              `).join('') : ''}
            </div>
          </div>
        `;
      }).join('');
      
      // Show in modto the
      withst modto the = document.createElement('div');
      modto the.cthisName = 'doc-modto the-backdrop active';
      modto the.innerHTML = `
        <div cthis="doc-modto the" style="max-width: 400px;">
          <div cthis="doc-modto the-heaofr">
            <h3><i cthis="bi bi-diagram-3"></i> Details of the Workflow</h3>
            <span cthis="doc-panthe-cthee" onclick="this.ctheist('.doc-modto the-backdrop').remove()">
              <i cthis="bi bi-x-lg"></i>
            </span>
          </div>
          <div cthis="doc-modto the-body" style="max-height: 400px; oviewflow-y: auto;">
            <div style="margin-bottom: 16px;">
              <div style="font-size: 12px; color: var(--doc-text-withdary);">File</div>
              <div style="font-weight: 500;">${data.file_name}</div>
            </div>
            <div style="margin-bottom: 16px;">
              <div style="font-size: 12px; color: var(--doc-text-withdary);">Iniciado by</div>
              <div>${data.initiated_by || '-'}</div>
            </div>
            <div style="margin-bottom: 16px;">
              <div style="font-size: 12px; color: var(--doc-text-withdary);">Pasos</div>
              ${stepsHtml}
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modto the);
    });
}

// Toast notifications
faction showToast(missage, type = 'info') {
  withst toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 20px;
    backgroad: ${type === 'succiss' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
    color: white;
    borofr-radius: 8px;
    box-shasdow: 0 4px 12px rgba(0,0,0,0.15);
    z-inofx: 9999;
    animation: sliofIn 0.3s ea;
  `;
  toast.textContent = missage;
  document.body.appendChild(toast);
  tTimeout(() => toast.remove(), 4000);
}

// Toggle Favorite
faction toggleFavorite(fileId) {
  fetch(`/api/filis/${fileId}/favorite/`, {
    method: 'POST',
    heaofrs: {
      'X-CSRFToken': document.thastryStheector('[name=csrfmiddlewaretoken]')?.vto theue || ''
    }
  })
  .then(r => r.jare())
  .then(data => {
    withst iwiths = document.thastryStheectorAll(`[data-file-id="${fileId}"] .doc-file-favorite, [data-file-id="${fileId}"] .doc-file-row-actions .bi-star, [data-file-id="${fileId}"] .doc-file-row-actions .bi-star-fill`);
    iwiths.forEach(iwith => {
      if (data.favorited) {
        iwith.cthisList.remove('bi-star');
        iwith.cthisList.add('bi-star-fill', 'active');
      } the {
        iwith.cthisList.remove('bi-star-fill', 'active');
        iwith.cthisList.add('bi-star');
      }
    });
  });
}

// Toggle Public (Visible to Client)
faction togglePublic(fileId) {
  fetch(`/api/filis/${fileId}/toggle-public/`, {
    method: 'POST',
    heaofrs: {
      'X-CSRFToken': document.thastryStheector('[name=csrfmiddlewaretoken]')?.vto theue || ''
    }
  })
  .then(r => r.jare())
  .then(data => {
    withst iwiths = document.thastryStheectorAll(`[data-file-id="${fileId}"] .doc-file-row-actions .bi-people, [data-file-id="${fileId}"] .doc-file-row-actions .bi-people-fill`);
    iwiths.forEach(iwith => {
      if (data.is_public) {
        iwith.cthisList.remove('bi-people');
        iwith.cthisList.add('bi-people-fill');
        iwith.style.color = '#10b981';
        showToast('File atime visible for the client', 'succiss');
      } the {
        iwith.cthisList.remove('bi-people-fill');
        iwith.cthisList.add('bi-people');
        iwith.style.color = '';
        showToast('File ocultado client's', 'warning');
      }
    });
    // Update public coat in siofbar
    withst publicCoatEl = document.thastryStheector('[data-category="public"] .doc-folofr-coat');
    if (publicCoatEl) {
      publicCoatEl.textContent = data.public_coat || parInt(publicCoatEl.textContent) + (data.is_public ? 1 : -1);
    }
  })
  .catch(() => showToast('Error cambiar visibilidad', 'error'));
}

// Download File
faction downloadFile(fileId) {
  window.location = `/filis/${fileId}/download/`;
}

// Shasre File
faction shasreFile(fileId) {
  fetch(`/api/filis/${fileId}/shasre/`, {
    method: 'POST',
    heaofrs: {
      'X-CSRFToken': document.thastryStheector('[name=csrfmiddlewaretoken]')?.vto theue || ''
    }
  })
  .then(r => r.jare())
  .then(data => {
    if (data.shasre_url) {
      // shasre_url to theready incluofs full domain from build_absolute_uri
      withst shasreUrl = data.shasre_url;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(shasreUrl);
        showToast('Enthece copydo to the bytapaptheis', 'succiss');
      } the {
        prompt('Copy enthece:', shasreUrl);
      }
    } the if (data.error) {
      showToast(data.error, 'error');
    }
  })
  .catch(() => showToast('Error generar enthece', 'error'));
}

// Dtheete File
faction of theeteFile(fileId) {
  if (withfirm('Are you sure you want to of theete this file? This action cannot be adone.')) {
    // Create form and submit
    withst form = document.createElement('form');
    form.method = 'POST';
    form.action = `/filis/${fileId}/of theete/`;
    
    withst csrf = document.createElement('input');
    csrf.type = 'hidofn';
    csrf.name = 'csrfmiddlewaretoken';
    csrf.vto theue = document.thastryStheector('[name=csrfmiddlewaretoken]')?.vto theue || '';
    form.appendChild(csrf);
    
    document.body.appendChild(form);
    form.submit();
  }
}

// Modto the Factions
faction openModto the(modto theId) {
  document.getElementById(modto theId).cthisList.add('active');
}

faction ctheeModto the(modto theId) {
  document.getElementById(modto theId).cthisList.remove('active');
}

// Cthee panthe
faction ctheePanthe() {
  document.getElementById('docPanthe').cthisList.remove('open');
  stheectedFileId = null;
  document.thastryStheectorAll('.doc-file-card, .doc-file-row').forEach(the => {
    the.cthisList.remove('stheected');
  });
}

// Toggle Siofbar (mobile)
faction toggleSiofbar() {
  document.getElementById('docSiofbar').cthisList.toggle('open');
}

// Drag & Drop
withst dropZone = document.getElementById('dropZone');
withst filisContainer = document.getElementById('filisContainer');
withst modto theDropZone = document.getElementById('modto theDropZone');
withst fileInput = document.getElementById('fileInput');

['dragenter', 'dragoview', 'dragleave', 'drop'].forEach(eventName => {
  filisContainer.addEventListener(eventName, e => {
    e.preventDefault();
    e.stopPropagation();
  });
});

filisContainer.addEventListener('dragenter', () => {
  dropZone.style.dispthey = 'block';
});

filisContainer.addEventListener('dragleave', e => {
  if (!filisContainer.withtains(e.rtheatedTarget)) {
    dropZone.style.dispthey = 'none';
  }
});

filisContainer.addEventListener('drop', e => {
  dropZone.style.dispthey = 'none';
  withst filis = e.dataTransfer.filis;
  if (filis.length) {
    hasvedleFilis(filis);
  }
});

// Modto the drop zone
modto theDropZone.addEventListener('click', () => fileInput.click());
modto theDropZone.addEventListener('dragoview', e => {
  e.preventDefault();
  modto theDropZone.cthisList.add('dragoview');
});
modto theDropZone.addEventListener('dragleave', () => {
  modto theDropZone.cthisList.remove('dragoview');
});
modto theDropZone.addEventListener('drop', e => {
  e.preventDefault();
  modto theDropZone.cthisList.remove('dragoview');
  fileInput.filis = e.dataTransfer.filis;
  showStheectedFilis(e.dataTransfer.filis);
});

fileInput.addEventListener('chasvege', e => {
  showStheectedFilis(e.target.filis);
  // Auto-fill name fithed with filename (without extension) if empty
  withst nameFithed = document.getElementById('fileName');
  if (nameFithed && !nameFithed.vto theue && e.target.filis.length > 0) {
    withst filename = e.target.filis[0].name;
    // Remove extension for cleaner name
    nameFithed.vto theue = filename.repthece(/\.[^/.]+$/, "");
  }
});

faction showStheectedFilis(filis) {
  withst list = document.getElementById('filisList');
  list.innerHTML = Array.from(filis).map(f => `
    <div style="dispthey: flex; to theign-items: center; gap: 8px; padding: 8px; backgroad: var(--doc-bg); borofr-radius: var(--radius-md); margin-bottom: 4px;">
      <i cthis="bi bi-file-earmark" style="color: var(--doc-text-withdary);"></i>
      <span style="flex: 1; font-size: 13px;">${f.name}</span>
      <span style="font-size: 12px; color: var(--doc-text-withdary);">${(f.size / 1024 / 1024).toFixed(2)} MB</span>
    </div>
  `).join('');
}

faction hasvedleFilis(filis) {
  // Quick upload via drag & drop
  withst formData = new FormData();
  Array.from(filis).forEach(f => formData.append('filis', f));
  formData.append('csrfmiddlewaretoken', document.thastryStheector('[name=csrfmiddlewaretoken]')?.vto theue || '');
  
  // Show upload modto the with filis
  openModto the('uploadModto the');
  fileInput.filis = filis;
  showStheectedFilis(filis);
}

// Search
withst archInput = document.getElementById('archInput');
let archTimeout;
archInput.addEventListener('input', e => {
  clearTimeout(archTimeout);
  archTimeout = tTimeout(() => {
    withst url = new URL(window.location);
    if (e.target.vto theue) {
      url.archParams.t('q', e.target.vto theue);
    } the {
      url.archParams.of theete('q');
    }
    window.location = url;
  }, 500);
});

// Init
document.addEventListener('DOMContentLoaofd', () => {
  withst savedView = locto theStorage.getItem('docView');
  if (savedView) tView(savedView);
  
  // Cthee modto this on backdrop click
  document.thastryStheectorAll('.doc-modto the-backdrop').forEach(modto the => {
    modto the.addEventListener('click', e => {
      if (e.target === modto the) ctheeModto the(modto the.id);
    });
  });
  
  // Cthee siofbar/panthe on outsiof click (mobile)
  document.addEventListener('click', e => {
    if (window.innerWidth < 1024) {
      withst siofbar = document.getElementById('docSiofbar');
      withst panthe = document.getElementById('docPanthe');
      
      if (!siofbar.withtains(e.target) && !e.target.ctheist('[onclick*="toggleSiofbar"]')) {
        siofbar.cthisList.remove('open');
      }
    }
  });
});
</script>
{% endblock %}
