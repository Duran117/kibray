{% extends "core/base.html" %}

{% block extra_css %}
<style>
    /* ===== MOBILE-FIRST MATERIALS REQUEST ===== */
    .materials-container {
        padding: 12px;
        background: #f8f9fa;
        min-height: 100vh;
    }
    
    @media (min-width: 768px) {
        .materials-container {
            padding: 24px;
        }
    }
    
    /* ===== HEADER ===== */
    .materials-header {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 20px 16px;
        border-radius: 12px 12px 0 0;
        margin-bottom: 0;
    }
    
    .materials-header h1 {
        font-size: 20px;
        margin: 0 0 4px 0;
        font-weight: 700;
    }
    
    .materials-header .project {
        font-size: 14px;
        opacity: 0.9;
    }
    
    /* ===== FORM CARD ===== */
    .materials-form {
        background: white;
        border-radius: 0 0 12px 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* ===== SECTION HEADERS ===== */
    .section-divider {
        border-top: 2px solid #e5e7eb;
        margin: 24px 0 16px 0;
        position: relative;
    }
    
    .section-title {
        position: absolute;
        top: -12px;
        left: 0;
        background: white;
        padding: 0 12px 0 0;
        font-size: 14px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* ===== FORM INPUTS (LARGE FOR MOBILE) ===== */
    .materials-form label {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
    }
    
    .materials-form select,
    .materials-form input,
    .materials-form textarea {
        height: 48px;
        font-size: 16px; /* Prevent iOS zoom */
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        transition: border-color 0.2s;
    }
    
    .materials-form textarea {
        height: 100px;
        resize: vertical;
    }
    
    .materials-form select:focus,
    .materials-form input:focus,
    .materials-form textarea:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* ===== QUICK SELECT BUTTONS ===== */
    .quick-selects {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 20px;
    }
    
    .quick-select-btn {
        background: #f3f4f6;
        border: 2px solid #e5e7eb;
        padding: 12px;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .quick-select-btn:hover,
    .quick-select-btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }
    
    .quick-select-btn i {
        font-size: 24px;
        display: block;
        margin-bottom: 4px;
    }
    
    .quick-select-btn span {
        font-size: 12px;
        font-weight: 500;
    }
    
    /* ===== PHOTO UPLOAD (PROMINENT) ===== */
    .photo-upload {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.2s;
        margin-bottom: 20px;
    }
    
    .photo-upload:active {
        transform: scale(0.98);
    }
    
    .photo-upload i {
        font-size: 48px;
        margin-bottom: 8px;
    }
    
    .photo-upload p {
        margin: 0;
        font-size: 16px;
        font-weight: 500;
    }
    
    .photo-upload small {
        opacity: 0.9;
    }
    
    .photo-preview {
        position: relative;
        margin-top: 12px;
    }
    
    .photo-preview img {
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .photo-preview .remove-photo {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #ef4444;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        font-size: 18px;
        line-height: 1;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    /* ===== QUANTITY INPUT (LARGE NUMBERS) ===== */
    .quantity-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .quantity-group input {
        flex: 1;
        font-size: 24px;
        font-weight: 700;
        text-align: center;
        color: #1f2937;
    }
    
    .quantity-group select {
        flex: 0 0 120px;
    }
    
    .quantity-btn {
        background: #3b82f6;
        color: white;
        border: none;
        width: 48px;
        height: 48px;
        border-radius: 8px;
        font-size: 24px;
        line-height: 1;
        flex-shrink: 0;
    }
    
    /* ===== SUBMIT BUTTON (PROMINENT) ===== */
    .submit-section {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 16px;
        border-top: 2px solid #e5e7eb;
        margin: 0 -20px -20px -20px;
        border-radius: 0 0 12px 12px;
    }
    
    .submit-btn {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        height: 56px;
        font-size: 18px;
        font-weight: 600;
        border-radius: 12px;
        width: 100%;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        transition: transform 0.2s;
    }
    
    .submit-btn:active {
        transform: scale(0.98);
    }
    
    .cancel-btn {
        background: transparent;
        color: #6b7280;
        border: 2px solid #e5e7eb;
        height: 48px;
        font-size: 16px;
        border-radius: 8px;
        width: 100%;
        margin-top: 8px;
    }
    
    /* ===== COLLAPSIBLE SECTIONS (ADVANCED) ===== */
    .advanced-section {
        background: #f9fafb;
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }
    
    .collapse-trigger {
        background: none;
        border: none;
        width: 100%;
        text-align: left;
        padding: 12px 0;
        font-weight: 600;
        color: #1f2937;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }
    
    .collapse-trigger i {
        transition: transform 0.2s;
    }
    
    .collapse-trigger[aria-expanded="true"] i {
        transform: rotate(180deg);
    }
    
    /* ===== FORM TEXT (SMALLER) ===== */
    .form-text {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
    }
    
    /* ===== ALERT MESSAGES ===== */
    .alert {
        border-radius: 8px;
        margin-bottom: 16px;
        padding: 12px 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="materials-container">
    <!-- Header -->
    <div class="materials-header">
        <h1><i class="bi bi-box-seam"></i> Solicitar Materiales</h1>
        <div class="project">
            <i class="bi bi-building"></i> {{ project.name }}
        </div>
    </div>
    
    <!-- Form -->
    <form method="post" enctype="multipart/form-data" class="materials-form" id="materialsForm">
        {% csrf_token %}
        
        <!-- Messages -->
        {% for m in messages %}
        <div class="alert alert-{{ m.tags }}">{{ m }}</div>
        {% endfor %}
        
        <!-- Quick Catalog Select -->
        <div class="mb-3">
            <label class="form-label">
                <i class="bi bi-bookmark-star"></i> {{ form.catalog_item.label }}
            </label>
            {{ form.catalog_item }}
            <div class="form-text">Selecciona un material guardado o llena los campos abajo</div>
        </div>
        
        <!-- Photo Upload (Prominent) -->
        <div class="photo-upload" onclick="document.getElementById('id_reference_image').click()">
            <i class="bi bi-camera"></i>
            <p>Tomar Foto del Material</p>
            <small>Opcional - Ayuda a identificar el producto</small>
        </div>
        {{ form.reference_image }}
        <div class="photo-preview" id="photoPreview" style="display: none;">
            <img id="photoImg" src="" alt="Preview">
            <button type="button" class="remove-photo" onclick="removePhoto()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        
        <!-- Quantity (Large) -->
        <div class="section-divider">
            <span class="section-title">ðŸ“¦ Cantidad</span>
        </div>
        
        <div class="mb-3">
            <label class="form-label">Â¿CuÃ¡nto necesitas?</label>
            <div class="quantity-group">
                <button type="button" class="quantity-btn" onclick="adjustQuantity(-1)">âˆ’</button>
                {{ form.quantity }}
                <button type="button" class="quantity-btn" onclick="adjustQuantity(1)">+</button>
                {{ form.unit }}
            </div>
        </div>
        
        <!-- When Needed -->
        <div class="mb-3">
            <label class="form-label">
                <i class="bi bi-clock"></i> {{ form.needed_when.label }}
            </label>
            {{ form.needed_when }}
        </div>
        
        <div class="mb-3" id="needed-date-wrap" style="display:none">
            <label class="form-label">Fecha especÃ­fica</label>
            {{ form.needed_date }}
        </div>
        
        <!-- Material Details (Collapsible) -->
        <div class="advanced-section">
            <button type="button" class="collapse-trigger" data-bs-toggle="collapse" data-bs-target="#detailsSection" aria-expanded="false">
                <span><i class="bi bi-info-circle"></i> Detalles del Material</span>
                <i class="bi bi-chevron-down"></i>
            </button>
            
            <div class="collapse" id="detailsSection">
                <!-- Quick Shortcuts -->
                <div class="mb-3">
                    <label class="form-label">Accesos RÃ¡pidos</label>
                    <div class="row g-2">
                        <div class="col-6">
                            {{ form.approved_color }}
                        </div>
                        <div class="col-6">
                            {{ form.product_preset }}
                        </div>
                    </div>
                </div>
                
                <!-- Category & Brand -->
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label">{{ form.category.label }}</label>
                        {{ form.category }}
                    </div>
                    <div class="col-6">
                        <label class="form-label">{{ form.brand.label }}</label>
                        {{ form.brand }}
                    </div>
                </div>
                
                <div class="mb-3" id="brand-other-wrap" style="display:none">
                    <label class="form-label">{{ form.brand_other.label }}</label>
                    {{ form.brand_other }}
                </div>
                
                <!-- Product Name -->
                <div class="mb-3">
                    <label class="form-label">{{ form.product_name.label }}</label>
                    {{ form.product_name }}
                </div>
                
                <!-- Color Details -->
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label">{{ form.color_name.label }}</label>
                        {{ form.color_name }}
                    </div>
                    <div class="col-6">
                        <label class="form-label">{{ form.color_code.label }}</label>
                        {{ form.color_code }}
                    </div>
                </div>
                
                <!-- Finish & Gloss -->
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label">{{ form.finish.label }}</label>
                        {{ form.finish }}
                    </div>
                    <div class="col-6">
                        <label class="form-label">{{ form.gloss.label }}</label>
                        {{ form.gloss }}
                    </div>
                </div>
                
                <!-- Formula -->
                <div class="mb-3">
                    <label class="form-label">{{ form.formula.label }}</label>
                    {{ form.formula }}
                </div>
            </div>
        </div>
        
        <!-- Comments -->
        <div class="section-divider">
            <span class="section-title">ðŸ’¬ Comentarios</span>
        </div>
        
        <div class="mb-3">
            <label class="form-label">{{ form.comments.label }}</label>
            {{ form.comments }}
            <div class="form-text">Instrucciones adicionales o notas</div>
        </div>
        
        <!-- Save to Catalog -->
        <div class="form-check mb-3">
            {{ form.save_to_catalog }}
            <label class="form-check-label" for="id_save_to_catalog">
                {{ form.save_to_catalog.label }}
            </label>
            <div class="form-text">Guardar para futuras solicitudes</div>
        </div>
        
        <!-- Submit Section (Sticky) -->
        <div class="submit-section">
            <button type="submit" class="submit-btn">
                <i class="bi bi-send-fill"></i> Enviar Solicitud
            </button>
            <a class="btn cancel-btn" href="{% url 'dashboard_pm' %}">
                <i class="bi bi-x-circle"></i> Cancelar
            </a>
        </div>
    </form>
</div>

{% block extra_js %}
<script>
    // Datos entregados por la vista
    const PRESETS = JSON.parse('{{ presets_json|default:"[]"|escapejs }}');
    const CATALOG = JSON.parse('{{ catalog_json|default:"[]"|escapejs }}');

    // Utilidad para asignar valores
    function setVal(id, val) {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === "SELECT" || el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
            el.value = val ?? "";
        }
    }

    // ===== PHOTO PREVIEW =====
    const photoInput = document.getElementById("id_reference_image");
    const photoPreview = document.getElementById("photoPreview");
    const photoImg = document.getElementById("photoImg");
    
    if (photoInput) {
        photoInput.style.display = 'none'; // Hide file input
        photoInput.accept = 'image/*';
        photoInput.capture = 'environment'; // Use back camera on mobile
        
        photoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoImg.src = e.target.result;
                    photoPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    function removePhoto() {
        if (photoInput) photoInput.value = '';
        photoPreview.style.display = 'none';
    }
    
    // ===== QUANTITY ADJUSTMENT =====
    function adjustQuantity(delta) {
        const input = document.getElementById('id_quantity');
        if (!input) return;
        const current = parseFloat(input.value) || 0;
        const step = parseFloat(input.step) || 1;
        const min = parseFloat(input.min) || 0;
        const newValue = Math.max(min, current + (delta * step));
        input.value = newValue;
    }
    
    // ===== BRAND "OTHER" TOGGLE =====
    const brandSel = document.getElementById("id_brand");
    const brandWrap = document.getElementById("brand-other-wrap");
    const brandOther = document.getElementById("id_brand_other");
    
    function toggleBrandOther() {
        const show = brandSel && brandSel.value === "other";
        if (brandWrap) brandWrap.style.display = show ? "" : "none";
        if (!show && brandOther) brandOther.value = "";
    }
    
    if (brandSel) {
        brandSel.addEventListener("change", toggleBrandOther);
        toggleBrandOther();
    }

    // ===== PRODUCT PRESETS =====
    const presetSelect = document.getElementById("id_product_preset");
    
    function applyPreset() {
        const raw = presetSelect ? presetSelect.value : "";
        if (!raw) return;
        const idx = parseInt(raw, 10);
        if (Number.isNaN(idx)) return;
        const p = PRESETS[idx];
        if (!p) return;
        setVal("id_category", p.category);
        setVal("id_brand", p.brand);
        const prod = document.getElementById("id_product_name");
        if (prod && !prod.value) setVal("id_product_name", p.product_name);
        setVal("id_unit", p.unit);
        toggleBrandOther();
        
        // Expand details section
        const detailsSection = document.getElementById('detailsSection');
        if (detailsSection && !detailsSection.classList.contains('show')) {
            const bsCollapse = new bootstrap.Collapse(detailsSection, { toggle: true });
        }
    }
    
    if (presetSelect) presetSelect.addEventListener("change", applyPreset);

    // ===== CATALOG ITEMS =====
    const catSelect = document.getElementById("id_catalog_item");
    
    function applyCatalog() {
        const raw = catSelect ? catSelect.value : "";
        const id = parseInt(raw || "0", 10);
        const item = CATALOG.find(x => x.id === id);
        if (!item) return;
        setVal("id_category", item.category);
        setVal("id_product_name", item.product_name);
        setVal("id_color_name", item.color_name);
        setVal("id_color_code", item.color_code);
        setVal("id_finish", item.finish);
        setVal("id_gloss", item.gloss);
        setVal("id_formula", item.formula);
        setVal("id_unit", item.default_unit);
        // Marca texto libre desde catÃ¡logo
        setVal("id_brand", "other");
        toggleBrandOther();
        setVal("id_brand_other", item.brand_text);
        
        // Expand details section
        const detailsSection = document.getElementById('detailsSection');
        if (detailsSection && !detailsSection.classList.contains('show')) {
            const bsCollapse = new bootstrap.Collapse(detailsSection, { toggle: true });
        }
    }
    
    if (catSelect) catSelect.addEventListener("change", applyCatalog);

    // ===== NEEDED DATE TOGGLE =====
    const whenSelect = document.getElementById("id_needed_when");
    const dateWrap = document.getElementById("needed-date-wrap");
    const dateInput = document.getElementById("id_needed_date");
    
    function toggleDate() {
        const show = whenSelect && whenSelect.value === "date";
        if (dateWrap) dateWrap.style.display = show ? "" : "none";
        if (!show && dateInput) dateInput.value = "";
    }
    
    if (whenSelect) {
        whenSelect.addEventListener("change", toggleDate);
        toggleDate();
    }
    
    // ===== FORM VALIDATION =====
    const form = document.getElementById('materialsForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const quantity = document.getElementById('id_quantity');
            if (quantity && parseFloat(quantity.value) <= 0) {
                e.preventDefault();
                alert('Por favor ingresa una cantidad vÃ¡lida');
                quantity.focus();
                return false;
            }
        });
    }
</script>
{% endblock %}
{% endblock %}

      <!-- Datos del material -->
      <div class="col-md-4">
        <label class="form-label">{{ form.category.label }}</label>
        {{ form.category }}
      </div>
      <div class="col-md-4">
        <label class="form-label">{{ form.brand.label }}</label>
        {{ form.brand }}
      </div>
      <div class="col-md-4" id="brand-other-wrap" style="display:none">
        <label class="form-label">{{ form.brand_other.label }}</label>
        {{ form.brand_other }}
      </div>

      <div class="col-md-4">
        <label class="form-label">{{ form.product_name.label }}</label>
        {{ form.product_name }}
      </div>
      <div class="col-md-3">
        <label class="form-label">{{ form.color_name.label }}</label>
        {{ form.color_name }}
      </div>
      <div class="col-md-3">
        <label class="form-label">{{ form.color_code.label }}</label>
        {{ form.color_code }}
      </div>
      <div class="col-md-2">
        <label class="form-label">{{ form.finish.label }}</label>
        {{ form.finish }}
      </div>
      <div class="col-md-2">
        <label class="form-label">{{ form.gloss.label }}</label>
        {{ form.gloss }}
      </div>

      <div class="col-md-6">
        <label class="form-label">{{ form.formula.label }}</label>
        {{ form.formula }}
      </div>
      <div class="col-md-6">
        <label class="form-label">{{ form.reference_image.label }}</label>
        {{ form.reference_image }}
      </div>

      <!-- Cantidad y cuÃ¡ndo -->
      <div class="col-md-3">
        <label class="form-label">{{ form.quantity.label }}</label>
        {{ form.quantity }}
      </div>
      <div class="col-md-3">
        <label class="form-label">{{ form.unit.label }}</label>
        {{ form.unit }}
      </div>
      <div class="col-md-3">
        <label class="form-label">{{ form.needed_when.label }}</label>
        {{ form.needed_when }}
      </div>
      <div class="col-md-3" id="needed-date-wrap">
        <label class="form-label">{{ form.needed_date.label }}</label>
        {{ form.needed_date }}
      </div>

      <div class="col-12">
        <label class="form-label">{{ form.comments.label }}</label>
        {{ form.comments }}
      </div>

      <div class="col-12 form-check">
        {{ form.save_to_catalog }}
        <label class="form-check-label" for="id_save_to_catalog">{{ form.save_to_catalog.label }}</label>
      </div>

      <div class="col-12">
        <button class="btn btn-primary">Solicitar</button>
        <a class="btn btn-secondary" href="{% url 'dashboard_pm' %}">Volver</a>
      </div>
    </div>
  </form>

  <script>
    // Datos entregados por la vista
    const PRESETS = JSON.parse('{{ presets_json|default:"[]"|escapejs }}');
    const CATALOG = JSON.parse('{{ catalog_json|default:"[]"|escapejs }}');

    // Utilidad para asignar valores
    function setVal(id, val) {
      const el = document.getElementById(id);
      if (!el) return;
      if (el.tagName === "SELECT" || el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
        el.value = val ?? "";
      }
    }

    // Marca "Otra" => mostrar campo de texto
    const brandSel = document.getElementById("id_brand");
    const brandWrap = document.getElementById("brand-other-wrap");
    const brandOther = document.getElementById("id_brand_other");
    function toggleBrandOther() {
      const show = brandSel && brandSel.value === "other";
      if (brandWrap) brandWrap.style.display = show ? "" : "none";
      if (!show && brandOther) brandOther.value = "";
    }
    if (brandSel) {
      brandSel.addEventListener("change", toggleBrandOther);
      toggleBrandOther();
    }

    // Presets de producto
    const presetSelect = document.getElementById("id_product_preset");
    function applyPreset() {
      const raw = presetSelect ? presetSelect.value : "";
      if (!raw) return;
      const idx = parseInt(raw, 10);
      if (Number.isNaN(idx)) return;
      const p = PRESETS[idx];
      if (!p) return;
      setVal("id_category", p.category);
      setVal("id_brand", p.brand);
      const prod = document.getElementById("id_product_name");
      if (prod && !prod.value) setVal("id_product_name", p.product_name);
      setVal("id_unit", p.unit);
      toggleBrandOther();
    }
    if (presetSelect) presetSelect.addEventListener("change", applyPreset);

    // CatÃ¡logo del proyecto
    const catSelect = document.getElementById("id_catalog_item");
    function applyCatalog() {
      const raw = catSelect ? catSelect.value : "";
      const id = parseInt(raw || "0", 10);
      const item = CATALOG.find(x => x.id === id);
      if (!item) return;
      setVal("id_category", item.category);
      setVal("id_product_name", item.product_name);
      setVal("id_color_name", item.color_name);
      setVal("id_color_code", item.color_code);
      setVal("id_finish", item.finish);
      setVal("id_gloss", item.gloss);
      setVal("id_formula", item.formula);
      setVal("id_unit", item.default_unit);
      // Marca texto libre desde catÃ¡logo
      setVal("id_brand", "other");
      toggleBrandOther();
      setVal("id_brand_other", item.brand_text);
    }
    if (catSelect) catSelect.addEventListener("change", applyCatalog);

    // Mostrar fecha solo cuando se elija "Fecha especÃ­fica"
    const whenSelect = document.getElementById("id_needed_when");
    const dateWrap = document.getElementById("needed-date-wrap");
    const dateInput = document.getElementById("id_needed_date");
    function toggleDate() {
      const show = whenSelect && whenSelect.value === "date";
      if (dateWrap) dateWrap.style.display = show ? "" : "none";
      if (!show && dateInput) dateInput.value = "";
    }
    if (whenSelect) {
      whenSelect.addEventListener("change", toggleDate);
      toggleDate();
    }
  </script>
</div>
{% endblock %}