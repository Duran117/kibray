{% extends "core/base.html" %}
{% load i18n %}
{% load static %}
{% load core_extras %}

{% block title %}Dashboard de Profit - {{ project.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2>üìä Dashboard de Profit & Margen</h2>
            <p class="text-muted">Proyecto: <strong>{{ project.name }}</strong> - {{ project.client }}</p>
        </div>
    </div>

    <!-- ALERTS -->
    {% if alerts %}
    <div class="row mb-3">
        <div class="col-12">
            {% for alert in alerts %}
            <div class="alert alert-{{ alert.type }} alert-dismissible fade show" role="alert">
                {{ alert.message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- KEY METRICS -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center {% if profit > 0 %}border-success{% else %}border-danger{% endif %}">
                <div class="card-body">
                    <h6 class="text-muted">üí∞ Profit</h6>
                    <h2 class="{% if profit > 0 %}text-success{% else %}text-danger{% endif %}">${{ profit|floatformat:2 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center {% if margin_pct >= 25 %}border-success{% elif margin_pct >= 10 %}border-warning{% else %}border-danger{% endif %}">
                <div class="card-body">
                    <h6 class="text-muted">üìà Margen %</h6>
                    <h2 class="{% if margin_pct >= 25 %}text-success{% elif margin_pct >= 10 %}text-warning{% else %}text-danger{% endif %}">{{ margin_pct|floatformat:1 }}%</h2>
                    <small class="text-muted">Meta: >25%</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <h6 class="text-muted">üíµ Cobrado</h6>
                    <h2 class="text-primary">${{ collected_amount|floatformat:2 }}</h2>
                    <small class="text-muted">de ${{ billed_amount|floatformat:2 }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h6 class="text-muted">‚è≥ Pendiente</h6>
                    <h2 class="text-warning">${{ outstanding|floatformat:2 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- REVENUE BREAKDOWN -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üí∞ Presupuesto & Facturaci√≥n</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <tbody>
                            <tr>
                                <td>Estimado Base</td>
                                <td class="text-end"><strong>${{ estimate_revenue|floatformat:2 }}</strong></td>
                            </tr>
                            <tr>
                                <td>Change Orders</td>
                                <td class="text-end"><strong>${{ cos_revenue|floatformat:2 }}</strong></td>
                            </tr>
                            <tr class="table-active">
                                <td><strong>Total Presupuestado</strong></td>
                                <td class="text-end"><strong>${{ budgeted_revenue|floatformat:2 }}</strong></td>
                            </tr>
                            <tr>
                                <td>Facturado Real</td>
                                <td class="text-end"><strong>${{ billed_amount|floatformat:2 }}</strong></td>
                            </tr>
                            <tr class="{% if budget_variance >= 0 %}table-success{% else %}table-danger{% endif %}">
                                <td><strong>Varianza</strong></td>
                                <td class="text-end">
                                    <strong>
                                        {% if budget_variance >= 0 %}+{% endif %}${{ budget_variance|floatformat:2 }}
                                        ({{ budget_variance_pct|floatformat:1 }}%)
                                    </strong>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">üìâ Costos Reales</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <tbody>
                            <tr>
                                <td>üë∑ Labor (Tiempo)</td>
                                <td class="text-end"><strong>${{ labor_cost|floatformat:2 }}</strong></td>
                                <td class="text-end">{{ labor_cost|floatformat:0|add:"0"|mul:100|div:total_actual_cost|default:"0" }}%</td>
                            </tr>
                            <tr>
                                <td>üõ†Ô∏è Materiales (Gastos)</td>
                                <td class="text-end"><strong>${{ material_cost|floatformat:2 }}</strong></td>
                                <td class="text-end">{{ material_cost|floatformat:0|add:"0"|mul:100|div:total_actual_cost|default:"0" }}%</td>
                            </tr>
                            <tr class="table-active">
                                <td><strong>Total Costos</strong></td>
                                <td class="text-end"><strong>${{ total_actual_cost|floatformat:2 }}</strong></td>
                                <td class="text-end"><strong>100%</strong></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <!-- Simple Pie Chart with CSS -->
                    <div class="mt-3">
                        <div class="d-flex align-items-center mb-2">
                            <div style="width:100%; height:30px; background: linear-gradient(to right, #0d6efd 0%, #0d6efd {{ labor_cost|floatformat:0|add:"0"|mul:100|div:total_actual_cost|default:"0" }}%, #dc3545 {{ labor_cost|floatformat:0|add:"0"|mul:100|div:total_actual_cost|default:"0" }}%, #dc3545 100%); border-radius: 5px;"></div>
                        </div>
                        <small class="text-muted">
                            <span class="badge bg-primary">Labor</span>
                            <span class="badge bg-danger">Materiales</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CASH FLOW -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üíµ Estado de Cobros</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <h6 class="text-muted">Total Facturado</h6>
                            <h3>${{ billed_amount|floatformat:2 }}</h3>
                        </div>
                        <div class="col-md-4 text-center border-start">
                            <h6 class="text-muted text-success">‚úÖ Cobrado</h6>
                            <h3 class="text-success">${{ collected_amount|floatformat:2 }}</h3>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-success" style="width: {{ collected_amount|floatformat:0|add:"0"|mul:100|div:billed_amount|default:"0" }}%"></div>
                            </div>
                            <small class="text-muted">{{ collected_amount|floatformat:0|add:"0"|mul:100|div:billed_amount|default:"0" }}%</small>
                        </div>
                        <div class="col-md-4 text-center border-start">
                            <h6 class="text-muted text-warning">‚è≥ Pendiente</h6>
                            <h3 class="text-warning">${{ outstanding|floatformat:2 }}</h3>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-warning" style="width: {{ outstanding|floatformat:0|add:"0"|mul:100|div:billed_amount|default:"0" }}%"></div>
                            </div>
                            <small class="text-muted">{{ outstanding|floatformat:0|add:"0"|mul:100|div:billed_amount|default:"0" }}%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ACTIONS -->
    <div class="row">
        <div class="col-12">
            <a href="{% url 'project_overview' project.id %}" class="btn btn-outline-primary">üìÅ Volver al Proyecto</a>
            <a href="{% url 'invoice_builder' project.id %}" class="btn btn-success">üí∞ Crear Factura</a>
            <a href="{% url 'invoice_payment_dashboard' %}" class="btn btn-warning">üíµ Panel de Pagos</a>
        </div>
    </div>
</div>

<script>
// Simple calculation helpers for percentage display in template
// (Django templates don't support complex math, but we handle most in view)
</script>
{% endblock %}
