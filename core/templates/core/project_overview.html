{% extends "core/base_modern.html" %}
{% load i18n %}

{% block extra_css %}
<style>
  /* ===== PROJECT LAYOUT OVERRIDES ===== */
  /* With legacy_shell=True, global header/sidebar are not rendered */
  /* Just need to remove any leftover padding from main content */
  
  [data-layout-root] { 
    min-height: 100vh !important; 
    padding-top: 0 !important;
  }
  
  #main-content,
  #main-content.lg\:pl-64,
  main.lg\:pl-64 { 
    padding-left: 0 !important; 
    margin-left: 0 !important;
  }
  
  #main-content > div.w-full,
  #main-content > div { 
    padding: 0 !important;
    max-width: 100% !important;
    margin: 0 !important;
  }
  
  /* ===== HIDE GLOBAL NAV ELEMENTS ===== */
  /* Project overview has its own navigation, hide the global one */
  #kb-header,
  #kb-sidebar,
  #kb-sidebar-backdrop,
  #react-navigation-root,
  [id^="react-"] {
    display: none !important;
  }
  
  /* ===== PROJECT SIDEBAR - Desktop ===== */
  .project-sidebar {
    width: 240px;
    height: 100vh;
    background: #1e1f21;
    transition: all 0.2s ease;
    position: fixed;
    left: 0;
    top: 0;
    z-index: 50; /* Higher than global nav (40) */
    overflow-y: auto;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    border-right: none; /* Remove any border that might cause the white line */
  }
  
  /* Collapsed state */
  .project-sidebar.collapsed { width: 56px; }
  .project-sidebar.collapsed .nav-text,
  .project-sidebar.collapsed .section-title,
  .project-sidebar.collapsed .project-header-info { display: none; }
  .project-sidebar.collapsed .nav-item { justify-content: center; padding: 0.75rem; }
  .project-sidebar.collapsed .project-header { padding: 0.75rem; justify-content: center; }
  .project-sidebar.collapsed .color-dot { display: none; }
  
  /* Main content area */
  .project-main {
    margin-left: 240px;
    transition: margin-left 0.2s ease;
    min-height: 100vh;
    background: #f8fafc;
  }
  .project-main.expanded { margin-left: 56px; }
  
  /* Nav sections */
  .nav-section { padding: 0.5rem 0; }
  
  /* Navigation container - flex grow to fill space */
  .project-sidebar > nav {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 0.5rem;
  }
  .section-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6f7782;
    padding: 0.5rem 1rem;
    margin-top: 0.5rem;
  }
  
  /* Nav items */
  .nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 1rem;
    color: #a2a0a2;
    text-decoration: none;
    font-size: 14px;
    border-radius: 0;
    transition: all 0.15s ease;
    white-space: nowrap;
  }
  .nav-item:hover { background: rgba(255,255,255,0.08); color: #fff; }
  .nav-item.active { background: rgba(255,255,255,0.12); color: #fff; }
  .nav-item i { font-size: 18px; width: 20px; text-align: center; flex-shrink: 0; }
  .nav-item .badge-count {
    margin-left: auto;
    background: rgba(255,255,255,0.15);
    color: #a2a0a2;
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 10px;
  }
  
  .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 0.5rem 1rem; }
  
  /* Color indicators */
  .nav-item .color-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  
  /* Sidebar footer - collapse toggle */
  .sidebar-footer {
    margin-top: auto;
    padding: 1rem;
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  
  /* Collapse toggle button - sticky at bottom */
  .sidebar-collapse-toggle {
    position: sticky;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.75rem 1rem;
    background: #1e1f21;
    border-top: 1px solid rgba(255,255,255,0.1);
    margin-top: auto;
  }
  
  .project-sidebar.collapsed .sidebar-collapse-toggle {
    padding: 0.75rem 0.5rem;
  }
  
  /* ===== MOBILE: Bottom Nav + Hamburger ===== */
  .mobile-project-header {
    display: none;
    position: sticky;
    top: 0;
    z-index: 35;
    background: #1e1f21;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  .mobile-bottom-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #1e1f21;
    border-top: 1px solid rgba(255,255,255,0.15);
    z-index: 100;
    padding: 0.5rem 0;
    padding-bottom: max(env(safe-area-inset-bottom, 0.5rem), 0.5rem);
  }
  
  .mobile-bottom-nav .nav-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0;
  }
  
  .mobile-bottom-nav .nav-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 0.25rem;
    color: #a2a0a2;
    text-decoration: none;
    font-size: 10px;
    transition: all 0.15s ease;
  }
  .mobile-bottom-nav .nav-btn:hover,
  .mobile-bottom-nav .nav-btn.active { color: #fff; }
  .mobile-bottom-nav .nav-btn i { font-size: 20px; margin-bottom: 2px; }
  
  /* Mobile drawer overlay */
  .mobile-drawer-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 55;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .mobile-drawer-overlay.active { display: block; opacity: 1; }
  
  /* Mobile drawer */
  .mobile-drawer {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 280px;
    max-width: 85vw;
    background: #1e1f21;
    z-index: 60;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  .mobile-drawer.open { transform: translateX(0); }
  
  .mobile-drawer .drawer-header {
    padding: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .mobile-drawer .drawer-close {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #a2a0a2;
    border-radius: 8px;
    transition: all 0.15s ease;
  }
  .mobile-drawer .drawer-close:hover { background: rgba(255,255,255,0.1); color: #fff; }
  
  /* ===== RESPONSIVE BREAKPOINTS ===== */
  @media (max-width: 1024px) {
    .project-sidebar { width: 56px; }
    .project-sidebar .nav-text,
    .project-sidebar .section-title,
    .project-sidebar .project-header-info { display: none; }
    .project-sidebar .nav-item { justify-content: center; padding: 0.75rem; }
    .project-sidebar .project-header { padding: 0.75rem; justify-content: center; }
    .project-sidebar .color-dot { display: none; }
    .project-main { margin-left: 56px; }
  }
  
  @media (max-width: 768px) {
    /* Hide desktop sidebar */
    .project-sidebar { display: none !important; }
    .project-main { 
      margin-left: 0 !important; 
      padding-bottom: 80px !important; /* Space for bottom nav */
    }
    
    /* Show mobile elements */
    .mobile-project-header { display: flex !important; }
    .mobile-bottom-nav { display: block !important; }
    
    /* Ensure the main content wrapper is block on mobile */
    [data-layout-root] > .flex,
    .project-layout-wrapper { display: block !important; }
  }
</style>
{% endblock %}

{% block page_header %}
{% endblock %}

{% block content %}
<!-- ===== MOBILE: Header with hamburger ===== -->
<div class="mobile-project-header items-center justify-between">
  <button onclick="openMobileDrawer()" class="p-2 text-white hover:bg-white/10 rounded-lg transition">
    <i class="bi bi-list text-xl"></i>
  </button>
  <div class="flex items-center gap-2 flex-1 ml-3">
    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white flex-shrink-0">
      <i class="bi bi-building text-sm"></i>
    </div>
    <span class="text-white font-medium text-sm truncate">{{ project.name }}</span>
  </div>
  <a href="{% url 'schedule_gantt_react' project.id %}" class="p-2 text-white hover:bg-white/10 rounded-lg transition">
    <i class="bi bi-diagram-3"></i>
  </a>
</div>

<!-- ===== MOBILE: Bottom Navigation ===== -->
<nav class="mobile-bottom-nav">
  <div class="nav-grid">
    <a href="{% url 'project_overview' project.id %}" class="nav-btn active">
      <i class="bi bi-house-door"></i>
      <span>{% trans "Inicio" %}</span>
    </a>
    <a href="{% url 'schedule_gantt_react' project.id %}" class="nav-btn">
      <i class="bi bi-diagram-3"></i>
      <span>Gantt</span>
    </a>
    <a href="{% url 'project_files' project.id %}" class="nav-btn">
      <i class="bi bi-folder2"></i>
      <span>{% trans "Files" %}</span>
    </a>
    <a href="{% url 'budget_wizard' project.id %}" class="nav-btn">
      <i class="bi bi-wallet2"></i>
      <span>{% trans "Budget" %}</span>
    </a>
    <button onclick="openMobileDrawer()" class="nav-btn">
      <i class="bi bi-grid-3x3-gap"></i>
      <span>{% trans "Más" %}</span>
    </button>
  </div>
</nav>

<!-- ===== MOBILE: Drawer Overlay ===== -->
<div class="mobile-drawer-overlay" id="mobileDrawerOverlay" onclick="closeMobileDrawer()"></div>

<!-- ===== MOBILE: Full Drawer Menu ===== -->
<aside class="mobile-drawer" id="mobileDrawer">
  <div class="drawer-header">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white">
        <i class="bi bi-building"></i>
      </div>
      <div>
        <h2 class="text-white font-semibold text-sm">{{ project.name }}</h2>
        <span class="text-xs text-slate-400">{% trans "Project" %}</span>
      </div>
    </div>
    <button onclick="closeMobileDrawer()" class="drawer-close">
      <i class="bi bi-x-lg text-xl"></i>
    </button>
  </div>
  
  <nav class="flex-1 py-2 overflow-y-auto">
    <!-- Overview -->
    <a href="{% url 'project_overview' project.id %}" class="nav-item active">
      <i class="bi bi-house-door"></i>
      <span class="nav-text">{% trans "Overview" %}</span>
    </a>
    
    <div class="nav-divider"></div>
    
    <!-- Planificación -->
    <div class="section-title">{% trans "Planificación" %}</div>
    <a href="{% url 'schedule_gantt_react' project.id %}" class="nav-item">
      <i class="bi bi-diagram-3"></i>
      <span class="nav-text">{% trans "Gantt Chart" %}</span>
    </a>
    <a href="{% url 'daily_planning_dashboard' %}" class="nav-item">
      <i class="bi bi-calendar-check"></i>
      <span class="nav-text">{% trans "Daily Plans" %}</span>
    </a>
    <a href="{% url 'strategic_planning_dashboard' %}" class="nav-item">
      <i class="bi bi-compass"></i>
      <span class="nav-text">{% trans "Strategic" %}</span>
    </a>
    <a href="{% url 'daily_log' project.id %}" class="nav-item">
      <i class="bi bi-journal-text"></i>
      <span class="nav-text">{% trans "Daily Logs" %}</span>
    </a>
    
    <!-- Documentos -->
    <div class="section-title">{% trans "Documentos" %}</div>
    <a href="{% url 'project_files' project.id %}" class="nav-item">
      <i class="bi bi-folder2-open"></i>
      <span class="nav-text">{% trans "Archivos" %}</span>
    </a>
    <a href="{% url 'floor_plan_list' project.id %}" class="nav-item">
      <i class="bi bi-map"></i>
      <span class="nav-text">{% trans "Planos 2D" %}</span>
    </a>
    <a href="{% url 'project_minutes_list' project.id %}" class="nav-item">
      <i class="bi bi-journal-richtext"></i>
      <span class="nav-text">{% trans "Minutas" %}</span>
    </a>
    <a href="{% url 'rfi_list' project.id %}" class="nav-item">
      <i class="bi bi-question-diamond"></i>
      <span class="nav-text">RFIs</span>
    </a>
    
    <!-- Financiero -->
    <div class="section-title">{% trans "Financiero" %}</div>
    <a href="{% url 'budget_wizard' project.id %}" class="nav-item">
      <i class="bi bi-wallet2"></i>
      <span class="nav-text">{% trans "Budget" %}</span>
    </a>
    <a href="{% url 'expense_list' %}?project={{ project.id }}" class="nav-item">
      <i class="bi bi-cash-stack"></i>
      <span class="nav-text">{% trans "Expenses" %}</span>
    </a>
    <a href="{% url 'income_list' %}?project={{ project.id }}" class="nav-item">
      <i class="bi bi-cash-coin"></i>
      <span class="nav-text">{% trans "Income" %}</span>
    </a>
    <a href="{% url 'invoice_builder' project.id %}" class="nav-item">
      <i class="bi bi-receipt"></i>
      <span class="nav-text">{% trans "Facturas" %}</span>
    </a>
    <a href="{% url 'project_profit_dashboard' project.id %}" class="nav-item">
      <i class="bi bi-graph-up"></i>
      <span class="nav-text">{% trans "Profit" %}</span>
    </a>
    <a href="{% url 'project_ev' project.id %}" class="nav-item">
      <i class="bi bi-speedometer2"></i>
      <span class="nav-text">{% trans "Earned Value" %}</span>
    </a>
    
    <!-- Diseño y Colores -->
    <div class="section-title">{% trans "Design" %}</div>
    <a href="{% url 'color_sample_list' project.id %}" class="nav-item">
      <i class="bi bi-palette"></i>
      <span class="nav-text">{% trans "Color Samples" %}</span>
    </a>
    
    <!-- Operaciones -->
    <div class="section-title">{% trans "Operaciones" %}</div>
    <a href="{% url 'touchup_plans_list' project.id %}" class="nav-item">
      <i class="bi bi-brush"></i>
      <span class="nav-text">{% trans "Touch-ups" %}</span>
    </a>
    <a href="{% url 'damage_report_list' project.id %}" class="nav-item">
      <i class="bi bi-exclamation-diamond"></i>
      <span class="nav-text">{% trans "Daños" %}</span>
    </a>
    <a href="{% url 'materials_requests_list' project.id %}" class="nav-item">
      <i class="bi bi-truck"></i>
      <span class="nav-text">{% trans "Materials" %}</span>
    </a>
    <a href="{% url 'inventory_wizard' project.id %}" class="nav-item">
      <i class="bi bi-box-seam"></i>
      <span class="nav-text">{% trans "Inventario" %}</span>
    </a>
    <a href="{% url 'issue_list' project.id %}" class="nav-item">
      <i class="bi bi-bug"></i>
      <span class="nav-text">{% trans "Issues" %}</span>
    </a>
    
    <!-- Change Orders -->
    <div class="section-title">{% trans "Change Orders" %}</div>
    <a href="{% url 'changeorder_board' %}" class="nav-item">
      <i class="bi bi-kanban"></i>
      <span class="nav-text">{% trans "CO Board" %}</span>
    </a>
    <a href="{% url 'changeorder_create' %}" class="nav-item">
      <i class="bi bi-file-earmark-plus"></i>
      <span class="nav-text">{% trans "Nuevo CO" %}</span>
    </a>
    
    <!-- Comunicación -->
    <div class="section-title">{% trans "Comunicación" %}</div>
    <a href="{% url 'client_requests_list' project.id %}" class="nav-item">
      <i class="bi bi-people"></i>
      <span class="nav-text">{% trans "Client Requests" %}</span>
    </a>
    <a href="{% url 'task_list' project.id %}" class="nav-item">
      <i class="bi bi-check2-square"></i>
      <span class="nav-text">{% trans "Tareas" %}</span>
    </a>
  </nav>
</aside>

<!-- ===== DESKTOP: Asana-style Sidebar ===== -->
<div class="flex">
  <!-- Sidebar -->
  <aside class="project-sidebar" id="projectSidebar">
    <!-- Project Header -->
    <div class="p-4 border-b border-white/10 project-header">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white flex-shrink-0">
          <i class="bi bi-building"></i>
        </div>
        <div class="nav-text project-header-info overflow-hidden">
          <h2 class="text-white font-semibold text-sm truncate">{{ project.name }}</h2>
          <span class="text-xs text-slate-400">{% trans "Project" %}</span>
        </div>
      </div>
    </div>
    
    <!-- Navigation -->
    <nav class="py-2">
      <!-- Overview -->
      <a href="{% url 'project_overview' project.id %}" class="nav-item active">
        <i class="bi bi-house-door"></i>
        <span class="nav-text">{% trans "Overview" %}</span>
      </a>
      
      <div class="nav-divider"></div>
      
      <!-- Planificación -->
      <div class="section-title">{% trans "Planificación" %}</div>
      <a href="{% url 'schedule_gantt_react' project.id %}" class="nav-item">
        <span class="color-dot bg-purple-500"></span>
        <i class="bi bi-diagram-3"></i>
        <span class="nav-text">{% trans "Gantt Chart" %}</span>
      </a>
      <a href="{% url 'daily_planning_dashboard' %}" class="nav-item">
        <span class="color-dot bg-teal-500"></span>
        <i class="bi bi-calendar-check"></i>
        <span class="nav-text">{% trans "Daily Plans" %}</span>
      </a>
      <a href="{% url 'strategic_planning_dashboard' %}" class="nav-item">
        <span class="color-dot bg-indigo-500"></span>
        <i class="bi bi-compass"></i>
        <span class="nav-text">{% trans "Strategic" %}</span>
      </a>
      <a href="{% url 'daily_log' project.id %}" class="nav-item">
        <span class="color-dot bg-slate-500"></span>
        <i class="bi bi-journal-text"></i>
        <span class="nav-text">{% trans "Daily Logs" %}</span>
      </a>
      
      <!-- Documentos -->
      <div class="section-title">{% trans "Documentos" %}</div>
      <a href="{% url 'project_files' project.id %}" class="nav-item">
        <i class="bi bi-folder2-open"></i>
        <span class="nav-text">{% trans "Archivos" %}</span>
      </a>
      <a href="{% url 'floor_plan_list' project.id %}" class="nav-item">
        <i class="bi bi-map"></i>
        <span class="nav-text">{% trans "Planos 2D" %}</span>
      </a>
      <a href="{% url 'project_minutes_list' project.id %}" class="nav-item">
        <i class="bi bi-journal-richtext"></i>
        <span class="nav-text">{% trans "Minutas" %}</span>
      </a>
      <a href="{% url 'rfi_list' project.id %}" class="nav-item">
        <i class="bi bi-question-diamond"></i>
        <span class="nav-text">RFIs</span>
      </a>
      
      <!-- Financiero -->
      <div class="section-title">{% trans "Financiero" %}</div>
      <a href="{% url 'budget_wizard' project.id %}" class="nav-item">
        <i class="bi bi-wallet2"></i>
        <span class="nav-text">{% trans "Budget" %}</span>
      </a>
      <a href="{% url 'budget_lines' project.id %}" class="nav-item">
        <i class="bi bi-list-columns"></i>
        <span class="nav-text">{% trans "Budget Lines" %}</span>
      </a>
      <a href="{% url 'expense_list' %}?project={{ project.id }}" class="nav-item">
        <i class="bi bi-cash-stack"></i>
        <span class="nav-text">{% trans "Expenses" %}</span>
      </a>
      <a href="{% url 'income_list' %}?project={{ project.id }}" class="nav-item">
        <i class="bi bi-cash-coin"></i>
        <span class="nav-text">{% trans "Income" %}</span>
      </a>
      <a href="{% url 'invoice_builder' project.id %}" class="nav-item">
        <i class="bi bi-receipt"></i>
        <span class="nav-text">{% trans "Facturas" %}</span>
      </a>
      <a href="{% url 'project_profit_dashboard' project.id %}" class="nav-item">
        <i class="bi bi-graph-up"></i>
        <span class="nav-text">{% trans "Profit" %}</span>
      </a>
      <a href="{% url 'project_ev' project.id %}" class="nav-item">
        <i class="bi bi-speedometer2"></i>
        <span class="nav-text">{% trans "Earned Value" %}</span>
      </a>
      
      <!-- Diseño y Colores -->
      <div class="section-title">{% trans "Design" %}</div>
      <a href="{% url 'color_sample_list' project.id %}" class="nav-item">
        <i class="bi bi-palette"></i>
        <span class="nav-text">{% trans "Color Samples" %}</span>
      </a>
      <a href="{% url 'site_photo_list' project.id %}" class="nav-item">
        <i class="bi bi-camera"></i>
        <span class="nav-text">{% trans "Site Photos" %}</span>
      </a>
      
      <!-- Operaciones -->
      <div class="section-title">{% trans "Operaciones" %}</div>
      <a href="{% url 'touchup_board' project.id %}" class="nav-item">
        <i class="bi bi-brush"></i>
        <span class="nav-text">{% trans "Touch-ups" %}</span>
      </a>
      <a href="{% url 'damage_report_list' project.id %}" class="nav-item">
        <i class="bi bi-exclamation-diamond"></i>
        <span class="nav-text">{% trans "Daños" %}</span>
      </a>
      <a href="{% url 'materials_requests_list' project.id %}" class="nav-item">
        <i class="bi bi-truck"></i>
        <span class="nav-text">{% trans "Materials" %}</span>
      </a>
      <a href="{% url 'inventory_wizard' project.id %}" class="nav-item">
        <i class="bi bi-box-seam"></i>
        <span class="nav-text">{% trans "Inventario" %}</span>
      </a>
      <a href="{% url 'pickup_view' project.id %}" class="nav-item">
        <i class="bi bi-bag-check"></i>
        <span class="nav-text">{% trans "Pickup" %}</span>
      </a>
      <a href="{% url 'issue_list' project.id %}" class="nav-item">
        <i class="bi bi-bug"></i>
        <span class="nav-text">{% trans "Issues" %}</span>
      </a>
      <a href="{% url 'risk_list' project.id %}" class="nav-item">
        <i class="bi bi-shield-exclamation"></i>
        <span class="nav-text">{% trans "Risks" %}</span>
      </a>
      
      <!-- Change Orders -->
      <div class="section-title">{% trans "Change Orders" %}</div>
      <a href="{% url 'changeorder_board' %}" class="nav-item">
        <i class="bi bi-kanban"></i>
        <span class="nav-text">{% trans "CO Board" %}</span>
      </a>
      <a href="{% url 'changeorder_create' %}" class="nav-item">
        <i class="bi bi-file-earmark-plus"></i>
        <span class="nav-text">{% trans "Nuevo CO" %}</span>
      </a>
      
      <!-- Comunicación -->
      <div class="section-title">{% trans "Comunicación" %}</div>
      <a href="{% url 'client_requests_list' project.id %}" class="nav-item">
        <i class="bi bi-people"></i>
        <span class="nav-text">{% trans "Client Requests" %}</span>
      </a>
      <a href="{% url 'task_list' project.id %}" class="nav-item">
        <i class="bi bi-check2-square"></i>
        <span class="nav-text">{% trans "Tareas" %}</span>
      </a>
      <a href="{% url 'project_chat_index' project.id %}" class="nav-item">
        <i class="bi bi-chat-dots"></i>
        <span class="nav-text">{% trans "Chat" %}</span>
      </a>
      
      <!-- Exports & Tools -->
      <div class="section-title">{% trans "Tools" %}</div>
      <a href="{% url 'estimate_create' project.id %}" class="nav-item">
        <i class="bi bi-calculator"></i>
        <span class="nav-text">{% trans "Estimates" %}</span>
      </a>
      <a href="{% url 'schedule_generator' project.id %}" class="nav-item">
        <i class="bi bi-magic"></i>
        <span class="nav-text">{% trans "Schedule Gen" %}</span>
      </a>
      <a href="{% url 'project_schedule_ics' project.id %}" class="nav-item" target="_blank">
        <i class="bi bi-calendar-event"></i>
        <span class="nav-text">{% trans "Export ICS" %}</span>
      </a>
      <a href="{% url 'project_pdf' project.id %}" class="nav-item" target="_blank">
        <i class="bi bi-file-pdf"></i>
        <span class="nav-text">{% trans "Export PDF" %}</span>
      </a>
      <a href="{% url 'project_edit' project.id %}" class="nav-item">
        <i class="bi bi-gear"></i>
        <span class="nav-text">{% trans "Settings" %}</span>
      </a>
    </nav>
    
    <!-- Collapse Toggle - sticky at bottom -->
    <div class="sidebar-collapse-toggle">
      <button onclick="toggleSidebar()" class="nav-item w-full justify-center" title="{% trans 'Colapsar menú' %}">
        <i class="bi bi-chevron-double-left" id="collapseIcon"></i>
        <span class="nav-text">{% trans "Colapsar" %}</span>
      </button>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="project-main flex-1 p-6 bg-slate-50" id="projectMain">
    <!-- Breadcrumbs -->
    <div class="flex items-center gap-2 text-sm text-slate-500 mb-4">
      <a href="{% url 'dashboard_admin' %}" class="hover:text-slate-700">{% trans "Dashboard" %}</a>
      <i class="bi bi-chevron-right text-xs"></i>
      <a href="{% url 'project_list' %}" class="hover:text-slate-700">{% trans "Projects" %}</a>
      <i class="bi bi-chevron-right text-xs"></i>
      <span class="text-slate-700">{{ project.name }}</span>
    </div>
    
    <!-- Project Header -->
    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-6">
      <div>
        <div class="flex items-center gap-3 mb-2">
          <h1 class="text-2xl font-bold text-slate-900">{{ project.name }}</h1>
          <!-- Language Toggle -->
          <div class="flex items-center gap-1 ml-4">
            <form method="post" action="{% url 'set_language' %}" class="inline">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.path }}" />
              <input type="hidden" name="language" value="es" />
              <button type="submit" class="px-2 py-1 rounded text-xs font-medium {% if LANGUAGE_CODE|lower == 'es' %}bg-indigo-600 text-white{% else %}bg-slate-200 text-slate-600 hover:bg-slate-300{% endif %}">ES</button>
            </form>
            <form method="post" action="{% url 'set_language' %}" class="inline">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.path }}" />
              <input type="hidden" name="language" value="en" />
              <button type="submit" class="px-2 py-1 rounded text-xs font-medium {% if LANGUAGE_CODE|lower == 'en' %}bg-indigo-600 text-white{% else %}bg-slate-200 text-slate-600 hover:bg-slate-300{% endif %}">EN</button>
            </form>
          </div>
        </div>
        <div class="flex items-center gap-2 text-slate-500 text-sm">
          <i class="bi bi-geo-alt"></i>
          <span>
            {% if project_info.address %}{{ project_info.address }}{% endif %}
            {% if project_info.city %}, {{ project_info.city }}{% endif %}
            {% if project_info.state %}, {{ project_info.state }}{% endif %}
            {% if project_info.zip %} {{ project_info.zip }}{% endif %}
          </span>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="flex items-center gap-2">
        <a href="{% url 'schedule_gantt_react' project.id %}" class="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm font-medium">
          <i class="bi bi-diagram-3"></i>
          {% trans "Abrir Gantt" %}
        </a>
        <button class="p-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition" title="{% trans 'Más opciones' %}">
          <i class="bi bi-three-dots"></i>
        </button>
      </div>
    </div>
    
    <!-- Progress Bar (from Gantt V2/V1) -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-medium text-slate-700">{% trans "Progreso del Proyecto" %}</span>
        <span class="text-sm font-bold text-slate-900">{% if gantt_progress.progress_percent %}{{ gantt_progress.progress_percent|floatformat:0 }}%{% else %}0%{% endif %}</span>
      </div>
      <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
        <div class="h-full bg-gradient-to-r from-green-500 to-emerald-500 rounded-full transition-all" style="width: {% if gantt_progress.progress_percent %}{{ gantt_progress.progress_percent|floatformat:0 }}{% else %}0{% endif %}%;"></div>
      </div>
      <div class="flex items-center justify-between mt-3 text-xs text-slate-500">
        <span><i class="bi bi-calendar-check"></i> {% trans "Inicio:" %} {% if project.start_date %}{{ project.start_date|date:"M d, Y" }}{% else %}—{% endif %}</span>
        <span><i class="bi bi-calendar-x"></i> {% trans "Fin:" %} {% if project.end_date %}{{ project.end_date|date:"M d, Y" }}{% else %}—{% endif %}</span>
      </div>
      {% if gantt_progress.total_items > 0 %}
      <div class="flex items-center gap-4 mt-3 text-xs">
        <span class="text-green-600"><i class="bi bi-check-circle-fill"></i> {{ gantt_progress.completed_items }} {% trans "completados" %}</span>
        <span class="text-blue-600"><i class="bi bi-arrow-repeat"></i> {{ gantt_progress.in_progress_items }} {% trans "en progreso" %}</span>
        <span class="text-slate-400"><i class="bi bi-circle"></i> {{ gantt_progress.planned_items }} {% trans "pendientes" %}</span>
      </div>
      {% endif %}
    </div>
    
    <!-- KPIs Grid -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow-sm p-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
            <i class="bi bi-arrow-up-circle text-green-600 text-xl"></i>
          </div>
          <div>
            <div class="text-xs text-slate-500">{% trans "Ingresos" %}</div>
            <div class="text-lg font-bold text-slate-900">${{ project.calculated_income|floatformat:0|default:"0" }}</div>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-red-100 flex items-center justify-center">
            <i class="bi bi-arrow-down-circle text-red-600 text-xl"></i>
          </div>
          <div>
            <div class="text-xs text-slate-500">{% trans "Gastos" %}</div>
            <div class="text-lg font-bold text-slate-900">${{ project.calculated_expenses|floatformat:0|default:"0" }}</div>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
            <i class="bi bi-cash-stack text-blue-600 text-xl"></i>
          </div>
          <div>
            <div class="text-xs text-slate-500">{% trans "Utilidad" %}</div>
            <div class="text-lg font-bold text-slate-900">${{ project.profit|floatformat:0|default:"0" }}</div>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center">
            <i class="bi bi-piggy-bank text-amber-600 text-xl"></i>
          </div>
          <div>
            <div class="text-xs text-slate-500">{% trans "Presupuesto Rest." %}</div>
            <div class="text-lg font-bold text-slate-900">${{ project.budget_remaining|floatformat:0|default:"0" }}</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Recent Activity -->
      <div class="bg-white rounded-xl shadow-sm">
        <div class="p-4 border-b border-slate-100">
          <h3 class="font-semibold text-slate-900 flex items-center gap-2">
            <i class="bi bi-calendar3 text-slate-400"></i>
            {% trans "Próximas Tareas del Gantt" %}
          </h3>
        </div>
        <div class="p-4 max-h-80 overflow-y-auto">
          {% if upcoming_gantt_items %}
            {% for item in upcoming_gantt_items|slice:":5" %}
            <div class="flex gap-3 py-2 {% if not forloop.last %}border-b border-slate-50{% endif %}">
              <div class="w-12 text-center flex-shrink-0">
                <div class="text-xs font-bold text-indigo-600">{{ item.start_date|date:"M" }}</div>
                <div class="text-lg font-bold text-slate-900">{{ item.start_date|date:"d" }}</div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-medium text-slate-900 truncate">{{ item.title }}</div>
                <div class="flex items-center gap-2 text-xs text-slate-500">
                  {% if item.phase_name %}
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium" style="background-color: {{ item.phase_color }}20; color: {{ item.phase_color }};">
                      {{ item.phase_name }}
                    </span>
                  {% endif %}
                  {% if item.is_milestone %}
                    <span class="text-amber-500"><i class="bi bi-flag-fill"></i> {% trans "Hito" %}</span>
                  {% endif %}
                </div>
              </div>
              <div class="flex-shrink-0 text-right">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium 
                  {% if item.status == 'done' %}bg-green-100 text-green-800
                  {% elif item.status == 'in_progress' %}bg-blue-100 text-blue-800
                  {% elif item.status == 'blocked' %}bg-red-100 text-red-800
                  {% else %}bg-slate-100 text-slate-600{% endif %}">
                  {{ item.progress }}%
                </span>
              </div>
            </div>
            {% endfor %}
          {% elif upcoming_schedules %}
            {# Fallback to calendar events if no Gantt items #}
            {% for s in upcoming_schedules|slice:":5" %}
            <div class="flex gap-3 py-2 {% if not forloop.last %}border-b border-slate-50{% endif %}">
              <div class="w-12 text-center flex-shrink-0">
                <div class="text-xs font-bold text-indigo-600">{{ s.start_datetime|date:"M" }}</div>
                <div class="text-lg font-bold text-slate-900">{{ s.start_datetime|date:"d" }}</div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-medium text-slate-900 truncate">{{ s.title }}</div>
                <div class="text-xs text-slate-500">{{ s.start_datetime|date:"H:i" }}</div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-8 text-slate-400">
              <i class="bi bi-calendar-x text-3xl mb-2 block"></i>
              <span class="text-sm">{% trans "Sin tareas próximas" %}</span>
              <a href="{% url 'schedule_gantt_react' project.id %}" class="block mt-2 text-indigo-600 hover:text-indigo-800 text-sm">
                <i class="bi bi-plus-circle"></i> {% trans "Crear en Gantt" %}
              </a>
            </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Quick Stats -->
      <div class="bg-white rounded-xl shadow-sm">
        <div class="p-4 border-b border-slate-100">
          <h3 class="font-semibold text-slate-900 flex items-center gap-2">
            <i class="bi bi-bar-chart text-slate-400"></i>
            {% trans "Estadísticas Rápidas" %}
          </h3>
        </div>
        <div class="p-4 grid grid-cols-2 gap-4">
          <a href="{% url 'schedule_gantt_react' project.id %}" class="text-center p-4 bg-slate-50 rounded-lg hover:bg-indigo-50 hover:shadow transition cursor-pointer block no-underline">
            <div class="text-3xl font-bold text-indigo-600">{{ gantt_progress.total_items|default:"0" }}</div>
            <div class="text-xs text-slate-500 mt-1">{% trans "Items Gantt" %}</div>
          </a>
          <a href="{% url 'task_list' project.id %}" class="text-center p-4 bg-slate-50 rounded-lg hover:bg-green-50 hover:shadow transition cursor-pointer block no-underline">
            <div class="text-3xl font-bold text-green-600">{{ recent_tasks|length|default:"0" }}</div>
            <div class="text-xs text-slate-500 mt-1">{% trans "Tareas Activas" %}</div>
          </a>
          <a href="{% url 'issue_list' project.id %}" class="text-center p-4 bg-slate-50 rounded-lg hover:bg-amber-50 hover:shadow transition cursor-pointer block no-underline">
            <div class="text-3xl font-bold text-amber-600">{{ open_issues|default:"0" }}</div>
            <div class="text-xs text-slate-500 mt-1">{% trans "Issues Abiertos" %}</div>
          </a>
          <a href="{% url 'changeorder_board' %}" class="text-center p-4 bg-slate-50 rounded-lg hover:bg-purple-50 hover:shadow transition cursor-pointer block no-underline">
            <div class="text-3xl font-bold text-purple-600">{{ pending_cos|default:"0" }}</div>
            <div class="text-xs text-slate-500 mt-1">{% trans "COs Pendientes" %}</div>
          </a>
        </div>
      </div>
    </div>
  </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ===== Desktop Sidebar Toggle =====
function toggleSidebar() {
  const sidebar = document.getElementById('projectSidebar');
  const main = document.getElementById('projectMain');
  const icon = document.getElementById('collapseIcon');
  
  sidebar.classList.toggle('collapsed');
  main.classList.toggle('expanded');
  
  if (sidebar.classList.contains('collapsed')) {
    icon.classList.remove('bi-chevron-double-left');
    icon.classList.add('bi-chevron-double-right');
  } else {
    icon.classList.remove('bi-chevron-double-right');
    icon.classList.add('bi-chevron-double-left');
  }
  
  // Save preference
  localStorage.setItem('projectSidebarCollapsed', sidebar.classList.contains('collapsed'));
}

// ===== Mobile Drawer Functions =====
function openMobileDrawer() {
  const drawer = document.getElementById('mobileDrawer');
  const overlay = document.getElementById('mobileDrawerOverlay');
  
  drawer.classList.add('open');
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden'; // Prevent background scroll
}

function closeMobileDrawer() {
  const drawer = document.getElementById('mobileDrawer');
  const overlay = document.getElementById('mobileDrawerOverlay');
  
  drawer.classList.remove('open');
  overlay.classList.remove('active');
  document.body.style.overflow = ''; // Restore scroll
}

// Close drawer on escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeMobileDrawer();
  }
});

// Close drawer when clicking a link inside
document.getElementById('mobileDrawer')?.querySelectorAll('a').forEach(link => {
  link.addEventListener('click', () => {
    // Small delay to allow navigation
    setTimeout(closeMobileDrawer, 100);
  });
});

// ===== Restore sidebar state on desktop =====
document.addEventListener('DOMContentLoaded', function() {
  const collapsed = localStorage.getItem('projectSidebarCollapsed') === 'true';
  if (collapsed) {
    document.getElementById('projectSidebar')?.classList.add('collapsed');
    document.getElementById('projectMain')?.classList.add('expanded');
    const icon = document.getElementById('collapseIcon');
    if (icon) {
      icon.classList.remove('bi-chevron-double-left');
      icon.classList.add('bi-chevron-double-right');
    }
  }
  
  // Mark active nav item based on current URL
  const currentPath = window.location.pathname;
  document.querySelectorAll('.nav-item, .nav-btn').forEach(item => {
    if (item.getAttribute('href') === currentPath) {
      item.classList.add('active');
    } else if (!item.getAttribute('href')?.includes('project_overview')) {
      item.classList.remove('active');
    }
  });
});
</script>
{% endblock %}
