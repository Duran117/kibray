{% extends "core/base.html" %}
{% load i18n %}

{% block title %}{% trans "Daily Plan Timeline" %}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">{% trans "Timeline" %}: {{ plan.plan_date }}</h2>
        <div>
            <a href="{% url 'daily_plan_detail' plan.id %}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i> {% trans "Back to Detail" %}</a>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-0">
            <div class="d-flex">
                <!-- Sidebar (Hierarchy) -->
                <div id="sidebar-container" style="width: 300px; border-right: 1px solid #ccc; background: #fff; z-index: 20;">
                    <div style="height: 30px; border-bottom: 1px solid #ccc; padding: 5px; font-weight: bold; background: #f8f9fa;">
                        {% trans "Activity" %}
                    </div>
                    <div id="sidebar-rows">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- Timeline -->
                <div id="timeline-wrapper" style="flex: 1; overflow-x: auto; position: relative;">
                    <div id="timeline-container" style="min-height: 600px; position: relative; background: #fafafa; min-width: 1500px;">
                        <!-- Time headers -->
                        <div id="time-header" style="display: flex; border-bottom: 1px solid #ccc; height: 30px; position: sticky; top: 0; background: #fff; z-index: 10;">
                            <!-- Generated by JS -->
                        </div>
                        
                        <!-- Activities -->
                        <div id="activities-container" style="position: relative; min-height: 500px;">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Activity Modal -->
<div class="modal fade" id="editActivityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Edit Activity" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editActivityForm">
                    <input type="hidden" id="edit-id">
                    <div class="mb-3">
                        <label class="form-label">{% trans "Title" %}</label>
                        <input type="text" class="form-control" id="edit-title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Description" %}</label>
                        <textarea class="form-control" id="edit-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{% trans "Status" %}</label>
                        <select class="form-select" id="edit-status">
                            <option value="PENDING">{% trans "Pending" %}</option>
                            <option value="IN_PROGRESS">{% trans "In Progress" %}</option>
                            <option value="COMPLETED">{% trans "Completed" %}</option>
                            <option value="BLOCKED">{% trans "Blocked" %}</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">{% trans "Start Time" %}</label>
                            <input type="time" class="form-control" id="edit-start">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">{% trans "End Time" %}</label>
                            <input type="time" class="form-control" id="edit-end">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                <button type="button" class="btn btn-primary" onclick="saveActivity()">{% trans "Save changes" %}</button>
            </div>
        </div>
    </div>
</div>

<style>
    .timeline-activity {
        position: absolute;
        height: 30px; /* Slightly smaller to fit rows */
        background-color: #3b82f6;
        color: white;
        border-radius: 4px;
        padding: 0 8px;
        font-size: 11px;
        display: flex;
        align-items: center;
        overflow: hidden;
        white-space: nowrap;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.1s;
        z-index: 5;
    }
    .timeline-activity:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 10;
    }
    .timeline-hour {
        flex: 0 0 100px; /* 100px per hour */
        border-right: 1px solid #eee;
        padding-left: 5px;
        font-size: 11px;
        color: #666;
    }
    .timeline-grid-line {
        position: absolute;
        top: 0;
        bottom: 0;
        border-right: 1px solid #f0f0f0;
        z-index: 0;
    }
    .sidebar-row {
        height: 40px;
        border-bottom: 1px solid #eee;
        padding: 0 10px;
        display: flex;
        align-items: center;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .timeline-row-bg {
        position: absolute;
        left: 0;
        right: 0;
        height: 40px;
        border-bottom: 1px solid #f5f5f5;
        z-index: 0;
    }
    .timeline-row-bg:nth-child(even) {
        background-color: #fcfcfc;
    }
</style>

<script>
    let editModal;
    
    document.addEventListener('DOMContentLoaded', function() {
        editModal = new bootstrap.Modal(document.getElementById('editActivityModal'));
        const activitiesRaw = {{ activities_json|safe }};
        const container = document.getElementById('activities-container');
        const header = document.getElementById('time-header');
        const sidebar = document.getElementById('sidebar-rows');
        
        // Config
        const startHour = 6; // 6 AM
        const endHour = 20; // 8 PM
        const pixelsPerHour = 100;
        const rowHeight = 40;
        
        // Render Header
        for (let h = startHour; h <= endHour; h++) {
            const div = document.createElement('div');
            div.className = 'timeline-hour';
            div.innerText = `${h}:00`;
            header.appendChild(div);
            
            // Grid line
            const line = document.createElement('div');
            line.className = 'timeline-grid-line';
            line.style.left = `${(h - startHour) * pixelsPerHour}px`;
            container.appendChild(line);
        }
        
        // Helper to parse time "HH:MM:SS"
        function parseTime(timeStr) {
            if (!timeStr) return null;
            const [h, m, s] = timeStr.split(':').map(Number);
            return h + m/60;
        }

        // Helper to format time "HH:MM"
        function formatTime(decimalTime) {
            const h = Math.floor(decimalTime);
            const m = Math.round((decimalTime - h) * 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:00`;
        }

        // Build Hierarchy
        function buildHierarchy(items) {
            const map = {};
            const roots = [];
            // First pass: create nodes
            items.forEach(a => {
                map[a.id] = { ...a, children: [] };
            });
            // Second pass: link parents
            items.forEach(a => {
                if (a.parent && map[a.parent]) {
                    map[a.parent].children.push(map[a.id]);
                } else {
                    roots.push(map[a.id]);
                }
            });
            return roots;
        }

        function flatten(nodes, depth = 0, result = []) {
            nodes.forEach(node => {
                result.push({ ...node, depth });
                if (node.children && node.children.length > 0) {
                    flatten(node.children, depth + 1, result);
                }
            });
            return result;
        }

        const rootNodes = buildHierarchy(activitiesRaw);
        const flatActivities = flatten(rootNodes);
        
        // Render Rows and Activities
        flatActivities.forEach((activity, index) => {
            // 1. Render Sidebar Row
            const rowDiv = document.createElement('div');
            rowDiv.className = 'sidebar-row';
            rowDiv.style.paddingLeft = `${activity.depth * 20 + 10}px`;
            
            // Icon based on children
            const icon = activity.children && activity.children.length > 0 ? '<i class="bi bi-caret-down-fill me-1"></i>' : '<i class="bi bi-circle-fill me-1" style="font-size: 6px;"></i>';
            rowDiv.innerHTML = `${icon} ${activity.title}`;
            sidebar.appendChild(rowDiv);

            // 2. Render Timeline Row Background
            const bgDiv = document.createElement('div');
            bgDiv.className = 'timeline-row-bg';
            bgDiv.style.top = `${index * rowHeight}px`;
            container.appendChild(bgDiv);

            // 3. Render Activity Bar (if it has time)
            if (activity.start_time && activity.end_time) {
                const start = parseTime(activity.start_time);
                const end = parseTime(activity.end_time);
                
                if (start >= startHour && start <= endHour) {
                    const duration = end - start;
                    const left = (start - startHour) * pixelsPerHour;
                    const width = duration * pixelsPerHour;
                    
                    const el = document.createElement('div');
                    el.className = 'timeline-activity';
                    el.style.left = `${left}px`;
                    el.style.width = `${Math.max(width, 20)}px`;
                    el.style.top = `${index * rowHeight + 5}px`; // Centered in row
                    el.innerText = activity.title;
                    el.title = `${activity.title} (${activity.start_time} - ${activity.end_time})`;
                    el.dataset.id = activity.id;
                    
                    // Drag and Drop Logic
                    let isDragging = false;
                    
                    el.onmousedown = function(e) {
                        e.preventDefault();
                        isDragging = false;
                        
                        let shiftX = e.clientX - el.getBoundingClientRect().left;
                        let startX = e.clientX;
                        
                        document.onmousemove = function(e) {
                            if (Math.abs(e.clientX - startX) > 5) isDragging = true;
                            
                            let newLeft = e.clientX - container.getBoundingClientRect().left - shiftX;
                            
                            // Snap to 15 mins (25px)
                            newLeft = Math.round(newLeft / 25) * 25;
                            
                            if (newLeft < 0) newLeft = 0;
                            
                            el.style.left = newLeft + 'px';
                        };
                        
                        document.onmouseup = function(e) {
                            document.onmousemove = null;
                            document.onmouseup = null;
                            
                            if (isDragging) {
                                // Calculate new time
                                const newLeft = parseFloat(el.style.left);
                                const newStartDecimal = (newLeft / pixelsPerHour) + startHour;
                                const newStartTime = formatTime(newStartDecimal);
                                const newEndTime = formatTime(newStartDecimal + duration);
                                
                                // Optimistic update
                                activity.start_time = newStartTime;
                                activity.end_time = newEndTime;
                                el.title = `${activity.title} (${newStartTime} - ${newEndTime})`;

                                // API Call
                                updateActivityTime(activity.id, newStartTime, newEndTime);
                            }
                        };
                    };
                    
                    // Edit on Double Click
                    el.ondblclick = function() {
                        openEditModal(activity);
                    };

                    container.appendChild(el);
                }
            }
        });

        function updateActivityTime(id, start, end) {
            fetch(`/api/v1/planned-activities/${id}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    start_time: start,
                    end_time: end
                })
            })
            .then(response => {
                if (!response.ok) {
                    alert('Failed to update activity time');
                }
            });
        }
    });
    
    function openEditModal(activity) {
        document.getElementById('edit-id').value = activity.id;
        document.getElementById('edit-title').value = activity.title;
        document.getElementById('edit-description').value = activity.description || '';
        document.getElementById('edit-status').value = activity.status;
        document.getElementById('edit-start').value = activity.start_time ? activity.start_time.substring(0, 5) : '';
        document.getElementById('edit-end').value = activity.end_time ? activity.end_time.substring(0, 5) : '';
        
        editModal.show();
    }
    
    function saveActivity() {
        const id = document.getElementById('edit-id').value;
        const data = {
            title: document.getElementById('edit-title').value,
            description: document.getElementById('edit-description').value,
            status: document.getElementById('edit-status').value,
            start_time: document.getElementById('edit-start').value,
            end_time: document.getElementById('edit-end').value
        };
        
        fetch(`/api/v1/planned-activities/${id}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (response.ok) {
                location.reload(); // Reload to reflect changes
            } else {
                alert('Failed to save activity');
            }
        });
    }
</script>
{% endblock %}
