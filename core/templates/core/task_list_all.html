{% extends 'core/base.html' %}
{% load i18n %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div>
      <h2 class="mb-0"><i class="bi bi-kanban"></i> {% trans 'Tareas por proyecto' %}</h2>
      <small class="text-muted">{% trans 'Explora, asigna y edita tareas desde un solo lugar.' %}</small>
    </div>
  </div>

  {% if tasks %}
    {% regroup tasks by project as project_list %}
    <div class="row g-3">
      {% for proj in project_list %}
      <div class="col-12 col-md-6 col-xl-4">
        <div class="card h-100 shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-semibold">{{ proj.grouper.name|default:_('Sin proyecto') }}</div>
              <div class="small text-muted">{% blocktrans count counter=proj.list|length %}{{ counter }} tarea{% plural %}{{ counter }} tareas{% endblocktrans %}</div>
            </div>
            <div class="btn-group">
              {% if proj.grouper %}
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'task_list' proj.grouper.id %}">
                <i class="bi bi-columns-gap"></i> {% trans 'Tablero' %}
              </a>
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'touchup_board' proj.grouper.id %}">
                <i class="bi bi-brush"></i>
              </a>
              {% endif %}
            </div>
          </div>
          <div class="card-body p-0">
            <div class="list-group list-group-flush">
              {% for t in proj.list %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="me-2">
                    <div class="fw-semibold">{{ t.title }}</div>
                    <div class="small text-muted">
                      {% trans 'ID' %}: #{{ t.id }} • {% trans 'Estado' %}: {{ t.status|default:_('—') }}
                      {% if t.assigned_to %} • {% trans 'Asignada a' %}: {{ t.assigned_to.get_full_name|default:t.assigned_to.username }}{% endif %}
                    </div>
                  </div>
                  <span class="badge text-bg-light">{{ t.priority|default:_('N/A') }}</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <div class="small text-muted">
                    {% if t.due_date %}<i class="bi bi-calendar-event"></i> {{ t.due_date }}{% endif %}
                    {% if t.dependencies.all %}
                      {% with deps=t.dependencies.all %}
                        {% if deps|length %}
                          • <i class="bi bi-link-45deg"></i> {% trans 'Dependencias' %}: {{ deps|join:", " }}
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  </div>
                  <div class="btn-group btn-group-sm">
                    <a class="btn btn-outline-primary" href="{% url 'task_detail' t.id %}"><i class="bi bi-eye"></i></a>
                    {% if can_manage %}
                      <a class="btn btn-outline-secondary" href="{% url 'task_edit' t.id %}" title="{% trans 'Asignar / Editar' %}"><i class="bi bi-person-plus"></i></a>
                      <a class="btn btn-outline-danger" href="{% url 'task_delete' t.id %}"><i class="bi bi-trash"></i></a>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
          {% if can_manage and proj.grouper %}
          <div class="card-footer text-end">
            <a class="btn btn-sm btn-primary" href="{% url 'task_list' proj.grouper.id %}">
              <i class="bi bi-plus-circle"></i> {% trans 'Nueva tarea' %}
            </a>
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
  <div class="text-center py-5">
    <i class="bi bi-inbox display-1 text-muted"></i>
    <h4 class="mt-3">{% trans 'Aún no tienes tareas asignadas' %}</h4>
    <p class="text-muted">{% trans 'Cuando tu PM te asigne tareas aparecerán aquí.' %}</p>
  </div>
  {% endif %}
</div>
{% endblock %}