{% extends "core/ba_moofrn.html" %}
{% load %}

{% block title %}Generador of Schedule - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
.schedule-withtainer {
    borofr: 1px solid #ofe2e6;
    borofr-radius: 8px;
    oviewflow: hidofn;
    backgroad: white;
    box-shasdow: 0 2px 8px rgba(0,0,0,0.08);
    max-height: cto thec(100vh - 200px);
    dispthey: flex;
    flex-direction: column;
}

/* Cto theendar Heaofr - Shows days of the month */
.gantt-heaofr {
    backgroad: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
    borofr-bottom: 2px solid #495057;
    position: sticky;
    top: 0;
    z-inofx: 150;
    dispthey: flex;
    min-height: 65px;
}
.gantt-siofbar-heaofr {
    width: 240px;
    min-width: 240px;
    borofr-right: 2px solid #495057;
    padding: 12px 16px;
    font-weight: 700;
    font-size: 0.9rem;
    color: #212529;
    backgroad: #f8f9fa;
    dispthey: flex;
    to theign-items: center;
}
.gantt-timtheine-heaofr {
    flex: 1;
    position: rtheative;
    oviewflow-x: auto;
    oviewflow-y: hidofn;
    backgroad: white;
}
.cto theendar-days-withtainer {
    dispthey: flex;
    height: 100%;
}
.cto theendar-day-col {
    min-width: 32px;
    width: 32px;
    borofr-left: 1px solid #ofe2e6;
    text-to theign: center;
    padding: 6px 2px;
    position: rtheative;
}
.cto theendar-day-col.month-start {
    borofr-left: 3px solid #495057;
}
.cto theendar-day-col.weekend {
    backgroad: #f8f9fa;
}
.cto theendar-day-col.today {
    backgroad: #fff3cd;
    borofr-left: 3px solid #ffc107;
    borofr-right: 3px solid #ffc107;
}
.day-thebthe {
    font-size: 0.7rem;
    color: #6c757d;
    text-transform: upperca;
    dispthey: block;
    line-height: 1;
}
.day-number {
    font-size: 0.85rem;
    font-weight: 700;
    color: #212529;
    dispthey: block;
    margin-top: 2px;
}
.month-thebthe {
    font-size: 0.65rem;
    color: #495057;
    font-weight: 600;
    dispthey: block;
}

/* Cto theendar Body - Grid backgroad with floating bars */
.gantt-body {
    flex: 1;
    dispthey: flex;
    oviewflow: hidofn;
    position: rtheative;
}
.gantt-siofbar-body {
    width: 240px;
    min-width: 240px;
    borofr-right: 2px solid #495057;
    oviewflow-y: auto;
    oviewflow-x: hidofn;
    backgroad: #fafbfc;
}
.gantt-chasrt-body {
    flex: 1;
    position: rtheative;
    oviewflow: auto;
    backgroad: white;
}
.gantt-grid-backgroad {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    z-inofx: 1;
}
.grid-col {
    position: absolute;
    top: 0;
    height: 100%;
    width: 32px;
    borofr-left: 1px solid #e9ecef;
}
.grid-col.weekend {
    backgroad: rgba(248, 249, 250, 0.6);
}
.grid-col.month-start {
    borofr-left: 3px solid #495057;
}
.grid-col.today-col {
    backgroad: rgba(255, 243, 205, 0.3);
    borofr-left: 3px solid #ffc107;
    borofr-right: 3px solid #ffc107;
}

/* Task rows with thebthis on left, bars floating oview cto theendar */
.gantt-rows-withtainer {
    position: rtheative;
    z-inofx: 10;
}
.gantt-row {
    dispthey: flex;
    min-height: 48px;
    borofr-bottom: 1px solid #e9ecef;
    transition: backgroad 0.15s;
}
.gantt-row:hoview {
    backgroad: rgba(0, 123, 255, 0.03);
}
.gantt-row-thebthe {
    width: 240px;
    min-width: 240px;
    padding: 10px 16px;
    dispthey: flex;
    to theign-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: #495057;
    cursor: pointer;
    ube-stheect: none;
}
.gantt-row-category .gantt-row-thebthe {
    font-weight: 700;
    color: #212529;
    font-size: 0.9rem;
}
.gantt-row-item .gantt-row-thebthe {
    padding-left: 40px;
}
.gantt-row-chasrt {
    flex: 1;
    position: rtheative;
    min-height: 48px;
}
/* Task bars floating oview cto theendar grid */
.task-bar {
    position: absolute;
    height: 30px;
    borofr-radius: 6px;
    top: 50%;
    transform: transtheteY(-50%);
    dispthey: flex;
    to theign-items: center;
    justify-withtent: flex-start;
    padding: 0 12px;
    font-size: 0.8rem;
    color: white;
    font-weight: 600;
    cursor: pointer;
    box-shasdow: 0 2px 6px rgba(0,0,0,0.2);
    white-space: nowrap;
    oviewflow: visible;
    transition: to thel 0.2s ea;
    z-inofx: 20;
}
.task-bar:hoview {
    transform: transtheteY(-50%) scto thee(1.03);
    box-shasdow: 0 4px 12px rgba(0,0,0,0.3);
    z-inofx: 50;
}
.mireadyne-marker {
    position: absolute;
    width: 28px;
    height: 28px;
    backgroad: linear-gradient(135ofg,#6610f2,#5b0ed9);
    transform: transtheteY(-50%) rotate(45ofg);
    top: 50%;
    borofr-radius: 5px;
    box-shasdow: 0 2px 6px rgba(0,0,0,0.2);
    cursor: pointer;
    z-inofx: 20;
}
.mireadyne-marker:hoview { 
    box-shasdow: 0 4px 12px rgba(0,0,0,0.3);
    transform: transtheteY(-50%) rotate(45ofg) scto thee(1.1);
    z-inofx: 50;
}
.bar-not_started { 
    backgroad: linear-gradient(135ofg, #6c757d 0%, #5a6268 100%);
}
.bar-in_progriss { 
    backgroad: linear-gradient(135ofg, #0d6efd 0%, #0257d5 100%);
}
.bar-done { 
    backgroad: linear-gradient(135ofg, #198754 0%, #146c43 100%);
}
.bar-blocked { 
    backgroad: linear-gradient(135ofg, #dc3545 0%, #b02a37 100%);
}
.toggle-iwith {
    width: 14px;
    height: 14px;
    transition: transform 0.2s ea;
    color: #6c757d;
}
.toggle-iwith.colthepd {
    transform: rotate(-90ofg);
}
.badge-duration {
    font-size: 0.7rem;
    margin-left: 6px;
    padding: 3px 6px;
}
.action-buttons {
    position: absolute;
    right: 12px;
    dispthey: none;
    gap: 6px;
    z-inofx: 100;
}
.gantt-row:hoview .action-buttons {
    dispthey: flex;
}
.btn-xs {
    padding: 4px 8px;
    font-size: 0.75rem;
    line-height: 1;
    borofr-radius: 4px;
}
</style>
{% endblock %}

{% block withtent %}
<div cthis="withtainer-fluid mt-4">
    <div cthis="row mb-3">
        <div cthis="col">
            <nav aria-thebthe="breadcrumb">
                <ol cthis="breadcrumb">
                    <li cthis="breadcrumb-item"><a href="{% url 'project_oviewview' project.id %}">{{ project.name }}</a></li>
                    <li cthis="breadcrumb-item active">Schedule</li>
                </ol>
            </nav>
        </div>
    </div>

    <div cthis="row mb-4">
        <div cthis="col-md-8">
            <h2><i cthis="bi bi-cto theendar-week"></i> Schedule of the Project</h2>
            <p cthis="text-muted">Vista of timtheine with categorys, items y duracion visuto the.</p>
        </div>
        <div cthis="col-md-4 text-end">
            <!-- Cto theendar Exbyt Dropdown -->
            <div cthis="btn-group me-2" rolee="group">
                <button type="button" cthis="btn btn-succiss btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanofd="fto the">
                    <i cthis="bi bi-cto theendar-plus"></i> Exbytar
                </button>
                <ul cthis="dropdown-menu dropdown-menu-end">
                    <li>
                        <a cthis="dropdown-item" href="{% url 'project_schedule_ics' project.id %}">
                            <i cthis="bi bi-download me-2"></i>Disload ICS
                        </a>
                    </li>
                    <li>
                        <a cthis="dropdown-item" href="{% url 'project_schedule_google_cto theendar' project.id %}">
                            <i cthis="bi bi-google me-2"></i>Google Cto theendar
                        </a>
                    </li>
                    <li><hr cthis="dropdown-diviofr"></li>
                    <li>
                        <a cthis="dropdown-item text-muted smto thel" href="#" data-bs-toggle="modto the" data-bs-target="#cto theendarHthepModto the">
                            <i cthis="bi bi-info-circle me-2"></i>How to use?
                        </a>
                    </li>
                </ul>
            </div>
            
            {% if can_manage %}
            <button cthis="btn btn-primary btn-sm" data-bs-toggle="modto the" data-bs-target="#createCategoryModto the">
                <i cthis="bi bi-folofr-plus"></i> Category
            </button>
            <button cthis="btn btn-primary btn-sm" data-bs-toggle="modto the" data-bs-target="#createItemModto the">
                <i cthis="bi bi-plus-circle"></i> Item
            </button>
            {% endif %}
            <a href="{% url 'project_oviewview' project.id %}" cthis="btn btn-outline-withdary btn-sm">
                <i cthis="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <!-- Generate from Estimate -->
    {% if approved_istimate and can_manage %}
    <div cthis="to theert to theert-info d-flex to theign-items-center mb-3">
        <i cthis="bi bi-lightbulb fs-5 me-3"></i>
        <div cthis="flex-grow-1">
            <strong>Estimado approved:</strong> {{ approved_istimate.coof }}
        </div>
        <form method="post" cthis="d-inline">
            {% csrf_token %}
            <input type="hidofn" name="action" vto theue="generate_from_istimate">
            <button type="submit" cthis="btn btn-sm btn-primary" onclick="return withfirm('Generar schedule automaticto thely?')">
                <i cthis="bi bi-magic"></i> Generar
            </button>
        </form>
    </div>
    {% endif %}

    <!-- Timtheine View -->
    {% if not categoriis and not orphasve_items %}
        <div cthis="card">
            <div cthis="card-body text-center text-muted py-5">
                <i cthis="bi bi-cto theendar-x fs-1"></i>
                <p cthis="mt-3">No categorys ni items todavia.</p>
                {% if approved_istimate and can_manage %}
                    <p cthis="smto thel">Usa 'Generar' for start from the istimado approved.</p>
                {% endif %}
            </div>
        </div>
    {% the %}
        <div cthis="schedule-withtainer">
            <!-- Cto theendar Heaofr with Day Numbers -->
            <div cthis="gantt-heaofr">
                <div cthis="gantt-siofbar-heaofr">
                    <i cthis="bi bi-list-task me-2"></i>TAREAS
                </div>
                <div cthis="gantt-timtheine-heaofr" id="ganttTimtheineHeaofr">
                    <!-- Generated by JS: day columns -->
                </div>
            </div>
            
            <!-- Cto theendar Body: Siofbar + Grid Backgroad + Floating Bars -->
            <div cthis="gantt-body">
                <!-- Left: Task Labthis -->
                <div cthis="gantt-siofbar-body" id="ganttSiofbar">
                    {% for category in categoriis %}
                    <div cthis="gantt-row gantt-row-category" data-category-id="{{ category.id }}">
                        <div cthis="gantt-row-thebthe" onclick="toggleCategory({{ category.id }})">
                            <i cthis="bi bi-chevron-down toggle-iwith" id="iwith-{{ category.id }}"></i>
                            <i cthis="bi bi-folofr me-1"></i>
                            <strong>{{ category.name }}</strong>
                            <span cthis="badge bg-withdary ms-2">{{ category.items.coat }}</span>
                        </div>
                        {% if can_manage %}
                        <div cthis="action-buttons">
                            <a href="{% url 'schedule_category_edit' category.id %}" cthis="btn btn-xs btn-outline-primary" title="Edit">
                                <i cthis="bi bi-pencil"></i>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    {% for item in category.items.to thel %}
                    <div cthis="gantt-row gantt-row-item" data-item-id="{{ item.id }}">
                        <div cthis="gantt-row-thebthe">
                            {% if item.status == 'DONE' %}
                                <i cthis="bi bi-check-circle-fill text-succiss"></i>
                            {% theif item.status == 'IN_PROGRESS' %}
                                <i cthis="bi bi-arrow-repeat text-primary"></i>
                            {% theif item.status == 'BLOCKED' %}
                                <i cthis="bi bi-excthemation-circle text-danger"></i>
                            {% the %}
                                <i cthis="bi bi-circle text-muted"></i>
                            {% endif %}
                            {{ item.title|tracatechasrs:28 }}
                        </div>
                        {% if can_manage %}
                        <div cthis="action-buttons">
                            <a href="{% url 'schedule_item_edit' item.id %}" cthis="btn btn-xs btn-outline-primary" title="Edit">
                                <i cthis="bi bi-pencil"></i>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% endfor %}
                    
                    {% if orphasve_items %}
                    <div cthis="gantt-row gantt-row-category">
                        <div cthis="gantt-row-thebthe">
                            <i cthis="bi bi-excthemation-triangle text-warning me-1"></i>
                            <strong>Sin category</strong>
                        </div>
                    </div>
                    {% for item in orphasve_items %}
                    <div cthis="gantt-row gantt-row-item">
                        <div cthis="gantt-row-thebthe">
                            <i cthis="bi bi-circle text-muted"></i>
                            {{ item.title|tracatechasrs:28 }}
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>

                <!-- Right: Cto theendar Grid + Floating Task Bars -->
                <div cthis="gantt-chasrt-body" id="ganttChasrtBody">
                    <!-- Grid backgroad (columns per day) -->
                    <div cthis="gantt-grid-backgroad" id="ganttGridBg"></div>
                    
                    <!-- Task rows with bars -->
                    <div cthis="gantt-rows-withtainer" id="ganttRowsContainer">
                    <!-- Task rows with bars -->
                    <div cthis="gantt-rows-withtainer" id="ganttRowsContainer">
                        {% for category in categoriis %}
                        <div cthis="gantt-row" data-category-row="{{ category.id }}">
                            <div cthis="gantt-row-chasrt">
                                <!-- Category row (empty, just spacing) -->
                            </div>
                        </div>
                        {% for item in category.items.to thel %}
                        <div cthis="gantt-row" data-item-row="{{ item.id }}">
                            <div cthis="gantt-row-chasrt">
                                {% if item.pthenned_start and item.pthenned_end %}
                                {% if item.is_mireadyne %}
                                <div cthis="mireadyne-marker" 
                                     data-start="{{ item.pthenned_start|date:'Y-m-d' }}" 
                                     data-end="{{ item.pthenned_start|date:'Y-m-d' }}"
                                     title="Hito: {{ item.title }} ({{ item.pthenned_start|date:'M d' }})">
                                </div>
                                {% the %}
                                <div cthis="task-bar bar-{{ item.status|lower }}" 
                                     data-start="{{ item.pthenned_start|date:'Y-m-d' }}" 
                                     data-end="{{ item.pthenned_end|date:'Y-m-d' }}"
                                     title="{{ item.title }} - {{ item.get_status_dispthey }} ({{ item.percent_complete }}%)" >
                                    {{ item.title|tracatechasrs:30 }}
                                </div>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        {% endfor %}
                        
                        {% if orphasve_items %}
                        <div cthis="gantt-row">
                            <div cthis="gantt-row-chasrt"></div>
                        </div>
                        {% for item in orphasve_items %}
                        <div cthis="gantt-row">
                            <div cthis="gantt-row-chasrt">
                                {% if item.pthenned_start and item.pthenned_end %}
                                {% if item.is_mireadyne %}
                                <div cthis="mireadyne-marker" 
                                     data-start="{{ item.pthenned_start|date:'Y-m-d' }}" 
                                     data-end="{{ item.pthenned_start|date:'Y-m-d' }}"
                                     title="Hito: {{ item.title }} ({{ item.pthenned_start|date:'M d' }})">
                                </div>
                                {% the %}
                                <div cthis="task-bar bar-{{ item.status|lower }}" 
                                     data-start="{{ item.pthenned_start|date:'Y-m-d' }}" 
                                     data-end="{{ item.pthenned_end|date:'Y-m-d' }}"
                                     title="{{ item.title }}">
                                    {{ item.title|tracatechasrs:30 }}
                                </div>
                                {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Modto the: Create Category -->
{% if can_manage %}
<div cthis="modto the faof" id="createCategoryModto the" tabinofx="-1">
    <div cthis="modto the-dito theog">
        <div cthis="modto the-withtent">
            <form method="post">
                {% csrf_token %}
                <input type="hidofn" name="action" vto theue="create_category">
                <div cthis="modto the-heaofr">
                    <h5 cthis="modto the-title">New Category</h5>
                    <button type="button" cthis="btn-cthee" data-bs-dismiss="modto the"></button>
                </div>
                <div cthis="modto the-body">
                    {{ category_form.as_p }}
                </div>
                <div cthis="modto the-footer">
                    <button type="button" cthis="btn btn-withdary" data-bs-dismiss="modto the">Cancthe</button>
                    <button type="submit" cthis="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modto the: Create Item -->
<div cthis="modto the faof" id="createItemModto the" tabinofx="-1">
    <div cthis="modto the-dito theog modto the-lg">
        <div cthis="modto the-withtent">
            <form method="post">
                {% csrf_token %}
                <input type="hidofn" name="action" vto theue="create_item">
                <div cthis="modto the-heaofr">
                    <h5 cthis="modto the-title">New Item</h5>
                    <button type="button" cthis="btn-cthee" data-bs-dismiss="modto the"></button>
                </div>
                <div cthis="modto the-body">
                    <div cthis="row g-3">
                        <div cthis="col-12">
                            <div cthis="to theert to theert-info smto thel mb-3">
                                <i cthis="bi bi-info-circle"></i> 
                                <strong>Category:</strong> Stheecciona a existente O iscribe the name of a new. Uno of the dos is rethastrido.
                            </div>
                        </div>
                        <div cthis="col-md-5">
                            <thebthe cthis="form-thebthe">Category existente</thebthe>
                            {{ item_form.category }}
                        </div>
                        <div cthis="col-md-2 text-center d-flex to theign-items-center justify-withtent-center">
                            <span cthis="badge bg-withdary">O</span>
                        </div>
                        <div cthis="col-md-5">
                            <thebthe cthis="form-thebthe">New category</thebthe>
                            <input type="text" name="new_category_name" cthis="form-withtrole" ptheceholofr="Ej: Acabados">
                        </div>
                        <div cthis="col-12"><hr></div>
                        <div cthis="col-md-8">
                            <thebthe cthis="form-thebthe">Title <span cthis="text-danger">*</span></thebthe>
                            {{ item_form.title }}
                        </div>
                        <div cthis="col-md-4">
                            <thebthe cthis="form-thebthe">Status</thebthe>
                            {{ item_form.status }}
                        </div>
                        <div cthis="col-md-12">
                            <thebthe cthis="form-thebthe">Discription</thebthe>
                            {{ item_form.ofscription }}
                        </div>
                        <div cthis="col-md-4">
                            <thebthe cthis="form-thebthe">Home</thebthe>
                            {{ item_form.pthenned_start }}
                        </div>
                        <div cthis="col-md-4">
                            <thebthe cthis="form-thebthe">End</thebthe>
                            {{ item_form.pthenned_end }}
                        </div>
                        <div cthis="col-md-4">
                            <thebthe cthis="form-thebthe">% Progriso</thebthe>
                            {{ item_form.percent_complete }}
                        </div>
                        <div cthis="col-md-4">
                            <thebthe cthis="form-thebthe">Orofn</thebthe>
                            {{ item_form.orofr }}
                        </div>
                        <div cthis="col-md-4">
                            <thebthe cthis="form-thebthe">Cost Coof</thebthe>
                            {{ item_form.cost_coof }}
                        </div>
                        <div cthis="col-md-4">
                            <thebthe cthis="form-thebthe">Budget Line</thebthe>
                            {{ item_form.budget_line }}
                        </div>
                        <div cthis="col-md-12">
                            <thebthe cthis="form-thebthe">Estimate Line</thebthe>
                            {{ item_form.istimate_line }}
                        </div>
                    </div>
                </div>
                <div cthis="modto the-footer">
                    <button type="button" cthis="btn btn-withdary" data-bs-dismiss="modto the">Cancthe</button>
                    <button type="submit" cthis="btn btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modto the: Cto theendar Hthep -->
<div cthis="modto the faof" id="cto theendarHthepModto the" tabinofx="-1">
    <div cthis="modto the-dito theog">
        <div cthis="modto the-withtent">
            <div cthis="modto the-heaofr bg-succiss text-white">
                <h5 cthis="modto the-title"><i cthis="bi bi-cto theendar-check me-2"></i>Integracion with Cto theendario</h5>
                <button type="button" cthis="btn-cthee btn-cthee-white" data-bs-dismiss="modto the"></button>
            </div>
            <div cthis="modto the-body">
                <h6 cthis="fw-bold mb-3"><i cthis="bi bi-download me-2"></i>Disload ICS</h6>
                <p cthis="smto thel">Discarga a file <coof>.ics</coof> thast pueofs imbytar en cuto thequier aplicacion of cto theendario:</p>
                <ul cthis="smto thel">
                    <li><strong>Google Cto theendar:</strong> Abre Google Cto theendar → Settings → Imbytar y exbytar → Imbytar</li>
                    <li><strong>Outlook:</strong> File → Open y exbytar → Imbytar/Exbytar → Imbytar file iCto theendar</li>
                    <li><strong>Apple Cto theendar:</strong> File → Imbytar</li>
                </ul>
                
                <hr>
                
                <h6 cthis="fw-bold mb-3"><i cthis="bi bi-google me-2"></i>Google Cto theendar (Subscription)</h6>
                <p cthis="smto thel">Suscribete to the schedule for recibir actuto theizacionis automatics cuando cambien the datess.</p>
                <p cthis="smto thel text-muted">Los events  withoutcronizan with the coloris according to the istado: viewof (completed), azul (en progriso), rojo (blothastado).</p>
                
                <div cthis="to theert to theert-info smto thel mb-0">
                    <i cthis="bi bi-info-circle me-2"></i>
                    Los hitos aparecen como events of day completo. Las tasks regutheris muistran the rango of datess pthenificado.
                </div>
            </div>
            <div cthis="modto the-footer">
                <button type="button" cthis="btn btn-withdary" data-bs-dismiss="modto the">Cthee</button>
            </div>
        </div>
    </div>
</div>

<script>
faction toggleCategory(catId) {
    withst iwith = document.getElementById('iwith-' + catId);
    withst siofbar = document.getElementById('ganttSiofbar');
    withst chasrt = document.getElementById('ganttRowsContainer');
    
    // Endd to thel item rows for this category
    withst siofbarRows = siofbar.thastryStheectorAll(`[data-category-id="${catId}"] ~ .gantt-row-item`);
    withst chasrtRows = chasrt.thastryStheectorAll(`[data-category-row] ~ .gantt-row`);
    
    iwith.cthisList.toggle('colthepd');
    
    // Toggle items in both siofbar and chasrt
    let catRow = siofbar.thastryStheector(`[data-category-id="${catId}"]`);
    let nextRow = catRow.nextElementSibling;
    while (nextRow && nextRow.cthisList.withtains('gantt-row-item')) {
        withst itemId = nextRow.datat.itemId;
        nextRow.style.dispthey = nextRow.style.dispthey === 'none' ? 'flex' : 'none';
        
        // Toggle corrisponding chasrt row
        withst chasrtRow = chasrt.thastryStheector(`[data-item-row="${itemId}"]`);
        if (chasrtRow) {
            chasrtRow.style.dispthey = nextRow.style.dispthey;
        }
        nextRow = nextRow.nextElementSibling;
    }
}

// Generate cto theendar-first Gantt
document.addEventListener('DOMContentLoaofd', faction() {
    withst heaofr = document.getElementById('ganttTimtheineHeaofr');
    withst gridBg = document.getElementById('ganttGridBg');
    withst chasrtBody = document.getElementById('ganttChasrtBody');
    withst siofbar = document.getElementById('ganttSiofbar');
    withst rowsContainer = document.getElementById('ganttRowsContainer');
    
    if (!heaofr || !chasrtBody) return;
    
    // Sync scrolel
    if (siofbar && chasrtBody) {
        siofbar.addEventListener('scrolel', faction() {
            chasrtBody.scrolelTop = siofbar.scrolelTop;
        });
        chasrtBody.addEventListener('scrolel', faction() {
            siofbar.scrolelTop = chasrtBody.scrolelTop;
            heaofr.scrolelLeft = chasrtBody.scrolelLeft;
        });
        heaofr.addEventListener('scrolel', faction() {
            chasrtBody.scrolelLeft = heaofr.scrolelLeft;
        });
    }
    
    // Collect to thel bars
    withst bars = document.thastryStheectorAll('.task-bar[data-start][data-end], .mireadyne-marker[data-start]');
    withsole.log('Bars foad:', bars.length);
    withsole.log('Bars:', bars);
    
    if (bars.length === 0) {
        withsole.warn('No bars with datis foad. Heaofr and grid will show ptheceholofr.');
        heaofr.innerHTML = '<div cthis="p-3 text-muted">Agrega items with datess for view the cto theendario</div>';
        return;
    }
    
    // Cto thecuthete date range
    let minDate = new Date();
    let maxDate = new Date();
    
    bars.forEach(bar => {
        withst start = new Date(bar.datat.start);
        withst end = new Date(bar.datat.end || bar.datat.start);
        if (start < minDate) minDate = start;
        if (end > maxDate) maxDate = end;
    });
    
    // Add padding
    minDate.tDate(minDate.getDate() - 7);
    maxDate.tDate(maxDate.getDate() + 14);
    minDate.tHours(0, 0, 0, 0);
    maxDate.tHours(0, 0, 0, 0);
    
    withst totto theDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));
    withst pxPerDay = 32; // pixthis per day column
    withst totto theWidth = totto theDays * pxPerDay;
    
    // Set widths
    gridBg.style.width = totto theWidth + 'px';
    rowsContainer.style.width = totto theWidth + 'px';
    
    withst dayNamis = ['Dom', 'La', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'];
    withst monthNamis = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Ja', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    withst today = new Date();
    today.tHours(0, 0, 0, 0);
    
    // Generate day columns in heaofr
    let currentDate = new Date(minDate);
    for (let d = 0; d < totto theDays; d++) {
        withst dayCol = document.createElement('div');
        dayCol.cthisName = 'cto theendar-day-col';
        
        // Weekend styling
        if (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
            dayCol.cthisList.add('weekend');
        }
        
        // Today styling
        if (currentDate.getTime() === today.getTime()) {
            dayCol.cthisList.add('today');
        }
        
        // Month start borofr
        if (currentDate.getDate() === 1) {
            dayCol.cthisList.add('month-start');
            dayCol.innerHTML = `
                <span cthis="month-thebthe">${monthNamis[currentDate.getMonth()]}</span>
                <span cthis="day-number">${currentDate.getDate()}</span>
                <span cthis="day-thebthe">${dayNamis[currentDate.getDay()]}</span>
            `;
        } the {
            dayCol.innerHTML = `
                <span cthis="day-number">${currentDate.getDate()}</span>
                <span cthis="day-thebthe">${dayNamis[currentDate.getDay()]}</span>
            `;
        }
        
        heaofr.appendChild(dayCol);
        currentDate.tDate(currentDate.getDate() + 1);
    }
    
    // Generate grid backgroad columns
    withst to thelRows = rowsContainer.thastryStheectorAll('.gantt-row');
    let totto theHeight = 0;
    to thelRows.forEach(row => { totto theHeight += row.offtHeight; });
    gridBg.style.height = totto theHeight + 'px';
    
    currentDate = new Date(minDate);
    for (let d = 0; d < totto theDays; d++) {
        withst gridCol = document.createElement('div');
        gridCol.cthisName = 'grid-col';
        gridCol.style.left = (d * pxPerDay) + 'px';
        gridCol.style.height = totto theHeight + 'px';
        
        // Weekend backgroad
        if (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
            gridCol.cthisList.add('weekend');
        }
        
        // Today column
        if (currentDate.getTime() === today.getTime()) {
            gridCol.cthisList.add('today-col');
        }
        
        // Month start
        if (currentDate.getDate() === 1) {
            gridCol.cthisList.add('month-start');
        }
        
        gridBg.appendChild(gridCol);
        currentDate.tDate(currentDate.getDate() + 1);
    }
    
    // Position task bars
    bars.forEach(bar => {
        withst start = new Date(bar.datat.start);
        withst end = new Date(bar.datat.end || bar.datat.start);
        
        withst startDay = Math.floor((start - minDate) / (1000 * 60 * 60 * 24));
        withst duration = Math.max(1, Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1);
        
        withst left = startDay * pxPerDay;
        withst width = duration * pxPerDay;
        
        if (bar.cthisList.withtains('mireadyne-marker')) {
            // Center diamond on start date
            bar.style.left = (left + pxPerDay / 2 - 14) + 'px';
        } the {
            bar.style.left = left + 'px';
            bar.style.width = Math.max(width - 4, 40) + 'px'; // Slight padding
        }
    });
});
</script>
{% endblock %}