{% extends "core/base_modern.html" %}
{% load static %}
{% load core_extras %}

{% block title %}Touch-ups - {{ plan.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'project_list' %}">Proyectos</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'project_overview' project.id %}">{{ project.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'touchup_plans_list' project.id %}">Planos Touch-up</a></li>
                    <li class="breadcrumb-item active">{{ plan.name }}</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-brush"></i> {{ plan.name }}
                    </h2>
                    {% if plan.level_identifier %}
                    <p class="text-muted mb-0">{{ plan.level_identifier }}</p>
                    {% endif %}
                </div>
                <div>
                    {% if can_create %}
                    <button type="button" class="btn btn-primary" id="createTouchupBtn">
                        <i class="bi bi-plus-circle"></i> Nuevo Touch-up
                    </button>
                    {% endif %}
                    <a href="{% url 'touchup_plans_list' project.id %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Floor Plan View -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Plano con Touch-ups</h5>
                    <small class="text-muted">Haz clic en el plano para agregar un touch-up</small>
                </div>
                <div class="card-body p-0">
                    {% if plan.image %}
                    <div id="planContainer" class="position-relative" style="width: 100%; background: #f8f9fa;">
                        <img id="floorPlanImage" 
                             src="{{ plan.image.url }}" 
                             alt="{{ plan.name }}"
                             class="img-fluid w-100"
                             style="display: block; cursor: crosshair;">
                        
                        <!-- Touchup Pins -->
                        {% for touchup in touchups %}
                        <div class="touchup-pin position-absolute"
                             data-touchup-id="{{ touchup.id }}"
                             data-status="{{ touchup.status }}"
                             style="left: {{ touchup.x|mul:100 }}%; 
                                    top: {{ touchup.y|mul:100 }}%;
                                    transform: translate(-50%, -100%);">
                            <div class="pin-marker 
                                {% if touchup.status == 'completed' %}bg-success
                                {% elif touchup.status == 'in_progress' %}bg-info
                                {% else %}bg-danger
                                {% endif %}"
                                 data-bs-toggle="tooltip" 
                                 title="{{ touchup.task_name }}">
                                <i class="bi bi-brush-fill text-white"></i>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-5 text-center text-muted">
                        <i class="bi bi-file-earmark-image" style="font-size: 4rem;"></i>
                        <p class="mt-3">No hay imagen de plano disponible</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Instructions -->
            <div class="card border-0 shadow-sm mt-3">
                <div class="card-body">
                    <h6 class="mb-2"><i class="bi bi-info-circle"></i> Instrucciones</h6>
                    <ul class="mb-0 small text-muted">
                        <li><strong>PM/Admin:</strong> Haz clic en el plano para agregar un touch-up, asigna a un empleado</li>
                        <li><strong>Empleado:</strong> Haz clic en el pin para ver detalles y completar el trabajo</li>
                        <li><strong>Al completar:</strong> Sube una foto del trabajo terminado</li>
                        <li>Los touch-ups completados desaparecen automáticamente y se guardan en el historial</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Touch-ups List -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Touch-ups ({{ touchups.count }})</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% if touchups %}
                        {% for touchup in touchups %}
                        <div class="touchup-item border-start border-4 
                            {% if touchup.status == 'completed' %}border-success
                            {% elif touchup.status == 'in_progress' %}border-info
                            {% else %}border-danger
                            {% endif %} 
                            p-3 mb-3 bg-light rounded-end cursor-pointer"
                            data-touchup-id="{{ touchup.id }}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">{{ touchup.task_name }}</h6>
                                <span class="badge 
                                    {% if touchup.status == 'completed' %}bg-success
                                    {% elif touchup.status == 'in_progress' %}bg-info
                                    {% else %}bg-warning text-dark
                                    {% endif %}">
                                    {{ touchup.get_status_display }}
                                </span>
                            </div>
                            
                            {% if touchup.description %}
                            <p class="text-muted small mb-2">{{ touchup.description|truncatewords:15 }}</p>
                            {% endif %}
                            
                            <div class="small text-muted">
                                {% if touchup.assigned_to %}
                                <div><i class="bi bi-person"></i> {{ touchup.assigned_to.get_full_name|default:touchup.assigned_to.username }}</div>
                                {% else %}
                                <div><i class="bi bi-person-x"></i> Sin asignar</div>
                                {% endif %}
                                
                                {% if touchup.approved_color %}
                                <div><i class="bi bi-palette"></i> {{ touchup.approved_color.name }}</div>
                                {% elif touchup.custom_color_name %}
                                <div><i class="bi bi-palette"></i> {{ touchup.custom_color_name }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary view-touchup-btn" 
                                        data-touchup-id="{{ touchup.id }}">
                                    <i class="bi bi-eye"></i> Ver Detalles
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-brush" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">No hay touch-ups en este plano</p>
                            {% if can_create %}
                            <p class="small">Haz clic en el plano para agregar uno</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Touch-up Detail Modal -->
<div class="modal fade" id="touchupDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="touchupModalTitle">Detalles del Touch-up</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="touchupModalBody">
                <!-- Content loaded via AJAX -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Touch-up Modal -->
<div class="modal fade" id="createTouchupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Nuevo Touch-up</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createTouchupForm" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="plan" value="{{ plan.id }}">
                <input type="hidden" id="touchup_x" name="x">
                <input type="hidden" id="touchup_y" name="y">
                
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        Haz clic en el plano para seleccionar la ubicación del touch-up
                    </div>
                    
                    <div id="coordinatePreview" class="alert alert-success d-none">
                        <i class="bi bi-pin-map"></i> 
                        Ubicación seleccionada: <span id="coordText"></span>
                    </div>
                    
                    <!-- Form fields will be loaded here -->
                    <div id="touchupFormFields"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submitTouchupBtn" disabled>
                        <i class="bi bi-plus-circle"></i> Crear Touch-up
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.pin-marker {
    width: 32px;
    height: 32px;
    border-radius: 50% 50% 50% 0;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    cursor: pointer;
    transition: transform 0.2s;
    transform: rotate(-45deg);
}
.pin-marker:hover {
    transform: rotate(-45deg) scale(1.1);
}
.pin-marker i {
    transform: rotate(45deg);
    font-size: 14px;
}
.touchup-item {
    cursor: pointer;
    transition: transform 0.2s;
}
.touchup-item:hover {
    transform: translateX(5px);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedX = null;
    let selectedY = null;
    const planImg = document.getElementById('floorPlanImage');
    const planContainer = document.getElementById('planContainer');
    const createModal = new bootstrap.Modal(document.getElementById('createTouchupModal'));
    const detailModal = new bootstrap.Modal(document.getElementById('touchupDetailModal'));
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
    
    // Click on plan to add touchup
    {% if can_create %}
    planImg.addEventListener('click', function(e) {
        const rect = planImg.getBoundingClientRect();
        selectedX = ((e.clientX - rect.left) / rect.width).toFixed(4);
        selectedY = ((e.clientY - rect.top) / rect.height).toFixed(4);
        
        document.getElementById('touchup_x').value = selectedX;
        document.getElementById('touchup_y').value = selectedY;
        document.getElementById('coordText').textContent = `X: ${(selectedX * 100).toFixed(1)}%, Y: ${(selectedY * 100).toFixed(1)}%`;
        document.getElementById('coordinatePreview').classList.remove('d-none');
        document.getElementById('submitTouchupBtn').disabled = false;
        
        createModal.show();
    });
    {% endif %}
    
    // View touchup details
    document.querySelectorAll('.view-touchup-btn, .touchup-pin').forEach(el => {
        el.addEventListener('click', function(e) {
            e.stopPropagation();
            const touchupId = this.dataset.touchupId;
            loadTouchupDetails(touchupId);
        });
    });
    
    function loadTouchupDetails(touchupId) {
        const modalBody = document.getElementById('touchupModalBody');
        modalBody.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
        detailModal.show();
        
        fetch(`/touchups/${touchupId}/`)
            .then(response => response.json())
            .then(data => {
                renderTouchupDetails(data);
            })
            .catch(error => {
                modalBody.innerHTML = '<div class="alert alert-danger">Error cargando detalles</div>';
            });
    }
    
    function renderTouchupDetails(touchup) {
        const statusBadges = {
            'pending': 'warning text-dark',
            'in_progress': 'info',
            'completed': 'success',
            'archived': 'secondary'
        };
        
        let html = `
            <div class="row">
                <div class="col-md-6">
                    <h5>${touchup.task_name}</h5>
                    <span class="badge bg-${statusBadges[touchup.status]}">${touchup.status_display}</span>
                </div>
                <div class="col-md-6 text-end">
                    ${touchup.can_close ? `
                        <button class="btn btn-success btn-sm" onclick="completeTouchup(${touchup.id})">
                            <i class="bi bi-check-circle"></i> Completar
                        </button>
                    ` : ''}
                    ${touchup.can_edit ? `
                        <button class="btn btn-danger btn-sm" onclick="deleteTouchup(${touchup.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    ` : ''}
                </div>
            </div>
            
            <hr>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <p class="mb-1"><strong>Asignado a:</strong></p>
                    <p>${touchup.assigned_to || 'Sin asignar'}</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>Creado por:</strong></p>
                    <p>${touchup.created_by || '-'}</p>
                </div>
            </div>
            
            ${touchup.description ? `
                <div class="mb-3">
                    <p class="mb-1"><strong>Descripción:</strong></p>
                    <p>${touchup.description}</p>
                </div>
            ` : ''}
            
            ${touchup.approved_color || touchup.custom_color_name ? `
                <div class="mb-3">
                    <p class="mb-1"><strong>Color:</strong></p>
                    <p>${touchup.approved_color || touchup.custom_color_name}</p>
                </div>
            ` : ''}
            
            ${touchup.sheen ? `
                <div class="mb-3">
                    <p class="mb-1"><strong>Brillo:</strong></p>
                    <p>${touchup.sheen}</p>
                </div>
            ` : ''}
            
            ${touchup.details ? `
                <div class="mb-3">
                    <p class="mb-1"><strong>Detalles:</strong></p>
                    <p>${touchup.details}</p>
                </div>
            ` : ''}
            
            ${touchup.completion_photos.length > 0 ? `
                <div class="mb-3">
                    <p class="mb-1"><strong>Fotos de Finalización:</strong></p>
                    <div class="row g-2">
                        ${touchup.completion_photos.map(photo => `
                            <div class="col-6">
                                <img src="${photo.url}" class="img-fluid rounded" alt="Completion photo">
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${touchup.status === 'completed' ? `
                <hr>
                <div class="mb-3">
                    <p class="mb-1"><strong>Estado de Aprobación:</strong></p>
                    ${touchup.approval_status === 'approved' ? `
                        <div class="alert alert-success mb-0">
                            <i class="bi bi-check-circle"></i> Aprobado
                            ${touchup.reviewed_by ? ` por ${touchup.reviewed_by}` : ''}
                            ${touchup.reviewed_at ? ` el ${new Date(touchup.reviewed_at).toLocaleDateString()}` : ''}
                        </div>
                    ` : touchup.approval_status === 'rejected' ? `
                        <div class="alert alert-danger mb-0">
                            <i class="bi bi-x-circle"></i> Rechazado
                            ${touchup.reviewed_by ? ` por ${touchup.reviewed_by}` : ''}
                            ${touchup.reviewed_at ? ` el ${new Date(touchup.reviewed_at).toLocaleDateString()}` : ''}
                            ${touchup.rejection_reason ? `
                                <hr class="my-2">
                                <strong>Razón:</strong> ${touchup.rejection_reason}
                            ` : ''}
                        </div>
                    ` : `
                        <span class="badge bg-warning text-dark">
                            <i class="bi bi-clock"></i> Pendiente de Revisión
                        </span>
                        ${touchup.can_approve ? `
                            <div class="mt-3">
                                <button class="btn btn-success btn-sm me-2" onclick="approveTouchup(${touchup.id})">
                                    <i class="bi bi-check-circle"></i> Aprobar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="rejectTouchup(${touchup.id})">
                                    <i class="bi bi-x-circle"></i> Rechazar
                                </button>
                            </div>
                        ` : ''}
                    `}
                </div>
            ` : ''}
        `;
        
        document.getElementById('touchupModalBody').innerHTML = html;
    }
    
    // Create touchup form submission
    document.getElementById('createTouchupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch(`/plans/{{ plan.id }}/touchups/create/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        });
    });
});

function completeTouchup(touchupId) {
    // Show completion modal
    const modal = new bootstrap.Modal(document.getElementById('completeTouchupModal'));
    document.getElementById('completeTouchupId').value = touchupId;
    document.getElementById('completionPhotoPreview').innerHTML = '';
    modal.show();
}

function deleteTouchup(touchupId) {
    if (confirm('¿Eliminar este touch-up?')) {
        fetch(`/touchups/${touchupId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}

async function approveTouchup(touchupId) {
    if (!confirm('¿Aprobar este touch-up?')) return;
    
    // Show loading state
    const modalBody = document.getElementById('touchupModalBody');
    const originalContent = modalBody.innerHTML;
    modalBody.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2">Aprobando...</p></div>';
    
    try {
        const response = await fetch(`/touchups/${touchupId}/approve/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Reload the touch-up details
            loadTouchupDetails(touchupId);
        } else {
            modalBody.innerHTML = originalContent;
            alert('Error: ' + (data.error || 'No se pudo aprobar'));
        }
    } catch (error) {
        modalBody.innerHTML = originalContent;
        alert('Error de conexión');
    }
}

async function rejectTouchup(touchupId) {
    const reason = prompt('Indica la razón del rechazo:');
    if (!reason || reason.trim() === '') return;
    
    // Show loading state
    const modalBody = document.getElementById('touchupModalBody');
    const originalContent = modalBody.innerHTML;
    modalBody.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-danger"></div><p class="mt-2">Rechazando...</p></div>';
    
    try {
        const response = await fetch(`/touchups/${touchupId}/reject/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `reason=${encodeURIComponent(reason)}`
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Reload the touch-up details
            loadTouchupDetails(touchupId);
        } else {
            modalBody.innerHTML = originalContent;
            alert('Error: ' + (data.error || 'No se pudo rechazar'));
        }
    } catch (error) {
        modalBody.innerHTML = originalContent;
        alert('Error de conexión');
    }
}

// Handle photo selection for completion
document.addEventListener('DOMContentLoaded', function() {
    const photoInput = document.getElementById('completionPhotos');
    if (photoInput) {
        photoInput.addEventListener('change', function(e) {
            const files = e.target.files;
            const preview = document.getElementById('completionPhotoPreview');
            preview.innerHTML = '';
            
            if (files.length > 0) {
                document.getElementById('annotatePhotosBtn').disabled = false;
                
                Array.from(files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const col = document.createElement('div');
                        col.className = 'col-md-4 mb-3';
                        col.innerHTML = `
                            <div class="card">
                                <img src="${e.target.result}" class="card-img-top" alt="Photo ${index + 1}">
                                <div class="card-body p-2 text-center">
                                    <small class="text-muted">${file.name}</small>
                                </div>
                            </div>
                        `;
                        preview.appendChild(col);
                    };
                    reader.readAsDataURL(file);
                });
            } else {
                document.getElementById('annotatePhotosBtn').disabled = true;
            }
        });
    }
});

// Handle touch-up completion submission
document.getElementById('completeTouchupForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const touchupId = document.getElementById('completeTouchupId').value;
    const formData = new FormData(this);
    
    // Show loading
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Completando...';
    submitBtn.disabled = true;
    
    fetch(`/touchups/${touchupId}/complete/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        alert('Error completando touch-up');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});
</script>

<!-- Complete Touch-up Modal -->
<div class="modal fade" id="completeTouchupModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle"></i> Completar Touch-up
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="completeTouchupForm" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" id="completeTouchupId" name="touchup_id">
                
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Importante:</strong> Debes subir al menos una foto mostrando el trabajo completado.
                        Puedes anotar las fotos para resaltar áreas específicas.
                    </div>
                    
                    <!-- Photo Upload -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-camera"></i> Fotos de Finalización *
                        </label>
                        <input type="file" 
                               class="form-control" 
                               id="completionPhotos"
                               name="photos" 
                               accept="image/*" 
                               multiple 
                               required>
                        <div class="form-text">
                            Selecciona una o más fotos. Puedes agregar anotaciones después.
                        </div>
                    </div>
                    
                    <!-- Photo Preview -->
                    <div class="row" id="completionPhotoPreview"></div>
                    
                    <!-- Annotate Button -->
                    <div class="mb-4 text-center">
                        <button type="button" 
                                class="btn btn-primary" 
                                id="annotatePhotosBtn"
                                data-bs-toggle="modal"
                                data-bs-target="#photoAnnotationModal"
                                disabled>
                            <i class="bi bi-pencil-square"></i> Anotar Fotos
                        </button>
                        <div class="form-text">
                            Opcional: Agrega flechas, círculos o texto a las fotos para resaltar detalles
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-chat-text"></i> Notas de Finalización
                        </label>
                        <textarea class="form-control" 
                                  name="notes" 
                                  rows="3"
                                  placeholder="Describe el trabajo realizado, materiales usados, observaciones, etc..."></textarea>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Marcar como Completado
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Photo Annotation Modal -->
<div class="modal fade" id="photoAnnotationModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square"></i> Anotar Fotos de Finalización
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div id="annotationEditors"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="bi bi-check"></i> Guardar Anotaciones
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'core/js/photo-annotator.js' %}"></script>

<script>
// Handle photo annotation
document.getElementById('annotatePhotosBtn')?.addEventListener('click', function() {
    const files = document.getElementById('completionPhotos').files;
    const container = document.getElementById('annotationEditors');
    container.innerHTML = '';
    
    Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const canvasId = `annotationCanvas${index}`;
            
            const editorDiv = document.createElement('div');
            editorDiv.className = 'mb-5';
            editorDiv.innerHTML = `
                <h5 class="mb-3">Foto ${index + 1}: ${file.name}</h5>
                <div class="card">
                    <div class="card-body">
                        <!-- Toolbar -->
                        <div class="mb-3">
                            <div class="row g-2 align-items-center">
                                <div class="col-auto">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary tool-btn active" data-canvas="${canvasId}" data-tool="brush">
                                            <i class="bi bi-brush"></i> Pincel
                                        </button>
                                        <button type="button" class="btn btn-outline-primary tool-btn" data-canvas="${canvasId}" data-tool="arrow">
                                            <i class="bi bi-arrow-up-right"></i> Flecha
                                        </button>
                                        <button type="button" class="btn btn-outline-primary tool-btn" data-canvas="${canvasId}" data-tool="rectangle">
                                            <i class="bi bi-square"></i> Rectángulo
                                        </button>
                                        <button type="button" class="btn btn-outline-primary tool-btn" data-canvas="${canvasId}" data-tool="circle">
                                            <i class="bi bi-circle"></i> Círculo
                                        </button>
                                        <button type="button" class="btn btn-outline-primary tool-btn" data-canvas="${canvasId}" data-tool="text">
                                            <i class="bi bi-fonts"></i> Texto
                                        </button>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <input type="color" class="form-control form-control-sm form-control-color" id="color${index}" value="#ff0000" style="width: 60px;">
                                </div>
                                <div class="col-auto">
                                    <input type="range" class="form-range" id="width${index}" min="1" max="10" value="3" style="width: 120px;">
                                    <small id="widthDisplay${index}">3px</small>
                                </div>
                                <div class="col-auto ms-auto">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.annotator${index}.undo()">
                                        <i class="bi bi-arrow-counterclockwise"></i> Deshacer
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="window.annotator${index}.clear()">
                                        <i class="bi bi-trash"></i> Limpiar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Canvas -->
                        <div class="text-center" style="background: #f8f9fa; padding: 20px;">
                            <canvas id="${canvasId}"></canvas>
                        </div>
                        
                        <input type="hidden" id="annotations${index}" name="annotations_${index}">
                    </div>
                </div>
            `;
            
            container.appendChild(editorDiv);
            
            // Initialize annotator
            const annotator = new PhotoAnnotator(canvasId, e.target.result, null);
            annotator.init().then(() => {
                window[`annotator${index}`] = annotator;
                
                // Setup controls
                document.querySelectorAll(`[data-canvas="${canvasId}"]`).forEach(btn => {
                    btn.addEventListener('click', function() {
                        const tool = this.getAttribute('data-tool');
                        document.querySelectorAll(`[data-canvas="${canvasId}"]`).forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        if (tool === 'text') {
                            annotator.addText();
                        } else {
                            annotator.setTool(tool);
                        }
                    });
                });
                
                document.getElementById(`color${index}`).addEventListener('change', function() {
                    annotator.setColor(this.value);
                });
                
                document.getElementById(`width${index}`).addEventListener('input', function() {
                    annotator.setBrushWidth(parseInt(this.value));
                    document.getElementById(`widthDisplay${index}`).textContent = this.value + 'px';
                });
                
                // Save annotations periodically
                setInterval(() => {
                    document.getElementById(`annotations${index}`).value = annotator.getAnnotations();
                }, 2000);
            });
        };
        reader.readAsDataURL(file);
    });
});
</script>

{% endblock %}
