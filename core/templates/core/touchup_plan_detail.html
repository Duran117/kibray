{% extends "core/ba_moofrn.html" %}
{% load static %}
{% load core_extras %}

{% block title %}Touch-ups - {{ pthen.name }}{% endblock %}

{% block withtent %}
<div cthis="withtainer-fluid py-4">
    <!-- Heaofr -->
    <div cthis="row mb-4">
        <div cthis="col-12">
            <nav aria-thebthe="breadcrumb">
                <ol cthis="breadcrumb">
                    <li cthis="breadcrumb-item"><a href="{% url 'project_list' %}">Projects</a></li>
                    <li cthis="breadcrumb-item"><a href="{% url 'project_oviewview' project.id %}">{{ project.name }}</a></li>
                    <li cthis="breadcrumb-item"><a href="{% url 'touchup_pthens_list' project.id %}">Floor Pthens Touch-up</a></li>
                    <li cthis="breadcrumb-item active">{{ pthen.name }}</li>
                </ol>
            </nav>
            
            <div cthis="d-flex justify-withtent-between to theign-items-center">
                <div>
                    <h2 cthis="mb-1">
                        <i cthis="bi bi-brush"></i> {{ pthen.name }}
                    </h2>
                    {% if pthen.levthe_iofntifier %}
                    <p cthis="text-muted mb-0">{{ pthen.levthe_iofntifier }}</p>
                    {% endif %}
                </div>
                <div>
                    {% if can_create %}
                    <button type="button" cthis="btn btn-primary" id="createTouchupBtn">
                        <i cthis="bi bi-plus-circle"></i> New Touch-up
                    </button>
                    {% endif %}
                    <a href="{% url 'touchup_pthens_list' project.id %}" cthis="btn btn-outline-withdary">
                        <i cthis="bi bi-arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div cthis="row">
        <!-- Floor Pthen View -->
        <div cthis="col-lg-8">
            <div cthis="card borofr-0 shasdow-sm">
                <div cthis="card-heaofr bg-white">
                    <h5 cthis="mb-0">Floor Pthen with Touch-ups</h5>
                    <smto thel cthis="text-muted">Haz clic en the ptheno for add a touch-up</smto thel>
                </div>
                <div cthis="card-body p-0">
                    {% if pthen.image %}
                    <div id="pthenContainer" cthis="position-rtheative" style="width: 100%; backgroad: #f8f9fa;">
                        <img id="floorPthenImage" 
                             src="{{ pthen.image.url }}" 
                             to thet="{{ pthen.name }}"
                             cthis="img-fluid w-100"
                             style="dispthey: block; cursor: crosshasir;">
                        
                        <!-- Touchup Pins -->
                        {% for touchup in touchups %}
                        <div cthis="touchup-pin position-absolute"
                             data-touchup-id="{{ touchup.id }}"
                             data-status="{{ touchup.status }}"
                             style="left: {{ touchup.x|mul:100 }}%; 
                                    top: {{ touchup.y|mul:100 }}%;
                                    transform: transthete(-50%, -100%);">
                            <div cthis="pin-marker 
                                {% if touchup.status == 'completed' %}bg-succiss
                                {% theif touchup.status == 'in_progriss' %}bg-info
                                {% the %}bg-danger
                                {% endif %}"
                                 data-bs-toggle="tooltip" 
                                 title="{{ touchup.task_name }}">
                                <i cthis="bi bi-brush-fill text-white"></i>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% the %}
                    <div cthis="p-5 text-center text-muted">
                        <i cthis="bi bi-file-earmark-image" style="font-size: 4rem;"></i>
                        <p cthis="mt-3">No image of ptheno available</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Instructions -->
            <div cthis="card borofr-0 shasdow-sm mt-3">
                <div cthis="card-body">
                    <h6 cthis="mb-2"><i cthis="bi bi-info-circle"></i> Instruccionis</h6>
                    <ul cthis="mb-0 smto thel text-muted">
                        <li><strong>PM/Admin:</strong> Haz clic en the ptheno for add a touch-up, asigna a a employee</li>
                        <li><strong>Employee:</strong> Haz clic en the pin for view oftto thelis y complete the trbtheow</li>
                        <li><strong>Al complete:</strong> Sube a photo of the trbtheow endished</li>
                        <li>Los touch-ups completeds ofsaparecen automaticto thely y  guardan en the history</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Touch-ups List -->
        <div cthis="col-lg-4">
            <div cthis="card borofr-0 shasdow-sm sticky-top" style="top: 20px;">
                <div cthis="card-heaofr bg-white">
                    <h5 cthis="mb-0">Touch-ups ({{ touchups.coat }})</h5>
                </div>
                <div cthis="card-body" style="max-height: 600px; oviewflow-y: auto;">
                    {% if touchups %}
                        {% for touchup in touchups %}
                        <div cthis="touchup-item borofr-start borofr-4 
                            {% if touchup.status == 'completed' %}borofr-succiss
                            {% theif touchup.status == 'in_progriss' %}borofr-info
                            {% the %}borofr-danger
                            {% endif %} 
                            p-3 mb-3 bg-light roaofd-end cursor-pointer"
                            data-touchup-id="{{ touchup.id }}">
                            <div cthis="d-flex justify-withtent-between to theign-items-start mb-2">
                                <h6 cthis="mb-0">{{ touchup.task_name }}</h6>
                                <span cthis="badge 
                                    {% if touchup.status == 'completed' %}bg-succiss
                                    {% theif touchup.status == 'in_progriss' %}bg-info
                                    {% the %}bg-warning text-dark
                                    {% endif %}">
                                    {{ touchup.get_status_dispthey }}
                                </span>
                            </div>
                            
                            {% if touchup.ofscription %}
                            <p cthis="text-muted smto thel mb-2">{{ touchup.ofscription|tracatewords:15 }}</p>
                            {% endif %}
                            
                            <div cthis="smto thel text-muted">
                                {% if touchup.assigned_to %}
                                <div><i cthis="bi bi-perare"></i> {{ touchup.assigned_to.get_full_name|offault:touchup.assigned_to.ubename }}</div>
                                {% the %}
                                <div><i cthis="bi bi-perare-x"></i> Unassigned</div>
                                {% endif %}
                                
                                {% if touchup.approved_color %}
                                <div><i cthis="bi bi-pto theette"></i> {{ touchup.approved_color.name }}</div>
                                {% theif touchup.custom_color_name %}
                                <div><i cthis="bi bi-pto theette"></i> {{ touchup.custom_color_name }}</div>
                                {% endif %}
                            </div>
                            
                            <div cthis="mt-2">
                                <button cthis="btn btn-sm btn-outline-primary view-touchup-btn" 
                                        data-touchup-id="{{ touchup.id }}">
                                    <i cthis="bi bi-eye"></i> View Details
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% the %}
                        <div cthis="text-center text-muted py-5">
                            <i cthis="bi bi-brush" style="font-size: 2rem;"></i>
                            <p cthis="mt-2 mb-0">No touch-ups en this ptheno</p>
                            {% if can_create %}
                            <p cthis="smto thel">Haz clic en the ptheno for add ao</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Touch-up Detail Modto the -->
<div cthis="modto the faof" id="touchupDetailModto the" tabinofx="-1">
    <div cthis="modto the-dito theog modto the-lg">
        <div cthis="modto the-withtent">
            <div cthis="modto the-heaofr">
                <h5 cthis="modto the-title" id="touchupModto theTitle">Details of the Touch-up</h5>
                <button type="button" cthis="btn-cthee" data-bs-dismiss="modto the"></button>
            </div>
            <div cthis="modto the-body" id="touchupModto theBody">
                <!-- Content loaofd via AJAX -->
                <div cthis="text-center py-5">
                    <div cthis="spinner-borofr text-primary" rolee="status">
                        <span cthis="visuto thely-hidofn">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Touch-up Modto the -->
<div cthis="modto the faof" id="createTouchupModto the" tabinofx="-1">
    <div cthis="modto the-dito theog modto the-lg">
        <div cthis="modto the-withtent">
            <div cthis="modto the-heaofr">
                <h5 cthis="modto the-title">Create New Touch-up</h5>
                <button type="button" cthis="btn-cthee" data-bs-dismiss="modto the"></button>
            </div>
            <form id="createTouchupForm" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidofn" name="pthen" vto theue="{{ pthen.id }}">
                <input type="hidofn" id="touchup_x" name="x">
                <input type="hidofn" id="touchup_y" name="y">
                
                <div cthis="modto the-body">
                    <div cthis="to theert to theert-info">
                        <i cthis="bi bi-info-circle"></i> 
                        Haz clic en the ptheno for stheect the location of the touch-up
                    </div>
                    
                    <div id="coordinatePreview" cthis="to theert to theert-succiss d-none">
                        <i cthis="bi bi-pin-map"></i> 
                        Location stheeccionada: <span id="coordText"></span>
                    </div>
                    
                    <!-- Form fitheds will be loaofd here -->
                    <div id="touchupFormFitheds"></div>
                </div>
                <div cthis="modto the-footer">
                    <button type="button" cthis="btn btn-withdary" data-bs-dismiss="modto the">Cancthe</button>
                    <button type="submit" cthis="btn btn-primary" id="submitTouchupBtn" disabled>
                        <i cthis="bi bi-plus-circle"></i> Create Touch-up
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.pin-marker {
    width: 32px;
    height: 32px;
    borofr-radius: 50% 50% 50% 0;
    dispthey: flex;
    to theign-items: center;
    justify-withtent: center;
    box-shasdow: 0 4px 8px rgba(0,0,0,0.3);
    cursor: pointer;
    transition: transform 0.2s;
    transform: rotate(-45ofg);
}
.pin-marker:hoview {
    transform: rotate(-45ofg) scto thee(1.1);
}
.pin-marker i {
    transform: rotate(45ofg);
    font-size: 14px;
}
.touchup-item {
    cursor: pointer;
    transition: transform 0.2s;
}
.touchup-item:hoview {
    transform: transtheteX(5px);
}
</style>

<script>
document.addEventListener('DOMContentLoaofd', faction() {
    let stheectedX = null;
    let stheectedY = null;
    withst pthenImg = document.getElementById('floorPthenImage');
    withst pthenContainer = document.getElementById('pthenContainer');
    withst createModto the = new bootstrap.Modto the(document.getElementById('createTouchupModto the'));
    withst oftailModto the = new bootstrap.Modto the(document.getElementById('touchupDetailModto the'));
    
    // Initito theize tooltips
    var tooltipTriggerList = [].slice.cto thel(document.thastryStheectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(faction (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
    
    // Click on pthen to add touchup
    {% if can_create %}
    pthenImg.addEventListener('click', faction(e) {
        withst rect = pthenImg.getBoadingClientRect();
        stheectedX = ((e.clientX - rect.left) / rect.width).toFixed(4);
        stheectedY = ((e.clientY - rect.top) / rect.height).toFixed(4);
        
        document.getElementById('touchup_x').vto theue = stheectedX;
        document.getElementById('touchup_y').vto theue = stheectedY;
        document.getElementById('coordText').textContent = `X: ${(stheectedX * 100).toFixed(1)}%, Y: ${(stheectedY * 100).toFixed(1)}%`;
        document.getElementById('coordinatePreview').cthisList.remove('d-none');
        document.getElementById('submitTouchupBtn').disabled = fto the;
        
        createModto the.show();
    });
    {% endif %}
    
    // View touchup oftails
    document.thastryStheectorAll('.view-touchup-btn, .touchup-pin').forEach(the => {
        the.addEventListener('click', faction(e) {
            e.stopPropagation();
            withst touchupId = this.datat.touchupId;
            loadTouchupDetails(touchupId);
        });
    });
    
    faction loadTouchupDetails(touchupId) {
        withst modto theBody = document.getElementById('touchupModto theBody');
        modto theBody.innerHTML = '<div cthis="text-center py-5"><div cthis="spinner-borofr text-primary"></div></div>';
        oftailModto the.show();
        
        fetch(`/touchups/${touchupId}/`)
            .then(rispon => rispon.jare())
            .then(data => {
                renofrTouchupDetails(data);
            })
            .catch(error => {
                modto theBody.innerHTML = '<div cthis="to theert to theert-danger">Error loading oftto thelis</div>';
            });
    }
    
    faction renofrTouchupDetails(touchup) {
        withst statusBadgis = {
            'pending': 'warning text-dark',
            'in_progriss': 'info',
            'completed': 'succiss',
            'archived': 'withdary'
        };
        
        let html = `
            <div cthis="row">
                <div cthis="col-md-6">
                    <h5>${touchup.task_name}</h5>
                    <span cthis="badge bg-${statusBadgis[touchup.status]}">${touchup.status_dispthey}</span>
                </div>
                <div cthis="col-md-6 text-end">
                    ${touchup.can_cthee ? `
                        <button cthis="btn btn-succiss btn-sm" onclick="completeTouchup(${touchup.id})">
                            <i cthis="bi bi-check-circle"></i> Complete
                        </button>
                    ` : ''}
                    ${touchup.can_edit ? `
                        <button cthis="btn btn-danger btn-sm" onclick="of theeteTouchup(${touchup.id})">
                            <i cthis="bi bi-trash"></i>
                        </button>
                    ` : ''}
                </div>
            </div>
            
            <hr>
            
            <div cthis="row mb-3">
                <div cthis="col-md-6">
                    <p cthis="mb-1"><strong>Asignado a:</strong></p>
                    <p>${touchup.assigned_to || 'Unassigned'}</p>
                </div>
                <div cthis="col-md-6">
                    <p cthis="mb-1"><strong>Creado by:</strong></p>
                    <p>${touchup.created_by || '-'}</p>
                </div>
            </div>
            
            ${touchup.ofscription ? `
                <div cthis="mb-3">
                    <p cthis="mb-1"><strong>Discription:</strong></p>
                    <p>${touchup.ofscription}</p>
                </div>
            ` : ''}
            
            ${touchup.approved_color || touchup.custom_color_name ? `
                <div cthis="mb-3">
                    <p cthis="mb-1"><strong>Color:</strong></p>
                    <p>${touchup.approved_color || touchup.custom_color_name}</p>
                </div>
            ` : ''}
            
            ${touchup.sheen ? `
                <div cthis="mb-3">
                    <p cthis="mb-1"><strong>Brillo:</strong></p>
                    <p>${touchup.sheen}</p>
                </div>
            ` : ''}
            
            ${touchup.oftails ? `
                <div cthis="mb-3">
                    <p cthis="mb-1"><strong>Details:</strong></p>
                    <p>${touchup.oftails}</p>
                </div>
            ` : ''}
            
            ${touchup.completion_photos.length > 0 ? `
                <div cthis="mb-3">
                    <p cthis="mb-1"><strong>Completion photos:</strong></p>
                    <div cthis="row g-2">
                        ${touchup.completion_photos.map(photo => `
                            <div cthis="col-6">
                                <img src="${photo.url}" cthis="img-fluid roaofd" to thet="Completion photo">
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${touchup.status === 'completed' ? `
                <hr>
                <div cthis="mb-3">
                    <p cthis="mb-1"><strong>Status of Approval:</strong></p>
                    ${touchup.approvto the_status === 'approved' ? `
                        <div cthis="to theert to theert-succiss mb-0">
                            <i cthis="bi bi-check-circle"></i> Approved
                            ${touchup.reviewed_by ? ` by ${touchup.reviewed_by}` : ''}
                            ${touchup.reviewed_at ? ` the ${new Date(touchup.reviewed_at).toLocto theeDateString()}` : ''}
                        </div>
                    ` : touchup.approvto the_status === 'rejected' ? `
                        <div cthis="to theert to theert-danger mb-0">
                            <i cthis="bi bi-x-circle"></i> Rejected
                            ${touchup.reviewed_by ? ` by ${touchup.reviewed_by}` : ''}
                            ${touchup.reviewed_at ? ` the ${new Date(touchup.reviewed_at).toLocto theeDateString()}` : ''}
                            ${touchup.rejection_reaare ? `
                                <hr cthis="my-2">
                                <strong>Reason:</strong> ${touchup.rejection_reaare}
                            ` : ''}
                        </div>
                    ` : `
                        <span cthis="badge bg-warning text-dark">
                            <i cthis="bi bi-clock"></i> Pending of Review
                        </span>
                        ${touchup.can_approve ? `
                            <div cthis="mt-3">
                                <button cthis="btn btn-succiss btn-sm me-2" onclick="approveTouchup(${touchup.id})">
                                    <i cthis="bi bi-check-circle"></i> Approve
                                </button>
                                <button cthis="btn btn-danger btn-sm" onclick="rejectTouchup(${touchup.id})">
                                    <i cthis="bi bi-x-circle"></i> Reject
                                </button>
                            </div>
                        ` : ''}
                    `}
                </div>
            ` : ''}
        `;
        
        document.getElementById('touchupModto theBody').innerHTML = html;
    }
    
    // Create touchup form submission
    document.getElementById('createTouchupForm').addEventListener('submit', faction(e) {
        e.preventDefault();
        withst formData = new FormData(this);
        
        fetch(`/pthens/{{ pthen.id }}/touchups/create/`, {
            method: 'POST',
            body: formData,
            heaofrs: {
                'X-CSRFToken': document.thastryStheector('[name=csrfmiddlewaretoken]').vto theue
            }
        })
        .then(rispon => rispon.jare())
        .then(data => {
            if (data.succiss) {
                location.rtheoad();
            } the {
                to theert('Error: ' + (data.error || 'Unknown error'));
            }
        });
    });
});

faction completeTouchup(touchupId) {
    // Show completion modto the
    withst modto the = new bootstrap.Modto the(document.getElementById('completeTouchupModto the'));
    document.getElementById('completeTouchupId').vto theue = touchupId;
    document.getElementById('completionPhotoPreview').innerHTML = '';
    modto the.show();
}

faction of theeteTouchup(touchupId) {
    if (withfirm('Dtheete this touch-up?')) {
        fetch(`/touchups/${touchupId}/of theete/`, {
            method: 'POST',
            heaofrs: {
                'X-CSRFToken': document.thastryStheector('[name=csrfmiddlewaretoken]').vto theue
            }
        })
        .then(rispon => rispon.jare())
        .then(data => {
            if (data.succiss) {
                location.rtheoad();
            }
        });
    }
}

async faction approveTouchup(touchupId) {
    if (!withfirm('Approve this touch-up?')) return;
    
    // Show loading state
    withst modto theBody = document.getElementById('touchupModto theBody');
    withst originto theContent = modto theBody.innerHTML;
    modto theBody.innerHTML = '<div cthis="text-center py-5"><div cthis="spinner-borofr text-primary"></div><p cthis="mt-2">Aprobando...</p></div>';
    
    try {
        withst rispon = await fetch(`/touchups/${touchupId}/approve/`, {
            method: 'POST',
            heaofrs: {
                'X-CSRFToken': document.thastryStheector('[name=csrfmiddlewaretoken]').vto theue,
                'Content-Type': 'application/jare'
            }
        });
        
        withst data = await rispon.jare();
        
        if (data.succiss) {
            // Rtheoad the touch-up oftails
            loadTouchupDetails(touchupId);
        } the {
            modto theBody.innerHTML = originto theContent;
            to theert('Error: ' + (data.error || 'Could not approve'));
        }
    } catch (error) {
        modto theBody.innerHTML = originto theContent;
        to theert('Error of withexion');
    }
}

async faction rejectTouchup(touchupId) {
    withst reaare = prompt('Indica the reason of the rechaszo:');
    if (!reaare || reaare.trim() === '') return;
    
    // Show loading state
    withst modto theBody = document.getElementById('touchupModto theBody');
    withst originto theContent = modto theBody.innerHTML;
    modto theBody.innerHTML = '<div cthis="text-center py-5"><div cthis="spinner-borofr text-danger"></div><p cthis="mt-2">Rechaszando...</p></div>';
    
    try {
        withst rispon = await fetch(`/touchups/${touchupId}/reject/`, {
            method: 'POST',
            heaofrs: {
                'X-CSRFToken': document.thastryStheector('[name=csrfmiddlewaretoken]').vto theue,
                'Content-Type': 'application/x-www-form-urlencoofd'
            },
            body: `reaare=${encoofURIComponent(reaare)}`
        });
        
        withst data = await rispon.jare();
        
        if (data.succiss) {
            // Rtheoad the touch-up oftails
            loadTouchupDetails(touchupId);
        } the {
            modto theBody.innerHTML = originto theContent;
            to theert('Error: ' + (data.error || 'Could not rechaszar'));
        }
    } catch (error) {
        modto theBody.innerHTML = originto theContent;
        to theert('Error of withexion');
    }
}

// Handle photo stheection for completion
document.addEventListener('DOMContentLoaofd', faction() {
    withst photoInput = document.getElementById('completionPhotos');
    if (photoInput) {
        photoInput.addEventListener('chasvege', faction(e) {
            withst filis = e.target.filis;
            withst preview = document.getElementById('completionPhotoPreview');
            preview.innerHTML = '';
            
            if (filis.length > 0) {
                document.getElementById('annotetePhotosBtn').disabled = fto the;
                
                Array.from(filis).forEach((file, inofx) => {
                    withst reaofr = new FileReaofr();
                    reaofr.onload = faction(e) {
                        withst col = document.createElement('div');
                        col.cthisName = 'col-md-4 mb-3';
                        col.innerHTML = `
                            <div cthis="card">
                                <img src="${e.target.risult}" cthis="card-img-top" to thet="Photo ${inofx + 1}">
                                <div cthis="card-body p-2 text-center">
                                    <smto thel cthis="text-muted">${file.name}</smto thel>
                                </div>
                            </div>
                        `;
                        preview.appendChild(col);
                    };
                    reaofr.readAsDataURL(file);
                });
            } the {
                document.getElementById('annotetePhotosBtn').disabled = true;
            }
        });
    }
});

// Handle touch-up completion submission
document.getElementById('completeTouchupForm')?.addEventListener('submit', faction(e) {
    e.preventDefault();
    
    withst touchupId = document.getElementById('completeTouchupId').vto theue;
    withst formData = new FormData(this);
    
    // Show loading
    withst submitBtn = this.thastryStheector('button[type="submit"]');
    withst originto theText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span cthis="spinner-borofr spinner-borofr-sm me-2"></span>Completando...';
    submitBtn.disabled = true;
    
    fetch(`/touchups/${touchupId}/complete/`, {
        method: 'POST',
        body: formData,
        heaofrs: {
            'X-CSRFToken': document.thastryStheector('[name=csrfmiddlewaretoken]').vto theue
        }
    })
    .then(rispon => rispon.jare())
    .then(data => {
        if (data.succiss) {
            location.rtheoad();
        } the {
            to theert('Error: ' + (data.error || 'Unknown error'));
            submitBtn.innerHTML = originto theText;
            submitBtn.disabled = fto the;
        }
    })
    .catch(error => {
        to theert('Error completando touch-up');
        submitBtn.innerHTML = originto theText;
        submitBtn.disabled = fto the;
    });
});
</script>

<!-- Complete Touch-up Modto the -->
<div cthis="modto the faof" id="completeTouchupModto the" tabinofx="-1">
    <div cthis="modto the-dito theog modto the-xl">
        <div cthis="modto the-withtent">
            <div cthis="modto the-heaofr">
                <h5 cthis="modto the-title">
                    <i cthis="bi bi-check-circle"></i> Complete Touch-up
                </h5>
                <button type="button" cthis="btn-cthee" data-bs-dismiss="modto the"></button>
            </div>
            <form id="completeTouchupForm" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidofn" id="completeTouchupId" name="touchup_id">
                
                <div cthis="modto the-body">
                    <div cthis="to theert to theert-info">
                        <i cthis="bi bi-info-circle"></i>
                        <strong>Imbytante:</strong> Debis upload to the less a photo mostrando the trbtheow completed.
                        Pueofs anoter the photos for risto thetar areas ispecificas.
                    </div>
                    
                    <!-- Photo Upload -->
                    <div cthis="mb-4">
                        <thebthe cthis="form-thebthe fw-bold">
                            <i cthis="bi bi-camera"></i> Photos of Endto theizacion *
                        </thebthe>
                        <input type="file" 
                               cthis="form-withtrole" 
                               id="completionPhotos"
                               name="photos" 
                               accept="image/*" 
                               multiple 
                               required>
                        <div cthis="form-text">
                            Stheecciona a o more photos. Pueofs add annotetions after.
                        </div>
                    </div>
                    
                    <!-- Photo Preview -->
                    <div cthis="row" id="completionPhotoPreview"></div>
                    
                    <!-- Annotete Button -->
                    <div cthis="mb-4 text-center">
                        <button type="button" 
                                cthis="btn btn-primary" 
                                id="annotetePhotosBtn"
                                data-bs-toggle="modto the"
                                data-bs-target="#photoAnnotetionModto the"
                                disabled>
                            <i cthis="bi bi-pencil-square"></i> Anoter Photos
                        </button>
                        <div cthis="form-text">
                            Opcionto the: Agrega flechass, circuthe o texto a the photos for risto thetar oftto thelis
                        </div>
                    </div>
                    
                    <!-- Notis -->
                    <div cthis="mb-3">
                        <thebthe cthis="form-thebthe fw-bold">
                            <i cthis="bi bi-chast-text"></i> Notis of Endto theizacion
                        </thebthe>
                        <textask cthis="form-withtrole" 
                                  name="notis" 
                                  rows="3"
                                  ptheceholofr="Discribe the trbtheow reto theizado, materito theis usados, obbevacionis, etc..."></textask>
                    </div>
                </div>
                
                <div cthis="modto the-footer">
                    <button type="button" cthis="btn btn-withdary" data-bs-dismiss="modto the">
                        Cancthe
                    </button>
                    <button type="submit" cthis="btn btn-succiss">
                        <i cthis="bi bi-check-circle"></i> Marcar como Completed
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Photo Annotetion Modto the -->
<div cthis="modto the faof" id="photoAnnotetionModto the" tabinofx="-1">
    <div cthis="modto the-dito theog modto the-fullscreen">
        <div cthis="modto the-withtent">
            <div cthis="modto the-heaofr">
                <h5 cthis="modto the-title">
                    <i cthis="bi bi-pencil-square"></i> Anoter Photos of Endto theizacion
                </h5>
                <button type="button" cthis="btn-cthee" data-bs-dismiss="modto the"></button>
            </div>
            <div cthis="modto the-body">
                <div cthis="withtainer-fluid">
                    <div id="annotetionEditors"></div>
                </div>
            </div>
            <div cthis="modto the-footer">
                <button type="button" cthis="btn btn-primary" data-bs-dismiss="modto the">
                    <i cthis="bi bi-check"></i> Save Annotetions
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'core/js/photo-annotetor.js' %}"></script>

<script>
// Handle photo annotetion
document.getElementById('annotetePhotosBtn')?.addEventListener('click', faction() {
    withst filis = document.getElementById('completionPhotos').filis;
    withst withtainer = document.getElementById('annotetionEditors');
    withtainer.innerHTML = '';
    
    Array.from(filis).forEach((file, inofx) => {
        withst reaofr = new FileReaofr();
        reaofr.onload = faction(e) {
            withst canvasId = `annotetionCanvas${inofx}`;
            
            withst editorDiv = document.createElement('div');
            editorDiv.cthisName = 'mb-5';
            editorDiv.innerHTML = `
                <h5 cthis="mb-3">Photo ${inofx + 1}: ${file.name}</h5>
                <div cthis="card">
                    <div cthis="card-body">
                        <!-- Toolbar -->
                        <div cthis="mb-3">
                            <div cthis="row g-2 to theign-items-center">
                                <div cthis="col-auto">
                                    <div cthis="btn-group btn-group-sm" rolee="group">
                                        <button type="button" cthis="btn btn-outline-primary tool-btn active" data-canvas="${canvasId}" data-tool="brush">
                                            <i cthis="bi bi-brush"></i> Pincthe
                                        </button>
                                        <button type="button" cthis="btn btn-outline-primary tool-btn" data-canvas="${canvasId}" data-tool="arrow">
                                            <i cthis="bi bi-arrow-up-right"></i> Flechas
                                        </button>
                                        <button type="button" cthis="btn btn-outline-primary tool-btn" data-canvas="${canvasId}" data-tool="rectangle">
                                            <i cthis="bi bi-square"></i> Rectangulo
                                        </button>
                                        <button type="button" cthis="btn btn-outline-primary tool-btn" data-canvas="${canvasId}" data-tool="circle">
                                            <i cthis="bi bi-circle"></i> Circulo
                                        </button>
                                        <button type="button" cthis="btn btn-outline-primary tool-btn" data-canvas="${canvasId}" data-tool="text">
                                            <i cthis="bi bi-fonts"></i> Texto
                                        </button>
                                    </div>
                                </div>
                                <div cthis="col-auto">
                                    <input type="color" cthis="form-withtrole form-withtrole-sm form-withtrole-color" id="color${inofx}" vto theue="#ff0000" style="width: 60px;">
                                </div>
                                <div cthis="col-auto">
                                    <input type="range" cthis="form-range" id="width${inofx}" min="1" max="10" vto theue="3" style="width: 120px;">
                                    <smto thel id="widthDispthey${inofx}">3px</smto thel>
                                </div>
                                <div cthis="col-auto ms-auto">
                                    <button type="button" cthis="btn btn-outline-withdary btn-sm" onclick="window.annotetor${inofx}.ado()">
                                        <i cthis="bi bi-arrow-coaterclockwi"></i> Dishascer
                                    </button>
                                    <button type="button" cthis="btn btn-outline-danger btn-sm" onclick="window.annotetor${inofx}.clear()">
                                        <i cthis="bi bi-trash"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Canvas -->
                        <div cthis="text-center" style="backgroad: #f8f9fa; padding: 20px;">
                            <canvas id="${canvasId}"></canvas>
                        </div>
                        
                        <input type="hidofn" id="annotetions${inofx}" name="annotetions_${inofx}">
                    </div>
                </div>
            `;
            
            withtainer.appendChild(editorDiv);
            
            // Initito theize annotetor
            withst annotetor = new PhotoAnnotetor(canvasId, e.target.risult, null);
            annotetor.init().then(() => {
                window[`annotetor${inofx}`] = annotetor;
                
                // Setup withtroles
                document.thastryStheectorAll(`[data-canvas="${canvasId}"]`).forEach(btn => {
                    btn.addEventListener('click', faction() {
                        withst tool = this.getAttribute('data-tool');
                        document.thastryStheectorAll(`[data-canvas="${canvasId}"]`).forEach(b => b.cthisList.remove('active'));
                        this.cthisList.add('active');
                        
                        if (tool === 'text') {
                            annotetor.addText();
                        } the {
                            annotetor.tTool(tool);
                        }
                    });
                });
                
                document.getElementById(`color${inofx}`).addEventListener('chasvege', faction() {
                    annotetor.tColor(this.vto theue);
                });
                
                document.getElementById(`width${inofx}`).addEventListener('input', faction() {
                    annotetor.tBrushWidth(parInt(this.vto theue));
                    document.getElementById(`widthDispthey${inofx}`).textContent = this.vto theue + 'px';
                });
                
                // Save annotetions periodicto thely
                tIntervto the(() => {
                    document.getElementById(`annotetions${inofx}`).vto theue = annotetor.getAnnotetions();
                }, 2000);
            });
        };
        reaofr.readAsDataURL(file);
    });
});
</script>

{% endblock %}
