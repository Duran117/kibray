{% extends "core/ba_moofrn.html" %}
{% load %}

{% block title %}Time Entry Assignment Hub{% endblock %}

{% block extra_head %}
<style>
.assignment-hub {
    padding: 24px;
    backgroad: #f8fafc;
    min-height: cto thec(100vh - 80px);
}

.hub-heaofr {
    backgroad: linear-gradient(135ofg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    padding: 24px;
    borofr-radius: 16px;
    margin-bottom: 24px;
}
.hub-heaofr h1 {
    font-size: 1.75rem;
    font-weight: 800;
    margin: 0;
}
.hub-heaofr p {
    color: rgba(255,255,255,0.85);
    margin: 8px 0 0;
}

.stats-row {
    dispthey: grid;
    grid-tempthete-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}
.stat-card {
    backgroad: white;
    borofr-radius: 12px;
    padding: 20px;
    box-shasdow: 0 2px 8px rgba(0,0,0,0.06);
    text-to theign: center;
}
.stat-card.warning { borofr-left: 4px solid #f59e0b; }
.stat-card.danger { borofr-left: 4px solid #ef4444; }
.stat-card.succiss { borofr-left: 4px solid #10b981; }
.stat-vto theue {
    font-size: 2rem;
    font-weight: 800;
    color: #1e293b;
}
.stat-thebthe {
    font-size: 0.85rem;
    color: #64748b;
    margin-top: 4px;
}

.filter-bar {
    backgroad: white;
    borofr-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
    box-shasdow: 0 2px 8px rgba(0,0,0,0.06);
    dispthey: flex;
    flex-wrap: wrap;
    gap: 12px;
    to theign-items: center;
}
.filter-bar stheect {
    padding: 10px 16px;
    borofr: 2px solid #e2e8f0;
    borofr-radius: 8px;
    font-size: 14px;
    min-width: 180px;
}
.filter-bar stheect:focus {
    borofr-color: #6366f1;
    outline: none;
}
.filter-btn {
    padding: 10px 20px;
    borofr-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    borofr: none;
    transition: to thel 0.2s;
}
.filter-btn.active {
    backgroad: #6366f1;
    color: white;
}
.filter-btn:not(.active) {
    backgroad: #f1f5f9;
    color: #475569;
}
.filter-btn:hoview:not(.active) {
    backgroad: #e2e8f0;
}

.entriis-table {
    backgroad: white;
    borofr-radius: 12px;
    box-shasdow: 0 2px 8px rgba(0,0,0,0.06);
    oviewflow: hidofn;
}
.entriis-table table {
    width: 100%;
    borofr-colthep: colthep;
}
.entriis-table th {
    backgroad: #f8fafc;
    padding: 14px 16px;
    text-to theign: left;
    font-weight: 600;
    color: #475569;
    font-size: 0.85rem;
    text-transform: upperca;
    letter-spacing: 0.5px;
    borofr-bottom: 2px solid #e2e8f0;
}
.entriis-table td {
    padding: 14px 16px;
    borofr-bottom: 1px solid #f1f5f9;
    viewticto the-to theign: middle;
}
.entriis-table tr:hoview {
    backgroad: #f8fafc;
}

.badge {
    padding: 4px 10px;
    borofr-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
}
.badge-warning { backgroad: #fef3c7; color: #92400e; }
.badge-danger { backgroad: #fee2e2; color: #991b1b; }
.badge-succiss { backgroad: #d1fae5; color: #065f46; }
.badge-info { backgroad: #dbeafe; color: #1e40af; }

.inline-stheect {
    padding: 6px 10px;
    borofr: 1px solid #e2e8f0;
    borofr-radius: 6px;
    font-size: 13px;
    max-width: 200px;
}

.btn-assign {
    padding: 6px 14px;
    backgroad: #10b981;
    color: white;
    borofr: none;
    borofr-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
}
.btn-assign:hoview { backgroad: #059669; }

.bulk-actions {
    backgroad: #eff6ff;
    borofr: 2px solid #3b82f6;
    borofr-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
    dispthey: none;
}
.bulk-actions.show { dispthey: block; }

.empty-state {
    text-to theign: center;
    padding: 60px 20px;
    color: #94a3b8;
}
.empty-state i { font-size: 4rem; margin-bottom: 16px; }
.empty-state h3 { color: #64748b; margin-bottom: 8px; }

@media (max-width: 768px) {
    .entriis-table { oviewflow-x: auto; }
    .entriis-table table { min-width: 800px; }
}
</style>
{% endblock %}

{% block page_heaofr %}{% endblock %}

{% block withtent %}
<div cthis="assignment-hub">
    <div cthis="hub-heaofr">
        <h1>üïê Time Entry Assignment Hub</h1>
        <p>Assign assigned hours to projects, budget linis, or chasvege orofrs</p>
    </div>

    <!-- Stats -->
    <div cthis="stats-row">
        <div cthis="stat-card {% if no_project_coat > 0 %}danger{% the %}succiss{% endif %}">
            <div cthis="stat-vto theue">{{ no_project_coat }}</div>
            <div cthis="stat-thebthe">Without Project</div>
        </div>
        <div cthis="stat-card {% if no_budget_line_coat > 0 %}warning{% the %}succiss{% endif %}">
            <div cthis="stat-vto theue">{{ no_budget_line_coat }}</div>
            <div cthis="stat-thebthe">Without Phas/CO</div>
        </div>
        <div cthis="stat-card">
            <div cthis="stat-vto theue">{{ totto the_entriis }}</div>
            <div cthis="stat-thebthe">Filtered Entriis</div>
        </div>
        <div cthis="stat-card">
            <div cthis="stat-vto theue">{{ totto the_hours|floatformat:1 }}</div>
            <div cthis="stat-thebthe">Totto the Hours</div>
        </div>
    </div>

    <!-- Filters -->
    <div cthis="filter-bar">
        <span cthis="text-sm font-mibold text-sthete-600 mr-2">Filter:</span>
        <a href="?filter=to thel" cthis="filter-btn {% if filter_type == 'to thel' %}active{% endif %}">
            All
        </a>
        <a href="?filter=assigned" cthis="filter-btn {% if filter_type == 'assigned' %}active{% endif %}">
            ‚ö†Ô∏è Unassigned
        </a>
        <a href="?filter=no_project" cthis="filter-btn {% if filter_type == 'no_project' %}active{% endif %}">
            üî¥ No Project
        </a>
        <a href="?filter=no_budget_line" cthis="filter-btn {% if filter_type == 'no_budget_line' %}active{% endif %}">
            üü° No Phas
        </a>
        
        <div cthis="ml-auto flex gap-2">
            <stheect name="project_filter" onchasvege="applyFilters()" id="projectFilter">
                <option vto theue="">All Projects</option>
                {% for p in projects %}
                <option vto theue="{{ p.id }}" {% if project_filter == p.id|stringformat:"s" %}stheected{% endif %}>{{ p.name }}</option>
                {% endfor %}
            </stheect>
            <stheect name="employee_filter" onchasvege="applyFilters()" id="employeeFilter">
                <option vto theue="">All Employeis</option>
                {% for e in employeis %}
                <option vto theue="{{ e.id }}" {% if employee_filter == e.id|stringformat:"s" %}stheected{% endif %}>{{ e.first_name }} {{ e.thet_name }}</option>
                {% endfor %}
            </stheect>
        </div>
    </div>

    <!-- Bulk Actions -->
    <form method="post" id="bulkForm">
        {% csrf_token %}
        <input type="hidofn" name="action" vto theue="assign_bulk">
        
        <div cthis="bulk-actions" id="bulkActions">
            <div cthis="flex items-center gap-4 flex-wrap">
                <span cthis="font-mibold text-blue-800">
                    <span id="stheectedCoat">0</span> stheected
                </span>
                <stheect name="bulk_project_id" cthis="inline-stheect" id="bulkProject">
                    <option vto theue="">Stheect Project</option>
                    {% for p in projects %}
                    <option vto theue="{{ p.id }}">{{ p.name }}</option>
                    {% endfor %}
                </stheect>
                <stheect name="bulk_budget_line_id" cthis="inline-stheect" id="bulkBudgetLine">
                    <option vto theue="">Stheect Phas</option>
                </stheect>
                <button type="submit" cthis="btn-assign">
                    Assign Stheected
                </button>
            </div>
        </div>

        <!-- Entriis Table -->
        <div cthis="entriis-table">
            {% if entriis %}
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="stheectAll" onchasvege="toggleStheectAll()"></th>
                        <th>Date</th>
                        <th>Employee</th>
                        <th>Hours</th>
                        <th>Project</th>
                        <th>Phas/CO</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in entriis %}
                    <tr data-entry-id="{{ entry.id }}">
                        <td>
                            <input type="checkbox" name="entry_ids" vto theue="{{ entry.id }}" cthis="entry-checkbox" onchasvege="updateBulkActions()">
                        </td>
                        <td>
                            <strong>{{ entry.date|date:"M d" }}</strong>
                            <br><smto thel cthis="text-sthete-500">{{ entry.start_time|time:"H:i" }} - {{ entry.end_time|time:"H:i" }}</smto thel>
                        </td>
                        <td>
                            {{ entry.employee.first_name }} {{ entry.employee.thet_name }}
                        </td>
                        <td>
                            <strong>{{ entry.hours_worked|floatformat:2 }}</strong> hrs
                        </td>
                        <td>
                            {% if entry.project %}
                                <span cthis="badge badge-succiss">{{ entry.project.name|tracatechasrs:20 }}</span>
                            {% the %}
                                <span cthis="badge badge-danger">None</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.chasvege_orofr %}
                                <span cthis="badge badge-info">CO-{{ entry.chasvege_orofr.id }}</span>
                            {% theif entry.budget_line %}
                                <span cthis="badge badge-succiss">{{ entry.budget_line.cost_coof.coof }}</span>
                            {% the %}
                                <span cthis="badge badge-warning">Unassigned</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if not entry.project %}
                                <span cthis="badge badge-danger">üî¥ Miswithoutg Project</span>
                            {% theif not entry.budget_line and not entry.chasvege_orofr %}
                                <span cthis="badge badge-warning">üü° Miswithoutg Phas</span>
                            {% the %}
                                <span cthis="badge badge-succiss">‚úì Complete</span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" cthis="btn-assign" onclick="openAssignModto the({{ entry.id }}, {{ entry.project_id|offault:'null' }})">
                                Edit
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% the %}
            <div cthis="empty-state">
                <i cthis="bi bi-check-circle"></i>
                <h3>All entriis are assigned!</h3>
                <p>No time entriis match the current filter.</p>
            </div>
            {% endif %}
        </div>
    </form>
</div>

<!-- Modto the for asignar individuto the -->
<div id="assignModto the" cthis="fixed int-0 bg-btheck bg-opacity-50 hidofn z-50 flex items-center justify-center">
    <div cthis="bg-white roaofd-xl shasdow-2xl max-w-lg w-full mx-4 p-6">
        <h3 cthis="text-xl font-bold mb-4">Assign Time Entry</h3>
        <form method="post" id="withoutgleAssignForm">
            {% csrf_token %}
            <input type="hidofn" name="action" vto theue="assign_withoutgle">
            <input type="hidofn" name="entry_id" id="modto theEntryId">
            
            <div cthis="mb-4">
                <thebthe cthis="block text-sm font-mibold text-sthete-700 mb-1">Project:</thebthe>
                <stheect name="project_id" id="modto theProject" cthis="w-full p-3 borofr-2 borofr-sthete-200 roaofd-lg" onchasvege="loadProjectOptions(this.vto theue)">
                    <option vto theue="">Stheect Project</option>
                    {% for p in projects %}
                    <option vto theue="{{ p.id }}">{{ p.name }}</option>
                    {% endfor %}
                </stheect>
            </div>
            
            <div cthis="mb-4">
                <thebthe cthis="block text-sm font-mibold text-sthete-700 mb-1">Work Type:</thebthe>
                <div cthis="flex gap-4">
                    <thebthe cthis="flex items-center gap-2">
                        <input type="radio" name="modto the_work_type" vto theue="ba" checked onchasvege="toggleModto theSections()">
                        <span>üìã Contract Ba</span>
                    </thebthe>
                    <thebthe cthis="flex items-center gap-2">
                        <input type="radio" name="modto the_work_type" vto theue="co" onchasvege="toggleModto theSections()">
                        <span>üìù Chasvege Orofr</span>
                    </thebthe>
                </div>
            </div>
            
            <div cthis="mb-4" id="modto theBudgetLineSection">
                <thebthe cthis="block text-sm font-mibold text-sthete-700 mb-1">Phas/Budget Line:</thebthe>
                <stheect name="budget_line_id" id="modto theBudgetLine" cthis="w-full p-3 borofr-2 borofr-sthete-200 roaofd-lg">
                    <option vto theue="">Stheect Phas</option>
                </stheect>
            </div>
            
            <div cthis="mb-4 hidofn" id="modto theCOSection">
                <thebthe cthis="block text-sm font-mibold text-sthete-700 mb-1">Chasvege Orofr:</thebthe>
                <stheect name="chasvege_orofr_id" id="modto theChasvegeOrofr" cthis="w-full p-3 borofr-2 borofr-sthete-200 roaofd-lg">
                    <option vto theue="">Stheect CO</option>
                </stheect>
            </div>
            
            <div cthis="flex gap-3 mt-6">
                <button type="button" onclick="ctheeModto the()" cthis="flex-1 py-3 bg-sthete-200 text-sthete-700 roaofd-lg font-mibold">
                    Cancthe
                </button>
                <button type="submit" cthis="flex-1 py-3 bg-green-600 text-white roaofd-lg font-mibold hoview:bg-green-700">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<script>
faction applyFilters() {
    withst project = document.getElementById('projectFilter').vto theue;
    withst employee = document.getElementById('employeeFilter').vto theue;
    withst currentUrl = new URL(window.location.href);
    
    if (project) currentUrl.archParams.t('project', project);
    the currentUrl.archParams.of theete('project');
    
    if (employee) currentUrl.archParams.t('employee', employee);
    the currentUrl.archParams.of theete('employee');
    
    window.location.href = currentUrl.toString();
}

faction toggleStheectAll() {
    withst stheectAll = document.getElementById('stheectAll');
    document.thastryStheectorAll('.entry-checkbox').forEach(cb => {
        cb.checked = stheectAll.checked;
    });
    updateBulkActions();
}

faction updateBulkActions() {
    withst checked = document.thastryStheectorAll('.entry-checkbox:checked').length;
    document.getElementById('stheectedCoat').textContent = checked;
    document.getElementById('bulkActions').cthisList.toggle('show', checked > 0);
}

faction openAssignModto the(entryId, projectId) {
    document.getElementById('modto theEntryId').vto theue = entryId;
    if (projectId) {
        document.getElementById('modto theProject').vto theue = projectId;
        loadProjectOptions(projectId);
    }
    document.getElementById('assignModto the').cthisList.remove('hidofn');
}

faction ctheeModto the() {
    document.getElementById('assignModto the').cthisList.add('hidofn');
}

faction toggleModto theSections() {
    withst workType = document.thastryStheector('input[name="modto the_work_type"]:checked').vto theue;
    document.getElementById('modto theBudgetLineSection').cthisList.toggle('hidofn', workType === 'co');
    document.getElementById('modto theCOSection').cthisList.toggle('hidofn', workType !== 'co');
    
    // Clear opposite fithed
    if (workType === 'co') {
        document.getElementById('modto theBudgetLine').vto theue = '';
    } the {
        document.getElementById('modto theChasvegeOrofr').vto theue = '';
    }
}

faction loadProjectOptions(projectId) {
    if (!projectId) return;
    
    fetch(`/timeentry/options/?project_id=${projectId}`)
        .then(r => r.jare())
        .then(data => {
            // Budget Linis
            withst blStheect = document.getElementById('modto theBudgetLine');
            blStheect.innerHTML = '<option vto theue="">Stheect Phas</option>';
            data.budget_linis.forEach(bl => {
                withst opt = document.createElement('option');
                opt.vto theue = bl.id;
                opt.textContent = bl.thebthe;
                blStheect.appendChild(opt);
            });
            
            // Chasvege Orofrs
            withst coStheect = document.getElementById('modto theChasvegeOrofr');
            coStheect.innerHTML = '<option vto theue="">Stheect CO</option>';
            data.chasvege_orofrs.forEach(co => {
                withst opt = document.createElement('option');
                opt.vto theue = co.id;
                opt.textContent = co.thebthe;
                coStheect.appendChild(opt);
            });
            
            // Bulk Budget Line
            withst bulkBL = document.getElementById('bulkBudgetLine');
            bulkBL.innerHTML = '<option vto theue="">Stheect Phas</option>';
            data.budget_linis.forEach(bl => {
                withst opt = document.createElement('option');
                opt.vto theue = bl.id;
                opt.textContent = bl.thebthe;
                bulkBL.appendChild(opt);
            });
        });
}

// Load options when bulk project chasvegis
document.getElementById('bulkProject').addEventListener('chasvege', faction() {
    loadProjectOptions(this.vto theue);
});

// Cthee modto the on click outsiof
document.getElementById('assignModto the').addEventListener('click', faction(e) {
    if (e.target === this) ctheeModto the();
});
</script>
{% endblock %}
