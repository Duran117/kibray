{% extends "core/base_modern.html" %}
{% load i18n %}

{% block extra_css %}
<style>
/* Mobile optimization for client dashboard */
* {
  box-sizing: border-box;
}

body {
  overflow-x: hidden;
  max-width: 100vw;
}

.kb-container-narrow {
  width: 100%;
  max-width: 100%;
  padding: 0.75rem;
}

@media (min-width: 768px) {
  .kb-container-narrow {
    padding: 1.5rem;
  }
}

.card {
  transition: transform 0.2s;
  width: 100%;
  max-width: 100%;
  overflow: hidden;
}

.card:hover {
  transform: translateY(-5px);
}

.card-header h3 {
  font-size: 1.25rem;
  word-wrap: break-word;
}

@media (min-width: 768px) {
  .card-header h3 {
    font-size: 1.75rem;
  }
}

img {
  max-width: 100%;
  height: auto;
}

.row {
  margin-left: 0;
  margin-right: 0;
}

.row > * {
  padding-left: 0.5rem;
  padding-right: 0.5rem;
}

@media (min-width: 768px) {
  .row > * {
    padding-left: 0.75rem;
    padding-right: 0.75rem;
  }
}

.btn-sm {
  font-size: 0.8rem;
  padding: 0.375rem 0.5rem;
  white-space: nowrap;
}

@media (max-width: 576px) {
  .d-flex.gap-2 {
    flex-wrap: wrap;
  }
  
  .d-flex.gap-2 .btn {
    flex: 1 1 45%;
    min-width: 0;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4 kb-container-narrow">
  <div class="text-center mb-4">
    <h2 class="display-5">My Projects</h2>
    <div class="text-muted">{{ display_name }}</div>
    <p class="text-muted mb-0">{{ today|date:"l, F d, Y" }}</p>
  </div>

  {% for data in project_data %}
  <div class="card shadow-sm mb-4 kb-elevated kb-gradient-border">
    <!-- Header con progreso -->
  <div class="card-header text-white" style="background: var(--kb-gradient-primary); border-top-left-radius: var(--kb-radius); border-top-right-radius: var(--kb-radius);">
      <div class="row align-items-center text-white">
        <div class="col-md-8">
          <h3 class="mb-1">{{ data.project.name }}</h3>
          <p class="mb-0 opacity-75">
            <i class="bi bi-geo-alt"></i> {{ data.project.address|default:"—" }}
          </p>
        </div>
        <div class="col-md-4 text-end">
          <div class="h1 mb-0">{{ data.progress_pct }}%</div>
          <small>Progress</small>
        </div>
      </div>
      <!-- Progress Bar -->
      <div class="progress mt-3" style="height: 10px; background:#233; opacity:.35">
        <div class="progress-bar bg-success" role="progressbar" style="width: {{ data.progress_pct }}%"></div>
      </div>
      {% if data.gantt_progress.total_items > 0 %}
      <div class="d-flex gap-3 mt-2 opacity-75" style="font-size: 0.8rem;">
        <span><i class="bi bi-check-circle-fill text-success"></i> {{ data.gantt_progress.completed_items }} completed</span>
        <span><i class="bi bi-arrow-repeat text-warning"></i> {{ data.gantt_progress.in_progress_items }} in progress</span>
        <span><i class="bi bi-circle text-secondary"></i> {{ data.gantt_progress.planned_items }} pending</span>
      </div>
      {% endif %}
    </div>

    <div class="card-body">
      <div class="row g-4">
        <!-- === PHOTO GALLERY === -->
        <div class="col-lg-6">
          <h5 class="kb-section-title"><i class="bi bi-images"></i> Recent Gallery</h5>
          {% if data.recent_photos %}
          <div class="row g-2">
            {% for photo in data.recent_photos %}
            <div class="col-4">
              <a href="{{ photo.image.url }}" target="_blank" class="d-block">
                <img src="{{ photo.image.url }}" class="img-fluid rounded shadow-sm" alt="Site photo" style="height: 120px; object-fit: cover; width: 100%;">
              </a>
              <small class="text-muted d-block mt-1">{{ photo.room|default:"—" }}</small>
            </div>
            {% endfor %}
          </div>
          <a href="{% url 'site_photo_list' data.project.id %}" class="btn btn-sm btn-outline-primary mt-2 w-100">
            View all photos →
          </a>
          {% else %}
          <p class="text-muted">No photos available yet.</p>
          {% endif %}
        </div>

        <!-- === INVOICES & PAYMENTS === -->
        <div class="col-lg-6">
          <h5 class="kb-section-title"><i class="bi bi-receipt"></i> Invoices</h5>
          
          <!-- Financial Summary -->
          <div class="row g-2 mb-3">
            <div class="col-6">
              <div class="p-3 bg-light rounded text-center">
                <small class="text-muted d-block">Total Invoiced</small>
                <h5 class="mb-0 text-primary">${{ data.total_invoiced|floatformat:2 }}</h5>
              </div>
            </div>
            <div class="col-6">
              <div class="p-3 bg-light rounded text-center">
                <small class="text-muted d-block">Pending</small>
                <h5 class="mb-0 text-danger">${{ data.balance|floatformat:2 }}</h5>
              </div>
            </div>
          </div>

          <!-- Invoice list -->
          {% if data.invoices %}
          <ul class="list-group">
            {% for invoice in data.invoices %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ invoice.invoice_number }}</strong><br>
                <small class="text-muted">{{ invoice.date_issued|date:"M d, Y" }}</small>
              </div>
              <div class="text-end">
                <div class="fw-bold">${{ invoice.total_amount|floatformat:2 }}</div>
                <span class="badge bg-{{ invoice.status }}">{{ invoice.get_status_display }}</span>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted">No invoices yet.</p>
          {% endif %}
        </div>

        <!-- === NEXT EVENT === -->
        <div class="col-lg-6">
          <h5 class="kb-section-title"><i class="bi bi-calendar-check"></i> Next Event</h5>
          {% if data.next_schedule %}
          <div class="alert alert-info">
            <h6 class="mb-1">{{ data.next_schedule.title }}</h6>
            <p class="mb-1"><i class="bi bi-clock"></i> {{ data.next_schedule.start_datetime|date:"D, M d 'at' g:i A" }}</p>
            {% if data.next_schedule.description %}
            <small class="text-muted">{{ data.next_schedule.description }}</small>
            {% endif %}
          </div>
          {% else %}
          <p class="text-muted">No upcoming events scheduled.</p>
          {% endif %}
        </div>

        <!-- === MY REQUESTS === -->
        <div class="col-lg-6">
          <h5 class="kb-section-title"><i class="bi bi-chat-left-dots"></i> My Requests</h5>
          {% if data.client_requests %}
          <ul class="list-group">
            {% for req in data.client_requests %}
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>{{ req.title }}</strong><br>
                  <small class="text-muted">{{ req.created_at|date:"M d, Y" }}</small>
                </div>
                <span class="badge bg-{{ req.status }}">{{ req.get_status_display }}</span>
              </div>
              {% if req.description %}
              <p class="mb-0 mt-2 small">{{ req.description|truncatewords:20 }}</p>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted mb-3">You have no requests yet.</p>
          {% endif %}
          <a href="{% url 'client_request_create' data.project.id %}" class="btn btn-sm btn-success w-100">
            <i class="bi bi-plus-circle"></i> New Request
          </a>
        </div>
      </div>
    </div>

    <!-- Footer with actions -->
    <div class="card-footer bg-light">
      <div class="d-flex gap-2">
        <a href="{% url 'client_project_view' data.project.id %}" class="btn btn-outline-primary btn-sm flex-fill">
          <i class="bi bi-eye"></i> View Details
        </a>
        <a href="{% url 'site_photo_list' data.project.id %}" class="btn btn-outline-secondary btn-sm flex-fill">
          <i class="bi bi-images"></i> Gallery
        </a>
        <a href="{% url 'project_minutes_list' data.project.id %}" class="btn btn-outline-info btn-sm flex-fill">
          <i class="bi bi-journal-text"></i> Minutes
        </a>
        <a href="{% url 'client_requests_list' data.project.id %}" class="btn btn-outline-success btn-sm flex-fill">
          <i class="bi bi-chat"></i> Requests
        </a>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="text-center py-5">
    <i class="bi bi-folder2-open display-1 text-muted"></i>
    <h3 class="mt-3">You have no assigned projects</h3>
    <p class="text-muted">Contact your Project Manager for more information.</p>
  </div>
  {% endfor %}
</div>
{% endblock %}
