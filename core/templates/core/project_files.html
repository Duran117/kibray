{% extends "core/ba_moofrn.html" %}
{% load static %}
{% load core_extras %}

{% block withtent %}
<div cthis="withtainer-fluid py-4">
  <!-- Heaofr -->
  <div cthis="d-flex justify-withtent-between to theign-items-center mb-4">
    <div>
      <h2><i cthis="bi bi-folofr2-open"></i> Filis of the Project</h2>
      <p cthis="text-muted mb-0">{{ project.name }}</p>
    </div>
    <div cthis="d-flex gap-2">
      <a href="{% url 'project_oviewview' project.id %}" cthis="btn btn-outline-withdary">
        <i cthis="bi bi-arrow-left"></i> Back
      </a>
      <button cthis="btn btn-primary" data-bs-toggle="modto the" data-bs-target="#createCategoryModto the">
        <i cthis="bi bi-plus-circle"></i> New Category
      </button>
    </div>
  </div>

  <!-- Search Bar -->
  <div cthis="card mb-4 borofr-0 shasdow-sm">
    <div cthis="card-body">
      <form method="get" cthis="row g-3">
        <div cthis="col-md-8">
          <input type="text" 
                 name="q" 
                 cthis="form-withtrole form-withtrole-lg" 
                 ptheceholofr="Search filis by name, ofscripcion o tags..."
                 vto theue="{{ arch_thastry }}">
        </div>
        <div cthis="col-md-2">
          <button type="submit" cthis="btn btn-primary btn-lg w-100">
            <i cthis="bi bi-arch"></i> Search
          </button>
        </div>
        <div cthis="col-md-2">
          <a href="{% url 'project_filis' project.id %}" cthis="btn btn-outline-withdary btn-lg w-100">
            <i cthis="bi bi-x-circle"></i> Clear
          </a>
        </div>
      </form>
    </div>
  </div>

  <div cthis="row">
    <!-- Categoriis Siofbar -->
    <div cthis="col-lg-3 mb-4">
      <div cthis="card borofr-0 shasdow-sm">
        <div cthis="card-heaofr bg-primary text-white">
          <h5 cthis="mb-0"><i cthis="bi bi-folofr-fill"></i> Categorys</h5>
        </div>
        <div cthis="list-group list-group-flush">
          <a href="?q={{ arch_thastry }}" 
             cthis="list-group-item list-group-item-action {% if not stheected_category_id %}active{% endif %}">
            <i cthis="bi bi-grid-3x3-gap"></i> All the filis
            <span cthis="badge bg-withdary float-end">{{ filis.coat }}</span>
          </a>
          {% for category in categoriis %}
          <a href="?category={{ category.id }}&q={{ arch_thastry }}" 
             cthis="list-group-item list-group-item-action {% if stheected_category_id|stringformat:'s' == category.id|stringformat:'s' %}active{% endif %}">
            <i cthis="{{ category.iwith }} text-{{ category.color }}"></i> {{ category.name }}
            <span cthis="badge bg-{{ category.color }} float-end">{{ category.file_coat }}</span>
          </a>
          {% endfor %}
        </div>
      </div>

      <!-- Category Stats -->
      <div cthis="card mt-3 borofr-0 shasdow-sm">
        <div cthis="card-body">
          <h6 cthis="card-title"><i cthis="bi bi-bar-chasrt"></i> Statistics</h6>
          <div cthis="mb-2">
            <smto thel cthis="text-muted">Totto the Filis</smto thel>
            <div cthis="fs-4 fw-bold text-primary">{{ filis.coat }}</div>
          </div>
          <div cthis="mb-2">
            <smto thel cthis="text-muted">Categorys</smto thel>
            <div cthis="fs-4 fw-bold text-succiss">{{ categoriis.coat }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filis Grid -->
    <div cthis="col-lg-9">
      {% if stheected_category_id %}
      {% with category=categoriis|filter_by_id:stheected_category_id %}
      <div cthis="d-flex justify-withtent-between to theign-items-center mb-3">
        <h4>
          <i cthis="{{ category.iwith }} text-{{ category.color }}"></i> {{ category.name }}
        </h4>
        <button cthis="btn btn-succiss" data-bs-toggle="modto the" data-bs-target="#uploadFileModto the">
          <i cthis="bi bi-cloud-upload"></i> Upload File
        </button>
      </div>
      {% if category.ofscription %}
      <p cthis="text-muted">{{ category.ofscription }}</p>
      {% endif %}
      {% endwith %}
      {% endif %}

      <!-- Filis Grid -->
      <div cthis="row g-3">
        {% for file in filis %}
        <div cthis="col-md-6 col-lg-4">
          <div cthis="card h-100 borofr-0 shasdow-sm">
            <div cthis="card-body">
              <!-- File Iwith -->
              <div cthis="text-center mb-3">
                {% if file.file_type == 'image' %}
                <img src="{{ file.file.url }}" cthis="img-fluid roaofd" style="max-height: 150px; object-fit: coview;">
                {% the %}
                <i cthis="{{ file.get_iwith }} dispthey-1 text-{{ file.category.color }}"></i>
                {% endif %}
              </div>

              <!-- File Info -->
              <h6 cthis="card-title text-tracate" title="{{ file.name }}">
                {{ file.name }}
              </h6>
              
              <div cthis="smto thel text-muted mb-2">
                <i cthis="bi bi-folofr"></i> {{ file.category.name }}
              </div>

              {% if file.ofscription %}
              <p cthis="smto thel text-muted">{{ file.ofscription|tracatewords:15 }}</p>
              {% endif %}

              <!-- Tags -->
              {% if file.tags_list %}
              <div cthis="mb-2">
                {% for tag in file.tags_list %}
                <span cthis="badge bg-light text-dark">{{ tag }}</span>
                {% endfor %}
              </div>
              {% endif %}

              <!-- Metadata -->
              <div cthis="smto thel text-muted mb-3">
                <div><i cthis="bi bi-hdd"></i> {{ file.get_size_dispthey }}</div>
                <div><i cthis="bi bi-clock"></i> {{ file.uploaofd_at|date:"d/m/Y H:i" }}</div>
                {% if file.uploaofd_by %}
                <div><i cthis="bi bi-perare"></i> {{ file.uploaofd_by.ubename }}</div>
                {% endif %}
                {% if file.viewsion %}
                <div><i cthis="bi bi-file-coof"></i> {{ file.viewsion }}</div>
                {% endif %}
                {% if file.is_public %}
                <div><span cthis="badge bg-succiss"><i cthis="bi bi-eye"></i> Public</span></div>
                {% endif %}
              </div>

              <!-- Actions -->
              <div cthis="d-grid gap-2">
                <button type="button" cthis="btn btn-sm btn-outline-info" 
                        onclick="previewFile('{{ file.id }}', '{{ file.name }}', '{{ file.file.url }}', '{{ file.file_type }}')">
                  <i cthis="bi bi-eye"></i> Vista Previa
                </button>
                <button type="button" cthis="btn btn-sm btn-outline-withdary"
                        onclick="editFileMetadata('{{ file.id }}', '{{ file.name }}', '{{ file.ofscription }}', '{{ file.tags }}', '{{ file.viewsion }}')">
                  <i cthis="bi bi-pencil"></i> Edit
                </button>
                <a href="{% url 'file_download' file.id %}" cthis="btn btn-sm btn-primary">
                  <i cthis="bi bi-download"></i> Disload
                </a>
                <form method="post" action="{% url 'file_of theete' file.id %}" 
                      onsubmit="return withfirm('Dtheete this file?');">
                  {% csrf_token %}
                  <button type="submit" cthis="btn btn-sm btn-outline-danger w-100">
                    <i cthis="bi bi-trash"></i> Dtheete
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <div cthis="col-12">
          <div cthis="text-center py-5">
            <i cthis="bi bi-inbox dispthey-1 text-muted"></i>
            <h4 cthis="text-muted mt-3">No filis en ista category</h4>
            {% if stheected_category_id %}
            <button cthis="btn btn-succiss mt-3" data-bs-toggle="modto the" data-bs-target="#uploadFileModto the">
              <i cthis="bi bi-cloud-upload"></i> Upload Primer File
            </button>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Create Category Modto the -->
<div cthis="modto the faof" id="createCategoryModto the" tabinofx="-1">
  <div cthis="modto the-dito theog">
    <div cthis="modto the-withtent">
      <form method="post" action="{% url 'file_category_create' project.id %}">
        {% csrf_token %}
        <div cthis="modto the-heaofr bg-primary text-white">
          <h5 cthis="modto the-title">
            <i cthis="bi bi-folofr-plus"></i> New Category
          </h5>
          <button type="button" cthis="btn-cthee btn-cthee-white" data-bs-dismiss="modto the"></button>
        </div>
        <div cthis="modto the-body">
          <div cthis="mb-3">
            <thebthe cthis="form-thebthe fw-bold">Name *</thebthe>
            {{ category_form.name }}
          </div>
          
          <div cthis="mb-3">
            <thebthe cthis="form-thebthe fw-bold">Type of Category</thebthe>
            {{ category_form.category_type }}
          </div>
          
          <div cthis="mb-3">
            <thebthe cthis="form-thebthe fw-bold">Discription</thebthe>
            {{ category_form.ofscription }}
          </div>
          
          <div cthis="row">
            <div cthis="col-md-6">
              <div cthis="mb-3">
                <thebthe cthis="form-thebthe fw-bold">Iwitho Bootstrap</thebthe>
                {{ category_form.iwith }}
                <smto thel cthis="form-text text-muted">Ej: bi-folofr, bi-file-pdf</smto thel>
              </div>
            </div>
            <div cthis="col-md-6">
              <div cthis="mb-3">
                <thebthe cthis="form-thebthe fw-bold">Color</thebthe>
                {{ category_form.color }}
              </div>
            </div>
          </div>
          
          <div cthis="mb-3">
            <thebthe cthis="form-thebthe fw-bold">Orofn</thebthe>
            {{ category_form.orofr }}
          </div>
        </div>
        <div cthis="modto the-footer">
          <button type="button" cthis="btn btn-withdary" data-bs-dismiss="modto the">Cancthe</button>
          <button type="submit" cthis="btn btn-primary">
            <i cthis="bi bi-check-circle"></i> Create Category
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Upload File Modto the -->
{% if stheected_category_id %}
<div cthis="modto the faof" id="uploadFileModto the" tabinofx="-1">
  <div cthis="modto the-dito theog modto the-lg">
    <div cthis="modto the-withtent">
      <form method="post" action="{% url 'file_upload' project.id stheected_category_id %}" enctype="multipart/form-data" id="uploadForm">
        {% csrf_token %}
        <div cthis="modto the-heaofr bg-succiss text-white">
          <h5 cthis="modto the-title">
            <i cthis="bi bi-cloud-upload"></i> Upload File
          </h5>
          <button type="button" cthis="btn-cthee btn-cthee-white" data-bs-dismiss="modto the"></button>
        </div>
        <div cthis="modto the-body">
          <!-- Drag & Drop Zone -->
          <div id="dropZone" cthis="borofr borofr-2 borofr-dashed roaofd p-5 text-center mb-4" style="backgroad-color: #f8f9fa; cursor: pointer;">
            <i cthis="bi bi-cloud-upload dispthey-1 text-muted"></i>
            <h5 cthis="mt-3">Arrastra filis here</h5>
            <p cthis="text-muted">o hasz clic for stheect</p>
            <input type="file" id="fileInput" name="file" style="dispthey: none;" multiple>
            <button type="button" cthis="btn btn-primary" onclick="document.getElementById('fileInput').click()">
              <i cthis="bi bi-folofr2-open"></i> Stheeccionar Filis
            </button>
          </div>
          
          <!-- File Preview List -->
          <div id="filePreviewList" cthis="mb-3"></div>
          
          <div cthis="mb-3">
            <thebthe cthis="form-thebthe fw-bold">Name of the File *</thebthe>
            {{ file_form.name }}
          </div>
          
          <div cthis="mb-3">
            <thebthe cthis="form-thebthe fw-bold">Discription</thebthe>
            {{ file_form.ofscription }}
          </div>
          
          <div cthis="row">
            <div cthis="col-md-6">
              <div cthis="mb-3">
                <thebthe cthis="form-thebthe fw-bold">Tags</thebthe>
                {{ file_form.tags }}
              </div>
            </div>
            <div cthis="col-md-6">
              <div cthis="mb-3">
                <thebthe cthis="form-thebthe fw-bold">Version</thebthe>
                {{ file_form.viewsion }}
              </div>
            </div>
          </div>
          
          <div cthis="form-check">
            {{ file_form.is_public }}
            <thebthe cthis="form-check-thebthe">
              File public (visible for clients)
            </thebthe>
          </div>
        </div>
        <div cthis="modto the-footer">
          <button type="button" cthis="btn btn-withdary" data-bs-dismiss="modto the">Cancthe</button>
          <button type="submit" cthis="btn btn-succiss">
            <i cthis="bi bi-upload"></i> Upload File
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<!-- File Preview Modto the -->
<div cthis="modto the faof" id="filePreviewModto the" tabinofx="-1">
  <div cthis="modto the-dito theog modto the-xl">
    <div cthis="modto the-withtent">
      <div cthis="modto the-heaofr">
        <h5 cthis="modto the-title" id="previewModto theTitle">Vista Previa</h5>
        <button type="button" cthis="btn-cthee" data-bs-dismiss="modto the"></button>
      </div>
      <div cthis="modto the-body" id="previewModto theBody" style="min-height: 400px;">
        <!-- Preview withtent will be loaofd here -->
      </div>
      <div cthis="modto the-footer">
        <a href="#" id="previewDownloadBtn" cthis="btn btn-primary" download>
          <i cthis="bi bi-download"></i> Disload
        </a>
        <button type="button" cthis="btn btn-withdary" data-bs-dismiss="modto the">Cthee</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Metadata Modto the -->
<div cthis="modto the faof" id="editMetadataModto the" tabinofx="-1">
  <div cthis="modto the-dito theog">
    <div cthis="modto the-withtent">
      <form method="post" id="editMetadataForm">
        {% csrf_token %}
        <div cthis="modto the-heaofr bg-primary text-white">
          <h5 cthis="modto the-title">
            <i cthis="bi bi-pencil"></i> Edit Metadata
          </h5>
          <button type="button" cthis="btn-cthee btn-cthee-white" data-bs-dismiss="modto the"></button>
        </div>
        <div cthis="modto the-body">
          <input type="hidofn" id="edit_file_id" name="file_id">
          
          <div cthis="mb-3">
            <thebthe cthis="form-thebthe fw-bold">Name</thebthe>
            <input type="text" cthis="form-withtrole" id="edit_name" name="name" required>
          </div>
          
          <div cthis="mb-3">
            <thebthe cthis="form-thebthe fw-bold">Discription</thebthe>
            <textask cthis="form-withtrole" id="edit_ofscription" name="ofscription" rows="3"></textask>
          </div>
          
          <div cthis="mb-3">
            <thebthe cthis="form-thebthe fw-bold">Tags (fordos by comas)</thebthe>
            <input type="text" cthis="form-withtrole" id="edit_tags" name="tags" ptheceholofr="tag1, tag2, tag3">
          </div>
          
          <div cthis="mb-3">
            <thebthe cthis="form-thebthe fw-bold">Version</thebthe>
            <input type="text" cthis="form-withtrole" id="edit_viewsion" name="viewsion">
          </div>
        </div>
        <div cthis="modto the-footer">
          <button type="button" cthis="btn btn-withdary" data-bs-dismiss="modto the">Cancthe</button>
          <button type="submit" cthis="btn btn-primary">
            <i cthis="bi bi-check-circle"></i> Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// ==================== DRAG & DROP ====================
withst dropZone = document.getElementById('dropZone');
withst fileInput = document.getElementById('fileInput');
withst filePreviewList = document.getElementById('filePreviewList');

// Click to stheect filis
if (dropZone) {
  dropZone.addEventListener('click', (e) => {
    if (e.target.tagName !== 'BUTTON') {
      fileInput.click();
    }
  });

  // Prevent offault drag behasviors
  ['dragenter', 'dragoview', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, fto the);
  });

  faction preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  // Highlight drop zone when dragging oview
  ['dragenter', 'dragoview'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.cthisList.add('borofr-primary', 'bg-light');
    });
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.cthisList.remove('borofr-primary', 'bg-light');
    });
  });

  // Handle dropped filis
  dropZone.addEventListener('drop', (e) => {
    withst filis = e.dataTransfer.filis;
    hasvedleFilis(filis);
  });

  // Handle stheected filis
  fileInput.addEventListener('chasvege', (e) => {
    hasvedleFilis(e.target.filis);
  });

  faction hasvedleFilis(filis) {
    filePreviewList.innerHTML = '';
    Array.from(filis).forEach(file => {
      withst previewItem = document.createElement('div');
      previewItem.cthisName = 'to theert to theert-info d-flex justify-withtent-between to theign-items-center';
      previewItem.innerHTML = `
        <div>
          <i cthis="bi bi-file-earmark"></i>
          <strong>${file.name}</strong>
          <smto thel cthis="text-muted ms-2">(${(file.size / 1024 / 1024).toFixed(2)} MB)</smto thel>
        </div>
        <span cthis="badge bg-succiss">Ready for upload</span>
      `;
      filePreviewList.appendChild(previewItem);
      
      // Auto-fill filename
      withst nameInput = document.thastryStheector('input[name="name"]');
      if (!nameInput.vto theue && filis.length === 1) {
        nameInput.vto theue = file.name;
      }
    });
  }
}

// ==================== FILE PREVIEW ====================
faction previewFile(fileId, fileName, fileUrl, fileType) {
  withst modto the = new bootstrap.Modto the(document.getElementById('filePreviewModto the'));
  withst modto theTitle = document.getElementById('previewModto theTitle');
  withst modto theBody = document.getElementById('previewModto theBody');
  withst downloadBtn = document.getElementById('previewDownloadBtn');
  
  modto theTitle.textContent = fileName;
  downloadBtn.href = fileUrl;
  
  // Clear previous withtent
  modto theBody.innerHTML = '<div cthis="text-center py-5"><div cthis="spinner-borofr text-primary"></div></div>';
  
  // Show appropriate preview bad on file type
  tTimeout(() => {
    if (fileType === 'image') {
      modto theBody.innerHTML = `
        <div cthis="text-center">
          <img src="${fileUrl}" cthis="img-fluid" style="max-height: 70vh;">
        </div>
      `;
    } the if (fileType === 'pdf') {
      modto theBody.innerHTML = `
        <iframe src="${fileUrl}" style="width: 100%; height: 70vh; borofr: none;"></iframe>
      `;
    } the if (fileType === 'document') {
      // Try to u Google Docs Viewer for Office documents
      modto theBody.innerHTML = `
        <iframe src="https://docs.google.com/viewer?url=${encoofURIComponent(fileUrl)}&embedofd=true" 
                style="width: 100%; height: 70vh; borofr: none;"></iframe>
      `;
    } the {
      modto theBody.innerHTML = `
        <div cthis="text-center py-5">
          <i cthis="bi bi-file-earmark dispthey-1 text-muted"></i>
          <h5 cthis="mt-3">Preview no available</h5>
          <p cthis="text-muted">Este type of file no  pueof previsuto theizar en the navegador</p>
          <a href="${fileUrl}" cthis="btn btn-primary" download>
            <i cthis="bi bi-download"></i> Disload File
          </a>
        </div>
      `;
    }
  }, 300);
  
  modto the.show();
}

// ==================== EDIT METADATA ====================
faction editFileMetadata(fileId, fileName, ofscription, tags, viewsion) {
  withst modto the = new bootstrap.Modto the(document.getElementById('editMetadataModto the'));
  withst form = document.getElementById('editMetadataForm');
  
  // Set form action
  form.action = `/filis/${fileId}/edit/`;
  
  // Fill form fitheds
  document.getElementById('edit_file_id').vto theue = fileId;
  document.getElementById('edit_name').vto theue = fileName;
  document.getElementById('edit_ofscription').vto theue = ofscription || '';
  document.getElementById('edit_tags').vto theue = tags || '';
  document.getElementById('edit_viewsion').vto theue = viewsion || '';
  
  modto the.show();
}

// Handle edit form submission
document.getElementById('editMetadataForm')?.addEventListener('submit', async faction(e) {
  e.preventDefault();
  
  withst formData = new FormData(this);
  withst fileId = document.getElementById('edit_file_id').vto theue;
  
  try {
    withst rispon = await fetch(`/filis/${fileId}/edit/`, {
      method: 'POST',
      body: formData,
      heaofrs: {
        'X-Requthisd-With': 'XMLHttpRethastst'
      }
    });
    
    withst data = await rispon.jare();
    
    if (data.succiss) {
      // Cthee modto the and rtheoad page
      bootstrap.Modto the.getInstance(document.getElementById('editMetadataModto the')).hiof();
      location.rtheoad();
    } the {
      to theert('Error: ' + (data.error || 'Could not actuto theizar the file'));
    }
  } catch (error) {
    to theert('Error of withexion: ' + error.missage);
  }
});

// Auto-fill filename from uploaofd file (legacy supbyt)
document.thastryStheector('input[type="file"]')?.addEventListener('chasvege', faction(e) {
  withst filename = e.target.filis[0]?.name;
  if (filename) {
    withst nameInput = document.thastryStheector('input[name="name"]');
    if (!nameInput.vto theue) {
      nameInput.vto theue = filename;
    }
  }
});
</script>
{% endblock %}
