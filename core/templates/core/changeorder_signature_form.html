{% load static currency_extras i18n %}{% load static currency_extras i18n %}{% load static currency_extras %}

<!DOCTYPE html>

<html lang="en"><!DOCTYPE html><!DOCTYPE html>

<head>

    <meta charset="UTF-8"><html lang="en"><html lang="{{ request.LANGUAGE_CODE|default:'es' }}">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{% trans "Sign Change Order" %} - CO-{{ changeorder.id|stringformat:"04d" }}</title><head><head>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">    <meta charset="UTF-8">    <meta charset="UTF-8">

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

    <style>    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <meta name="viewport" content="width=device-width, initial-scale=1.0">

        :root {

            --primary-color: #667eea;    <title>{% trans "Sign Change Order" %} - CO-{{ changeorder.id|stringformat:"04d" }}</title>    <title>Firma de Change Order - CO-{{ changeorder.id|stringformat:"04d" }}</title>

            --success-color: #059669;

            --danger-color: #dc2626;    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

            --info-color: #0284c7;

        }    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

        body {

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>

            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);

            min-height: 100vh;    <style>    <style>

            padding: 2rem 1rem;

        }        :root {        :root {

        .co-container {

            max-width: 900px;            --primary-color: #667eea;            --primary-color: #667eea;

            margin: 0 auto;

        }            --success-color: #059669;            --success-color: #059669;

        .co-card {

            background: white;            --danger-color: #dc2626;            --danger-color: #dc2626;

            border-radius: 16px;

            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);            --info-color: #0284c7;            --info-color: #0284c7;

            overflow: hidden;

            margin-bottom: 1.5rem;        }        }

        }

        .co-header {

            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            color: white;        body {        body {

            padding: 2rem;

            text-align: center;            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;

        }

        .co-header h1 {            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

            font-size: 1.75rem;

            font-weight: 700;            min-height: 100vh;            min-height: 100vh;

            margin-bottom: 0.5rem;

        }            padding: 1rem;            padding: 1rem;

        .co-header .co-number {

            font-size: 1.1rem;        }        }

            opacity: 0.9;

        }

        .co-body {

            padding: 2rem;        .signature-container {        .signature-container {

        }

        .info-section {            max-width: 800px;            max-width: 800px;

            margin-bottom: 2rem;

        }            margin: 0 auto;            margin: 0 auto;

        .info-section h3 {

            font-size: 1rem;            background: white;            background: white;

            font-weight: 600;

            color: #374151;            border-radius: 16px;            border-radius: 16px;

            margin-bottom: 1rem;

            display: flex;            box-shadow: 0 20px 60px rgba(0,0,0,0.3);            box-shadow: 0 20px 60px rgba(0,0,0,0.3);

            align-items: center;

            gap: 0.5rem;            overflow: hidden;            overflow: hidden;

        }

        .info-section h3 i {        }        }

            color: var(--primary-color);

        }

        .info-grid {

            display: grid;        .header {        .header {

            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));

            gap: 1rem;            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

        }

        .info-item {            color: white;            color: white;

            background: #f9fafb;

            padding: 1rem;            padding: 2rem;            padding: 2rem;

            border-radius: 8px;

        }            text-align: center;            text-align: center;

        .info-item label {

            font-size: 0.75rem;        }        }

            text-transform: uppercase;

            color: #6b7280;

            margin-bottom: 0.25rem;

            display: block;        .header h1 {        .header h1 {

        }

        .info-item span {            margin: 0;            margin: 0;

            font-size: 1rem;

            font-weight: 600;            font-size: 1.8rem;            font-size: 1.8rem;

            color: #111827;

        }            font-weight: 700;            font-weight: 700;

        .line-items-table {

            width: 100%;        }        }

            border-collapse: collapse;

        }

        .line-items-table th {

            background: #f3f4f6;        .header .co-number {        .header .co-number {

            padding: 0.75rem 1rem;

            text-align: left;            font-size: 2.5rem;            font-size: 2.5rem;

            font-size: 0.8rem;

            text-transform: uppercase;            font-weight: 800;            font-weight: 800;

            color: #6b7280;

            border-bottom: 2px solid #e5e7eb;            margin: 0.5rem 0;            margin: 0.5rem 0;

        }

        .line-items-table td {        }        }

            padding: 0.75rem 1rem;

            border-bottom: 1px solid #e5e7eb;

        }

        .totals-section {        .content {        .content {

            background: #f9fafb;

            padding: 1.5rem;            padding: 2rem;            padding: 2rem;

            border-radius: 8px;

            margin-top: 1rem;        }        }

        }

        .totals-row {

            display: flex;

            justify-content: space-between;        .section {        .section {

            padding: 0.5rem 0;

        }            margin-bottom: 2rem;            margin-bottom: 2rem;

        .totals-row.grand-total {

            border-top: 2px solid #e5e7eb;            padding-bottom: 2rem;            padding-bottom: 2rem;

            margin-top: 0.5rem;

            padding-top: 1rem;            border-bottom: 2px solid #e2e8f0;            border-bottom: 2px solid #e2e8f0;

            font-size: 1.25rem;

            font-weight: 700;        }        }

            color: #111827;

        }

        .signature-section {

            background: #fefce8;        .section:last-child {        .section:last-child {

            border: 2px dashed #facc15;

            border-radius: 12px;            border-bottom: none;            border-bottom: none;

            padding: 2rem;

            text-align: center;        }        }

        }

        .signature-section h3 {

            margin-bottom: 1rem;

        }        .section-title {        .section-title {

        .signature-canvas-wrapper {

            background: white;            font-size: 1.3rem;            font-size: 1.3rem;

            border: 1px solid #d1d5db;

            border-radius: 8px;            font-weight: 700;            font-weight: 700;

            margin: 1rem auto;

            max-width: 500px;            color: #1e293b;            color: #1e293b;

        }

        #signatureCanvas {            margin-bottom: 1rem;            margin-bottom: 1rem;

            width: 100%;

            height: 200px;            display: flex;            display: flex;

            cursor: crosshair;

        }            align-items: center;            align-items: center;

        .signature-actions {

            display: flex;            gap: 0.5rem;            gap: 0.5rem;

            gap: 1rem;

            justify-content: center;        }        }

            margin-top: 1rem;

        }

        .btn-clear {

            background: #f3f4f6;        .info-grid {        .info-grid {

            border: 1px solid #d1d5db;

            color: #374151;            display: grid;            display: grid;

            padding: 0.5rem 1.5rem;

            border-radius: 8px;            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));

            cursor: pointer;

            transition: all 0.2s;            gap: 1rem;            gap: 1rem;

        }

        .btn-clear:hover {            margin-bottom: 1rem;            margin-bottom: 1rem;

            background: #e5e7eb;

        }        }        }

        .btn-submit {

            background: linear-gradient(135deg, #059669 0%, #047857 100%);

            color: white;

            border: none;        .info-item {        .info-item {

            padding: 1rem 2rem;

            border-radius: 8px;            background: #f8fafc;            background: #f8fafc;

            font-size: 1rem;

            font-weight: 600;            padding: 1rem;            padding: 1rem;

            cursor: pointer;

            transition: all 0.2s;            border-radius: 8px;            border-radius: 8px;

            display: inline-flex;

            align-items: center;            border-left: 4px solid var(--primary-color);            border-left: 4px solid var(--primary-color);

            gap: 0.5rem;

        }        }        }

        .btn-submit:hover {

            transform: translateY(-2px);

            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);

        }        .info-label {        .info-label {

        .btn-submit:disabled {

            opacity: 0.6;            font-size: 0.85rem;            font-size: 0.85rem;

            cursor: not-allowed;

            transform: none;            color: #64748b;            color: #64748b;

        }

        .already-signed {            font-weight: 600;            font-weight: 600;

            background: #ecfdf5;

            border: 2px solid #10b981;            text-transform: uppercase;            text-transform: uppercase;

            border-radius: 12px;

            padding: 2rem;            letter-spacing: 0.5px;            letter-spacing: 0.5px;

            text-align: center;

        }            margin-bottom: 0.3rem;            margin-bottom: 0.3rem;

        .already-signed i {

            font-size: 3rem;        }        }

            color: #10b981;

            margin-bottom: 1rem;

        }

        .already-signed h3 {        .info-value {        .info-value {

            color: #065f46;

            margin-bottom: 0.5rem;            font-size: 1.1rem;            font-size: 1.1rem;

        }

        .signature-image {            color: #1e293b;            color: #1e293b;

            max-width: 300px;

            margin: 1rem auto;            font-weight: 600;            font-weight: 600;

            border: 1px solid #d1d5db;

            border-radius: 8px;        }        }

            padding: 1rem;

            background: white;

        }

        .signature-image img {        .amount-display {        .amount-display {

            width: 100%;

            height: auto;            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);

        }

        .status-badge {            border: 3px solid var(--success-color);            border: 3px solid var(--success-color);

            display: inline-flex;

            align-items: center;            border-radius: 12px;            border-radius: 12px;

            gap: 0.375rem;

            padding: 0.375rem 0.75rem;            padding: 1.5rem;            padding: 1.5rem;

            border-radius: 9999px;

            font-size: 0.8rem;            text-align: center;            text-align: center;

            font-weight: 600;

        }            margin: 1.5rem 0;            margin: 1.5rem 0;

        .status-badge.pending {

            background: #fef3c7;        }        }

            color: #92400e;

        }

        .status-badge.approved {

            background: #d1fae5;        .amount-label {        .amount-label {

            color: #065f46;

        }            font-size: 0.9rem;            font-size: 0.9rem;

        @media (max-width: 640px) {

            body { padding: 1rem 0.5rem; }            color: #065f46;            color: #065f46;

            .co-header { padding: 1.5rem 1rem; }

            .co-body { padding: 1rem; }            font-weight: 600;            font-weight: 600;

            .info-grid { grid-template-columns: 1fr; }

            .line-items-table { font-size: 0.875rem; }            text-transform: uppercase;            text-transform: uppercase;

            .signature-actions { flex-direction: column; }

        }            margin-bottom: 0.5rem;            margin-bottom: 0.5rem;

    </style>

</head>        }        }

<body>

    <div class="co-container">

        <!-- Header -->

        <div class="co-card">        .amount-value {        .amount-value {

            <div class="co-header">

                <h1><i class="bi bi-file-earmark-text me-2"></i>{% trans "Change Order" %}</h1>            font-size: 3rem;            font-size: 3rem;

                <div class="co-number">CO-{{ changeorder.id|stringformat:"04d" }}</div>

            </div>            font-weight: 800;            font-weight: 800;

            

            <div class="co-body">            color: #047857;            color: #047857;

                <!-- Project Information -->

                <div class="info-section">        }        }

                    <h3><i class="bi bi-building"></i> {% trans "Project Information" %}</h3>

                    <div class="info-grid">

                        <div class="info-item">

                            <label>{% trans "Project" %}</label>        .rates-display {        .rates-display {

                            <span>{{ changeorder.project.name }}</span>

                        </div>            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);

                        <div class="info-item">

                            <label>{% trans "Address" %}</label>            border: 3px solid var(--info-color);            border: 3px solid var(--info-color);

                            <span>{{ changeorder.project.address|default:"—" }}</span>

                        </div>            border-radius: 12px;            border-radius: 12px;

                        <div class="info-item">

                            <label>{% trans "Date" %}</label>            padding: 1.5rem;            padding: 1.5rem;

                            <span>{{ changeorder.created_at|date:"M d, Y" }}</span>

                        </div>            margin: 1.5rem 0;            margin: 1.5rem 0;

                        <div class="info-item">

                            <label>{% trans "Status" %}</label>        }        }

                            <span class="status-badge {% if changeorder.status == 'approved' %}approved{% else %}pending{% endif %}">

                                {% if changeorder.status == 'approved' %}

                                <i class="bi bi-check-circle"></i> {% trans "Approved" %}

                                {% else %}        .rate-item {        .rate-item {

                                <i class="bi bi-clock"></i> {% trans "Pending Signature" %}

                                {% endif %}            display: flex;            display: flex;

                            </span>

                        </div>            justify-content: space-between;            justify-content: space-between;

                    </div>

                </div>            align-items: center;            align-items: center;



                <!-- Description -->            padding: 0.75rem 0;            padding: 0.75rem 0;

                {% if changeorder.description %}

                <div class="info-section">            border-bottom: 1px solid rgba(2, 132, 199, 0.2);            border-bottom: 1px solid rgba(2, 132, 199, 0.2);

                    <h3><i class="bi bi-card-text"></i> {% trans "Description" %}</h3>

                    <p>{{ changeorder.description }}</p>        }        }

                </div>

                {% endif %}



                <!-- Line Items -->        .rate-item:last-child {        .rate-item:last-child {

                <div class="info-section">

                    <h3><i class="bi bi-list-ul"></i> {% trans "Line Items" %}</h3>            border-bottom: none;            border-bottom: none;

                    <div class="table-responsive">

                        <table class="line-items-table">        }        }

                            <thead>

                                <tr>

                                    <th>{% trans "Description" %}</th>

                                    <th class="text-center">{% trans "Qty" %}</th>        .rate-label {        .rate-label {

                                    <th class="text-end">{% trans "Unit Price" %}</th>

                                    <th class="text-end">{% trans "Total" %}</th>            font-weight: 600;            font-weight: 600;

                                </tr>

                            </thead>            color: #075985;            color: #075985;

                            <tbody>

                                {% for item in changeorder.line_items.all %}        }        }

                                <tr>

                                    <td>{{ item.description }}</td>

                                    <td class="text-center">{{ item.quantity }}</td>

                                    <td class="text-end">{{ item.unit_price|currency }}</td>        .rate-value {        .rate-value {

                                    <td class="text-end">{{ item.line_total|currency }}</td>

                                </tr>            font-size: 1.3rem;            font-size: 1.3rem;

                                {% empty %}

                                <tr>            font-weight: 800;            font-weight: 800;

                                    <td colspan="4" class="text-center text-muted py-3">{% trans "No line items" %}</td>

                                </tr>            color: #0369a1;            color: #0369a1;

                                {% endfor %}

                            </tbody>        }        }

                        </table>

                    </div>



                    <!-- Totals -->        .legal-text {        .legal-text {

                    <div class="totals-section">

                        <div class="totals-row">            background: #fffbeb;            background: #fffbeb;

                            <span>{% trans "Subtotal" %}</span>

                            <span>{{ changeorder.subtotal|currency }}</span>            border: 2px solid #f59e0b;            border: 2px solid #f59e0b;

                        </div>

                        {% if changeorder.tax_amount %}            border-radius: 12px;            border-radius: 12px;

                        <div class="totals-row">

                            <span>{% trans "Tax" %}</span>            padding: 1.5rem;            padding: 1.5rem;

                            <span>{{ changeorder.tax_amount|currency }}</span>

                        </div>            margin: 1.5rem 0;            margin: 1.5rem 0;

                        {% endif %}

                        <div class="totals-row grand-total">        }        }

                            <span>{% trans "Grand Total" %}</span>

                            <span>{{ changeorder.total_amount|currency }}</span>

                        </div>

                    </div>        .legal-text p {        .legal-text p {

                </div>

            margin: 0;            margin: 0;

                <!-- Signature Section -->

                {% if changeorder.client_signature %}            color: #78350f;            color: #78350f;

                <!-- Already Signed -->

                <div class="already-signed">            font-size: 0.95rem;            font-size: 0.95rem;

                    <i class="bi bi-check-circle-fill"></i>

                    <h3>{% trans "Already Signed" %}</h3>            line-height: 1.6;            line-height: 1.6;

                    <p class="text-muted">{% trans "This change order was signed on" %} {{ changeorder.signed_at|date:"M d, Y 'at' g:i A" }}</p>

                    <div class="signature-image">        }        }

                        <img src="{{ changeorder.client_signature.url }}" alt="{% trans 'Client Signature' %}">

                    </div>

                </div>

                {% else %}        .legal-text strong {        .legal-text strong {

                <!-- Signature Pad -->

                <div class="signature-section">            color: #92400e;            color: #92400e;

                    <h3><i class="bi bi-pencil-square me-2"></i>{% trans "Digital Signature" %}</h3>

                    <p class="text-muted mb-3">{% trans "Please sign below to approve this change order" %}</p>        }        }

                    

                    <form method="post" id="signatureForm">

                        {% csrf_token %}

                        <input type="hidden" name="signature_data" id="signatureData">        .signature-pad-container {        .signature-pad-container {

                        

                        <div class="signature-canvas-wrapper">            border: 3px solid #cbd5e1;            border: 3px solid #cbd5e1;

                            <canvas id="signatureCanvas"></canvas>

                        </div>            border-radius: 12px;            border-radius: 12px;

                        

                        <div class="signature-actions">            overflow: hidden;            overflow: hidden;

                            <button type="button" class="btn-clear" id="clearBtn">

                                <i class="bi bi-eraser"></i> {% trans "Clear" %}            margin: 1rem 0;            margin: 1rem 0;

                            </button>

                            <button type="submit" class="btn-submit" id="submitBtn" disabled>            background: #f8fafc;            background: #f8fafc;

                                <i class="bi bi-check-circle"></i> {% trans "Sign and Approve Change Order" %}

                            </button>        }        }

                        </div>

                    </form>

                </div>

                {% endif %}        .signature-pad {        .signature-pad {

            </div>

        </div>            width: 100%;            width: 100%;



        <!-- Back Link -->            height: 200px;            height: 200px;

        <div class="text-center">

            <a href="{% url 'client_project_view' changeorder.project.id %}" class="text-decoration-none">            cursor: crosshair;            cursor: crosshair;

                <i class="bi bi-arrow-left"></i> {% trans "Back to Project" %}

            </a>            touch-action: none;            touch-action: none;

        </div>

    </div>        }        }



    <script>

        document.addEventListener('DOMContentLoaded', function() {

            const canvas = document.getElementById('signatureCanvas');        .signature-controls {        .signature-controls {

            if (!canvas) return;

                        background: #f1f5f9;            background: #f1f5f9;

            const signaturePad = new SignaturePad(canvas, {

                backgroundColor: 'rgb(255, 255, 255)',            padding: 1rem;            padding: 1rem;

                penColor: 'rgb(0, 0, 0)'

            });            display: flex;            display: flex;

            

            // Resize canvas            justify-content: space-between;            justify-content: space-between;

            function resizeCanvas() {

                const ratio = Math.max(window.devicePixelRatio || 1, 1);            align-items: center;            align-items: center;

                const wrapper = canvas.parentElement;

                canvas.width = wrapper.offsetWidth * ratio;        }        }

                canvas.height = 200 * ratio;

                canvas.getContext('2d').scale(ratio, ratio);

                signaturePad.clear();

            }        .form-group {        .form-group {

            

            window.addEventListener('resize', resizeCanvas);            margin-bottom: 1.5rem;            margin-bottom: 1.5rem;

            resizeCanvas();

                    }        }

            // Clear button

            document.getElementById('clearBtn').addEventListener('click', function() {

                signaturePad.clear();

                document.getElementById('submitBtn').disabled = true;        .form-label {        .form-label {

            });

                        font-weight: 600;            font-weight: 600;

            // Enable submit when signed

            signaturePad.addEventListener('endStroke', function() {            color: #475569;            color: #475569;

                document.getElementById('submitBtn').disabled = signaturePad.isEmpty();

            });            margin-bottom: 0.5rem;            margin-bottom: 0.5rem;

            

            // Form submission            display: block;            display: block;

            document.getElementById('signatureForm').addEventListener('submit', function(e) {

                if (signaturePad.isEmpty()) {        }        }

                    e.preventDefault();

                    alert('{% trans "Please provide a signature" %}');

                    return false;

                }        .form-control {        .form-control {

                document.getElementById('signatureData').value = signaturePad.toDataURL('image/png');

            });            width: 100%;            width: 100%;

        });

    </script>            padding: 0.75rem;            padding: 0.75rem;

</body>

</html>            border: 2px solid #cbd5e1;            border: 2px solid #cbd5e1;


            border-radius: 8px;            border-radius: 8px;

            font-size: 1rem;            font-size: 1rem;

            transition: border-color 0.2s;            transition: border-color 0.2s;

        }        }



        .form-control:focus {        .form-control:focus {

            outline: none;            outline: none;

            border-color: var(--primary-color);            border-color: var(--primary-color);

        }        }



        .btn {        .btn {

            padding: 0.75rem 1.5rem;            padding: 0.75rem 1.5rem;

            border-radius: 8px;            border-radius: 8px;

            border: none;            border: none;

            font-weight: 600;            font-weight: 600;

            font-size: 1rem;            font-size: 1rem;

            cursor: pointer;            cursor: pointer;

            transition: all 0.2s;            transition: all 0.2s;

            display: inline-flex;            display: inline-flex;

            align-items: center;            align-items: center;

            gap: 0.5rem;            gap: 0.5rem;

        }        }



        .btn-secondary {        .btn-secondary {

            background: #e5e7eb;            background: #e5e7eb;

            color: #374151;            color: #374151;

        }        }



        .btn-secondary:hover {        .btn-secondary:hover {

            background: #d1d5db;            background: #d1d5db;

        }        }



        .btn-primary {        .btn-primary {

            background: var(--primary-color);            background: var(--primary-color);

            color: white;            color: white;

        }        }



        .btn-primary:hover {        .btn-primary:hover {

            background: #5568d3;            background: #5568d3;

            transform: translateY(-2px);            transform: translateY(-2px);

            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);

        }        }



        .btn-primary:disabled {        .btn-primary:disabled {

            background: #cbd5e1;            background: #cbd5e1;

            cursor: not-allowed;            cursor: not-allowed;

            transform: none;            transform: none;

        }        }



        .btn-success {        .btn-success {

            background: var(--success-color);            background: var(--success-color);

            color: white;            color: white;

            width: 100%;            width: 100%;

            padding: 1rem;            padding: 1rem;

            font-size: 1.1rem;            font-size: 1.1rem;

        }        }



        .btn-success:hover {        .btn-success:hover {

            background: #047857;            background: #047857;

        }        }



        .alert {        .alert {

            padding: 1rem 1.5rem;            padding: 1rem 1.5rem;

            border-radius: 8px;            border-radius: 8px;

            margin-bottom: 1.5rem;            margin-bottom: 1.5rem;

        }        }



        .alert-danger {        .alert-danger {

            background: #fee2e2;            background: #fee2e2;

            border: 2px solid #dc2626;            border: 2px solid #dc2626;

            color: #7f1d1d;            color: #7f1d1d;

        }        }



        .description-box {        .description-box {

            background: #f8fafc;            background: #f8fafc;

            border-left: 4px solid var(--primary-color);            border-left: 4px solid var(--primary-color);

            padding: 1rem 1.5rem;            padding: 1rem 1.5rem;

            border-radius: 8px;            border-radius: 8px;

            color: #475569;            color: #475569;

            line-height: 1.6;            line-height: 1.6;

            margin: 1rem 0;            margin: 1rem 0;

        }        }



        @media (max-width: 768px) {        @media (max-width: 768px) {

            .header {            .header {

                padding: 1.5rem 1rem;                padding: 1.5rem 1rem;

            }            }



            .header h1 {            .header h1 {

                font-size: 1.3rem;                font-size: 1.3rem;

            }            }



            .header .co-number {            .header .co-number {

                font-size: 2rem;                font-size: 2rem;

            }            }



            .content {            .content {

                padding: 1rem;                padding: 1rem;

            }            }



            .amount-value {            .amount-value {

                font-size: 2rem;                font-size: 2rem;

            }            }



            .info-grid {            .info-grid {

                grid-template-columns: 1fr;                grid-template-columns: 1fr;

            }            }



            .signature-controls {            .signature-controls {

                flex-direction: column;                flex-direction: column;

                gap: 0.5rem;                gap: 0.5rem;

            }            }



            .btn {            .btn {

                width: 100%;                width: 100%;

                justify-content: center;                justify-content: center;

            }            }

        }        }



        .empty-signature-warning {        .empty-signature-warning {

            display: none;            display: none;

            background: #fee2e2;            background: #fee2e2;

            border: 2px solid #dc2626;            border: 2px solid #dc2626;

            border-radius: 8px;            border-radius: 8px;

            padding: 1rem;            padding: 1rem;

            margin-top: 1rem;            margin-top: 1rem;

            color: #7f1d1d;            color: #7f1d1d;

            font-weight: 600;            font-weight: 600;

        }        }

    </style>    </style>

</head></head>

<body><body>

    <div class="signature-container">    <div class="signature-container">

        <!-- HEADER -->        <!-- HEADER -->

        <div class="header">        <div class="header">

            <h1><i class="bi bi-file-earmark-text"></i> {% trans "Change Order" %}</h1>            <h1><i class="bi bi-file-earmark-text"></i> Change Order</h1>

            <div class="co-number">CO-{{ changeorder.id|stringformat:"04d" }}</div>            <div class="co-number">CO-{{ changeorder.id|stringformat:"04d" }}</div>

            <p style="margin: 0; opacity: 0.9;">{{ changeorder.project.name }}</p>            <p style="margin: 0; opacity: 0.9;">{{ changeorder.project.name }}</p>

        </div>        </div>



        <!-- CONTENT -->        <!-- CONTENT -->

        <div class="content">        <div class="content">

            {% if error %}            {% if error %}

            <div class="alert alert-danger" role="alert" aria-live="polite" tabindex="0">            <div class="alert alert-danger" role="alert" aria-live="polite" tabindex="0">

                <i class="bi bi-exclamation-triangle" aria-hidden="true"></i> <span>{{ error }}</span>                <i class="bi bi-exclamation-triangle" aria-hidden="true"></i> <span>{{ error }}</span>

            </div>            </div>

            {% endif %}            {% endif %}



            <!-- PROJECT INFO -->            <!-- PROJECT INFO -->

            <div class="section">            <div class="section">

                <div class="section-title">                <div class="section-title">

                    <i class="bi bi-info-circle"></i> {% trans "Project Information" %}                    <i class="bi bi-info-circle"></i> Información del Proyecto

                </div>                </div>

                <div class="info-grid">                <div class="info-grid">

                    <div class="info-item">                    <div class="info-item">

                        <div class="info-label">{% trans "Client" %}</div>                        <div class="info-label">Cliente</div>

                        <div class="info-value">{{ changeorder.project.client|default:"Not specified" }}</div>                        <div class="info-value">{{ changeorder.project.client|default:"No especificado" }}</div>

                    </div>                    </div>

                    <div class="info-item">                    <div class="info-item">

                        <div class="info-label">{% trans "Date Created" %}</div>                        <div class="info-label">Fecha de Creación</div>

                        <div class="info-value">{{ changeorder.date_created|date:"M d, Y" }}</div>                        <div class="info-value">{{ changeorder.date_created|date:"d/m/Y" }}</div>

                    </div>                    </div>

                </div>                </div>

            </div>            </div>



            <!-- DESCRIPTION -->            <!-- DESCRIPTION -->

            <div class="section">            <div class="section">

                <div class="section-title">                <div class="section-title">

                    <i class="bi bi-file-text"></i> {% trans "Work Description" %}                    <i class="bi bi-file-text"></i> Descripción del Trabajo

                </div>                </div>

                <div class="description-box">                <div class="description-box">

                    {{ changeorder.description|linebreaks }}                    {{ changeorder.description|linebreaks }}

                </div>                </div>

            </div>            </div>



            <!-- PRICING INFO -->            <!-- PRICING INFO -->

            <div class="section">            <div class="section">

                <div class="section-title">                <div class="section-title">

                    <i class="bi bi-currency-dollar"></i> {% trans "Pricing Information" %}                    <i class="bi bi-currency-dollar"></i> Información de Precios

                </div>                </div>



                {% if changeorder.pricing_type == 'FIXED' %}                {% if changeorder.pricing_type == 'FIXED' %}

                <!-- FIXED PRICE -->                <!-- FIXED PRICE -->

                <div class="amount-display">                <div class="amount-display">

                    <div class="amount-label">{% trans "Total Amount - Fixed Price" %}</div>                    <div class="amount-label">Monto Total - Precio Fijo</div>

                    <div class="amount-value">{{ changeorder.amount|currency_es }}</div>                    <div class="amount-value">{{ changeorder.amount|currency_es }}</div>

                </div>                </div>



                <div class="legal-text">                <div class="legal-text">

                    <p>                    <p>

                        <i class="bi bi-shield-check"></i>                        <i class="bi bi-shield-check"></i>

                        <strong>{% trans "Fixed Price Agreement:" %}</strong> {% trans "I, the client, agree to pay the fixed sum of" %}                        <strong>Acuerdo de Precio Fijo:</strong> Yo, el cliente, acepto pagar la suma fija de 

                        <strong>{{ changeorder.amount|currency_es }}</strong> {% trans "for the work described above. This amount is final and will not be subject to changes based on hours worked or materials used." %}                        <strong>{{ changeorder.amount|currency_es }}</strong> por el trabajo descrito arriba. 

                    </p>                        Este monto es definitivo y no estará sujeto a cambios basados en horas trabajadas o materiales utilizados.

                </div>                    </p>

                </div>

                {% else %}

                <!-- TIME & MATERIALS -->                {% else %}

                <div class="rates-display">                <!-- TIME & MATERIALS -->

                    <div style="text-align: center; margin-bottom: 1rem;">                <div class="rates-display">

                        <div style="font-size: 1.1rem; font-weight: 700; color: #075985; margin-bottom: 0.5rem;">                    <div style="text-align: center; margin-bottom: 1rem;">

                            <i class="bi bi-clock-history"></i> {% trans "Mode: Time and Materials" %}                        <div style="font-size: 1.1rem; font-weight: 700; color: #075985; margin-bottom: 0.5rem;">

                        </div>                            <i class="bi bi-clock-history"></i> Modalidad: Tiempo y Materiales

                        <div style="font-size: 0.9rem; color: #0369a1;">                        </div>

                            {% trans "Will be billed based on hours worked and materials used" %}                        <div style="font-size: 0.9rem; color: #0369a1;">

                        </div>                            Se facturará según las horas trabajadas y materiales utilizados

                    </div>                        </div>

                    </div>

                    <div class="rate-item">

                        <span class="rate-label">                    <div class="rate-item">

                            <i class="bi bi-person-badge"></i> {% trans "Labor Hourly Rate" %}                        <span class="rate-label">

                        </span>                            <i class="bi bi-person-badge"></i> Tarifa por Hora de Mano de Obra

                        <span class="rate-value">{{ changeorder.billing_hourly_rate|currency_es }}/hr</span>                        </span>

                    </div>                        <span class="rate-value">{{ changeorder.billing_hourly_rate|currency_es }}/hr</span>

                    </div>

                    <div class="rate-item">

                        <span class="rate-label">                    <div class="rate-item">

                            <i class="bi bi-box-seam"></i> {% trans "Material Markup" %}                        <span class="rate-label">

                        </span>                            <i class="bi bi-box-seam"></i> Markup sobre Materiales

                        <span class="rate-value">{{ changeorder.material_markup_pct|floatformat:0 }}%</span>                        </span>

                    </div>                        <span class="rate-value">{{ changeorder.material_markup_pct|floatformat:0 }}%</span>

                </div>                    </div>

                </div>

                <div class="legal-text">

                    <p>                <div class="legal-text">

                        <i class="bi bi-shield-check"></i>                    <p>

                        <strong>{% trans "Time and Materials Agreement:" %}</strong> {% trans "I, the client, authorize this work under the Time and Materials (T&M) modality with the rates listed above. I understand that the final cost will be calculated based on:" %}                        <i class="bi bi-shield-check"></i>

                    </p>                        <strong>Acuerdo de Tiempo y Materiales:</strong> Yo, el cliente, autorizo este trabajo bajo la modalidad 

                    <ul style="margin: 0.5rem 0 0 1.5rem;">                        de Tiempo y Materiales (T&M) con las tarifas listadas arriba. Entiendo que el costo final será calculado 

                        <li><strong>{% trans "Labor:" %}</strong> {% trans "Hours worked" %} × {{ changeorder.billing_hourly_rate|currency_es }}/{% trans "hour" %}</li>                        basándose en:

                        <li><strong>{% trans "Materials:" %}</strong> {% trans "Cost of materials" %} + {{ changeorder.material_markup_pct|floatformat:0 }}% {% trans "markup" %}</li>                    </p>

                    </ul>                    <ul style="margin: 0.5rem 0 0 1.5rem;">

                    <p style="margin-top: 0.5rem; font-style: italic;">                        <li><strong>Mano de Obra:</strong> Horas trabajadas × {{ changeorder.billing_hourly_rate|currency_es }}/hora</li>

                        {% trans "The total amount is not predefined and will be determined upon completion of the work." %}                        <li><strong>Materiales:</strong> Costo de materiales + {{ changeorder.material_markup_pct|floatformat:0 }}% de markup</li>

                    </p>                    </ul>

                </div>                    <p style="margin-top: 0.5rem; font-style: italic;">

                {% endif %}                        El monto total no está predefinido y se determinará al finalizar el trabajo.

            </div>                    </p>

                </div>

            <!-- SIGNATURE SECTION -->                {% endif %}

            <div class="section">            </div>

                <div class="section-title">

                    <i class="bi bi-pencil-square"></i> {% trans "Digital Signature" %}            <!-- SIGNATURE SECTION -->

                </div>            <div class="section">

                <div class="section-title">

                <form method="post" id="signatureForm" novalidate aria-describedby="signatureInstructions">                    <i class="bi bi-pencil-square"></i> Firma Digital

                    {% csrf_token %}                </div>

                    <input type="hidden" name="signature_data" id="signatureData">

                    <p id="signatureInstructions" class="visually-hidden">{% trans "Enter your name and draw your signature in the box. All fields marked with an asterisk are required." %}</p>                <form method="post" id="signatureForm" novalidate aria-describedby="signatureInstructions">

                    {% csrf_token %}

                    <div class="form-group">                    <input type="hidden" name="signature_data" id="signatureData">

                        <label for="signerName" class="form-label">                    <p id="signatureInstructions" class="visually-hidden">Complete su nombre y dibuje su firma en el recuadro. Todos los campos marcados con asterisco son obligatorios.</p>

                            <i class="bi bi-person"></i> {% trans "Full Name" %} *

                        </label>                    <div class="form-group">

                        <input                         <label for="signerName" class="form-label">

                            type="text"                             <i class="bi bi-person"></i> Nombre Completo *

                            class="form-control"                         </label>

                            id="signerName"                         <input 

                            name="signer_name"                             type="text" 

                            placeholder="{% trans 'Enter your full name' %}"                            class="form-control" 

                            required                            id="signerName" 

                            aria-required="true"                            name="signer_name" 

                            aria-label="{% trans 'Full name of signer' %}"                            placeholder="Ingrese su nombre completo"

                        >                            required

                    </div>                            aria-required="true"

                            aria-label="Nombre completo del firmante"

                    <div class="form-group">                        >

                        <label for="customerEmail" class="form-label">                    </div>

                            <i class="bi bi-envelope"></i> {% trans "Email Address (for optional confirmation)" %}

                        </label>                    <div class="form-group">

                        <input                        <label for="customerEmail" class="form-label">

                            type="email"                            <i class="bi bi-envelope"></i> Correo Electrónico (para confirmación opcional)

                            class="form-control"                        </label>

                            id="customerEmail"                        <input

                            name="customer_email"                            type="email"

                            placeholder="client@example.com"                            class="form-control"

                            aria-label="{% trans 'Email address to receive signature confirmation' %}"                            id="customerEmail"

                        >                            name="customer_email"

                    </div>                            placeholder="cliente@ejemplo.com"

                            aria-label="Correo electrónico para recibir confirmación de firma"

                    <div class="form-group">                        >

                        <label class="form-label">                    </div>

                            <i class="bi bi-pen"></i> {% trans "Sign in the Box" %} *

                        </label>                    <div class="form-group">

                        <div class="signature-pad-container" aria-label="{% trans 'Signature area' %}">                        <label class="form-label">

                            <canvas id="signaturePad" class="signature-pad" aria-label="{% trans 'Canvas to draw your signature' %}" role="img"></canvas>                            <i class="bi bi-pen"></i> Firme en el Recuadro *

                            <div class="signature-controls">                        </label>

                                <small style="color: #64748b;">                        <div class="signature-pad-container" aria-label="Área de firma">

                                    <i class="bi bi-info-circle"></i> {% trans "Draw your signature with your finger or mouse" %}                            <canvas id="signaturePad" class="signature-pad" aria-label="Lienzo para dibujar su firma" role="img"></canvas>

                                </small>                            <div class="signature-controls">

                                <button type="button" class="btn btn-secondary" id="clearButton">                                <small style="color: #64748b;">

                                    <i class="bi bi-eraser"></i> {% trans "Clear" %}                                    <i class="bi bi-info-circle"></i> Dibuje su firma con el dedo o mouse

                                </button>                                </small>

                            </div>                                <button type="button" class="btn btn-secondary" id="clearButton">

                        </div>                                    <i class="bi bi-eraser"></i> Limpiar

                        <div id="emptySignatureWarning" class="empty-signature-warning" role="alert" aria-live="assertive">                                </button>

                            <i class="bi bi-exclamation-triangle" aria-hidden="true"></i> <span>{% trans "Please sign in the box before continuing." %}</span>                            </div>

                        </div>                        </div>

                    </div>                        <div id="emptySignatureWarning" class="empty-signature-warning" role="alert" aria-live="assertive">

                            <i class="bi bi-exclamation-triangle" aria-hidden="true"></i> <span>Por favor, firme en el recuadro antes de continuar.</span>

                    <button type="submit" class="btn btn-success" id="submitButton">                        </div>

                        <i class="bi bi-check-circle"></i> {% trans "Sign and Approve Change Order" %}                    </div>

                    </button>

                </form>                    <button type="submit" class="btn btn-success" id="submitButton">

            </div>                        <i class="bi bi-check-circle"></i> Firmar y Aprobar Change Order

        </div>                    </button>

    </div>                </form>

            </div>

    <script>        </div>

        // Initialize Signature Pad    </div>

        const canvas = document.getElementById('signaturePad');

        const signaturePad = new SignaturePad(canvas, {    <script>

            backgroundColor: 'rgb(255, 255, 255)',        // Initialize Signature Pad

            penColor: 'rgb(0, 0, 0)',        const canvas = document.getElementById('signaturePad');

            minWidth: 1,        const signaturePad = new SignaturePad(canvas, {

            maxWidth: 3            backgroundColor: 'rgb(255, 255, 255)',

        });            penColor: 'rgb(0, 0, 0)',

            minWidth: 1,

        // Resize canvas to fit container            maxWidth: 3

        function resizeCanvas() {        });

            const ratio = Math.max(window.devicePixelRatio || 1, 1);

            canvas.width = canvas.offsetWidth * ratio;        // Resize canvas to fit container

            canvas.height = canvas.offsetHeight * ratio;        function resizeCanvas() {

            canvas.getContext("2d").scale(ratio, ratio);            const ratio = Math.max(window.devicePixelRatio || 1, 1);

            signaturePad.clear();            canvas.width = canvas.offsetWidth * ratio;

        }            canvas.height = canvas.offsetHeight * ratio;

            canvas.getContext("2d").scale(ratio, ratio);

        window.addEventListener('resize', resizeCanvas);            signaturePad.clear();

        resizeCanvas();        }



        // Clear button        window.addEventListener('resize', resizeCanvas);

        document.getElementById('clearButton').addEventListener('click', function() {        resizeCanvas();

            signaturePad.clear();

            document.getElementById('emptySignatureWarning').style.display = 'none';        // Clear button

        });        document.getElementById('clearButton').addEventListener('click', function() {

            signaturePad.clear();

        // Form submission            document.getElementById('emptySignatureWarning').style.display = 'none';

        document.getElementById('signatureForm').addEventListener('submit', function(e) {        });

            e.preventDefault();

        // Form submission

            const signerName = document.getElementById('signerName').value.trim();        document.getElementById('signatureForm').addEventListener('submit', function(e) {

            const warningDiv = document.getElementById('emptySignatureWarning');            e.preventDefault();



            // Validate signer name            const signerName = document.getElementById('signerName').value.trim();

            if (!signerName) {            const warningDiv = document.getElementById('emptySignatureWarning');

                const nameField = document.getElementById('signerName');

                nameField.setAttribute('aria-invalid', 'true');            // Validate signer name

                nameField.focus();            if (!signerName) {

                return false;                const nameField = document.getElementById('signerName');

            }                nameField.setAttribute('aria-invalid', 'true');

                nameField.focus();

            // Validate signature                return false;

            if (signaturePad.isEmpty()) {            }

                warningDiv.style.display = 'block';

                warningDiv.focus();            // Validate signature

                canvas.scrollIntoView({ behavior: 'smooth', block: 'center' });            if (signaturePad.isEmpty()) {

                return false;                warningDiv.style.display = 'block';

            }                warningDiv.focus();

                canvas.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Get signature data as base64                return false;

            const signatureData = signaturePad.toDataURL('image/png');            }

            document.getElementById('signatureData').value = signatureData;

            // Get signature data as base64

            // Show loading state            const signatureData = signaturePad.toDataURL('image/png');

            const submitButton = document.getElementById('submitButton');            document.getElementById('signatureData').value = signatureData;

            submitButton.disabled = true;

            submitButton.innerHTML = '<i class="bi bi-hourglass-split"></i> {% trans "Processing..." %}';            // Show loading state

            const submitButton = document.getElementById('submitButton');

            // Submit form            submitButton.disabled = true;

            this.submit();            submitButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Procesando...';

        });

            // Submit form

        // Prevent accidental page reload            this.submit();

        window.addEventListener('beforeunload', function(e) {        });

            if (!signaturePad.isEmpty()) {

                e.preventDefault();        // Prevent accidental page reload

                e.returnValue = '';        window.addEventListener('beforeunload', function(e) {

                return '';            if (!signaturePad.isEmpty()) {

            }                e.preventDefault();

        });                e.returnValue = '';

    </script>                return '';

</body>            }

</html>        });

    </script>
</body>
</html>
