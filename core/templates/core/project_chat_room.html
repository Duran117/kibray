{% extends "core/base_modern.html" %}
{% block content %}
<div class="container mt-3 kb-container-narrow">
  <h2 class="mb-3"><span class="text-gradient"><i class="bi bi-chat-dots"></i> Chat del Proyecto · {{ project.name }}</span></h2>
  <ul class="nav nav-tabs mb-3" role="tablist">
    {% for ch in channels %}
      <li class="nav-item">
        <a class="nav-link {% if ch.id == channel.id %}active{% endif %}" href="{% url 'project_chat_room' project.id ch.id %}">{{ ch.name }}</a>
      </li>
    {% endfor %}
  </ul>
  <div class="mb-3 p-3 bg-white kb-glass rounded shadow-sm" style="max-height:380px; overflow-y:auto;">
    {% for m in messages %}
      <div class="mb-2">
        <strong>{{ m.user.username|default:'Anon' }}</strong>
        <small class="text-muted">{{ m.created_at|date:'Y-m-d H:i' }}</small><br>
        {% if m.message %}<span>{{ m.message }}</span>{% endif %}
        {% if m.link_url %}<a href="{{ m.link_url }}" target="_blank" rel="noopener" class="ms-1">Link ↗</a>{% endif %}
        {% if m.image %}<div><img src="{{ m.image.url }}" class="img-fluid mt-1 rounded" style="max-height:160px;object-fit:contain;"></div>{% endif %}
      </div>
    {% empty %}
      <div class="text-muted">Sin mensajes aún.</div>
    {% endfor %}
  </div>
  <form method="post" enctype="multipart/form-data" class="row g-3 align-items-end mb-2">
    {% csrf_token %}
    <input type="hidden" name="action" value="send">
    <div class="col-12 col-md-5">
      <label class="form-label">Mensaje</label>
      <textarea name="message" id="voiceTarget" class="form-control" rows="2" placeholder="Escribe o usa dictado (Ctrl+Enter para enviar)"></textarea>
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label">Link (opcional)</label>
      <input type="url" name="link_url" class="form-control" placeholder="https://...">
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label">Imagen (opcional)</label>
      <input type="file" name="image" class="form-control">
    </div>
    <div class="col-12 col-md-1 d-flex gap-2">
      <button class="btn btn-primary flex-grow-1 shadow-hover" type="submit" id="sendBtn"><i class="bi bi-send"></i></button>
      <button class="btn btn-soft" type="button" id="voiceBtn" title="Dictado" data-bs-toggle="tooltip"><i class="bi bi-mic"></i></button>
    </div>
  </form>
  <hr>
  <form method="post" class="row g-2 mt-3">
    {% csrf_token %}
    <input type="hidden" name="action" value="invite">
    <div class="col-12 col-md-4">
      <input type="text" name="username" class="form-control" placeholder="Usuario a invitar" required>
    </div>
    <div class="col-12 col-md-2">
      <button class="btn btn-success shadow-hover" type="submit"><i class="bi bi-person-plus"></i> Invitar</button>
    </div>
  </form>
</div>
<script>
(function(){
  const btn = document.getElementById('voiceBtn');
  const target = document.getElementById('voiceTarget');
  const form = target.closest('form');
  const sendBtn = document.getElementById('sendBtn');
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    btn.disabled = true; btn.title = 'Dictado no soportado'; return;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const rec = new SpeechRecognition();
  rec.lang = 'es-ES';
  rec.continuous = false;
  rec.interimResults = false;
  rec.onresult = function(e){
    const txt = e.results[0][0].transcript;
    target.value = (target.value ? target.value + ' ' : '') + txt;
  };
  rec.onerror = function(){ btn.classList.remove('btn-danger'); };
  btn.addEventListener('click', function(){
    try { rec.start(); btn.classList.add('btn-danger'); } catch(err) {}
  });
  // Ctrl+Enter enviar
  target.addEventListener('keydown', function(e){
    if(e.key==='Enter' && (e.ctrlKey || e.metaKey)){
      e.preventDefault();
      sendBtn.click();
    }
  });
  // Esc limpia selección / blur
  target.addEventListener('keydown', function(e){
    if(e.key==='Escape') { target.blur(); }
  });
})();
</script>
{% endblock %}