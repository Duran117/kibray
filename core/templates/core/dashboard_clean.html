{% extends "core/base_modern.html" %}
{% load static %}
{% load i18n %}

{% block title %}Dashboard - Kibray{% endblock %}

{% block page_header %}
<div class="flex flex-col items-center text-center mb-6">
    <img src="{% static 'brand/kibray-logo.png' %}" 
         alt="Kibray Logo" 
         class="h-12 mb-3" 
         onerror="this.onerror=null; this.src='{% static 'kibray-logo.png' %}';">
    <h1 class="text-3xl font-bold text-slate-900">
        {% trans "Welcome" %}, {{ user.first_name|default:user.username }}
    </h1>
    <p class="text-slate-600 mt-1">{% trans "Dashboard General" %}</p>
</div>
{% endblock %}

{% block content %}
<!-- Quick Actions Card -->
{% include "core/components/card.html" with title=_("Quick Actions") icon="lightning-charge-fill" %}
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-9 gap-3">
        <a href="{% url 'payroll_weekly_review' %}" 
           class="flex flex-col items-center gap-2 p-4 bg-green-600 hover:bg-green-700 text-white rounded-lg transition shadow-sm">
            <i class="bi bi-calendar-week text-3xl"></i>
            <span class="text-sm font-medium text-center">{% trans "Payroll" %}</span>
        </a>
        <a href="{% url 'schedule_create' %}" 
           class="flex flex-col items-center gap-2 p-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition shadow-sm">
            <i class="bi bi-calendar-plus text-3xl"></i>
            <span class="text-sm font-medium text-center">{% trans "Add Event" %}</span>
        </a>
        <a href="{% url 'expense_create' %}" 
           class="flex flex-col items-center gap-2 p-4 bg-red-600 hover:bg-red-700 text-white rounded-lg transition shadow-sm">
            <i class="bi bi-cash-coin text-3xl"></i>
            <span class="text-sm font-medium text-center">{% trans "Add Expense" %}</span>
        </a>
        <a href="{% url 'income_create' %}" 
           class="flex flex-col items-center gap-2 p-4 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg transition shadow-sm">
            <i class="bi bi-piggy-bank text-3xl"></i>
            <span class="text-sm font-medium text-center">{% trans "Add Income" %}</span>
        </a>
        <a href="{% url 'timeentry_create' %}" 
           class="flex flex-col items-center gap-2 p-4 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition shadow-sm">
            <i class="bi bi-clock-history text-3xl"></i>
            <span class="text-sm font-medium text-center">{% trans "Register Hours" %}</span>
        </a>
        <a href="{% url 'changeorder_board' %}" 
           class="flex flex-col items-center gap-2 p-4 bg-white hover:bg-yellow-50 text-yellow-700 border-2 border-yellow-400 rounded-lg transition shadow-sm">
            <i class="bi bi-kanban text-3xl"></i>
            <span class="text-sm font-medium text-center">{% trans "Change Orders" %}</span>
        </a>
        <a href="{% url 'changeorder_create' %}" 
           class="flex flex-col items-center gap-2 p-4 bg-white hover:bg-indigo-50 text-indigo-700 border-2 border-indigo-400 rounded-lg transition shadow-sm">
            <i class="bi bi-file-earmark-plus text-3xl"></i>
            <span class="text-sm font-medium text-center">New CO</span>
        </a>
        <a href="{% url 'invoice_list' %}" 
           class="flex flex-col items-center gap-2 p-4 bg-white hover:bg-cyan-50 text-cyan-700 border-2 border-cyan-400 rounded-lg transition shadow-sm">
            <i class="bi bi-receipt text-3xl"></i>
            <span class="text-sm font-medium text-center">{% trans "Invoices" %}</span>
        </a>
        <a href="{% url 'invoice_payment_dashboard' %}" 
           class="flex flex-col items-center gap-2 p-4 bg-white hover:bg-green-50 text-green-700 border-2 border-green-400 rounded-lg transition shadow-sm">
            <i class="bi bi-credit-card text-3xl"></i>
            <span class="text-sm font-medium text-center">{% trans "Payments" %}</span>
        </a>
    </div>
{% include "core/components/card.html" with close_card=True only %}

<!-- Project Overview and Upcoming Events -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
    <!-- Project Overview -->
    {% include "core/components/card.html" with title=_("Project Overview") icon="folder2-open" %}
        <div class="overflow-x-auto">
            <p class="text-sm text-slate-500 italic">{% trans "Project summary will appear here" %}</p>
        </div>
    {% include "core/components/card.html" with close_card=True only %}

    <!-- Upcoming Events -->
    {% include "core/components/card.html" with title=_("Upcoming Events") icon="calendar-event" %}
        <p class="text-xs text-slate-500 mb-3">30 {% trans "days" %}</p>
        <div class="space-y-2">
            <p class="text-sm text-slate-500 italic">{% trans "Upcoming events will appear here" %}</p>
        </div>
    {% include "core/components/card.html" with close_card=True only %}
</div>

<!-- Charts -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mt-6">
    <!-- Net Profit Chart -->
    {% include "core/components/card.html" %}
        <h6 class="text-sm font-semibold text-slate-600 mb-4 flex items-center gap-2">
            <i class="bi bi-graph-up"></i>
            {% trans "Net Profit" %}
        </h6>
        <div class="relative h-64">
            <canvas id="netProfitChart"></canvas>
        </div>
    {% include "core/components/card.html" with close_card=True only %}

    <!-- Budget Chart -->
    {% include "core/components/card.html" %}
        <h6 class="text-sm font-semibold text-slate-600 mb-4 flex items-center gap-2">
            <i class="bi bi-wallet2"></i>
            {% trans "Budget per Project" %}
        </h6>
        <div class="relative h-64">
            <canvas id="budgetChart"></canvas>
        </div>
    {% include "core/components/card.html" with close_card=True only %}

    <!-- Income vs Expense Chart -->
    {% include "core/components/card.html" %}
        <h6 class="text-sm font-semibold text-slate-600 mb-4 flex items-center gap-2">
            <i class="bi bi-cash-stack"></i>
            {% trans "Income vs Expense" %}
        </h6>
        <div class="relative h-64">
            <canvas id="incomeExpenseChart"></canvas>
        </div>
    {% include "core/components/card.html" with close_card=True only %}
</div>

<!-- Calendar -->
{% include "core/components/card.html" with title=_("Project Event Calendar") icon="calendar3" %}
    <div id="calendar" class="mt-4"></div>
{% include "core/components/card.html" with close_card=True only %}
{% endblock %}

{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart.js Configuration
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    
    // Income vs Expense Chart
    const ctx1 = document.getElementById('incomeExpenseChart');
    if (ctx1) {
        new Chart(ctx1.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ chart_labels|safe }},
                datasets: [
                    {
                        label: '{% trans "Income" %}',
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        data: {{ chart_income|safe }}
                    },
                    {
                        label: '{% trans "Expense" %}',
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        data: {{ chart_expense|safe }}
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    } 
                }
            }
        });
    }

    // Budget Chart
    const ctx2 = document.getElementById('budgetChart');
    if (ctx2) {
        new Chart(ctx2.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ chart_budget_labels|safe }},
                datasets: [
                    {
                        label: '{% trans "Labor" %}',
                        data: {{ chart_budget_labor|safe }},
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    },
                    {
                        label: '{% trans "Materials" %}',
                        data: {{ chart_budget_materials|safe }},
                        backgroundColor: 'rgba(153, 102, 255, 0.7)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 2
                    },
                    {
                        label: '{% trans "Other" %}',
                        data: {{ chart_budget_other|safe }},
                        backgroundColor: 'rgba(255, 205, 86, 0.7)',
                        borderColor: 'rgba(255, 205, 86, 1)',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    tooltip: { mode: 'index', intersect: false },
                    legend: { position: 'top' }
                },
                scales: { 
                    y: { 
                        beginAtZero: true,
                        stacked: false,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    } 
                }
            }
        });
    }

    // Net Profit Chart
    const netProfitValues = {{ chart_net_profit|safe }};
    const netProfitColors = netProfitValues.map(value => 
        value >= 0 ? 'rgba(0, 200, 83, 0.7)' : 'rgba(255, 99, 132, 0.7)'
    );
    const netProfitBorders = netProfitValues.map(value => 
        value >= 0 ? 'rgba(0, 200, 83, 1)' : 'rgba(255, 99, 132, 1)'
    );

    const ctx3 = document.getElementById('netProfitChart');
    if (ctx3) {
        new Chart(ctx3.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ chart_labels|safe }},
                datasets: [{
                    label: '{% trans "Net Profit" %}',
                    data: netProfitValues,
                    backgroundColor: netProfitColors,
                    borderColor: netProfitBorders,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    } 
                }
            }
        });
    }

    // FullCalendar
    var calendarEl = document.getElementById('calendar');
    if (calendarEl) {
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: window.innerWidth < 768 ? 'listWeek' : 'dayGridMonth',
            events: {{ calendar_events|safe }},
            locale: '{{ request.LANGUAGE_CODE|default:"en" }}',
            height: 'auto',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: window.innerWidth < 768 ? 'listWeek,dayGridMonth' : 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            buttonText: {
                today: '{% trans "Today" %}',
                month: '{% trans "Month" %}',
                week: '{% trans "Week" %}',
                day: '{% trans "Day" %}',
                list: '{% trans "List" %}'
            },
            eventClick: function(info) {
                if (info.event.url) {
                    window.location.href = info.event.url;
                    return false;
                }
            },
            windowResize: function(view) {
                if (window.innerWidth < 768) {
                    calendar.changeView('listWeek');
                } else {
                    calendar.changeView('dayGridMonth');
                }
            }
        });
        calendar.render();
    }
});
</script>
{% endblock %}
