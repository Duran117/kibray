{% extends "core/base_modern.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Asignar Proyectos" %} - Kibray{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'dashboard_admin' %}">
                            <i class="bi bi-house-door"></i> {% trans "Dashboard" %}
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'client_list' %}">{% trans "Clientes" %}</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'client_detail' client.id %}">{{ client.get_full_name }}</a>
                    </li>
                    <li class="breadcrumb-item active">{% trans "Asignar Proyectos" %}</li>
                </ol>
            </nav>

            <!-- Header -->
            <div class="mb-4">
                <h1 class="h3">
                    <i class="bi bi-folder-plus text-primary me-2"></i>
                    {% trans "Asignar Proyectos a" %} {{ client.get_full_name }}
                </h1>
                <p class="text-muted">
                    {% trans "Selecciona los proyectos a los que este cliente tendrá acceso" %}
                </p>
            </div>

            <!-- Proyectos Disponibles -->
            {% if available_projects %}
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-folder2-open me-2"></i>
                        {% trans "Proyectos Disponibles" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>{% trans "Proyecto" %}</th>
                                    <th>{% trans "Cliente del Proyecto" %}</th>
                                    <th>{% trans "Estado" %}</th>
                                    <th>{% trans "Fechas" %}</th>
                                    <th class="text-center">{% trans "Acción" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for project in available_projects %}
                                <tr>
                                    <td>
                                        <strong>{{ project.name }}</strong>
                                        <br>
                                        <small class="text-muted">{{ project.address }}</small>
                                    </td>
                                    <td>
                                        {% if project.client %}
                                            <span class="badge bg-info">{{ project.client }}</span>
                                        {% else %}
                                            <span class="text-muted">{% trans "Sin cliente" %}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if project.end_date %}
                                            <span class="badge bg-success">
                                                <i class="bi bi-check-circle me-1"></i>{% trans "Completado" %}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-primary">
                                                <i class="bi bi-play-circle me-1"></i>{% trans "Activo" %}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ project.start_date|date:"d M Y" }}
                                            {% if project.end_date %}
                                                - {{ project.end_date|date:"d M Y" }}
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td class="text-center">
                                        <form method="post" class="d-flex align-items-center gap-2 justify-content-center">
                                            {% csrf_token %}
                                            <input type="hidden" name="project_id" value="{{ project.id }}">
                                            <input type="hidden" name="action" value="add">
                                            <select name="access_role" class="form-select form-select-sm" style="width: auto; min-width: 130px;">
                                                {% for role_value, role_label in role_choices %}
                                                <option value="{{ role_value }}" {% if role_value == "client" %}selected{% endif %}>
                                                    {{ role_label }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <button type="submit" class="btn btn-sm btn-success">
                                                <i class="bi bi-plus-circle me-1"></i>
                                                {% trans "Asignar" %}
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="bi bi-folder2-open display-1 text-muted mb-3"></i>
                    <h5>{% trans "No hay proyectos disponibles" %}</h5>
                    <p class="text-muted">
                        {% trans "Este cliente ya tiene acceso a todos los proyectos existentes" %}
                    </p>
                    <a href="{% url 'client_detail' client.id %}" class="btn btn-primary mt-3">
                        <i class="bi bi-arrow-left me-2"></i>
                        {% trans "Volver al Perfil" %}
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Additional Information -->
            <div class="alert alert-info mt-4" role="alert">
                <h6 class="alert-heading">
                    <i class="bi bi-info-circle me-2"></i>
                    {% trans "Project Access Information" %}
                </h6>
                <p class="mb-2"><strong>{% trans "Available Roles:" %}</strong></p>
                <ul class="mb-3">
                    <li><strong>Client:</strong> {% trans "Your direct client (e.g., General Contractor)" %}</li>
                    <li><strong>Project Owner:</strong> {% trans "The property owner who needs to approve items" %}</li>
                    <li><strong>External PM:</strong> {% trans "External project manager with view access" %}</li>
                    <li><strong>Viewer:</strong> {% trans "Read-only access to project updates" %}</li>
                </ul>
                <hr>
                <p class="mb-2"><strong>{% trans "Access Permissions:" %}</strong></p>
                <ul class="mb-0">
                    <li>{% trans "Client & Owner can see project dashboard and approve colors" %}</li>
                    <li>{% trans "They will have permission to create change requests" %}</li>
                    <li>{% trans "They will receive notifications about project updates" %}</li>
                    <li>{% trans "Approvals will show who made them (Client vs Owner)" %}</li>
                </ul>
            </div>

            <!-- Back button -->
            <div class="d-flex justify-content-between mt-4">
                <a href="{% url 'client_detail' client.id %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-2"></i>
                    {% trans "Back to Client Profile" %}
                </a>
                <a href="{% url 'client_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-list-ul me-2"></i>
                    {% trans "View All Clients" %}
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
