{% extends "core/base_modern.html" %}
{% load i18n %}
{% load static %}

{% block title %}Master Schedule Center{% endblock %}

{% block extra_head %}
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<style>
  body.schedule-center { background:#f8fafc; }
  
  .schedule-header {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    color: white;
    padding: 2rem;
    border-radius: 16px;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
  }
  
  .schedule-header h1 {
    letter-spacing: -0.02em;
    color: white;
  }

  .schedule-header p {
    color: rgba(255,255,255,0.9);
  }
  
  .view-toggle {
    display: inline-flex;
    gap: 0.5rem;
    background: rgba(255,255,255,0.2);
    padding: 0.4rem;
    border-radius: 12px;
  }
  
  .toggle-btn {
    flex: 1;
    padding: 0.7rem 1.1rem;
    border: none;
    background: transparent;
    color: rgba(255,255,255,0.9);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  .toggle-btn:hover {
    background: rgba(255,255,255,0.15);
    color: white;
  }
  
  .toggle-btn.active {
    background: white;
    color: #6366f1;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .view-content {
    display: none;
    animation: fadeIn 0.3s ease;
  }
  
  .view-content.active {
    display: block;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Gantt View Styles */
  .gantt-container {
      background: #fff;
      border-radius: 18px;
      padding: 1.75rem;
      box-shadow: 0 18px 32px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.04);
      overflow-x: auto;
    }
  
    .gantt-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .gantt-zoom {
      display: inline-flex;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
      background: #f8fafc;
    }

    .gantt-zoom button {
      padding: 0.5rem 0.9rem;
      border: none;
      background: transparent;
      font-weight: 600;
      color: #475569;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .gantt-zoom button.active {
      background: #0f172a;
      color: #f8fafc;
    }
  
    .gantt-timeline {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 1rem;
      min-width: 1200px;
    }

    .gantt-scale {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 1rem;
      margin-bottom: 0.75rem;
      align-items: stretch;
    }

    .gantt-scale-labels {
      color: #475569;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gantt-scale-ticks {
      position: relative;
      height: 42px;
      background: #f8fafc;
      border-radius: 10px;
      overflow: hidden;
      display: flex;
    }

    .gantt-scale-tick {
      position: relative;
      flex: 1;
      border-left: 1px solid #e2e8f0;
      display: flex;
      align-items: flex-end;
      padding: 0.35rem 0.35rem 0.45rem;
      font-size: 0.75rem;
      color: #475569;
      min-width: 50px;
      box-sizing: border-box;
    }

    .gantt-scale-tick:first-child { border-left: none; }

    .gantt-scale-tick.today {
      background: rgba(14,165,233,0.08);
      color: #0ea5e9;
      font-weight: 700;
    }
  
  .gantt-labels {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .gantt-label {
    padding: 1rem;
    background: #f1f5f9;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-height: 60px;
  }
  
  .gantt-label-name {
    color: #1e293b;
  }
  
  .gantt-label-meta {
    font-size: 0.75rem;
    color: #64748b;
    font-weight: 400;
  }
  
  .gantt-bars {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    position: relative;
  }

  .gantt-bar-row {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .gantt-bar-container {
    position: relative;
    height: 60px;
    background: #f8fafc;
    border-radius: 8px;
  }
  
  .gantt-bar {
    position: absolute;
    height: 100%;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    color: white;
    font-size: 0.875rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .gantt-bar:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  }
  
  .gantt-bar-progress {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: rgba(255,255,255,0.2);
    border-radius: 8px 0 0 8px;
    transition: width 0.5s ease;
  }
  
  .gantt-bar-content {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
  }
  
  .gantt-bar-text {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .gantt-bar-percent {
    background: rgba(0,0,0,0.2);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    margin-left: 0.5rem;
  }

  .gantt-item-row {
    position: relative;
    height: 40px;
    background: #f8fafc;
    border-radius: 8px;
    overflow: hidden;
  }

  .gantt-item-bar {
    position: absolute;
    height: 32px;
    top: 4px;
    border-radius: 8px;
    padding: 0.35rem 0.75rem;
    color: white;
    font-size: 0.8rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.35rem;
    box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: grab;
  }

  .gantt-item-bar:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 12px rgba(0,0,0,0.2);
  }

  .gantt-item-bar:active {
    cursor: grabbing;
  }

  .gantt-item-progress {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: rgba(255,255,255,0.25);
    border-radius: 8px 0 0 8px;
  }

  .gantt-item-text {
    position: relative;
    z-index: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .gantt-item-add {
    position: absolute;
    right: 6px;
    top: 4px;
    width: 24px;
    height: 24px;
    border-radius: 6px;
    background: rgba(255,255,255,0.18);
    color: #fff;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    cursor: pointer;
    z-index: 2;
    transition: background 0.15s ease, transform 0.15s ease;
  }

  .gantt-item-add:hover {
    background: rgba(255,255,255,0.28);
    transform: scale(1.05);
  }
  
  /* Calendar View Styles */
  .calendar-container {
    background: #fff;
    border-radius: 18px;
    padding: 1.75rem;
    box-shadow: 0 18px 32px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.04);
  }
  
  #calendar {
    max-width: 100%;
  }
  
  .fc {
    font-family: inherit;
  }
  
  .fc .fc-button-primary {
    background: #667eea;
    border-color: #667eea;
  }
  
  .fc .fc-button-primary:hover {
    background: #5568d3;
    border-color: #5568d3;
  }
  
  .fc .fc-button-primary:not(:disabled).fc-button-active {
    background: #4c51bf;
    border-color: #4c51bf;
  }
  
  /* Legend */
  .legend {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-top: 1.5rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
  }
  
  .legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
  }
  
  /* Loading State */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  
  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #e2e8f0;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  /* Task modal */
  .task-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .task-modal {
    background: #fff;
    border-radius: 14px;
    max-width: 520px;
    width: 92%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    overflow: hidden;
  }

  .task-modal header {
    padding: 16px 20px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .task-modal form {
    padding: 18px 20px 20px;
    display: grid;
    gap: 12px;
  }

  .task-modal label {
    font-weight: 600;
    color: #0f172a;
    font-size: 0.95rem;
  }

  .task-modal input,
  .task-modal select,
  .task-modal textarea {
    width: 100%;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 0.95rem;
  }

  .task-modal textarea { min-height: 90px; }

  .task-modal .actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 4px;
  }

  .btn-secondary {
    background: #e2e8f0;
    color: #0f172a;
    border: none;
    padding: 10px 14px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
  }

  .btn-primary {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
    border: none;
    padding: 10px 14px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    box-shadow: 0 10px 25px rgba(99,102,241,0.25);
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-top: 1.25rem;
  }
  
  .stat-card {
    background: rgba(255,255,255,0.15);
    padding: 1rem 1.25rem;
    border-radius: 12px;
    display: grid;
    gap: 0.25rem;
  }
  
  .stat-value {
    font-size: 1.75rem;
    font-weight: 800;
    color: white;
  }
  
  .stat-label {
    font-size: 0.85rem;
    color: rgba(255,255,255,0.8);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }
</style>
{% endblock %}

{% block page_header %}
<div class="schedule-header">
  <div class="flex items-center justify-between flex-wrap gap-4 mb-4">
    <div>
      <h1 class="text-4xl font-bold mb-2">ðŸ“Š Master Schedule Center</h1>
      <p class="text-gray-600">Strategic Overview & Tactical Planning</p>
    </div>
    <div class="view-toggle">
      <button class="toggle-btn active" data-view="gantt">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        Gantt View
      </button>
      <button class="toggle-btn" data-view="calendar">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        Calendar View
      </button>
    </div>
  </div>
  
  <div class="stats-grid" id="statsGrid">
    <div class="stat-card">
      <div class="stat-label">Active Projects</div>
      <div class="stat-value" id="statProjects">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Schedule Items</div>
      <div class="stat-value" id="statScheduleItems">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Upcoming Events</div>
      <div class="stat-value" id="statEvents">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">View Range</div>
      <div class="stat-value text-2xl" id="statRange">--</div>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<!-- Gantt View -->
<div class="view-content active" id="ganttView">
  <div class="gantt-container">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">Strategic Project Timeline</h2>
    <div id="ganttContent">
      <div class="text-center py-12 text-gray-400">Loading projects...</div>
    </div>
  </div>
</div>

<!-- Calendar View -->
<div class="view-content" id="calendarView">
  <div class="calendar-container">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">Tactical Event Calendar</h2>
    <div id="calendar"></div>
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background:#dc2626;"></div>
        <span>Invoices Due</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background:#f59e0b;"></div>
        <span>{% trans "Change Orders" %}</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background:#fb923c;"></div>
        <span class="text-muted text-xs">{% trans "Incluye Tasks, Change Orders, RFIs y Damages" %}</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background:#3b82f6;"></div>
        <span>Critical Tasks</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background:#8b5cf6;"></div>
        <span>Meetings</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background:#10b981;"></div>
        <span>Client Requests</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background:#06b6d4;"></div>
        <span>Material Requests</span>
      </div>
        <div class="legend-item">
          <div class="legend-color" style="background:#cbd5e1;"></div>
          <span>Schedule Items (status-coded)</span>
        </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
</div>

<!-- Task creation modal -->
<div class="task-modal-backdrop" id="taskModal">
  <div class="task-modal" role="dialog" aria-modal="true" aria-labelledby="taskModalTitle">
    <header>
      <div>
        <div class="text-sm text-white/80">{% trans "Nueva tarea" %}</div>
        <div class="text-lg font-bold" id="taskModalTitle">{% trans "Crear tarea" %}</div>
      </div>
      <button type="button" aria-label="Close" class="text-white/80" onclick="window.MasterSchedule.closeTaskModal()">âœ•</button>
    </header>
    <form id="taskForm">
      <input type="hidden" name="project" id="taskProject">
      <input type="hidden" name="schedule_item" id="taskScheduleItem">
      <div>
        <label for="taskTitle">{% trans "TÃ­tulo" %}</label>
        <input id="taskTitle" name="title" required placeholder="{% trans 'Ej. Definir alcance con cliente' %}">
      </div>
      <div>
        <label for="taskDueDate">{% trans "Fecha lÃ­mite" %}</label>
        <input id="taskDueDate" name="due_date" type="date">
      </div>
      <div>
        <label for="taskPriority">{% trans "Prioridad" %}</label>
        <select id="taskPriority" name="priority">
          <option value="medium">{% trans "Media" %}</option>
          <option value="high">{% trans "Alta" %}</option>
          <option value="urgent">{% trans "Urgente" %}</option>
          <option value="low">{% trans "Baja" %}</option>
        </select>
      </div>
      <div>
        <label for="taskDescription">{% trans "DescripciÃ³n" %}</label>
        <textarea id="taskDescription" name="description" placeholder="{% trans 'Notas opcionales' %}"></textarea>
      </div>
      <div class="actions">
        <button type="button" class="btn-secondary" onclick="window.MasterSchedule.closeTaskModal()">{% trans "Cancelar" %}</button>
        <button type="submit" class="btn-primary">{% trans "Crear" %}</button>
      </div>
    </form>
  </div>
</div>

<div class="task-modal-backdrop" id="itemDetailModal" aria-hidden="true">
  <div class="task-modal" role="dialog" aria-modal="true" aria-labelledby="itemDetailTitle">
    <header>
      <div class="text-lg font-bold" id="itemDetailTitle">{% trans "Detalle de item" %}</div>
      <button type="button" aria-label="Close" class="text-white/80" onclick="window.MasterSchedule.closeItemDetail()">âœ•</button>
    </header>
    <div style="padding: 18px 20px 12px; display: grid; gap: 10px;">
      <div><strong>{% trans "TÃ­tulo" %}:</strong> <span data-field="title">-</span></div>
      <div><strong>{% trans "Estado" %}:</strong> <span data-field="status">-</span></div>
      <div><strong>{% trans "Rango" %}:</strong> <span data-field="dates">-</span></div>
      <div><strong>{% trans "Progreso" %}:</strong> <span data-field="progress">0%</span></div>
    </div>
    <div class="actions" style="padding: 0 20px 18px; display:flex; justify-content:flex-end; gap:10px;">
      <button type="button" class="btn-secondary" onclick="window.MasterSchedule.closeItemDetail()">{% trans "Cerrar" %}</button>
      <a class="btn-secondary" data-action="edit" href="#" target="_blank" rel="noopener">{% trans "Ver/editar" %}</a>
      <button type="button" class="btn-primary" data-action="create-task">{% trans "Crear tarea" %}</button>
    </div>
  </div>
</div>

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<script>
(function() {
  'use strict';
  
  let scheduleData = null;
  let calendar = null;
  let scheduleItems = [];
  let ganttMinDate = null;
  let ganttTotalDays = 0;
  let ganttZoom = 'week';
  let dragState = null;
  
  // View Toggle Logic
  const toggleButtons = document.querySelectorAll('.toggle-btn');
  const viewContents = document.querySelectorAll('.view-content');
  
  toggleButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const viewType = btn.dataset.view;
      
      // Update active states
      toggleButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      viewContents.forEach(v => v.classList.remove('active'));
      document.getElementById(viewType + 'View').classList.add('active');
      
      // Render calendar if switching to it
      if (viewType === 'calendar' && calendar) {
        calendar.render();
      }
    });
  });
  
  // Fetch Schedule Data
  async function fetchScheduleData() {
    try {
      const headers = {
        'X-CSRFToken': getCookie('csrftoken')
      };
      const token = localStorage.getItem('access_token');
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }

      const response = await fetch('/api/v1/schedule/master/', {
        headers: headers
      });
      
      if (!response.ok) {
        throw new Error('Failed to fetch schedule data');
      }
      
      scheduleData = await response.json();
      
      // Update stats
  document.getElementById('statProjects').textContent = scheduleData.metadata.total_projects;
  document.getElementById('statEvents').textContent = scheduleData.metadata.total_events;
  document.getElementById('statScheduleItems').textContent = scheduleData.metadata.total_schedule_items;
      
      const startDate = new Date(scheduleData.metadata.date_range.start);
      const endDate = new Date(scheduleData.metadata.date_range.end);
      const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
      document.getElementById('statRange').textContent = `${daysDiff} days`;
      
      // Render views
  scheduleItems = scheduleData.schedule_items || [];
  renderGantt(scheduleData.projects, scheduleItems);
      initCalendar(scheduleData.events);
      
      document.getElementById('loadingOverlay').style.display = 'none';
    } catch (error) {
      console.error('Error fetching schedule:', error);
      alert('Failed to load schedule data. Please refresh the page.');
    }
  }
  
  // Render Gantt Chart
  function renderGantt(projects, scheduleItems = []) {
    if (!projects || projects.length === 0) {
      document.getElementById('ganttContent').innerHTML = '<div class="text-center py-12 text-gray-400">No active projects found.</div>';
      return;
    }
    
    // Calculate date range across projects and items
  const projectDates = projects.flatMap(p => [new Date(p.start_date), new Date(p.end_date)]);
  const itemDates = (scheduleItems || []).flatMap(si => [new Date(si.start_date), new Date(si.end_date)]);
    const allDates = [...projectDates, ...itemDates].filter(Boolean);
  const minDate = new Date(Math.min(...allDates));
  const maxDate = new Date(Math.max(...allDates));
  const totalDays = Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)));
  ganttMinDate = minDate;
  ganttTotalDays = totalDays;

    const ticks = buildScaleTicks(minDate, maxDate, ganttZoom);
    
    // Build Gantt HTML
    const labelsHTML = projects.map(p => `
      <div class="gantt-label">
        <div class="gantt-label-name">${escapeHtml(p.name)}</div>
        <div class="gantt-label-meta">PM: ${escapeHtml(p.pm_name)}</div>
        <div class="gantt-label-meta">Client: ${escapeHtml(p.client_name)}</div>
      </div>
    `).join('');
    
    const barsHTML = projects.map(p => {
      const start = new Date(p.start_date);
      const end = new Date(p.end_date);
      const daysFromStart = Math.ceil((start - minDate) / (1000 * 60 * 60 * 24));
      const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
      
      const leftPercent = (daysFromStart / totalDays) * 100;
      const widthPercent = (duration / totalDays) * 100;

      const itemsForProject = (scheduleItems || []).filter(si => si.project === p.id);
        const itemsHTML = itemsForProject.map(si => {
        const iStart = new Date(si.start_date);
        const iEnd = new Date(si.end_date);
        const iDaysFromStart = Math.max(0, Math.ceil((iStart - minDate) / (1000 * 60 * 60 * 24)));
        const iDuration = Math.max(1, Math.ceil((iEnd - iStart) / (1000 * 60 * 60 * 24)));
        const iLeftPercent = (iDaysFromStart / totalDays) * 100;
        const iWidthPercent = Math.max((iDuration / totalDays) * 100, 0.8);
        return `
          <div class="gantt-item-bar" data-item-id="${si.id}" data-project-id="${si.project}" data-start="${si.start_date}" data-end="${si.end_date}" data-url="${si.url || ''}" data-title="${escapeHtml(si.title)}" data-status="${si.status}" data-progress="${si.percent_complete}" data-milestone="${si.is_milestone}">
            <div class="gantt-item-progress" style="width: ${si.percent_complete}%; background: rgba(255,255,255,0.25);"></div>
            <span class="gantt-item-text">${si.is_milestone ? 'ðŸš§ ' : ''}${escapeHtml(si.title)}</span>
            <button type="button" class="gantt-item-add" data-item-id="${si.id}" title="{% trans 'Agregar tarea' %}">+</button>
          </div>
        `;
      }).join('');
      
      return `
        <div class="gantt-bar-row">
          <div class="gantt-bar-container">
            <div class="gantt-bar" 
                 style="left: ${leftPercent}%; width: ${widthPercent}%; background: ${p.color};"
                 onclick="window.location.href='${p.url}'"
                 title="${escapeHtml(p.name)} - PM: ${escapeHtml(p.pm_name)} - Client: ${escapeHtml(p.client_name)}">
              <div class="gantt-bar-progress" style="width: ${p.progress_pct}%;"></div>
              <div class="gantt-bar-content">
                <span class="gantt-bar-text">${escapeHtml(p.name)}</span>
                <span class="gantt-bar-percent">${p.progress_pct}%</span>
              </div>
            </div>
          </div>
          ${itemsForProject.length ? `<div class="gantt-item-row">${itemsHTML}</div>` : ''}
        </div>
      `;
    }).join('');
    
    document.getElementById('ganttContent').innerHTML = `
      <div class="gantt-toolbar">
        <div class="text-sm text-slate-600">Rango: ${formatDate(minDate)} â†’ ${formatDate(maxDate)} Â· ${totalDays}d</div>
        <div class="gantt-zoom" role="group" aria-label="Zoom timeline">
          <button type="button" class="${ganttZoom === 'day' ? 'active' : ''}" data-zoom="day">DÃ­a</button>
          <button type="button" class="${ganttZoom === 'week' ? 'active' : ''}" data-zoom="week">Semana</button>
          <button type="button" class="${ganttZoom === 'month' ? 'active' : ''}" data-zoom="month">Mes</button>
        </div>
      </div>
      <div class="gantt-scale">
        <div class="gantt-scale-labels">LÃ­nea de tiempo</div>
        <div class="gantt-scale-ticks">
          ${ticks.map(t => `<div class="gantt-scale-tick ${t.isToday ? 'today' : ''}" style="flex: ${t.flex}">${t.label}</div>`).join('')}
        </div>
      </div>
      <div class="gantt-timeline">
        <div class="gantt-labels">${labelsHTML}</div>
        <div class="gantt-bars">${barsHTML}</div>
      </div>
    `;

    attachGanttInteractions();

    // Zoom button handlers
    document.querySelectorAll('.gantt-zoom button').forEach(btn => {
      btn.addEventListener('click', () => {
        const z = btn.dataset.zoom;
        if (z && z !== ganttZoom) {
          ganttZoom = z;
          renderGantt(projects, scheduleItems);
        }
      });
    });
  }

  function buildScaleTicks(minDate, maxDate, zoom) {
    const ticks = [];
    const stepDays = zoom === 'day' ? 1 : zoom === 'month' ? 30 : 7;
    const totalDays = Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)));
    const count = Math.max(1, Math.ceil(totalDays / stepDays));
    for (let i = 0; i < count; i++) {
      const d = addDays(minDate, i * stepDays);
      const label = zoom === 'month' ? d.toLocaleString(undefined, { month: 'short', year: 'numeric' }) : d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      ticks.push({ label, isToday: isSameDay(d, new Date()), flex: stepDays });
    }
    return ticks;
  }

  function attachGanttInteractions() {
    const bars = document.querySelectorAll('.gantt-item-bar');
    bars.forEach(bar => {
      const itemId = bar.dataset.itemId;
      const start = new Date(bar.dataset.start);
      const end = new Date(bar.dataset.end);
      const barsContainer = bar.closest('.gantt-bars');
      const widthPx = barsContainer ? barsContainer.getBoundingClientRect().width : 1;

      // Position bar based on dates
      const daysFromStart = Math.max(0, Math.ceil((start - ganttMinDate) / (1000 * 60 * 60 * 24)));
      const duration = Math.max(1, Math.ceil((end - start) / (1000 * 60 * 60 * 24)));
      const leftPercent = (daysFromStart / ganttTotalDays) * 100;
      const widthPercent = Math.max((duration / ganttTotalDays) * 100, 0.8);
      bar.style.left = `${leftPercent}%`;
      bar.style.width = `${widthPercent}%`;

      bar.addEventListener('mousedown', (e) => {
        if ((e.target && e.target.classList.contains('gantt-item-add'))) return;
        // Only start drag with primary button
        if (e.button !== 0) return;
        dragState = {
          el: bar,
          startX: e.clientX,
          origStart: start,
          origEnd: end,
          widthPx,
        };
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
      });

      // Click opens detail modal (without dragging)
      bar.addEventListener('click', (e) => {
        if (dragState) return; // ignore if in drag
        if (e.target && e.target.classList.contains('gantt-item-add')) return;
        const itemId = bar.dataset.itemId;
        const item = scheduleItems.find(si => String(si.id) === String(itemId));
        if (item) {
          openItemDetail(item);
        }
      });
    });

    const addButtons = document.querySelectorAll('.gantt-item-add');
    addButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const itemId = btn.dataset.itemId;
        const item = scheduleItems.find(si => String(si.id) === String(itemId));
        if (item) {
          openTaskModal(item);
        }
      });
    });
  }

  function onDragMove(e) {
    if (!dragState) return;
    const deltaX = e.clientX - dragState.startX;
    const pxPerDay = dragState.widthPx / ganttTotalDays;
    const deltaDays = Math.round(deltaX / pxPerDay);
    const newStart = addDays(dragState.origStart, deltaDays);
    const newEnd = addDays(dragState.origEnd, deltaDays);
    const daysFromStart = Math.max(0, Math.ceil((newStart - ganttMinDate) / (1000 * 60 * 60 * 24)));
    const duration = Math.max(1, Math.ceil((newEnd - newStart) / (1000 * 60 * 60 * 24)));
    const leftPercent = (daysFromStart / ganttTotalDays) * 100;
    const widthPercent = Math.max((duration / ganttTotalDays) * 100, 0.8);
    dragState.el.style.left = `${leftPercent}%`;
    dragState.el.style.width = `${widthPercent}%`;
    dragState.newStart = newStart;
    dragState.newEnd = newEnd;
  }

  function onDragEnd() {
    if (!dragState) return;
    document.removeEventListener('mousemove', onDragMove);
    document.removeEventListener('mouseup', onDragEnd);
    const { newStart, newEnd, origStart, origEnd, el } = dragState;
    const itemId = el.dataset.itemId;
    dragState = null;
    if (newStart && newEnd && (newStart.toDateString() !== origStart.toDateString() || newEnd.toDateString() !== origEnd.toDateString())) {
      saveScheduleItemDates(itemId, newStart, newEnd);
    }
  }

  async function saveScheduleItemDates(itemId, startDate, endDate) {
    try {
      const payload = {
        updates: [
          {
            id: Number(itemId),
            planned_start: startDate.toISOString().slice(0, 10),
            planned_end: endDate.toISOString().slice(0, 10),
          },
        ],
      };
      const res = await fetch('/api/v1/scheduleitems/bulk_update/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        throw new Error('Failed to save dates');
      }
      const updated = await res.json();
      if (Array.isArray(updated)) {
        scheduleItems = scheduleItems.map(si => {
          const hit = updated.find(u => u.id === si.id);
          return hit ? { ...si, start_date: hit.planned_start, end_date: hit.planned_end } : si;
        });
      }
    } catch (err) {
      console.error(err);
      alert('{% trans "No se pudo guardar las fechas. Intenta de nuevo." %}');
    }
  }

  function openTaskModal(item) {
    const modal = document.getElementById('taskModal');
    document.getElementById('taskProject').value = item.project;
    document.getElementById('taskScheduleItem').value = item.id;
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDescription').value = '';
    document.getElementById('taskPriority').value = 'medium';
    document.getElementById('taskDueDate').value = item.start_date ? item.start_date.slice(0,10) : '';
    modal.style.display = 'flex';
  }

  function openItemDetail(item) {
    const detail = document.getElementById('itemDetailModal');
    detail.querySelector('[data-field="title"]').textContent = item.title || '-';
    detail.querySelector('[data-field="status"]').textContent = item.status || '-';
    detail.querySelector('[data-field="dates"]').textContent = `${item.start_date} â†’ ${item.end_date}`;
    detail.querySelector('[data-field="progress"]').textContent = `${item.percent_complete || 0}%`;
    const editLink = detail.querySelector('[data-action="edit"]');
    editLink.href = item.url || '#';
    editLink.target = '_blank';
    editLink.rel = 'noopener noreferrer';

    const createTaskBtn = detail.querySelector('[data-action="create-task"]');
    createTaskBtn.onclick = () => {
      closeItemDetail();
      openTaskModal(item);
    };
    detail.style.display = 'flex';
  }

  function closeItemDetail() {
    const detail = document.getElementById('itemDetailModal');
    detail.style.display = 'none';
  }

  function closeTaskModal() {
    const modal = document.getElementById('taskModal');
    modal.style.display = 'none';
  }

  async function submitTaskForm(e) {
    e.preventDefault();
    const form = document.getElementById('taskForm');
    const data = Object.fromEntries(new FormData(form));
    try {
      const res = await fetch('/api/v1/tasks/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify(data),
      });
      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData.detail || 'Error creating task');
      }
      closeTaskModal();
      alert('{% trans "Tarea creada" %}');
    } catch (err) {
      console.error(err);
      alert(err.message || '{% trans "No se pudo crear la tarea" %}');
    }
  }
  
  // Initialize FullCalendar
  function initCalendar(events) {
    const calendarEl = document.getElementById('calendar');
    
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,listWeek'
      },
      events: events.map(e => ({
        title: e.title,
        start: e.start,
        end: e.end || e.start,
        backgroundColor: e.color,
        borderColor: e.color,
        url: e.url,
        extendedProps: {
          description: e.description,
          type: e.type
        }
      })),
      eventClick: function(info) {
        info.jsEvent.preventDefault();
        if (info.event.url) {
          window.location.href = info.event.url;
        }
      },
      eventDidMount: function(info) {
        // Add tooltip
        if (info.event.extendedProps.description) {
          info.el.title = info.event.extendedProps.description;
        }
      },
      height: 'auto',
      eventTimeFormat: {
        hour: '2-digit',
        minute: '2-digit',
        meridiem: false
      }
    });
    
    // Don't render calendar immediately if not visible
    if (document.getElementById('calendarView').classList.contains('active')) {
      calendar.render();
    }
  }
  
  // Utility Functions
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function isSameDay(a, b) {
    return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
  }

  function formatDate(d) {
    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
  }

  function addDays(date, days) {
    const d = new Date(date);
    d.setDate(d.getDate() + days);
    return d;
  }
  
  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    document.body.classList.add('schedule-center');
    fetchScheduleData();
    document.getElementById('taskForm').addEventListener('submit', submitTaskForm);
    window.MasterSchedule = { closeTaskModal, closeItemDetail };
  });
})();
</script>
{% endblock %}
