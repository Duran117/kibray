{% extends "core/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Admin Dashboard" %} - Kibray{% endblock %}

{% block extra_css %}
<style>
  .hover-lift { transition: transform .2s ease, box-shadow .2s ease; }
  .hover-lift:hover { transform: translateY(-5px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important; }

  /* Upcoming Events widget styles */
  #upcomingEventsWidget .event-item {
    border-left: 3px solid var(--bs-secondary);
    padding-left: .75rem;
    transition: background-color .2s ease, border-color .2s ease;
  }
  #upcomingEventsWidget .event-item:hover {
    background-color: rgba(0,0,0,.02);
    border-color: var(--bs-primary);
  }
  #upcomingEventsWidget .event-date-col {
    min-width: 72px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3 py-md-4">
  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 mb-md-4 gap-2">
    <h2 class="mb-0 h3 h-md-2">
      <i class="bi bi-speedometer2 text-primary"></i> 
      {% trans "Admin Dashboard" %}
    </h2>
    <div class="text-muted small">{{ today|date:"D, M d, Y" }}</div>
  </div>

  <!-- Panel Administrativo Avanzado - Acceso r√°pido -->
  <div class="alert alert-info border-0 shadow-sm mb-4">
    <div class="row align-items-center">
      <div class="col-md-9">
        <h5 class="mb-1">
          <i class="bi bi-gear-fill me-2"></i>
          {% trans "Panel Administrativo Avanzado" %}
        </h5>
        <p class="mb-0 small">
          {% trans "Gesti√≥n CRUD de usuarios, proyectos, finanzas, permisos y logs del sistema" %}
        </p>
      </div>
      <div class="col-md-3 text-end mt-2 mt-md-0">
        <a href="{% url 'admin_panel_main' %}" class="btn btn-outline-primary">
          <i class="bi bi-box-arrow-up-right me-2"></i>
          <span class="d-none d-md-inline">{% trans "Abrir Panel" %}</span>
          <span class="d-md-none">{% trans "Panel" %}</span>
        </a>
      </div>
    </div>
  </div>

  <!-- === ACCIONES R√ÅPIDAS === -->
  <div class="card shadow-sm mb-3 mb-md-4">
    <div class="card-body p-3">
      <h6 class="text-muted mb-3">
        <i class="bi bi-lightning-charge-fill me-2"></i>
        {% trans "Acciones R√°pidas" %}
      </h6>
      <div class="row g-2">
        <div class="col-6 col-md-3 col-lg-2">
          <a href="{% url 'strategic_planner' %}" class="btn btn-warning w-100 d-flex flex-column align-items-center p-3">
            <i class="bi bi-compass-fill fs-4 mb-2"></i>
            <span class="small">{% trans "Strategic Planner" %}</span>
          </a>
        </div>
        <div class="col-6 col-md-3 col-lg-2">
          <a href="{% url 'client_create' %}" class="btn btn-primary w-100 d-flex flex-column align-items-center p-3">
            <i class="bi bi-person-plus-fill fs-4 mb-2"></i>
            <span class="small">{% trans "Nuevo Cliente" %}</span>
          </a>
        </div>
        <div class="col-6 col-md-3 col-lg-2">
          <a href="{% url 'project_create' %}" class="btn btn-success w-100 d-flex flex-column align-items-center p-3">
            <i class="bi bi-folder-plus fs-4 mb-2"></i>
            <span class="small">{% trans "Nuevo Proyecto" %}</span>
          </a>
        </div>
        <div class="col-6 col-md-3 col-lg-2">
          <a href="{% url 'client_list' %}" class="btn btn-outline-primary w-100 d-flex flex-column align-items-center p-3">
            <i class="bi bi-people-fill fs-4 mb-2"></i>
            <span class="small">{% trans "Ver Clientes" %}</span>
          </a>
        </div>
        <div class="col-6 col-md-3 col-lg-2">
          <a href="{% url 'project_list' %}" class="btn btn-outline-success w-100 d-flex flex-column align-items-center p-3">
            <i class="bi bi-folder-fill fs-4 mb-2"></i>
            <span class="small">{% trans "Ver Proyectos" %}</span>
          </a>
        </div>
        <div class="col-6 col-md-3 col-lg-2">
          <a href="{% url 'expense_create' %}" class="btn btn-outline-danger w-100 d-flex flex-column align-items-center p-3">
            <i class="bi bi-cash-stack fs-4 mb-2"></i>
            <span class="small">{% trans "Nuevo Gasto" %}</span>
          </a>
        </div>
        <div class="col-6 col-md-3 col-lg-2">
          <a href="{% url 'income_create' %}" class="btn btn-outline-success w-100 d-flex flex-column align-items-center p-3">
            <i class="bi bi-wallet2 fs-4 mb-2"></i>
            <span class="small">{% trans "Nuevo Ingreso" %}</span>
          </a>
        </div>
        <div class="col-6 col-md-3 col-lg-2">
          <a href="{% url 'changeorder_create' %}" class="btn btn-outline-info w-100 d-flex flex-column align-items-center p-3">
            <i class="bi bi-file-earmark-plus fs-4 mb-2"></i>
            <span class="small">{% trans "Nuevo CO" %}</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- === STRATEGIC FOCUS === -->
  <div class="card shadow-sm mb-3 mb-md-4 border-warning">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0">
        <i class="bi bi-compass-fill me-2"></i>
        {% trans "Strategic Focus Today" %}
      </h5>
    </div>
    <div class="card-body p-3" id="strategicFocusWidget">
      <div class="text-center">
        <div class="spinner-border text-warning" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- === ALERTAS CR√çTICAS === -->
  <div class="row g-2 g-md-3 mb-3 mb-md-4">
    <!-- Tiempo sin CO -->
    <div class="col-6 col-md-3">
      <div class="card border-{% if unassigned_time_count > 0 %}danger{% else %}success{% endif %} h-100 shadow-sm">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <h6 class="text-muted mb-1 small">{% trans "Unassigned Time" %}</h6>
              <h3 class="mb-0 h4 h-md-3">{{ unassigned_time_count }}</h3>
              <small class="text-muted d-none d-sm-block">{{ unassigned_time_hours|floatformat:1 }}h {% trans "sin asignar" %}</small>
            </div>
            <i class="bi bi-clock-history fs-3 text-{% if unassigned_time_count > 0 %}danger{% else %}success{% endif %} d-none d-md-block"></i>
          </div>
          {% if unassigned_time_count > 0 %}
          <a href="{% url 'unassigned_timeentries' %}" class="btn btn-sm btn-outline-danger w-100 mt-2">
            <i class="bi bi-arrow-right-short"></i>
            <span class="d-none d-sm-inline">{% trans "Assign now" %}</span>
            <span class="d-sm-none">{% trans "Assign" %}</span>
          </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Solicitudes Cliente -->
    <div class="col-6 col-md-3">
      <div class="card border-{% if pending_client_requests > 0 %}warning{% else %}success{% endif %} h-100 shadow-sm">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <h6 class="text-muted mb-1 small">{% trans "Client Requests" %}</h6>
              <h3 class="mb-0 h4 h-md-3">{{ pending_client_requests }}</h3>
              <small class="text-muted d-none d-sm-block">{% trans "Pending approval" %}</small>
            </div>
            <i class="bi bi-person-plus fs-3 text-{% if pending_client_requests > 0 %}warning{% else %}success{% endif %} d-none d-md-block"></i>
          </div>
          {% if pending_client_requests > 0 %}
          <a href="{% url 'client_requests_list_all' %}" class="btn btn-sm btn-outline-warning w-100 mt-2">
            <i class="bi bi-arrow-right-short"></i>
            <span class="d-none d-sm-inline">{% trans "Review" %}</span>
            <span class="d-sm-none">{% trans "View" %}</span>
          </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- COs Pendientes -->
    <div class="col-6 col-md-3">
      <div class="card border-{% if pending_cos > 0 %}info{% else %}success{% endif %} h-100 shadow-sm">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <h6 class="text-muted mb-1 small">{% trans "Change Orders" %}</h6>
              <h3 class="mb-0 h4 h-md-3">{{ pending_cos }}</h3>
              <small class="text-muted d-none d-sm-block">{% trans "Awaiting approval" %}</small>
            </div>
            <i class="bi bi-file-earmark-text fs-3 text-{% if pending_cos > 0 %}info{% else %}success{% endif %} d-none d-md-block"></i>
          </div>
          {% if pending_cos > 0 %}
          <a href="{% url 'changeorder_board' %}" class="btn btn-sm btn-outline-info w-100 mt-2">
            <i class="bi bi-arrow-right-short"></i>
            <span class="d-none d-sm-inline">{% trans "Approve" %}</span>
            <span class="d-sm-none">{% trans "View" %}</span>
          </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Facturas Pendientes -->
    <div class="col-6 col-md-3">
      <div class="card border-{% if pending_invoices > 0 %}primary{% else %}success{% endif %} h-100 shadow-sm">
        <div class="card-body p-3">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="flex-grow-1">
              <h6 class="text-muted mb-1 small">{% trans "Pending Invoices" %}</h6>
              <h3 class="mb-0 h4 h-md-3">{{ pending_invoices }}</h3>
              <small class="text-muted d-none d-sm-block">${{ pending_invoice_amount|floatformat:2 }}</small>
            </div>
            <i class="bi bi-receipt fs-3 text-{% if pending_invoices > 0 %}primary{% else %}success{% endif %} d-none d-md-block"></i>
          </div>
          {% if pending_invoices > 0 %}
          <a href="{% url 'invoice_payment_dashboard' %}" class="btn btn-sm btn-outline-primary w-100 mt-2">
            <i class="bi bi-arrow-right-short"></i>
            <span class="d-none d-sm-inline">{% trans "View payments" %}</span>
            <span class="d-sm-none">{% trans "Payments" %}</span>
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- === M√âTRICAS FINANCIERAS === -->
  <div class="row g-2 g-md-3 mb-3 mb-md-4">
    <div class="col-12 col-md-4">
      <div class="card bg-success text-white h-100 shadow">
        <div class="card-body p-3">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <h6 class="text-white-50 mb-1 small">{% trans "Total Income" %}</h6>
              <h2 class="mb-0 h3 h-md-2">${{ total_income|floatformat:2 }}</h2>
            </div>
            <i class="bi bi-cash-stack fs-1 opacity-50 d-none d-md-block"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card bg-danger text-white h-100 shadow">
        <div class="card-body p-3">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <h6 class="text-white-50 mb-1 small">{% trans "Total Expenses" %}</h6>
              <h2 class="mb-0 h3 h-md-2">${{ total_expense|floatformat:2 }}</h2>
            </div>
            <i class="bi bi-credit-card fs-1 opacity-50 d-none d-md-block"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card bg-{% if net_profit >= 0 %}primary{% else %}warning{% endif %} text-white h-100 shadow">
        <div class="card-body p-3">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <h6 class="text-white-50 mb-1 small">{% trans "Net Profit" %}</h6>
              <h2 class="mb-0 h3 h-md-2">${{ net_profit|floatformat:2 }}</h2>
            </div>
            <i class="bi bi-graph-up-arrow fs-1 opacity-50 d-none d-md-block"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- === MAIN NAVIGATION (Module shortcuts) === -->
  <div class="card shadow-sm mb-3 mb-md-4">
    <div class="card-body p-3">
      <h6 class="text-muted mb-3">
        <i class="bi bi-grid-3x3-gap-fill me-2"></i>
        {% trans "Navigation" %}
      </h6>
      <div class="row g-2 g-md-3">
        <!-- Focus Wizard -->
        <div class="col-6 col-md-3">
          <a href="{% url 'focus_wizard' %}" class="btn btn-outline-dark w-100 d-flex flex-column align-items-center gap-1 py-3 hover-lift">
            <i class="bi bi-bullseye fs-3 d-none d-md-block"></i>
            <i class="bi bi-bullseye fs-5 d-md-none"></i>
            <span class="small text-nowrap">{% trans "Focus Wizard" %}</span>
          </a>
        </div>
        <!-- Strategic Planner -->
        <div class="col-6 col-md-3">
          <a href="{% url 'strategic_planner' %}" class="btn btn-outline-warning w-100 d-flex flex-column align-items-center gap-1 py-3 hover-lift">
            <i class="bi bi-compass fs-3 d-none d-md-block"></i>
            <i class="bi bi-compass fs-5 d-md-none"></i>
            <span class="small text-nowrap">{% trans "Strategic Planner" %}</span>
          </a>
        </div>
        <!-- Master Schedule -->
        <div class="col-6 col-md-3">
          <a href="{% url 'master_schedule_center' %}" class="btn btn-outline-primary w-100 d-flex flex-column align-items-center gap-1 py-3 hover-lift">
            <i class="bi bi-calendar3 fs-3 d-none d-md-block"></i>
            <i class="bi bi-calendar3 fs-5 d-md-none"></i>
            <span class="small text-nowrap">{% trans "Master Schedule" %}</span>
          </a>
        </div>
        <!-- BI Dashboard -->
        <div class="col-6 col-md-3">
          <a href="{% url 'dashboard_bi' %}" class="btn btn-outline-info w-100 d-flex flex-column align-items-center gap-1 py-3 hover-lift">
            <i class="bi bi-bar-chart-fill fs-3 d-none d-md-block"></i>
            <i class="bi bi-bar-chart-fill fs-5 d-md-none"></i>
            <span class="small text-nowrap">{% trans "BI Dashboard" %}</span>
          </a>
        </div>
        <!-- Daily Plans -->
        <div class="col-6 col-md-3">
          <a href="{% url 'strategic_planner' %}" class="btn btn-outline-success w-100 d-flex flex-column align-items-center gap-1 py-3 hover-lift">
            <i class="bi bi-calendar-check fs-3 d-none d-md-block"></i>
            <i class="bi bi-calendar-check fs-5 d-md-none"></i>
            <span class="small text-nowrap">{% trans "Daily Plans" %}</span>
          </a>
        </div>
        <!-- Morning View -->
        <div class="col-6 col-md-3">
          <a href="{% url 'dashboard_employee' %}" class="btn btn-outline-secondary w-100 d-flex flex-column align-items-center gap-1 py-3 hover-lift">
            <i class="bi bi-sunrise fs-3 d-none d-md-block"></i>
            <i class="bi bi-sunrise fs-5 d-md-none"></i>
            <span class="small text-nowrap">{% trans "Morning View" %}</span>
          </a>
        </div>
        <!-- SOP Library (point to Files navigation) -->
        <div class="col-6 col-md-3">
          <a href="{% url 'navigation_files' %}" class="btn btn-outline-dark w-100 d-flex flex-column align-items-center gap-1 py-3 hover-lift">
            <i class="bi bi-book fs-3 d-none d-md-block"></i>
            <i class="bi bi-book fs-5 d-md-none"></i>
            <span class="small text-nowrap">{% trans "SOP Library" %}</span>
          </a>
        </div>
        <!-- Financial -->
        <div class="col-6 col-md-3">
          <a href="{% url 'financial_dashboard' %}" class="btn btn-outline-success w-100 d-flex flex-column align-items-center gap-1 py-3 hover-lift">
            <i class="bi bi-cash-coin fs-3 d-none d-md-block"></i>
            <i class="bi bi-cash-coin fs-5 d-md-none"></i>
            <span class="small text-nowrap">{% trans "Financial" %}</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- === PROYECTOS CON ALERTAS === -->
  {% if projects_with_alerts %}
  <div class="card mb-3 mb-md-4 shadow-sm">
    <div class="card-header bg-danger text-white">
      <h5 class="mb-0">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        {% trans "Projects with Alerts" %}
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="ps-3">{% trans "Project" %}</th>
              <th>{% trans "Alerts" %}</th>
              <th class="text-end d-none d-md-table-cell">SPI</th>
              <th class="text-end d-none d-md-table-cell">CPI</th>
              <th class="text-end pe-3">{% trans "Actions" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for item in projects_with_alerts %}
            <tr>
              <td class="ps-3">
                <strong class="d-block">{{ item.project.name }}</strong>
                <small class="text-muted d-md-none">
                  {% if item.metrics.SPI %}
                    SPI: <span class="badge bg-{% if item.metrics.SPI < 0.9 %}danger{% elif item.metrics.SPI < 1 %}warning{% else %}success{% endif %} badge-sm">{{ item.metrics.SPI|floatformat:2 }}</span>
                  {% endif %}
                  {% if item.metrics.CPI %}
                    CPI: <span class="badge bg-{% if item.metrics.CPI < 0.9 %}danger{% elif item.metrics.CPI < 1 %}warning{% else %}success{% endif %} badge-sm">{{ item.metrics.CPI|floatformat:2 }}</span>
                  {% endif %}
                </small>
              </td>
              <td>
                <div class="d-flex flex-wrap gap-1">
                  {% for alert_type, alert_msg in item.alerts %}
                  <span class="badge bg-{{ alert_type }} small">{{ alert_msg }}</span>
                  {% endfor %}
                </div>
              </td>
              <td class="text-end d-none d-md-table-cell">
                {% if item.metrics.SPI %}
                <span class="badge bg-{% if item.metrics.SPI < 0.9 %}danger{% elif item.metrics.SPI < 1 %}warning{% else %}success{% endif %}">
                  {{ item.metrics.SPI|floatformat:2 }}
                </span>
                {% else %}‚Äî{% endif %}
              </td>
              <td class="text-end d-none d-md-table-cell">
                {% if item.metrics.CPI %}
                <span class="badge bg-{% if item.metrics.CPI < 0.9 %}danger{% elif item.metrics.CPI < 1 %}warning{% else %}success{% endif %}">
                  {{ item.metrics.CPI|floatformat:2 }}
                </span>
                {% else %}‚Äî{% endif %}
              </td>
              <td class="text-end pe-3">
                <a href="{% url 'project_overview' item.project.id %}" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-speedometer2 d-md-none"></i>
                  <span class="d-none d-md-inline">{% trans "Dashboard" %}</span>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row g-2 g-md-3 mb-3 mb-md-4">
    <!-- === APROBACIONES PENDIENTES === -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-warning">
          <h5 class="mb-0">
            <i class="bi bi-check-circle me-2"></i>
            {% trans "Pending Approvals" %}
          </h5>
        </div>
        <div class="card-body">
          <!-- COs -->
          {% if pending_cos_list %}
          <h6 class="text-muted mb-2 small">
            <i class="bi bi-file-earmark-text me-1"></i>
            Change Orders ({{ pending_cos }})
          </h6>
          <ul class="list-group mb-3">
            {% for co in pending_cos_list %}
            <li class="list-group-item p-2 p-md-3">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                <div class="flex-grow-1">
                  <strong class="d-block">CO #{{ co.id }}</strong>
                  <span class="text-muted small">{{ co.project.name }}</span>
                  <div class="d-none d-md-block">
                    <small class="text-muted">{{ co.description|truncatewords:10 }}</small>
                  </div>
                </div>
                <div class="d-flex align-items-center gap-2 w-100 w-md-auto">
                  <div class="fw-bold text-success flex-grow-1 flex-md-grow-0">${{ co.amount|floatformat:2 }}</div>
                  <a href="{% url 'changeorder_detail' co.id %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-check-lg d-md-none"></i>
                    <span class="d-none d-md-inline">{% trans "Approve" %}</span>
                  </a>
                </div>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% endif %}

          <!-- Solicitudes Cliente -->
          {% if pending_requests_list %}
          <h6 class="text-muted mb-2 small">
            <i class="bi bi-person-plus me-1"></i>
            {% trans "Client Requests" %} ({{ pending_client_requests }})
          </h6>
          <ul class="list-group">
            {% for req in pending_requests_list %}
            <li class="list-group-item p-2 p-md-3">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                <div class="flex-grow-1">
                  <strong class="d-block">CR #{{ req.id }}</strong>
                  <span class="text-muted small">{{ req.project.name }}</span>
                  <div class="d-none d-md-block">
                    <small class="text-muted">{{ req.title }}</small>
                  </div>
                </div>
                <a href="{% url 'client_request_convert' req.id %}" class="btn btn-sm btn-outline-success w-100 w-md-auto">
                  <i class="bi bi-arrow-repeat d-md-none"></i>
                  <span class="d-none d-md-inline">{% trans "Convert" %}</span>
                </a>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% endif %}

          {% if not pending_cos_list and not pending_requests_list %}
          <div class="text-center py-4">
            <i class="bi bi-check-circle-fill text-success fs-1 mb-2"></i>
            <p class="text-muted mb-0">{% trans "No pending approvals" %}</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- === N√ìMINA Y TIEMPO === -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-calendar-week me-2"></i>
            {% trans "Payroll & Time" %}
          </h5>
        </div>
        <div class="card-body">
          {% if latest_payroll_period %}
          <h6 class="text-muted small">{% trans "Latest Payroll Period" %}</h6>
          <div class="mb-3 p-3 bg-light rounded">
            <div class="row g-2 small">
              <div class="col-12 col-sm-6">
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">{% trans "Week" %}:</span>
                  <strong>{{ latest_payroll_period.week_start|date:"M d" }} - {{ latest_payroll_period.week_end|date:"M d" }}</strong>
                </div>
              </div>
              <div class="col-12 col-sm-6">
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">{% trans "Status" %}:</span>
                  <span class="badge bg-{{ latest_payroll_period.status }}">{{ latest_payroll_period.get_status_display }}</span>
                </div>
              </div>
              <div class="col-6">
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">{% trans "Total" %}:</span>
                  <strong>${{ latest_payroll_period.total_payroll|floatformat:2 }}</strong>
                </div>
              </div>
              <div class="col-6">
                <div class="d-flex justify-content-between mb-2">
                  <span class="text-muted">{% trans "Paid" %}:</span>
                  <strong class="text-success">${{ latest_payroll_period.total_paid|floatformat:2 }}</strong>
                </div>
              </div>
              <div class="col-12">
                <div class="d-flex justify-content-between">
                  <span class="text-muted">{% trans "Pending" %}:</span>
                  <strong class="text-danger">${{ payroll_balance|floatformat:2 }}</strong>
                </div>
              </div>
            </div>
            <a href="{% url 'payroll_weekly_review' %}" class="btn btn-sm btn-primary w-100 mt-2">
              <i class="bi bi-calendar-check me-1"></i>
              {% trans "Review Payroll" %}
            </a>
          </div>
          {% endif %}

          <h6 class="text-muted mt-3 small">{% trans "Time Recorded" %}</h6>
          <div class="row g-2">
            <div class="col-6">
              <div class="p-3 bg-light rounded text-center">
                <small class="text-muted d-block">{% trans "Today" %}</small>
                <h4 class="mb-0">{{ today_hours|floatformat:1 }}h</h4>
                <small class="text-muted">${{ today_labor_cost|floatformat:2 }}</small>
              </div>
            </div>
            <div class="col-6">
              <div class="p-3 bg-light rounded text-center">
                <small class="text-muted d-block">{% trans "This Week" %}</small>
                <h4 class="mb-0">{{ week_hours|floatformat:1 }}h</h4>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- === RESUMEN PROYECTOS === -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body text-center">
          <h1 class="display-4 text-primary">{{ active_projects }}</h1>
          <p class="text-muted mb-0">{% trans "Proyectos Activos" %}</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-body text-center">
          <h1 class="display-4 text-secondary">{{ completed_projects }}</h1>
          <p class="text-muted mb-0">{% trans "Proyectos Completados" %}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- === UPCOMING EVENTS === -->
  <div class="card shadow-sm mb-3 mb-md-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0 h6 h-md-5">
        <i class="bi bi-calendar-event text-primary me-2"></i>
        {% trans "Upcoming Events" %}
      </h5>
      <span class="small text-muted d-none d-md-inline">{% trans "Next 5" %}</span>
    </div>
    <div class="card-body p-2 p-md-3" id="upcomingEventsWidget">
      <div class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- === GR√ÅFICOS === -->
  <div class="row g-3 mb-4">
    <div class="col-lg-6">
  <!-- === CHARTS ROW === -->
  <div class="row g-2 g-md-3 mb-3 mb-md-4">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0 h6 h-md-5">
            <i class="bi bi-graph-up text-primary me-2"></i>
            {% trans "Income vs Expenses" %} <span class="d-none d-md-inline">({% trans "Last 30 days" %})</span>
          </h5>
        </div>
        <div class="card-body p-2 p-md-3">
          <div style="position: relative; height: 250px;">
            <canvas id="incomeExpenseChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0 h6 h-md-5">
            <i class="bi bi-pie-chart text-warning me-2"></i>
            {% trans "Alerts Distribution" %}
          </h5>
        </div>
        <div class="card-body p-2 p-md-3">
          <div style="position: relative; height: 250px;">
            <canvas id="alertsChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- === QUICK ACTIONS === -->
  <div class="card shadow-sm">
    <div class="card-header bg-white">
      <h5 class="mb-0 h6 h-md-5">
        <i class="bi bi-lightning-charge text-warning me-2"></i>
        {% trans "Quick Actions" %}
      </h5>
    </div>
    <div class="card-body p-2 p-md-3">
      <div class="row g-2">
        <!-- Projects -->
        <div class="col-6 col-sm-4 col-md-2">
          <a href="{% url 'project_list' %}" class="btn btn-outline-primary w-100 d-flex flex-column align-items-center gap-1 py-3">
            <i class="bi bi-folder fs-3 d-none d-md-block"></i>
            <i class="bi bi-folder fs-5 d-md-none"></i>
            <span class="small">{% trans "Projects" %}</span>
          </a>
        </div>
        <!-- Invoices -->
        <div class="col-6 col-sm-4 col-md-2">
          <a href="{% url 'invoice_list' %}" class="btn btn-outline-success w-100 d-flex flex-column align-items-center gap-1 py-3">
            <i class="bi bi-receipt fs-3 d-none d-md-block"></i>
            <i class="bi bi-receipt fs-5 d-md-none"></i>
            <span class="small">{% trans "Invoices" %}</span>
          </a>
        </div>
        <!-- Payroll -->
        <div class="col-6 col-sm-4 col-md-2">
          <a href="{% url 'payroll_weekly_review' %}" class="btn btn-outline-info w-100 d-flex flex-column align-items-center gap-1 py-3">
            <i class="bi bi-cash-stack fs-3 d-none d-md-block"></i>
            <i class="bi bi-cash-stack fs-5 d-md-none"></i>
            <span class="small">{% trans "Payroll" %}</span>
          </a>
        </div>
        <!-- Change Orders -->
        <div class="col-6 col-sm-4 col-md-2">
          <a href="{% url 'changeorder_board' %}" class="btn btn-outline-warning w-100 d-flex flex-column align-items-center gap-1 py-3">
            <i class="bi bi-file-earmark-text fs-3 d-none d-md-block"></i>
            <i class="bi bi-file-earmark-text fs-5 d-md-none"></i>
            <span class="small">{% trans "COs" %}</span>
          </a>
        </div>
        <!-- Planning -->
        <div class="col-6 col-sm-4 col-md-2">
          <a href="{% url 'daily_planning_dashboard' %}" class="btn btn-outline-secondary w-100 d-flex flex-column align-items-center gap-1 py-3">
            <i class="bi bi-calendar-check fs-3 d-none d-md-block"></i>
            <i class="bi bi-calendar-check fs-5 d-md-none"></i>
            <span class="small">{% trans "Planning" %}</span>
          </a>
        </div>
        <!-- Minutes -->
        <div class="col-6 col-sm-4 col-md-2">
          <a href="#" onclick="alert('{% trans "Select a project first" %}'); return false;" class="btn btn-outline-dark w-100 d-flex flex-column align-items-center gap-1 py-3">
            <i class="bi bi-journal-text fs-3 d-none d-md-block"></i>
            <i class="bi bi-journal-text fs-5 d-md-none"></i>
            <span class="small">{% trans "Minutes" %}</span>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- ACCESO AL PANEL ADMINISTRATIVO AVANZADO - Eliminado (ya est√° arriba) -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Income vs Expenses Chart
const ctx1 = document.getElementById('incomeExpenseChart');
if (ctx1) {
  new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: ['{% trans "Income" %}', '{% trans "Expenses" %}', '{% trans "Profit" %}'],
      datasets: [{
        label: 'USD',
        data: [
          {{ total_income|default:0 }},
          {{ total_expense|default:0 }},
          {{ net_profit|default:0 }}
        ],
        backgroundColor: [
          'rgba(75, 192, 192, 0.6)',
          'rgba(255, 99, 132, 0.6)',
          {{ net_profit|default:0 }} >= 0 ? 'rgba(54, 162, 235, 0.6)' : 'rgba(255, 193, 7, 0.6)'
        ],
        borderColor: [
          'rgba(75, 192, 192, 1)',
          'rgba(255, 99, 132, 1)',
          {{ net_profit|default:0 }} >= 0 ? 'rgba(54, 162, 235, 1)' : 'rgba(255, 193, 7, 1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return '$' + context.parsed.y.toLocaleString();
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toLocaleString();
            }
          }
        }
      }
    }
  });
}

// Alerts Distribution Chart
const ctx2 = document.getElementById('alertsChart');
if (ctx2) {
  new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: [
        '{% trans "Unassigned Time" %} ({{ unassigned_time_count }})',
        '{% trans "Client Requests" %} ({{ pending_client_requests }})',
        '{% trans "Pending COs" %} ({{ pending_cos }})',
        '{% trans "Invoices" %} ({{ pending_invoices }})',
        '{% trans "Materials" %} ({{ pending_materials }})'
      ],
      datasets: [{
        data: [
          {{ unassigned_time_count|default:0 }},
          {{ pending_client_requests|default:0 }},
          {{ pending_cos|default:0 }},
          {{ pending_invoices|default:0 }},
          {{ pending_materials|default:0 }}
        ],
        backgroundColor: [
          'rgba(220, 53, 69, 0.8)',
          'rgba(255, 193, 7, 0.8)',
          'rgba(13, 202, 240, 0.8)',
          'rgba(13, 110, 253, 0.8)',
          'rgba(111, 66, 193, 0.8)'
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: window.innerWidth < 768 ? 'bottom' : 'right',
          labels: { 
            padding: window.innerWidth < 768 ? 8 : 15, 
            font: { size: window.innerWidth < 768 ? 10 : 11 }
          }
        }
      }
    }
  });
}

// Load Strategic Focus Widget
async function loadStrategicFocus() {
  const widget = document.getElementById('strategicFocusWidget');
  if (!widget) return;
  
  try {
    const response = await fetch('/api/planner/ritual/today/');
    const data = await response.json();
    
    if (!data.has_ritual) {
      widget.innerHTML = `
        <div class="text-center py-4">
          <i class="bi bi-compass display-1 text-muted mb-3"></i>
          <h5 class="mb-2">{% trans "No plan for today yet" %}</h5>
          <p class="text-muted">{% trans "Kickstart your day with the Strategic Planner or Focus Wizard" %}</p>
          <div class="d-flex flex-column flex-sm-row justify-content-center gap-2 mt-2">
            <a href="{% url 'strategic_planner' %}" class="btn btn-warning">
              <i class="bi bi-compass me-2"></i>
              {% trans "Strategic Planner" %}
            </a>
            <a href="{% url 'focus_wizard' %}" class="btn btn-outline-dark">
              <i class="bi bi-bullseye me-2"></i>
              {% trans "Focus Wizard" %}
            </a>
          </div>
        </div>`;
      return;
    }
    
    if (!data.has_frog) {
      widget.innerHTML = `
        <div class="text-center py-4">
          <i class="bi bi-check-circle display-1 text-success mb-3"></i>
          <h5>{% trans "Ritual completed!" %}</h5>
          <p class="text-muted">{% trans "But no Frog was selected. Consider reviewing your high-impact actions." %}</p>
          <a href="{% url 'strategic_planner' %}" class="btn btn-outline-warning">
            <i class="bi bi-pencil-fill me-2"></i>
            {% trans "Review Ritual" %}
          </a>
        </div>
      `;
      return;
    }
    
    const frog = data.frog;
    const ritual = data.ritual;
    
    // Build micro-steps HTML
    let microStepsHtml = '';
    if (frog.micro_steps && frog.micro_steps.length > 0) {
      microStepsHtml = '<div class="mt-3"><h6 class="mb-2">{% trans "Battle Plan:" %}</h6>';
      frog.micro_steps.forEach((step, idx) => {
        const checked = step.done ? 'checked' : '';
        const textClass = step.done ? 'text-decoration-line-through text-muted' : '';
        microStepsHtml += `
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" ${checked} 
                   onchange="toggleMicroStep(${frog.id}, ${idx})">
            <label class="form-check-label ${textClass}">
              ${step.text}
            </label>
          </div>
        `;
      });
      microStepsHtml += '</div>';
    }
    
    // Time block info
    let timeBlockHtml = '';
    if (frog.scheduled_start && frog.scheduled_end) {
      const start = new Date(frog.scheduled_start).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
      const end = new Date(frog.scheduled_end).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
      timeBlockHtml = `
        <div class="alert alert-info mt-3 mb-0">
          <i class="bi bi-clock-fill me-2"></i>
          <strong>{% trans "Time Block:" %}</strong> ${start} - ${end} (${frog.duration_minutes} min)
        </div>
      `;
    }
    
    // Status badge
    const statusBadges = {
      'DRAFT': '<span class="badge bg-secondary">Draft</span>',
      'SCHEDULED': '<span class="badge bg-primary">Scheduled</span>',
      'DONE': '<span class="badge bg-success">‚úì Done</span>'
    };
    
    widget.innerHTML = `
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <h4 class="mb-1">üê∏ ${frog.title}</h4>
          ${statusBadges[frog.status]}
          <div class="small text-muted mt-1">
            {% trans "Energy Level:" %} ${ritual.energy_level}/10 | 
            {% trans "High Impact Actions:" %} ${ritual.high_impact_actions}
          </div>
        </div>
        <button class="btn btn-${frog.is_completed ? 'success' : 'outline-success'}" 
                onclick="toggleFrogStatus(${frog.id})">
          <i class="bi bi-check2-circle me-2"></i>
          ${frog.is_completed ? '{% trans "Completed" %}' : '{% trans "Mark Done" %}'}
        </button>
      </div>
      
      ${microStepsHtml}
      ${timeBlockHtml}
      
      <div class="progress mt-3" style="height: 8px;">
        <div class="progress-bar bg-success" role="progressbar" 
             style="width: ${frog.micro_steps_progress}%" 
             aria-valuenow="${frog.micro_steps_progress}" aria-valuemin="0" aria-valuemax="100">
        </div>
      </div>
      <div class="text-end small text-muted mt-1">
        ${frog.micro_steps_progress}% {% trans "Complete" %}
      </div>
    `;
    
  } catch (error) {
    console.error('Error loading strategic focus:', error);
    widget.innerHTML = `
      <div class="alert alert-warning mb-0">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {% trans "Could not load strategic focus. Please refresh." %}
      </div>
    `;
  }
}

async function toggleFrogStatus(actionId) {
  try {
    const response = await fetch(`/api/planner/action/${actionId}/toggle/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    
    if (response.ok) {
      loadStrategicFocus(); // Reload widget
    }
  } catch (error) {
    console.error('Error toggling frog status:', error);
  }
}

async function toggleMicroStep(actionId, stepIndex) {
  try {
    const response = await fetch(`/api/planner/action/${actionId}/step/${stepIndex}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken')
      }
    });
    
    if (response.ok) {
      loadStrategicFocus(); // Reload widget
    }
  } catch (error) {
    console.error('Error toggling micro step:', error);
  }
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Load on page load
document.addEventListener('DOMContentLoaded', () => {
  loadStrategicFocus();
  loadUpcomingEvents();
});

// Translation constants for Upcoming Events
const UNTITLED_TEXT = "{% trans 'Untitled' %}";
const FOCUS_BADGE_TEXT = "{% trans 'Focus' %}";
const PLAN_BADGE_TEXT = "{% trans 'Plan' %}";

// Upcoming Events loader
async function loadUpcomingEvents() {
  const container = document.getElementById('upcomingEventsWidget');
  if (!container) return;

  // Parse date from various field names. Note: API should return UTC timestamps
  // and browser will display in user's local timezone automatically via Date constructor.
  const toDate = (item) => {
    const keys = ['scheduled_at','scheduled_for','due_at','due_on','start','date','datetime'];
    for (const k of keys) {
      if (item[k]) {
        const d = new Date(item[k]);
        if (!isNaN(d)) return d;
      }
    }
    return null;
  };

  const normalize = (list, kind) => (list || []).map((it) => ({
    kind,
    title: it.title || it.name || it.summary || UNTITLED_TEXT,
    date: toDate(it),
    raw: it
  })).filter(x => !!x.date);

  try {
    const [focusRes, plansRes] = await Promise.allSettled([
      fetch('/api/v1/focus/tasks/upcoming/'),
      fetch('/api/v1/daily-plans/upcoming/')
    ]);

    // Log any API failures for debugging
    if (focusRes.status === 'rejected') {
      console.error('Focus API fetch failed:', focusRes.reason);
    } else if (!focusRes.value.ok) {
      console.error('Focus API returned error status:', focusRes.value.status);
    }
    if (plansRes.status === 'rejected') {
      console.error('Plans API fetch failed:', plansRes.reason);
    } else if (!plansRes.value.ok) {
      console.error('Plans API returned error status:', plansRes.value.status);
    }

    const focusJson = focusRes.status === 'fulfilled' && focusRes.value.ok
      ? await focusRes.value.json()
      : [];
    const plansJson = plansRes.status === 'fulfilled' && plansRes.value.ok
      ? await plansRes.value.json()
      : [];

    const combined = [
      ...normalize(focusJson, 'FOCUS'),
      ...normalize(plansJson, 'PLAN')
    ].sort((a,b) => a.date - b.date).slice(0,5);

    if (combined.length === 0) {
      container.innerHTML = `
        <div class="text-center text-muted py-3">
          <i class="bi bi-inboxes me-2"></i> {% trans "No upcoming items" %}
        </div>`;
      return;
    }

    container.innerHTML = combined.map(ev => {
      const d = ev.date;
      const dateStr = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      const timeStr = d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
      const badge = ev.kind === 'FOCUS' 
        ? `<span class="badge bg-dark me-2">${FOCUS_BADGE_TEXT}</span>`
        : `<span class="badge bg-success me-2">${PLAN_BADGE_TEXT}</span>`;
      return `
        <div class="event-item d-flex align-items-start gap-2 py-2 px-1">
          <div class="text-nowrap small text-muted event-date-col">
            <i class="bi bi-calendar-event me-1"></i>${dateStr}<span class="d-none d-sm-inline"> ¬∑ ${timeStr}</span>
          </div>
          <div class="flex-grow-1">
            ${badge}<strong>${ev.title}</strong>
          </div>
        </div>`;
    }).join('');

  } catch (err) {
    console.error('Upcoming events failed:', err);
    container.innerHTML = `
      <div class="alert alert-warning mb-0">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {% trans "Could not load upcoming events right now." %}
      </div>`;
  }
}
</script>
{% endblock %}
