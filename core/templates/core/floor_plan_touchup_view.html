{% extends "core/base_modern.html" %}
{% load static %}
{% load i18n %}
{% load core_extras %}

{% block title %}Touch-ups & Tasks - {{ plan.name }}{% endblock %}

{% block extra_css %}
<style>
:root{--fp-primary:#10b981;--fp-primary-dark:#059669;--fp-secondary:#3b82f6;--fp-warning:#f59e0b;--fp-danger:#ef4444;--fp-purple:#8b5cf6}
.fp-container{display:grid;grid-template-columns:1fr 380px;gap:1rem;min-height:80vh}
@media(max-width:1200px){.fp-container{grid-template-columns:1fr}}
.fp-header{background:linear-gradient(135deg,var(--fp-primary),var(--fp-primary-dark));border-radius:1rem;padding:1.25rem 1.5rem;color:white;margin-bottom:1rem}
.fp-header h1{font-size:1.35rem;font-weight:700;margin:0}
.fp-header-meta{display:flex;gap:1rem;margin-top:0.5rem;font-size:0.85rem;opacity:0.9}
.fp-canvas-card{background:white;border-radius:1rem;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
.fp-canvas-toolbar{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;border-bottom:1px solid #e2e8f0;background:#ecfdf5;flex-wrap:wrap;gap:0.5rem}
.fp-mode-group{display:flex;gap:0.25rem;background:#d1fae5;padding:0.25rem;border-radius:0.5rem}
.fp-mode-btn{padding:0.5rem 1rem;border:none;background:transparent;border-radius:0.375rem;font-size:0.8rem;font-weight:600;color:#065f46;cursor:pointer;display:flex;align-items:center;gap:0.375rem;transition:all 0.2s}
.fp-mode-btn:hover{color:#064e3b}
.fp-mode-btn.active{background:white;color:var(--fp-primary);box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.fp-zoom-group{display:flex;align-items:center;gap:0.5rem}
.fp-zoom-btn{width:32px;height:32px;border:1px solid #a7f3d0;border-radius:0.375rem;background:white;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fp-zoom-btn:hover{background:#ecfdf5}
.fp-zoom-level{font-size:0.75rem;font-weight:600;color:#065f46;min-width:45px;text-align:center}
.fp-canvas-wrapper{position:relative;background:#1e293b;overflow:auto;height:60vh;cursor:grab}
.fp-canvas-wrapper.grabbing{cursor:grabbing}
.fp-canvas-wrapper.crosshair{cursor:crosshair}
.fp-canvas-content{display:inline-block;position:relative;transform-origin:top left}
.fp-canvas-content img{display:block;max-width:none;user-select:none;-webkit-user-drag:none}
.fp-pins-layer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
.fp-pin{position:absolute;transform:translate(-50%,-100%);pointer-events:auto;cursor:pointer;z-index:10;transition:transform 0.2s}
.fp-pin:hover{transform:translate(-50%,-100%) scale(1.15);z-index:20}
.fp-pin.selected{transform:translate(-50%,-100%) scale(1.2);z-index:25}
.fp-pin-marker{width:32px;height:32px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:2px solid white}
.fp-pin-marker i{transform:rotate(45deg);color:white;font-size:0.8rem}
.fp-pin-marker.touchup{background:#10b981}
.fp-pin-marker.task{background:#3b82f6}
.fp-pin-marker.task-complete{background:#6b7280}
.fp-paths-svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
.fp-sidebar{display:flex;flex-direction:column;gap:1rem}
.fp-sidebar-card{background:white;border-radius:1rem;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
.fp-sidebar-header{padding:1rem 1.25rem;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
.fp-sidebar-header h3{font-size:0.95rem;font-weight:600;margin:0;display:flex;align-items:center;gap:0.5rem}
.fp-filter-tabs{display:flex;gap:0.25rem;padding:0.75rem 1rem;background:#f0fdf4;border-bottom:1px solid #e2e8f0;overflow-x:auto}
.fp-filter-tab{padding:0.375rem 0.75rem;border:none;background:transparent;border-radius:0.375rem;font-size:0.75rem;font-weight:600;color:#065f46;cursor:pointer;white-space:nowrap}
.fp-filter-tab:hover{background:white}
.fp-filter-tab.active{background:white;color:var(--fp-primary);box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.fp-work-list{max-height:50vh;overflow-y:auto;padding:0.75rem}
.fp-work-item{display:flex;align-items:flex-start;gap:0.75rem;padding:0.75rem;border-radius:0.5rem;cursor:pointer;margin-bottom:0.5rem;border-left:3px solid transparent}
.fp-work-item:hover{background:#f0fdf4}
.fp-work-item.selected{background:#ecfdf5;border-left-color:var(--fp-primary)}
.fp-work-item.touchup{border-left-color:#10b981}
.fp-work-item.task{border-left-color:#3b82f6}
.fp-work-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;margin-top:0.3rem}
.fp-work-dot.touchup{background:#10b981}
.fp-work-dot.task{background:#3b82f6}
.fp-work-dot.complete{background:#6b7280}
.fp-work-info{flex:1;min-width:0}
.fp-work-title{font-weight:600;font-size:0.85rem;color:#1e293b;margin-bottom:0.125rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fp-work-desc{font-size:0.75rem;color:#64748b;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.fp-work-badge{font-size:0.65rem;padding:0.15rem 0.4rem;border-radius:0.25rem;font-weight:600}
.fp-work-badge.pending{background:#fef3c7;color:#b45309}
.fp-work-badge.in-progress{background:#dbeafe;color:#1d4ed8}
.fp-work-badge.complete{background:#d1fae5;color:#065f46}
.fp-empty{text-align:center;padding:2rem 1rem;color:#94a3b8}
.fp-empty i{font-size:2.5rem;margin-bottom:0.75rem;opacity:0.5}
.fp-btn{padding:0.625rem 1.25rem;border-radius:0.5rem;font-weight:600;font-size:0.875rem;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:0.5rem}
.fp-btn-primary{background:var(--fp-primary);color:white}
.fp-btn-primary:hover{background:var(--fp-primary-dark)}
.fp-btn-secondary{background:white;color:#374151;border:1px solid #d1d5db}
.fp-btn-secondary:hover{background:#f9fafb}
.fp-btn-blue{background:var(--fp-secondary);color:white}
.fp-btn-blue:hover{background:#2563eb}
.fp-btn-sm{padding:0.375rem 0.75rem;font-size:0.75rem}
.fp-mobile-toggle{display:none;position:fixed;bottom:1rem;right:1rem;z-index:100}
@media(max-width:1200px){
.fp-mobile-toggle{display:block}
.fp-sidebar{position:fixed;top:0;right:-100%;width:85%;max-width:380px;height:100vh;background:#f8fafc;z-index:200;transition:right 0.3s;padding:1rem;overflow-y:auto}
.fp-sidebar.open{right:0}
.fp-sidebar-backdrop{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:150}
.fp-sidebar.open + .fp-sidebar-backdrop{display:block}
}
.fp-tooltip{position:absolute;background:#1e293b;color:white;padding:0.5rem 0.75rem;border-radius:0.375rem;font-size:0.75rem;white-space:nowrap;z-index:30;pointer-events:none;transform:translate(-50%,-100%);margin-top:-0.5rem;opacity:0}
.fp-pin:hover .fp-tooltip{opacity:1}
.fp-detail-panel{background:#f0fdf4;border-radius:0.75rem;padding:1rem;margin:0.75rem}
.fp-detail-panel h4{font-size:0.9rem;font-weight:600;color:#065f46;margin:0 0 0.75rem 0;display:flex;align-items:center;gap:0.5rem}
.fp-detail-content{background:white;padding:1rem;border-radius:0.5rem}
.fp-detail-row{display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid #e2e8f0}
.fp-detail-row:last-child{border-bottom:none}
.fp-detail-label{font-size:0.75rem;color:#64748b;font-weight:600}
.fp-detail-value{font-size:0.85rem;color:#1e293b}
.fp-detail-photos{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;margin-top:0.75rem}
.fp-detail-photo{aspect-ratio:1;border-radius:0.375rem;overflow:hidden}
.fp-detail-photo img{width:100%;height:100%;object-fit:cover;cursor:pointer}
.fp-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s}
.fp-modal-overlay.active{opacity:1;visibility:visible}
.fp-modal{background:white;border-radius:1rem;width:90%;max-width:500px;max-height:90vh;overflow:hidden;transform:translateY(20px);transition:transform 0.3s}
.fp-modal-overlay.active .fp-modal{transform:translateY(0)}
.fp-modal-header{padding:1rem 1.5rem;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
.fp-modal-header.green{background:#ecfdf5}
.fp-modal-header.green h3{color:#065f46}
.fp-modal-header.blue{background:#eff6ff}
.fp-modal-header.blue h3{color:#1e40af}
.fp-modal-header h3{font-size:1.1rem;font-weight:600;margin:0}
.fp-modal-close{width:32px;height:32px;border:none;background:#f1f5f9;border-radius:0.375rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fp-modal-body{padding:1.5rem;max-height:60vh;overflow-y:auto}
.fp-modal-footer{padding:1rem 1.5rem;border-top:1px solid #e2e8f0;display:flex;gap:0.75rem;justify-content:flex-end}
.fp-field{margin-bottom:1rem}
.fp-field label{display:block;font-size:0.8rem;font-weight:600;color:#374151;margin-bottom:0.375rem}
.fp-field input,.fp-field textarea,.fp-field select{width:100%;padding:0.625rem 0.75rem;border:1px solid #d1d5db;border-radius:0.5rem;font-size:0.9rem}
.fp-field input:focus,.fp-field textarea:focus,.fp-field select:focus{outline:none;border-color:var(--fp-primary);box-shadow:0 0 0 3px rgba(16,185,129,0.15)}
.fp-info-banner{background:#dbeafe;color:#1e40af;padding:0.75rem 1rem;border-radius:0.5rem;font-size:0.85rem;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem}
.fp-info-banner.green{background:#d1fae5;color:#065f46}
.fp-row{display:flex;gap:1rem}
.fp-row .fp-field{flex:1}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <nav aria-label="breadcrumb" class="mb-2">
    <ol class="breadcrumb small">
      <li class="breadcrumb-item"><a href="{% url 'project_overview' project.id %}" class="text-decoration-none">{{ project.name }}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'floor_plan_list' project.id %}" class="text-decoration-none">Floor Plans</a></li>
      <li class="breadcrumb-item"><a href="{% url 'floor_plan_detail' plan.id %}" class="text-decoration-none">{{ plan.name }}</a></li>
      <li class="breadcrumb-item active">Touch-ups & Tasks</li>
    </ol>
  </nav>

  <div class="fp-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div>
        <h1><i class="bi bi-brush me-2"></i>Touch-ups & Tasks Panel</h1>
        <div class="fp-header-meta">
          <span><i class="bi bi-layers me-1"></i>{{ plan.name }}</span>
          <span><i class="bi bi-brush me-1"></i>{{ touchup_pins|length }} touch-ups</span>
          <span><i class="bi bi-list-task me-1"></i>{{ task_pins|length }} tasks</span>
        </div>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'floor_plan_detail' plan.id %}" class="btn btn-light btn-sm"><i class="bi bi-layers me-1"></i>Info Panel</a>
        <a href="{% url 'floor_plan_edit' plan.id %}" class="btn btn-light btn-sm"><i class="bi bi-pencil me-1"></i>Edit Plan</a>
      </div>
    </div>
  </div>

  <div class="fp-info-banner green">
    <i class="bi bi-info-circle"></i>
    <span>This panel is for <strong>Touch-ups</strong> and <strong>Tasks</strong>. Click on the plan to add work items with automatic task creation.</span>
  </div>

  <div class="fp-container">
    <div class="fp-canvas-card">
      <div class="fp-canvas-toolbar">
        <div class="fp-mode-group">
          <button class="fp-mode-btn active" data-mode="view" title="View Mode"><i class="bi bi-eye"></i> View</button>
          <button class="fp-mode-btn" data-mode="touchup" title="Add Touch-up"><i class="bi bi-brush"></i> Touch-up</button>
          <button class="fp-mode-btn" data-mode="task" title="Add Task"><i class="bi bi-list-task"></i> Task</button>
        </div>
        <div class="fp-zoom-group">
          <button class="fp-zoom-btn" id="zoomOut" title="Zoom Out"><i class="bi bi-dash"></i></button>
          <span class="fp-zoom-level" id="zoomLevel">100%</span>
          <button class="fp-zoom-btn" id="zoomIn" title="Zoom In"><i class="bi bi-plus"></i></button>
          <button class="fp-zoom-btn" id="zoomFit" title="Fit to View"><i class="bi bi-arrows-angle-expand"></i></button>
        </div>
      </div>
      <div class="fp-canvas-wrapper" id="canvasWrapper">
        {% if plan.image %}
        <div class="fp-canvas-content" id="canvasContent">
          <img src="{{ plan.image.url }}" alt="{{ plan.name }}" id="planImage">
          <svg class="fp-paths-svg" id="pathsSvg"></svg>
          <div class="fp-pins-layer" id="pinsLayer"></div>
        </div>
        {% else %}
        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-white p-5">
          <i class="bi bi-image display-1 opacity-50 mb-3"></i>
          <p>No image uploaded</p>
          <a href="{% url 'floor_plan_edit' plan.id %}" class="btn btn-success btn-sm"><i class="bi bi-upload me-1"></i>Upload</a>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="fp-sidebar" id="sidebar">
      <div class="fp-sidebar-card">
        <div class="fp-sidebar-header">
          <h3><i class="bi bi-brush" style="color:#10b981"></i> Work Items</h3>
          <span class="fp-work-badge pending">{{ touchup_pins|length|add:task_pins|length }}</span>
        </div>
        <div class="fp-filter-tabs">
          <button class="fp-filter-tab active" data-filter="all">All</button>
          <button class="fp-filter-tab" data-filter="touchup">Touch-ups</button>
          <button class="fp-filter-tab" data-filter="task">Tasks</button>
          <button class="fp-filter-tab" data-filter="pending">Pending</button>
          <button class="fp-filter-tab" data-filter="complete">Complete</button>
        </div>
        <div class="fp-work-list" id="workList">
          {% for pin in touchup_pins %}
          <div class="fp-work-item touchup" data-id="{{ pin.id }}" data-type="touchup" data-x="{{ pin.x }}" data-y="{{ pin.y }}" data-status="{{ pin.linked_task.status|default:'Pending' }}">
            <div class="fp-work-dot touchup"></div>
            <div class="fp-work-info">
              <div class="fp-work-title">{{ pin.title|default:"Touch-up" }}</div>
              {% if pin.description %}<div class="fp-work-desc">{{ pin.description }}</div>{% endif %}
            </div>
            <span class="fp-work-badge {% if pin.linked_task.status == 'Completed' %}complete{% elif pin.linked_task.status == 'In Progress' %}in-progress{% else %}pending{% endif %}">{{ pin.linked_task.status|default:"Pending" }}</span>
          </div>
          {% endfor %}
          {% for pin in task_pins %}
          <div class="fp-work-item task" data-id="{{ pin.id }}" data-type="task" data-x="{{ pin.x }}" data-y="{{ pin.y }}" data-status="{{ pin.linked_task.status|default:'Pending' }}">
            <div class="fp-work-dot task {% if pin.linked_task.status == 'Completed' %}complete{% endif %}"></div>
            <div class="fp-work-info">
              <div class="fp-work-title">{{ pin.linked_task.title|default:pin.title|default:"Task" }}</div>
              {% if pin.description %}<div class="fp-work-desc">{{ pin.description }}</div>{% endif %}
            </div>
            <span class="fp-work-badge {% if pin.linked_task.status == 'Completed' %}complete{% elif pin.linked_task.status == 'In Progress' %}in-progress{% else %}pending{% endif %}">{{ pin.linked_task.status|default:"Pending" }}</span>
          </div>
          {% endfor %}
          {% if not touchup_pins and not task_pins %}
          <div class="fp-empty">
            <i class="bi bi-brush"></i>
            <p>No touch-ups or tasks with locations yet.</p>
            <button class="fp-btn fp-btn-primary fp-btn-sm" onclick="setMode('touchup')"><i class="bi bi-plus-lg"></i> Add Touch-up</button>
          </div>
          {% endif %}
        </div>
      </div>
      
      <div class="fp-detail-panel" id="detailPanel" style="display:none;">
        <h4><i class="bi bi-info-circle"></i> Selected Item</h4>
        <div class="fp-detail-content" id="detailContent"></div>
      </div>
      
      <div class="fp-sidebar-card">
        <div class="fp-sidebar-header"><h3><i class="bi bi-lightning"></i> Quick Actions</h3></div>
        <div class="p-3 d-grid gap-2">
          <button class="fp-btn fp-btn-primary" onclick="setMode('touchup')"><i class="bi bi-brush"></i> Add Touch-up</button>
          <button class="fp-btn fp-btn-blue" onclick="setMode('task')"><i class="bi bi-list-task"></i> Add Task with Location</button>
          <button class="fp-btn fp-btn-secondary" onclick="openLinkExistingModal()"><i class="bi bi-link-45deg"></i> Link Existing Task</button>
          <a href="{% url 'floor_plan_detail' plan.id %}" class="fp-btn fp-btn-secondary"><i class="bi bi-arrow-left"></i> Back to Info Panel</a>
        </div>
      </div>
    </div>
    <div class="fp-sidebar-backdrop" id="sidebarBackdrop"></div>
  </div>
</div>

<button class="fp-mobile-toggle fp-btn fp-btn-primary" id="mobileToggle"><i class="bi bi-list"></i> Work</button>

<!-- Touch-up Modal (creates pin + task automatically) -->
<div class="fp-modal-overlay" id="touchupModal">
  <div class="fp-modal">
    <div class="fp-modal-header green">
      <h3><i class="bi bi-brush me-2"></i>Add Touch-up</h3>
      <button class="fp-modal-close" onclick="closeModal('touchupModal')"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="fp-modal-body">
      <div class="fp-info-banner green" style="margin-bottom:1rem">
        <i class="bi bi-magic"></i>
        <span>A task will be automatically created and linked to this touch-up.</span>
      </div>
      <form id="touchupForm">
        <input type="hidden" id="touchupX" name="x">
        <input type="hidden" id="touchupY" name="y">
        <div class="fp-field">
          <label for="touchupTitle">Title <span class="text-danger">*</span></label>
          <input type="text" id="touchupTitle" name="title" placeholder="What needs to be touched up?" required>
        </div>
        <div class="fp-field">
          <label for="touchupDescription">Description</label>
          <textarea id="touchupDescription" name="description" rows="3" placeholder="Detailed description of the work needed..."></textarea>
        </div>
        <div class="fp-row">
          <div class="fp-field">
            <label for="touchupPriority">Priority</label>
            <select id="touchupPriority" name="priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
          {% if request.user.is_staff %}
          <div class="fp-field">
            <label for="touchupAssigned">Assign To</label>
            <select id="touchupAssigned" name="assigned_to">
              <option value="">-- Unassigned --</option>
              {% for emp in employees %}
              <option value="{{ emp.id }}">{{ emp.user.get_full_name|default:emp.user.username }}</option>
              {% endfor %}
            </select>
          </div>
          {% endif %}
        </div>
      </form>
    </div>
    <div class="fp-modal-footer">
      <button class="fp-btn fp-btn-secondary" onclick="closeModal('touchupModal')">Cancel</button>
      <button class="fp-btn fp-btn-primary" onclick="saveTouchup()"><i class="bi bi-check-lg"></i> Create Touch-up</button>
    </div>
  </div>
</div>

<!-- Task Modal (creates task + pin with location) -->
<div class="fp-modal-overlay" id="taskModal">
  <div class="fp-modal">
    <div class="fp-modal-header blue">
      <h3><i class="bi bi-list-task me-2"></i>Add Task with Location</h3>
      <button class="fp-modal-close" onclick="closeModal('taskModal')"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="fp-modal-body">
      <div class="fp-info-banner" style="margin-bottom:1rem">
        <i class="bi bi-geo-alt"></i>
        <span>This task will be linked to the selected location on the floor plan.</span>
      </div>
      <form id="taskForm">
        <input type="hidden" id="taskX" name="x">
        <input type="hidden" id="taskY" name="y">
        <div class="fp-field">
          <label for="taskTitle">Title <span class="text-danger">*</span></label>
          <input type="text" id="taskTitle" name="title" placeholder="Task title" required>
        </div>
        <div class="fp-field">
          <label for="taskDescription">Description</label>
          <textarea id="taskDescription" name="description" rows="3" placeholder="Detailed task description..."></textarea>
        </div>
        <div class="fp-row">
          <div class="fp-field">
            <label for="taskPriority">Priority</label>
            <select id="taskPriority" name="priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
          <div class="fp-field">
            <label for="taskDueDate">Due Date</label>
            <input type="date" id="taskDueDate" name="due_date">
          </div>
        </div>
        {% if request.user.is_staff %}
        <div class="fp-field">
          <label for="taskAssigned">Assign To</label>
          <select id="taskAssigned" name="assigned_to">
            <option value="">-- Unassigned --</option>
            {% for emp in employees %}
            <option value="{{ emp.id }}">{{ emp.user.get_full_name|default:emp.user.username }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
      </form>
    </div>
    <div class="fp-modal-footer">
      <button class="fp-btn fp-btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
      <button class="fp-btn fp-btn-blue" onclick="saveTask()"><i class="bi bi-check-lg"></i> Create Task</button>
    </div>
  </div>
</div>

<!-- Link Existing Task Modal -->
<div class="fp-modal-overlay" id="linkExistingModal">
  <div class="fp-modal">
    <div class="fp-modal-header blue">
      <h3><i class="bi bi-link-45deg me-2"></i>Link Existing Task</h3>
      <button class="fp-modal-close" onclick="closeModal('linkExistingModal')"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="fp-modal-body">
      <p class="text-muted mb-3">Select an existing task to link to a location on this plan.</p>
      <div class="fp-field">
        <label for="existingTaskSelect">Select Task</label>
        <select id="existingTaskSelect" name="task_id">
          <option value="">-- Select a task --</option>
          {% for task in unlinked_tasks %}
          <option value="{{ task.id }}" data-title="{{ task.title }}" data-desc="{{ task.description|default:'' }}">{{ task.title }} ({{ task.status }})</option>
          {% empty %}
          <option value="" disabled>No unlinked tasks available</option>
          {% endfor %}
        </select>
      </div>
      <div class="fp-info-banner" style="margin-top:1rem">
        <i class="bi bi-hand-index"></i>
        <span>After selecting, click on the plan to set the task's location.</span>
      </div>
    </div>
    <div class="fp-modal-footer">
      <button class="fp-btn fp-btn-secondary" onclick="closeModal('linkExistingModal')">Cancel</button>
      <button class="fp-btn fp-btn-blue" onclick="startLinkingTask()"><i class="bi bi-cursor"></i> Select Location</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const canvasWrapper = document.getElementById('canvasWrapper');
  const canvasContent = document.getElementById('canvasContent');
  const planImage = document.getElementById('planImage');
  const pinsLayer = document.getElementById('pinsLayer');
  const pathsSvg = document.getElementById('pathsSvg');
  const workList = document.getElementById('workList');
  const sidebar = document.getElementById('sidebar');
  const sidebarBackdrop = document.getElementById('sidebarBackdrop');
  const mobileToggle = document.getElementById('mobileToggle');
  const detailPanel = document.getElementById('detailPanel');
  const detailContent = document.getElementById('detailContent');
  
  let currentMode = 'view';
  let scale = 1;
  let isPanning = false;
  let panStart = {x:0,y:0};
  let scrollStart = {x:0,y:0};
  let selectedItemId = null;
  let linkingTaskId = null;
  let linkingTaskTitle = '';
  
  // Work data from server
  const workData = [
    {% for pin in touchup_pins %}
    {
      id: {{ pin.id }},
      x: {{ pin.x }},
      y: {{ pin.y }},
      type: 'touchup',
      title: '{{ pin.title|escapejs|default:"Touch-up" }}',
      description: '{{ pin.description|escapejs|default:"" }}',
      color: '{{ pin.pin_color|default:"#10b981" }}',
      createdBy: '{{ pin.created_by.username|default:"Unknown" }}',
      createdAt: '{{ pin.created_at|date:"M d, Y" }}',
      taskId: {% if pin.linked_task %}{{ pin.linked_task.id }}{% else %}null{% endif %},
      taskStatus: '{{ pin.linked_task.status|default:"Pending" }}',
      taskPriority: '{{ pin.linked_task.priority|default:"medium" }}',
      attachments: [{% for att in pin.attachments.all %}{ id: {{ att.id }}, url: '{{ att.image.url }}' }{% if not forloop.last %},{% endif %}{% endfor %}]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
    {% if touchup_pins and task_pins %},{% endif %}
    {% for pin in task_pins %}
    {
      id: {{ pin.id }},
      x: {{ pin.x }},
      y: {{ pin.y }},
      type: 'task',
      title: '{{ pin.linked_task.title|escapejs|default:pin.title|default:"Task" }}',
      description: '{{ pin.description|escapejs|default:"" }}',
      color: '#3b82f6',
      createdBy: '{{ pin.created_by.username|default:"Unknown" }}',
      createdAt: '{{ pin.created_at|date:"M d, Y" }}',
      taskId: {% if pin.linked_task %}{{ pin.linked_task.id }}{% else %}null{% endif %},
      taskStatus: '{{ pin.linked_task.status|default:"Pending" }}',
      taskPriority: '{{ pin.linked_task.priority|default:"medium" }}',
      attachments: [{% for att in pin.attachments.all %}{ id: {{ att.id }}, url: '{{ att.image.url }}' }{% if not forloop.last %},{% endif %}{% endfor %}]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  
  const csrfToken = '{{ csrf_token }}';
  const apiPins = '/api/v1/plan-pins/';
  const apiTasks = '/api/v1/tasks/';
  const planId = {{ plan.id }};
  const projectId = {{ project.id }};
  
  function init() {
    if (planImage) { 
      if (planImage.complete) renderAllPins(); 
      else planImage.addEventListener('load', renderAllPins); 
    }
    setupEvents();
  }
  
  function setupEvents() {
    document.querySelectorAll('.fp-mode-btn').forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode)));
    document.getElementById('zoomIn').addEventListener('click', () => zoom(0.25));
    document.getElementById('zoomOut').addEventListener('click', () => zoom(-0.25));
    document.getElementById('zoomFit').addEventListener('click', zoomFit);
    
    if (canvasWrapper) {
      canvasWrapper.addEventListener('wheel', handleWheel, {passive:false});
      canvasWrapper.addEventListener('mousedown', handleMouseDown);
      canvasWrapper.addEventListener('mousemove', handleMouseMove);
      canvasWrapper.addEventListener('mouseup', handleMouseUp);
      canvasWrapper.addEventListener('mouseleave', handleMouseUp);
      canvasWrapper.addEventListener('click', handleCanvasClick);
    }
    
    document.querySelectorAll('.fp-filter-tab').forEach(tab => tab.addEventListener('click', () => filterItems(tab.dataset.filter)));
    
    if (workList) {
      workList.addEventListener('click', e => { 
        const item = e.target.closest('.fp-work-item'); 
        if (item) { 
          const itemId = parseInt(item.dataset.id);
          selectItem(itemId); 
          panToPin(parseFloat(item.dataset.x), parseFloat(item.dataset.y));
          showDetail(itemId);
        } 
      });
    }
    
    if (mobileToggle) mobileToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
    if (sidebarBackdrop) sidebarBackdrop.addEventListener('click', () => sidebar.classList.remove('open'));
  }
  
  window.setMode = function(mode) { 
    currentMode = mode; 
    document.querySelectorAll('.fp-mode-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode)); 
    if (canvasWrapper) {
      canvasWrapper.classList.toggle('crosshair', mode === 'touchup' || mode === 'task' || mode === 'linking');
    }
    if (mode === 'touchup' || mode === 'task') {
      linkingTaskId = null;
    }
  };
  
  function zoom(d) { scale = Math.max(0.25, Math.min(4, scale + d)); updateScale(); }
  function zoomFit() { scale = 1; updateScale(); if (canvasWrapper) { canvasWrapper.scrollLeft = 0; canvasWrapper.scrollTop = 0; } }
  function updateScale() { if(canvasContent) canvasContent.style.transform = 'scale('+scale+')'; document.getElementById('zoomLevel').textContent = Math.round(scale*100)+'%'; }
  function handleWheel(e) { if(e.ctrlKey||e.metaKey) { e.preventDefault(); zoom(e.deltaY>0?-0.1:0.1); } }
  function handleMouseDown(e) { if(currentMode==='view'&&e.button===0) { isPanning=true; panStart={x:e.clientX,y:e.clientY}; scrollStart={x:canvasWrapper.scrollLeft,y:canvasWrapper.scrollTop}; canvasWrapper.classList.add('grabbing'); } }
  function handleMouseMove(e) { if(isPanning) { canvasWrapper.scrollLeft = scrollStart.x - (e.clientX-panStart.x); canvasWrapper.scrollTop = scrollStart.y - (e.clientY-panStart.y); } }
  function handleMouseUp() { isPanning = false; if (canvasWrapper) canvasWrapper.classList.remove('grabbing'); }
  
  function handleCanvasClick(e) { 
    if (isPanning || !planImage) return; 
    const rect = planImage.getBoundingClientRect(); 
    const x = (e.clientX - rect.left) / rect.width; 
    const y = (e.clientY - rect.top) / rect.height; 
    if (x < 0 || x > 1 || y < 0 || y > 1) return; 
    
    if (currentMode === 'touchup') {
      openTouchupModal(x, y);
    } else if (currentMode === 'task') {
      openTaskModal(x, y);
    } else if (currentMode === 'linking' && linkingTaskId) {
      linkTaskToLocation(linkingTaskId, x, y);
    }
  }
  
  function renderAllPins() { 
    if (!pinsLayer || !planImage) return; 
    pinsLayer.innerHTML = ''; 
    if (pathsSvg) pathsSvg.innerHTML = ''; 
    workData.forEach(renderPin); 
  }
  
  function renderPin(item) { 
    const el = document.createElement('div'); 
    el.className = 'fp-pin'; 
    el.dataset.id = item.id; 
    el.style.left = (item.x*100)+'%'; 
    el.style.top = (item.y*100)+'%'; 
    
    const markerClass = item.type === 'touchup' ? 'touchup' : (item.taskStatus === 'Completed' ? 'task-complete' : 'task');
    const icon = item.type === 'touchup' ? 'bi-brush-fill' : 'bi-geo-alt-fill';
    
    el.innerHTML = '<div class="fp-pin-marker '+markerClass+'"><i class="bi '+icon+'"></i></div><div class="fp-tooltip">'+item.title+'</div>'; 
    el.addEventListener('click', e => { 
      e.stopPropagation(); 
      selectItem(item.id);
      showDetail(item.id);
    }); 
    pinsLayer.appendChild(el); 
  }
  
  function selectItem(id) { 
    selectedItemId = id; 
    document.querySelectorAll('.fp-pin').forEach(el => el.classList.toggle('selected', parseInt(el.dataset.id)===id)); 
    document.querySelectorAll('.fp-work-item').forEach(el => el.classList.toggle('selected', parseInt(el.dataset.id)===id)); 
  }
  
  function panToPin(x, y) { 
    if (!canvasWrapper || !planImage) return; 
    const wr = canvasWrapper.getBoundingClientRect(); 
    canvasWrapper.scrollTo({ 
      left: (x*planImage.naturalWidth*scale) - (wr.width/2), 
      top: (y*planImage.naturalHeight*scale) - (wr.height/2), 
      behavior: 'smooth' 
    }); 
  }
  
  function filterItems(type) { 
    document.querySelectorAll('.fp-filter-tab').forEach(t => t.classList.toggle('active', t.dataset.filter === type)); 
    document.querySelectorAll('.fp-work-item').forEach(i => {
      const itemType = i.dataset.type;
      const itemStatus = i.dataset.status;
      let show = false;
      if (type === 'all') show = true;
      else if (type === 'touchup') show = itemType === 'touchup';
      else if (type === 'task') show = itemType === 'task';
      else if (type === 'pending') show = itemStatus === 'Pending';
      else if (type === 'complete') show = itemStatus === 'Completed';
      i.style.display = show ? 'flex' : 'none';
    });
  }
  
  function showDetail(itemId) {
    const item = workData.find(w => w.id === itemId);
    if (!item) {
      detailPanel.style.display = 'none';
      return;
    }
    
    let html = '<div class="fp-detail-row"><span class="fp-detail-label">Type</span><span class="fp-detail-value">'+(item.type === 'touchup' ? 'Touch-up' : 'Task')+'</span></div>';
    html += '<div class="fp-detail-row"><span class="fp-detail-label">Status</span><span class="fp-detail-value">'+item.taskStatus+'</span></div>';
    html += '<div class="fp-detail-row"><span class="fp-detail-label">Priority</span><span class="fp-detail-value" style="text-transform:capitalize">'+item.taskPriority+'</span></div>';
    html += '<div class="fp-detail-row"><span class="fp-detail-label">Created By</span><span class="fp-detail-value">'+item.createdBy+'</span></div>';
    html += '<div class="fp-detail-row"><span class="fp-detail-label">Date</span><span class="fp-detail-value">'+item.createdAt+'</span></div>';
    
    if (item.description) {
      html += '<div class="fp-detail-row" style="flex-direction:column;align-items:flex-start"><span class="fp-detail-label">Description</span><span class="fp-detail-value" style="margin-top:0.25rem">'+item.description+'</span></div>';
    }
    
    if (item.attachments && item.attachments.length > 0) {
      html += '<div style="margin-top:0.75rem"><span class="fp-detail-label">Photos ('+item.attachments.length+')</span><div class="fp-detail-photos">';
      item.attachments.forEach(a => {
        html += '<div class="fp-detail-photo"><img src="'+a.url+'" onclick="window.open(\''+a.url+'\',\'_blank\')"></div>';
      });
      html += '</div></div>';
    }
    
    if (item.taskId) {
      html += '<div style="margin-top:0.75rem"><a href="/tasks/'+item.taskId+'/" class="fp-btn fp-btn-sm fp-btn-secondary" style="width:100%;justify-content:center"><i class="bi bi-box-arrow-up-right"></i> View Full Task</a></div>';
    }
    
    detailContent.innerHTML = html;
    detailPanel.style.display = 'block';
  }
  
  // Modal functions
  window.closeModal = function(modalId) {
    document.getElementById(modalId).classList.remove('active');
  };
  
  function openTouchupModal(x, y) {
    document.getElementById('touchupX').value = x;
    document.getElementById('touchupY').value = y;
    document.getElementById('touchupTitle').value = '';
    document.getElementById('touchupDescription').value = '';
    document.getElementById('touchupPriority').value = 'medium';
    const assignedEl = document.getElementById('touchupAssigned');
    if (assignedEl) assignedEl.value = '';
    document.getElementById('touchupModal').classList.add('active');
  }
  
  function openTaskModal(x, y) {
    document.getElementById('taskX').value = x;
    document.getElementById('taskY').value = y;
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDescription').value = '';
    document.getElementById('taskPriority').value = 'medium';
    document.getElementById('taskDueDate').value = '';
    const assignedEl = document.getElementById('taskAssigned');
    if (assignedEl) assignedEl.value = '';
    document.getElementById('taskModal').classList.add('active');
  }
  
  window.openLinkExistingModal = function() {
    document.getElementById('existingTaskSelect').value = '';
    document.getElementById('linkExistingModal').classList.add('active');
  };
  
  // Save Touch-up (creates pin which auto-creates task via model)
  window.saveTouchup = function() {
    const x = parseFloat(document.getElementById('touchupX').value);
    const y = parseFloat(document.getElementById('touchupY').value);
    const title = document.getElementById('touchupTitle').value.trim();
    const description = document.getElementById('touchupDescription').value.trim();
    const priority = document.getElementById('touchupPriority').value;
    const assignedEl = document.getElementById('touchupAssigned');
    const assignedTo = assignedEl ? assignedEl.value : '';
    
    if (!title) {
      alert('Please enter a title');
      return;
    }
    
    // Create pin (model will auto-create linked task)
    const pinData = {
      plan: planId,
      x: x,
      y: y,
      pin_type: 'touchup',
      title: title,
      description: description,
      pin_color: '#10b981'
    };
    
    fetch(apiPins, {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken':csrfToken},
      body: JSON.stringify(pinData)
    })
    .then(r => { 
      if(!r.ok) throw new Error('Failed to create pin'); 
      return r.json(); 
    })
    .then(pin => {
      // If we have assignment or priority to update, update the linked task
      if (pin.linked_task && (assignedTo || priority !== 'medium')) {
        return fetch(apiTasks + pin.linked_task + '/', {
          method: 'PATCH',
          headers: {'Content-Type':'application/json','X-CSRFToken':csrfToken},
          body: JSON.stringify({
            priority: priority,
            assigned_to: assignedTo || null
          })
        }).then(() => pin);
      }
      return pin;
    })
    .then(() => { 
      closeModal('touchupModal'); 
      location.reload(); 
    })
    .catch(e => { 
      console.error(e); 
      alert('Failed to save touch-up. Please try again.'); 
    });
  };
  
  // Save Task (creates task first, then pin linked to it)
  window.saveTask = function() {
    const x = parseFloat(document.getElementById('taskX').value);
    const y = parseFloat(document.getElementById('taskY').value);
    const title = document.getElementById('taskTitle').value.trim();
    const description = document.getElementById('taskDescription').value.trim();
    const priority = document.getElementById('taskPriority').value;
    const dueDate = document.getElementById('taskDueDate').value;
    const assignedEl = document.getElementById('taskAssigned');
    const assignedTo = assignedEl ? assignedEl.value : '';
    
    if (!title) {
      alert('Please enter a title');
      return;
    }
    
    // First create the task
    const taskData = {
      project: projectId,
      title: title,
      description: description,
      priority: priority,
      status: 'Pending'
    };
    if (dueDate) taskData.due_date = dueDate;
    if (assignedTo) taskData.assigned_to = parseInt(assignedTo);
    
    fetch(apiTasks, {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken':csrfToken},
      body: JSON.stringify(taskData)
    })
    .then(r => { 
      if(!r.ok) throw new Error('Failed to create task'); 
      return r.json(); 
    })
    .then(task => {
      // Now create pin linked to the task
      const pinData = {
        plan: planId,
        x: x,
        y: y,
        pin_type: 'task',  // Use 'task' type for task locations
        title: task.title,
        description: description || 'Task location',
        linked_task: task.id,
        pin_color: '#3b82f6'
      };
      
      return fetch(apiPins, {
        method: 'POST',
        headers: {'Content-Type':'application/json','X-CSRFToken':csrfToken},
        body: JSON.stringify(pinData)
      });
    })
    .then(r => { 
      if(!r.ok) throw new Error('Failed to create pin'); 
      return r.json(); 
    })
    .then(() => { 
      closeModal('taskModal'); 
      location.reload(); 
    })
    .catch(e => { 
      console.error(e); 
      alert('Failed to save task. Please try again.'); 
    });
  };
  
  // Link existing task to location
  window.startLinkingTask = function() {
    const select = document.getElementById('existingTaskSelect');
    const taskId = select.value;
    if (!taskId) {
      alert('Please select a task');
      return;
    }
    const option = select.options[select.selectedIndex];
    linkingTaskId = taskId;
    linkingTaskTitle = option.dataset.title || 'Task';
    closeModal('linkExistingModal');
    setMode('linking');
    alert('Click on the floor plan to set the location for: ' + linkingTaskTitle);
  };
  
  function linkTaskToLocation(taskId, x, y) {
    const pinData = {
      plan: planId,
      x: x,
      y: y,
      pin_type: 'task',  // Use 'task' type for task locations
      title: linkingTaskTitle,
      description: 'Task location',
      linked_task: parseInt(taskId),
      pin_color: '#3b82f6'
    };
    
    fetch(apiPins, {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken':csrfToken},
      body: JSON.stringify(pinData)
    })
    .then(r => { 
      if(!r.ok) throw new Error('Failed to link task'); 
      return r.json(); 
    })
    .then(() => { 
      linkingTaskId = null;
      linkingTaskTitle = '';
      setMode('view');
      location.reload(); 
    })
    .catch(e => { 
      console.error(e); 
      alert('Failed to link task to location. Please try again.'); 
    });
  }
  
  init();
});
</script>
{% endblock %}
