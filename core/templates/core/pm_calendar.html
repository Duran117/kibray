{% extends "core/base_modern.html" %}
{% load static %}
{% load i18n %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<style>
    body.pm-calendar-page { background: #f5f7fb; }

    .pm-card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 18px;
        box-shadow: 0 18px 32px rgba(15, 23, 42, 0.07);
    }

    .pm-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.45rem 0.8rem;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .pm-progress-bar {
        position: relative;
        height: 16px;
        background: #eef2ff;
        border-radius: 999px;
        overflow: hidden;
    }

    .pm-progress-fill {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, #22c55e, #f59e0b, #ef4444);
        transition: width 250ms ease;
    }

    /* FullCalendar modern look */
    .fc { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    .fc-toolbar.fc-header-toolbar { margin-bottom: 1rem; }
    .fc .fc-toolbar-title { font-size: 1.4rem; font-weight: 800; color: #0f172a; }
    .fc .fc-button-primary {
        background: #4f46e5;
        border-color: #4f46e5;
        border-radius: 10px;
        box-shadow: 0 10px 20px rgba(79,70,229,0.22);
        text-transform: none;
        padding: 0.45rem 0.9rem;
    }
    .fc .fc-button-primary:hover { background: #4338ca; border-color: #4338ca; }
    .fc .fc-daygrid-day-number { color: #0f172a; font-weight: 600; }
    .fc .fc-daygrid-day {
        transition: background 120ms ease, transform 120ms ease;
    }
    .fc .fc-daygrid-day:hover { background: #f8fafc; }
    .fc .fc-day-today { background: #eef2ff !important; }
    .fc .fc-event {
        border: none;
        border-radius: 10px;
        padding: 4px 8px;
        box-shadow: 0 10px 18px rgba(99,102,241,0.16);
        font-weight: 600;
    }
    .fc-theme-standard td, .fc-theme-standard th { border-color: #e5e7eb; }

    .list-card-item {
        display: flex;
        gap: 12px;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid #f1f5f9;
        background: #f8fafc;
        transition: transform 140ms ease, box-shadow 140ms ease, border-color 140ms ease;
        cursor: pointer;
    }
    .list-card-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 20px rgba(15, 23, 42, 0.08);
        border-color: #cbd5e1;
    }
    .list-empty {
        text-align: center;
        padding: 1.5rem 1rem;
        color: #94a3b8;
        font-weight: 600;
    }

    .stat-pill {
        border-radius: 16px;
        padding: 12px;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .stat-pill strong { font-size: 1.2rem; }

    @media (max-width: 1024px) {
        .fc .fc-toolbar { flex-wrap: wrap; gap: 0.5rem; }
    }
</style>
{% endblock %}

{% block page_header %}
<div class="pm-card p-6 bg-white/90 backdrop-blur" aria-label="Encabezado calendario PM">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-slate-900">üìÖ {{ title }}</h1>
            <p class="text-slate-500">{% trans "Bienvenido" %}, {{ user.get_full_name|default:user.username }}</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <span class="pm-badge bg-indigo-50 text-indigo-700">
                <i class="bi bi-speedometer2 text-indigo-600"></i>
                {% trans "Carga" %}: {{ workload_score }}% ({{ workload_level }})
            </span>
            <a href="{% url 'calendar_wizard_new' %}" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-500 focus:ring-2 focus:ring-indigo-400 flex items-center gap-2">
                <i class="bi bi-plus-lg"></i>
                {% trans "New Event" %}
            </a>
            <button type="button" data-bs-toggle="modal" data-bs-target="#blockDayModal" class="px-4 py-2 rounded-lg border border-indigo-200 text-indigo-700 font-semibold hover:bg-indigo-50 focus:ring-2 focus:ring-indigo-200 flex items-center gap-2">
                <i class="bi bi-slash-circle"></i>
                {% trans "Block Day" %}
            </button>
        </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
        <div class="stat-pill">
            <span class="text-slate-500 text-sm">{% trans "Activos" %}</span>
            <strong class="text-indigo-700">{{ active_count }}</strong>
        </div>
        <div class="stat-pill">
            <span class="text-slate-500 text-sm">{% trans "Urgentes" %}</span>
            <strong class="text-rose-600">{{ urgent_task_count }}</strong>
        </div>
        <div class="stat-pill">
            <span class="text-slate-500 text-sm">{% trans "Hitos pr√≥ximos" %}</span>
            <strong class="text-amber-600">{{ upcoming_milestone_count }}</strong>
        </div>
        <div class="stat-pill">
            <span class="text-slate-500 text-sm">{% trans "D√≠as bloqueados" %}</span>
            <strong class="text-slate-700">{{ blocked_days.count }}</strong>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="grid gap-6 xl:grid-cols-3">
    <div class="xl:col-span-2 space-y-6">
        <div class="pm-card p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                <div class="flex items-center gap-2">
                    <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl">üìÜ</div>
                    <div>
                        <h2 class="text-xl font-semibold text-slate-900">{% trans "Mi Calendario" %}</h2>
                        <p class="text-sm text-slate-500">{% trans "Vista mensual y semanal" %}</p>
                    </div>
                </div>
                <div class="flex gap-3 text-sm">
                    <span class="px-3 py-1 rounded-full bg-indigo-50 text-indigo-700 font-semibold">{% trans "Eventos" %}</span>
                    <span class="px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 font-semibold">{% trans "D√≠as Bloqueados" %}</span>
                </div>
            </div>
            <div id="pmCalendar"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="pm-card p-4 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white">
                <p class="text-sm opacity-80">{% trans "Proyectos Activos" %}</p>
                <p class="text-3xl font-bold">{{ active_count }}</p>
            </div>
            <div class="pm-card p-4 bg-gradient-to-r from-rose-500 to-rose-600 text-white">
                <p class="text-sm opacity-80">{% trans "Tareas Urgentes" %}</p>
                <p class="text-3xl font-bold">{{ urgent_task_count }}</p>
            </div>
            <div class="pm-card p-4 bg-gradient-to-r from-amber-400 to-orange-500 text-slate-900">
                <p class="text-sm opacity-80">{% trans "Milestones Pr√≥ximos" %}</p>
                <p class="text-3xl font-bold">{{ upcoming_milestone_count }}</p>
            </div>
            <div class="pm-card p-4 bg-gradient-to-r from-slate-500 to-slate-700 text-white">
                <p class="text-sm opacity-80">{% trans "D√≠as Bloqueados" %}</p>
                <p class="text-3xl font-bold">{{ blocked_days.count }}</p>
            </div>
        </div>
    </div>

    <div class="space-y-6">
        <div class="pm-card p-5">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <p class="text-sm text-slate-500">{% trans "Carga de Trabajo" %}</p>
                    <p class="text-lg font-semibold text-slate-900">{{ workload_level }}</p>
                </div>
                <span class="px-3 py-1 rounded-full bg-indigo-50 text-indigo-700 font-semibold">{{ workload_score }}%</span>
            </div>
            <div class="pm-progress-bar mb-2">
                <div class="pm-progress-fill" style="width: {{ workload_score }}%;"></div>
            </div>
            <p class="text-sm text-slate-500">{% trans "Balancea tu agenda antes de asignar m√°s tareas." %}</p>
        </div>

        <div class="pm-card p-5 space-y-4">
            <div class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center">üìÅ</div>
                <div>
                    <p class="text-xs uppercase tracking-wide text-slate-500">{% trans "Proyectos Activos" %}</p>
                    <p class="text-lg font-semibold text-slate-900">{{ assigned_projects|length }}</p>
                </div>
            </div>

            {% if assigned_projects %}
                <div class="space-y-2">
                    {% for project in assigned_projects %}
                        <div class="list-card-item" onclick="window.location.href='{% url 'project_overview' project.id %}'">
                            <div class="w-10 h-10 rounded-lg bg-indigo-100 text-indigo-700 flex items-center justify-center font-semibold">{{ project.progress_pct }}%</div>
                            <div class="min-w-0">
                                <p class="font-semibold text-slate-900 truncate">{{ project.name }}</p>
                                <p class="text-sm text-slate-500 truncate">{{ project.client|default:"Sin cliente" }}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="list-empty">{% trans "No hay proyectos activos asignados" %}</div>
            {% endif %}

            <div class="pt-2 border-t border-slate-100"></div>

            <div class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center">üöÄ</div>
                <div>
                    <p class="text-xs uppercase tracking-wide text-slate-500">Pipeline</p>
                    <p class="text-lg font-semibold text-slate-900">{{ pipeline_projects|length }}</p>
                </div>
            </div>

            {% if pipeline_projects %}
                <div class="space-y-2">
                    {% for project in pipeline_projects %}
                        <div class="list-card-item" onclick="window.location.href='{% url 'project_overview' project.id %}'">
                            <div class="w-10 h-10 rounded-lg bg-emerald-100 text-emerald-700 flex items-center justify-center font-semibold">‚ñ∂</div>
                            <div class="min-w-0">
                                <p class="font-semibold text-slate-900 truncate">{{ project.name }}</p>
                                <p class="text-sm text-slate-500 truncate">{% trans "Inicia" %}: {{ project.start_date|date:"M d, Y" }}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="list-empty">{% trans "No hay proyectos en pipeline" %}</div>
            {% endif %}

            <div class="flex justify-center pt-2">
                <button class="px-4 py-2 rounded-lg bg-rose-50 text-rose-700 font-semibold border border-rose-100 hover:bg-rose-100" data-bs-toggle="modal" data-bs-target="#blockDayModal">
                    ‚õî {% trans "Bloquear D√≠a" %}
                </button>
            </div>
        </div>

        <div class="pm-card p-5">
            <div class="flex items-center gap-2 mb-3">
                <div class="w-9 h-9 rounded-xl bg-amber-50 text-amber-600 flex items-center justify-center">üìå</div>
                <div>
                    <p class="text-xs uppercase tracking-wide text-slate-500">{% trans "Pr√≥ximas Deadlines" %}</p>
                    <p class="text-lg font-semibold text-slate-900">{{ upcoming_deadlines|length }}</p>
                </div>
            </div>

                            {% if upcoming_deadlines %}
                                <div class="space-y-2">
                                    {% for deadline in upcoming_deadlines %}
                                        <div class="list-card-item" onclick="window.location.href='{% url 'project_overview' deadline.project_id %}'">
                                            <div class="w-10 h-10 rounded-lg bg-amber-100 text-amber-700 flex items-center justify-center font-semibold">{{ deadline.icon }}</div>
                                            <div class="min-w-0 flex-1">
                                                <p class="font-semibold text-slate-900 truncate">{{ deadline.title }}</p>
                                                <p class="text-sm text-slate-500 truncate">{{ deadline.project }}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-sm text-slate-500">{{ deadline.date|date:"M d" }}</p>
                                                <span class="px-2 py-1 rounded-full text-xs font-semibold {{ deadline.badge_class }}">
                                                    {% if deadline.days_until == 0 %}
                                                        Hoy
                                                    {% elif deadline.days_until == 1 %}
                                                        Ma√±ana
                                                    {% else %}
                                                        {{ deadline.days_until }}d
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="list-empty">{% trans "No hay deadlines pr√≥ximos" %}</div>
                            {% endif %}
        </div>
    </div>
</div>

<!-- Block Day Modal -->
<div class="modal fade" id="blockDayModal" tabindex="-1" aria-labelledby="blockDayModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="blockDayModalLabel">‚õî {% trans "Bloquear D√≠a" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="blockDayForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="blockDate" class="form-label">{% trans "Fecha" %}</label>
                        <input type="date" class="form-control" id="blockDate" name="date" required>
                    </div>
                    <div class="mb-3">
                        <label for="blockReason" class="form-label">{% trans "Raz√≥n" %}</label>
                        <select class="form-select" id="blockReason" name="reason" required>
                            <option value="vacation">{% trans "Vacaciones" %}</option>
                            <option value="personal">{% trans "Personal" %}</option>
                            <option value="sick">{% trans "Enfermedad" %}</option>
                            <option value="training">{% trans "Capacitaci√≥n" %}</option>
                            <option value="other">{% trans "Otro" %}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="blockNotes" class="form-label">{% trans "Notas (opcional)" %}</label>
                        <textarea class="form-control" id="blockNotes" name="notes" rows="2"></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="isFullDay" name="is_full_day" checked>
                        <label class="form-check-label" for="isFullDay">{% trans "D√≠a completo" %}</label>
                    </div>
                    <div id="partialTimeFields" style="display: none;">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="startTime" class="form-label">{% trans "Hora inicio" %}</label>
                                <input type="time" class="form-control" id="startTime" name="start_time">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="endTime" class="form-label">{% trans "Hora fin" %}</label>
                                <input type="time" class="form-control" id="endTime" name="end_time">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancelar" %}</button>
                <button type="button" class="btn btn-primary" id="saveBlockedDay">{% trans "Bloquear" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('pm-calendar-page');

    const calendarEl = document.getElementById('pmCalendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        selectable: true,
        editable: true,
        events: '{% url "pm_calendar_api_data" %}',
        select: function(info) {
            document.getElementById('blockDate').value = info.startStr;
            const modal = new bootstrap.Modal(document.getElementById('blockDayModal'));
            modal.show();
        },
        eventDrop: function(info) {
            if (!confirm('{% trans "Move this event?" %}')) {
                info.revert();
            }
        },
        eventClick: function(info) {
            const props = info.event.extendedProps;
            if (props.type === 'blocked') {
                if (confirm('{% trans "¬øDesbloquear este d√≠a?" %}')) {
                    unblockDay(props.blocked_day_id);
                }
            } else if (props.project_id) {
                window.location.href = `/projects/${props.project_id}/overview/`;
            }
        },
        eventDidMount: function(info) {
            info.el.title = info.event.title;
        },
        height: 'auto',
        locale: 'es'
    });

    calendar.render();

    // Toggle partial time fields
    document.getElementById('isFullDay').addEventListener('change', function() {
        document.getElementById('partialTimeFields').style.display = this.checked ? 'none' : 'block';
    });

    // Block day submission
    document.getElementById('saveBlockedDay').addEventListener('click', function() {
        const form = document.getElementById('blockDayForm');
        const formData = new FormData(form);

        fetch('{% url "pm_block_day" %}', {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('blockDayModal')).hide();
                calendar.refetchEvents();
                alert(data.message);
                setTimeout(() => window.location.reload(), 400);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "Error al bloquear el d√≠a" %}');
        });
    });

    // Unblock day function
    window.unblockDay = function(blockedDayId) {
        fetch(`/pm-calendar/unblock/${blockedDayId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                calendar.refetchEvents();
                alert(data.message);
                setTimeout(() => window.location.reload(), 400);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "Error al desbloquear el d√≠a" %}');
        });
    };
});
</script>
{% endblock %}
