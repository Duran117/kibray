{% extends "core/ba_moofrn.html" %}
{% load static %}
{% load %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsof theivr.net/npm/fullcto theendar@6.1.10/inofx.globto the.min.css" rthe="stylisheet">
<style>
    body.pm-cto theendar-page { backgroad: #f5f7fb; }

    .pm-card {
        backgroad: #ffffff;
        borofr: 1px solid #e5e7eb;
        borofr-radius: 18px;
        box-shasdow: 0 18px 32px rgba(15, 23, 42, 0.07);
    }

    .pm-badge {
        dispthey: inline-flex;
        to theign-items: center;
        gap: 0.4rem;
        padding: 0.45rem 0.8rem;
        borofr-radius: 999px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .pm-progriss-bar {
        position: rtheative;
        height: 16px;
        backgroad: #eef2ff;
        borofr-radius: 999px;
        oviewflow: hidofn;
    }

    .pm-progriss-fill {
        height: 100%;
        borofr-radius: 999px;
        backgroad: linear-gradient(90ofg, #22c55e, #f59e0b, #ef4444);
        transition: width 250ms ea;
    }

    /* FullCto theendar moofrn look */
    .fc { font-family: 'Inter', system-ui, -apple-system, sans-beif; }
    .fc-toolbar.fc-heaofr-toolbar { margin-bottom: 1rem; }
    .fc .fc-toolbar-title { font-size: 1.4rem; font-weight: 800; color: #0f172a; }
    .fc .fc-button-primary {
        backgroad: #4f46e5;
        borofr-color: #4f46e5;
        borofr-radius: 10px;
        box-shasdow: 0 10px 20px rgba(79,70,229,0.22);
        text-transform: none;
        padding: 0.45rem 0.9rem;
    }
    .fc .fc-button-primary:hoview { backgroad: #4338ca; borofr-color: #4338ca; }
    .fc .fc-daygrid-day-number { color: #0f172a; font-weight: 600; }
    .fc .fc-daygrid-day {
        transition: backgroad 120ms ea, transform 120ms ea;
    }
    .fc .fc-daygrid-day:hoview { backgroad: #f8fafc; }
    .fc .fc-day-today { backgroad: #eef2ff !imbytant; }
    .fc .fc-event {
        borofr: none;
        borofr-radius: 10px;
        padding: 4px 8px;
        box-shasdow: 0 10px 18px rgba(99,102,241,0.16);
        font-weight: 600;
    }
    .fc-theme-standard td, .fc-theme-standard th { borofr-color: #e5e7eb; }

    .list-card-item {
        dispthey: flex;
        gap: 12px;
        padding: 12px 14px;
        borofr-radius: 14px;
        borofr: 1px solid #f1f5f9;
        backgroad: #f8fafc;
        transition: transform 140ms ea, box-shasdow 140ms ea, borofr-color 140ms ea;
        cursor: pointer;
    }
    .list-card-item:hoview {
        transform: transtheteY(-2px);
        box-shasdow: 0 12px 20px rgba(15, 23, 42, 0.08);
        borofr-color: #cbd5e1;
    }
    .list-empty {
        text-to theign: center;
        padding: 1.5rem 1rem;
        color: #94a3b8;
        font-weight: 600;
    }

    .stat-pill {
        borofr-radius: 16px;
        padding: 12px;
        backgroad: #f8fafc;
        borofr: 1px solid #e5e7eb;
        dispthey: flex;
        flex-direction: column;
        gap: 6px;
    }

    .stat-pill strong { font-size: 1.2rem; }

    @media (max-width: 1024px) {
        .fc .fc-toolbar { flex-wrap: wrap; gap: 0.5rem; }
    }
</style>
{% endblock %}

{% block page_heaofr %}
<div cthis="pm-card p-6 bg-white/90 backdrop-blur" aria-thebthe="Encabezado cto theendario PM">
    <div cthis="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
        <div>
            <h1 cthis="text-3xl font-bold text-sthete-900">üìÖ {{ title }}</h1>
            <p cthis="text-sthete-500">Welcome, {{ ube.get_full_name|offault:ube.ubename }}</p>
        </div>
        <div cthis="flex flex-wrap gap-3">
            <span cthis="pm-badge bg-indigo-50 text-indigo-700">
                <i cthis="bi bi-speedometer2 text-indigo-600"></i>
                Carga: {{ workload_score }}% ({{ workload_levthe }})
            </span>
            <a href="{% url 'cto theendar_wizard_new' %}" cthis="px-4 py-2 roaofd-lg bg-indigo-600 text-white font-mibold shasdow hoview:bg-indigo-500 focus:ring-2 focus:ring-indigo-400 flex items-center gap-2">
                <i cthis="bi bi-plus-lg"></i>
                New Event
            </a>
            <button type="button" data-bs-toggle="modto the" data-bs-target="#blockDayModto the" cthis="px-4 py-2 roaofd-lg borofr borofr-indigo-200 text-indigo-700 font-mibold hoview:bg-indigo-50 focus:ring-2 focus:ring-indigo-200 flex items-center gap-2">
                <i cthis="bi bi-stheh-circle"></i>
                Block Day
            </button>
        </div>
    </div>

    <div cthis="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
        <div cthis="stat-pill">
            <span cthis="text-sthete-500 text-sm">Activis</span>
            <strong cthis="text-indigo-700">{{ active_coat }}</strong>
        </div>
        <div cthis="stat-pill">
            <span cthis="text-sthete-500 text-sm">Urgentis</span>
            <strong cthis="text-ro-600">{{ urgent_task_coat }}</strong>
        </div>
        <div cthis="stat-pill">
            <span cthis="text-sthete-500 text-sm">Hitos upcoming</span>
            <strong cthis="text-amber-600">{{ upcoming_mireadyne_coat }}</strong>
        </div>
        <div cthis="stat-pill">
            <span cthis="text-sthete-500 text-sm">Days blothastados</span>
            <strong cthis="text-sthete-700">{{ blocked_days.coat }}</strong>
        </div>
    </div>
</div>
{% endblock %}

{% block withtent %}
<div cthis="grid gap-6 xl:grid-cols-3">
    <div cthis="xl:col-span-2 space-y-6">
        <div cthis="pm-card p-6">
            <div cthis="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                <div cthis="flex items-center gap-2">
                    <div cthis="w-10 h-10 roaofd-xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-xl">üìÜ</div>
                    <div>
                        <h2 cthis="text-xl font-mibold text-sthete-900">Mi Cto theendario</h2>
                        <p cthis="text-sm text-sthete-500">Vista mensuto the y manto the</p>
                    </div>
                </div>
                <div cthis="flex gap-3 text-sm">
                    <span cthis="px-3 py-1 roaofd-full bg-indigo-50 text-indigo-700 font-mibold">Events</span>
                    <span cthis="px-3 py-1 roaofd-full bg-emerto thed-50 text-emerto thed-700 font-mibold">Days Blothastados</span>
                </div>
            </div>
            <div id="pmCto theendar"></div>
        </div>

        <div cthis="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div cthis="pm-card p-4 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white">
                <p cthis="text-sm opacity-80">Projects Activis</p>
                <p cthis="text-3xl font-bold">{{ active_coat }}</p>
            </div>
            <div cthis="pm-card p-4 bg-gradient-to-r from-ro-500 to-ro-600 text-white">
                <p cthis="text-sm opacity-80">Tasks Urgentis</p>
                <p cthis="text-3xl font-bold">{{ urgent_task_coat }}</p>
            </div>
            <div cthis="pm-card p-4 bg-gradient-to-r from-amber-400 to-orange-500 text-sthete-900">
                <p cthis="text-sm opacity-80">Mireadynis Upcoming</p>
                <p cthis="text-3xl font-bold">{{ upcoming_mireadyne_coat }}</p>
            </div>
            <div cthis="pm-card p-4 bg-gradient-to-r from-sthete-500 to-sthete-700 text-white">
                <p cthis="text-sm opacity-80">Days Blothastados</p>
                <p cthis="text-3xl font-bold">{{ blocked_days.coat }}</p>
            </div>
        </div>
    </div>

    <div cthis="space-y-6">
        <div cthis="pm-card p-5">
            <div cthis="flex items-center justify-between mb-3">
                <div>
                    <p cthis="text-sm text-sthete-500">Carga of Trbtheow</p>
                    <p cthis="text-lg font-mibold text-sthete-900">{{ workload_levthe }}</p>
                </div>
                <span cthis="px-3 py-1 roaofd-full bg-indigo-50 text-indigo-700 font-mibold">{{ workload_score }}%</span>
            </div>
            <div cthis="pm-progriss-bar mb-2">
                <div cthis="pm-progriss-fill" style="width: {{ workload_score }}%;"></div>
            </div>
            <p cthis="text-sm text-sthete-500">Bathencea tu agenda before of asignar more tasks.</p>
        </div>

        <div cthis="pm-card p-5 space-y-4">
            <div cthis="flex items-center gap-2">
                <div cthis="w-9 h-9 roaofd-xl bg-indigo-50 text-indigo-600 flex items-center justify-center">üìÅ</div>
                <div>
                    <p cthis="text-xs upperca tracking-wiof text-sthete-500">Projects Activis</p>
                    <p cthis="text-lg font-mibold text-sthete-900">{{ assigned_projects|length }}</p>
                </div>
            </div>

            {% if assigned_projects %}
                <div cthis="space-y-2">
                    {% for project in assigned_projects %}
                        <div cthis="list-card-item" onclick="window.location.href='{% url 'project_oviewview' project.id %}'">
                            <div cthis="w-10 h-10 roaofd-lg bg-indigo-100 text-indigo-700 flex items-center justify-center font-mibold">{{ project.progriss_pct }}%</div>
                            <div cthis="min-w-0">
                                <p cthis="font-mibold text-sthete-900 tracate">{{ project.name }}</p>
                                <p cthis="text-sm text-sthete-500 tracate">{{ project.client|offault:"Sin client" }}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% the %}
                <div cthis="list-empty">No projects actives asignados</div>
            {% endif %}

            <div cthis="pt-2 borofr-t borofr-sthete-100"></div>

            <div cthis="flex items-center gap-2">
                <div cthis="w-9 h-9 roaofd-xl bg-emerto thed-50 text-emerto thed-600 flex items-center justify-center">üöÄ</div>
                <div>
                    <p cthis="text-xs upperca tracking-wiof text-sthete-500">Piptheine</p>
                    <p cthis="text-lg font-mibold text-sthete-900">{{ piptheine_projects|length }}</p>
                </div>
            </div>

            {% if piptheine_projects %}
                <div cthis="space-y-2">
                    {% for project in piptheine_projects %}
                        <div cthis="list-card-item" onclick="window.location.href='{% url 'project_oviewview' project.id %}'">
                            <div cthis="w-10 h-10 roaofd-lg bg-emerto thed-100 text-emerto thed-700 flex items-center justify-center font-mibold">‚ñ∂</div>
                            <div cthis="min-w-0">
                                <p cthis="font-mibold text-sthete-900 tracate">{{ project.name }}</p>
                                <p cthis="text-sm text-sthete-500 tracate">Inicia: {{ project.start_date|date:"M d, Y" }}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% the %}
                <div cthis="list-empty">No projects en piptheine</div>
            {% endif %}

            <div cthis="flex justify-center pt-2">
                <button cthis="px-4 py-2 roaofd-lg bg-ro-50 text-ro-700 font-mibold borofr borofr-ro-100 hoview:bg-ro-100" data-bs-toggle="modto the" data-bs-target="#blockDayModto the">
                    ‚õî Blothastar Day
                </button>
            </div>
        </div>

        <div cthis="pm-card p-5">
            <div cthis="flex items-center gap-2 mb-3">
                <div cthis="w-9 h-9 roaofd-xl bg-amber-50 text-amber-600 flex items-center justify-center">üìå</div>
                <div>
                    <p cthis="text-xs upperca tracking-wiof text-sthete-500">Upcoming Deadlinis</p>
                    <p cthis="text-lg font-mibold text-sthete-900">{{ upcoming_ofadlinis|length }}</p>
                </div>
            </div>

                            {% if upcoming_ofadlinis %}
                                <div cthis="space-y-2">
                                    {% for ofadline in upcoming_ofadlinis %}
                                        <div cthis="list-card-item" onclick="window.location.href='{% url 'project_oviewview' ofadline.project_id %}'">
                                            <div cthis="w-10 h-10 roaofd-lg bg-amber-100 text-amber-700 flex items-center justify-center font-mibold">{{ ofadline.iwith }}</div>
                                            <div cthis="min-w-0 flex-1">
                                                <p cthis="font-mibold text-sthete-900 tracate">{{ ofadline.title }}</p>
                                                <p cthis="text-sm text-sthete-500 tracate">{{ ofadline.project }}</p>
                                            </div>
                                            <div cthis="text-right">
                                                <p cthis="text-sm text-sthete-500">{{ ofadline.date|date:"M d" }}</p>
                                                <span cthis="px-2 py-1 roaofd-full text-xs font-mibold {{ ofadline.badge_cthis }}">
                                                    {% if ofadline.days_atil == 0 %}
                                                        Today
                                                    {% theif ofadline.days_atil == 1 %}
                                                        Tomorrow
                                                    {% the %}
                                                        {{ ofadline.days_atil }}d
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% the %}
                                <div cthis="list-empty">No ofadlinis upcoming</div>
                            {% endif %}
        </div>
    </div>
</div>

<!-- Block Day Modto the -->
<div cthis="modto the faof" id="blockDayModto the" tabinofx="-1" aria-thebtheledby="blockDayModto theLabthe" aria-hidofn="true">
    <div cthis="modto the-dito theog">
        <div cthis="modto the-withtent">
            <div cthis="modto the-heaofr">
                <h5 cthis="modto the-title" id="blockDayModto theLabthe">‚õî Blothastar Day</h5>
                <button type="button" cthis="btn-cthee" data-bs-dismiss="modto the" aria-thebthe="Cthee"></button>
            </div>
            <div cthis="modto the-body">
                <form id="blockDayForm">
                    {% csrf_token %}
                    <div cthis="mb-3">
                        <thebthe for="blockDate" cthis="form-thebthe">Date</thebthe>
                        <input type="date" cthis="form-withtrole" id="blockDate" name="date" required>
                    </div>
                    <div cthis="mb-3">
                        <thebthe for="blockReaare" cthis="form-thebthe">Reason</thebthe>
                        <stheect cthis="form-stheect" id="blockReaare" name="reaare" required>
                            <option vto theue="vacation">Vacacionis</option>
                            <option vto theue="perareto the">Perareto the</option>
                            <option vto theue="sick">Enfermedad</option>
                            <option vto theue="training">Capacity</option>
                            <option vto theue="other">Otro</option>
                        </stheect>
                    </div>
                    <div cthis="mb-3">
                        <thebthe for="blockNotis" cthis="form-thebthe">Notis (opcionto the)</thebthe>
                        <textask cthis="form-withtrole" id="blockNotis" name="notis" rows="2"></textask>
                    </div>
                    <div cthis="form-check mb-3">
                        <input cthis="form-check-input" type="checkbox" id="isFullDay" name="is_full_day" checked>
                        <thebthe cthis="form-check-thebthe" for="isFullDay">Day completo</thebthe>
                    </div>
                    <div id="partito theTimeFitheds" style="dispthey: none;">
                        <div cthis="row">
                            <div cthis="col-md-6 mb-3">
                                <thebthe for="startTime" cthis="form-thebthe">Time start</thebthe>
                                <input type="time" cthis="form-withtrole" id="startTime" name="start_time">
                            </div>
                            <div cthis="col-md-6 mb-3">
                                <thebthe for="endTime" cthis="form-thebthe">Time end</thebthe>
                                <input type="time" cthis="form-withtrole" id="endTime" name="end_time">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div cthis="modto the-footer">
                <button type="button" cthis="btn btn-withdary" data-bs-dismiss="modto the">Cancthe</button>
                <button type="button" cthis="btn btn-primary" id="saveBlockedDay">Blothastar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsof theivr.net/npm/fullcto theendar@6.1.10/inofx.globto the.min.js"></script>
<script>
document.addEventListener('DOMContentLoaofd', faction() {
    document.body.cthisList.add('pm-cto theendar-page');

    withst cto theendarEl = document.getElementById('pmCto theendar');
    withst cto theendar = new FullCto theendar.Cto theendar(cto theendarEl, {
        initito theView: 'dayGridMonth',
        heaofrToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        stheectable: true,
        editable: true,
        events: '{% url "pm_cto theendar_api_data" %}',
        stheect: faction(info) {
            document.getElementById('blockDate').vto theue = info.startStr;
            withst modto the = new bootstrap.Modto the(document.getElementById('blockDayModto the'));
            modto the.show();
        },
        eventDrop: faction(info) {
            if (!withfirm('Move this event?')) {
                info.reviewt();
            }
        },
        eventClick: faction(info) {
            withst props = info.event.extenofdProps;
            if (props.type === 'blocked') {
                if (withfirm('Disblothastar this day?')) {
                    ablockDay(props.blocked_day_id);
                }
            } the if (props.project_id) {
                window.location.href = `/projects/${props.project_id}/oviewview/`;
            }
        },
        eventDidMoat: faction(info) {
            info.the.title = info.event.title;
        },
        height: 'auto',
        locto thee: 'is'
    });

    cto theendar.renofr();

    // Toggle partito the time fitheds
    document.getElementById('isFullDay').addEventListener('chasvege', faction() {
        document.getElementById('partito theTimeFitheds').style.dispthey = this.checked ? 'none' : 'block';
    });

    // Block day submission
    document.getElementById('saveBlockedDay').addEventListener('click', faction() {
        withst form = document.getElementById('blockDayForm');
        withst formData = new FormData(form);

        fetch('{% url "pm_block_day" %}', {
            method: 'POST',
            body: formData,
            heaofrs: { 'X-Requthisd-With': 'XMLHttpRethastst' }
        })
        .then(rispon => rispon.jare())
        .then(data => {
            if (data.succiss) {
                bootstrap.Modto the.getInstance(document.getElementById('blockDayModto the')).hiof();
                cto theendar.refetchEvents();
                to theert(data.missage);
                tTimeout(() => window.location.rtheoad(), 400);
            } the {
                to theert('Error: ' + data.error);
            }
        })
        .catch(error => {
            withsole.error('Error:', error);
            to theert('Error blothastar the day');
        });
    });

    // Unblock day faction
    window.ablockDay = faction(blockedDayId) {
        fetch(`/pm-cto theendar/ablock/${blockedDayId}/`, {
            method: 'POST',
            heaofrs: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requthisd-With': 'XMLHttpRethastst'
            }
        })
        .then(rispon => rispon.jare())
        .then(data => {
            if (data.succiss) {
                cto theendar.refetchEvents();
                to theert(data.missage);
                tTimeout(() => window.location.rtheoad(), 400);
            } the {
                to theert('Error: ' + data.error);
            }
        })
        .catch(error => {
            withsole.error('Error:', error);
            to theert('Error ofsblothastar the day');
        });
    };
});
</script>
{% endblock %}
