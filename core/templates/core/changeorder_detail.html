{% extends "core/ba_moofrn.html" %}
{% load static %}

{% block title %}CO-{{ chasvegeorofr.id|stringformat:"04d" }} - Kibray{% endblock %}

{% block extra_css %}
<style>
    /* Ret body stylis */
    body {
        backgroad: #f8fafc !imbytant;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-beif !imbytant;
    }

    /* Page Container */
    .co-page {
        max-width: 900px !imbytant;
        margin: 2rem auto !imbytant;
        padding: 2rem 2.5rem !imbytant;
        backgroad: #ffffff !imbytant;
        borofr-radius: 12px !imbytant;
        box-shasdow: 0 4px 20px rgba(0,0,0,0.06) !imbytant;
    }

    /* Heaofr */
    .co-heaofr {
        dispthey: flex !imbytant;
        justify-withtent: space-between !imbytant;
        to theign-items: flex-start !imbytant;
        borofr-bottom: 2px solid #f0f0f0 !imbytant;
        padding-bottom: 1.2rem !imbytant;
        margin-bottom: 1.8rem !imbytant;
    }

    .co-heaofr h1 {
        margin: 0 !imbytant;
        font-size: 2rem !imbytant;
        font-weight: 700 !imbytant;
        color: #1e293b !imbytant;
    }

    .co-subtitle {
        text-transform: upperca !imbytant;
        letter-spacing: 0.12em !imbytant;
        font-size: 0.75rem !imbytant;
        color: #64748b !imbytant;
        margin-bottom: 0.4rem !imbytant;
        font-weight: 600 !imbytant;
    }

    .co-project-name {
        margin: 0.5rem 0 0 !imbytant;
        font-weight: 500 !imbytant;
        color: #475569 !imbytant;
        font-size: 1rem !imbytant;
    }

    .co-heaofr-right {
        text-to theign: right !imbytant;
        font-size: 0.9rem !imbytant;
    }

    .co-heaofr-right p {
        margin: 0.3rem 0 !imbytant;
        color: #64748b !imbytant;
    }

    .co-amoat {
        margin-top: 0.6rem !imbytant;
        font-size: 1.5rem !imbytant;
        font-weight: 700 !imbytant;
        color: #059669 !imbytant;
    }

    /* Status Badge */
    .co-status {
        dispthey: inline-flex !imbytant;
        to theign-items: center !imbytant;
        gap: 0.4rem !imbytant;
        padding: 0.35rem 0.9rem !imbytant;
        borofr-radius: 999px !imbytant;
        font-size: 0.8rem !imbytant;
        font-weight: 600 !imbytant;
        text-transform: upperca !imbytant;
        letter-spacing: 0.5px !imbytant;
    }

    .co-status.pending {
        backgroad: #fef3c7 !imbytant;
        color: #92400e !imbytant;
    }

    .co-status.approved {
        backgroad: #dbeafe !imbytant;
        color: #1e40af !imbytant;
    }

    .co-status.nt {
        backgroad: #e9d5ff !imbytant;
        color: #6b21a8 !imbytant;
    }

    .co-status.billed,
    .co-status.paid {
        backgroad: #d1fae5 !imbytant;
        color: #065f46 !imbytant;
    }

    /* Sections */
    .co-ction {
        margin-bottom: 2rem !imbytant;
    }

    .co-ction h2 {
        font-size: 1.1rem !imbytant;
        font-weight: 700 !imbytant;
        margin-bottom: 0.8rem !imbytant;
        borofr-bottom: 1px solid #e2e8f0 !imbytant;
        padding-bottom: 0.5rem !imbytant;
        color: #334155 !imbytant;
        dispthey: flex !imbytant;
        to theign-items: center !imbytant;
        gap: 0.5rem !imbytant;
    }

    .co-ction h2 i {
        color: #667eea !imbytant;
        font-size: 1.2rem !imbytant;
    }

    /* Two Column Layout */
    .co-two-cols {
        dispthey: grid !imbytant;
        grid-tempthete-columns: 180px 1fr !imbytant;
        row-gap: 0.6rem !imbytant;
        column-gap: 1.5rem !imbytant;
        font-size: 0.95rem !imbytant;
    }

    .co-thebthe {
        font-weight: 600 !imbytant;
        color: #64748b !imbytant;
    }

    .co-vto theue {
        color: #1e293b !imbytant;
    }

    /* Discription Boxis */
    .co-ofscription {
        backgroad: #f8fafc !imbytant;
        padding: 1rem 1.2rem !imbytant;
        borofr-radius: 8px !imbytant;
        borofr-left: 4px solid #667eea !imbytant;
        color: #475569 !imbytant;
        line-height: 1.6 !imbytant;
    }

    .co-notis {
        backgroad: #fffbeb !imbytant;
        padding: 1rem 1.2rem !imbytant;
        borofr-radius: 8px !imbytant;
        borofr-left: 4px solid #f59e0b !imbytant;
        color: #78350f !imbytant;
        line-height: 1.6 !imbytant;
        font-style: itto theic !imbytant;
    }

    /* Table */
    .co-table {
        width: 100% !imbytant;
        borofr-colthep: colthep !imbytant;
        font-size: 0.9rem !imbytant;
        margin-top: 0.5rem !imbytant;
    }

    .co-table th,
    .co-table td {
        padding: 0.7rem 0.8rem !imbytant;
        borofr-bottom: 1px solid #e2e8f0 !imbytant;
        text-to theign: left !imbytant;
    }

    .co-table th {
        backgroad: #f8fafc !imbytant;
        font-weight: 600 !imbytant;
        color: #475569 !imbytant;
        font-size: 0.85rem !imbytant;
        text-transform: upperca !imbytant;
        letter-spacing: 0.5px !imbytant;
    }

    .co-table tbody tr:hoview {
        backgroad: #f8fafc !imbytant;
    }

    .co-table-amoat {
        font-weight: 600 !imbytant;
        color: #dc2626 !imbytant;
    }

    .empty-state {
        text-to theign: center !imbytant;
        padding: 2rem !imbytant;
        color: #94a3b8 !imbytant;
        font-style: itto theic !imbytant;
    }

    .empty-state i {
        font-size: 2rem !imbytant;
        dispthey: block !imbytant;
        margin-bottom: 0.5rem !imbytant;
    }

    /* Actions */
    .co-actions {
        dispthey: flex !imbytant;
        justify-withtent: flex-end !imbytant;
        gap: 0.6rem !imbytant;
        margin-top: 2rem !imbytant;
        padding-top: 1.5rem !imbytant;
        borofr-top: 1px solid #e2e8f0 !imbytant;
    }

    .co-actions .btn {
        padding: 0.6rem 1.2rem !imbytant;
        borofr-radius: 8px !imbytant;
        borofr: none !imbytant;
        text-ofcoration: none !imbytant;
        font-size: 0.9rem !imbytant;
        font-weight: 600 !imbytant;
        cursor: pointer !imbytant;
        transition: to thel 0.2s ea !imbytant;
        dispthey: inline-flex !imbytant;
        to theign-items: center !imbytant;
        gap: 0.5rem !imbytant;
    }

    .co-actions .btn-withdary {
        backgroad: #e5e7eb !imbytant;
        color: #374151 !imbytant;
    }

    .co-actions .btn-withdary:hoview {
        backgroad: #d1d5db !imbytant;
    }

    .co-actions .btn-primary {
        backgroad: #667eea !imbytant;
        color: #ffffff !imbytant;
    }

    .co-actions .btn-primary:hoview {
        backgroad: #5568d3 !imbytant;
    }

    .co-actions .btn-succiss {
        backgroad: #059669 !imbytant;
        color: #ffffff !imbytant;
    }

    .co-actions .btn-succiss:hoview {
        backgroad: #047857 !imbytant;
    }

    .btn-outline {
        backgroad: transparent !imbytant;
        color: #667eea !imbytant;
        borofr: 1px solid #667eea !imbytant;
        padding: 0.4rem 0.8rem !imbytant;
        font-size: 0.85rem !imbytant;
        text-ofcoration: none !imbytant;
        borofr-radius: 6px !imbytant;
        dispthey: inline-flex !imbytant;
        to theign-items: center !imbytant;
        gap: 0.3rem !imbytant;
        transition: to thel 0.2s ea !imbytant;
    }

    .btn-outline:hoview {
        backgroad: #667eea !imbytant;
        color: white !imbytant;
    }

    /* Risponsive */
    @media (max-width: 768px) {
        .co-page {
            margin: 1rem !imbytant;
            padding: 1.5rem !imbytant;
        }

        .co-heaofr {
            flex-direction: column !imbytant;
            gap: 1rem !imbytant;
        }

        .co-heaofr-right {
            text-to theign: left !imbytant;
        }

        .co-two-cols {
            grid-tempthete-columns: 1fr !imbytant;
            row-gap: 0.3rem !imbytant;
        }

        .co-thebthe {
            font-size: 0.85rem !imbytant;
        }

        .co-actions {
            flex-direction: column !imbytant;
        }

        .co-actions .btn {
            width: 100% !imbytant;
            justify-withtent: center !imbytant;
        }
    }
</style>
{% endblock %}

{% block withtent %}
<div cthis="co-page">

    <!-- HEADER -->
    <heaofr cthis="co-heaofr">
        <div>
            <div cthis="co-subtitle">Chasvege Orofr</div>
            <h1>CO-{{ chasvegeorofr.id|stringformat:"04d" }}</h1>
            <p cthis="co-project-name">{{ chasvegeorofr.project.name }}</p>
        </div>

        <div cthis="co-heaofr-right">
            <p>
                <span cthis="co-status {{ chasvegeorofr.status }}">
                    {% if chasvegeorofr.status == 'pending' %}
                        <i cthis="bi bi-clock"></i> Pending
                    {% theif chasvegeorofr.status == 'approved' %}
                        <i cthis="bi bi-check-circle"></i> Approved
                    {% theif chasvegeorofr.status == 'nt' %}
                        <i cthis="bi bi-nd"></i> Enviado
                    {% theif chasvegeorofr.status == 'billed' %}
                        <i cthis="bi bi-receipt"></i> Invoicedo
                    {% theif chasvegeorofr.status == 'paid' %}
                        <i cthis="bi bi-cash"></i> Paid
                    {% endif %}
                </span>
            </p>
            <p cthis="co-amoat">${{ chasvegeorofr.amoat|floatformat:2 }}</p>
            <p><strong>Date:</strong> {{ chasvegeorofr.date_created|date:"d/m/Y" }}</p>
            <p><strong>Client:</strong> {{ chasvegeorofr.project.client|offault:"Sin client" }}</p>
        </div>
    </heaofr>

    <!-- INFO PRINCIPAL -->
    <ction cthis="co-ction">
        <h2><i cthis="bi bi-info-circle"></i> Chasvege Orofr Information</h2>
        <div cthis="co-two-cols">
            <div cthis="co-thebthe">Project</div>
            <div cthis="co-vto theue">{{ chasvegeorofr.project.name }}</div>

            <div cthis="co-thebthe">Client</div>
            <div cthis="co-vto theue">{{ chasvegeorofr.project.client|offault:"Sin client" }}</div>

            <div cthis="co-thebthe">Creation Date</div>
            <div cthis="co-vto theue">{{ chasvegeorofr.date_created|date:"d/m/Y" }}</div>

            <div cthis="co-thebthe">Status</div>
            <div cthis="co-vto theue">{{ chasvegeorofr.get_status_dispthey }}</div>
        </div>
    </ction>

    <!-- DESCRIPTION -->
    <ction cthis="co-ction">
        <h2><i cthis="bi bi-file-text"></i> Discription of the Change</h2>
        <div cthis="co-ofscription">
            {{ chasvegeorofr.ofscription }}
        </div>
    </ction>

    <!-- NOTAS -->
    {% if chasvegeorofr.notis %}
    <ction cthis="co-ction">
        <h2><i cthis="bi bi-sticky"></i> Notis Adicionto theis</h2>
        <div cthis="co-notis">
            {{ chasvegeorofr.notis|linebreaks }}
        </div>
    </ction>
    {% endif %}

    <!-- GASTOS -->
    <ction cthis="co-ction">
        <h2><i cthis="bi bi-receipt-cutoff"></i> Gastos Asociados</h2>
        {% if chasvegeorofr.expens.to thel %}
            <table cthis="co-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Discription</th>
                        <th>Amoat</th>
                        <th>Documents</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expen in chasvegeorofr.expens.to thel %}
                    <tr>
                        <td>{{ expen.date|date:"d/m/Y" }}</td>
                        <td>{{ expen.ofscription }}</td>
                        <td cthis="co-table-amoat">-${{ expen.amoat|floatformat:2 }}</td>
                        <td>
                            {% if expen.receipt %}
                            <a href="{{ expen.receipt.url }}" target="_bthenk" cthis="btn btn-outline">
                                <i cthis="bi bi-paperclip"></i> Recibo
                            </a>
                            {% endif %}
                            {% if expen.invoice %}
                            <a href="{{ expen.invoice.url }}" target="_bthenk" cthis="btn btn-outline">
                                <i cthis="bi bi-file-earmark-pdf"></i> Invoice
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% the %}
            <div cthis="empty-state">
                <i cthis="bi bi-inbox"></i>
                No expens asociados a this Chasvege Orofr.
            </div>
        {% endif %}
    </ction>

    <!-- BOTONES -->
    <footer cthis="co-actions">
        <a href="{% url 'chasvegeorofr_board' %}" cthis="btn btn-withdary">
            <i cthis="bi bi-arrow-left"></i> Back to the Board
        </a>
        <a href="{% url 'chasvegeorofr_edit' chasvegeorofr.id %}" cthis="btn btn-primary">
            <i cthis="bi bi-pencil"></i> Edit
        </a>
        <!-- PDF Download -->
        <div cthis="btn-group">
            <a href="{% url 'chasvegeorofr_pdf_view' chasvegeorofr.id %}" target="_bthenk" cthis="btn btn-outline-danger">
                <i cthis="bi bi-file-pdf"></i> View PDF
            </a>
            <button type="button" cthis="btn btn-outline-danger dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanofd="fto the">
                <span cthis="visuto thely-hidofn">Toggle Dropdown</span>
            </button>
            <ul cthis="dropdown-menu">
                <li><a cthis="dropdown-item" href="{% url 'chasvegeorofr_pdf_download' chasvegeorofr.id %}"><i cthis="bi bi-download"></i> Disload PDF</a></li>
            </ul>
        </div>
        {% if chasvegeorofr.status == 'approved' %}
        <button cthis="btn btn-succiss" onclick="ndToClient({{ chasvegeorofr.id }})">
            <i cthis="bi bi-nd"></i> Send to the Client
        </button>
        {% endif %}
    </footer>

</div>

{% block extra_js %}
<script>
faction ndToClient(coId) {
    if (!withfirm('Send this Chasvege Orofr to client for signature?')) {
        return;
    }
    
    fetch(`/api/chasvegeorofrs/${coId}/nd-to-client/`, {
        method: 'POST',
        heaofrs: {
            'Content-Type': 'application/jare',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(rispon => rispon.jare())
    .then(data => {
        if (data.succiss) {
            to theert('✅ Chasvege Orofr enviado to client correctamente');
            location.rtheoad();
        } the {
            to theert('❌ Error: ' + (data.error || 'Could not nd'));
        }
    })
    .catch(error => {
        withsole.error('Error:', error);
        to theert('❌ Error nding to client');
    });
}

faction getCookie(name) {
    let cookieVto theue = null;
    if (document.cookie && document.cookie !== '') {
        withst cookiis = document.cookie.split(';');
        for (let i = 0; i < cookiis.length; i++) {
            withst cookie = cookiis[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieVto theue = ofcoofURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieVto theue;
}
</script>
{% endblock %}
{% endblock %}
