{% extends "core/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}Dashboard - Kibray{% endblock %}

{% block content %}
<div class="container-fluid py-3 py-md-4">
    <!-- Header con logo y bienvenida -->
    <div class="text-center mb-4">
        <img src="{% static 'brand/kibray-logo.png' %}" alt="Kibray Logo" style="height:50px; max-height: 50px;" class="mb-2" onerror="this.style.display='none'">
        <h2 class="h3 h-md-2 mt-2 mb-0">{% trans "Welcome" %}, {{ user.first_name|default:user.username }}</h2>
        <p class="text-muted small">{% trans "Dashboard General" %}</p>
    </div>

    <!-- Botones de acción - Grid responsive -->
    <div class="row mb-4 g-2">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3"><i class="bi bi-lightning-charge-fill text-warning me-2"></i>{% trans "Quick Actions" %}</h5>
                    <div class="row g-2">
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="{% url 'payroll_weekly_review' %}" class="btn btn-success w-100 d-flex flex-column align-items-center py-3">
                                <i class="bi bi-calendar-week fs-4 mb-1"></i>
                                <span class="small">{% trans "Payroll" %}</span>
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="{% url 'schedule_create' %}" class="btn btn-primary w-100 d-flex flex-column align-items-center py-3">
                                <i class="bi bi-calendar-plus fs-4 mb-1"></i>
                                <span class="small">{% trans "Add Event" %}</span>
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="{% url 'expense_create' %}" class="btn btn-danger w-100 d-flex flex-column align-items-center py-3">
                                <i class="bi bi-cash-coin fs-4 mb-1"></i>
                                <span class="small">{% trans "Add Expense" %}</span>
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="{% url 'income_create' %}" class="btn btn-info w-100 d-flex flex-column align-items-center py-3">
                                <i class="bi bi-piggy-bank fs-4 mb-1"></i>
                                <span class="small">{% trans "Add Income" %}</span>
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="{% url 'timeentry_create' %}" class="btn btn-warning w-100 d-flex flex-column align-items-center py-3">
                                <i class="bi bi-clock-history fs-4 mb-1"></i>
                                <span class="small">{% trans "Register Hours" %}</span>
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="{% url 'changeorder_board' %}" class="btn btn-outline-warning w-100 d-flex flex-column align-items-center py-3">
                                <i class="bi bi-kanban fs-4 mb-1"></i>
                                <span class="small">Change Orders</span>
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="{% url 'changeorder_create' %}" class="btn btn-outline-primary w-100 d-flex flex-column align-items-center py-3">
                                <i class="bi bi-file-earmark-plus fs-4 mb-1"></i>
                                <span class="small">New CO</span>
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="{% url 'invoice_list' %}" class="btn btn-outline-info w-100 d-flex flex-column align-items-center py-3">
                                <i class="bi bi-receipt fs-4 mb-1"></i>
                                <span class="small">{% trans "Invoices" %}</span>
                            </a>
                        </div>
                        <div class="col-6 col-md-4 col-lg-3">
                            <a href="{% url 'invoice_payment_dashboard' %}" class="btn btn-outline-success w-100 d-flex flex-column align-items-center py-3">
                                <i class="bi bi-credit-card fs-4 mb-1"></i>
                                <span class="small">{% trans "Payments" %}</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Overview y Upcoming Events -->
    <div class="row mb-4 g-3">
        <div class="col-12 col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-folder2-open text-primary me-2"></i>
                        {% trans "Project Overview" %}
                    </h5>
                    <div class="table-responsive">
                        <!-- Tabla o resumen de proyectos aquí -->
                        <p class="text-muted small">{% trans "Project summary will appear here" %}</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-calendar-event text-info me-2"></i>
                        {% trans "Upcoming Events" %} (30 {% trans "days" %})
                    </h5>
                    <div class="list-group list-group-flush">
                        <!-- Lista de eventos próximos aquí -->
                        <p class="text-muted small">{% trans "Upcoming events will appear here" %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficas - Responsive Grid -->
    <div class="row mb-4 g-3">
        <div class="col-12 col-md-6 col-xl-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-muted">
                        <i class="bi bi-graph-up me-1"></i>
                        {% trans "Net Profit" %}
                    </h6>
                    <div style="position: relative; height: 250px;">
                        <canvas id="netProfitChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-muted">
                        <i class="bi bi-wallet2 me-1"></i>
                        {% trans "Budget per Project" %}
                    </h6>
                    <div style="position: relative; height: 250px;">
                        <canvas id="budgetChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-12 col-xl-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-muted">
                        <i class="bi bi-cash-stack me-1"></i>
                        {% trans "Income vs Expense" %}
                    </h6>
                    <div style="position: relative; height: 250px;">
                        <canvas id="incomeExpenseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendario de eventos -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-calendar3 text-success me-2"></i>
                        {% trans "Project Event Calendar" %}
                    </h5>
                    <div id="calendar" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== CHART.JS - Responsive Configuration =====
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    
    // Income vs Expense Chart
    const ctx1 = document.getElementById('incomeExpenseChart');
    if (ctx1) {
        new Chart(ctx1.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ chart_labels|safe }},
                datasets: [
                    {
                        label: '{% trans "Income" %}',
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        data: {{ chart_income|safe }}
                    },
                    {
                        label: '{% trans "Expense" %}',
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        data: {{ chart_expense|safe }}
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    } 
                }
            }
        });
    }

        });
    }

    // Budget Chart
    const ctx2 = document.getElementById('budgetChart');
    if (ctx2) {
        new Chart(ctx2.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ chart_budget_labels|safe }},
                datasets: [
                    {
                        label: '{% trans "Labor" %}',
                        data: {{ chart_budget_labor|safe }},
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    },
                    {
                        label: '{% trans "Materials" %}',
                        data: {{ chart_budget_materials|safe }},
                        backgroundColor: 'rgba(153, 102, 255, 0.7)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 2
                    },
                    {
                        label: '{% trans "Other" %}',
                        data: {{ chart_budget_other|safe }},
                        backgroundColor: 'rgba(255, 205, 86, 0.7)',
                        borderColor: 'rgba(255, 205, 86, 1)',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    tooltip: { mode: 'index', intersect: false },
                    legend: { position: 'top' }
                },
                scales: { 
                    y: { 
                        beginAtZero: true,
                        stacked: false,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    } 
                }
            }
        });
    }

    // Net Profit Chart
    const netProfitValues = {{ chart_net_profit|safe }};
    const netProfitColors = netProfitValues.map(value => 
        value >= 0 ? 'rgba(0, 200, 83, 0.7)' : 'rgba(255, 99, 132, 0.7)'
    );
    const netProfitBorders = netProfitValues.map(value => 
        value >= 0 ? 'rgba(0, 200, 83, 1)' : 'rgba(255, 99, 132, 1)'
    );

    const ctx3 = document.getElementById('netProfitChart');
    if (ctx3) {
        new Chart(ctx3.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ chart_labels|safe }},
                datasets: [{
                    label: '{% trans "Net Profit" %}',
                    data: netProfitValues,
                    backgroundColor: netProfitColors,
                    borderColor: netProfitBorders,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: { 
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    } 
                }
            }
        });
    }

    // ===== FULLCALENDAR - Responsive =====
    var calendarEl = document.getElementById('calendar');
    if (calendarEl) {
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: window.innerWidth < 768 ? 'listWeek' : 'dayGridMonth',
            events: {{ calendar_events|safe }},
            locale: '{{ request.session.lang|default:"en" }}',
            height: 'auto',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: window.innerWidth < 768 ? 'listWeek,dayGridMonth' : 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            buttonText: {
                today: '{% trans "Today" %}',
                month: '{% trans "Month" %}',
                week: '{% trans "Week" %}',
                day: '{% trans "Day" %}',
                list: '{% trans "List" %}'
            },
            eventClick: function(info) {
                if (info.event.url) {
                    window.location.href = info.event.url;
                    return false;
                }
            },
            windowResize: function(view) {
                if (window.innerWidth < 768) {
                    calendar.changeView('listWeek');
                } else {
                    calendar.changeView('dayGridMonth');
                }
            }
        });
        calendar.render();
    }
});
</script>
{% endblock %}
{% endblock %}