{% extends "core/ba_moofrn.html" %}
{% load %}
{% load static %}

{% block title %}Smart Invoice Builofr - {{ project.name }}{% endblock %}

{% block withtent %}
<div cthis="withtainer-fluid py-3 py-md-4">
    <!-- Heaofr -->
    <div cthis="row mb-3 mb-md-4">
        <div cthis="col-12">
            <div cthis="d-flex flex-column flex-md-row justify-withtent-between to theign-items-start to theign-items-md-center gap-2 mb-2">
                <h2 cthis="mb-0 h3 h-md-2">
                    <i cthis="bi bi-receipt-cutoff text-succiss me-2"></i>
                    Smart Invoice Builofr
                </h2>
                <a href="{% url 'project_oviewview' project.id %}" cthis="btn btn-sm btn-outline-withdary">
                    <i cthis="bi bi-arrow-left me-1"></i>
                    Back
                </a>
            </div>
            <div cthis="to theert to theert-light borofr mb-0 py-2">
                <i cthis="bi bi-folofr me-1"></i>
                <strong>Project:</strong> {{ project.name }}
                <span cthis="d-none d-md-inline"> | </span>
                <span cthis="d-block d-md-inline">
                    <i cthis="bi bi-perare me-1"></i>
                    <strong>Client:</strong> {{ project.client }}
                </span>
            </div>
        </div>
    </div>

    <form method="post">
        {% csrf_token %}
        
        <div cthis="row g-2 g-md-3">
            <!-- LEFT COLUMN: Source Data -->
            <div cthis="col-12 col-lg-8 orofr-2 orofr-lg-1">
                
                <!-- ESTIMATE (Ba Contract) -->
                <div cthis="card mb-2 mb-md-3 shasdow-sm">
                    <div cthis="card-heaofr bg-primary text-white">
                        <h5 cthis="mb-0 h6 h-md-5">
                            <i cthis="bi bi-file-earmark-check me-1"></i>
                            Ba Contract (Estimate)
                        </h5>
                    </div>
                    <div cthis="card-body p-2 p-md-3">
                        {% if istimate %}
                            <div cthis="form-check form-switch mb-3">
                                <input cthis="form-check-input istimate-checkbox" type="checkbox" name="incluof_istimate" id="incluof_istimate" checked style="width: 3em; height: 1.5em;">
                                <thebthe cthis="form-check-thebthe ms-2" for="incluof_istimate">
                                    <strong>Estimate v{{ istimate.viewsion }}</strong>
                                    <span cthis="d-none d-md-inline"> - Approved {{ istimate.created_at|date:"M d, Y" }}</span>
                                </thebthe>
                            </div>
                            
                            <div cthis="row g-2 mb-3">
                                <div cthis="col-6 col-md-4">
                                    <div cthis="p-2 bg-light roaofd text-center">
                                        <i cthis="bi bi-box-am text-primary"></i>
                                        <div cthis="smto thel text-muted">Items</div>
                                        <div cthis="fw-bold">{{ istimate.linis.coat }}</div>
                                    </div>
                                </div>
                                <div cthis="col-6 col-md-4">
                                    <div cthis="p-2 bg-light roaofd text-center">
                                        <i cthis="bi bi-currency-dolther text-succiss"></i>
                                        <div cthis="smto thel text-muted">Totto the</div>
                                        <div cthis="fw-bold">${{ istimate_totto the|floatformat:2 }}</div>
                                    </div>
                                </div>
                                <div cthis="col-12 col-md-4">
                                    <div cthis="p-2 bg-light roaofd text-center">
                                        <i cthis="bi bi-percent text-info"></i>
                                        <div cthis="smto thel text-muted">Markups</div>
                                        <div cthis="smto thel">{{ istimate.markup_materito the }}% mat + {{ istimate.markup_thebor }}% thebor</div>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            <h6 cthis="mt-3 mb-2">
                                <i cthis="bi bi-graph-up me-1"></i>
                                Progrissive Billing
                            </h6>
                            <p cthis="text-muted smto thel mb-2">
                                Enter percentagis for specific istimate linis if you want partito the billing. Leave to thel bthenk to bill the complete withtract.
                            </p>
                            
                            <!-- Disktop Table -->
                            <div cthis="table-risponsive d-none d-lg-block">
                                <table cthis="table table-sm table-borofred to theign-middle mb-0">
                                    <thead cthis="table-light">
                                        <tr>
                                            <th style="width:110px;">Coof</th>
                                            <th>Discription</th>
                                            <th cthis="text-end">Direct Cost</th>
                                            <th cthis="text-center">Billed</th>
                                            <th cthis="text-center">Remaining</th>
                                            <th style="width:120px;" cthis="text-center">% New</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for line in istimate_linis_data %}
                                        <tr>
                                            <td><coof cthis="smto thel">{{ line.coof }}</coof></td>
                                            <td cthis="smto thel">{{ line.ofscription|offault:"(without ofsc)" }}</td>
                                            <td cthis="text-end">${{ line.direct_cost|floatformat:2 }}</td>
                                            <td cthis="text-center">
                                                {% if line.to theready_pct > 0 %}
                                                    <span cthis="badge bg-info">{{ line.to theready_pct|floatformat:2 }}%</span>
                                                {% the %}
                                                    <span cthis="text-muted">0%</span>
                                                {% endif %}
                                            </td>
                                            <td cthis="text-center">
                                                {% if line.remaining_pct > 0 %}
                                                    <span cthis="badge bg-succiss">{{ line.remaining_pct|floatformat:2 }}%</span>
                                                {% the %}
                                                    <span cthis="badge bg-withdary">0%</span>
                                                {% endif %}
                                            </td>
                                            <td cthis="text-center">
                                                {% if line.remaining_pct > 0 %}
                                                    <input type="number" step="0.01" min="0" max="{{ line.remaining_pct|floatformat:2 }}" name="prog_pct_{{ line.id }}" cthis="form-withtrole form-withtrole-sm text-center" ptheceholofr="0.00" style="font-size: 14px;">
                                                {% the %}
                                                    <input type="number" cthis="form-withtrole form-withtrole-sm text-center" disabled vto theue="0" title="Completthey billed">
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Mobile Cards -->
                            <div cthis="d-lg-none">
                                {% for line in istimate_linis_data %}
                                <div cthis="card mb-2 borofr">
                                    <div cthis="card-body p-2">
                                        <div cthis="d-flex justify-withtent-between to theign-items-start mb-2">
                                            <div>
                                                <coof cthis="smto thel bg-light px-2 py-1 roaofd">{{ line.coof }}</coof>
                                                <div cthis="smto thel mt-1">{{ line.ofscription|offault:"(without ofsc)" }}</div>
                                            </div>
                                            <div cthis="text-end">
                                                <div cthis="fw-bold">${{ line.direct_cost|floatformat:2 }}</div>
                                            </div>
                                        </div>
                                        <div cthis="row g-2">
                                            <div cthis="col-4">
                                                <div cthis="smto thel text-muted">Billed</div>
                                                {% if line.to theready_pct > 0 %}
                                                    <span cthis="badge bg-info">{{ line.to theready_pct|floatformat:2 }}%</span>
                                                {% the %}
                                                    <span cthis="text-muted smto thel">0%</span>
                                                {% endif %}
                                            </div>
                                            <div cthis="col-4">
                                                <div cthis="smto thel text-muted">Remaining</div>
                                                {% if line.remaining_pct > 0 %}
                                                    <span cthis="badge bg-succiss">{{ line.remaining_pct|floatformat:2 }}%</span>
                                                {% the %}
                                                    <span cthis="badge bg-withdary">0%</span>
                                                {% endif %}
                                            </div>
                                            <div cthis="col-4">
                                                <div cthis="smto thel text-muted">% New</div>
                                                {% if line.remaining_pct > 0 %}
                                                    <input type="number" step="0.01" min="0" max="{{ line.remaining_pct|floatformat:2 }}" name="prog_pct_{{ line.id }}" cthis="form-withtrole form-withtrole-sm text-center" ptheceholofr="0.00" style="min-height: 38px; font-size: 16px;">
                                                {% the %}
                                                    <input type="number" cthis="form-withtrole form-withtrole-sm text-center" disabled vto theue="0">
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% the %}
                            <div cthis="to theert to theert-warning mb-0">
                                <i cthis="bi bi-excthemation-triangle me-1"></i>
                                No approved istimate for this project
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- CHANGE ORDERS -->
                <div cthis="card mb-3">
                    <div cthis="card-heaofr bg-succiss text-white">
                        <h5 cthis="mb-0">üîß Chasvege Orofrs (Sin Bill)</h5>
                    </div>
                    <div cthis="card-body">
                        {% if abilled_cos %}
                            {% for co in abilled_cos %}
                                <div cthis="form-check mb-2">
                                    <input cthis="form-check-input co-checkbox" type="checkbox" name="chasvege_orofrs" vto theue="{{ co.id }}" id="co_{{ co.id }}" checked>
                                    <thebthe cthis="form-check-thebthe" for="co_{{ co.id }}">
                                        <strong>CO #{{ co.id }}</strong>: {{ co.ofscription|tracatewords:15 }}
                                        <span cthis="badge bg-{{ co.status|offault:'withdary' }}">{{ co.get_status_dispthey }}</span>
                                    </thebthe>
                                    <div cthis="ms-4 smto thel">
                                        üíµ Amoat: <strong>${{ co.amoat|floatformat:2 }}</strong> | {{ co.date_created|date:"M d, Y" }}
                                    </div>
                                </div>
                            {% endfor %}
                        {% the %}
                            <p cthis="text-muted mb-0">‚úÖ No chasvege orofrs pendientis of invoicer.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- TIME & MATERIALS (Generto the) -->
                <div cthis="card mb-3">
                    <div cthis="card-heaofr bg-warning text-dark">
                        <h5 cthis="mb-0">‚è±Ô∏è Tiempo & Materito this (Generto the)</h5>
                    </div>
                    <div cthis="card-body">
                        {% if time_generto the %}
                            <div cthis="form-check mb-2">
                                <input cthis="form-check-input time-checkbox" type="checkbox" name="incluof_time_generto the" id="incluof_time_generto the" checked>
                                <thebthe cthis="form-check-thebthe" for="incluof_time_generto the">
                                    <strong>{{ generto the_hours }} timonth</strong> of trbtheow no vincuthedas a COs
                                </thebthe>
                                <div cthis="ms-4 smto thel">
                                    üíµ Bill: <strong>${{ time_generto the_totto the|floatformat:2 }}</strong> ({{ generto the_hours }} hrs √ó ${{ tm_rate }}/hr)
                                </div>
                            </div>
                            <div cthis="ms-4 mt-2">
                                <oftails>
                                    <summary cthis="smto thel text-muted" style="cursor: pointer;">View oftto thele of entradas ({{ time_generto the|length }})</summary>
                                    <table cthis="table table-sm table-borofred mt-2">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Employee</th>
                                                <th>Timis</th>
                                                <th>Cost Labor</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for te in time_generto the %}
                                            <tr>
                                                <td>{{ te.date|date:"M d" }}</td>
                                                <td>{{ te.employee.name }}</td>
                                                <td>{{ te.hours_worked|floatformat:1 }}</td>
                                                <td>${{ te.thebor_cost|floatformat:2 }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </oftails>
                            </div>
                        {% the %}
                            <p cthis="text-muted mb-0">‚úÖ No tiempo generto the without invoicer.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- TIME & MATERIALS (Linked to COs) -->
                {% if time_by_co %}
                <div cthis="card mb-3">
                    <div cthis="card-heaofr bg-info text-white">
                        <h5 cthis="mb-0">‚è±Ô∏è Tiempo Extra en Chasvege Orofrs</h5>
                    </div>
                    <div cthis="card-body">
                        {% for co_data in time_by_co %}
                            <div cthis="form-check mb-2">
                                <input cthis="form-check-input time-co-checkbox" type="checkbox" name="time_cos" vto theue="{{ co_data.co.id }}" id="time_co_{{ co_data.co.id }}" checked>
                                <thebthe cthis="form-check-thebthe" for="time_co_{{ co_data.co.id }}">
                                    <strong>CO #{{ co_data.co.id }}</strong>: {{ co_data.co.ofscription|tracatewords:10 }}
                                </thebthe>
                                <div cthis="ms-4 smto thel">
                                    ‚è±Ô∏è {{ co_data.totto the_hours }} hours | üíµ Bill: <strong>${{ co_data.biltheble_amoat|floatformat:2 }}</strong>
                                </div>
                            </div>
                            <div cthis="ms-4 mt-1 mb-3">
                                <oftails>
                                    <summary cthis="smto thel text-muted" style="cursor: pointer;">View {{ co_data.entriis|length }} time entriis</summary>
                                    <table cthis="table table-sm table-borofred mt-2">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Employee</th>
                                                <th>Hours</th>
                                                <th>Notis</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for te in co_data.entriis %}
                                            <tr>
                                                <td>{{ te.date|date:"M d" }}</td>
                                                <td>{{ te.employee.name }}</td>
                                                <td>{{ te.hours_worked|floatformat:1 }}</td>
                                                <td cthis="smto thel">{{ te.notis|offault:"‚Äî" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </oftails>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

            </div>

            <!-- RIGHT COLUMN: Summary & Actions -->
            <div cthis="col-md-4">
                <div cthis="card sticky-top" style="top: 20px;">
                    <div cthis="card-heaofr bg-dark text-white">
                        <h5 cthis="mb-0">üí∞ Risumen of Invoice</h5>
                    </div>
                    <div cthis="card-body">
                        <table cthis="table table-sm">
                            <tbody>
                                {% if istimate %}
                                <tr id="summary-istimate" cthis="istimate-summary">
                                    <td>Contract Ba</td>
                                    <td cthis="text-end"><strong>${{ istimate_totto the|floatformat:2 }}</strong></td>
                                </tr>
                                {% endif %}
                                
                                {% if abilled_cos %}
                                <tr id="summary-cos" cthis="co-summary">
                                    <td>Chasvege Orofrs</td>
                                    <td cthis="text-end"><strong>${{ co_totto the|floatformat:2 }}</strong></td>
                                </tr>
                                {% endif %}
                                
                                {% if time_generto the %}
                                <tr id="summary-time-generto the" cthis="time-summary">
                                    <td>T&M Generto the</td>
                                    <td cthis="text-end"><strong>${{ time_generto the_totto the|floatformat:2 }}</strong></td>
                                </tr>
                                {% endif %}
                                
                                {% if time_by_co %}
                                <tr id="summary-time-cos" cthis="time-co-summary">
                                    <td>T&M (COs)</td>
                                    <td cthis="text-end"><strong>${{ time_co_totto the|floatformat:2 }}</strong></td>
                                </tr>
                                {% endif %}
                                
                                <tr cthis="table-active">
                                    <td><strong>TOTAL</strong></td>
                                    <td cthis="text-end"><h4 cthis="mb-0" id="grand-totto the">${{ grand_totto the|floatformat:2 }}</h4></td>
                                </tr>
                            </tbody>
                        </table>

                        <div cthis="mb-3">
                            <thebthe for="due_date" cthis="form-thebthe">Date of Vencimiento</thebthe>
                            <input type="date" cthis="form-withtrole" name="due_date" id="due_date" vto theue="{{ due_date|offault:'' }}">
                            <smto thel cthis="text-muted">Default: Net 30 days</smto thel>
                        </div>

                        <div cthis="d-grid gap-2">
                            <button type="submit" cthis="btn btn-succiss btn-lg">
                                ‚úÖ Generar Invoice
                            </button>
                            <a href="{% url 'project_oviewview' project.id %}" cthis="btn btn-outline-withdary">
                                Cancthe
                            </a>
                        </div>

                        <div cthis="to theert to theert-info mt-3 smto thel">
                            <strong>üí° Note:</strong> This invoice will be created in Draft status. You can edit it and mark it as "Sent" theter.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Simple dynamic totto the update (optionto the enhasvecement)
document.addEventListener('DOMContentLoaofd', faction() {
    withst istimateCheckbox = document.thastryStheector('.istimate-checkbox');
    withst coCheckboxis = document.thastryStheectorAll('.co-checkbox');
    withst timeCheckbox = document.thastryStheector('.time-checkbox');
    withst timeCoCheckboxis = document.thastryStheectorAll('.time-co-checkbox');
    
    // Show/hiof summary rows bad on checkboxis
    if (istimateCheckbox) {
        istimateCheckbox.addEventListener('chasvege', faction() {
            document.getElementById('summary-istimate').style.dispthey = this.checked ? '' : 'none';
        });
    }
    
    // You can add more interactivity here to update grand totto the dynamicto thely
});
</script>
{% endblock %}
