{% extends "core/base_modern.html" %}
{% load i18n %}
{% block content %}
<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Touch-Ups: {{ project.name }}</h2>
        <a href="{% url 'project_overview' project.id %}" class="btn btn-secondary btn-sm"><i class="bi bi-arrow-left"></i> {% trans "Volver al proyecto" %}</a>
    </div>
    <form method="get" class="row g-2 mb-3">
        <div class="col-md-2">
            <label class="form-label">Estado</label>
            <select name="status" class="form-select form-select-sm">
                <option value="">{% trans "Todos" %}</option>
                <option value="Pendiente" {% if filter_status == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                <option value="En Progreso" {% if filter_status == 'En Progreso' %}selected{% endif %}>En Progreso</option>
                <option value="Completada" {% if filter_status == 'Completada' %}selected{% endif %}>Completada</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Asignado</label>
            <select name="assigned" class="form-select form-select-sm">
                <option value="">{% trans "Todos" %}</option>
                <option value="unassigned" {% if filter_assigned == 'unassigned' %}selected{% endif %}>Sin asignar</option>
                {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if filter_assigned == emp.id|stringformat:'s' %}selected{% endif %}>{{ emp.username }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Desde</label>
            <input type="date" name="date_from" class="form-control form-control-sm" value="{{ filter_date_from }}" />
        </div>
        <div class="col-md-2">
            <label class="form-label">Hasta</label>
            <input type="date" name="date_to" class="form-control form-control-sm" value="{{ filter_date_to }}" />
        </div>
        <div class="col-md-2">
            <label class="form-label">Ordenar</label>
            <select name="sort" class="form-select form-select-sm">
                <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>Más reciente</option>
                <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Más antiguo</option>
                <option value="status" {% if sort_by == 'status' %}selected{% endif %}>Estado (A-Z)</option>
                <option value="-status" {% if sort_by == '-status' %}selected{% endif %}>Estado (Z-A)</option>
            </select>
        </div>
        <div class="col-md-2 d-flex align-items-end gap-2">
            <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
            <a href="{% url 'touchup_board' project.id %}" class="btn btn-outline-secondary btn-sm">Limpiar</a>
        </div>
    </form>
    <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Título</th>
                    <th>Estado</th>
                    <th>Asignado</th>
                    <th>Creado</th>
                    <th>Imagen</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for t in page_obj %}
                <tr data-task-id="{{ t.id }}">
                    <td>
                        <strong>{{ t.title }}</strong>
                        {% if t.description %}<br><small class="text-muted">{{ t.description|truncatewords:10 }}</small>{% endif %}
                    </td>
                    <td>
                        <select class="form-select form-select-sm status-select" data-task-id="{{ t.id }}" style="width:140px;">
                            <option value="Pendiente" {% if t.status == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                            <option value="En Progreso" {% if t.status == 'En Progreso' %}selected{% endif %}>En Progreso</option>
                            <option value="Completada" {% if t.status == 'Completada' %}selected{% endif %}>Completada</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-select form-select-sm assign-select" data-task-id="{{ t.id }}" style="width:150px;">
                            <option value="">Sin asignar</option>
                            {% for emp in employees %}
                                <option value="{{ emp.id }}" {% if t.assigned_to.id == emp.id %}selected{% endif %}>{{ emp.username }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><small>{{ t.created_at|date:'Y-m-d H:i' }}</small></td>
                    <td>
                        {% if t.image %}
                            <a href="{{ t.image.url }}" target="_blank">
                                <img src="{{ t.image.url }}" style="height:50px;width:50px;object-fit:cover;border-radius:4px;"/>
                            </a>
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'task_detail' t.id %}" class="btn btn-sm btn-outline-primary" title="Ver detalle"><i class="bi bi-eye"></i></a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-center text-muted py-4">No hay touch-ups con estos filtros.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if page_obj.has_other_pages %}
    <nav>
        <ul class="pagination pagination-sm justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1">Primera</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a></li>
            {% endif %}
            <li class="page-item active"><span class="page-link">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></li>
            {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Última</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    function postQuickUpdate(taskId, body) {
        return fetch(`/touchups/quick-update/${taskId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: body
        }).then(r => r.json());
    }
    document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', function() {
            const taskId = this.dataset.taskId;
            const newStatus = this.value;
            postQuickUpdate(taskId, `action=status&status=${encodeURIComponent(newStatus)}`)
                .then(data => { if (!data.success) console.warn('Fallo status', data); });
        });
    });
    document.querySelectorAll('.assign-select').forEach(select => {
        select.addEventListener('change', function() {
            const taskId = this.dataset.taskId;
            const empId = this.value;
            postQuickUpdate(taskId, `action=assign&employee_id=${encodeURIComponent(empId)}`)
                .then(data => { if (!data.success) console.warn('Fallo asignación', data); });
        });
    });
});
</script>
{% endblock %}

            body: `action=assign&employee_id=${employeeId}`

    /* Status Badge */      })

    .status-badge {      .then(res => res.json())

        display: inline-flex;      .then(data => {

        align-items: center;        if (data.success) {

        gap: 4px;          console.log('Asignado a:', data.assigned_to);

        padding: 6px 12px;        } else {

        border-radius: 20px;          alert('Error: ' + (data.error || 'No se pudo actualizar'));

        font-size: 13px;          location.reload();

        font-weight: 500;        }

    }      })

          .catch(err => {

    .status-badge.pendiente {        console.error(err);

        background: #fef3c7;        alert('Error de conexión');

        color: #92400e;        location.reload();

    }      });

        });

    .status-badge.en-progreso {  });

        background: #dbeafe;});

        color: #1e40af;</script>

    }{% endblock %}

    
    .status-badge.completada {
        background: #d1fae5;
        color: #065f46;
    }
    
    /* Action Buttons */
    .touchup-actions {
        display: flex;
        gap: 8px;
    }
    
    .action-btn {
        flex: 1;
        height: 44px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        border: 2px solid #e5e7eb;
        background: white;
        transition: all 0.2s;
    }
    
    .action-btn.primary {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }
    
    .action-btn:active {
        transform: scale(0.95);
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }
    
    .empty-state i {
        font-size: 64px;
        color: #d1d5db;
        margin-bottom: 16px;
    }
    
    .empty-state h3 {
        font-size: 18px;
        color: #6b7280;
        margin: 0;
    }
    
    /* FAB */
    .fab-create {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ec4899 0%, #d946ef 100%);
        color: white;
        border: none;
        font-size: 28px;
        box-shadow: 0 4px 16px rgba(236, 72, 153, 0.4);
        z-index: 100;
        transition: transform 0.2s;
    }
    
    .fab-create:active {
        transform: scale(0.9);
    }
    
    /* Desktop Table (Hidden on Mobile) */
    @media (max-width: 767px) {
        .desktop-table {
            display: none;
        }
    }
    
    @media (min-width: 768px) {
        .mobile-cards {
            display: none;
        }
        
        .desktop-table {
            display: block;
        }
        
        .fab-create {
            display: none;
        }
        
        .filter-chips {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="touchup-container">
    <!-- Header -->
    <div class="touchup-header">
        <h1><i class="bi bi-brush"></i> Touch-Ups</h1>
        <div class="project">
            <i class="bi bi-building"></i> {{ project.name }}
        </div>
    </div>
    
    <!-- Quick Filter Chips (Mobile) -->
    <div class="filter-chips">
        <button class="filter-chip {% if not filter_status %}active{% endif %}" onclick="filterBy('status', '')">
            <i class="bi bi-list"></i> Todos
        </button>
        <button class="filter-chip {% if filter_status == 'Pendiente' %}active{% endif %}" onclick="filterBy('status', 'Pendiente')">
            <i class="bi bi-clock"></i> Pendiente
        </button>
        <button class="filter-chip {% if filter_status == 'En Progreso' %}active{% endif %}" onclick="filterBy('status', 'En Progreso')">
            <i class="bi bi-play-circle"></i> En Progreso
        </button>
        <button class="filter-chip {% if filter_status == 'Completada' %}active{% endif %}" onclick="filterBy('status', 'Completada')">
            <i class="bi bi-check-circle"></i> Completada
        </button>
    </div>
    
    <!-- Advanced Filters (Collapsible) -->
    <div class="advanced-filters">
        <button type="button" class="filters-toggle" data-bs-toggle="collapse" data-bs-target="#filtersSection" aria-expanded="false">
            <span><i class="bi bi-funnel"></i> Filtros Avanzados</span>
            <i class="bi bi-chevron-down"></i>
        </button>
        
        <div class="collapse" id="filtersSection">
            <form method="get" class="mt-3" id="filterForm">
                <div class="row g-2">
                    <div class="col-12">
                        <label class="form-label">Estado</label>
                        <select name="status" class="form-select">
                            <option value="">{% trans "Todos" %}</option>
                            <option value="Pendiente" {% if filter_status == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                            <option value="En Progreso" {% if filter_status == 'En Progreso' %}selected{% endif %}>En Progreso</option>
                            <option value="Completada" {% if filter_status == 'Completada' %}selected{% endif %}>Completada</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Asignado</label>
                        <select name="assigned" class="form-select">
                            <option value="">{% trans "Todos" %}</option>
                            <option value="unassigned" {% if filter_assigned == 'unassigned' %}selected{% endif %}>Sin asignar</option>
                            {% for emp in employees %}
                                <option value="{{ emp.id }}" {% if filter_assigned == emp.id|stringformat:'s' %}selected{% endif %}>{{ emp.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Desde</label>
                        <input type="date" name="date_from" class="form-control" value="{{ filter_date_from }}">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Hasta</label>
                        <input type="date" name="date_to" class="form-control" value="{{ filter_date_to }}">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Ordenar</label>
                        <select name="sort" class="form-select">
                            <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>Más reciente</option>
                            <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Más antiguo</option>
                            <option value="status" {% if sort_by == 'status' %}selected{% endif %}>Estado (A-Z)</option>
                            <option value="-status" {% if sort_by == '-status' %}selected{% endif %}>Estado (Z-A)</option>
                        </select>
                    </div>
                    <div class="col-12 d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-fill">
                            <i class="bi bi-funnel"></i> Aplicar Filtros
                        </button>
                        <a href="{% url 'touchup_board' project.id %}" class="btn btn-outline-secondary flex-fill">
                            <i class="bi bi-x"></i> Limpiar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Mobile Cards -->
    <div class="mobile-cards">
        {% for t in page_obj %}
        <div class="touchup-card" data-task-id="{{ t.id }}">
            <div class="status-stripe {{ t.status|slugify }}"></div>
            <div class="touchup-content">
                <h3 class="touchup-title">{{ t.title }}</h3>
                {% if t.description %}
                    <p class="touchup-description">{{ t.description|truncatewords:15 }}</p>
                {% endif %}
                
                {% if t.image %}
                    <img src="{{ t.image.url }}" alt="Touchup" class="touchup-image" onclick="window.open('{{ t.image.url }}', '_blank')">
                {% endif %}
                
                <div class="touchup-meta">
                    <div class="meta-item">
                        <span class="status-badge {{ t.status|slugify }}">
                            {% if t.status == 'Pendiente' %}<i class="bi bi-clock"></i>
                            {% elif t.status == 'En Progreso' %}<i class="bi bi-play-circle"></i>
                            {% else %}<i class="bi bi-check-circle"></i>{% endif %}
                            {{ t.status }}
                        </span>
                    </div>
                    <div class="meta-item">
                        <i class="bi bi-person"></i>
                        <span>{{ t.assigned_to.username|default:"Sin asignar" }}</span>
                    </div>
                    <div class="meta-item">
                        <i class="bi bi-calendar"></i>
                        <span>{{ t.created_at|date:"d/m/Y" }}</span>
                    </div>
                </div>
                
                <div class="touchup-actions">
                    <button class="action-btn" onclick="updateStatus({{ t.id }})">
                        <i class="bi bi-arrow-repeat"></i> Estado
                    </button>
                    <button class="action-btn" onclick="assignTask({{ t.id }})">
                        <i class="bi bi-person-plus"></i> Asignar
                    </button>
                    <a href="{% url 'task_detail' t.id %}" class="action-btn primary">
                        <i class="bi bi-eye"></i> Ver
                    </a>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <h3>No hay touch-ups con estos filtros</h3>
        </div>
        {% endfor %}
    </div>
    
    <!-- Desktop Table -->
    <div class="desktop-table">
        <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Título</th>
                        <th>Estado</th>
                        <th>Asignado</th>
                        <th>Creado</th>
                        <th>Imagen</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in page_obj %}
                    <tr data-task-id="{{ t.id }}">
                        <td>
                            <strong>{{ t.title }}</strong>
                            {% if t.description %}<br><small class="text-muted">{{ t.description|truncatewords:10 }}</small>{% endif %}
                        </td>
                        <td>
                            <select class="form-select form-select-sm status-select" data-task-id="{{ t.id }}" style="width:140px;">
                                <option value="Pendiente" {% if t.status == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                                <option value="En Progreso" {% if t.status == 'En Progreso' %}selected{% endif %}>En Progreso</option>
                                <option value="Completada" {% if t.status == 'Completada' %}selected{% endif %}>Completada</option>
                            </select>
                        </td>
                        <td>
                            <select class="form-select form-select-sm assign-select" data-task-id="{{ t.id }}" style="width:150px;">
                                <option value="">Sin asignar</option>
                                {% for emp in employees %}
                                    <option value="{{ emp.id }}" {% if t.assigned_to.id == emp.id %}selected{% endif %}>{{ emp.username }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><small>{{ t.created_at|date:'Y-m-d H:i' }}</small></td>
                        <td>
                            {% if t.image %}
                                <a href="{{ t.image.url }}" target="_blank">
                                    <img src="{{ t.image.url }}" style="height:50px;width:50px;object-fit:cover;border-radius:4px;"/>
                                </a>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'task_detail' t.id %}" class="btn btn-sm btn-outline-primary" title="Ver detalle">
                                <i class="bi bi-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">No hay touch-ups con estos filtros.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav class="mt-4">
        <ul class="pagination pagination-sm justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if filter_assigned %}&assigned={{ filter_assigned }}{% endif %}{% if filter_date_from %}&date_from={{ filter_date_from }}{% endif %}{% if filter_date_to %}&date_to={{ filter_date_to }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            {% endif %}
            
            <li class="page-item active">
                <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
            </li>
            
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if filter_assigned %}&assigned={{ filter_assigned }}{% endif %}{% if filter_date_from %}&date_from={{ filter_date_from }}{% endif %}{% if filter_date_to %}&date_to={{ filter_date_to }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    
    <!-- FAB (Mobile Only) -->
    <a href="{% url 'project_overview' project.id %}" class="fab-create">
        <i class="bi bi-arrow-left"></i>
    </a>
</div>

{% block extra_js %}
<script>
    // Quick filter chips
    function filterBy(param, value) {
        const url = new URL(window.location.href);
        if (value) {
            url.searchParams.set(param, value);
        } else {
            url.searchParams.delete(param);
        }
        url.searchParams.delete('page'); // Reset to page 1
        window.location.href = url.toString();
    }
    
    // Modal for status update (mobile)
    function updateStatus(taskId) {
        const statuses = ['Pendiente', 'En Progreso', 'Completada'];
        const choice = prompt('Selecciona estado:\n1. Pendiente\n2. En Progreso\n3. Completada');
        if (choice && choice >= 1 && choice <= 3) {
            const newStatus = statuses[parseInt(choice) - 1];
            quickUpdate(taskId, 'status', newStatus);
        }
    }
    
    // Modal for assignment (mobile)
    function assignTask(taskId) {
        // Build employees list from DOM
        const assignSelects = document.querySelectorAll('.assign-select');
        if (assignSelects.length === 0) return;
        
        const firstSelect = assignSelects[0];
        const options = Array.from(firstSelect.options).filter(opt => opt.value);
        
        let message = 'Asignar a:\n0. Sin asignar\n';
        options.forEach((opt, idx) => {
            message += `${idx + 1}. ${opt.text}\n`;
        });
        
        const choice = prompt(message);
        if (choice !== null) {
            const employeeId = choice == 0 ? '' : options[parseInt(choice) - 1]?.value || '';
            quickUpdate(taskId, 'assign', employeeId);
        }
    }
    
    // Quick update via AJAX
    function quickUpdate(taskId, action, value) {
        const body = action === 'status' 
            ? `action=status&status=${encodeURIComponent(value)}`
            : `action=assign&employee_id=${value}`;
        
        fetch(`/touchups/quick-update/${taskId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: body
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'No se pudo actualizar'));
            }
        })
        .catch(err => {
            console.error(err);
            alert('Error de conexión');
        });
    }
    
    // Desktop AJAX Updates
    document.addEventListener('DOMContentLoaded', function() {
        // Status updates (desktop)
        document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', function() {
                const taskId = this.dataset.taskId;
                const newStatus = this.value;
                quickUpdate(taskId, 'status', newStatus);
            });
        });

        // Assignment updates (desktop)
        document.querySelectorAll('.assign-select').forEach(select => {
            select.addEventListener('change', function() {
                const taskId = this.dataset.taskId;
                const employeeId = this.value;
                quickUpdate(taskId, 'assign', employeeId);
            });
        });
    });
</script>
{% endblock %}
{% endblock %}
