{% extends "core/base_modern.html" %}
{% load i18n %}
{% load static %}

{% block title %}{{ project.name }} - {% trans "Inventory Management" %}{% endblock %}

{% block extra_head %}
<style>
    /* Prevent horizontal overflow */
    body {
        overflow-x: hidden;
        max-width: 100vw;
    }
    
    /* Wizard Container */
    .wizard-container {
        min-height: calc(100vh - 100px);
        max-width: 100vw;
        overflow-x: hidden;
    }
    
    /* Wizard Steps */
    .wizard-step {
        display: none;
        animation: fadeIn 0.3s ease-in-out;
    }
    
    .wizard-step.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Step Cards Grid */
    .step-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        padding: 1rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    @media (max-width: 768px) {
        .step-cards {
            grid-template-columns: 1fr;
            gap: 1rem;
            padding: 0.5rem;
        }
    }
    
    /* Action Card */
    .step-card {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 2rem 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .step-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }
    
    .step-card:hover {
        border-color: #8b5cf6;
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
        transform: translateY(-5px);
    }
    
    .step-card:hover::before {
        transform: scaleX(1);
    }
    
    .step-card:active {
        transform: translateY(-2px);
    }
    
    .step-card i {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: block;
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .step-card h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }
    
    .step-card p {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0;
    }
    
    /* Special Colors for Different Actions */
    .step-card.add i {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .step-card.add:hover {
        border-color: #10b981;
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.2);
    }
    
    .step-card.move i {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .step-card.move:hover {
        border-color: #3b82f6;
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
    }
    
    .step-card.adjust i {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .step-card.adjust:hover {
        border-color: #f59e0b;
        box-shadow: 0 10px 30px rgba(245, 158, 11, 0.2);
    }
    
    .step-card.history i {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .step-card.history:hover {
        border-color: #6b7280;
        box-shadow: 0 10px 30px rgba(107, 114, 128, 0.2);
    }
    
    .step-card.alerts i {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .step-card.alerts:hover {
        border-color: #ef4444;
        box-shadow: 0 10px 30px rgba(239, 68, 68, 0.2);
    }
    
    .step-card.reports i {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .step-card.reports:hover {
        border-color: #8b5cf6;
        box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
    }
    
    /* Form Container */
    .form-container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    @media (max-width: 768px) {
        .form-container {
            padding: 1.5rem;
            margin: 0 1rem;
        }
    }
    
    /* Form Elements */
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }
    
    /* Buttons */
    .btn-primary {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(139, 92, 246, 0.3);
    }
    
    .btn-primary:active {
        transform: translateY(0);
    }
    
    .btn-secondary {
        background: white;
        color: #6b7280;
        padding: 0.75rem 1.5rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-secondary:hover {
        border-color: #8b5cf6;
        color: #8b5cf6;
    }
    
    /* Progress Indicator */
    .progress-indicator {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1rem;
    }
    
    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }
    
    .progress-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .progress-step.active .progress-circle {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        box-shadow: 0 4px 10px rgba(139, 92, 246, 0.3);
    }
    
    .progress-step.completed .progress-circle {
        background: #10b981;
        color: white;
    }
    
    .progress-label {
        font-size: 0.75rem;
        color: #6b7280;
        font-weight: 500;
    }
    
    .progress-step.active .progress-label {
        color: #8b5cf6;
        font-weight: 600;
    }
    
    .progress-line {
        width: 60px;
        height: 2px;
        background: #e5e7eb;
        margin-top: -1.5rem;
    }
    
    .progress-step.completed ~ .progress-line {
        background: #10b981;
    }
    
    @media (max-width: 768px) {
        .progress-indicator {
            gap: 0.5rem;
        }
        
        .progress-circle {
            width: 32px;
            height: 32px;
            font-size: 0.875rem;
        }
        
        .progress-line {
            width: 40px;
        }
        
        .progress-label {
            font-size: 0.625rem;
        }
    }
    
    /* Stock Table */
    .stock-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    
    .stock-table th,
    .stock-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .stock-table th {
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
    }
    
    .stock-table tr:hover {
        background: #f9fafb;
    }
    
    /* Badge */
    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .badge-success {
        background: #d1fae5;
        color: #065f46;
    }
    
    .badge-warning {
        background: #fef3c7;
        color: #92400e;
    }
    
    .badge-danger {
        background: #fee2e2;
        color: #991b1b;
    }
    
    /* Alert */
    .alert {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .alert-info {
        background: #dbeafe;
        color: #1e40af;
        border-left: 4px solid #3b82f6;
    }
    
    .alert-warning {
        background: #fef3c7;
        color: #92400e;
        border-left: 4px solid #f59e0b;
    }
    
    .alert-success {
        background: #d1fae5;
        color: #065f46;
        border-left: 4px solid #10b981;
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-200 px-3 py-3 sm:px-6 sm:py-4 mb-4 rounded-lg mx-2 sm:mx-4">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
            <div class="flex-1 min-w-0">
                <div class="flex items-center flex-wrap gap-2">
                    <h1 class="text-lg sm:text-xl font-bold text-gray-900 truncate">
                        <i class="bi bi-boxes mr-2"></i>{% trans "Inventory Management" %}
                    </h1>
                </div>
                <p class="text-xs sm:text-sm text-gray-500 mt-1">
                    {{ project.name }}
                    {% if low_stock_count > 0 %}
                        <span class="mx-2">â€¢</span>
                        <span class="text-red-600 font-semibold">
                            <i class="bi bi-exclamation-triangle"></i> {{ low_stock_count }} {% trans "items low on stock" %}
                        </span>
                    {% endif %}
                </p>
            </div>
            <div class="flex flex-wrap gap-2">
                <a href="{% url 'project_overview' project.id %}" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-xs sm:text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none">
                    <i class="bi bi-arrow-left mr-1 sm:mr-2"></i> <span class="hidden sm:inline">{% trans "Back to Project" %}</span><span class="sm:hidden">{% trans "Back" %}</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Progress Indicator (Hidden on Step 1) -->
    <div id="progress-indicator" class="progress-indicator" style="display: none;">
        <div class="progress-step" id="progress-1">
            <div class="progress-circle">1</div>
            <span class="progress-label">{% trans "Action" %}</span>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" id="progress-2">
            <div class="progress-circle">2</div>
            <span class="progress-label">{% trans "Details" %}</span>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step" id="progress-3">
            <div class="progress-circle">3</div>
            <span class="progress-label">{% trans "Confirm" %}</span>
        </div>
    </div>

    <!-- Step 1: Select Action -->
    <div id="step-1" class="wizard-step active">
        <div class="text-center mb-6 px-4">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">{% trans "What would you like to do?" %}</h2>
            <p class="text-gray-600">{% trans "Select an action to manage your inventory" %}</p>
        </div>
        
        <div class="step-cards">
            <!-- Add/Receive Inventory -->
            <div class="step-card add" onclick="selectAction('add')">
                <i class="bi bi-plus-circle"></i>
                <h3>{% trans "Add Inventory" %}</h3>
                <p>{% trans "Receive new items from purchases" %}</p>
            </div>
            
            <!-- Move/Transfer Inventory -->
            <div class="step-card move" onclick="selectAction('move')">
                <i class="bi bi-arrow-left-right"></i>
                <h3>{% trans "Move Inventory" %}</h3>
                <p>{% trans "Transfer items between locations" %}</p>
            </div>
            
            <!-- Adjust Inventory -->
            <div class="step-card adjust" onclick="selectAction('adjust')">
                <i class="bi bi-tools"></i>
                <h3>{% trans "Adjust Stock" %}</h3>
                <p>{% trans "Manual corrections and cycle counts" %}</p>
            </div>
            
            <!-- View History -->
            <div class="step-card history" onclick="window.location.href='{% url 'inventory_history' project.id %}'">
                <i class="bi bi-clock-history"></i>
                <h3>{% trans "View History" %}</h3>
                <p>{% trans "See all inventory movements" %}</p>
            </div>
            
            <!-- Low Stock Alerts -->
            <div class="step-card alerts" onclick="viewLowStock()">
                <i class="bi bi-exclamation-triangle"></i>
                <h3>{% trans "Low Stock Alerts" %}</h3>
                <p>{% trans "Items that need restocking" %}</p>
            </div>
            
            <!-- Reports -->
            <div class="step-card reports" onclick="window.location.href='{% url 'inventory_view' project.id %}'">
                <i class="bi bi-file-bar-graph"></i>
                <h3>{% trans "View All Stock" %}</h3>
                <p>{% trans "Complete inventory overview" %}</p>
            </div>
        </div>
    </div>

    <!-- Step 2: Details Form (Add Inventory) -->
    <div id="step-2-add" class="wizard-step">
        <div class="form-container">
            <h2 class="text-xl font-bold text-gray-900 mb-4">
                <i class="bi bi-plus-circle text-green-600 mr-2"></i>{% trans "Add Inventory" %}
            </h2>
            
            <form method="POST" action="{% url 'inventory_wizard' project.id %}" id="form-add">
                {% csrf_token %}
                <input type="hidden" name="action" value="add">
                
                <div class="form-group">
                    <label for="add-item">{% trans "Item" %} *</label>
                    <select id="add-item" name="item_id" required>
                        <option value="">{% trans "Select an item" %}</option>
                        {% for item in items %}
                            <option value="{{ item.id }}">{{ item.sku }} - {{ item.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="add-quantity">{% trans "Quantity" %} *</label>
                    <input type="number" id="add-quantity" name="quantity" step="0.01" min="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="add-unit-price">{% trans "Unit Price" %}</label>
                    <input type="number" id="add-unit-price" name="unit_price" step="0.01" min="0">
                </div>
                
                <div class="form-group">
                    <label for="add-location">{% trans "Destination Location" %} *</label>
                    <select id="add-location" name="to_location_id" required>
                        <option value="">{% trans "Select location" %}</option>
                        {% for location in locations %}
                            <option value="{{ location.id }}">
                                {{ location.name }}
                                {% if location.is_storage %}({% trans "Storage" %}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="add-reason">{% trans "Reason" %} *</label>
                    <textarea id="add-reason" name="reason" required placeholder="{% trans 'e.g., Purchase Order #12345' %}"></textarea>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button type="button" class="btn-secondary" onclick="backToStep1()">
                        <i class="bi bi-arrow-left"></i> {% trans "Back" %}
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="bi bi-check-circle"></i> {% trans "Add Inventory" %}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Step 2: Details Form (Move Inventory) -->
    <div id="step-2-move" class="wizard-step">
        <div class="form-container">
            <h2 class="text-xl font-bold text-gray-900 mb-4">
                <i class="bi bi-arrow-left-right text-blue-600 mr-2"></i>{% trans "Move Inventory" %}
            </h2>
            
            <form method="POST" action="{% url 'inventory_wizard' project.id %}" id="form-move">
                {% csrf_token %}
                <input type="hidden" name="action" value="move">
                
                <div class="form-group">
                    <label for="move-item">{% trans "Item" %} *</label>
                    <select id="move-item" name="item_id" required onchange="updateAvailableStock(this, 'move')">
                        <option value="">{% trans "Select an item" %}</option>
                        {% for item in items %}
                            <option value="{{ item.id }}">{{ item.sku }} - {{ item.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="move-from-location">{% trans "From Location" %} *</label>
                    <select id="move-from-location" name="from_location_id" required onchange="updateAvailableStock(null, 'move')">
                        <option value="">{% trans "Select source location" %}</option>
                        {% for location in locations %}
                            <option value="{{ location.id }}">
                                {{ location.name }}
                                {% if location.is_storage %}({% trans "Storage" %}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="move-available-stock" class="alert alert-info" style="display: none;">
                    <i class="bi bi-info-circle mr-2"></i>
                    <span id="move-available-text"></span>
                </div>
                
                <div class="form-group">
                    <label for="move-quantity">{% trans "Quantity" %} *</label>
                    <input type="number" id="move-quantity" name="quantity" step="0.01" min="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="move-to-location">{% trans "To Location" %} *</label>
                    <select id="move-to-location" name="to_location_id" required>
                        <option value="">{% trans "Select destination location" %}</option>
                        {% for location in locations %}
                            <option value="{{ location.id }}">
                                {{ location.name }}
                                {% if location.is_storage %}({% trans "Storage" %}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="move-reason">{% trans "Reason" %} *</label>
                    <textarea id="move-reason" name="reason" required placeholder="{% trans 'e.g., Project material delivery' %}"></textarea>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button type="button" class="btn-secondary" onclick="backToStep1()">
                        <i class="bi bi-arrow-left"></i> {% trans "Back" %}
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="bi bi-check-circle"></i> {% trans "Move Inventory" %}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Step 2: Details Form (Adjust Stock) -->
    <div id="step-2-adjust" class="wizard-step">
        <div class="form-container">
            <h2 class="text-xl font-bold text-gray-900 mb-4">
                <i class="bi bi-tools text-amber-600 mr-2"></i>{% trans "Adjust Stock" %}
            </h2>
            
            <div class="alert alert-warning mb-4">
                <i class="bi bi-exclamation-triangle mr-2"></i>
                {% trans "Stock adjustments are used for manual corrections and cycle counts. Use positive numbers to increase stock, negative to decrease." %}
            </div>
            
            <form method="POST" action="{% url 'inventory_wizard' project.id %}" id="form-adjust">
                {% csrf_token %}
                <input type="hidden" name="action" value="adjust">
                
                <div class="form-group">
                    <label for="adjust-item">{% trans "Item" %} *</label>
                    <select id="adjust-item" name="item_id" required onchange="updateCurrentStock(this, 'adjust')">
                        <option value="">{% trans "Select an item" %}</option>
                        {% for item in items %}
                            <option value="{{ item.id }}">{{ item.sku }} - {{ item.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="adjust-location">{% trans "Location" %} *</label>
                    <select id="adjust-location" name="to_location_id" required onchange="updateCurrentStock(null, 'adjust')">
                        <option value="">{% trans "Select location" %}</option>
                        {% for location in locations %}
                            <option value="{{ location.id }}">
                                {{ location.name }}
                                {% if location.is_storage %}({% trans "Storage" %}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="adjust-current-stock" class="alert alert-info" style="display: none;">
                    <i class="bi bi-info-circle mr-2"></i>
                    <span id="adjust-current-text"></span>
                </div>
                
                <div class="form-group">
                    <label for="adjust-quantity">{% trans "Adjustment Quantity" %} *</label>
                    <input type="number" id="adjust-quantity" name="quantity" step="0.01" required placeholder="{% trans 'Positive to add, negative to remove' %}">
                    <small class="text-gray-600">{% trans "Example: +5 to add 5 units, -3 to remove 3 units" %}</small>
                </div>
                
                <div class="form-group">
                    <label for="adjust-reason">{% trans "Reason" %} *</label>
                    <textarea id="adjust-reason" name="reason" required placeholder="{% trans 'e.g., Cycle count correction - physical count was 18' %}"></textarea>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button type="button" class="btn-secondary" onclick="backToStep1()">
                        <i class="bi bi-arrow-left"></i> {% trans "Back" %}
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="bi bi-check-circle"></i> {% trans "Adjust Stock" %}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Low Stock View (Modal/Overlay) -->
    <div id="low-stock-view" class="wizard-step">
        <div class="form-container" style="max-width: 800px;">
            <h2 class="text-xl font-bold text-gray-900 mb-4">
                <i class="bi bi-exclamation-triangle text-red-600 mr-2"></i>{% trans "Low Stock Alerts" %}
            </h2>
            
            {% if low_stock_items %}
                <div class="alert alert-warning mb-4">
                    <i class="bi bi-info-circle mr-2"></i>
                    {% trans "The following items are below their threshold levels and need restocking:" %}
                </div>
                
                <table class="stock-table">
                    <thead>
                        <tr>
                            <th>{% trans "Item" %}</th>
                            <th>{% trans "Location" %}</th>
                            <th>{% trans "Current" %}</th>
                            <th>{% trans "Threshold" %}</th>
                            <th>{% trans "Status" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stock in low_stock_items %}
                        <tr>
                            <td>
                                <div class="font-medium text-gray-900">{{ stock.item.name }}</div>
                                <div class="text-xs text-gray-500">{{ stock.item.sku }}</div>
                            </td>
                            <td>{{ stock.location.name }}</td>
                            <td>
                                <span class="font-semibold text-red-600">
                                    {{ stock.quantity }} {{ stock.item.unit }}
                                </span>
                            </td>
                            <td>{{ stock.threshold }} {{ stock.item.unit }}</td>
                            <td>
                                <span class="badge badge-danger">
                                    <i class="bi bi-arrow-down mr-1"></i>{% trans "Low Stock" %}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle mr-2"></i>
                    {% trans "All items are adequately stocked!" %}
                </div>
            {% endif %}
            
            <div class="flex gap-3 mt-6">
                <button type="button" class="btn-secondary" onclick="backToStep1()">
                    <i class="bi bi-arrow-left"></i> {% trans "Back" %}
                </button>
                {% if low_stock_items %}
                    <button type="button" class="btn-primary" onclick="selectAction('add')">
                        <i class="bi bi-plus-circle"></i> {% trans "Add Inventory" %}
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
let currentAction = null;
let stockData = {{ stock_data_json|safe }};

function selectAction(action) {
    currentAction = action;
    
    // Hide step 1
    document.getElementById('step-1').classList.remove('active');
    
    // Show progress indicator
    document.getElementById('progress-indicator').style.display = 'flex';
    
    // Update progress
    updateProgress(2);
    
    // Show corresponding form
    if (action === 'add') {
        document.getElementById('step-2-add').classList.add('active');
    } else if (action === 'move') {
        document.getElementById('step-2-move').classList.add('active');
    } else if (action === 'adjust') {
        document.getElementById('step-2-adjust').classList.add('active');
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function backToStep1() {
    // Hide all steps
    document.querySelectorAll('.wizard-step').forEach(step => {
        step.classList.remove('active');
    });
    
    // Show step 1
    document.getElementById('step-1').classList.add('active');
    
    // Hide progress indicator
    document.getElementById('progress-indicator').style.display = 'none';
    
    // Reset progress
    updateProgress(1);
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateProgress(step) {
    // Reset all steps
    document.querySelectorAll('.progress-step').forEach(s => {
        s.classList.remove('active', 'completed');
    });
    
    // Mark completed steps
    for (let i = 1; i < step; i++) {
        document.getElementById(`progress-${i}`).classList.add('completed');
    }
    
    // Mark active step
    document.getElementById(`progress-${step}`).classList.add('active');
}

function viewLowStock() {
    // Hide step 1
    document.getElementById('step-1').classList.remove('active');
    
    // Show low stock view
    document.getElementById('low-stock-view').classList.add('active');
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateAvailableStock(selectElement, formType) {
    const itemSelect = document.getElementById(`${formType}-item`);
    const locationSelect = document.getElementById(`${formType}-from-location`);
    const alertDiv = document.getElementById(`${formType}-available-stock`);
    const textSpan = document.getElementById(`${formType}-available-text`);
    
    const itemId = itemSelect.value;
    const locationId = locationSelect.value;
    
    if (itemId && locationId) {
        // Find stock data
        const key = `${itemId}-${locationId}`;
        const stock = stockData[key];
        
        if (stock && stock.quantity !== undefined) {
            const itemName = itemSelect.options[itemSelect.selectedIndex].text.split(' - ')[1];
            textSpan.textContent = `{% trans "Available:" %} ${stock.quantity} ${stock.unit} {% trans "of" %} ${itemName}`;
            alertDiv.style.display = 'block';
            
            // Update max quantity
            document.getElementById(`${formType}-quantity`).setAttribute('max', stock.quantity);
        } else {
            textSpan.textContent = `{% trans "No stock available at this location" %}`;
            alertDiv.style.display = 'block';
            alertDiv.classList.remove('alert-info');
            alertDiv.classList.add('alert-warning');
        }
    } else {
        alertDiv.style.display = 'none';
    }
}

function updateCurrentStock(selectElement, formType) {
    const itemSelect = document.getElementById(`${formType}-item`);
    const locationSelect = document.getElementById(`${formType}-location`);
    const alertDiv = document.getElementById(`${formType}-current-stock`);
    const textSpan = document.getElementById(`${formType}-current-text`);
    
    const itemId = itemSelect.value;
    const locationId = locationSelect.value;
    
    if (itemId && locationId) {
        // Find stock data
        const key = `${itemId}-${locationId}`;
        const stock = stockData[key];
        
        if (stock && stock.quantity !== undefined) {
            const itemName = itemSelect.options[itemSelect.selectedIndex].text.split(' - ')[1];
            textSpan.textContent = `{% trans "Current stock:" %} ${stock.quantity} ${stock.unit} {% trans "of" %} ${itemName}`;
            alertDiv.style.display = 'block';
        } else {
            textSpan.textContent = `{% trans "No stock record found. This will create a new stock entry." %}`;
            alertDiv.style.display = 'block';
        }
    } else {
        alertDiv.style.display = 'none';
    }
}

// Form validation
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
        const quantityInput = this.querySelector('[name="quantity"]');
        const quantity = parseFloat(quantityInput.value);
        
        if (isNaN(quantity)) {
            e.preventDefault();
            alert('{% trans "Please enter a valid quantity" %}');
            return false;
        }
        
        // For move action, check if quantity is available
        if (this.id === 'form-move') {
            const max = parseFloat(quantityInput.getAttribute('max'));
            if (max && quantity > max) {
                e.preventDefault();
                alert(`{% trans "Insufficient stock. Maximum available:" %} ${max}`);
                return false;
            }
        }
        
        // For adjust action, warn about negative adjustments
        if (this.id === 'form-adjust' && quantity < 0) {
            if (!confirm(`{% trans "You are about to decrease stock by" %} ${Math.abs(quantity)} {% trans "units. Are you sure?" %}`)) {
                e.preventDefault();
                return false;
            }
        }
    });
});
</script>
{% endblock %}
