{% extends "core/base_modern.html" %}
{% load i18n static humanize %}

{% block title %}{% trans "Financials" %} - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
/* ========================================
   FINANCIAL HUB - PREMIUM DESIGN
   ======================================== */

.financials-wrapper {
    min-height: 100vh;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    padding: 2rem;
}

/* Header */
.financials-header {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 16px;
    padding: 2rem;
    color: white;
    margin-bottom: 2rem;
    box-shadow: 0 10px 40px rgba(30, 41, 59, 0.3);
}

.financials-header .btn-back {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255,255,255,0.7);
    text-decoration: none;
    font-size: 0.9rem;
    margin-bottom: 1rem;
    transition: color 0.2s;
}

.financials-header .btn-back:hover {
    color: white;
}

.financials-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.financials-header .project-name {
    color: rgba(255,255,255,0.7);
    font-size: 1rem;
}

/* Budget Summary Cards */
.budget-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.summary-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border-left: 4px solid;
    transition: transform 0.2s, box-shadow 0.2s;
}

.summary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.summary-card.total-budget { border-color: #3b82f6; }
.summary-card.budget-line { border-color: #10b981; }
.summary-card.spent { border-color: #f59e0b; }
.summary-card.remaining { border-color: #8b5cf6; }
.summary-card.margin { border-color: #ec4899; }

.summary-card .card-label {
    font-size: 0.85rem;
    color: #64748b;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.summary-card .card-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1e293b;
}

.summary-card .card-subtext {
    font-size: 0.8rem;
    color: #94a3b8;
    margin-top: 0.25rem;
}

/* Navigation Tabs */
.financial-nav {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
}

.nav-tab {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    color: #64748b;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.nav-tab:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
    color: #334155;
}

.nav-tab.active {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    border-color: transparent;
    color: white;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.nav-tab i {
    font-size: 1.1rem;
}

/* Main Content Area */
.financial-content {
    background: white;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    overflow: hidden;
}

.content-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.content-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-action {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-action:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

.btn-action.secondary {
    background: white;
    border: 1px solid #e2e8f0;
    color: #64748b;
}

.btn-action.secondary:hover {
    background: #f8fafc;
    color: #334155;
    box-shadow: none;
}

/* Table Styles */
.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead {
    background: #f8fafc;
}

.data-table th {
    padding: 1rem 1.25rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.75rem;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid #e2e8f0;
}

.data-table td {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #f1f5f9;
    font-size: 0.9rem;
    color: #334155;
}

.data-table tr:hover {
    background: #fafbfc;
}

.data-table .text-right {
    text-align: right;
}

.data-table .code-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    background: #f1f5f9;
    border-radius: 6px;
    font-family: 'SF Mono', 'Monaco', monospace;
    font-size: 0.85rem;
    font-weight: 500;
    color: #475569;
}

.data-table .amount {
    font-weight: 600;
    font-family: 'SF Mono', 'Monaco', monospace;
}

.data-table .amount.positive { color: #10b981; }
.data-table .amount.negative { color: #ef4444; }
.data-table .amount.warning { color: #f59e0b; }

/* Progress Bar */
.progress-bar-container {
    width: 100%;
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s;
}

.progress-bar-fill.good { background: linear-gradient(90deg, #10b981, #059669); }
.progress-bar-fill.warning { background: linear-gradient(90deg, #f59e0b, #d97706); }
.progress-bar-fill.danger { background: linear-gradient(90deg, #ef4444, #dc2626); }

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #64748b;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h3 {
    font-size: 1.25rem;
    color: #334155;
    margin-bottom: 0.5rem;
}

.empty-state p {
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
}

/* Info Box for PM */
.info-box {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 1px solid #fbbf24;
    border-radius: 10px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

.info-box.green {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    border-color: #34d399;
}

.info-box i {
    font-size: 1.25rem;
    color: #92400e;
    flex-shrink: 0;
}

.info-box.green i {
    color: #065f46;
}

.info-box-content {
    flex: 1;
}

.info-box-content strong {
    display: block;
    font-size: 0.9rem;
    color: #92400e;
    margin-bottom: 0.25rem;
}

.info-box.green .info-box-content strong {
    color: #065f46;
}

.info-box-content p {
    font-size: 0.85rem;
    color: #78350f;
    margin: 0;
}

.info-box.green .info-box-content p {
    color: #064e3b;
}

/* Status Badges */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.625rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-badge.approved {
    background: #d1fae5;
    color: #065f46;
}

.status-badge.pending {
    background: #fef3c7;
    color: #92400e;
}

.status-badge.draft {
    background: #e2e8f0;
    color: #475569;
}

/* Responsive */
@media (max-width: 768px) {
    .financials-wrapper {
        padding: 1rem;
    }
    
    .budget-summary {
        grid-template-columns: 1fr 1fr;
    }
    
    .summary-card .card-value {
        font-size: 1.25rem;
    }
    
    .financial-nav {
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 0.5rem;
    }
    
    .nav-tab {
        white-space: nowrap;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="financials-wrapper">
    <!-- Header -->
    <div class="financials-header">
        <a href="{% url 'project_overview' project.id %}" class="btn-back">
            <i class="bi bi-arrow-left"></i> {% trans "Back to Project" %}
        </a>
        <h1><i class="bi bi-currency-dollar"></i> {% trans "Financial Overview" %}</h1>
        <p class="project-name">{{ project.name }}</p>
    </div>

    <!-- Budget Summary Cards -->
    <div class="budget-summary">
        <div class="summary-card total-budget">
            <div class="card-label">
                <i class="bi bi-wallet2"></i> {% trans "Total Budget" %}
            </div>
            <div class="card-value">${{ total_budget|intcomma }}</div>
            <div class="card-subtext">{% trans "Approved estimate + COs" %}</div>
        </div>
        
        {% if not user.is_superuser and is_pm %}
        <div class="summary-card budget-line">
            <div class="card-label">
                <i class="bi bi-bar-chart"></i> {% trans "Working Budget" %}
            </div>
            <div class="card-value">${{ working_budget|intcomma }}</div>
            <div class="card-subtext">{% trans "Your target (-30%)" %}</div>
        </div>
        {% endif %}
        
        <div class="summary-card spent">
            <div class="card-label">
                <i class="bi bi-credit-card"></i> {% trans "Spent" %}
            </div>
            <div class="card-value">${{ total_spent|intcomma }}</div>
            <div class="card-subtext">{{ spent_percentage }}% {% trans "of budget" %}</div>
        </div>
        
        <div class="summary-card remaining">
            <div class="card-label">
                <i class="bi bi-piggy-bank"></i> {% trans "Remaining" %}
            </div>
            <div class="card-value {% if remaining < 0 %}text-danger{% endif %}">${{ remaining|intcomma }}</div>
            <div class="card-subtext">{% trans "Available to spend" %}</div>
        </div>
        
        {% if user.is_superuser or user.is_staff %}
        <div class="summary-card margin">
            <div class="card-label">
                <i class="bi bi-percent"></i> {% trans "Margin" %}
            </div>
            <div class="card-value">{{ margin_percentage }}%</div>
            <div class="card-subtext">{% trans "Projected profit" %}</div>
        </div>
        {% endif %}
    </div>

    <!-- Info Box for PM (non-admin) -->
    {% if is_pm and not user.is_superuser %}
    <div class="info-box">
        <i class="bi bi-info-circle-fill"></i>
        <div class="info-box-content">
            <strong>{% trans "Working Budget Mode" %}</strong>
            <p>{% trans "You're seeing a reduced budget (-30%) to maintain project margin. Stay within this target for optimal results." %}</p>
        </div>
    </div>
    {% endif %}

    <!-- Navigation Tabs -->
    <div class="financial-nav">
        <a href="{% url 'project_financials_hub' project.id %}" class="nav-tab {% if active_tab == 'overview' %}active{% endif %}">
            <i class="bi bi-grid"></i> {% trans "Overview" %}
        </a>
        <a href="{% url 'project_budget_detail' project.id %}" class="nav-tab {% if active_tab == 'budget' %}active{% endif %}">
            <i class="bi bi-wallet2"></i> {% trans "Budget" %}
        </a>
        <a href="{% url 'project_cost_codes' project.id %}" class="nav-tab {% if active_tab == 'costcodes' %}active{% endif %}">
            <i class="bi bi-tags"></i> {% trans "Cost Codes" %}
        </a>
        <a href="{% url 'project_estimates' project.id %}" class="nav-tab {% if active_tab == 'estimates' %}active{% endif %}">
            <i class="bi bi-calculator"></i> {% trans "Estimates" %}
        </a>
        {% if user.is_staff or user.is_superuser %}
        <a href="{% url 'project_invoices' project.id %}" class="nav-tab {% if active_tab == 'invoices' %}active{% endif %}">
            <i class="bi bi-receipt"></i> {% trans "Invoices" %}
        </a>
        {% endif %}
    </div>

    <!-- Main Content -->
    <div class="financial-content">
        <div class="content-header">
            <h2><i class="bi bi-graph-up"></i> {% trans "Budget Breakdown by Cost Code" %}</h2>
            {% if user.is_staff or user.is_superuser %}
            <a href="{% url 'project_budget_detail' project.id %}" class="btn-action">
                <i class="bi bi-pencil"></i> {% trans "Edit Budget" %}
            </a>
            {% endif %}
        </div>
        
        {% if budget_lines %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>{% trans "Cost Code" %}</th>
                    <th>{% trans "Description" %}</th>
                    <th class="text-right">{% trans "Budget" %}</th>
                    <th class="text-right">{% trans "Spent" %}</th>
                    <th class="text-right">{% trans "Remaining" %}</th>
                    <th style="width: 150px;">{% trans "Progress" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for line in budget_lines %}
                <tr>
                    <td>
                        <span class="code-badge">
                            <i class="bi bi-tag"></i>
                            {{ line.cost_code.code }}
                        </span>
                    </td>
                    <td>{{ line.description|default:line.cost_code.name }}</td>
                    <td class="text-right">
                        <span class="amount">${{ line.display_budget|intcomma }}</span>
                    </td>
                    <td class="text-right">
                        <span class="amount">${{ line.spent|intcomma }}</span>
                    </td>
                    <td class="text-right">
                        <span class="amount {% if line.remaining < 0 %}negative{% elif line.remaining_pct < 20 %}warning{% else %}positive{% endif %}">
                            ${{ line.remaining|intcomma }}
                        </span>
                    </td>
                    <td>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill {% if line.spent_pct > 100 %}danger{% elif line.spent_pct > 80 %}warning{% else %}good{% endif %}" 
                                 style="width: {% if line.spent_pct > 100 %}100{% else %}{{ line.spent_pct }}{% endif %}%;">
                            </div>
                        </div>
                        <small class="text-muted">{{ line.spent_pct|floatformat:0 }}%</small>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-folder-x"></i>
            <h3>{% trans "No Budget Lines Yet" %}</h3>
            <p>{% trans "Start by creating an estimate or adding budget lines to track costs." %}</p>
            {% if user.is_staff or user.is_superuser %}
            <a href="{% url 'project_budget_detail' project.id %}" class="btn-action">
                <i class="bi bi-plus-lg"></i> {% trans "Add Budget Lines" %}
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
