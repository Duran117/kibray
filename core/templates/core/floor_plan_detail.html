{% extends "core/base_modern.html" %}
{% load static %}
{% load i18n %}
{% load core_extras %}

{% block title %}{{ plan.name }} - Floor Plan{% endblock %}

{% block extra_css %}
<style>
:root{--fp-primary:#3b82f6;--fp-primary-dark:#2563eb;--fp-success:#10b981;--fp-warning:#f59e0b;--fp-danger:#ef4444;--fp-purple:#8b5cf6}
.fp-container{display:grid;grid-template-columns:1fr 360px;gap:1rem;min-height:80vh}
@media(max-width:1200px){.fp-container{grid-template-columns:1fr}}
.fp-header{background:linear-gradient(135deg,var(--fp-primary),var(--fp-primary-dark));border-radius:1rem;padding:1.25rem 1.5rem;color:white;margin-bottom:1rem}
.fp-header h1{font-size:1.35rem;font-weight:700;margin:0}
.fp-header-meta{display:flex;gap:1rem;margin-top:0.5rem;font-size:0.85rem;opacity:0.9}
.fp-canvas-card{background:white;border-radius:1rem;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
.fp-canvas-toolbar{display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;border-bottom:1px solid #e2e8f0;background:#f8fafc;flex-wrap:wrap;gap:0.5rem}
.fp-mode-group{display:flex;gap:0.25rem;background:#e2e8f0;padding:0.25rem;border-radius:0.5rem}
.fp-mode-btn{padding:0.5rem 1rem;border:none;background:transparent;border-radius:0.375rem;font-size:0.8rem;font-weight:600;color:#64748b;cursor:pointer;display:flex;align-items:center;gap:0.375rem;transition:all 0.2s}
.fp-mode-btn:hover{color:#1e293b}
.fp-mode-btn.active{background:white;color:var(--fp-primary);box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.fp-zoom-group{display:flex;align-items:center;gap:0.5rem}
.fp-zoom-btn{width:32px;height:32px;border:1px solid #d1d5db;border-radius:0.375rem;background:white;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fp-zoom-btn:hover{background:#f1f5f9}
.fp-zoom-level{font-size:0.75rem;font-weight:600;color:#64748b;min-width:45px;text-align:center}
.fp-canvas-wrapper{position:relative;background:#1e293b;overflow:auto;height:60vh;cursor:grab}
.fp-canvas-wrapper.grabbing{cursor:grabbing}
.fp-canvas-wrapper.crosshair{cursor:crosshair}
.fp-canvas-content{display:inline-block;position:relative;transform-origin:top left}
.fp-canvas-content img{display:block;max-width:none;user-select:none;-webkit-user-drag:none}
.fp-pins-layer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
.fp-pin{position:absolute;transform:translate(-50%,-100%);pointer-events:auto;cursor:pointer;z-index:10;transition:transform 0.2s}
.fp-pin:hover{transform:translate(-50%,-100%) scale(1.15);z-index:20}
.fp-pin.selected{transform:translate(-50%,-100%) scale(1.2);z-index:25}
.fp-pin-marker{width:28px;height:28px;border-radius:50% 50% 50% 0;transform:rotate(-45deg);display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:2px solid white}
.fp-pin-marker i{transform:rotate(45deg);color:white;font-size:0.7rem}
.fp-pin-marker.note{background:#3b82f6}
.fp-pin-marker.touchup{background:#10b981}
.fp-pin-marker.color{background:#8b5cf6}
.fp-pin-marker.alert{background:#f59e0b}
.fp-pin-marker.damage{background:#ef4444}
.fp-paths-svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
.fp-draw-point{position:absolute;width:10px;height:10px;background:white;border:2px solid var(--fp-primary);border-radius:50%;transform:translate(-50%,-50%)}
.fp-sidebar{display:flex;flex-direction:column;gap:1rem}
.fp-sidebar-card{background:white;border-radius:1rem;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
.fp-sidebar-header{padding:1rem 1.25rem;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
.fp-sidebar-header h3{font-size:0.95rem;font-weight:600;margin:0;display:flex;align-items:center;gap:0.5rem}
.fp-filter-tabs{display:flex;gap:0.25rem;padding:0.75rem 1rem;background:#f8fafc;border-bottom:1px solid #e2e8f0;overflow-x:auto}
.fp-filter-tab{padding:0.375rem 0.75rem;border:none;background:transparent;border-radius:0.375rem;font-size:0.75rem;font-weight:600;color:#64748b;cursor:pointer;white-space:nowrap}
.fp-filter-tab:hover{background:white}
.fp-filter-tab.active{background:white;color:var(--fp-primary);box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.fp-pin-list{max-height:40vh;overflow-y:auto;padding:0.75rem}
.fp-pin-item{display:flex;align-items:flex-start;gap:0.75rem;padding:0.75rem;border-radius:0.5rem;cursor:pointer;margin-bottom:0.5rem}
.fp-pin-item:hover{background:#f1f5f9}
.fp-pin-item.selected{background:#eff6ff;border:1px solid #bfdbfe}
.fp-pin-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:0.3rem}
.fp-pin-dot.note{background:#3b82f6}
.fp-pin-dot.touchup{background:#10b981}
.fp-pin-dot.color{background:#8b5cf6}
.fp-pin-dot.alert{background:#f59e0b}
.fp-pin-dot.damage{background:#ef4444}
.fp-pin-info{flex:1;min-width:0}
.fp-pin-title{font-weight:600;font-size:0.85rem;color:#1e293b;margin-bottom:0.125rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fp-pin-desc{font-size:0.75rem;color:#64748b;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.fp-pin-badge{font-size:0.65rem;padding:0.15rem 0.4rem;border-radius:0.25rem;font-weight:600;background:#f1f5f9;color:#64748b}
.fp-empty{text-align:center;padding:2rem 1rem;color:#94a3b8}
.fp-empty i{font-size:2.5rem;margin-bottom:0.75rem;opacity:0.5}
.fp-pending-section{background:#fef3c7;border-radius:0.75rem;padding:1rem;margin:0.75rem}
.fp-pending-title{font-size:0.8rem;font-weight:600;color:#b45309;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem}
.fp-pending-item{background:white;padding:0.75rem;border-radius:0.5rem;margin-bottom:0.5rem}
.fp-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s}
.fp-modal-overlay.active{opacity:1;visibility:visible}
.fp-modal{background:white;border-radius:1rem;width:90%;max-width:480px;max-height:90vh;overflow:hidden;transform:translateY(20px);transition:transform 0.3s}
.fp-modal-lg{max-width:700px}
.fp-modal-overlay.active .fp-modal{transform:translateY(0)}
.fp-modal-header{padding:1rem 1.5rem;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}
.fp-modal-header h3{font-size:1.1rem;font-weight:600;margin:0}
.fp-modal-close{width:32px;height:32px;border:none;background:#f1f5f9;border-radius:0.375rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
.fp-modal-body{padding:1.5rem;max-height:60vh;overflow-y:auto}
.fp-modal-footer{padding:1rem 1.5rem;border-top:1px solid #e2e8f0;display:flex;gap:0.75rem;justify-content:flex-end}
.fp-field{margin-bottom:1rem}
.fp-field label{display:block;font-size:0.8rem;font-weight:600;color:#374151;margin-bottom:0.375rem}
.fp-field input,.fp-field textarea,.fp-field select{width:100%;padding:0.625rem 0.75rem;border:1px solid #d1d5db;border-radius:0.5rem;font-size:0.9rem}
.fp-field input:focus,.fp-field textarea:focus{outline:none;border-color:var(--fp-primary);box-shadow:0 0 0 3px rgba(59,130,246,0.15)}
.fp-type-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:0.5rem;margin-bottom:1rem}
.fp-type-btn{padding:0.5rem;border:2px solid #e2e8f0;border-radius:0.5rem;background:white;cursor:pointer;text-align:center}
.fp-type-btn:hover{border-color:#94a3b8}
.fp-type-btn i{display:block;font-size:1.25rem;margin-bottom:0.125rem}
.fp-type-btn.note i{color:#3b82f6}.fp-type-btn.touchup i{color:#10b981}.fp-type-btn.color i{color:#8b5cf6}.fp-type-btn.alert i{color:#f59e0b}.fp-type-btn.damage i{color:#ef4444}
.fp-type-btn span{font-size:0.6rem;font-weight:600;text-transform:uppercase}
.fp-type-btn.note.selected{border-color:#3b82f6;background:#eff6ff}
.fp-type-btn.touchup.selected{border-color:#10b981;background:#ecfdf5}
.fp-type-btn.color.selected{border-color:#8b5cf6;background:#f5f3ff}
.fp-type-btn.alert.selected{border-color:#f59e0b;background:#fffbeb}
.fp-type-btn.damage.selected{border-color:#ef4444;background:#fef2f2}
.fp-color-picker{display:flex;gap:0.5rem;flex-wrap:wrap}
.fp-color-swatch{width:28px;height:28px;border-radius:50%;cursor:pointer;border:3px solid transparent}
.fp-color-swatch:hover{transform:scale(1.1)}
.fp-color-swatch.selected{border-color:#1e293b}
.fp-btn{padding:0.625rem 1.25rem;border-radius:0.5rem;font-weight:600;font-size:0.875rem;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:0.5rem}
.fp-btn-primary{background:var(--fp-primary);color:white}
.fp-btn-primary:hover{background:var(--fp-primary-dark)}
.fp-btn-secondary{background:white;color:#374151;border:1px solid #d1d5db}
.fp-btn-secondary:hover{background:#f9fafb}
.fp-btn-success{background:var(--fp-success);color:white}
.fp-btn-danger{background:var(--fp-danger);color:white}
.fp-btn-sm{padding:0.375rem 0.75rem;font-size:0.75rem}
.fp-mobile-toggle{display:none;position:fixed;bottom:1rem;right:1rem;z-index:100}
@media(max-width:1200px){
.fp-mobile-toggle{display:block}
.fp-sidebar{position:fixed;top:0;right:-100%;width:85%;max-width:360px;height:100vh;background:#f8fafc;z-index:200;transition:right 0.3s;padding:1rem;overflow-y:auto}
.fp-sidebar.open{right:0}
.fp-sidebar-backdrop{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:150}
.fp-sidebar.open + .fp-sidebar-backdrop{display:block}
}
.fp-tooltip{position:absolute;background:#1e293b;color:white;padding:0.5rem 0.75rem;border-radius:0.375rem;font-size:0.75rem;white-space:nowrap;z-index:30;pointer-events:none;transform:translate(-50%,-100%);margin-top:-0.5rem;opacity:0}
.fp-pin:hover .fp-tooltip{opacity:1}
/* Detail Modal Styles */
.fp-detail-header{display:flex;align-items:flex-start;gap:1rem;margin-bottom:1.5rem}
.fp-detail-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:white}
.fp-detail-icon.note{background:#3b82f6}
.fp-detail-icon.touchup{background:#10b981}
.fp-detail-icon.color{background:#8b5cf6}
.fp-detail-icon.alert{background:#f59e0b}
.fp-detail-icon.damage{background:#ef4444}
.fp-detail-title{flex:1}
.fp-detail-title h4{font-size:1.1rem;font-weight:700;margin:0 0 0.25rem 0}
.fp-detail-title .fp-detail-type{font-size:0.75rem;font-weight:600;text-transform:uppercase;padding:0.2rem 0.5rem;border-radius:0.25rem;display:inline-block}
.fp-detail-type.note{background:#eff6ff;color:#2563eb}
.fp-detail-type.touchup{background:#ecfdf5;color:#059669}
.fp-detail-type.color{background:#f5f3ff;color:#7c3aed}
.fp-detail-type.alert{background:#fffbeb;color:#d97706}
.fp-detail-type.damage{background:#fef2f2;color:#dc2626}
.fp-detail-section{margin-bottom:1.25rem}
.fp-detail-section-title{font-size:0.75rem;font-weight:600;color:#64748b;text-transform:uppercase;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.5rem}
.fp-detail-description{color:#374151;line-height:1.6;font-size:0.9rem}
.fp-detail-color-box{display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:#f8fafc;border-radius:0.5rem}
.fp-detail-color-sample{width:40px;height:40px;border-radius:8px;border:2px solid #e2e8f0}
.fp-detail-color-info{flex:1}
.fp-detail-color-name{font-weight:600;font-size:0.9rem}
.fp-detail-color-code{font-size:0.75rem;color:#64748b;font-family:monospace}
.fp-detail-photos{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:0.75rem}
.fp-detail-photo{aspect-ratio:1;border-radius:0.5rem;overflow:hidden;cursor:pointer;position:relative}
.fp-detail-photo img{width:100%;height:100%;object-fit:cover}
.fp-detail-photo:hover::after{content:'';position:absolute;inset:0;background:rgba(0,0,0,0.3)}
.fp-detail-meta{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem}
.fp-detail-meta-item{padding:0.75rem;background:#f8fafc;border-radius:0.5rem}
.fp-detail-meta-label{font-size:0.7rem;color:#64748b;text-transform:uppercase;font-weight:600}
.fp-detail-meta-value{font-size:0.9rem;font-weight:500;color:#1e293b;margin-top:0.125rem}
.fp-detail-comments{margin-top:1rem}
.fp-comment{padding:0.75rem;background:#f8fafc;border-radius:0.5rem;margin-bottom:0.5rem}
.fp-comment-header{display:flex;justify-content:space-between;margin-bottom:0.25rem}
.fp-comment-user{font-weight:600;font-size:0.85rem;color:#1e293b}
.fp-comment-date{font-size:0.7rem;color:#64748b}
.fp-comment-text{font-size:0.85rem;color:#374151}
.fp-no-data{color:#94a3b8;font-style:italic;font-size:0.85rem}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <nav aria-label="breadcrumb" class="mb-2">
    <ol class="breadcrumb small">
      <li class="breadcrumb-item"><a href="{% url 'project_overview' project.id %}" class="text-decoration-none">{{ project.name }}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'floor_plan_list' project.id %}" class="text-decoration-none">Floor Plans</a></li>
      <li class="breadcrumb-item active">{{ plan.name }}</li>
    </ol>
  </nav>

  <div class="fp-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div>
        <h1><i class="bi bi-layers me-2"></i>{{ plan.name }}</h1>
        <div class="fp-header-meta">
          <span><i class="bi bi-building me-1"></i> Level {{ plan.level|default:"N/A" }}</span>
          <span><i class="bi bi-pin-map me-1"></i> {{ pins|length }} pins</span>
          {% if plan.version %}<span><i class="bi bi-clock-history me-1"></i> v{{ plan.version }}</span>{% endif %}
        </div>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'floor_plan_touchup_view' plan.id %}" class="btn btn-light btn-sm"><i class="bi bi-brush me-1"></i> Touch-ups & Tasks</a>
        <a href="{% url 'floor_plan_edit' plan.id %}" class="btn btn-light btn-sm"><i class="bi bi-pencil me-1"></i> Edit</a>
      </div>
    </div>
  </div>

  <div class="fp-container">
    <div class="fp-canvas-card">
      <div class="fp-canvas-toolbar">
        <div class="fp-mode-group">
          <button class="fp-mode-btn active" data-mode="view" title="View"><i class="bi bi-eye"></i> View</button>
          <button class="fp-mode-btn" data-mode="edit" title="Edit"><i class="bi bi-pin-angle"></i> Edit</button>
          <button class="fp-mode-btn" data-mode="draw" title="Draw"><i class="bi bi-vector-pen"></i> Draw</button>
        </div>
        <div class="fp-zoom-group">
          <button class="fp-zoom-btn" id="zoomOut"><i class="bi bi-dash"></i></button>
          <span class="fp-zoom-level" id="zoomLevel">100%</span>
          <button class="fp-zoom-btn" id="zoomIn"><i class="bi bi-plus"></i></button>
          <button class="fp-zoom-btn" id="zoomFit"><i class="bi bi-arrows-angle-expand"></i></button>
        </div>
      </div>
      <div class="fp-canvas-wrapper" id="canvasWrapper">
        {% if plan.image %}
        <div class="fp-canvas-content" id="canvasContent">
          <img src="{{ plan.image.url }}" alt="{{ plan.name }}" id="planImage">
          <svg class="fp-paths-svg" id="pathsSvg"></svg>
          <div class="fp-pins-layer" id="pinsLayer"></div>
          <div class="fp-draw-preview" id="drawPreview"></div>
        </div>
        {% else %}
        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-white p-5">
          <i class="bi bi-image display-1 opacity-50 mb-3"></i>
          <p>No image uploaded</p>
          <a href="{% url 'floor_plan_edit' plan.id %}" class="btn btn-primary btn-sm"><i class="bi bi-upload me-1"></i> Upload</a>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="fp-sidebar" id="sidebar">
      <div class="fp-sidebar-card">
        <div class="fp-sidebar-header">
          <h3><i class="bi bi-pin-map"></i> Pins (Info Only)</h3>
          <span class="fp-pin-badge">{{ pins|length }}</span>
        </div>
        <div class="fp-filter-tabs">
          <button class="fp-filter-tab active" data-filter="all">All</button>
          <button class="fp-filter-tab" data-filter="note">Notes</button>
          <button class="fp-filter-tab" data-filter="color">Colors</button>
          <button class="fp-filter-tab" data-filter="alert">Alerts</button>
        </div>
        {% if is_admin and pending_pins %}
        <div class="fp-pending-section">
          <div class="fp-pending-title"><i class="bi bi-hourglass-split"></i> Pending Approval</div>
          {% for pin in pending_pins %}
          <div class="fp-pending-item">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <strong class="small">{{ pin.title|default:"Untitled" }}</strong>
                <div class="text-muted" style="font-size:0.7rem">{{ pin.created_by.username }} - {{ pin.created_at|date:"M d" }}</div>
              </div>
              <span class="fp-pin-badge">{{ pin.pin_type }}</span>
            </div>
            <div class="d-flex gap-1">
              <button class="fp-btn fp-btn-success fp-btn-sm" onclick="approvePin({{ pin.id }})"><i class="bi bi-check"></i> Approve</button>
              <button class="fp-btn fp-btn-danger fp-btn-sm" onclick="rejectPin({{ pin.id }})"><i class="bi bi-x"></i> Reject</button>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        <div class="fp-pin-list" id="pinList">
          {% if pins %}
            {% for pin in pins %}
            <div class="fp-pin-item" data-id="{{ pin.id }}" data-type="{{ pin.pin_type }}" data-x="{{ pin.x }}" data-y="{{ pin.y }}">
              <div class="fp-pin-dot {{ pin.pin_type }}"></div>
              <div class="fp-pin-info">
                <div class="fp-pin-title">{{ pin.title|default:"Untitled" }}</div>
                {% if pin.description %}<div class="fp-pin-desc">{{ pin.description }}</div>{% endif %}
              </div>
              <span class="fp-pin-badge">{{ pin.pin_type }}</span>
            </div>
            {% endfor %}
          {% else %}
            <div class="fp-empty">
              <i class="bi bi-pin-map"></i>
              <p>No pins yet.</p>
              <button class="fp-btn fp-btn-primary fp-btn-sm" onclick="setMode('edit')"><i class="bi bi-plus-lg"></i> Add Pin</button>
            </div>
          {% endif %}
        </div>
      </div>
      <div class="fp-sidebar-card">
        <div class="fp-sidebar-header"><h3><i class="bi bi-lightning"></i> Actions</h3></div>
        <div class="p-3 d-grid gap-2">
          <a href="{% url 'floor_plan_add_pin' plan.id %}" class="fp-btn fp-btn-primary"><i class="bi bi-plus-circle"></i> Add Info Pin</a>
          <a href="{% url 'floor_plan_touchup_view' plan.id %}" class="fp-btn fp-btn-success"><i class="bi bi-brush"></i> Touch-ups & Tasks Panel</a>
          <a href="{% url 'floor_plan_list' project.id %}" class="fp-btn fp-btn-secondary"><i class="bi bi-arrow-left"></i> All Plans</a>
        </div>
      </div>
    </div>
    <div class="fp-sidebar-backdrop" id="sidebarBackdrop"></div>
  </div>
</div>

<button class="fp-mobile-toggle fp-btn fp-btn-primary" id="mobileToggle"><i class="bi bi-list"></i> Pins</button>

<!-- Edit/Add Pin Modal -->
<div class="fp-modal-overlay" id="pinModal">
  <div class="fp-modal">
    <div class="fp-modal-header">
      <h3 id="modalTitle">Add Pin</h3>
      <button class="fp-modal-close" onclick="closePinModal()"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="fp-modal-body">
      <form id="pinForm">
        <input type="hidden" id="pinId" name="pin_id">
        <input type="hidden" id="pinX" name="x">
        <input type="hidden" id="pinY" name="y">
        <input type="hidden" id="pinIsMultipoint" name="is_multipoint" value="false">
        <input type="hidden" id="pinPathPoints" name="path_points" value="[]">
        <div class="fp-field">
          <label>Type (Info Pins Only)</label>
          <div class="fp-type-grid" style="grid-template-columns:repeat(4,1fr)">
            <button type="button" class="fp-type-btn note selected" data-type="note"><i class="bi bi-sticky-fill"></i><span>Note</span></button>
            <button type="button" class="fp-type-btn color" data-type="color"><i class="bi bi-palette-fill"></i><span>Color</span></button>
            <button type="button" class="fp-type-btn alert" data-type="alert"><i class="bi bi-exclamation-triangle-fill"></i><span>Alert</span></button>
            <button type="button" class="fp-type-btn damage" data-type="damage"><i class="bi bi-lightning-fill"></i><span>Damage</span></button>
          </div>
          <input type="hidden" id="pinType" name="pin_type" value="note">
        </div>
        <div class="fp-field">
          <label for="pinTitle">Title</label>
          <input type="text" id="pinTitle" name="title" placeholder="Enter title...">
        </div>
        <div class="fp-field">
          <label for="pinDescription">Description</label>
          <textarea id="pinDescription" name="description" rows="3" placeholder="Details..."></textarea>
        </div>
        <div class="fp-field">
          <label>Color</label>
          <div class="fp-color-picker">
            <div class="fp-color-swatch selected" data-color="#3b82f6" style="background:#3b82f6"></div>
            <div class="fp-color-swatch" data-color="#10b981" style="background:#10b981"></div>
            <div class="fp-color-swatch" data-color="#8b5cf6" style="background:#8b5cf6"></div>
            <div class="fp-color-swatch" data-color="#f59e0b" style="background:#f59e0b"></div>
            <div class="fp-color-swatch" data-color="#ef4444" style="background:#ef4444"></div>
            <div class="fp-color-swatch" data-color="#6b7280" style="background:#6b7280"></div>
          </div>
          <input type="hidden" id="pinColor" name="color" value="#3b82f6">
        </div>
      </form>
    </div>
    <div class="fp-modal-footer">
      <button class="fp-btn fp-btn-secondary" onclick="closePinModal()">Cancel</button>
      <button class="fp-btn fp-btn-danger" id="deleteBtn" onclick="deletePin()" style="display:none"><i class="bi bi-trash"></i> Delete</button>
      <button class="fp-btn fp-btn-primary" onclick="savePin()"><i class="bi bi-check-lg"></i> Save</button>
    </div>
  </div>
</div>

<!-- Pin Detail View Modal -->
<div class="fp-modal-overlay" id="pinDetailModal">
  <div class="fp-modal fp-modal-lg">
    <div class="fp-modal-header">
      <h3><i class="bi bi-info-circle me-2"></i>Pin Details</h3>
      <button class="fp-modal-close" onclick="closeDetailModal()"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="fp-modal-body" id="pinDetailContent">
      <!-- Content loaded dynamically -->
    </div>
    <div class="fp-modal-footer">
      <button class="fp-btn fp-btn-secondary" onclick="closeDetailModal()">Close</button>
      <button class="fp-btn fp-btn-primary" id="editFromDetailBtn" onclick="editFromDetail()"><i class="bi bi-pencil"></i> Edit Pin</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const canvasWrapper = document.getElementById('canvasWrapper');
  const canvasContent = document.getElementById('canvasContent');
  const planImage = document.getElementById('planImage');
  const pinsLayer = document.getElementById('pinsLayer');
  const pathsSvg = document.getElementById('pathsSvg');
  const drawPreview = document.getElementById('drawPreview');
  const pinList = document.getElementById('pinList');
  const sidebar = document.getElementById('sidebar');
  const sidebarBackdrop = document.getElementById('sidebarBackdrop');
  const mobileToggle = document.getElementById('mobileToggle');
  let currentMode = 'view';
  let scale = 1;
  let isPanning = false;
  let panStart = {x:0,y:0};
  let scrollStart = {x:0,y:0};
  let drawingPoints = [];
  let selectedPinId = null;
  
  // Pin data with full details including attachments
  const pinsData = [
    {% for pin in pins %}
    {
      id: {{ pin.id }},
      x: {{ pin.x }},
      y: {{ pin.y }},
      type: '{{ pin.pin_type }}',
      title: '{{ pin.title|escapejs|default:"" }}',
      description: '{{ pin.description|escapejs|default:"" }}',
      color: '{{ pin.pin_color|default:"#3b82f6" }}',
      isMultipoint: {{ pin.is_multipoint|yesno:"true,false" }},
      pathPoints: {{ pin.path_points|safe|default:"[]" }},
      createdBy: '{{ pin.created_by.username|default:"Unknown" }}',
      createdAt: '{{ pin.created_at|date:"M d, Y H:i" }}',
      colorSample: {% if pin.color_sample %}{ name: '{{ pin.color_sample.name|escapejs }}', code: '{{ pin.color_sample.color_code|default:"" }}', hex: '{{ pin.color_sample.hex_color|default:"#cccccc" }}' }{% else %}null{% endif %},
      linkedTask: {% if pin.linked_task %}{ id: {{ pin.linked_task.id }}, title: '{{ pin.linked_task.title|escapejs }}', status: '{{ pin.linked_task.status }}' }{% else %}null{% endif %},
      attachments: [{% for att in pin.attachments.all %}{ id: {{ att.id }}, url: '{{ att.image.url }}' }{% if not forloop.last %},{% endif %}{% endfor %}],
      comments: {{ pin.client_comments|safe|default:"[]" }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  
  const isAdmin = {% if is_admin %}true{% else %}false{% endif %};
  const csrfToken = '{{ csrf_token }}';
  const apiPins = '/api/v1/plan-pins/';
  
  function init() {
    if (planImage) { 
      if (planImage.complete) renderAllPins(); 
      else planImage.addEventListener('load', renderAllPins); 
    }
    setupEvents();
  }
  
  function setupEvents() {
    document.querySelectorAll('.fp-mode-btn').forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode)));
    document.getElementById('zoomIn').addEventListener('click', () => zoom(0.25));
    document.getElementById('zoomOut').addEventListener('click', () => zoom(-0.25));
    document.getElementById('zoomFit').addEventListener('click', zoomFit);
    
    if (canvasWrapper) {
      canvasWrapper.addEventListener('wheel', handleWheel, {passive:false});
      canvasWrapper.addEventListener('mousedown', handleMouseDown);
      canvasWrapper.addEventListener('mousemove', handleMouseMove);
      canvasWrapper.addEventListener('mouseup', handleMouseUp);
      canvasWrapper.addEventListener('mouseleave', handleMouseUp);
      canvasWrapper.addEventListener('click', handleCanvasClick);
      canvasWrapper.addEventListener('dblclick', handleDoubleClick);
    }
    
    document.querySelectorAll('.fp-filter-tab').forEach(tab => tab.addEventListener('click', () => filterPins(tab.dataset.filter)));
    
    if (pinList) {
      pinList.addEventListener('click', e => { 
        const item = e.target.closest('.fp-pin-item'); 
        if (item) { 
          const pinId = parseInt(item.dataset.id);
          selectPin(pinId); 
          panToPin(parseFloat(item.dataset.x), parseFloat(item.dataset.y));
          // Open detail modal on click in view mode
          if (currentMode === 'view') {
            openDetailModal(pinId);
          }
        } 
      });
    }
    
    if (mobileToggle) mobileToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
    if (sidebarBackdrop) sidebarBackdrop.addEventListener('click', () => sidebar.classList.remove('open'));
    
    document.querySelectorAll('.fp-type-btn').forEach(btn => btn.addEventListener('click', function() { 
      document.querySelectorAll('.fp-type-btn').forEach(b => b.classList.remove('selected')); 
      this.classList.add('selected'); 
      document.getElementById('pinType').value = this.dataset.type; 
    }));
    
    document.querySelectorAll('.fp-color-swatch').forEach(s => s.addEventListener('click', function() { 
      document.querySelectorAll('.fp-color-swatch').forEach(c => c.classList.remove('selected')); 
      this.classList.add('selected'); 
      document.getElementById('pinColor').value = this.dataset.color; 
    }));
  }
  
  window.setMode = function(mode) { 
    currentMode = mode; 
    document.querySelectorAll('.fp-mode-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode)); 
    if (canvasWrapper) canvasWrapper.classList.toggle('crosshair', mode === 'edit' || mode === 'draw'); 
    if (mode !== 'draw') { 
      drawingPoints = []; 
      if(drawPreview) drawPreview.innerHTML = ''; 
    } 
  };
  
  function zoom(d) { scale = Math.max(0.25, Math.min(4, scale + d)); updateScale(); }
  function zoomFit() { scale = 1; updateScale(); if (canvasWrapper) { canvasWrapper.scrollLeft = 0; canvasWrapper.scrollTop = 0; } }
  function updateScale() { if(canvasContent) canvasContent.style.transform = 'scale('+scale+')'; document.getElementById('zoomLevel').textContent = Math.round(scale*100)+'%'; }
  function handleWheel(e) { if(e.ctrlKey||e.metaKey) { e.preventDefault(); zoom(e.deltaY>0?-0.1:0.1); } }
  function handleMouseDown(e) { if(currentMode==='view'&&e.button===0) { isPanning=true; panStart={x:e.clientX,y:e.clientY}; scrollStart={x:canvasWrapper.scrollLeft,y:canvasWrapper.scrollTop}; canvasWrapper.classList.add('grabbing'); } }
  function handleMouseMove(e) { if(isPanning) { canvasWrapper.scrollLeft = scrollStart.x - (e.clientX-panStart.x); canvasWrapper.scrollTop = scrollStart.y - (e.clientY-panStart.y); } }
  function handleMouseUp() { isPanning = false; if (canvasWrapper) canvasWrapper.classList.remove('grabbing'); }
  
  function handleCanvasClick(e) { 
    if (isPanning || !planImage) return; 
    const rect = planImage.getBoundingClientRect(); 
    const x = (e.clientX - rect.left) / rect.width; 
    const y = (e.clientY - rect.top) / rect.height; 
    if (x < 0 || x > 1 || y < 0 || y > 1) return; 
    if (currentMode === 'edit') openPinModal(null, x, y); 
    else if (currentMode === 'draw') addDrawingPoint(x, y); 
  }
  
  function handleDoubleClick() { if (currentMode === 'draw' && drawingPoints.length >= 2) finishDrawing(); }
  
  function addDrawingPoint(x, y) { drawingPoints.push({x,y}); renderDrawingPreview(); }
  
  function renderDrawingPreview() { 
    if (!drawPreview || !planImage) return; 
    drawPreview.innerHTML = ''; 
    drawingPoints.forEach(p => { 
      const dot = document.createElement('div'); 
      dot.className = 'fp-draw-point'; 
      dot.style.left = (p.x*100)+'%'; 
      dot.style.top = (p.y*100)+'%'; 
      drawPreview.appendChild(dot); 
    }); 
    if (drawingPoints.length >= 2 && pathsSvg) { 
      let pathD = ''; 
      drawingPoints.forEach((p,i) => { pathD += (i===0?'M':'L') + (p.x*planImage.naturalWidth) + ',' + (p.y*planImage.naturalHeight); }); 
      let existing = pathsSvg.querySelector('#previewPath'); 
      if (existing) existing.remove(); 
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path'); 
      path.id = 'previewPath'; 
      path.setAttribute('d', pathD); 
      path.setAttribute('stroke', '#3b82f6'); 
      path.setAttribute('stroke-width', '3'); 
      path.setAttribute('fill', 'none'); 
      path.setAttribute('stroke-dasharray', '5,5'); 
      pathsSvg.appendChild(path); 
    } 
  }
  
  function finishDrawing() { if (drawingPoints.length < 2) return; const first = drawingPoints[0]; openPinModal(null, first.x, first.y, true, drawingPoints); }
  
  function renderAllPins() { 
    if (!pinsLayer || !planImage) return; 
    pinsLayer.innerHTML = ''; 
    if (pathsSvg) pathsSvg.innerHTML = ''; 
    pinsData.forEach(renderPin); 
  }
  
  function renderPin(pin) { 
    if (pin.isMultipoint && pin.pathPoints && pin.pathPoints.length >= 2 && pathsSvg) { 
      let pathD = ''; 
      pin.pathPoints.forEach((p,i) => { pathD += (i===0?'M':'L') + (p.x*planImage.naturalWidth) + ',' + (p.y*planImage.naturalHeight); }); 
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path'); 
      path.setAttribute('d', pathD); 
      path.setAttribute('stroke', pin.color || '#3b82f6'); 
      path.setAttribute('stroke-width', '3'); 
      path.setAttribute('fill', 'none'); 
      path.dataset.pinId = pin.id; 
      pathsSvg.appendChild(path); 
    } 
    const icons = {note:'bi-sticky-fill',touchup:'bi-brush-fill',color:'bi-palette-fill',alert:'bi-exclamation-triangle-fill',damage:'bi-lightning-fill'}; 
    const el = document.createElement('div'); 
    el.className = 'fp-pin'; 
    el.dataset.id = pin.id; 
    el.style.left = (pin.x*100)+'%'; 
    el.style.top = (pin.y*100)+'%'; 
    el.innerHTML = '<div class="fp-pin-marker '+pin.type+'"><i class="bi '+(icons[pin.type]||'bi-pin-fill')+'"></i></div><div class="fp-tooltip">'+(pin.title||'Untitled')+'</div>'; 
    el.addEventListener('click', e => { 
      e.stopPropagation(); 
      if(currentMode==='edit') openPinModal(pin.id); 
      else {
        selectPin(pin.id);
        openDetailModal(pin.id);
      }
    }); 
    pinsLayer.appendChild(el); 
  }
  
  function selectPin(id) { 
    selectedPinId = id; 
    document.querySelectorAll('.fp-pin').forEach(el => el.classList.toggle('selected', parseInt(el.dataset.id)===id)); 
    document.querySelectorAll('.fp-pin-item').forEach(el => el.classList.toggle('selected', parseInt(el.dataset.id)===id)); 
  }
  
  function panToPin(x, y) { 
    if (!canvasWrapper || !planImage) return; 
    const wr = canvasWrapper.getBoundingClientRect(); 
    canvasWrapper.scrollTo({ 
      left: (x*planImage.naturalWidth*scale) - (wr.width/2), 
      top: (y*planImage.naturalHeight*scale) - (wr.height/2), 
      behavior: 'smooth' 
    }); 
  }
  
  function filterPins(type) { 
    document.querySelectorAll('.fp-filter-tab').forEach(t => t.classList.toggle('active', t.dataset.filter === type)); 
    document.querySelectorAll('.fp-pin-item').forEach(i => i.style.display = (type==='all'||i.dataset.type===type) ? 'flex' : 'none'); 
    document.querySelectorAll('.fp-pin').forEach(p => { 
      const d = pinsData.find(pd => pd.id===parseInt(p.dataset.id)); 
      p.style.display = (type==='all'||(d&&d.type===type)) ? 'block' : 'none'; 
    }); 
  }
  
  // Pin Detail Modal Functions
  function openDetailModal(pinId) {
    const pin = pinsData.find(p => p.id === pinId);
    if (!pin) return;
    
    const icons = {note:'bi-sticky-fill',touchup:'bi-brush-fill',color:'bi-palette-fill',alert:'bi-exclamation-triangle-fill',damage:'bi-lightning-fill'};
    const content = document.getElementById('pinDetailContent');
    
    let html = `
      <div class="fp-detail-header">
        <div class="fp-detail-icon ${pin.type}"><i class="bi ${icons[pin.type] || 'bi-pin-fill'}"></i></div>
        <div class="fp-detail-title">
          <h4>${pin.title || 'Untitled Pin'}</h4>
          <span class="fp-detail-type ${pin.type}">${pin.type.charAt(0).toUpperCase() + pin.type.slice(1)}</span>
        </div>
      </div>
      
      <div class="fp-detail-section">
        <div class="fp-detail-section-title"><i class="bi bi-text-paragraph"></i> Description</div>
        <div class="fp-detail-description">${pin.description || '<span class="fp-no-data">No description provided</span>'}</div>
      </div>
    `;
    
    // Color Sample section
    if (pin.colorSample) {
      html += `
        <div class="fp-detail-section">
          <div class="fp-detail-section-title"><i class="bi bi-palette"></i> Color Sample</div>
          <div class="fp-detail-color-box">
            <div class="fp-detail-color-sample" style="background:${pin.colorSample.hex}"></div>
            <div class="fp-detail-color-info">
              <div class="fp-detail-color-name">${pin.colorSample.name}</div>
              <div class="fp-detail-color-code">${pin.colorSample.code || pin.colorSample.hex}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    // Photos/Attachments section
    if (pin.attachments && pin.attachments.length > 0) {
      html += `
        <div class="fp-detail-section">
          <div class="fp-detail-section-title"><i class="bi bi-images"></i> Photos (${pin.attachments.length})</div>
          <div class="fp-detail-photos">
            ${pin.attachments.map(att => `
              <div class="fp-detail-photo" onclick="window.open('${att.url}','_blank')">
                <img src="${att.url}" alt="Pin attachment">
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    // Linked Task section
    if (pin.linkedTask) {
      const statusColors = {Pending:'#f59e0b','In Progress':'#3b82f6',Completed:'#10b981'};
      html += `
        <div class="fp-detail-section">
          <div class="fp-detail-section-title"><i class="bi bi-link-45deg"></i> Linked Task</div>
          <div class="fp-detail-color-box">
            <div style="width:8px;height:100%;border-radius:4px;background:${statusColors[pin.linkedTask.status]||'#64748b'}"></div>
            <div class="fp-detail-color-info">
              <div class="fp-detail-color-name">${pin.linkedTask.title}</div>
              <div class="fp-detail-color-code">Status: ${pin.linkedTask.status}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    // Meta information
    html += `
      <div class="fp-detail-section">
        <div class="fp-detail-section-title"><i class="bi bi-info-circle"></i> Information</div>
        <div class="fp-detail-meta">
          <div class="fp-detail-meta-item">
            <div class="fp-detail-meta-label">Created By</div>
            <div class="fp-detail-meta-value">${pin.createdBy}</div>
          </div>
          <div class="fp-detail-meta-item">
            <div class="fp-detail-meta-label">Created At</div>
            <div class="fp-detail-meta-value">${pin.createdAt}</div>
          </div>
          <div class="fp-detail-meta-item">
            <div class="fp-detail-meta-label">Position</div>
            <div class="fp-detail-meta-value">X: ${(pin.x*100).toFixed(1)}%, Y: ${(pin.y*100).toFixed(1)}%</div>
          </div>
          <div class="fp-detail-meta-item">
            <div class="fp-detail-meta-label">Pin Color</div>
            <div class="fp-detail-meta-value"><span style="display:inline-block;width:16px;height:16px;border-radius:50%;background:${pin.color};vertical-align:middle;margin-right:0.5rem"></span>${pin.color}</div>
          </div>
        </div>
      </div>
    `;
    
    // Comments section
    if (pin.comments && pin.comments.length > 0) {
      html += `
        <div class="fp-detail-section">
          <div class="fp-detail-section-title"><i class="bi bi-chat-dots"></i> Comments (${pin.comments.length})</div>
          <div class="fp-detail-comments">
            ${pin.comments.map(c => `
              <div class="fp-comment">
                <div class="fp-comment-header">
                  <span class="fp-comment-user">${c.user}</span>
                  <span class="fp-comment-date">${new Date(c.timestamp).toLocaleDateString()}</span>
                </div>
                <div class="fp-comment-text">${c.comment}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    content.innerHTML = html;
    document.getElementById('editFromDetailBtn').dataset.pinId = pinId;
    document.getElementById('pinDetailModal').classList.add('active');
  }
  
  window.closeDetailModal = function() {
    document.getElementById('pinDetailModal').classList.remove('active');
  };
  
  window.editFromDetail = function() {
    const pinId = parseInt(document.getElementById('editFromDetailBtn').dataset.pinId);
    closeDetailModal();
    setMode('edit');
    openPinModal(pinId);
  };
  
  function openPinModal(pinId, x, y, isMultipoint, pathPoints) { 
    isMultipoint = isMultipoint || false; 
    pathPoints = pathPoints || []; 
    const modal = document.getElementById('pinModal'); 
    const deleteBtn = document.getElementById('deleteBtn'); 
    const modalTitle = document.getElementById('modalTitle'); 
    
    if (pinId) { 
      const pin = pinsData.find(p => p.id === pinId); 
      if (!pin) return; 
      modalTitle.textContent = 'Edit Pin'; 
      deleteBtn.style.display = 'inline-flex'; 
      document.getElementById('pinId').value = pin.id; 
      document.getElementById('pinX').value = pin.x; 
      document.getElementById('pinY').value = pin.y; 
      document.getElementById('pinType').value = pin.type; 
      document.getElementById('pinTitle').value = pin.title; 
      document.getElementById('pinDescription').value = pin.description; 
      document.getElementById('pinColor').value = pin.color; 
      document.getElementById('pinIsMultipoint').value = pin.isMultipoint; 
      document.getElementById('pinPathPoints').value = JSON.stringify(pin.pathPoints || []); 
      document.querySelectorAll('.fp-type-btn').forEach(b => b.classList.toggle('selected', b.dataset.type === pin.type)); 
      document.querySelectorAll('.fp-color-swatch').forEach(s => s.classList.toggle('selected', s.dataset.color === pin.color)); 
    } else { 
      modalTitle.textContent = 'Add Pin'; 
      deleteBtn.style.display = 'none'; 
      document.getElementById('pinId').value = ''; 
      document.getElementById('pinX').value = x; 
      document.getElementById('pinY').value = y; 
      document.getElementById('pinType').value = 'note'; 
      document.getElementById('pinTitle').value = ''; 
      document.getElementById('pinDescription').value = ''; 
      document.getElementById('pinColor').value = '#3b82f6'; 
      document.getElementById('pinIsMultipoint').value = isMultipoint; 
      document.getElementById('pinPathPoints').value = JSON.stringify(pathPoints); 
      document.querySelectorAll('.fp-type-btn').forEach(b => b.classList.toggle('selected', b.dataset.type === 'note')); 
      document.querySelectorAll('.fp-color-swatch').forEach(s => s.classList.toggle('selected', s.dataset.color === '#3b82f6')); 
    } 
    modal.classList.add('active'); 
  }
  
  window.closePinModal = function() { 
    document.getElementById('pinModal').classList.remove('active'); 
    drawingPoints = []; 
    if(drawPreview) drawPreview.innerHTML = ''; 
    if (pathsSvg) { 
      const prev = pathsSvg.querySelector('#previewPath'); 
      if(prev) prev.remove(); 
    } 
  };
  
  window.savePin = function() { 
    const form = document.getElementById('pinForm'); 
    const fd = new FormData(form); 
    const pinId = fd.get('pin_id'); 
    const method = pinId ? 'PUT' : 'POST'; 
    const url = pinId ? apiPins+pinId+'/' : apiPins; 
    const data = { 
      plan: {{ plan.id }}, 
      x: parseFloat(fd.get('x')), 
      y: parseFloat(fd.get('y')), 
      pin_type: fd.get('pin_type'), 
      title: fd.get('title'), 
      description: fd.get('description'), 
      pin_color: fd.get('color'), 
      is_multipoint: fd.get('is_multipoint') === 'true', 
      path_points: JSON.parse(fd.get('path_points') || '[]') 
    }; 
    fetch(url, { method, headers: {'Content-Type':'application/json','X-CSRFToken':csrfToken}, body: JSON.stringify(data) })
      .then(r => { if(!r.ok) throw new Error('Failed'); return r.json(); })
      .then(() => { closePinModal(); location.reload(); })
      .catch(e => { console.error(e); alert('Failed to save pin.'); }); 
  };
  
  window.deletePin = function() { 
    const pinId = document.getElementById('pinId').value; 
    if (!pinId || !confirm('Delete this pin?')) return; 
    fetch(apiPins+pinId+'/', { method: 'DELETE', headers: {'X-CSRFToken':csrfToken} })
      .then(r => { if(!r.ok) throw new Error('Failed'); closePinModal(); location.reload(); })
      .catch(e => { console.error(e); alert('Failed to delete.'); }); 
  };
  
  window.approvePin = function(pinId) { 
    fetch(apiPins+pinId+'/', { method: 'PATCH', headers: {'Content-Type':'application/json','X-CSRFToken':csrfToken}, body: JSON.stringify({status:'active'}) })
      .then(r => { if(!r.ok) throw new Error('Failed'); location.reload(); })
      .catch(e => { console.error(e); alert('Failed to approve.'); }); 
  };
  
  window.rejectPin = function(pinId) { 
    fetch(apiPins+pinId+'/', { method: 'PATCH', headers: {'Content-Type':'application/json','X-CSRFToken':csrfToken}, body: JSON.stringify({status:'rejected'}) })
      .then(r => { if(!r.ok) throw new Error('Failed'); location.reload(); })
      .catch(e => { console.error(e); alert('Failed to reject.'); }); 
  };
  
  init();
});
</script>
{% endblock %}
