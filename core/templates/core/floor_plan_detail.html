{% extends 'core/base.html' %}
{% load static %}
{% load i18n %}
{% load core_extras %}
{% block content %}
<style>
.plan-wrapper { position: relative; display: inline-block; }
.plan-wrapper img { max-width: 100%; height: auto; display: block; }
.plan-pin { position: absolute; transform: translate(-50%, -100%); cursor: pointer; }
.plan-pin .dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 4px rgba(0,0,0,0.3); }
.pin-path-line { stroke-width: 3; fill: none; pointer-events: none; }
.pin-path-marker { }
.zoom-controls { position: absolute; top: 10px; right: 10px; z-index: 100; }

/* Pulse animation for temp marker */
@keyframes pulse {
  0% { transform: translate(-50%, -100%) scale(1); opacity: 1; }
  50% { transform: translate(-50%, -100%) scale(1.2); opacity: 0.7; }
  100% { transform: translate(-50%, -100%) scale(1); opacity: 1; }
}

/* Mode Toggle Styles */
.mode-toggle-container {
  margin-bottom: 15px;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 2px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.mode-toggle-buttons .btn {
  margin-right: 5px;
  border-radius: 20px;
  padding: 8px 20px;
  font-weight: 500;
  transition: all 0.3s ease;
}
.mode-toggle-buttons .btn i {
  margin-right: 5px;
}
.mode-toggle-buttons .btn.active {
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  transform: translateY(-2px);
}
.mode-badge {
  font-size: 14px;
  font-weight: 600;
  padding: 6px 15px;
  border-radius: 20px;
}
.plan-wrapper.edit-mode {
  border: 3px solid #28a745;
  box-shadow: 0 0 15px rgba(40, 167, 69, 0.3);
  cursor: crosshair;
}
.plan-wrapper.view-mode {
  border: 3px solid #007bff;
  box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
  cursor: default;
}
</style>
<div class="container-fluid py-3">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'project_overview' project.id %}">{{ project.name }}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'floor_plan_list' project.id %}">Planos</a></li>
      <li class="breadcrumb-item active">{{ plan.name }}</li>
    </ol>
  </nav>

  <div class="row g-3">
    <!-- Controls disponibles según permisos -->
    {% if can_edit_pins %}
    <div class="col-12">
      <div class="d-flex justify-content-end mb-2 gap-2">
        <!-- Editar pines - todos los que pueden editar -->
        <button type="button" class="btn btn-sm btn-primary" id="topEditPinsBtn">
          <i class="bi bi-pin-angle"></i> {% trans "Editar Pines" %}
        </button>
        
        <!-- Editar plano - solo PM/Admin/Owner -->
        {% if can_delete %}
        <a href="{% url 'floor_plan_edit' plan.id %}" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-pencil-square"></i> {% trans "Editar Plano (imagen/nivel)" %}
        </a>
        <a href="{% url 'floor_plan_delete' plan.id %}" class="btn btn-sm btn-outline-danger">
          <i class="bi bi-trash"></i> {% trans "Eliminar Plano" %}
        </a>
        {% endif %}

        <!-- Info para Designer/Client -->
        {% if not can_delete %}
        <span class="badge bg-info align-self-center">
          <i class="bi bi-info-circle"></i> 
          {% if request.user.profile.role == 'designer' %}
            {% trans "Puedes editar pines y agregar comentarios" %}
          {% else %}
            {% trans "Vista de colaborador" %}
          {% endif %}
        </span>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <div class="col-lg-8">
      <!-- Mode Toggle Controls -->
      <div class="mode-toggle-container">
        <div class="mode-toggle-buttons">
          <button type="button" class="btn btn-primary active" id="viewModeBtn">
            <i class="bi bi-eye"></i> {% trans "Modo Visualización" %}
          </button>
          {% if can_edit_pins %}
          <button type="button" class="btn btn-success" id="editModeBtn">
            <i class="bi bi-pencil"></i> {% trans "Modo Edición" %}
          </button>
          <button type="button" class="btn btn-outline-primary" id="addPinBtn">
            <i class="bi bi-pin-map"></i> {% trans "Nuevo Pin" %}
          </button>
          {% endif %}
        </div>
        <div>
          <span class="mode-badge badge bg-primary" id="modeBadge">
            <i class="bi bi-eye"></i> {% trans "VISUALIZANDO" %}
          </span>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body position-relative" style="overflow:auto; max-height:80vh;">
          <div class="zoom-controls btn-group">
            <button class="btn btn-sm btn-outline-secondary" id="zoomIn" title="Zoom in">+</button>
            <button class="btn btn-sm btn-outline-secondary" id="zoomOut" title="Zoom out">−</button>
            <button class="btn btn-sm btn-outline-secondary" id="zoomReset" title="Reset">1:1</button>
          </div>
          <div class="plan-wrapper view-mode" id="planWrapper">
            <svg id="planSvg" style="position:absolute; top:0; left:0; pointer-events:none; width:100%; height:100%;"></svg>
            {% if plan.image %}
            <img id="planImage" src="{{ plan.image.url }}" alt="plan" style="transform-origin: top left;" onerror="console.error('Image load error:', this.src); this.style.display='none'; document.getElementById('imageError').style.display='block';">
            <div id="imageError" style="display:none; padding:20px; background:#f8d7da; color:#721c24; border-radius:5px;">
              <strong>⚠️ Error cargando imagen del plano</strong><br>
              URL: {{ plan.image.url }}<br>
              <small>La imagen no se pudo cargar. Verifica que el archivo exista y sea accesible.</small>
            </div>
            {% else %}
            <div style="padding:20px; background:#fff3cd; color:#856404; border-radius:5px;">
              <strong>⚠️ Este plano no tiene imagen asociada</strong><br>
              <small>Por favor, edita el plano y sube una imagen.</small>
            </div>
            {% endif %}
            {% for pin in pins %}
              <div class="plan-pin" data-pin-id="{{ pin.id }}" data-color="{{ pin.pin_color }}" data-popover-url="{% url 'pin_detail_ajax' pin.id %}" style="left: {{ pin.x|floatformat:4|mul:100 }}%; top: {{ pin.y|floatformat:4|mul:100 }}%;" title="{{ pin.title }}" tabindex="0">
                <div class="dot" style="background-color: {{ pin.pin_color }};"></div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="alert alert-secondary mt-2" id="modeHelpText">
  <i class="bi bi-info-circle"></i> <strong>{% trans "Modo Visualización" %}:</strong> {% trans "Haz clic en los pines para ver su información." %} 
        {% if can_edit_pins %}
  {% trans "Cambia a" %} <strong>{% trans "Modo Edición" %}</strong> {% trans "para agregar o editar pines." %}
        {% endif %}
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card">
  <div class="card-header">{% trans "Pines" %}</div>
        <div class="card-body p-0" style="max-height:300px; overflow-y:auto;">
          <ul class="list-group list-group-flush">
          {% for pin in pins %}
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>{{ pin.title|default:'(sin título)' }}</strong>
                  <span class="badge" style="background-color: {{ pin.pin_color }}; color: #fff; margin-left:4px;">●</span>
                  <div class="small text-muted">{{ pin.get_pin_type_display }} · {{ pin.created_at|date:'Y-m-d H:i' }}</div>
                  {% if pin.is_multipoint %}
                    <div class="small"><span class="badge text-bg-success">Línea: {{ pin.path_points|length }} pts</span></div>
                  {% endif %}
                  {% if pin.color_sample %}
                    <div class="small"><span class="badge text-bg-secondary">Color:</span> {{ pin.color_sample.name|default:pin.color_sample.code }}</div>
                  {% endif %}
                  {% if pin.linked_task %}
                    <div class="small"><span class="badge text-bg-info">Tarea:</span> {{ pin.linked_task.title }}</div>
                  {% endif %}
                  {% if pin.description %}
                    <div class="small mt-1">{{ pin.description }}</div>
                  {% endif %}
                </div>
                <span class="badge text-bg-light">({{ pin.x }}, {{ pin.y }})</span>
              </div>
            </li>
          {% empty %}
            <li class="list-group-item">{% trans "No hay pines en este plano." %}</li>
          {% endfor %}
          </ul>
        </div>
      </div>
      <div class="card mt-3">
  <div class="card-header">{% trans "Agregar pin" %}</div>
        <div class="card-body">
          <form id="pinForm" method="post" action="{% url 'floor_plan_add_pin' plan.id %}">
            {% csrf_token %}
            <input type="hidden" name="x" id="pinX">
            <input type="hidden" name="y" id="pinY">
            <input type="hidden" name="is_multipoint" id="isMultipoint" value="false">
            <input type="hidden" name="path_points" id="pathPoints" value="[]">
            {{ form.as_p|default:'' }}
            <div class="mb-2">
              <label class="form-label">{% trans "Color aprobado (opcional)" %}</label>
              <select name="color_sample" class="form-select form-select-sm">
                <option value="">— {% trans "Selecciona" %} —</option>
                {% for c in color_samples %}
                  <option value="{{ c.id }}">{{ c.name|default:c.code }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" name="create_task" id="createTask">
              <label class="form-check-label" for="createTask">{% trans "Crear tarea touch-up" %}</label>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="multipointCheck">
              <label class="form-check-label" for="multipointCheck">{% trans "Línea multipunto (A→B→C)" %}</label>
            </div>
            <div id="multipointControls" style="display:none;">
              <div class="alert alert-info small">{% trans "Haz clic en múltiples puntos. Presiona" %} <b>Esc</b> {% trans "para finalizar." %}</div>
              <div id="pointsList" class="small mb-2"></div>
              <button type="button" class="btn btn-sm btn-warning" id="clearPoints">{% trans "Limpiar puntos" %}</button>
            </div>
            <button class="btn btn-primary btn-sm" id="saveBtn">{% trans "Guardar pin" %}</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  console.log('[Floor Plan] Initializing...');
  
  const img = document.getElementById('planImage');
  const wrapper = document.getElementById('planWrapper');
  const svg = document.getElementById('planSvg');
  const pinX = document.getElementById('pinX');
  const pinY = document.getElementById('pinY');
  const form = document.getElementById('pinForm');
  const multipointCheck = document.getElementById('multipointCheck');
  const multipointControls = document.getElementById('multipointControls');
  const isMultipointInput = document.getElementById('isMultipoint');
  const pathPointsInput = document.getElementById('pathPoints');
  const pointsList = document.getElementById('pointsList');
  const clearBtn = document.getElementById('clearPoints');
  const zoomIn = document.getElementById('zoomIn');
  const zoomOut = document.getElementById('zoomOut');
  const zoomReset = document.getElementById('zoomReset');
  
  // Debug image load
  console.log('[Floor Plan] Image element:', img);
  console.log('[Floor Plan] Image src:', img ? img.src : 'null');
  console.log('[Floor Plan] Image complete:', img ? img.complete : 'null');
  console.log('[Floor Plan] Image naturalWidth:', img ? img.naturalWidth : 'null');
  console.log('[Floor Plan] Image naturalHeight:', img ? img.naturalHeight : 'null');
  
  // Check if image exists and has valid dimensions
  if (img) {
    if (img.complete) {
      if (img.naturalWidth === 0 || img.naturalHeight === 0) {
        console.error('[Floor Plan] Image has invalid dimensions - file may not exist or be corrupted');
        console.error('[Floor Plan] Image URL:', img.src);
      } else {
        console.log('[Floor Plan] Image loaded successfully:', img.naturalWidth, 'x', img.naturalHeight);
      }
    }
  }

  // i18n strings injected from template (Spanish msgid -> English translation via locale)
  const I18N = {
    viewingBadge: `{% trans "VISUALIZANDO" %}`,
    editingBadge: `{% trans "EDITANDO" %}`,
    viewModeHelpCanEdit: `{% trans "Modo Visualización: Haz clic en los pines para ver su información. Cambia a Modo Edición para agregar o editar pines." %}`,
    viewModeHelp: `{% trans "Modo Visualización: Haz clic en los pines para ver su información." %}`,
    editModeHelp: `{% trans "Modo Edición: Haz clic sobre el plano para agregar un pin. Marca \"Línea multipunto\" para conectar puntos A→B→C. Cada pin nuevo tiene un color único. Haz clic en pines existentes para editarlos." %}`,
    newPinHelp: `{% trans "Nuevo Pin: Haz clic sobre el plano para posicionar el pin. Se abrirá el creador para completar la información." %}`,
    pointsCaptured: `{% trans "Puntos capturados. Presiona Guardar pin." %}`,
    errorLoadingPin: `{% trans "Error cargando detalles del pin" %}`,
    descLabel: `{% trans "Descripción" %}`,
    approvedColorLabel: `{% trans "Color Aprobado" %}`,
    photosLabel: `{% trans "Fotos" %}`,
    noPhotosText: `{% trans "No hay fotos adjuntas" %}`,
    editPin: `{% trans "Editar Pin" %}`,
    deletePin: `{% trans "Eliminar Pin" %}`,
    confirmDeletePin: `{% trans "¿Estás seguro de eliminar este pin? Esta acción no se puede deshacer." %}`,
    selectPhotos: `{% trans "Seleccionar fotos" %}`,
    annotatePhotos: `{% trans "Anotar Fotos" %}`,
    uploadPhotos: `{% trans "Subir Fotos" %}`,
    errorUploadingPhotos: `{% trans "Error subiendo fotos" %}`,
    confirmDeletePhoto: `{% trans "¿Eliminar esta foto?" %}`
  };

  // Permissions from backend
  const CAN_EDIT = {{ can_edit_pins|yesno:"true,false" }};
  const CAN_DELETE = {{ can_delete|yesno:"true,false" }};

  let scale = 1.0;
  let multipointMode = false;
  let tempPoints = [];
  let currentMode = 'view'; // 'view' or 'edit'
  let addingMode = false;   // when true, next click positions a new pin and opens the creator modal

  // Mode Toggle Functions
  function switchToViewMode() {
    currentMode = 'view';
    document.getElementById('viewModeBtn').classList.add('active');
    document.getElementById('editModeBtn')?.classList.remove('active');
  document.getElementById('modeBadge').innerHTML = `<i class="bi bi-eye"></i> ${I18N.viewingBadge}`;
    document.getElementById('modeBadge').className = 'mode-badge badge bg-primary';
    wrapper.classList.remove('edit-mode');
    wrapper.classList.add('view-mode');
    wrapper.style.cursor = 'default';
    const canEdit = {{ can_edit_pins|lower }};
    if (canEdit) {
      document.getElementById('modeHelpText').innerHTML = `<i class="bi bi-info-circle"></i> <strong>${I18N.viewModeHelpCanEdit.split(':')[0]}:</strong> ${I18N.viewModeHelpCanEdit.split(':').slice(1).join(':')}`;
    } else {
      document.getElementById('modeHelpText').innerHTML = `<i class="bi bi-info-circle"></i> <strong>${I18N.viewModeHelp.split(':')[0]}:</strong> ${I18N.viewModeHelp.split(':').slice(1).join(':')}`;
    }
  }

  function switchToEditMode() {
    currentMode = 'edit';
    document.getElementById('viewModeBtn').classList.remove('active');
    document.getElementById('editModeBtn').classList.add('active');
  document.getElementById('modeBadge').innerHTML = `<i class="bi bi-pencil"></i> ${I18N.editingBadge}`;
    document.getElementById('modeBadge').className = 'mode-badge badge bg-success';
    wrapper.classList.remove('view-mode');
    wrapper.classList.add('edit-mode');
    wrapper.style.cursor = 'crosshair';
  document.getElementById('modeHelpText').innerHTML = `<i class="bi bi-pencil-square"></i> <strong>${I18N.editModeHelp.split(':')[0]}:</strong> ${I18N.editModeHelp.split(':').slice(1).join(':')}`;
  }

  // Expose mode functions globally for inline onclick handlers
  window.switchToEditMode = switchToEditMode;
  window.switchToViewMode = switchToViewMode;
  
  // Function to show temporary pin marker
  function showTempPinMarker(x, y) {
    // Remove any existing temp marker
    const existingMarker = document.getElementById('tempPinMarker');
    if (existingMarker) existingMarker.remove();
    
    // Create temporary visual marker
    const marker = document.createElement('div');
    marker.id = 'tempPinMarker';
    marker.style.cssText = `
      position: absolute;
      left: ${x * 100}%;
      top: ${y * 100}%;
      transform: translate(-50%, -100%);
      width: 20px;
      height: 20px;
      background: #ffc107;
      border: 3px solid #fff;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      animation: pulse 1s infinite;
      z-index: 1000;
      pointer-events: none;
    `;
    wrapper.appendChild(marker);
  }
  
  window.startAddPin = function(){
    console.log('[Floor Plan] startAddPin called');
    // Ensure edit mode and guide the user to click on the plan
    switchToEditMode();
    addingMode = true;
    console.log('[Floor Plan] addingMode set to true');
  document.getElementById('modeHelpText').innerHTML = `<i class="bi bi-geo-alt-fill text-warning"></i> <strong>${I18N.newPinHelp.split(':')[0]}:</strong> ${I18N.newPinHelp.split(':').slice(1).join(':')}`;
    document.getElementById('planWrapper').scrollIntoView({behavior:'smooth', block:'center'});
    
    // Flash the plan wrapper to indicate it's ready
    wrapper.style.outline = '3px solid #ffc107';
    setTimeout(() => {
      wrapper.style.outline = '';
    }, 1500);
  }

  // Zoom controls
  zoomIn.addEventListener('click', ()=>{ scale = Math.min(scale+0.2, 3); applyZoom(); });
  zoomOut.addEventListener('click', ()=>{ scale = Math.max(scale-0.2, 0.5); applyZoom(); });
  zoomReset.addEventListener('click', ()=>{ scale=1; applyZoom(); });
  function applyZoom(){ img.style.transform = `scale(${scale})`; updateSvgSize(); renderLines(); }
  function updateSvgSize(){
    const rect = img.getBoundingClientRect();
    svg.setAttribute('width', rect.width);
    svg.setAttribute('height', rect.height);
  }

  multipointCheck.addEventListener('change', function(){
    multipointMode = this.checked;
    multipointControls.style.display = multipointMode ? 'block' : 'none';
    isMultipointInput.value = multipointMode ? 'true' : 'false';
    if(!multipointMode){ tempPoints=[]; renderLines(); updatePointsList(); }
  });

  clearBtn.addEventListener('click', ()=>{ tempPoints=[]; renderLines(); updatePointsList(); });

  wrapper.addEventListener('click', function(evt){
    console.log('[Floor Plan] Click detected, mode:', currentMode, 'addingMode:', addingMode);
    
    // No crear pins si se hace click sobre un pin existente (para popover)
    if (evt.target && evt.target.closest && evt.target.closest('.plan-pin')) {
      console.log('[Floor Plan] Click on existing pin, ignoring');
      return;
    }
    
    // Solo permitir crear pins en modo edición
    if (currentMode !== 'edit') {
      console.log('[Floor Plan] Not in edit mode, ignoring click');
      return;
    }
    
    const rect = img.getBoundingClientRect();
    const x = (evt.clientX - rect.left) / (rect.width);
    const y = (evt.clientY - rect.top) / (rect.height);
    
    console.log('[Floor Plan] Coordinates captured:', x.toFixed(4), y.toFixed(4));
    
    if(multipointMode){
      tempPoints.push({x:x.toFixed(4), y:y.toFixed(4), label:String.fromCharCode(65+tempPoints.length)});
      renderLines();
      updatePointsList();
    } else {
      pinX.value = x.toFixed(4);
      pinY.value = y.toFixed(4);
      
      // Always show a visual indicator of where the pin will be placed
      showTempPinMarker(x, y);
      
      // If in quick add flow, open the creation modal
      if (addingMode) {
        console.log('[Floor Plan] Opening modal...');
        const xInput = document.getElementById('pinXModal');
        const yInput = document.getElementById('pinYModal');
        if (xInput && yInput) {
          xInput.value = pinX.value;
          yInput.value = pinY.value;
          console.log('[Floor Plan] Coordinates set in modal:', xInput.value, yInput.value);
        } else {
          console.error('[Floor Plan] Modal inputs not found!');
        }
        const modalEl = document.getElementById('pinCreateModal');
        if (modalEl) {
          const modal = new bootstrap.Modal(modalEl);
          modal.show();
          setTimeout(()=>{
            const firstInput = document.querySelector('#pinCreateModal form input[type="text"], #pinCreateModal form textarea, #pinCreateModal form select');
            if (firstInput) firstInput.focus();
          }, 300);
        } else {
          console.error('[Floor Plan] Modal element not found!');
        }
        addingMode = false;
      }
    }
  });

  document.addEventListener('keydown', function(e){
    if(e.key==='Escape' && multipointMode && tempPoints.length>0){
      // Finalizar multipunto: guardar primer punto como origen
      pinX.value = tempPoints[0].x;
      pinY.value = tempPoints[0].y;
      pathPointsInput.value = JSON.stringify(tempPoints);
      alert(I18N.pointsCaptured);
    }
  });

  function renderLines(){
    svg.innerHTML = '';
    if(tempPoints.length < 2) return;
    const rect = img.getBoundingClientRect();
    for(let i=0; i<tempPoints.length-1; i++){
      const p1 = tempPoints[i];
      const p2 = tempPoints[i+1];
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('class','pin-path-line');
      line.setAttribute('x1', p1.x * rect.width);
      line.setAttribute('y1', p1.y * rect.height);
      line.setAttribute('x2', p2.x * rect.width);
      line.setAttribute('y2', p2.y * rect.height);
      svg.appendChild(line);
    }
    tempPoints.forEach(pt=>{
      const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('cx', pt.x * rect.width);
      circle.setAttribute('cy', pt.y * rect.height);
      circle.setAttribute('r', 5);
      circle.setAttribute('class','pin-path-marker');
      svg.appendChild(circle);
      const text = document.createElementNS('http://www.w3.org/2000/svg','text');
      text.setAttribute('x', pt.x * rect.width + 8);
      text.setAttribute('y', pt.y * rect.height - 8);
      text.setAttribute('fill','#28a745');
      text.setAttribute('font-weight','bold');
      text.textContent = pt.label;
      svg.appendChild(text);
    });
  }

  function updatePointsList(){
    if(tempPoints.length===0){ pointsList.innerHTML=''; return; }
    pointsList.innerHTML = 'Puntos: ' + tempPoints.map(p=> `<b>${p.label}</b> (${p.x},${p.y})`).join(', ');
  }

  window.addEventListener('resize', ()=>{ updateSvgSize(); renderLines(); });
  
  // Initialize SVG size after image loads
  if (img.complete) {
    updateSvgSize();
  } else {
    img.addEventListener('load', function() {
      console.log('[Floor Plan] Image loaded, initializing...');
      updateSvgSize();
    });
    img.addEventListener('error', function() {
      console.error('[Floor Plan] Error loading image:', img.src);
      alert('Error: No se pudo cargar la imagen del plano. Por favor, recarga la página.');
    });
  }

  // Auto-switch to edit mode if URL has ?mode=edit or #edit
  (function() {
    const canEdit = {{ can_edit_pins|lower }};
    if (!canEdit) return;
    
    try {
      const params = new URLSearchParams(window.location.search);
      const hash = window.location.hash || '';
      if (params.get('mode') === 'edit' || params.get('edit') === '1' || hash === '#edit') {
        switchToEditMode();
        // Auto-trigger add pin flow if ?mode=edit
        if (params.get('mode') === 'edit') {
          setTimeout(() => startAddPin(), 300);
        }
      }
    } catch (e) {
      console.error('[Floor Plan] Error in auto-edit mode:', e);
    }
  })();

  // Render existing multipoint pins
  const pinsData = {{ pins_json|safe }};
  // (Para renderizar pins existentes con path_points se requiere pasar datos como JSON desde el backend)

  // Popovers para pines: al hacer clic, abrir modal de detalles
  const pinEls = document.querySelectorAll('.plan-pin');
  pinEls.forEach(el => {
    el.addEventListener('click', function(e){
      e.stopPropagation();
      const pinId = this.getAttribute('data-pin-id');
      if (pinId) {
        openPinModal(pinId);
      }
    });
  });

  function openPinModal(pinId) {
    const modal = new bootstrap.Modal(document.getElementById('pinInfoModal'));
    const modalBody = document.getElementById('pinInfoModalBody');
    modalBody.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p class="mt-2">Cargando información del pin...</p></div>';
    modal.show();

    console.log('Loading pin info for ID:', pinId);
    
    fetch(`/pins/${pinId}/info/`, {
      headers: { 'Accept': 'application/json' }
    })
    .then(r => {
      console.log('Response status:', r.status);
      if (!r.ok) {
        return r.text().then(text => {
          console.error('Error response:', text);
          throw new Error(`Server returned ${r.status}: ${text}`);
        });
      }
      return r.json();
    })
    .then(data => {
      console.log('Pin data received:', data);
      renderPinModal(data, pinId);
    })
    .catch(error => {
      console.error('Error loading pin:', error);
      modalBody.innerHTML = `
        <div class="alert alert-danger">
          <h5>Error al cargar la información del pin</h5>
          <p>${error.message || 'Error desconocido'}</p>
          <small class="text-muted">Pin ID: ${pinId}</small>
        </div>
      `;
    });
  }

  function renderPinModal(pin, pinId) {
    const canEdit = pin.can_edit;
    let html = `
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h5 class="mb-1">${escapeHtml(pin.title || 'Pin sin título')}</h5>
            <span class="badge bg-primary">${escapeHtml(pin.pin_type_display || pin.pin_type)}</span>
          </div>
          <div style="width: 30px; height: 30px; border-radius: 50%; background: ${pin.pin_color}; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
        </div>
      </div>

      ${pin.description ? `
        <div class="mb-3">
          <h6 class="text-muted mb-1">${I18N.descLabel}</h6>
          <p>${escapeHtml(pin.description)}</p>
        </div>
      ` : ''}

      ${pin.color_sample ? `
        <div class="mb-3">
          <h6 class="text-muted mb-1">${I18N.approvedColorLabel}</h6>
          <div class="d-flex align-items-center gap-2">
            ${pin.color_sample.hex_color ? `<div style="width: 24px; height: 24px; border-radius: 4px; background: ${pin.color_sample.hex_color}; border: 1px solid #dee2e6;"></div>` : ''}
            <div>
              <strong>${escapeHtml(pin.color_sample.name)}</strong>
              ${pin.color_sample.manufacturer ? `<div class="small text-muted">${escapeHtml(pin.color_sample.manufacturer)} - ${escapeHtml(pin.color_sample.color_code || '')}</div>` : ''}
            </div>
          </div>
        </div>
      ` : ''}

      ${pin.linked_task ? `
        <div class="mb-3">
          <h6 class="text-muted mb-1">${'{% trans "Linked Task" %}'}</h6>
          <div>
            <strong>${escapeHtml(pin.linked_task.title)}</strong>
            <span class="badge bg-info ms-2">${escapeHtml(pin.linked_task.status)}</span>
          </div>
        </div>
      ` : ''}

      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="text-muted mb-0">${I18N.photosLabel} (${pin.attachments.length})</h6>
          ${canEdit ? `
            <button class="btn btn-sm btn-primary" onclick="showAddPhotoForm(${pinId})">
              <i class="bi bi-plus-circle"></i> ${'{% trans "Agregar Foto" %}'}
            </button>
          ` : ''}
        </div>
        ${pin.attachments.length > 0 ? `
          <div class="row g-2">
            ${pin.attachments.map(att => `
              <div class="col-6 col-md-4" id="attachment-${att.id}">
                <div class="position-relative">
                  <img src="${att.image_url}" class="img-fluid rounded" alt="Attachment">
                  ${canEdit ? `
                    <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" 
                            onclick="deleteAttachment(${att.id})"
                            style="opacity: 0.9;">
                      <i class="bi bi-trash"></i>
                    </button>
                  ` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        ` : `<p class="text-muted">${I18N.noPhotosText}</p>`}
      </div>

      ${canEdit ? `
        <div class="border-top pt-3 d-flex gap-2">
          <button class="btn btn-primary btn-sm" onclick="showEditForm(${pinId})">
            <i class="bi bi-pencil"></i> ${I18N.editPin}
          </button>
          ${CAN_DELETE ? `
            <button class="btn btn-danger btn-sm" onclick="deletePin(${pinId})">
              <i class="bi bi-trash"></i> ${I18N.deletePin}
            </button>
          ` : ''}
        </div>
      ` : ''}
    `;

    document.getElementById('pinInfoModalBody').innerHTML = html;
  }

  window.showEditForm = function(pinId) {
    // TODO: Mostrar formulario de edición inline
    alert('Formulario de edición - próximamente');
  };

  window.showAddPhotoForm = function(pinId) {
    const html = `
      <form id="addPhotoForm" enctype="multipart/form-data">
        <div class="mb-3">
          <label class="form-label">${I18N.selectPhotos}</label>
          <input type="file" name="photos" id="pinPhotos" class="form-control" multiple accept="image/*" required>
        </div>
        <div id="pinPhotoPreview" class="row mb-3"></div>
        <button type="button" class="btn btn-primary me-2" id="annotatePinPhotosBtn" disabled>
          <i class="bi bi-pencil-square"></i> ${I18N.annotatePhotos}
        </button>
        <button type="submit" class="btn btn-success">
          <i class="bi bi-upload"></i> ${I18N.uploadPhotos}
        </button>
        <button type="button" class="btn btn-secondary" onclick="openPinModal(${pinId})">
          {% trans "Cancelar" %}
        </button>
      </form>
    `;
    document.getElementById('pinInfoModalBody').innerHTML = html;

    // Handle photo selection
    document.getElementById('pinPhotos').addEventListener('change', function(e) {
      const files = e.target.files;
      const preview = document.getElementById('pinPhotoPreview');
      preview.innerHTML = '';
      
      if (files.length > 0) {
        document.getElementById('annotatePinPhotosBtn').disabled = false;
        
        Array.from(files).forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const col = document.createElement('div');
            col.className = 'col-6 mb-2';
            col.innerHTML = `
              <div class="card">
                <img src="${e.target.result}" class="card-img-top" alt="Photo ${index + 1}">
                <div class="card-body p-2 text-center">
                  <small class="text-muted">${file.name}</small>
                </div>
              </div>
            `;
            preview.appendChild(col);
          };
          reader.readAsDataURL(file);
        });
      } else {
        document.getElementById('annotatePinPhotosBtn').disabled = true;
      }
    });

    // Annotate button
    document.getElementById('annotatePinPhotosBtn')?.addEventListener('click', function() {
      showPinPhotoAnnotator(pinId);
    });

    // Form submit
    document.getElementById('addPhotoForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      // Add annotations if they exist
      window.pinPhotoAnnotations = window.pinPhotoAnnotations || {};
      Object.keys(window.pinPhotoAnnotations).forEach(key => {
        formData.append(key, window.pinPhotoAnnotations[key]);
      });
      
      fetch(`/pins/${pinId}/add-photo/`, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': getCsrfToken()
        }
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          window.pinPhotoAnnotations = {}; // Clear
          openPinModal(pinId); // Reload modal
        } else {
          alert(`${'{% trans "Error:" %}'} ` + (data.error || `${'{% trans "Error desconocido" %}'}`));
        }
      })
      .catch(err => alert(I18N.errorUploadingPhotos));
    });
  };

  function showPinPhotoAnnotator(pinId) {
    const files = document.getElementById('pinPhotos').files;
    const annotationModal = document.getElementById('pinPhotoAnnotationModal');
    const container = document.getElementById('pinAnnotationEditors');
    container.innerHTML = '';
    
    const modal = new bootstrap.Modal(annotationModal);
    modal.show();
    
    Array.from(files).forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function(e) {
        const canvasId = `pinAnnotationCanvas${index}`;
        
        const editorDiv = document.createElement('div');
        editorDiv.className = 'mb-5';
        editorDiv.innerHTML = '<h5 class="mb-3">Foto ' + (index + 1) + ': ' + file.name + '</h5>' +
          '<div class="card">' +
            '<div class="card-body">' +
              '<div class="mb-3">' +
                '<div class="row g-2 align-items-center">' +
                  '<div class="col-auto">' +
                    '<div class="btn-group btn-group-sm" role="group">' +
                      '<button type="button" class="btn btn-outline-primary tool-btn active" data-canvas="' + canvasId + '" data-tool="brush">' +
                        '<i class="bi bi-brush"></i>' +
                      '</button>' +
                      '<button type="button" class="btn btn-outline-primary tool-btn" data-canvas="' + canvasId + '" data-tool="arrow">' +
                        '<i class="bi bi-arrow-up-right"></i>' +
                      '</button>' +
                      '<button type="button" class="btn btn-outline-primary tool-btn" data-canvas="' + canvasId + '" data-tool="rectangle">' +
                        '<i class="bi bi-square"></i>' +
                      '</button>' +
                      '<button type="button" class="btn btn-outline-primary tool-btn" data-canvas="' + canvasId + '" data-tool="circle">' +
                        '<i class="bi bi-circle"></i>' +
                      '</button>' +
                      '<button type="button" class="btn btn-outline-primary tool-btn" data-canvas="' + canvasId + '" data-tool="text">' +
                        '<i class="bi bi-fonts"></i>' +
                      '</button>' +
                    '</div>' +
                  '</div>' +
                  '<div class="col-auto">' +
                    '<input type="color" class="form-control form-control-sm form-control-color" id="pinColor' + index + '" value="#ff0000">' +
                  '</div>' +
                  '<div class="col-auto">' +
                    '<input type="range" class="form-range" id="pinWidth' + index + '" min="1" max="10" value="3" style="width: 120px;">' +
                    '<small id="pinWidthDisplay' + index + '">3px</small>' +
                  '</div>' +
                  '<div class="col-auto ms-auto">' +
                    '<button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.pinAnnotator' + index + '.undo()">' +
                      '<i class="bi bi-arrow-counterclockwise"></i>' +
                    '</button>' +
                    '<button type="button" class="btn btn-outline-danger btn-sm" onclick="if(confirm(\'¿Limpiar?\')) window.pinAnnotator' + index + '.clear()">' +
                      '<i class="bi bi-trash"></i>' +
                    '</button>' +
                  '</div>' +
                '</div>' +
              '</div>' +
              '<div class="text-center" style="background: #f8f9fa; padding: 20px;">' +
                '<canvas id="' + canvasId + '"></canvas>' +
              '</div>' +
            '</div>' +
          '</div>';
        
        container.appendChild(editorDiv);
        
        const annotator = new PhotoAnnotator(canvasId, e.target.result, null);
        annotator.init().then(() => {
          window[`pinAnnotator${index}`] = annotator;
          
          document.querySelectorAll(`[data-canvas="${canvasId}"]`).forEach(btn => {
            btn.addEventListener('click', function() {
              const tool = this.getAttribute('data-tool');
              document.querySelectorAll(`[data-canvas="${canvasId}"]`).forEach(b => b.classList.remove('active'));
              this.classList.add('active');
              
              if (tool === 'text') {
                annotator.addText();
              } else {
                annotator.setTool(tool);
              }
            });
          });
          
          document.getElementById(`pinColor${index}`).addEventListener('change', function() {
            annotator.setColor(this.value);
          });
          
          document.getElementById(`pinWidth${index}`).addEventListener('input', function() {
            annotator.setBrushWidth(parseInt(this.value));
            document.getElementById(`pinWidthDisplay${index}`).textContent = this.value + 'px';
          });
          
          setInterval(() => {
            window.pinPhotoAnnotations = window.pinPhotoAnnotations || {};
            window.pinPhotoAnnotations[`annotations_${index}`] = annotator.getAnnotations();
          }, 2000);
        });
      };
      reader.readAsDataURL(file);
    });
  }

  window.deleteAttachment = function(attachmentId) {
    if (!confirm(I18N.confirmDeletePhoto)) return;

    fetch(`/pins/attachments/${attachmentId}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCsrfToken()
      }
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        document.getElementById(`attachment-${attachmentId}`).remove();
      }
    });
  };

  window.deletePin = function(pinId) {
    if (!confirm(I18N.confirmDeletePin)) return;

    fetch(`/api/v1/plan-pins/${pinId}/`, {
      method: 'DELETE',
      headers: {
        'X-CSRFToken': getCsrfToken(),
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      if (response.ok) {
        // Close modal and reload page to update pins
        const modal = bootstrap.Modal.getInstance(document.getElementById('pinInfoModal'));
        if (modal) modal.hide();
        
        // Show success message
        alert('{% trans "Pin eliminado exitosamente" %}');
        
        // Reload page to refresh pins
        window.location.reload();
      } else {
        alert('{% trans "Error al eliminar el pin" %}');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('{% trans "Error al eliminar el pin" %}');
    });
  };

  function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
  }

  // util: escape básico para contenido HTML
  function escapeHtml(str){
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }
  
  // Attach event listeners to mode toggle and add pin buttons
  const addPinBtn = document.getElementById('addPinBtn');
  if (addPinBtn) {
    addPinBtn.addEventListener('click', function() {
      if (typeof window.startAddPin === 'function') {
        window.startAddPin();
      }
    });
  }
  
  const viewModeBtn = document.getElementById('viewModeBtn');
  if (viewModeBtn) {
    viewModeBtn.addEventListener('click', function() {
      if (typeof window.switchToViewMode === 'function') {
        window.switchToViewMode();
      }
    });
  }
  
  const editModeBtn = document.getElementById('editModeBtn');
  if (editModeBtn) {
    editModeBtn.addEventListener('click', function() {
      if (typeof window.switchToEditMode === 'function') {
        window.switchToEditMode();
      }
    });
  }
  
  const topEditPinsBtn = document.getElementById('topEditPinsBtn');
  if (topEditPinsBtn) {
    topEditPinsBtn.addEventListener('click', function() {
      if (typeof window.switchToEditMode === 'function') {
        window.switchToEditMode();
        document.getElementById('planWrapper').scrollIntoView({behavior:'smooth', block:'center'});
      }
    });
  }

  // --- Pan & Zoom Implementation ---
  const planWrapper = document.getElementById('planWrapper');
  // scale already declared above, reusing it
  let panning = false;
  let pointX = 0;
  let pointY = 0;
  let startX = 0;
  let startY = 0;

  if (planWrapper) {
      planWrapper.style.transformOrigin = '0 0';
      planWrapper.style.transform = 'scale(1) translate(0px, 0px)';

      // Zoom with wheel
      planWrapper.addEventListener('wheel', function(e) {
          if (e.ctrlKey || e.metaKey) {
              e.preventDefault();
              const xs = (e.clientX - pointX) / scale;
              const ys = (e.clientY - pointY) / scale;
              const delta = -Math.sign(e.deltaY);
              
              if (delta > 0) {
                  scale *= 1.1;
              } else {
                  scale /= 1.1;
              }
              
              // Limit scale
              scale = Math.min(Math.max(0.5, scale), 5);

              pointX = e.clientX - xs * scale;
              pointY = e.clientY - ys * scale;

              planWrapper.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
          }
      });

      // Pan with drag (only in view mode or if middle mouse button)
      planWrapper.addEventListener('mousedown', function(e) {
          if (e.button === 1 || (e.button === 0 && planWrapper.classList.contains('view-mode'))) {
              e.preventDefault();
              startX = e.clientX - pointX;
              startY = e.clientY - pointY;
              panning = true;
              planWrapper.style.cursor = 'grabbing';
          }
      });

      document.addEventListener('mousemove', function(e) {
          if (!panning) return;
          e.preventDefault();
          pointX = e.clientX - startX;
          pointY = e.clientY - startY;
          planWrapper.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
      });

      document.addEventListener('mouseup', function() {
          panning = false;
          if (planWrapper.classList.contains('view-mode')) {
              planWrapper.style.cursor = 'default';
          } else {
              planWrapper.style.cursor = 'crosshair';
          }
      });
  }
})();
</script>

<!-- Load Photo Annotator Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script>
// Check if photo-annotator.js exists, otherwise provide a stub
if (typeof PhotoAnnotator === 'undefined') {
  window.PhotoAnnotator = class {
    constructor() {}
    init() { return Promise.resolve(); }
    setTool() {}
    setColor() {}
    setBrushWidth() {}
    addText() {}
    undo() {}
    clear() {}
    getAnnotations() { return {}; }
  };
  console.warn('[Floor Plan] PhotoAnnotator not loaded, using stub');
}
</script>
<script src="{% static 'core/js/photo-annotator.js' %}" onerror="console.warn('photo-annotator.js not found')"></script>

<!-- Pin Create Modal (one-click add) -->
{% if can_edit_pins %}
<div class="modal fade" id="pinCreateModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'floor_plan_add_pin' plan.id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pin-map"></i> Nuevo Pin</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="x" id="pinXModal">
          <input type="hidden" name="y" id="pinYModal">
          <input type="hidden" name="is_multipoint" value="false">
          <input type="hidden" name="path_points" value="[]">

          <div class="mb-3">
            <label for="id_title" class="form-label">Título del pin <span class="text-danger">*</span></label>
            <input type="text" name="title" id="id_title" class="form-control" required placeholder="Ej: Reparar grieta, Pintar pared...">
          </div>
          
          <div class="mb-3">
            <label for="id_description" class="form-label">Descripción</label>
            <textarea name="description" id="id_description" class="form-control" rows="3" placeholder="Detalles adicionales..."></textarea>
          </div>
          
          <div class="mb-3">
            <label for="id_pin_type" class="form-label">Tipo de pin</label>
            <select name="pin_type" id="id_pin_type" class="form-select">
              <option value="note">Nota</option>
              <option value="touchup" selected>Touch-up</option>
              <option value="color">Color</option>
              <option value="alert">Alerta</option>
              <option value="damage">Daño</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Color aprobado (opcional)</label>
            <select name="color_sample" class="form-select">
              <option value="">— Selecciona —</option>
              {% for c in color_samples %}
                <option value="{{ c.id }}">{{ c.name|default:c.code }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="create_task" id="createTaskModal">
            <label class="form-check-label" for="createTaskModal">
              <strong>Crear tarea touch-up</strong>
              <small class="d-block text-muted">Se notificará al PM para asignar a un empleado</small>
            </label>
          </div>
          
          <div class="alert alert-success py-2 small">
            <i class="bi bi-check-circle"></i> Pin posicionado. Completa la información y guarda.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar pin</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<!-- Pin Info Modal -->
<div class="modal fade" id="pinInfoModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Información del Pin</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="pinInfoModalBody">
        <!-- Content loaded via AJAX -->
      </div>
    </div>
  </div>
</div>

<!-- Pin Photo Annotation Modal -->
<div class="modal fade" id="pinPhotoAnnotationModal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-pencil-square"></i> Anotar Fotos del Pin
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <div id="pinAnnotationEditors"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
          <i class="bi bi-check"></i> Guardar Anotaciones
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
