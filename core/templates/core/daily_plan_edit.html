{% extends "core/base_modern.html" %}
{% load i18n %}

{% block title %}{% trans "Edit Daily Plan" %} - {{ plan.project.name }}{% endblock %}

{% block extra_css %}
<style>
    /* ===== GLOBAL OVERFLOW PREVENTION ===== */
    * {
        box-sizing: border-box;
    }
    
    body {
        overflow-x: hidden;
        max-width: 100vw;
    }
    
    .container-fluid,
    .row,
    .card,
    .card-body,
    .card-header,
    .list-group,
    .list-group-item,
    .modal-content,
    .breadcrumb {
        max-width: 100%;
        overflow-x: hidden;
    }
    
    /* Force all text to wrap */
    h1, h2, h3, h4, h5, h6,
    p, span, div, label {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    /* Mobile responsive fixes */
    @media (max-width: 767.98px) {
        body {
            overflow-x: hidden;
        }
        
        .container-fluid {
            max-width: 100vw;
            overflow-x: hidden;
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }
        
        /* Fix Bootstrap row negative margins */
        .row {
            margin-left: 0 !important;
            margin-right: 0 !important;
            max-width: 100%;
        }
        
        .row > * {
            padding-left: 0.25rem !important;
            padding-right: 0.25rem !important;
        }
        
        .card {
            overflow: hidden;
            margin-bottom: 0.75rem;
        }
        
        .card-header {
            padding: 0.75rem !important;
            overflow-x: hidden;
        }
        
        .card-body {
            padding: 0.5rem !important;
            overflow-x: hidden;
        }
        
        .badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.4rem;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .list-group-item {
            word-wrap: break-word;
            overflow-wrap: break-word;
            padding: 0.75rem 0.5rem !important;
            overflow-x: hidden;
        }
        
        /* Fix flex items that can overflow */
        .d-flex {
            max-width: 100%;
        }
        
        .flex-wrap {
            flex-wrap: wrap !important;
        }
        
        /* Ensure buttons don't overflow */
        .btn {
            white-space: normal;
            word-wrap: break-word;
            max-width: 100%;
        }
        
        .btn-sm {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* Fix breadcrumb */
        .breadcrumb {
            font-size: 0.85rem;
            flex-wrap: wrap;
            overflow-x: hidden;
        }
        
        .breadcrumb-item {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Fix truncated text elements */
        .text-truncate {
            max-width: 100% !important;
        }
        
        /* Fix inline-block elements */
        span.d-inline-block {
            max-width: calc(100% - 45px) !important;
        }
        
        /* Modal full width on small screens */
        .modal-dialog {
            margin: 0.5rem;
            max-width: calc(100% - 1rem);
        }
        
        .modal-body {
            padding: 0.75rem !important;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .modal-header {
            padding: 0.75rem !important;
        }
        
        .modal-footer {
            padding: 0.75rem !important;
        }
        
        .modal-title {
            font-size: 1rem !important;
        }
        
        .form-label {
            font-size: 0.8rem !important;
            margin-bottom: 0.25rem !important;
        }
        
        .form-control,
        .form-select {
            font-size: 0.85rem !important;
            padding: 0.375rem 0.5rem !important;
            max-width: 100%;
        }
        
        .mb-3 {
            margin-bottom: 0.75rem !important;
        }
        
        textarea.form-control {
            min-height: 60px;
        }
        
        /* Fix gap utilities */
        .gap-1 {
            gap: 0.25rem !important;
        }
        
        .gap-2 {
            gap: 0.5rem !important;
        }
        
        /* Alert responsive */
        .alert {
            font-size: 0.85rem;
            padding: 0.5rem;
        }
        
        /* Fix sidebar cards */
        .col-lg-4 .card {
            overflow-x: hidden;
        }
        
        .col-lg-4 .card-body {
            padding: 0.75rem !important;
        }
        
        /* Fix action buttons in sidebar */
        .w-100 {
            max-width: 100%;
        }
        
        /* Fix small text */
        .small,
        small {
            font-size: 0.85rem !important;
        }
        
        /* Fix forms inside cards */
        form {
            max-width: 100%;
            overflow-x: hidden;
        }
        
        /* Fix h6 titles */
        h6 {
            font-size: 0.9rem;
        }
        
        /* Fix activity details */
        .flex-grow-1 {
            min-width: 0 !important;
            max-width: 100%;
        }

        /* Ensure the right-side icon/button column never forces width */
        .ms-2 {
            margin-left: 0.25rem !important;
            flex: 0 0 auto;
        }

        /* Prevent very long project/team/user strings from expanding layout */
        .breadcrumb-item,
        .card-header h5,
        .card-header h6,
        .text-muted,
        .small {
            min-width: 0;
        }

        /* Make truncation reliable without brittle inline calc() widths */
        .activity-title-truncate {
            display: block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Fix materials and status text */
        .text-muted {
            word-wrap: break-word;
        }
        

        /* If any element still overflows, this ensures the page doesn't scroll horizontally */
        html {
            overflow-x: hidden;
        }

    }
    
    /* Tablet responsiveness */
    @media (min-width: 768px) and (max-width: 991.98px) {
        .container-fluid {
            padding-left: 1rem;
            padding-right: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-2 px-md-4">
    <div class="row mb-3 mb-md-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="{% url 'daily_planning_dashboard' %}">{% trans "Daily Planning" %}</a></li>
                    <li class="breadcrumb-item active d-none d-md-inline">{{ plan.project.name }} - {{ plan.plan_date }}</li>
                    <li class="breadcrumb-item active d-md-none">{{ plan.project.name }}</li>
                </ol>
            </nav>
            <h2 class="h4 h-md-2">{% trans "Edit Daily Plan" %}</h2>
            <p class="text-muted small mb-2">
                <strong>{% trans "Project:" %}</strong> <span class="d-inline d-md-none">{{ plan.project.name|truncatechars:20 }}</span><span class="d-none d-md-inline">{{ plan.project.name }}</span><br class="d-md-none">
                <strong>{% trans "Date:" %}</strong> {{ plan.plan_date|date:"M d" }}<br class="d-md-none"> 
                <strong>{% trans "Status:" %}</strong> 
                {% if plan.status == 'DRAFT' %}
                <span class="badge bg-secondary">{% trans "Draft" %}</span>
                {% elif plan.status == 'SUBMITTED' %}
                <span class="badge bg-info">{% trans "Submitted" %}</span>
                {% elif plan.status == 'APPROVED' %}
                <span class="badge bg-success">{% trans "Approved" %}</span>
                {% endif %}
            </p>
            
            {% if plan.is_overdue %}
            <div class="alert alert-danger py-2 small">
                <i class="bi bi-exclamation-triangle-fill"></i> 
                {% trans "This plan is overdue! Deadline was:" %} {{ plan.completion_deadline }}
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row mb-3 g-2">
        <div class="col-12 col-sm-6 col-md-auto">
            <form method="post" style="display:inline;" class="w-100">
                {% csrf_token %}
                <input type="hidden" name="action" value="check_materials">
                <button type="submit" class="btn btn-outline-primary btn-sm w-100">
                    <i class="bi bi-search"></i> <span class="d-none d-sm-inline">{% trans "Check materials" %}</span><span class="d-sm-none">{% trans "Materials" %}</span>
                </button>
            </form>
        </div>
        <div class="col-12 col-sm-6 col-md-auto">
            <form method="post" style="display:inline;" class="w-100" onsubmit="return confirm('{% trans 'Copy all employees from yesterday to today activities?' %}');">
                {% csrf_token %}
                <input type="hidden" name="action" value="copy_yesterday_team">
                <button type="submit" class="btn btn-outline-success btn-sm w-100">
                    <i class="bi bi-arrow-repeat"></i> <span class="d-none d-sm-inline">{% trans "Copy Yesterday's Team" %}</span><span class="d-sm-none">{% trans "Copy Team" %}</span>
                </button>
            </form>
        </div>
    </div>
    <div class="row">
        <!-- Activities list - Full width on mobile, 8 cols on desktop -->
        <div class="col-12 col-lg-8 mb-3 mb-lg-0">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="mb-0">{% trans "Activities" %} ({{ activities.count }})</h5>
                    {% if plan.status == 'DRAFT' %}
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addActivityModal">
                        <i class="bi bi-plus-circle"></i> <span class="d-none d-sm-inline">{% trans "Add Activity" %}</span><span class="d-sm-none">{% trans "Add" %}</span>
                    </button>
                    {% endif %}
                </div>
                <div class="card-body p-2 p-md-3">
                    {% if activities %}
                    <div class="list-group">
                        {% for activity in activities %}
                        <div class="list-group-item p-2 p-md-3">
                            <div class="d-flex justify-content-between align-items-start flex-wrap flex-md-nowrap gap-2">
                                <div class="flex-grow-1" style="min-width: 0;">
                                    <h6 class="mb-1 small">
                                        <span class="badge bg-secondary me-1">{{ activity.order }}</span>
                                        <span class="activity-title-truncate">{{ activity.title }}</span>
                                    </h6>
                                    
                                    {% if activity.description %}
                                    <p class="mb-2 text-muted small" style="font-size: 0.85rem;">{{ activity.description|truncatewords:20 }}</p>
                                    {% endif %}
                                    
                                    <div class="mb-2 d-flex flex-wrap gap-1">
                                        {% if activity.activity_template %}
                                        <span class="badge bg-info small">
                                            <i class="bi bi-book"></i> <span class="d-none d-sm-inline">SOP:</span> {{ activity.activity_template.name|truncatechars:15 }}
                                        </span>
                                        {% endif %}
                                        
                                        {% if activity.schedule_item %}
                                        <span class="badge bg-success small">
                                            <i class="bi bi-calendar-check"></i> <span class="d-none d-sm-inline">Schedule:</span> {{ activity.schedule_item.title|truncatechars:15 }}
                                        </span>
                                        {% endif %}
                                        
                                        {% if activity.estimated_hours %}
                                        <span class="badge bg-warning text-dark small">
                                            <i class="bi bi-clock"></i> {{ activity.estimated_hours }}h
                                        </span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mb-2">
                                        <strong class="small">{% trans "Assigned:" %}</strong>
                                        <div class="d-flex flex-wrap gap-1 mt-1">
                                            {% for emp in activity.assigned_employees.all %}
                                            <span class="badge bg-secondary small">{{ emp.first_name }} {{ emp.last_name|truncatechars:10 }}</span>
                                            {% empty %}
                                            <span class="text-muted small">{% trans "No one assigned yet" %}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    {% if activity.materials_needed %}
                                    <div class="small" style="font-size: 0.85rem;">
                                        <strong>{% trans "Materials:" %}</strong>
                                        <span class="text-muted">{{ activity.materials_needed|length }} items{% if activity.materials_checked %} Â· {% if activity.material_shortage %}<span class='text-danger'>{% trans "Shortage" %}</span>{% else %}<span class='text-success'>{% trans "OK" %}</span>{% endif %}{% endif %}</span>
                                        {% if activity.material_shortage %}
                                        <span class="badge bg-danger small">{% trans "Shortage!" %}</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mt-2">
                                        <span class="badge small
                                            {% if activity.status == 'COMPLETED' %}bg-success
                                            {% elif activity.status == 'IN_PROGRESS' %}bg-primary
                                            {% elif activity.status == 'BLOCKED' %}bg-danger
                                            {% else %}bg-secondary
                                            {% endif %}">
                                            {{ activity.get_status_display }}
                                        </span>
                                        
                                        {% if activity.progress_percentage > 0 %}
                                        <span class="small text-muted">{{ activity.progress_percentage }}%</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                {% if plan.status == 'DRAFT' %}
                                <div class="ms-2">
                                    <form method="post" action="{% url 'daily_plan_delete_activity' activity.id %}" onsubmit="return confirm('{% trans 'Delete this activity?' %}');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4 py-md-5">
                        <i class="bi bi-clipboard-x" style="font-size: 2rem; color: #ccc;"></i>
                        <p class="text-muted mt-3 small">{% trans "No activities added yet. Click 'Add Activity' to start." %}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Actions sidebar - Full width on mobile, 4 cols on desktop -->
        <div class="col-12 col-lg-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0 small">{% trans "Actions" %}</h6>
                </div>
                <div class="card-body p-2 p-md-3">
                    {% if plan.status == 'DRAFT' %}
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="submit">
                        <button type="submit" class="btn btn-success w-100 mb-2 btn-sm" {% if not activities %}disabled{% endif %}>
                            <i class="bi bi-check-circle"></i> {% trans "Submit Plan" %}
                        </button>
                    </form>
                    
                    {% if not activities %}
                    <p class="small text-muted mb-2" style="font-size: 0.85rem;">{% trans "Add at least one activity before submitting" %}</p>
                    {% endif %}
                    {% endif %}
                    
                    <a href="{% url 'daily_planning_dashboard' %}" class="btn btn-outline-secondary w-100 btn-sm">
                        <i class="bi bi-arrow-left"></i> {% trans "Back to Dashboard" %}
                    </a>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0 small">{% trans "Quick Links" %}</h6>
                </div>
                <div class="card-body p-2 p-md-3">
                    <a href="{% url 'sop_library' %}" class="btn btn-outline-info w-100 mb-2 btn-sm" target="_blank">
                        <i class="bi bi-book"></i> {% trans "Browse SOPs" %}
                    </a>
                    <a href="{% url 'project_overview' plan.project.id %}" class="btn btn-outline-primary w-100 btn-sm">
                        <i class="bi bi-folder"></i> {% trans "View Project" %}
                    </a>
                </div>
            </div>
            
            <div class="card d-none d-lg-block">
                <div class="card-header">
                    <h6 class="mb-0 small">{% trans "Plan Info" %}</h6>
                </div>
                <div class="card-body small">
                    <p><strong>{% trans "Created by:" %}</strong> {{ plan.created_by.username }}</p>
                    <p><strong>{% trans "Created:" %}</strong> {{ plan.created_at|date:"M d, Y H:i" }}</p>
                    <p><strong>{% trans "Deadline:" %}</strong> {{ plan.completion_deadline|date:"M d, Y H:i" }}</p>
                    {% if plan.approved_by %}
                    <p><strong>{% trans "Approved by:" %}</strong> {{ plan.approved_by.username }}</p>
                    <p><strong>{% trans "Approved:" %}</strong> {{ plan.approved_at|date:"M d, Y H:i" }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Activity Modal -->
<div class="modal fade" id="addActivityModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_activity">
                
                <div class="modal-header py-2">
                    <h5 class="modal-title h6">{% trans "Add Activity" %}</h5>
                    <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal"></button>
                </div>
                
                <div class="modal-body p-2">
                    <div class="mb-2">
                        <label class="form-label small mb-1">{% trans "Activity Template (SOP)" %} <small class="text-muted">{% trans "(optional)" %}</small></label>
                        <select name="activity_template" id="templateSelect" class="form-select form-select-sm">
                            <option value="">-- {% trans "Select SOP template" %} --</option>
                            {% for template in available_templates %}
                            <option value="{{ template.id }}" 
                                    data-name="{{ template.name }}"
                                    data-description="{{ template.description }}"
                                    data-hours="{{ template.time_estimate|default:'' }}">
                                {{ template.get_category_display }} - {{ template.name|truncatechars:30 }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label small mb-1">{% trans "Link to Schedule Item" %} <small class="text-muted">{% trans "(optional)" %}</small></label>
                        <select name="schedule_item" class="form-select form-select-sm">
                            <option value="">-- {% trans "Not linked to schedule" %} --</option>
                            {% for item in schedule_items %}
                            <option value="{{ item.id }}">{{ item.title|truncatechars:30 }} ({{ item.start_datetime|date:"M d" }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label small mb-1">{% trans "Activity Title" %} *</label>
                        <input type="text" name="title" id="activityTitle" class="form-control form-control-sm" required>
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label small mb-1">{% trans "Description" %}</label>
                        <textarea name="description" id="activityDescription" class="form-control form-control-sm" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label small mb-1">{% trans "Estimated Hours" %}</label>
                        <input type="number" name="estimated_hours" id="estimatedHours" class="form-control form-control-sm" step="0.5" min="0">
                    </div>
                    
                    <div class="mb-2">
                        <label class="form-label small mb-1">{% trans "Assign Employees" %}</label>
                        <select name="assigned_employees" class="form-select form-select-sm" multiple size="3">
                            {% for emp in employees %}
                            <option value="{{ emp.id }}">{{ emp.first_name }} {{ emp.last_name }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted d-block mt-1" style="font-size: 0.7rem;">{% trans "Hold Ctrl/Cmd to select multiple employees" %}</small>
                    </div>
                </div>
                
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle"></i> {% trans "Add Activity" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Auto-fill form when SOP template is selected
if (document.getElementById('templateSelect')) {
    document.getElementById('templateSelect').addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    if (selected.value) {
        document.getElementById('activityTitle').value = selected.dataset.name || '';
        document.getElementById('activityDescription').value = selected.dataset.description || '';
        document.getElementById('estimatedHours').value = selected.dataset.hours || '';
    }
    });
}
</script>

{% endblock %}
