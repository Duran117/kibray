{% extends "core/base_modern.html" %}
{% load i18n static %}

{% block title %}{% trans "Cost Codes" %} - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
.costcodes-wrapper { min-height: 100vh; background: #f8fafc; padding: 2rem; }
.costcodes-header { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 16px; padding: 2rem; color: white; margin-bottom: 2rem; }
.costcodes-header .btn-back { display: inline-flex; align-items: center; gap: 0.5rem; color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.9rem; margin-bottom: 1rem; }
.costcodes-header .btn-back:hover { color: white; }
.costcodes-header h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
.costcodes-header p { color: rgba(255,255,255,0.7); margin: 0; }
.financial-nav { display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap; }
.nav-tab { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: white; border: 1px solid #e2e8f0; border-radius: 10px; color: #64748b; text-decoration: none; font-weight: 500; font-size: 0.9rem; }
.nav-tab:hover { background: #f8fafc; color: #334155; }
.nav-tab.active { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-color: transparent; color: white; }
.content-grid { display: grid; grid-template-columns: 1fr 320px; gap: 2rem; }
@media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } }
.category-section { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 1rem; overflow: hidden; }
.category-header { padding: 0.75rem 1rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #334155; }
.category-count { margin-left: auto; font-size: 0.8rem; color: #64748b; font-weight: normal; }
.code-list { padding: 0; margin: 0; list-style: none; }
.code-item { display: flex; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9; gap: 0.75rem; }
.code-item:last-child { border-bottom: none; }
.code-item:hover { background: #fafbfc; }
.code-badge { padding: 0.35rem 0.6rem; background: #1e293b; color: white; border-radius: 5px; font-family: monospace; font-size: 0.8rem; font-weight: 600; min-width: 70px; text-align: center; }
.code-name { flex: 1; color: #334155; }
.code-status { font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 9999px; }
.code-status.active { background: #d1fae5; color: #065f46; }
.code-status.inactive { background: #fee2e2; color: #991b1b; }
.code-actions { display: flex; gap: 0.25rem; }
.btn-icon { padding: 0.3rem 0.4rem; background: transparent; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; color: #64748b; font-size: 0.8rem; }
.btn-icon:hover { background: #f1f5f9; color: #334155; }
.btn-icon.danger:hover { background: #fef2f2; border-color: #fecaca; color: #dc2626; }
.form-card { background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); position: sticky; top: 1rem; }
.form-card h3 { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
.form-group { margin-bottom: 0.875rem; }
.form-group label { display: block; font-size: 0.75rem; font-weight: 500; color: #64748b; margin-bottom: 0.25rem; }
.form-group input, .form-group select { width: 100%; padding: 0.6rem 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.875rem; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
.form-group small { font-size: 0.7rem; color: #94a3b8; }
.btn-submit { width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
.btn-submit:hover { opacity: 0.9; }
.btn-submit.editing { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
.btn-cancel { width: 100%; padding: 0.5rem; background: #f1f5f9; border: none; border-radius: 6px; cursor: pointer; margin-top: 0.5rem; font-size: 0.8rem; }
.empty-state { padding: 2rem; text-align: center; color: #94a3b8; }
</style>
{% endblock %}

{% block content %}
<div class="costcodes-wrapper">
    <div class="costcodes-header">
        <a href="{% url 'project_financials_hub' project.id %}" class="btn-back"><i class="bi bi-arrow-left"></i> {% trans "Back to Financials" %}</a>
        <h1><i class="bi bi-tags"></i> {% trans "Cost Codes" %}</h1>
        <p>{% trans "Categorize and track project costs" %}</p>
    </div>
    <div class="financial-nav">
        <a href="{% url 'project_financials_hub' project.id %}" class="nav-tab"><i class="bi bi-grid"></i> {% trans "Overview" %}</a>
        <a href="{% url 'project_budget_detail' project.id %}" class="nav-tab"><i class="bi bi-wallet2"></i> {% trans "Budget" %}</a>
        <a href="{% url 'project_cost_codes' project.id %}" class="nav-tab active"><i class="bi bi-tags"></i> {% trans "Cost Codes" %}</a>
        <a href="{% url 'project_estimates' project.id %}" class="nav-tab"><i class="bi bi-calculator"></i> {% trans "Estimates" %}</a>
    </div>
    <div class="content-grid">
        <div>
            {% for category, codes in codes_by_category.items %}
            <div class="category-section">
                <div class="category-header"><i class="bi bi-tag"></i> {{ category }} <span class="category-count">{{ codes|length }}</span></div>
                <ul class="code-list">
                    {% for code in codes %}
                    <li class="code-item">
                        <span class="code-badge">{{ code.code }}</span>
                        <span class="code-name">{{ code.name }}</span>
                        <span class="code-status {% if code.active %}active{% else %}inactive{% endif %}">{% if code.active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}</span>
                        {% if can_edit %}
                        <div class="code-actions">
                            <button type="button" class="btn-icon" onclick="editCode({{ code.id }},'{{ code.code }}','{{ code.name|escapejs }}','{{ code.category|escapejs }}',{{ code.active|yesno:'true,false' }})" title="{% trans 'Edit' %}"><i class="bi bi-pencil"></i></button>
                            <button type="button" class="btn-icon danger" onclick="deleteCode({{ code.id }},'{{ code.code }}')" title="{% trans 'Delete' %}"><i class="bi bi-trash"></i></button>
                        </div>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% empty %}
            <div class="category-section"><div class="empty-state"><i class="bi bi-inbox" style="font-size:2rem;"></i><p>{% trans "No cost codes yet." %}</p></div></div>
            {% endfor %}
        </div>
        {% if can_edit %}
        <div>
            <form method="post" class="form-card" id="costCodeForm">
                {% csrf_token %}
                <input type="hidden" name="action" id="formAction" value="create">
                <input type="hidden" name="costcode_id" id="costcodeId" value="">
                <h3 id="formTitle"><i class="bi bi-plus-circle"></i> {% trans "Add Cost Code" %}</h3>
                <div class="form-group">
                    <label>{% trans "Code" %} *</label>
                    <input type="text" name="code" id="inputCode" required maxlength="20" placeholder="WIN, DOR..." style="text-transform:uppercase;">
                </div>
                <div class="form-group">
                    <label>{% trans "Name" %} *</label>
                    <input type="text" name="name" id="inputName" required placeholder="{% trans 'Description' %}">
                </div>
                <div class="form-group">
                    <label>{% trans "Category" %}</label>
                    <input type="text" name="category" id="inputCategory" list="categoryList" placeholder="{% trans 'Type or select...' %}">
                    <datalist id="categoryList">{% for cat in categories %}<option value="{{ cat }}">{% endfor %}</datalist>
                    <small>{% trans "Type any category" %}</small>
                </div>
                <div class="form-group" id="activeGroup" style="display:none;">
                    <label style="display:flex;align-items:center;gap:0.5rem;"><input type="checkbox" name="active" id="inputActive" checked> {% trans "Active" %}</label>
                </div>
                <button type="submit" class="btn-submit" id="submitBtn"><i class="bi bi-plus-lg"></i> <span id="submitText">{% trans "Create" %}</span></button>
                <button type="button" class="btn-cancel" id="cancelBtn" onclick="resetForm()" style="display:none;">{% trans "Cancel" %}</button>
            </form>
        </div>
        {% endif %}
    </div>
</div>
<script>
function editCode(id,code,name,category,active){
    document.getElementById('formAction').value='update';
    document.getElementById('costcodeId').value=id;
    document.getElementById('inputCode').value=code;
    document.getElementById('inputName').value=name;
    document.getElementById('inputCategory').value=category;
    document.getElementById('inputActive').checked=active;
    document.getElementById('formTitle').innerHTML='<i class="bi bi-pencil"></i> Edit';
    document.getElementById('submitText').textContent='Save';
    document.getElementById('submitBtn').classList.add('editing');
    document.getElementById('activeGroup').style.display='block';
    document.getElementById('cancelBtn').style.display='block';
    document.getElementById('inputCode').focus();
}
function resetForm(){
    document.getElementById('costCodeForm').reset();
    document.getElementById('formAction').value='create';
    document.getElementById('costcodeId').value='';
    document.getElementById('formTitle').innerHTML='<i class="bi bi-plus-circle"></i> Add Cost Code';
    document.getElementById('submitText').textContent='Create';
    document.getElementById('submitBtn').classList.remove('editing');
    document.getElementById('activeGroup').style.display='none';
    document.getElementById('cancelBtn').style.display='none';
}
function deleteCode(id,code){
    if(confirm('Delete "'+code+'"?')){
        var f=document.createElement('form');f.method='POST';
        f.innerHTML='<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}"><input type="hidden" name="action" value="delete"><input type="hidden" name="costcode_id" value="'+id+'">';
        document.body.appendChild(f);f.submit();
    }
}
</script>
{% endblock %}
