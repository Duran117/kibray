{% extends "core/base_modern.html" %}
{% load static %}
{% load i18n %}

{% block title %}{{ client.get_full_name }} - {% trans "Cliente" %} - Kibray{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Botón de regreso -->
    <div class="mb-3">
        <a href="{% url 'client_list' %}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>
            {% trans "Volver a Clientes" %}
        </a>
    </div>

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'dashboard_admin' %}">
                    <i class="bi bi-house-door"></i> {% trans "Dashboard" %}
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'client_list' %}">{% trans "Clientes" %}</a>
            </li>
            <li class="breadcrumb-item active">{{ client.get_full_name }}</li>
        </ol>
    </nav>

    <!-- Header con acciones -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div class="d-flex align-items-center">
                    <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px; font-size: 24px;">
                        {{ client.first_name|slice:":1" }}{{ client.last_name|slice:":1" }}
                    </div>
                    <div>
                        <h1 class="h3 mb-1">{{ client.get_full_name }}</h1>
                        <p class="text-muted mb-0">
                            <i class="bi bi-person-badge me-1"></i> {% trans "Cliente" %}
                            {% if not client.is_active %}
                                <span class="badge bg-danger ms-2">{% trans "Inactivo" %}</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
                
                <div class="btn-group" role="group">
                    <a href="{% url 'client_edit' client.id %}" class="btn btn-outline-primary">
                        <i class="bi bi-pencil me-1"></i> {% trans "Editar" %}
                    </a>
                    <a href="{% url 'client_assign_project' client.id %}" class="btn btn-outline-info">
                        <i class="bi bi-folder-plus me-1"></i> {% trans "Asignar Proyecto" %}
                    </a>
                    <a href="{% url 'client_reset_password' client.id %}" class="btn btn-outline-warning">
                        <i class="bi bi-key me-1"></i> {% trans "Resetear Contraseña" %}
                    </a>
                    <a href="{% url 'client_delete' client.id %}" class="btn btn-outline-danger">
                        <i class="bi bi-trash me-1"></i> {% trans "Desactivar/Eliminar" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Información del Cliente -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person-lines-fill me-2"></i>
                        {% trans "Información del Cliente" %}
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">
                            <i class="bi bi-envelope me-1"></i> {% trans "Email:" %}
                        </dt>
                        <dd class="col-sm-7">
                            <a href="mailto:{{ client.email }}">{{ client.email }}</a>
                        </dd>

                        <dt class="col-sm-5">
                            <i class="bi bi-person me-1"></i> {% trans "Usuario:" %}
                        </dt>
                        <dd class="col-sm-7">
                            <code>{{ client.username }}</code>
                        </dd>

                        <dt class="col-sm-5">
                            <i class="bi bi-translate me-1"></i> {% trans "Idioma:" %}
                        </dt>
                        <dd class="col-sm-7">
                            {% if client.profile.language == 'es' %}
                                <span class="badge bg-secondary">Español</span>
                            {% else %}
                                <span class="badge bg-secondary">English</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-5">
                            <i class="bi bi-calendar-event me-1"></i> {% trans "Registrado:" %}
                        </dt>
                        <dd class="col-sm-7">
                            {{ client.date_joined|date:"d M Y, H:i" }}
                        </dd>

                        <dt class="col-sm-5">
                            <i class="bi bi-clock-history me-1"></i> {% trans "Último acceso:" %}
                        </dt>
                        <dd class="col-sm-7">
                            {% if client.last_login %}
                                {{ client.last_login|date:"d M Y, H:i" }}
                            {% else %}
                                <span class="text-muted">{% trans "Nunca" %}</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-5">
                            <i class="bi bi-check-circle me-1"></i> {% trans "Estado:" %}
                        </dt>
                        <dd class="col-sm-7">
                            {% if client.is_active %}
                                <span class="badge bg-success">{% trans "Activo" %}</span>
                            {% else %}
                                <span class="badge bg-danger">{% trans "Inactivo" %}</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
            
            <!-- Organización (si aplica) -->
            {% if organization %}
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-building me-2"></i>
                        {% trans "Organización" %}
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">
                            <i class="bi bi-building me-1"></i> {% trans "Empresa:" %}
                        </dt>
                        <dd class="col-sm-7">
                            <a href="{% url 'organization_detail' organization.id %}">
                                <strong>{{ organization.name }}</strong>
                            </a>
                        </dd>
                        
                        {% if client_contact.role %}
                        <dt class="col-sm-5">
                            <i class="bi bi-person-badge me-1"></i> {% trans "Rol:" %}
                        </dt>
                        <dd class="col-sm-7">
                            <span class="badge bg-primary">{{ client_contact.get_role_display }}</span>
                        </dd>
                        {% endif %}
                        
                        {% if client_contact.job_title %}
                        <dt class="col-sm-5">
                            <i class="bi bi-briefcase me-1"></i> {% trans "Cargo:" %}
                        </dt>
                        <dd class="col-sm-7">{{ client_contact.job_title }}</dd>
                        {% endif %}
                        
                        {% if client_contact.phone_direct %}
                        <dt class="col-sm-5">
                            <i class="bi bi-telephone me-1"></i> {% trans "Teléfono:" %}
                        </dt>
                        <dd class="col-sm-7">{{ client_contact.phone_direct }}</dd>
                        {% endif %}
                    </dl>
                    
                    <!-- Permisos -->
                    <hr class="my-3">
                    <h6 class="text-muted mb-2">{% trans "Permisos" %}</h6>
                    <div class="d-flex flex-wrap gap-1">
                        {% if client_contact.can_approve_change_orders %}
                            <span class="badge bg-success"><i class="bi bi-check"></i> {% trans "Aprobar Change Orders" %}</span>
                        {% endif %}
                        {% if client_contact.can_view_financials %}
                            <span class="badge bg-success"><i class="bi bi-check"></i> {% trans "Ver Financieros" %}</span>
                        {% endif %}
                        {% if client_contact.can_create_tasks %}
                            <span class="badge bg-success"><i class="bi bi-check"></i> {% trans "Crear Tareas" %}</span>
                        {% endif %}
                        {% if client_contact.can_approve_colors %}
                            <span class="badge bg-success"><i class="bi bi-check"></i> {% trans "Aprobar Colores" %}</span>
                        {% endif %}
                        {% if client_contact.receive_daily_reports %}
                            <span class="badge bg-info"><i class="bi bi-envelope"></i> {% trans "Reportes Diarios" %}</span>
                        {% endif %}
                        {% if client_contact.receive_invoice_notifications %}
                            <span class="badge bg-info"><i class="bi bi-receipt"></i> {% trans "Notif. Facturas" %}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card shadow-sm mt-3 border-warning">
                <div class="card-body text-center py-3">
                    <i class="bi bi-person-fill text-warning" style="font-size: 2rem;"></i>
                    <p class="mb-1 mt-2"><strong>{% trans "Cliente Individual" %}</strong></p>
                    <small class="text-muted">{% trans "No pertenece a ninguna organización" %}</small>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Proyectos Asignados -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-folder-fill me-2"></i>
                        {% trans "Proyectos Asignados" %} ({{ project_accesses.count }})
                    </h5>
                    <a href="{% url 'client_assign_project' client.id %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle me-1"></i> {% trans "Asignar Nuevo" %}
                    </a>
                </div>
                <div class="card-body">
                    {% if project_accesses %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>{% trans "Proyecto" %}</th>
                                    <th>{% trans "Rol" %}</th>
                                    <th>{% trans "Permisos" %}</th>
                                    <th>{% trans "Asignado" %}</th>
                                    <th class="text-end">{% trans "Acciones" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for access in project_accesses %}
                                <tr>
                                    <td>
                                        <a href="{% url 'project_overview' access.project.id %}" class="text-decoration-none">
                                            <strong>{{ access.project.name }}</strong>
                                        </a>
                                        <br>
                                        <small class="text-muted">{{ access.project.address }}</small>
                                    </td>
                                    <td>
                                        {% if access.role == "owner" %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-house-door me-1"></i>{{ access.get_role_display }}
                                        </span>
                                        {% elif access.role == "client" %}
                                        <span class="badge bg-primary">
                                            <i class="bi bi-person me-1"></i>{{ access.get_role_display }}
                                        </span>
                                        {% elif access.role == "external_pm" %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-person-badge me-1"></i>{{ access.get_role_display }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-info">{{ access.get_role_display }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div>
                                            {% if access.can_comment %}
                                                <span class="badge bg-success mb-1">
                                                    <i class="bi bi-chat"></i> {% trans "Comentar" %}
                                                </span>
                                            {% endif %}
                                            {% if access.can_create_tasks %}
                                                <span class="badge bg-success mb-1">
                                                    <i class="bi bi-plus"></i> {% trans "Crear tareas" %}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ access.granted_at|date:"d M Y" }}</small>
                                    </td>
                                    <td class="text-end">
                                        <form method="post" action="{% url 'client_assign_project' client.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <input type="hidden" name="project_id" value="{{ access.project.id }}">
                                            <input type="hidden" name="action" value="remove">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                    onclick="return confirm('{% trans "¿Remover acceso a este proyecto?" %}')">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-folder2-open display-4 text-muted mb-3"></i>
                        <p class="text-muted">{% trans "Este cliente no tiene proyectos asignados" %}</p>
                        <a href="{% url 'client_assign_project' client.id %}" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i> {% trans "Asignar Primer Proyecto" %}
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Proyectos de la Organización (si aplica) -->
            {% if organization_projects %}
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-building me-2"></i>
                        {% trans "Otros Proyectos de" %} {{ organization.name }}
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        <i class="bi bi-info-circle me-1"></i>
                        {% trans "Proyectos facturados a la organización pero sin acceso directo asignado a este contacto" %}
                    </p>
                    <div class="list-group list-group-flush">
                        {% for project in organization_projects %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <strong>{{ project.name }}</strong>
                                <br><small class="text-muted">{{ project.address }}</small>
                            </div>
                            <a href="{% url 'client_assign_project' client.id %}?project={{ project.id }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-plus-circle me-1"></i> {% trans "Dar Acceso" %}
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Actividad Reciente -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-left-text me-2"></i>
                        {% trans "Solicitudes Recientes" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_requests %}
                    <div class="list-group list-group-flush">
                        {% for req in recent_requests %}
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong>{{ req.title }}</strong>
                                    <p class="mb-1 text-muted small">{{ req.description|truncatewords:15 }}</p>
                                    <small class="text-muted">
                                        <i class="bi bi-folder me-1"></i>{{ req.project.name }}
                                        • {{ req.created_at|date:"d M Y" }}
                                    </small>
                                </div>
                                <span class="badge {% if req.status == 'pending' %}bg-warning{% elif req.status == 'approved' %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ req.get_status_display }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">
                        {% trans "Sin solicitudes recientes" %}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check me-2"></i>
                        {% trans "Tareas Recientes" %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_tasks %}
                    <div class="list-group list-group-flush">
                        {% for task in recent_tasks %}
                        <div class="list-group-item px-0">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong>{{ task.name }}</strong>
                                    <p class="mb-1 text-muted small">{{ task.description|truncatewords:15 }}</p>
                                    <small class="text-muted">
                                        <i class="bi bi-folder me-1"></i>{{ task.project.name }}
                                        • {{ task.created_at|date:"d M Y" }}
                                    </small>
                                </div>
                                <span class="badge {% if task.status == 'pending' %}bg-warning{% elif task.status == 'in_progress' %}bg-info{% elif task.status == 'completed' %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ task.get_status_display }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">
                        {% trans "Sin tareas recientes" %}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
