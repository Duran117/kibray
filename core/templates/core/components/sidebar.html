{% load i18n %}

{% with prof=request.user.profile|default_if_none:'' %}
<aside id="kb-sidebar" class="fixed left-0 top-0 lg:top-16 bottom-0 w-72 lg:w-64 bg-white border-r border-gray-200 overflow-y-auto z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-200" aria-label="Primary navigation">
    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 lg:hidden">
        <div class="flex items-center gap-2">
            <i class="bi bi-compass text-xl text-kibray-600"></i>
            <span class="font-semibold">{% trans "Menu" %}</span>
        </div>
        <button id="kb-sidebar-close" aria-label="Close navigation" class="p-2 rounded-lg hover:bg-gray-100 focus:ring-2 focus:ring-kibray-600">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
    <nav class="p-4 space-y-4">
        {# Common section #}
        <details open class="group rounded-lg border border-gray-200 bg-white">
            <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none">
                <div class="flex items-center gap-2 text-sm font-semibold text-gray-800"><i class="bi bi-house-door text-lg text-kibray-600"></i>{% trans "Inicio" %}</div>
                <i class="bi bi-chevron-down text-gray-500 group-open:rotate-180 transition"></i>
            </summary>
            <div class="border-t border-gray-100 py-2 space-y-1">
                <a href="{% url 'dashboard' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-kibray-600">
                    <span>{% trans "Dashboard" %}</span>
                </a>
                <a href="{% url 'notifications_list' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-kibray-600">
                    <span>{% trans "Notificaciones" %}</span>
                    {% if badges.unread_notifications_count|default:0 > 0 %}
                    <span class="ml-auto inline-flex items-center justify-center px-2 py-0.5 text-xs font-semibold rounded-full bg-red-100 text-red-700">{{ badges.unread_notifications_count }}</span>
                    {% endif %}
                </a>
            </div>
        </details>

        {# Staff / PM / Admin #}
        {% if user.is_staff or user.is_superuser %}
        <details open class="group rounded-lg border border-indigo-200 bg-white">
            <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none">
                <div class="flex items-center gap-2 text-sm font-semibold text-indigo-900"><i class="bi bi-kanban text-lg text-indigo-600"></i>{% trans "Planificación" %}</div>
                <i class="bi bi-chevron-down text-gray-500 group-open:rotate-180 transition"></i>
            </summary>
            <div class="border-t border-indigo-100 py-2 space-y-1">
                <a href="{% url 'daily_planning_dashboard' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-600">{% trans "Daily Planning" %}</a>
                <a href="{% url 'strategic_planning_dashboard' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-600">{% trans "Strategic Planning" %}</a>
                <a href="{% url 'pm_calendar' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-600">{% trans "PM Calendar" %}</a>
                <a href="{% url 'master_schedule_center' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-600">{% trans "Master Schedule" %}</a>
                <a href="{% url 'pm_assignments_react' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-600">{% trans "Equipo" %}</a>
                <a href="{% url 'task_list_all' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-600">
                    <i class="bi bi-list-check text-indigo-600"></i>
                    <span>{% trans "Tareas" %}</span>
                </a>
                <a href="{% url 'payroll_summary' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-600">
                    <i class="bi bi-cash-coin text-indigo-600"></i>
                    <span>{% trans "Nómina" %}</span>
                </a>
                <a href="{% url 'pm_select_project' 'overview' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-600">{% trans "Proyectos" %}</a>
                <a href="{% url 'changeorder_board' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-indigo-600">{% trans "Change Orders" %}</a>
            </div>
        </details>

        <details class="group rounded-lg border border-yellow-200 bg-white">
            <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none">
                <div class="flex items-center gap-2 text-sm font-semibold text-yellow-900"><i class="bi bi-bricks text-lg text-yellow-600"></i>{% trans "Operaciones" %}</div>
                <i class="bi bi-chevron-down text-gray-500 group-open:rotate-180 transition"></i>
            </summary>
            <div class="border-t border-yellow-100 py-2 space-y-1">
                <a href="{% url 'pm_select_project' 'materials' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-yellow-600">{% trans "Materiales" %}</a>
                <a href="{% url 'pm_select_project' 'touchups' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-yellow-600">{% trans "Touch-Ups" %}</a>
                <a href="{% url 'pm_select_project' 'damages' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-yellow-600">{% trans "Daños" %}</a>
                <a href="{% url 'pm_select_project' 'chat' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-yellow-600">{% trans "Chat" %}</a>
                <a href="{% url 'unassigned_timeentries' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-yellow-600">{% trans "Tiempo sin CO" %}</a>
            </div>
        </details>

        <details class="group rounded-lg border border-teal-200 bg-white">
            <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none">
                <div class="flex items-center gap-2 text-sm font-semibold text-teal-900"><i class="bi bi-map text-lg text-teal-600"></i>{% trans "Docs & Planos" %}</div>
                <i class="bi bi-chevron-down text-gray-500 group-open:rotate-180 transition"></i>
            </summary>
            <div class="border-t border-teal-100 py-2 space-y-1">
                <a href="{% url 'pm_select_project' 'plans' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-teal-50 focus:outline-none focus:ring-2 focus:ring-teal-600">{% trans "Planos" %}</a>
                <a href="{% url 'pm_select_project' 'colors' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-teal-50 focus:outline-none focus:ring-2 focus:ring-teal-600">{% trans "Colores" %}</a>
            </div>
        </details>

        <details class="group rounded-lg border border-slate-200 bg-white">
            <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none">
                <div class="flex items-center gap-2 text-sm font-semibold text-slate-900"><i class="bi bi-bar-chart text-lg text-slate-700"></i>{% trans "Reportes" %}</div>
                <i class="bi bi-chevron-down text-gray-500 group-open:rotate-180 transition"></i>
            </summary>
            <div class="border-t border-slate-100 py-2 space-y-1">
                <a href="{% url 'pm_select_project' 'ev' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-600">EV / {% trans "Project Value" %}</a>
                <a href="{% url 'income_list' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-600">{% trans "Ingresos" %}</a>
                <a href="{% url 'expense_list' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-600">{% trans "Gastos" %}</a>
                <a href="#" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-slate-600" aria-disabled="true">{% trans "Executive BI (próximamente)" %}</a>
            </div>
        </details>

        <details class="group rounded-lg border border-rose-200 bg-white">
            <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none">
                <div class="flex items-center gap-2 text-sm font-semibold text-rose-900"><i class="bi bi-gear text-lg text-rose-600"></i>{% trans "Admin" %}</div>
                <i class="bi bi-chevron-down text-gray-500 group-open:rotate-180 transition"></i>
            </summary>
            <div class="border-t border-rose-100 py-2 space-y-1">
                <a href="{% url 'admin:index' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-rose-50 focus:outline-none focus:ring-2 focus:ring-rose-600">Django Admin</a>
            </div>
        </details>
        {% endif %}

        {# Empleado (no staff) #}
        {% if not user.is_staff and prof and prof.role == 'employee' %}
        <details open class="group rounded-lg border border-green-200 bg-white">
            <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none">
                <div class="flex items-center gap-2 text-sm font-semibold text-green-900"><i class="bi bi-briefcase-fill text-lg text-green-600"></i>{% trans "Mi Jornada" %}</div>
                <i class="bi bi-chevron-down text-gray-500 group-open:rotate-180 transition"></i>
            </summary>
            <div class="border-t border-green-100 py-2 space-y-1">
                <a href="{% url 'dashboard_employee' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-green-600">{% trans "Dashboard Empleado" %}</a>
                <a href="{% url 'employee_morning_dashboard' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-green-600">{% trans "Plan Mañana" %}</a>
                <a href="{% url 'task_list_all' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-green-600">{% trans "Mis Tareas" %}</a>
                <a href="{% url 'notifications_list' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-green-600">{% trans "Notificaciones" %}</a>
            </div>
        </details>
        {% endif %}

        {# Cliente / Builder / Superintendent #}
        {% if prof %}
        {% with role=prof.role %}
        {% if role == 'client' or role == 'builder' or role == 'superintendent' %}
        <details open class="group rounded-lg border border-sky-200 bg-white">
            <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none">
                <div class="flex items-center gap-2 text-sm font-semibold text-sky-900"><i class="bi bi-building text-lg text-sky-600"></i>Proyectos</div>
                <i class="bi bi-chevron-down text-gray-500 group-open:rotate-180 transition"></i>
            </summary>
            <div class="border-t border-sky-100 py-2 space-y-1">
                <a href="{% url 'dashboard_client' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-sky-50 focus:outline-none focus:ring-2 focus:ring-sky-600">{% trans "Resumen" %}</a>
                <a href="{% url 'client_requests_list_all' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-sky-50 focus:outline-none focus:ring-2 focus:ring-sky-600">{% trans "Solicitudes" %}</a>
            </div>
        </details>
        {% endif %}
        {% endwith %}
        {% endif %}

        {# Diseñador #}
        {% if prof and prof.role == 'designer' %}
        <details open class="group rounded-lg border border-purple-200 bg-white">
            <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none">
                <div class="flex items-center gap-2 text-sm font-semibold text-purple-900"><i class="bi bi-brush text-lg text-purple-600"></i>{% trans "Diseño" %}</div>
                <i class="bi bi-chevron-down text-gray-500 group-open:rotate-180 transition"></i>
            </summary>
            <div class="border-t border-purple-100 py-2 space-y-1">
                <a href="{% url 'dashboard_designer' %}" class="flex items-center gap-3 px-4 py-2 text-sm rounded-lg hover:bg-purple-50 focus:outline-none focus:ring-2 focus:ring-purple-600">{% trans "Dashboard Diseñador" %}</a>
            </div>
        </details>
        {% endif %}
    </nav>
</aside>
{% endwith %}
