{% load static %}
{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}

{# Dark Modern Header - Asana Style #}
<header id="kb-header" class="bg-[#1e1f21] border-b border-white/10 sticky top-0 z-40" role="banner">
    <div class="w-full px-4">
        <div class="flex items-center justify-between h-14">
            {# Left: Logo & Mobile Menu #}
            <div class="flex items-center gap-3">
                <button id="mobile-menu-toggle" aria-label="{% trans 'Open navigation' %}" class="lg:hidden p-2 rounded-lg text-slate-400 hover:bg-white/10 hover:text-white focus:ring-2 focus:ring-white/20 transition">
                    <i class="bi bi-list text-xl"></i>
                </button>
                <a href="{% url 'dashboard' %}" class="flex items-center gap-3 group focus:outline-none focus:ring-2 focus:ring-white/20 rounded-lg px-2 py-1">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i class="bi bi-layers text-white text-sm"></i>
                    </div>
                    <span class="text-lg font-bold text-white group-hover:text-indigo-300 transition hidden sm:inline">
                        Kibray
                    </span>
                </a>
            </div>
            
            {# Center: Search (hidden on mobile) #}
            <div class="hidden md:flex flex-1 max-w-md mx-8">
                <div class="relative w-full">
                    <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" 
                           placeholder="{% trans 'Search projects, tasks...' %}" 
                           class="w-full pl-10 pr-4 py-2 bg-white/10 border-0 rounded-lg text-sm text-white placeholder-slate-400 focus:bg-white/20 focus:ring-2 focus:ring-indigo-500 transition">
                </div>
            </div>
            
            {# Right: Actions #}
            <div class="flex items-center gap-2">
                {# Quick Create Button #}
                {% if user.is_staff or user.is_superuser %}
                <button class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-lg transition">
                    <i class="bi bi-plus-lg"></i>
                    <span class="hidden lg:inline">{% trans "New" %}</span>
                </button>
                {% endif %}
                
                {# Language Switcher #}
                <div class="flex items-center gap-1 bg-white/10 rounded-lg p-0.5">
                    <form method="post" action="{% url 'set_language' %}" class="inline">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.path }}" />
                        <input type="hidden" name="language" value="es" />
                        <button type="submit" class="px-2 py-1 rounded text-xs font-medium transition {% if LANGUAGE_CODE == 'es' %}bg-indigo-600 text-white{% else %}text-slate-400 hover:text-white{% endif %}">ES</button>
                    </form>
                    <form method="post" action="{% url 'set_language' %}" class="inline">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.path }}" />
                        <input type="hidden" name="language" value="en" />
                        <button type="submit" class="px-2 py-1 rounded text-xs font-medium transition {% if LANGUAGE_CODE == 'en' %}bg-indigo-600 text-white{% else %}text-slate-400 hover:text-white{% endif %}">EN</button>
                    </form>
                </div>
                
                {# Notifications #}
                {% if user.is_authenticated %}
                {% with unread=badges.unread_notifications_count|default:0 %}
                <a href="{% url 'notifications_list' %}" class="relative p-2 rounded-lg text-slate-400 hover:bg-white/10 hover:text-white transition focus:ring-2 focus:ring-white/20">
                    <i class="bi bi-bell text-lg"></i>
                    {% if unread|add:0 > 0 %}
                    <span class="absolute -top-0.5 -right-0.5 min-w-[18px] h-[18px] flex items-center justify-center px-1 bg-red-500 text-white text-[10px] font-bold rounded-full">{{ unread }}</span>
                    {% endif %}
                </a>
                {% endwith %}
                {% endif %}
                
                {# User Menu #}
                {% if user.is_authenticated %}
                <div class="relative" x-data="{ open: false }">
                    <button onclick="toggleUserMenu()" id="user-menu-btn" class="flex items-center gap-2 px-2 py-1.5 rounded-lg text-slate-300 hover:bg-white/10 hover:text-white transition focus:ring-2 focus:ring-white/20">
                        <div class="w-7 h-7 rounded-full bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white text-xs font-bold">
                            {{ user.first_name|slice:":1"|upper|default:user.username|slice:":1"|upper }}
                        </div>
                        <span class="text-sm font-medium hidden lg:inline max-w-[100px] truncate">{{ user.first_name|default:user.username }}</span>
                        <i class="bi bi-chevron-down text-xs hidden lg:inline"></i>
                    </button>
                    
                    {# Dropdown Menu #}
                    <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-[#2d2e30] rounded-lg shadow-xl border border-white/10 py-1 z-50">
                        <div class="px-4 py-3 border-b border-white/10">
                            <p class="text-sm font-medium text-white">{{ user.get_full_name|default:user.username }}</p>
                            <p class="text-xs text-slate-400">{{ user.email }}</p>
                        </div>
                        
                        {% if user.is_staff or user.is_superuser %}
                        <a href="{% url 'dashboard_admin' %}" class="flex items-center gap-3 px-4 py-2 text-sm text-slate-300 hover:bg-white/10 hover:text-white transition">
                            <i class="bi bi-gear"></i>
                            {% trans "Admin Panel" %}
                        </a>
                        {% endif %}
                        
                        <a href="{% url 'dashboard' %}" class="flex items-center gap-3 px-4 py-2 text-sm text-slate-300 hover:bg-white/10 hover:text-white transition">
                            <i class="bi bi-person"></i>
                            {% trans "My Dashboard" %}
                        </a>
                        
                        <div class="border-t border-white/10 mt-1 pt-1">
                            <a href="{% url 'logout' %}" class="flex items-center gap-3 px-4 py-2 text-sm text-red-400 hover:bg-red-500/10 hover:text-red-300 transition">
                                <i class="bi bi-box-arrow-right"></i>
                                {% trans "Logout" %}
                            </a>
                        </div>
                    </div>
                </div>
                {% else %}
                <a href="{% url 'login' %}" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition">
                    {% trans "Login" %}
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</header>

<script>
function toggleUserMenu() {
    const dropdown = document.getElementById('user-menu-dropdown');
    dropdown.classList.toggle('hidden');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const btn = document.getElementById('user-menu-btn');
    const dropdown = document.getElementById('user-menu-dropdown');
    if (dropdown && btn && !btn.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.add('hidden');
    }
});
</script>
