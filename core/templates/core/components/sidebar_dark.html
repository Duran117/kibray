{% load i18n %}
{% load static %}

{% with prof=request.user.profile|default_if_none:'' role=request.user.profile.role|default:'employee' %}

{# Dark Modern Sidebar - Asana Style #}
<aside id="kb-sidebar" class="fixed left-0 top-14 bottom-0 w-64 bg-[#1e1f21] border-r border-white/10 z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-200 flex flex-col" aria-label="{% trans 'Primary navigation' %}">
    
    {# Mobile Close Button #}
    <div class="flex items-center justify-between px-4 py-3 border-b border-white/10 lg:hidden flex-shrink-0">
        <span class="text-white font-semibold">{% trans "Menu" %}</span>
        <button id="kb-sidebar-close" aria-label="{% trans 'Close navigation' %}" class="p-2 rounded-lg text-slate-400 hover:bg-white/10 hover:text-white transition">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
    
    {# Navigation - Scrollable Area #}
    <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-6 dark-scroll">
        
        {# ===== MAIN SECTION (Not for clients) ===== #}
        {% if role != 'client' %}
        <div class="space-y-1">
            <a href="{% url 'dashboard' %}" class="sidebar-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                <i class="bi bi-house-door"></i>
                <span>{% trans "Home" %}</span>
            </a>
            
            <a href="{% url 'notifications_list' %}" class="sidebar-item {% if request.resolver_match.url_name == 'notifications_list' %}active{% endif %}">
                <i class="bi bi-bell{% if badges.unread_notifications_count|default:0 > 0 %}-fill text-amber-400{% endif %}"></i>
                <span>{% trans "Notifications" %}</span>
                {% if badges.unread_notifications_count|default:0 > 0 %}
                <span class="ml-auto bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full animate-pulse">{{ badges.unread_notifications_count }}</span>
                {% endif %}
            </a>
        </div>
        {% endif %}
        
        {# ===== PROJECTS SECTION (Not for clients) ===== #}
        {% if role != 'client' %}
        <div>
            <div class="sidebar-section-title">{% trans "Projects" %}</div>
            <div class="space-y-1">
                <a href="{% url 'project_list' %}" class="sidebar-item">
                    <i class="bi bi-folder2"></i>
                    <span>{% trans "All Projects" %}</span>
                </a>
                
                {# Recent Projects - Dynamic from context #}
                {% if recent_projects %}
                {% for project in recent_projects|slice:":5" %}
                <a href="{% url 'project_overview' project.id %}" class="sidebar-item">
                    <span class="w-2 h-2 rounded-full bg-indigo-500 flex-shrink-0"></span>
                    <span class="truncate">{{ project.name }}</span>
                </a>
                {% endfor %}
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {# ===== STAFF/PM SECTION ===== #}
        {% if user.is_staff or user.is_superuser or role == 'project_manager' or role == 'admin' %}
        <div>
            <div class="sidebar-section-title">{% trans "Planning" %}</div>
            <div class="space-y-1">
                <a href="{% url 'daily_planning_dashboard' %}" class="sidebar-item">
                    <i class="bi bi-calendar-check"></i>
                    <span>{% trans "Daily Planning" %}</span>
                </a>
                <a href="{% url 'strategic_planning_dashboard' %}" class="sidebar-item">
                    <i class="bi bi-compass"></i>
                    <span>{% trans "Strategic" %}</span>
                </a>
                {% if user.is_superuser or role == 'admin' %}
                <a href="{% url 'master_schedule_center' %}" class="sidebar-item">
                    <i class="bi bi-calendar3"></i>
                    <span>{% trans "Master Schedule" %}</span>
                </a>
                {% endif %}
                <a href="{% url 'assignment_hub' %}" class="sidebar-item">
                    <i class="bi bi-people"></i>
                    <span>{% trans "Team Assignments" %}</span>
                </a>
            </div>
        </div>
        
        <div>
            <div class="sidebar-section-title">{% trans "Operations" %}</div>
            <div class="space-y-1">
                <a href="{% url 'changeorder_board' %}" class="sidebar-item">
                    <i class="bi bi-kanban"></i>
                    <span>{% trans "Change Orders" %}</span>
                </a>
                <a href="{% url 'task_list_all' %}" class="sidebar-item">
                    <i class="bi bi-check2-square"></i>
                    <span>{% trans "All Tasks" %}</span>
                </a>
                <a href="{% url 'materials_requests_list_all' %}" class="sidebar-item">
                    <i class="bi bi-box-seam"></i>
                    <span>{% trans "Material Requests" %}</span>
                </a>
                <a href="{% url 'unassigned_timeentries' %}" class="sidebar-item">
                    <i class="bi bi-clock-history"></i>
                    <span>{% trans "Unassigned Time" %}</span>
                </a>
            </div>
        </div>
        {% endif %}
        
        {# ===== ADMIN ONLY SECTION ===== #}
        {% if user.is_superuser or role == 'admin' %}
        <div>
            <div class="sidebar-section-title">{% trans "Administration" %}</div>
            <div class="space-y-1">
                <a href="{% url 'dashboard_admin' %}" class="sidebar-item">
                    <i class="bi bi-speedometer2"></i>
                    <span>{% trans "Admin Dashboard" %}</span>
                </a>
                <a href="{% url 'client_list' %}" class="sidebar-item">
                    <i class="bi bi-people"></i>
                    <span>{% trans "Clients" %}</span>
                </a>
                <a href="/admin/core/employee/" class="sidebar-item">
                    <i class="bi bi-person-badge"></i>
                    <span>{% trans "Employees" %}</span>
                </a>
                <a href="{% url 'user_wizard_list' %}" class="sidebar-item">
                    <i class="bi bi-person-gear"></i>
                    <span>{% trans "User Management" %}</span>
                </a>
                <a href="{% url 'payroll_weekly_review' %}" class="sidebar-item">
                    <i class="bi bi-cash-stack"></i>
                    <span>{% trans "Payroll Review" %}</span>
                </a>
                <a href="{% url 'costcode_list' %}" class="sidebar-item">
                    <i class="bi bi-code-square"></i>
                    <span>{% trans "Cost Codes" %}</span>
                </a>
                <a href="{% url 'sop_library' %}" class="sidebar-item">
                    <i class="bi bi-journal-bookmark"></i>
                    <span>{% trans "SOP Library" %}</span>
                </a>
            </div>
        </div>
        
        <div>
            <div class="sidebar-section-title">{% trans "Finance" %}</div>
            <div class="space-y-1">
                <a href="{% url 'financial_dashboard' %}" class="sidebar-item">
                    <i class="bi bi-graph-up-arrow"></i>
                    <span>{% trans "Financial Dashboard" %}</span>
                </a>
                <a href="{% url 'income_list' %}" class="sidebar-item">
                    <i class="bi bi-currency-dollar"></i>
                    <span>{% trans "Income" %}</span>
                </a>
                <a href="{% url 'expense_list' %}" class="sidebar-item">
                    <i class="bi bi-receipt"></i>
                    <span>{% trans "Expenses" %}</span>
                </a>
                <a href="{% url 'invoice_list' %}" class="sidebar-item">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>{% trans "Invoices" %}</span>
                </a>
                <a href="{% url 'invoice_aging_report' %}" class="sidebar-item">
                    <i class="bi bi-calendar-x"></i>
                    <span>{% trans "Aging Report" %}</span>
                </a>
            </div>
        </div>
        
        <div>
            <div class="sidebar-section-title">{% trans "Reports" %}</div>
            <div class="space-y-1">
                <a href="{% url 'analytics_dashboard' %}" class="sidebar-item">
                    <i class="bi bi-bar-chart-line"></i>
                    <span>{% trans "Analytics" %}</span>
                </a>
                <a href="{% url 'productivity_dashboard' %}" class="sidebar-item">
                    <i class="bi bi-activity"></i>
                    <span>{% trans "Productivity" %}</span>
                </a>
                <a href="{% url 'dashboard_bi' %}" class="sidebar-item">
                    <i class="bi bi-pie-chart"></i>
                    <span>{% trans "Executive BI" %}</span>
                </a>
                <a href="/admin/" class="sidebar-item">
                    <i class="bi bi-database"></i>
                    <span>{% trans "Django Admin" %}</span>
                </a>
            </div>
        </div>
        {% endif %}
        
        {# ===== EMPLOYEE SECTION ===== #}
        {% if role == 'employee' and not user.is_staff %}
        <div>
            <div class="sidebar-section-title">{% trans "My Work" %}</div>
            <div class="space-y-1">
                <a href="{% url 'dashboard_employee' %}" class="sidebar-item">
                    <i class="bi bi-clock-history"></i>
                    <span>{% trans "Time Tracking" %}</span>
                </a>
            </div>
        </div>
        {% endif %}
        
        {# ===== CLIENT SECTION ===== #}
        {% if role == 'client' %}
        <div>
            <div class="sidebar-section-title">{% trans "Overview" %}</div>
            <div class="space-y-1">
                <a href="{% url 'dashboard_client' %}" class="sidebar-item {% if request.resolver_match.url_name == 'dashboard_client' %}active{% endif %}">
                    <i class="bi bi-grid-1x2"></i>
                    <span>{% trans "My Dashboard" %}</span>
                </a>
                <a href="{% url 'notifications_list' %}" class="sidebar-item {% if request.resolver_match.url_name == 'notifications_list' %}active{% endif %}">
                    <i class="bi bi-bell{% if badges.unread_notifications_count|default:0 > 0 %}-fill text-amber-400{% endif %}"></i>
                    <span>{% trans "Notifications" %}</span>
                    {% if badges.unread_notifications_count|default:0 > 0 %}
                    <span class="ml-auto bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full animate-pulse">{{ badges.unread_notifications_count }}</span>
                    {% endif %}
                </a>
            </div>
        </div>
        
        <div>
            <div class="sidebar-section-title">{% trans "Quick Access" %}</div>
            <div class="space-y-1">
                <a href="{% url 'client_requests_list_all' %}" class="sidebar-item {% if request.resolver_match.url_name == 'client_requests_list_all' %}active{% endif %}">
                    <i class="bi bi-chat-square-text"></i>
                    <span>{% trans "My Requests" %}</span>
                </a>
            </div>
        </div>
        {% endif %}
        
        {# ===== DESIGNER SECTION ===== #}
        {% if role == 'designer' %}
        <div>
            <div class="sidebar-section-title">{% trans "Design" %}</div>
            <div class="space-y-1">
                <a href="{% url 'dashboard_designer' %}" class="sidebar-item">
                    <i class="bi bi-palette2"></i>
                    <span>{% trans "My Dashboard" %}</span>
                </a>
                <a href="{% url 'color_approvals_react' %}" class="sidebar-item">
                    <i class="bi bi-palette"></i>
                    <span>{% trans "Color Approvals" %}</span>
                </a>
            </div>
        </div>
        {% endif %}
        
        {# ===== SUPERINTENDENT SECTION ===== #}
        {% if role == 'superintendent' %}
        <div>
            <div class="sidebar-section-title">{% trans "Field Operations" %}</div>
            <div class="space-y-1">
                <a href="{% url 'dashboard_superintendent' %}" class="sidebar-item">
                    <i class="bi bi-clipboard-check"></i>
                    <span>{% trans "My Dashboard" %}</span>
                </a>
                <a href="{% url 'daily_planning_dashboard' %}" class="sidebar-item">
                    <i class="bi bi-calendar-check"></i>
                    <span>{% trans "Daily Plans" %}</span>
                </a>
                <a href="{% url 'task_list_all' %}" class="sidebar-item">
                    <i class="bi bi-check2-square"></i>
                    <span>{% trans "Tasks" %}</span>
                </a>
            </div>
        </div>
        {% endif %}
        
    </nav>
    
    {# Bottom Section - Help & Version (Fixed at bottom, not absolute) #}
    <div class="flex-shrink-0 p-3 border-t border-white/10 bg-[#1e1f21]">
        <a href="#" class="sidebar-item text-slate-500 hover:text-slate-300">
            <i class="bi bi-question-circle"></i>
            <span>{% trans "Help & Support" %}</span>
        </a>
        <div class="text-center text-[10px] text-slate-600 mt-2">
            Kibray v2.0
        </div>
    </div>
</aside>

{# Mobile Backdrop #}
<div id="kb-sidebar-backdrop" class="fixed inset-0 bg-black/60 opacity-0 pointer-events-none transition-opacity duration-200 z-30 lg:hidden"></div>

<style>
/* Sidebar Item Styles */
.sidebar-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    color: #a2a0a2;
    text-decoration: none;
    font-size: 14px;
    border-radius: 6px;
    transition: all 0.15s ease;
}

.sidebar-item:hover {
    background: rgba(255, 255, 255, 0.08);
    color: #ffffff;
}

.sidebar-item.active {
    background: rgba(255, 255, 255, 0.12);
    color: #ffffff;
}

.sidebar-item i {
    font-size: 16px;
    width: 20px;
    text-align: center;
    flex-shrink: 0;
}

.sidebar-section-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6f7782;
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.25rem;
}
</style>

{% endwith %}
