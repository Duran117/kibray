{% extends "core/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Employee Performance Reviews" %}{% endblock %}

{% block extra_css %}
<style>
    .performance-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        transition: transform 0.2s;
    }
    
    .performance-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    .employee-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .employee-name {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
    }
    
    .overall-score {
        font-size: 2.5rem;
        font-weight: 700;
    }
    
    .score-excellent { color: #10b981; }
    .score-good { color: #3b82f6; }
    .score-average { color: #f59e0b; }
    .score-poor { color: #ef4444; }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
    }
    
    .metric-box {
        background: #f9fafb;
        padding: 16px;
        border-radius: 8px;
        text-align: center;
    }
    
    .metric-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 8px 0;
    }
    
    .metric-label {
        color: #6b7280;
        font-size: 0.85rem;
        text-transform: uppercase;
    }
    
    .rating-stars {
        color: #fbbf24;
        font-size: 1.2rem;
    }
    
    .bonus-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        margin-top: 8px;
    }
    
    .bonus-paid {
        background: #d1fae5;
        color: #065f46;
    }
    
    .bonus-pending {
        background: #fef3c7;
        color: #92400e;
    }
    
    .year-selector {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="bi bi-star-fill text-warning"></i> {% trans "Employee Performance Reviews" %}</h1>
            <p class="text-muted">{% trans "Annual performance metrics for bonus evaluation" %}</p>
        </div>
    </div>
    
    <!-- Year Selector -->
    <div class="row">
        <div class="col-12">
            <div class="year-selector">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h4>{% trans "Review Year" %}: {{ year }}</h4>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group">
                            {% for y in years %}
                                <a href="?year={{ y }}" class="btn btn-{% if y == year %}primary{% else %}outline-primary{% endif %}">
                                    {{ y }}
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Performance Cards -->
    <div class="row">
        {% for metric in metrics %}
        <div class="col-md-6 col-lg-4">
            <div class="performance-card">
                <div class="employee-header">
                    <div>
                        <div class="employee-name">
                            {{ metric.employee.first_name }} {{ metric.employee.last_name }}
                        </div>
                        <small class="text-muted">{{ metric.employee.position|default:"Employee" }}</small>
                    </div>
                    <div class="text-end">
                        <div class="overall-score 
                            {% if metric.overall_score >= 85 %}score-excellent
                            {% elif metric.overall_score >= 70 %}score-good
                            {% elif metric.overall_score >= 50 %}score-average
                            {% else %}score-poor{% endif %}">
                            {{ metric.overall_score|floatformat:0 }}
                        </div>
                        <small class="text-muted">{% trans "Overall Score" %}</small>
                    </div>
                </div>
                
                <!-- Metrics Grid -->
                <div class="metrics-grid">
                    <div class="metric-box">
                        <div class="metric-label">{% trans "Productivity" %}</div>
                        <div class="metric-value text-primary">{{ metric.productivity_rate|floatformat:0 }}%</div>
                    </div>
                    
                    <div class="metric-box">
                        <div class="metric-label">{% trans "Hours Worked" %}</div>
                        <div class="metric-value">{{ metric.total_hours_worked|floatformat:0 }}</div>
                    </div>
                    
                    <div class="metric-box">
                        <div class="metric-label">{% trans "Days Worked" %}</div>
                        <div class="metric-value">{{ metric.days_worked }}</div>
                    </div>
                    
                    <div class="metric-box">
                        <div class="metric-label">{% trans "Tasks Done" %}</div>
                        <div class="metric-value">{{ metric.tasks_completed }}</div>
                    </div>
                </div>
                
                <!-- Ratings -->
                {% if metric.quality_rating or metric.attitude_rating or metric.teamwork_rating %}
                <div class="mt-3 p-3" style="background: #f0f9ff; border-radius: 8px;">
                    <strong>{% trans "Manual Ratings" %}</strong>
                    <div class="mt-2">
                        {% if metric.quality_rating %}
                        <div class="mb-2">
                            <small class="text-muted">{% trans "Quality" %}:</small>
                            <span class="rating-stars ms-2">
                                {% for i in "12345" %}
                                    <i class="bi bi-star{% if forloop.counter <= metric.quality_rating %}-fill{% endif %}"></i>
                                {% endfor %}
                            </span>
                        </div>
                        {% endif %}
                        
                        {% if metric.attitude_rating %}
                        <div class="mb-2">
                            <small class="text-muted">{% trans "Attitude" %}:</small>
                            <span class="rating-stars ms-2">
                                {% for i in "12345" %}
                                    <i class="bi bi-star{% if forloop.counter <= metric.attitude_rating %}-fill{% endif %}"></i>
                                {% endfor %}
                            </span>
                        </div>
                        {% endif %}
                        
                        {% if metric.teamwork_rating %}
                        <div class="mb-2">
                            <small class="text-muted">{% trans "Teamwork" %}:</small>
                            <span class="rating-stars ms-2">
                                {% for i in "12345" %}
                                    <i class="bi bi-star{% if forloop.counter <= metric.teamwork_rating %}-fill{% endif %}"></i>
                                {% endfor %}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Bonus Info -->
                {% if metric.bonus_amount %}
                <div class="mt-3 text-center">
                    <h4 class="mb-2">{% trans "Bonus" %}: ${{ metric.bonus_amount|floatformat:2 }}</h4>
                    <span class="bonus-badge {% if metric.bonus_paid %}bonus-paid{% else %}bonus-pending{% endif %}">
                        {% if metric.bonus_paid %}
                            <i class="bi bi-check-circle"></i> {% trans "Paid" %} ({{ metric.bonus_paid_date|date:"M j, Y" }})
                        {% else %}
                            <i class="bi bi-clock"></i> {% trans "Pending" %}
                        {% endif %}
                    </span>
                    {% if metric.bonus_notes %}
                    <p class="mt-3 mb-0"><small><em>"{{ metric.bonus_notes }}"</em></small></p>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Action Button -->
                <div class="mt-3">
                    <a href="{% url 'employee_performance_review' metric.employee.id %}?year={{ year }}" 
                       class="btn btn-primary w-100">
                        <i class="bi bi-pencil"></i> {% trans "Edit Performance Review" %}
                    </a>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="performance-card text-center py-5">
                <i class="bi bi-inbox" style="font-size: 4rem; color: #d1d5db;"></i>
                <h3 class="mt-3">{% trans "No Performance Data Yet" %}</h3>
                <p class="text-muted">{% trans "Performance metrics will appear as employees work throughout the year" %}</p>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Summary Stats -->
    {% if metrics %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="performance-card">
                <h4><i class="bi bi-bar-chart"></i> {% trans "Team Summary" %} ({{ year }})</h4>
                <div class="row mt-4">
                    <div class="col-md-3 text-center">
                        <h2 class="text-primary">{{ metrics|length }}</h2>
                        <small class="text-muted">{% trans "Employees Reviewed" %}</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <h2 class="text-success">
                            {% widthratio metrics|length metrics|length 1 %}
                        </h2>
                        <small class="text-muted">{% trans "With Ratings" %}</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <h2 class="text-warning">
                            ${% widthratio metrics|length 1 1000 %}
                        </h2>
                        <small class="text-muted">{% trans "Avg Bonus" %}</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <h2 class="text-info">
                            {% for m in metrics %}{% if m.bonus_paid %}1{% endif %}{% endfor %}
                        </h2>
                        <small class="text-muted">{% trans "Bonuses Paid" %}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Back Button -->
    <div class="row mt-4">
        <div class="col-12">
            <a href="{% url 'financial_dashboard' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> {% trans "Back to Financial Dashboard" %}
            </a>
            <a href="{% url 'productivity_dashboard' %}" class="btn btn-outline-primary">
                <i class="bi bi-graph-up"></i> {% trans "Productivity Dashboard" %}
            </a>
        </div>
    </div>
</div>
{% endblock %}
