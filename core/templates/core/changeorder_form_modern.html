{% extends "core/base.html" %}
{% load static %}

{% block title %}{% if is_edit %}Editar{% else %}Crear{% endif %} Change Order - Kibray{% endblock %}

{% block extra_css %}
<style>
    /* ===== CHANGE ORDER FORM MODERN STYLES ===== */
    .co-modern-container {
        max-width: 1000px;
        margin: 0 auto;
    }
    
    .co-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 2rem;
        margin-bottom: 1.5rem;
    }
    
    .co-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .co-header-icon {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.75rem;
    }
    
    .co-header-content h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }
    
    .co-header-content p {
        margin: 0;
        color: #64748b;
        font-size: 0.9rem;
    }
    
    .form-section {
        margin-bottom: 2rem;
    }
    
    .form-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #334155;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 8px;
    }
    
    .form-section-title i {
        color: #667eea;
        font-size: 1.3rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        font-weight: 600;
        color: #475569;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .form-group label.required::after {
        content: " *";
        color: #dc2626;
    }
    
    .form-control, .form-select {
        min-height: 46px;
        border: 1.5px solid #cbd5e1;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.2s;
        width: 100%;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        outline: none;
    }
    
    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }
    
    /* Color Picker */
    .color-picker-wrapper {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 1rem;
    }
    
    .color-preview-box {
        width: 80px;
        height: 80px;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .color-preview-box:hover {
        transform: scale(1.05);
    }
    
    .color-input-group {
        flex: 1;
    }
    
    .color-help-text {
        font-size: 0.85rem;
        color: #64748b;
        margin-top: 0.5rem;
    }
    
    /* Photo Upload Area */
    .photo-upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        padding: 3rem 2rem;
        text-align: center;
        background: #f8fafc;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 1.5rem;
    }
    
    .photo-upload-area:hover {
        border-color: #667eea;
        background: #f0f3ff;
    }
    
    .photo-upload-area i {
        font-size: 3rem;
        color: #667eea;
        display: block;
        margin-bottom: 1rem;
    }
    
    .photo-upload-area p {
        margin: 0.5rem 0;
        color: #475569;
    }
    
    .photo-upload-area .upload-hint {
        font-size: 0.85rem;
        color: #94a3b8;
    }
    
    #photoInput {
        display: none;
    }
    
    /* Photo Preview Grid - Compact Thumbnails */
    .photo-preview-grid {
        display: none;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .photo-preview-grid.has-photos {
        display: grid;
    }
    
    .photo-preview-item {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        border: 2px solid #e2e8f0;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        transition: all 0.2s;
    }
    
    .photo-preview-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        border-color: #667eea;
    }
    
    .photo-preview-item img {
        width: 100%;
        height: 140px;
        object-fit: cover;
        display: block;
        cursor: pointer;
    }
    
    .photo-preview-item .photo-info {
        padding: 0.5rem;
        background: #f8fafc;
    }
    
    .photo-preview-item input.photo-description {
        width: 100%;
        padding: 0.4rem 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 0.75rem;
    }
    
    .photo-preview-item .remove-photo {
        position: absolute;
        top: 0.4rem;
        right: 0.4rem;
        background: rgba(220, 38, 38, 0.95);
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        line-height: 1;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        transition: all 0.2s;
        z-index: 10;
    }
    
    .photo-preview-item .remove-photo:hover {
        background: #b91c1c;
        transform: scale(1.15);
    }
    
    .photo-preview-item .edit-photo-btn {
        position: absolute;
        top: 0.4rem;
        left: 0.4rem;
        background: rgba(102, 126, 234, 0.95);
        color: white;
        border: none;
        border-radius: 16px;
        padding: 0.3rem 0.7rem;
        cursor: pointer;
        font-size: 0.7rem;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        transition: all 0.2s;
        z-index: 10;
    }
    
    .photo-preview-item .edit-photo-btn:hover {
        background: #5568d3;
        transform: scale(1.05);
    }
    
    .photo-preview-item .edit-photo-btn i {
        font-size: 0.7rem;
    }
    
    /* Existing Photos (Edit Mode) */
    .existing-photos {
        margin-bottom: 1.5rem;
    }
    
    .existing-photo-item {
        position: relative;
        display: inline-block;
        margin: 0.5rem;
        border-radius: 12px;
        overflow: hidden;
        border: 1.5px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .existing-photo-item img {
        width: 200px;
        height: 200px;
        object-fit: cover;
        display: block;
    }
    
    .existing-photo-item .photo-actions {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: flex;
        gap: 0.5rem;
    }
    
    .existing-photo-item .photo-actions button {
        background: rgba(0,0,0,0.7);
        color: white;
        border: none;
        padding: 0.4rem 0.7rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background 0.2s;
    }
    
    .existing-photo-item .photo-actions button:hover {
        background: rgba(0,0,0,0.9);
    }
    
    /* Photo Editor Modal - Fullscreen Experience */
    .photo-editor-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.98);
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
    }
    
    .photo-editor-modal.active {
        display: flex;
    }
    
    .photo-editor-content {
        background: #0f172a;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        position: relative;
    }
    
    .photo-editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem 2rem;
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border-bottom: 2px solid #334155;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .photo-editor-header h3 {
        margin: 0;
        color: #f1f5f9;
        font-size: 1.3rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .photo-editor-header .btn-close {
        background: transparent;
        border: none;
        color: #94a3b8;
        font-size: 1.75rem;
        cursor: pointer;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        transition: all 0.2s;
    }
    
    .photo-editor-header .btn-close:hover {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        transform: scale(1.1);
    }
    
    .canvas-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: auto;
        background: #020617;
        padding: 2rem;
    }
    
    #drawingCanvas {
        max-width: 100%;
        max-height: 100%;
        border: 3px solid #334155;
        border-radius: 12px;
        cursor: crosshair;
        background: white;
        box-shadow: 0 20px 60px rgba(0,0,0,0.7);
    }
    
    .drawing-tools {
        display: flex;
        gap: 0.75rem;
        padding: 1.25rem 2rem;
        background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
        border-bottom: 2px solid #334155;
        flex-wrap: wrap;
        align-items: center;
        box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
    }
    
    .tool-btn {
        padding: 0.75rem 1.5rem;
        border: 2px solid #475569;
        background: #1e293b;
        color: #e2e8f0;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .tool-btn:hover {
        border-color: #667eea;
        background: #334155;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .tool-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.5);
    }
    
    .tool-btn i {
        font-size: 1.1rem;
    }
    
    .color-selector {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        margin-left: auto;
        padding: 0.5rem 1rem;
        background: rgba(30, 41, 59, 0.5);
        border-radius: 10px;
    }
    
    .color-selector span {
        color: #e2e8f0;
        font-weight: 600;
        font-size: 0.95rem;
        margin-right: 0.5rem;
    }
    
    .color-swatch {
        width: 42px;
        height: 42px;
        border: 3px solid #475569;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.25s ease;
        position: relative;
    }
    
    .color-swatch:hover {
        transform: scale(1.15);
        border-color: #cbd5e1;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    
    .color-swatch.active {
        border-color: white;
        border-width: 4px;
        box-shadow: 0 0 0 3px #667eea, 0 4px 16px rgba(102, 126, 234, 0.6);
        transform: scale(1.1);
    }
    
    .color-swatch.active::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }
    
    .editor-actions {
        display: flex;
        gap: 1rem;
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
        border-top: 2px solid #334155;
        box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
    }
    
    .editor-actions .btn {
        padding: 1rem 2rem;
        font-weight: 600;
        font-size: 1.05rem;
        border-radius: 10px;
        min-height: 52px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .editor-actions .btn-secondary {
        flex: 1;
        background: #475569;
        border: 2px solid #64748b;
        color: white;
    }
    
    .editor-actions .btn-secondary:hover {
        background: #64748b;
        border-color: #94a3b8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(71, 85, 105, 0.4);
    }
    
    .editor-actions .btn-success {
        flex: 2;
        background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        border: none;
        color: white;
    }
    
    .editor-actions .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(22, 163, 74, 0.5);
    }
    
    /* Form Actions */
    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #e2e8f0;
    }
    
    .form-actions .btn {
        flex: 1;
        padding: 0.9rem 1.5rem;
        font-weight: 600;
        font-size: 1rem;
        border-radius: 10px;
        min-height: 50px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .errorlist {
        list-style: none;
        padding: 0;
        margin: 0.5rem 0 0 0;
    }
    
    .errorlist li {
        color: #dc2626;
        font-size: 0.85rem;
        padding: 0.5rem;
        background: #fee2e2;
        border-radius: 6px;
        margin-top: 0.25rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .co-card {
            padding: 1.5rem;
        }
        
        .co-header-icon {
            width: 48px;
            height: 48px;
            font-size: 1.5rem;
        }
        
        .co-header-content h1 {
            font-size: 1.5rem;
        }
        
        .color-picker-wrapper {
            grid-template-columns: 1fr;
        }
        
        .photo-preview-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
        
        .form-actions {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="co-modern-container">
    <div class="co-card">
        <div class="co-header">
            <div class="co-header-icon">
                <i class="bi bi-{% if is_edit %}pencil-square{% else %}plus-circle-fill{% endif %}"></i>
            </div>
            <div class="co-header-content">
                <h1>{% if is_edit %}Editar Change Order #{{ changeorder.id }}{% else %}Nuevo Change Order{% endif %}</h1>
                <p>Complete la información del change order{% if is_edit %} y actualice los campos necesarios{% endif %}</p>
            </div>
        </div>
        
        <form method="post" enctype="multipart/form-data" id="changeOrderForm">
            {% csrf_token %}
            
            <!-- Basic Info Section -->
            <div class="form-section">
                <div class="form-section-title">
                    <i class="bi bi-info-circle-fill"></i>
                    Información Básica
                </div>
                
                <div class="form-group">
                    <label for="{{ form.project.id_for_label }}" class="required">Proyecto</label>
                    {{ form.project }}
                    {% if form.project.errors %}
                        <ul class="errorlist">
                            {% for error in form.project.errors %}<li>{{ error }}</li>{% endfor %}
                        </ul>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.description.id_for_label }}" class="required">Descripción</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <ul class="errorlist">
                            {% for error in form.description.errors %}<li>{{ error }}</li>{% endfor %}
                        </ul>
                    {% endif %}
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.amount.id_for_label }}" class="required">Monto</label>
                            {{ form.amount }}
                            {% if form.amount.errors %}
                                <ul class="errorlist">
                                    {% for error in form.amount.errors %}<li>{{ error }}</li>{% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.status.id_for_label }}" class="required">Estado</label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <ul class="errorlist">
                                    {% for error in form.status.errors %}<li>{{ error }}</li>{% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.notes.id_for_label }}">Notas</label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <ul class="errorlist">
                            {% for error in form.notes.errors %}<li>{{ error }}</li>{% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
            
            <!-- Color Selection Section -->
            <div class="form-section">
                <div class="form-section-title">
                    <i class="bi bi-palette-fill"></i>
                    Selección de Color
                </div>
                
                <div class="color-picker-wrapper">
                    <div class="color-input-group">
                        {# Server-side fallback: show dropdown immediately if approved_colors exist #}
                        <div class="form-group" id="approvedColorsGroup" style="{% if approved_colors %}display:block;{% else %}display:none;{% endif %}">
                            <label for="approvedColorSelect">Colores Aprobados del Proyecto</label>
                            <select id="approvedColorSelect" class="form-select" onchange="selectApprovedColor(this)">
                                <option value="">-- Seleccionar color aprobado --</option>
                                {% for color_sample in approved_colors %}
                                <option value="{{ color_sample.code }}" 
                                        data-brand="{{ color_sample.brand }}"
                                        data-name="{{ color_sample.name }}">
                                    {{ color_sample.code }}{% if color_sample.name %} - {{ color_sample.name }}{% endif %}
                                    {% if color_sample.brand %} ({{ color_sample.brand }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <p class="color-help-text">Seleccione un color aprobado para este proyecto</p>
                        </div>
                        
                        {# Server-side fallback: show message if no approved colors #}
                        <div class="form-group" id="noColorsMessage" style="{% if not approved_colors %}display:block;{% else %}display:none;{% endif %}">
                            <div class="alert alert-warning" role="alert">
                                <i class="bi bi-info-circle"></i> 
                                <strong>Este proyecto no tiene colores aprobados.</strong><br>
                                Puede usar el selector de color manual a continuación.
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.color.id_for_label }}">Color (Hex) - Manual</label>
                            {{ form.color }}
                            <p class="color-help-text">O escriba un código hex manualmente (ej: #FF5733)</p>
                            {% if form.color.errors %}
                                <ul class="errorlist">
                                    {% for error in form.color.errors %}<li>{{ error }}</li>{% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.reference_code.id_for_label }}">Código de Referencia o Material</label>
                            {{ form.reference_code }}
                            <p class="color-help-text">Para hacer match con madera, metal u otro material (ej: "Madera X", "Metal Z")</p>
                            {% if form.reference_code.errors %}
                                <ul class="errorlist">
                                    {% for error in form.reference_code.errors %}<li>{{ error }}</li>{% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="color-preview-box" id="colorPreview" onclick="document.getElementById('{{ form.color.id_for_label }}').click()"></div>
                </div>
            </div>
            
            <!-- Photos Section -->
            <div class="form-section">
                <div class="form-section-title">
                    <i class="bi bi-camera-fill"></i>
                    Fotos del Proyecto
                </div>
                
                <div class="alert alert-info d-flex align-items-start gap-2" role="alert" style="font-size:0.9rem;">
                    <i class="bi bi-info-circle-fill" style="font-size:1.2rem; margin-top:0.1rem;"></i>
                    <div>
                        <strong>Cómo subir fotos:</strong>
                        <ol style="margin:0.5rem 0 0 0; padding-left:1.2rem;">
                            <li>Haga clic en el área azul para seleccionar fotos</li>
                            <li>Verá miniaturas de las fotos seleccionadas</li>
                            <li>Opcional: Haga clic en "Editar" para anotar/dibujar sobre una foto</li>
                            <li>Opcional: Agregue descripciones en los campos de texto</li>
                            <li>Haga clic en <strong>"{% if is_edit %}Guardar Cambios{% else %}Crear Change Order{% endif %}"</strong> al final del formulario para subir las fotos</li>
                        </ol>
                    </div>
                </div>
                
                {% if is_edit and changeorder.photos.all %}
                <div class="existing-photos">
                    <p style="font-weight: 600; margin-bottom: 1rem; color: #475569;">Fotos Existentes:</p>
                    {% for photo in changeorder.photos.all %}
                    <div class="existing-photo-item" data-photo-id="{{ photo.id }}">
                        <img src="{{ photo.image.url }}" alt="{{ photo.description }}">
                        <div class="photo-actions">
                            <button type="button" class="edit-btn" onclick="openPhotoEditor('{{ photo.image.url }}', {{ photo.id }}, '{{ photo.annotations|escapejs }}')">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <button type="button" class="delete-btn" onclick="deletePhoto({{ photo.id }})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        {% if photo.description %}
                        <p style="padding: 0.5rem; font-size: 0.85rem; color: #64748b;">{{ photo.description }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                    <i class="bi bi-cloud-upload"></i>
                    <p><strong>Haga clic para subir fotos</strong></p>
                    <p class="upload-hint">Puede seleccionar múltiples archivos (JPG, PNG, HEIC) - Máx 10MB por foto</p>
                </div>
                {# Photo input: ensure proper attributes; name as photos to allow getlist; add capture for mobile #}
                <input type="file" id="photoInput" name="photos" accept="image/*" multiple capture="environment">
                <div id="photoErrorMessage" style="display:none; color:#b91c1c; font-size:0.85rem; margin-top:0.5rem;"></div>
                
                <div id="photoPreviewGrid" class="photo-preview-grid"></div>
                
                <div id="photoCountBadge" style="display:none; margin-top:1rem; padding:0.75rem; background:#dbeafe; border:1px solid #3b82f6; border-radius:8px; text-align:center; font-weight:600; color:#1e40af;">
                    <i class="bi bi-check-circle-fill" style="color:#16a34a;"></i>
                    <span id="photoCountText">0 fotos</span> seleccionadas - Haga clic en "Guardar" al final para subirlas
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="form-actions">
                <a href="{% url 'changeorder_board' %}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> {% if is_edit %}Guardar Cambios{% else %}Crear Change Order{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Photo Editor Modal - Fullscreen -->
<div class="photo-editor-modal" id="photoEditorModal">
    <div class="photo-editor-content">
        <div class="photo-editor-header">
            <h3>
                <i class="bi bi-pencil-square"></i> 
                Editor de Fotos
            </h3>
            <button type="button" class="btn-close" onclick="closePhotoEditor()" aria-label="Cerrar">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="drawing-tools">
            <button type="button" class="tool-btn active" onclick="setDrawingMode('draw')" id="drawBtn">
                <i class="bi bi-pencil-fill"></i> Dibujar
            </button>
            <button type="button" class="tool-btn" onclick="setDrawingMode('arrow')" id="arrowBtn">
                <i class="bi bi-arrow-up-right"></i> Flecha
            </button>
            <button type="button" class="tool-btn" onclick="setDrawingMode('text')" id="textBtn">
                <i class="bi bi-fonts"></i> Texto
            </button>
            <button type="button" class="tool-btn" onclick="undoDrawing()">
                <i class="bi bi-arrow-counterclockwise"></i> Deshacer
            </button>
            <button type="button" class="tool-btn" onclick="clearDrawing()">
                <i class="bi bi-trash3"></i> Limpiar Todo
            </button>
            
            <div class="color-selector">
                <span>Color:</span>
                <div class="color-swatch active" style="background:#dc2626;" onclick="setDrawingColor('#dc2626', this)" title="Rojo"></div>
                <div class="color-swatch" style="background:#2563eb;" onclick="setDrawingColor('#2563eb', this)" title="Azul"></div>
                <div class="color-swatch" style="background:#16a34a;" onclick="setDrawingColor('#16a34a', this)" title="Verde"></div>
                <div class="color-swatch" style="background:#f59e0b;" onclick="setDrawingColor('#f59e0b', this)" title="Amarillo"></div>
                <div class="color-swatch" style="background:#000000;" onclick="setDrawingColor('#000000', this)" title="Negro"></div>
                <div class="color-swatch" style="background:#ffffff; border-color:#94a3b8;" onclick="setDrawingColor('#ffffff', this)" title="Blanco"></div>
            </div>
        </div>
        
        <div class="canvas-container">
            <canvas id="drawingCanvas"></canvas>
        </div>
        
        <div class="editor-actions">
            <button type="button" class="btn btn-secondary" onclick="closePhotoEditor()">
                <i class="bi bi-x-circle"></i> Cancelar
            </button>
            <button type="button" class="btn btn-success" onclick="saveAnnotations()">
                <i class="bi bi-check-circle-fill"></i> Guardar Anotaciones
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Color preview and approved colors
const colorInput = document.getElementById('{{ form.color.id_for_label }}');
const colorPreview = document.getElementById('colorPreview');
const referenceCodeInput = document.getElementById('{{ form.reference_code.id_for_label }}');
const projectSelect = document.getElementById('{{ form.project.id_for_label }}');

// DEBUG: Log to verify elements are found
console.log('=== CHANGE ORDER FORM DEBUG ===');
console.log('colorInput:', colorInput);
console.log('colorPreview:', colorPreview);
console.log('projectSelect:', projectSelect);
console.log('projectSelect.value:', projectSelect ? projectSelect.value : 'N/A');

// Update color preview
if (colorInput && colorPreview) {
    function updateColorPreview() {
        const color = colorInput.value || '#000000';
        colorPreview.style.background = color;
    }
    colorInput.addEventListener('input', updateColorPreview);
    updateColorPreview();
}

// Load approved colors when project changes
if (projectSelect) {
    console.log('Adding change event listener to projectSelect');
    projectSelect.addEventListener('change', function() {
        const projectId = this.value;
        console.log('Project changed to:', projectId);
        if (projectId) {
            loadApprovedColors(projectId);
        } else {
            // Hide both if no project selected
            const approvedColorsGroup = document.getElementById('approvedColorsGroup');
            const noColorsMessage = document.getElementById('noColorsMessage');
            if (approvedColorsGroup) approvedColorsGroup.style.display = 'none';
            if (noColorsMessage) noColorsMessage.style.display = 'none';
        }
    });
    
    // Load colors on page load if project is already selected (edit mode)
    if (projectSelect.value) {
        loadApprovedColors(projectSelect.value);
    }
}

function loadApprovedColors(projectId) {
       console.log('loadApprovedColors called with projectId:', projectId);
    fetch(`/api/projects/${projectId}/approved-colors/`)
        .then(response => response.json())
        .then(data => {
               console.log('Approved colors received:', data);
            const approvedColorsGroup = document.getElementById('approvedColorsGroup');
            const approvedColorSelect = document.getElementById('approvedColorSelect');
            const noColorsMessage = document.getElementById('noColorsMessage');
            
            if (data.colors && data.colors.length > 0) {
                // Clear and populate select
                approvedColorSelect.innerHTML = '<option value="">-- Seleccionar color aprobado --</option>';
                data.colors.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color.code || '';
                    option.setAttribute('data-brand', color.brand || '');
                    option.setAttribute('data-name', color.name || '');
                    option.textContent = color.code || '';
                    if (color.name) option.textContent += ' - ' + color.name;
                    if (color.brand) option.textContent += ' (' + color.brand + ')';
                    approvedColorSelect.appendChild(option);
                });
                // Show the group, hide the message
                if (approvedColorsGroup) approvedColorsGroup.style.display = 'block';
                if (noColorsMessage) noColorsMessage.style.display = 'none';
            } else {
                // Hide dropdown, show message
                if (approvedColorsGroup) approvedColorsGroup.style.display = 'none';
                if (noColorsMessage) noColorsMessage.style.display = 'block';
            }
        })
        .catch(err => {
            console.error('Error loading approved colors:', err);
            // On error, show message
            const approvedColorsGroup = document.getElementById('approvedColorsGroup');
            const noColorsMessage = document.getElementById('noColorsMessage');
            if (approvedColorsGroup) approvedColorsGroup.style.display = 'none';
            if (noColorsMessage) noColorsMessage.style.display = 'block';
        });
}

function selectApprovedColor(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const code = selectedOption.value;
    const brand = selectedOption.getAttribute('data-brand');
    const name = selectedOption.getAttribute('data-name');
    
    if (code && colorInput) {
        // Try to parse hex from code if it looks like one
        if (code.startsWith('#')) {
            colorInput.value = code;
        }
        // Update reference field with full info
        if (referenceCodeInput) {
            let refText = code;
            if (brand) refText += ` - ${brand}`;
            if (name) refText += ` (${name})`;
            referenceCodeInput.value = refText;
        }
        updateColorPreview();
    }
}

// Photo preview with immediate editor
const photoInput = document.getElementById('photoInput');
const photoPreviewGrid = document.getElementById('photoPreviewGrid');

// DEBUG: Log photo elements
console.log('photoInput:', photoInput);
console.log('photoPreviewGrid:', photoPreviewGrid);

let selectedFiles = [];
let pendingPhotoIndex = null;
let editedIndices = new Set(); // Track which photos have been edited

photoInput.addEventListener('change', function(e) {
       console.log('Photo input changed, files:', e.target.files);
       const errorBox = document.getElementById('photoErrorMessage');
       if (errorBox) { errorBox.style.display='none'; errorBox.textContent=''; }
       if (!e.target.files || e.target.files.length === 0) {
           console.warn('No files selected');
           return;
       }
       // Basic validation: size and type
       const validImages = [];
       for (const f of e.target.files) {
           if (!f.type.startsWith('image/')) {
               console.warn('Skipping non-image file:', f.name);
               continue;
           }
           if (f.size > 10 * 1024 * 1024) { // 10MB limit
               console.warn('Skipping large file (>10MB):', f.name);
               if (errorBox) {
                   errorBox.style.display='block';
                   errorBox.textContent='Algún archivo supera el límite de 10MB y fue omitido.';
               }
               continue;
           }
           validImages.push(f);
       }
       if (validImages.length === 0) {
           console.warn('No valid images after filtering');
           return;
       }
    const files = Array.from(e.target.files);
    
    // Add files to selectedFiles array
    validImages.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const newIndex = selectedFiles.length;
            
            selectedFiles.push({
                file: file,
                dataUrl: e.target.result,
                description: '',
                annotations: []
            });
            
            // Render preview immediately
            renderPhotoPreview();
        };
        reader.readAsDataURL(file);
    });
    
    // Reset input to allow selecting same file again
    photoInput.value = '';
});

function renderPhotoPreview() {
    console.log('renderPhotoPreview called, selectedFiles:', selectedFiles.length);
    if (!photoPreviewGrid) {
        console.error('photoPreviewGrid element not found!');
        return;
    }
    
    photoPreviewGrid.innerHTML = '';
    
    const countBadge = document.getElementById('photoCountBadge');
    const countText = document.getElementById('photoCountText');
    
    // Toggle visibility based on content
    if (selectedFiles.length > 0) {
        photoPreviewGrid.classList.add('has-photos');
        if (countBadge) {
            countBadge.style.display = 'block';
            if (countText) {
                countText.textContent = `${selectedFiles.length} foto${selectedFiles.length !== 1 ? 's' : ''}`;
            }
        }
    } else {
        photoPreviewGrid.classList.remove('has-photos');
        if (countBadge) countBadge.style.display = 'none';
    }
    
    selectedFiles.forEach((fileObj, index) => {
        const div = document.createElement('div');
        div.className = 'photo-preview-item';
        div.innerHTML = `
            <img src="${fileObj.dataUrl}" alt="Foto ${index + 1}" onclick="openPhotoEditorNew('${fileObj.dataUrl}', ${index}, false)" title="Clic para editar">
            <button type="button" class="remove-photo" onclick="removePhoto(${index})" title="Eliminar">&times;</button>
            <button type="button" class="edit-photo-btn" onclick="openPhotoEditorNew('${fileObj.dataUrl}', ${index}, false)" title="Editar">
                <i class="bi bi-pencil"></i>
            </button>
            <div class="photo-info">
                <input type="text" class="photo-description" name="photo_description_${index}" 
                       placeholder="Descripción..." value="${fileObj.description || ''}"
                       onchange="updatePhotoDescription(${index}, this.value)">
            </div>
        `;
        photoPreviewGrid.appendChild(div);
        console.log('Added preview for photo', index);
    });
    
    // Update the actual file input
    updateFileInput();
}

function updatePhotoDescription(index, description) {
    console.log('updatePhotoDescription:', index, description);
    if (selectedFiles[index]) {
        selectedFiles[index].description = description;
    }
}

function removePhoto(index) {
    console.log('removePhoto called for index:', index);
    if (confirm('¿Eliminar esta foto?')) {
        selectedFiles.splice(index, 1);
        renderPhotoPreview();
    }
}

function updateFileInput() {
    // Create a new DataTransfer object to hold our files
    const dt = new DataTransfer();
    selectedFiles.forEach(fileObj => {
        if (fileObj.file) {
            dt.items.add(fileObj.file);
        }
    });
    // Update the input's files
    photoInput.files = dt.files;
}

// Canvas Drawing with corrected cursor precision
let canvas, ctx, isDrawing = false, drawingMode = 'draw';
let startX, startY, currentAnnotations = [], currentPhotoId = null, currentPhotoIndex = null;
let drawingHistory = [];
let currentImageUrl = null;
let drawingColor = '#dc2626';

function openPhotoEditor(imageUrl, photoId, annotations) {
    currentPhotoId = photoId;
    currentPhotoIndex = null;
    const modal = document.getElementById('photoEditorModal');
    modal.classList.add('active');
    
    // Add keyboard listener
    document.addEventListener('keydown', editorKeyHandler);
    
    canvas = document.getElementById('drawingCanvas');
    ctx = canvas.getContext('2d');
    currentImageUrl = imageUrl;
    
    const img = new Image();
    img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        if (annotations) {
            try {
                currentAnnotations = JSON.parse(annotations);
                redrawAnnotations();
            } catch(e) {
                currentAnnotations = [];
            }
        } else {
            currentAnnotations = [];
        }
        drawingHistory = [currentAnnotations.slice()];
    };
    img.src = imageUrl;
    
    setupCanvasEvents();
}

function openPhotoEditorNew(imageUrl, index, isNewPhoto) {
    currentPhotoId = null;
    currentPhotoIndex = index;
    const modal = document.getElementById('photoEditorModal');
    modal.classList.add('active');
    
    // Add keyboard listener
    document.addEventListener('keydown', editorKeyHandler);
    
    canvas = document.getElementById('drawingCanvas');
    ctx = canvas.getContext('2d');
    currentImageUrl = imageUrl;
    
    const img = new Image();
    img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        const fileObj = selectedFiles[index];
        if (fileObj && fileObj.annotations) {
            currentAnnotations = fileObj.annotations;
            redrawAnnotations();
        } else {
            currentAnnotations = [];
        }
        drawingHistory = [currentAnnotations.slice()];
    };
    img.src = imageUrl;
    
    setupCanvasEvents();
}

function setupCanvasEvents() {
    canvas.onmousedown = startDrawing;
    canvas.onmousemove = draw;
    canvas.onmouseup = stopDrawing;
    canvas.onmouseleave = stopDrawing;
    
    // Touch events
    canvas.ontouchstart = function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    };
    
    canvas.ontouchmove = function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    };
    
    canvas.ontouchend = function(e) {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        canvas.dispatchEvent(mouseEvent);
    };
}

function getCanvasCoordinates(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
    };
}

function startDrawing(e) {
    isDrawing = true;
    const coords = getCanvasCoordinates(e);
    startX = coords.x;
    startY = coords.y;
    
    if (drawingMode === 'text') {
        const text = prompt('Escriba el texto:');
        if (text) {
            currentAnnotations.push({
                type: 'text',
                x: startX,
                y: startY,
                text: text,
                color: drawingColor
            });
            redrawAnnotations();
            drawingHistory.push(currentAnnotations.slice());
        }
        isDrawing = false;
    }
}

function draw(e) {
    if (!isDrawing || drawingMode === 'text') return;
    
    const coords = getCanvasCoordinates(e);
    
    if (drawingMode === 'draw') {
        currentAnnotations.push({
            type: 'line',
            x1: startX,
            y1: startY,
            x2: coords.x,
            y2: coords.y,
            color: drawingColor
        });
        startX = coords.x;
        startY = coords.y;
        redrawAnnotations();
    }
}

function stopDrawing(e) {
    if (!isDrawing) return;
    
    if (drawingMode === 'arrow') {
        const coords = getCanvasCoordinates(e);
        currentAnnotations.push({
            type: 'arrow',
            x1: startX,
            y1: startY,
            x2: coords.x,
            y2: coords.y,
            color: drawingColor
        });
        redrawAnnotations();
        drawingHistory.push(currentAnnotations.slice());
    } else if (drawingMode === 'draw') {
        drawingHistory.push(currentAnnotations.slice());
    }
    
    isDrawing = false;
}

function redrawAnnotations() {
    // Reload image
    const img = new Image();
    img.onload = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        
        // Draw all annotations
        currentAnnotations.forEach(annotation => {
            ctx.strokeStyle = annotation.color;
            ctx.lineWidth = 3;
            ctx.fillStyle = annotation.color;
            
            if (annotation.type === 'line') {
                ctx.beginPath();
                ctx.moveTo(annotation.x1, annotation.y1);
                ctx.lineTo(annotation.x2, annotation.y2);
                ctx.stroke();
            } else if (annotation.type === 'arrow') {
                drawArrow(ctx, annotation.x1, annotation.y1, annotation.x2, annotation.y2);
            } else if (annotation.type === 'text') {
                ctx.font = '24px Arial';
                ctx.fillText(annotation.text, annotation.x, annotation.y);
            }
        });
    };
    img.src = currentImageUrl;
}

function drawArrow(ctx, x1, y1, x2, y2) {
    const headLength = 20;
    const angle = Math.atan2(y2 - y1, x2 - x1);
    
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - headLength * Math.cos(angle - Math.PI / 6), y2 - headLength * Math.sin(angle - Math.PI / 6));
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - headLength * Math.cos(angle + Math.PI / 6), y2 - headLength * Math.sin(angle + Math.PI / 6));
    ctx.stroke();
}

function setDrawingMode(mode) {
    drawingMode = mode;
    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(mode + 'Btn').classList.add('active');
}

function setDrawingColor(color, element) {
    drawingColor = color;
    document.querySelectorAll('.color-swatch').forEach(sw => sw.classList.remove('active'));
    element.classList.add('active');
}

function undoDrawing() {
    if (drawingHistory.length > 1) {
        drawingHistory.pop();
        currentAnnotations = drawingHistory[drawingHistory.length - 1].slice();
        redrawAnnotations();
    }
}

function clearDrawing() {
    if (confirm('¿Eliminar todas las anotaciones?')) {
        currentAnnotations = [];
        drawingHistory = [[]];
        redrawAnnotations();
    }
}

function closePhotoEditor() {
    document.getElementById('photoEditorModal').classList.remove('active');
    // Remove keyboard listener
    document.removeEventListener('keydown', editorKeyHandler);
}

// Keyboard shortcuts for editor
function editorKeyHandler(e) {
    if (e.key === 'Escape') {
        closePhotoEditor();
    } else if (e.ctrlKey || e.metaKey) {
        if (e.key === 'z') {
            e.preventDefault();
            undoDrawing();
        } else if (e.key === 's') {
            e.preventDefault();
            saveAnnotations();
        }
    }
}

function saveAnnotations() {
    if (currentPhotoId) {
        // Saving to existing photo
        fetch(`/api/v1/changeorder-photo/${currentPhotoId}/annotations/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                annotations: JSON.stringify(currentAnnotations)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closePhotoEditor();
                // Show success message
                const toast = document.createElement('div');
                toast.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
                toast.style.zIndex = '11000';
                toast.innerHTML = '<i class="bi bi-check-circle-fill"></i> Anotaciones guardadas exitosamente';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        })
        .catch(err => {
            console.error('Error saving annotations:', err);
            alert('Error al guardar anotaciones');
        });
    } else if (currentPhotoIndex !== null) {
        // Saving to new photo (before upload)
        selectedFiles[currentPhotoIndex].annotations = currentAnnotations;
        closePhotoEditor();
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
        toast.style.zIndex = '11000';
        toast.innerHTML = '<i class="bi bi-check-circle-fill"></i> Anotaciones guardadas. Se aplicarán al enviar el formulario.';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
}

function deletePhoto(photoId) {
    if (!confirm('¿Eliminar esta foto permanentemente?')) return;
    
    fetch(`/api/v1/changeorder-photo/${photoId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelector(`[data-photo-id="${photoId}"]`).remove();
        }
    })
    .catch(err => {
        console.error('Error deleting photo:', err);
        alert('Error al eliminar la foto');
    });
}
</script>
{% endblock %}
