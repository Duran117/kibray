{% extends "core/base_modern.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% if is_edit %}{% trans "Editar" %}{% else %}{% trans "Crear" %}{% endif %} Change Order - Kibray{% endblock %}

{% block extra_css %}
<style>
    /* ===== CHANGE ORDER FORM REFINED (Clean Minimal) ===== */
    :root {
        --co-bg: #ffffff;
        --co-surface: #f8fafc;
        --co-border: #e2e8f0;
        --co-border-strong: #cbd5e1;
        --co-accent: #6366f1; /* Indigo */
        --co-accent-alt: #4f46e5;
        --co-danger: #dc2626;
        --co-success: #16a34a;
        --co-text: #1e293b;
        --co-text-soft: #64748b;
        --co-radius-lg: 16px;
        --co-radius-md: 10px;
        --co-shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
        --co-shadow-md: 0 4px 12px rgba(0,0,0,0.08);
        --co-shadow-lg: 0 10px 30px rgba(0,0,0,0.10);
        --co-transition: 0.18s cubic-bezier(.4,.0,.2,1);
    }
    .co-modern-container {max-width: 1000px;margin: 0 auto;}
    .co-card {background: var(--co-bg);border-radius: var(--co-radius-lg);border:1px solid var(--co-border);box-shadow: var(--co-shadow-md);padding: 1.75rem 1.75rem 2.25rem;margin-bottom: 1.75rem;}
    .co-header {display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;padding-bottom:1.25rem;border-bottom:1px solid var(--co-border);}
    .co-header-icon {width:52px;height:52px;background:var(--co-accent);border-radius:14px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.6rem;box-shadow: var(--co-shadow-sm);}
    .co-header-content h1 {font-size:1.6rem;font-weight:600;color:var(--co-text);margin:0;}
    .co-header-content p {margin:0;color:var(--co-text-soft);font-size:0.85rem;}
    .form-section {margin-bottom:1.75rem;}
    .form-section-title {font-size:0.95rem;font-weight:600;color:var(--co-text);margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;padding:0.6rem 0.75rem;background:var(--co-surface);border:1px solid var(--co-border);border-radius: var(--co-radius-md);}
    .form-section-title i {color:var(--co-accent);font-size:1.1rem;}
    .form-group {margin-bottom:1.25rem;}
    .form-group label {display:block;font-weight:600;color:var(--co-text-soft);margin-bottom:0.4rem;font-size:0.8rem;letter-spacing:.3px;text-transform:uppercase;}
    .form-group label.required::after {content:" *";color:var(--co-danger);}
    .form-control,.form-select {min-height:44px;border:1px solid var(--co-border-strong);border-radius: var(--co-radius-md);padding:0.6rem 0.85rem;font-size:0.9rem;transition:var(--co-transition);background:#fff;}
    .form-control:focus,.form-select:focus {border-color:var(--co-accent);box-shadow:0 0 0 3px rgba(99,102,241,.25);outline:none;}
    textarea.form-control {min-height:110px;resize:vertical;}
    /* Color Picker */
    .color-picker-wrapper {display:grid;grid-template-columns:1fr auto;gap:1rem;align-items:start;}
    .color-preview-box {width:72px;height:72px;border-radius:12px;border:2px solid var(--co-border);cursor:pointer;transition:var(--co-transition);box-shadow:var(--co-shadow-sm);background:linear-gradient(135deg,#ffffff,#f1f5f9);}
    .color-preview-box:hover {transform:scale(1.04);border-color:var(--co-accent);}
    .color-help-text {font-size:0.7rem;color:var(--co-text-soft);margin-top:0.35rem;}
    /* Upload Area */
    .photo-upload-area {border:2px dashed var(--co-border-strong);border-radius: var(--co-radius-md);padding:2.25rem 1.5rem;text-align:center;background:var(--co-surface);cursor:pointer;transition:var(--co-transition);margin-bottom:1.25rem;}
    .photo-upload-area:hover {border-color:var(--co-accent);background:#eef2ff;}
    .photo-upload-area i {font-size:2.75rem;color:var(--co-accent);margin-bottom:0.75rem;}
    .photo-upload-area p {margin:0.4rem 0;color:var(--co-text);font-size:0.85rem;}
    .photo-upload-area .upload-hint {font-size:0.7rem;color:var(--co-text-soft);}
    #photoInput {display:none;}
    /* New Photo Grid */
    .photo-preview-grid {display:none;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:0.75rem;margin-top:1.25rem;}
    .photo-preview-grid.has-photos {display:grid;}
    .photo-preview-item {position:relative;border-radius:10px;overflow:hidden;border:1px solid var(--co-border);background:#fff;box-shadow:var(--co-shadow-sm);transition:var(--co-transition);}
    .photo-preview-item:hover {box-shadow:var(--co-shadow-md);transform:translateY(-2px);border-color:var(--co-accent);}
    .photo-preview-item img {width:100%;height:120px;object-fit:cover;display:block;}
    .photo-preview-item .photo-info {padding:0.4rem;background:var(--co-surface);}
    .photo-preview-item input.photo-description {width:100%;padding:0.35rem 0.45rem;border:1px solid var(--co-border);border-radius:6px;font-size:0.65rem;background:#fff;}
    .photo-preview-item .remove-photo,.photo-preview-item .edit-photo-btn {position:absolute;top:0.35rem;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.85rem;line-height:1;border-radius:6px;padding:0.3rem 0.55rem;font-weight:600;letter-spacing:.5px;box-shadow:var(--co-shadow-sm);transition:var(--co-transition);}
    .photo-preview-item .remove-photo {right:0.35rem;background:var(--co-danger);color:#fff;}
    .photo-preview-item .remove-photo:hover {background:#b91c1c;transform:scale(1.08);}
    .photo-preview-item .edit-photo-btn {left:0.35rem;background:var(--co-accent);color:#fff;}
    .photo-preview-item .edit-photo-btn:hover {background:var(--co-accent-alt);transform:scale(1.05);}
    /* Existing Photos */
    .existing-photos {margin-bottom:1.25rem;}
    .existing-photo-item {position:relative;border:1px solid var(--co-border);border-radius:12px;overflow:hidden;background:#fff;box-shadow:var(--co-shadow-sm);transition:var(--co-transition);display:block;}
    .existing-photo-item:hover {box-shadow:var(--co-shadow-md);border-color:var(--co-accent);}
    .existing-photo-item .photo-actions {position:absolute;top:0.5rem;right:0.5rem;display:flex;gap:0.25rem;z-index:20;}
    .existing-photo-item .photo-actions button {background:rgba(99,102,241,0.8);color:#fff;border:none;padding:0.5rem;border-radius:0.375rem;font-size:10px;font-weight:600;cursor:pointer;transition:var(--co-transition);backdrop-filter:blur(4px);}
    .existing-photo-item .photo-actions button:hover {background:rgba(79,70,229,1);}
    .existing-photo-item .photo-actions .delete-btn {background:rgba(220,38,38,0.8);}
    .existing-photo-item .photo-actions .delete-btn:hover {background:rgba(185,28,28,1);}
    .existing-photos-grid {display:grid;gap:1rem;grid-template-columns:repeat(2,1fr);}
    @media (min-width: 640px) { .existing-photos-grid {grid-template-columns:repeat(3,1fr);} }
    @media (min-width: 768px) { .existing-photos-grid {grid-template-columns:repeat(4,1fr);} }
    @media (min-width: 1024px) { .existing-photos-grid {grid-template-columns:repeat(5,1fr);} }
    @media (min-width: 1280px) { .existing-photos-grid {grid-template-columns:repeat(6,1fr);} }
    /* Modal */
    .photo-editor-modal {position:fixed;inset:0;width:100vw;height:100vh;background:rgba(0,0,0,.85);z-index:10000;display:none;align-items:center;justify-content:center;}
    .photo-editor-modal.active {display:flex;}
    .photo-editor-content {background:#ffffff;width:100%;height:100%;display:flex;flex-direction:column;}
    .photo-editor-header {display:flex;justify-content:space-between;align-items:center;padding:0.85rem 1.25rem;background:#fff;border-bottom:1px solid var(--co-border);}
    .photo-editor-header h3 {margin:0;color:var(--co-text);font-size:1rem;font-weight:600;display:flex;align-items:center;gap:0.5rem;}
    .photo-editor-header .btn-close {background:transparent;border:none;color:var(--co-text-soft);font-size:1.4rem;cursor:pointer;width:38px;height:38px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:var(--co-transition);}
    .photo-editor-header .btn-close:hover {background:#fee2e2;color:var(--co-danger);}
    .canvas-container {flex:1;display:flex;align-items:center;justify-content:center;overflow:auto;background:var(--co-surface);padding:1rem;}
    #drawingCanvas {max-width:100%;max-height:100%;border:2px solid var(--co-border);border-radius:12px;background:#fff;box-shadow:var(--co-shadow-sm);}
    .drawing-tools {display:flex;gap:0.5rem;padding:0.6rem 0.75rem;background:#fff;border-top:1px solid var(--co-border);flex-wrap:wrap;align-items:center;}
    .tool-btn {padding:0.55rem 0.9rem;border:1px solid var(--co-border-strong);background:var(--co-surface);color:var(--co-text);border-radius:8px;cursor:pointer;font-weight:600;transition:var(--co-transition);font-size:0.75rem;display:flex;align-items:center;gap:0.4rem;}
    .tool-btn:hover {background:#eef2ff;border-color:var(--co-accent);}
    .tool-btn.active {background:var(--co-accent);color:#fff;border-color:var(--co-accent);}
    .tool-btn i {font-size:0.85rem;}
    .color-selector {display:flex;gap:0.4rem;align-items:center;margin-left:auto;padding:0.4rem 0.6rem;background:var(--co-surface);border-radius:8px;border:1px solid var(--co-border);}
    .color-selector span {color:var(--co-text-soft);font-weight:600;font-size:0.65rem;margin-right:0.25rem;text-transform:uppercase;letter-spacing:.5px;}
    .color-swatch {width:30px;height:30px;border:2px solid var(--co-border-strong);border-radius:6px;cursor:pointer;transition:var(--co-transition);position:relative;}
    .color-swatch:hover {transform:scale(1.08);border-color:var(--co-accent);}
    .color-swatch.active {border-color:var(--co-accent);box-shadow:0 0 0 2px rgba(99,102,241,.4);}
    .color-swatch.active::after {content:'✓';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:0.9rem;font-weight:600;text-shadow:0 1px 2px rgba(0,0,0,.4);}
    .editor-actions {display:flex;gap:0.6rem;padding:0.75rem 0.9rem;background:#fff;border-top:1px solid var(--co-border);}
    .editor-actions .btn {padding:0.65rem 1rem;font-weight:600;font-size:0.75rem;border-radius:8px;min-height:42px;transition:var(--co-transition);display:flex;align-items:center;justify-content:center;gap:0.4rem;}
    .editor-actions .btn-secondary {flex:1;background:var(--co-surface);border:1px solid var(--co-border);color:var(--co-text-soft);}
    .editor-actions .btn-secondary:hover {background:#f1f5f9;color:var(--co-text);}
    .editor-actions .btn-success {flex:2;background:var(--co-success);border:1px solid var(--co-success);color:#fff;}
    .editor-actions .btn-success:hover {filter:brightness(1.08);}
    /* Form Actions */
    .form-actions {display:flex;gap:0.75rem;margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--co-border);}
    .form-actions .btn {flex:1;padding:0.75rem 1rem;font-weight:600;font-size:0.85rem;border-radius:8px;min-height:44px;}
    .btn-primary {background:var(--co-accent);border:none;}
    .btn-primary:hover {background:var(--co-accent-alt);}
    .errorlist {list-style:none;padding:0;margin:0.4rem 0 0;}
    .errorlist li {color:var(--co-danger);font-size:0.7rem;padding:0.4rem;background:#fee2e2;border-radius:6px;margin-top:0.25rem;}
    @media (max-width:768px){.co-card{padding:1.25rem}.photo-preview-grid{grid-template-columns:repeat(auto-fill,minmax(110px,1fr))}.form-actions{flex-direction:column}}
</style>
{% endblock %}

{% block content %}
<div class="co-modern-container max-w-5xl mx-auto px-4 lg:px-8">
    <div class="co-card relative bg-white rounded-2xl shadow-md ring-1 ring-slate-200/70">
        {% if is_edit %}
        <a href="{% url 'changeorder_detail' changeorder.id %}"
           class="absolute top-4 right-4 z-10 inline-flex items-center gap-2 rounded-lg border border-slate-300 bg-white/90 hover:bg-white px-3.5 py-2 text-sm font-semibold text-slate-700 shadow-sm backdrop-blur">
            <i class="bi bi-arrow-left"></i>
            {% trans "Volver al CO" %}
        </a>
        {% endif %}
        <div class="co-header">
            <div class="co-header-icon">
                <i class="bi bi-{% if is_edit %}pencil-square{% else %}plus-circle-fill{% endif %}"></i>
            </div>
            <div class="co-header-content">
                {% if is_edit %}
                <h1>{% blocktrans with co_id=changeorder.id %}Editar Change Order #{{ co_id }}{% endblocktrans %}</h1>
                <p>{% trans "Complete la información del change order y actualice los campos necesarios" %}</p>
                {% else %}
                <h1>{% trans "Nuevo Change Order" %}</h1>
                <p>{% trans "Complete la información del change order" %}</p>
                {% endif %}
            </div>
        </div>

    <form method="post" enctype="multipart/form-data" class="space-y-10">
            {% csrf_token %}
            
            <!-- Basic Information Section -->
            <div class="form-section bg-white/80 backdrop-blur-sm rounded-xl p-6 mb-8 shadow-sm ring-1 ring-slate-200 space-y-6">
                <div class="form-section-title">
                    <i class="bi bi-info-circle-fill"></i>
                    {% trans "Información Básica" %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.description.id_for_label }}" class="required">{% trans "Descripción" %}</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <ul class="errorlist">
                            {% for error in form.description.errors %}<li>{{ error }}</li>{% endfor %}
                        </ul>
                    {% endif %}
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.amount.id_for_label }}" class="required">{% trans "Monto" %}</label>
                            {{ form.amount }}
                            {% if form.amount.errors %}
                                <ul class="errorlist">
                                    {% for error in form.amount.errors %}<li>{{ error }}</li>{% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.status.id_for_label }}" class="required">{% trans "Estado" %}</label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <ul class="errorlist">
                                    {% for error in form.status.errors %}<li>{{ error }}</li>{% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.notes.id_for_label }}">{% trans "Notas" %}</label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <ul class="errorlist">
                            {% for error in form.notes.errors %}<li>{{ error }}</li>{% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
            
            <!-- Color Selection Section -->
            <div class="form-section bg-white/80 backdrop-blur-sm rounded-xl p-6 mb-8 shadow-sm ring-1 ring-slate-200 space-y-6">
                <div class="form-section-title">
                    <i class="bi bi-palette-fill"></i>
                    {% trans "Selección de Color" %}
                </div>
                
                <div class="color-picker-wrapper">
                    <div class="color-input-group">
                        {# Server-side fallback: show dropdown immediately if approved_colors exist #}
                        <div class="form-group" id="approvedColorsGroup" style="{% if approved_colors %}display:block;{% else %}display:none;{% endif %}">
                            <label for="approvedColorSelect">{% trans "Colores Aprobados del Proyecto" %}</label>
                            <select id="approvedColorSelect" class="form-select" onchange="selectApprovedColor(this)">
                                <option value="">{% trans "-- Seleccionar color aprobado --" %}</option>
                                {% for color_sample in approved_colors %}
                                <option value="{{ color_sample.code }}" 
                                        data-brand="{{ color_sample.brand }}"
                                        data-name="{{ color_sample.name }}">
                                    {{ color_sample.code }}{% if color_sample.name %} - {{ color_sample.name }}{% endif %}
                                    {% if color_sample.brand %} ({{ color_sample.brand }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <p class="color-help-text">{% trans "Seleccione un color aprobado para este proyecto" %}</p>
                        </div>
                        
                        {# Server-side fallback: show message if no approved colors #}
                        <div class="form-group" id="noColorsMessage" style="{% if not approved_colors %}display:block;{% else %}display:none;{% endif %}">
                            <div class="alert alert-warning" role="alert">
                                <i class="bi bi-info-circle"></i> 
                                <strong>{% trans "Este proyecto no tiene colores aprobados." %}</strong><br>
                                {% trans "Puede usar el selector de color manual a continuación." %}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.color.id_for_label }}">{% trans "Color (Hex) - Manual" %}</label>
                            {{ form.color }}
                            <p class="color-help-text">{% trans "O escriba un código hex manualmente (ej: #FF5733)" %}</p>
                            {% if form.color.errors %}
                                <ul class="errorlist">
                                    {% for error in form.color.errors %}<li>{{ error }}</li>{% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.reference_code.id_for_label }}">{% trans "Código de Referencia o Material" %}</label>
                            {{ form.reference_code }}
                            <p class="color-help-text">{% trans "Para hacer match con madera, metal u otro material (ej: \"Madera X\", \"Metal Z\")" %}</p>
                            {% if form.reference_code.errors %}
                                <ul class="errorlist">
                                    {% for error in form.reference_code.errors %}<li>{{ error }}</li>{% endfor %}
                                </ul>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="color-preview-box" id="colorPreview" onclick="document.getElementById('{{ form.color.id_for_label }}').click()"></div>
                </div>
            </div>
            
            <!-- Photos Section -->
            <div class="form-section bg-white/80 backdrop-blur-sm rounded-xl p-6 mb-10 shadow-sm ring-1 ring-slate-200 space-y-6">
                <div class="form-section-title">
                    <i class="bi bi-camera-fill"></i>
                    {% trans "Fotos del Proyecto" %}
                </div>
                
                <div class="alert alert-info d-flex align-items-start gap-2 rounded-lg shadow-sm" role="alert" style="font-size:0.9rem;">
                    <i class="bi bi-info-circle-fill" style="font-size:1.2rem; margin-top:0.1rem;"></i>
                    <div>
                        <strong>{% trans "Cómo subir fotos:" %}</strong>
                        <ol style="margin:0.5rem 0 0 0; padding-left:1.2rem;">
                            <li>{% trans "Haga clic en el área azul para seleccionar fotos" %}</li>
                            <li>{% trans "Verá miniaturas de las fotos seleccionadas" %}</li>
                            <li>{% trans "Opcional: Haga clic en \"Editar\" para anotar/dibujar sobre una foto" %}</li>
                            <li>{% trans "Opcional: Agregue descripciones en los campos de texto" %}</li>
                            {% if is_edit %}
                            <li>{% blocktrans %}Haga clic en <strong>"Guardar Cambios"</strong> al final del formulario para subir las fotos{% endblocktrans %}</li>
                            {% else %}
                            <li>{% blocktrans %}Haga clic en <strong>"Crear Change Order"</strong> al final del formulario para subir las fotos{% endblocktrans %}</li>
                            {% endif %}
                        </ol>
                    </div>
                </div>
                
                {% if is_edit and changeorder.photos.all %}
                <div class="existing-photos mt-6">
                    <p style="font-weight: 600; margin-bottom: 0.75rem; color: #475569;">{% trans "Fotos Existentes:" %}</p>
                    <div class="existing-photos-grid">
                        {% for photo in changeorder.photos.all %}
                        <div class="existing-photo-item" data-photo-id="{{ photo.id }}" style="aspect-ratio: 1/1; min-height: 0;">
                            <script type="application/json" class="photo-annotations-data">{{ photo.annotations|safe }}</script>
                            <div style="position: relative; width: 100%; height: 100%;">
                                <img src="{{ photo.image.url }}" alt="{{ photo.description }}" class="photo-thumb-base" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;">
                                <canvas class="photo-annotations-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;"></canvas>
                                <div class="photo-actions">
                                    <button type="button" class="edit-btn" data-photo-id="{{ photo.id }}" data-image-url="{{ photo.image.url }}">
                                        <i class="bi bi-pencil"></i><span style="display: none;">{% trans "Editar" %}</span>
                                    </button>
                                    <button type="button" class="delete-btn" data-photo-id="{{ photo.id }}">
                                        <i class="bi bi-trash"></i><span class="sr-only">{% trans "Eliminar" %}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <div class="photo-upload-area relative flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-indigo-300/70 hover:border-indigo-500 hover:bg-indigo-50 transition cursor-pointer py-10" onclick="document.getElementById('photoInput').click()">
                    <i class="bi bi-cloud-upload text-indigo-600 text-5xl mb-3"></i>
                    <p class="text-slate-700 font-semibold"><strong>{% trans "Haga clic para subir fotos" %}</strong></p>
                    <p class="upload-hint text-xs text-slate-500 mt-1">{% trans "Puede seleccionar múltiples archivos (JPG, PNG, HEIC) - Máx 10MB por foto" %}</p>
                </div>
                {# Photo input: ensure proper attributes; name as photos to allow getlist; add capture for mobile #}
                <input type="file" id="photoInput" name="photos" accept="image/*" multiple capture="environment">
                <div id="photoErrorMessage" style="display:none; color:#b91c1c; font-size:0.85rem; margin-top:0.5rem;"></div>
                
                <div id="photoPreviewGrid" class="photo-preview-grid grid gap-4 mt-6"></div>
                
                <div id="photoCountBadge" style="display:none;" class="mt-4 px-4 py-3 bg-indigo-50 border border-indigo-300 rounded-lg text-center font-semibold text-indigo-700 flex items-center justify-center gap-2">
                    <i class="bi bi-check-circle-fill" style="color:#16a34a;"></i>
                    <span id="photoCountText">{% trans "0 fotos" %}</span> {% trans "seleccionadas - Haga clic en \"Guardar\" al final para subirlas" %}
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="form-actions flex flex-col sm:flex-row gap-4 pt-8 border-t border-slate-200">
                <a href="{% url 'changeorder_board' %}" class="btn btn-secondary inline-flex items-center justify-center rounded-lg border border-slate-300 bg-white text-slate-600 hover:bg-slate-50 px-5 py-3 text-sm font-semibold shadow-sm">
                    <i class="bi bi-x-circle mr-2"></i> {% trans "Cancelar" %}
                </a>
                <button type="submit" class="btn btn-primary inline-flex items-center justify-center rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 text-sm font-semibold shadow-sm">
                    <i class="bi bi-check-circle mr-2"></i> {% if is_edit %}{% trans "Guardar Cambios" %}{% else %}{% trans "Crear Change Order" %}{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

{% if is_edit %}
<!-- Floating back button for mobile -->
<a href="{% url 'changeorder_detail' changeorder.id %}"
     class="md:hidden fixed bottom-5 right-5 z-50 inline-flex items-center justify-center gap-2 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg px-4 py-3">
        <i class="bi bi-arrow-left text-lg"></i>
        <span class="sr-only">{% trans "Volver al CO" %}</span>
    </a>
{% endif %}

<!-- Photo Editor Modal - Fullscreen -->
<div class="photo-editor-modal" id="photoEditorModal">
    <div class="photo-editor-content">
        <div class="photo-editor-header">
            <h3>
                <i class="bi bi-pencil-square"></i> 
                {% trans "Editor de Fotos" %}
            </h3>
            <button type="button" class="btn-close" onclick="closePhotoEditor()" aria-label="{% trans "Cerrar" %}">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="drawing-tools">
            <button type="button" class="tool-btn active" onclick="setDrawingMode('draw')" id="drawBtn">
                <i class="bi bi-pencil-fill"></i> {% trans "Dibujar" %}
            </button>
            <button type="button" class="tool-btn" onclick="setDrawingMode('arrow')" id="arrowBtn">
                <i class="bi bi-arrow-up-right"></i> {% trans "Flecha" %}
            </button>
            <button type="button" class="tool-btn" onclick="setDrawingMode('text')" id="textBtn">
                <i class="bi bi-fonts"></i> {% trans "Texto" %}
            </button>
            <button type="button" class="tool-btn" onclick="undoDrawing()">
                <i class="bi bi-arrow-counterclockwise"></i> {% trans "Deshacer" %}
            </button>
            <button type="button" class="tool-btn" onclick="clearDrawing()">
                <i class="bi bi-trash3"></i> {% trans "Limpiar Todo" %}
            </button>
            
            <div class="color-selector">
                <span>{% trans "Color:" %}</span>
                <div class="color-swatch active" style="background:#dc2626;" onclick="setDrawingColor('#dc2626', this)" title="{% trans 'Rojo' %}"></div>
                <div class="color-swatch" style="background:#2563eb;" onclick="setDrawingColor('#2563eb', this)" title="{% trans 'Azul' %}"></div>
                <div class="color-swatch" style="background:#16a34a;" onclick="setDrawingColor('#16a34a', this)" title="{% trans 'Verde' %}"></div>
                <div class="color-swatch" style="background:#f59e0b;" onclick="setDrawingColor('#f59e0b', this)" title="{% trans 'Amarillo' %}"></div>
                <div class="color-swatch" style="background:#000000;" onclick="setDrawingColor('#000000', this)" title="{% trans 'Negro' %}"></div>
                <div class="color-swatch" style="background:#ffffff; border-color:#94a3b8;" onclick="setDrawingColor('#ffffff', this)" title="{% trans 'Blanco' %}"></div>
            </div>
        </div>
        
        <div class="canvas-container">
            <canvas id="drawingCanvas"></canvas>
        </div>
        
        <div class="editor-actions">
            <button type="button" class="btn btn-secondary" onclick="closePhotoEditor()">
                <i class="bi bi-x-circle"></i> {% trans "Cancelar" %}
            </button>
            <button type="button" class="btn btn-success" onclick="saveAnnotations()">
                <i class="bi bi-check-circle-fill"></i> {% trans "Guardar Anotaciones" %}
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Color preview and approved colors
const colorInput = document.getElementById('{{ form.color.id_for_label }}');
const colorPreview = document.getElementById('colorPreview');
const referenceCodeInput = document.getElementById('{{ form.reference_code.id_for_label }}');
const projectSelect = document.getElementById('{{ form.project.id_for_label }}');

// DEBUG: Log to verify elements are found
console.log('=== CHANGE ORDER FORM DEBUG ===');
console.log('colorInput:', colorInput);
console.log('colorPreview:', colorPreview);
console.log('projectSelect:', projectSelect);
console.log('projectSelect.value:', projectSelect ? projectSelect.value : 'N/A');

// Update color preview
if (colorInput && colorPreview) {
    function updateColorPreview() {
        const color = colorInput.value || '#000000';
        colorPreview.style.background = color;
    }
    colorInput.addEventListener('input', updateColorPreview);
    updateColorPreview();
}

// Load approved colors when project changes
if (projectSelect) {
    console.log('Adding change event listener to projectSelect');
    projectSelect.addEventListener('change', function() {
        const projectId = this.value;
        console.log('Project changed to:', projectId);
        if (projectId) {
            loadApprovedColors(projectId);
        } else {
            // Hide both if no project selected
            const approvedColorsGroup = document.getElementById('approvedColorsGroup');
            const noColorsMessage = document.getElementById('noColorsMessage');
            if (approvedColorsGroup) approvedColorsGroup.style.display = 'none';
            if (noColorsMessage) noColorsMessage.style.display = 'none';
        }
    });
    
    // Load colors on page load if project is already selected (edit mode)
    if (projectSelect.value) {
        loadApprovedColors(projectSelect.value);
    }
}

function loadApprovedColors(projectId) {
       console.log('loadApprovedColors called with projectId:', projectId);
    fetch(`/api/projects/${projectId}/approved-colors/`)
        .then(response => response.json())
        .then(data => {
               console.log('Approved colors received:', data);
            const approvedColorsGroup = document.getElementById('approvedColorsGroup');
            const approvedColorSelect = document.getElementById('approvedColorSelect');
            const noColorsMessage = document.getElementById('noColorsMessage');
            
            if (data.colors && data.colors.length > 0) {
                // Clear and populate select
                approvedColorSelect.innerHTML = '<option value="">-- Seleccionar color aprobado --</option>';
                data.colors.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color.code || '';
                    option.setAttribute('data-brand', color.brand || '');
                    option.setAttribute('data-name', color.name || '');
                    option.textContent = color.code || '';
                    if (color.name) option.textContent += ' - ' + color.name;
                    if (color.brand) option.textContent += ' (' + color.brand + ')';
                    approvedColorSelect.appendChild(option);
                });
                // Show the group, hide the message
                if (approvedColorsGroup) approvedColorsGroup.style.display = 'block';
                if (noColorsMessage) noColorsMessage.style.display = 'none';
            } else {
                // Hide dropdown, show message
                if (approvedColorsGroup) approvedColorsGroup.style.display = 'none';
                if (noColorsMessage) noColorsMessage.style.display = 'block';
            }
        })
        .catch(err => {
            console.error('Error loading approved colors:', err);
            // On error, show message
            const approvedColorsGroup = document.getElementById('approvedColorsGroup');
            const noColorsMessage = document.getElementById('noColorsMessage');
            if (approvedColorsGroup) approvedColorsGroup.style.display = 'none';
            if (noColorsMessage) noColorsMessage.style.display = 'block';
        });
}

function selectApprovedColor(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const code = selectedOption.value;
    const brand = selectedOption.getAttribute('data-brand');
    const name = selectedOption.getAttribute('data-name');
    
    if (code && colorInput) {
        // Try to parse hex from code if it looks like one
        if (code.startsWith('#')) {
            colorInput.value = code;
        }
        // Update reference field with full info
        if (referenceCodeInput) {
            let refText = code;
            if (brand) refText += ` - ${brand}`;
            if (name) refText += ` (${name})`;
            referenceCodeInput.value = refText;
        }
        updateColorPreview();
    }
}

// Photo preview with immediate editor
const photoInput = document.getElementById('photoInput');
const photoPreviewGrid = document.getElementById('photoPreviewGrid');

// DEBUG: Log photo elements
console.log('photoInput:', photoInput);
console.log('photoPreviewGrid:', photoPreviewGrid);

let selectedFiles = [];
let pendingPhotoIndex = null;
let editedIndices = new Set(); // Track which photos have been edited

photoInput.addEventListener('change', function(e) {
       console.log('Photo input changed, files:', e.target.files);
       const errorBox = document.getElementById('photoErrorMessage');
       if (errorBox) { errorBox.style.display='none'; errorBox.textContent=''; }
       if (!e.target.files || e.target.files.length === 0) {
           console.warn('No files selected');
           return;
       }
       // Basic validation: size and type
       const validImages = [];
       for (const f of e.target.files) {
           if (!f.type.startsWith('image/')) {
               console.warn('Skipping non-image file:', f.name);
               continue;
           }
           if (f.size > 10 * 1024 * 1024) { // 10MB limit
               console.warn('Skipping large file (>10MB):', f.name);
               if (errorBox) {
                   errorBox.style.display='block';
                   errorBox.textContent='Algún archivo supera el límite de 10MB y fue omitido.';
               }
               continue;
           }
           validImages.push(f);
       }
       if (validImages.length === 0) {
           console.warn('No valid images after filtering');
           return;
       }
    const files = Array.from(e.target.files);
    
    // Add files to selectedFiles array
    validImages.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const newIndex = selectedFiles.length;
            
            selectedFiles.push({
                file: file,
                dataUrl: e.target.result,
                description: '',
                annotations: []
            });
            
            // Render preview immediately
            renderPhotoPreview();
        };
        reader.readAsDataURL(file);
    });
    
    // Reset input to allow selecting same file again
    photoInput.value = '';
});

function renderPhotoPreview() {
    console.log('renderPhotoPreview called, selectedFiles:', selectedFiles.length);
    if (!photoPreviewGrid) {
        console.error('photoPreviewGrid element not found!');
        return;
    }
    
    photoPreviewGrid.innerHTML = '';
    
    const countBadge = document.getElementById('photoCountBadge');
    const countText = document.getElementById('photoCountText');
    
    // Toggle visibility based on content
    if (selectedFiles.length > 0) {
        photoPreviewGrid.classList.add('has-photos');
        if (countBadge) {
            countBadge.style.display = 'block';
            if (countText) {
                countText.textContent = `${selectedFiles.length} foto${selectedFiles.length !== 1 ? 's' : ''}`;
            }
        }
    } else {
        photoPreviewGrid.classList.remove('has-photos');
        if (countBadge) countBadge.style.display = 'none';
    }
    
    selectedFiles.forEach((fileObj, index) => {
        const div = document.createElement('div');
        div.className = 'photo-preview-item';
        div.innerHTML = `
            <img src="${fileObj.dataUrl}" alt="Foto ${index + 1}" onclick="openPhotoEditorNew('${fileObj.dataUrl}', ${index}, false)" title="Clic para editar">
            <button type="button" class="remove-photo" onclick="removePhoto(${index})" title="Eliminar">&times;</button>
            <button type="button" class="edit-photo-btn" onclick="openPhotoEditorNew('${fileObj.dataUrl}', ${index}, false)" title="Editar">
                <i class="bi bi-pencil"></i>
            </button>
            <div class="photo-info">
                <input type="text" class="photo-description" name="photo_description_${index}" 
                       placeholder="Descripción..." value="${fileObj.description || ''}"
                       onchange="updatePhotoDescription(${index}, this.value)">
            </div>
        `;
        photoPreviewGrid.appendChild(div);
        console.log('Added preview for photo', index);
    });
    
    // Update the actual file input
    updateFileInput();
}

function updatePhotoDescription(index, description) {
    console.log('updatePhotoDescription:', index, description);
    if (selectedFiles[index]) {
        selectedFiles[index].description = description;
    }
}

function removePhoto(index) {
    console.log('removePhoto called for index:', index);
    if (confirm('¿Eliminar esta foto?')) {
        selectedFiles.splice(index, 1);
        renderPhotoPreview();
    }
}

function updateFileInput() {
    // Create a new DataTransfer object to hold our files
    const dt = new DataTransfer();
    selectedFiles.forEach(fileObj => {
        if (fileObj.file) {
            dt.items.add(fileObj.file);
        }
    });
    // Update the input's files
    photoInput.files = dt.files;
}

// Canvas Drawing with corrected cursor precision
let canvas, ctx, isDrawing = false, drawingMode = 'draw';
let startX, startY, currentAnnotations = [], currentPhotoId = null, currentPhotoIndex = null;
let drawingHistory = [];
let currentImageUrl = null;
let drawingColor = '#dc2626';

function openPhotoEditor(imageUrl, photoId, annotations) {
    currentPhotoId = photoId;
    currentPhotoIndex = null;
    const modal = document.getElementById('photoEditorModal');
    modal.classList.add('active');
    
    // Add keyboard listener
    document.addEventListener('keydown', editorKeyHandler);
    
    canvas = document.getElementById('drawingCanvas');
    ctx = canvas.getContext('2d');
    currentImageUrl = imageUrl;
    
    const img = new Image();
    img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        if (annotations) {
            let parsed = [];
            try { parsed = JSON.parse(annotations); } catch (e) { parsed = []; }
            currentAnnotations = parsed;
            redrawAnnotations();
        } else {
            currentAnnotations = [];
        }
        drawingHistory = [currentAnnotations.slice()];
    };
    img.src = imageUrl;
    
    setupCanvasEvents();
}

function openPhotoEditorNew(imageUrl, index, isNewPhoto) {
    currentPhotoId = null;
    currentPhotoIndex = index;
    const modal = document.getElementById('photoEditorModal');
    modal.classList.add('active');
    
    // Add keyboard listener
    document.addEventListener('keydown', editorKeyHandler);
    
    canvas = document.getElementById('drawingCanvas');
    ctx = canvas.getContext('2d');
    currentImageUrl = imageUrl;
    
    const img = new Image();
    img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        const fileObj = selectedFiles[index];
        if (fileObj && fileObj.annotations) {
            currentAnnotations = fileObj.annotations;
            redrawAnnotations();
        } else {
            currentAnnotations = [];
        }
        drawingHistory = [currentAnnotations.slice()];
    };
    img.src = imageUrl;
    
    setupCanvasEvents();
}

function setupCanvasEvents() {
    canvas.onmousedown = startDrawing;
    canvas.onmousemove = draw;
    canvas.onmouseup = stopDrawing;
    canvas.onmouseleave = stopDrawing;
    
    // Touch events
    canvas.ontouchstart = function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    };
    
    canvas.ontouchmove = function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    };
    
    canvas.ontouchend = function(e) {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        canvas.dispatchEvent(mouseEvent);
    };
}

function getCanvasCoordinates(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
    };
}

function startDrawing(e) {
    isDrawing = true;
    const coords = getCanvasCoordinates(e);
    startX = coords.x;
    startY = coords.y;
    
    if (drawingMode === 'text') {
        const text = prompt('Escriba el texto:');
        if (text) {
            currentAnnotations.push({
                type: 'text',
                x: startX,
                y: startY,
                text: text,
                color: drawingColor
            });
            redrawAnnotations();
            drawingHistory.push(currentAnnotations.slice());
        }
        isDrawing = false;
    }
}

function draw(e) {
    if (!isDrawing || drawingMode === 'text') return;
    
    const coords = getCanvasCoordinates(e);
    
    if (drawingMode === 'draw') {
        currentAnnotations.push({
            type: 'line',
            x1: startX,
            y1: startY,
            x2: coords.x,
            y2: coords.y,
            color: drawingColor
        });
        startX = coords.x;
        startY = coords.y;
        redrawAnnotations();
    }
}

function stopDrawing(e) {
    if (!isDrawing) return;
    
    if (drawingMode === 'arrow') {
        const coords = getCanvasCoordinates(e);
        currentAnnotations.push({
            type: 'arrow',
            x1: startX,
            y1: startY,
            x2: coords.x,
            y2: coords.y,
            color: drawingColor
        });
        redrawAnnotations();
        drawingHistory.push(currentAnnotations.slice());
    } else if (drawingMode === 'draw') {
        drawingHistory.push(currentAnnotations.slice());
    }
    
    isDrawing = false;
}

function redrawAnnotations() {
    // Reload image
    const img = new Image();
    img.onload = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        
        // Draw all annotations
        currentAnnotations.forEach(annotation => {
            ctx.strokeStyle = annotation.color;
            ctx.lineWidth = 3;
            ctx.fillStyle = annotation.color;
            
            if (annotation.type === 'line') {
                ctx.beginPath();
                ctx.moveTo(annotation.x1, annotation.y1);
                ctx.lineTo(annotation.x2, annotation.y2);
                ctx.stroke();
            } else if (annotation.type === 'arrow') {
                drawArrow(ctx, annotation.x1, annotation.y1, annotation.x2, annotation.y2);
            } else if (annotation.type === 'text') {
                ctx.font = '24px Arial';
                ctx.fillText(annotation.text, annotation.x, annotation.y);
            }
        });
    };
    img.src = currentImageUrl;
}

function drawArrow(ctx, x1, y1, x2, y2) {
    const headLength = 20;
    const angle = Math.atan2(y2 - y1, x2 - x1);
    
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - headLength * Math.cos(angle - Math.PI / 6), y2 - headLength * Math.sin(angle - Math.PI / 6));
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - headLength * Math.cos(angle + Math.PI / 6), y2 - headLength * Math.sin(angle + Math.PI / 6));
    ctx.stroke();
}

function setDrawingMode(mode) {
    drawingMode = mode;
    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(mode + 'Btn').classList.add('active');
}

function setDrawingColor(color, element) {
    drawingColor = color;
    document.querySelectorAll('.color-swatch').forEach(sw => sw.classList.remove('active'));
    element.classList.add('active');
}

function undoDrawing() {
    if (drawingHistory.length > 1) {
        drawingHistory.pop();
        currentAnnotations = drawingHistory[drawingHistory.length - 1].slice();
        redrawAnnotations();
    }
}

function clearDrawing() {
    if (confirm('¿Eliminar todas las anotaciones?')) {
        currentAnnotations = [];
        drawingHistory = [[]];
        redrawAnnotations();
    }
}

function closePhotoEditor() {
    document.getElementById('photoEditorModal').classList.remove('active');
    // Remove keyboard listener
    document.removeEventListener('keydown', editorKeyHandler);
}

// Keyboard shortcuts for editor
function editorKeyHandler(e) {
    if (e.key === 'Escape') {
        closePhotoEditor();
    } else if (e.ctrlKey || e.metaKey) {
        if (e.key === 'z') {
            e.preventDefault();
            undoDrawing();
        } else if (e.key === 's') {
            e.preventDefault();
            saveAnnotations();
        }
    }
}

function saveAnnotations() {
    if (currentPhotoId) {
        // Saving to existing photo
        fetch(`/api/v1/changeorder-photo/${currentPhotoId}/annotations/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                annotations: JSON.stringify(currentAnnotations)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // After saving annotations, also save the annotated image
                const annotatedImageData = canvas.toDataURL('image/png');
                return fetch(`/api/v1/changeorder-photo/${currentPhotoId}/annotated-image/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        image_data: annotatedImageData
                    })
                });
            } else {
                throw new Error('Failed to save annotations');
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Refresh the thumbnail with the new annotated image
                redrawThumbnail(currentPhotoId, currentAnnotations);
                closePhotoEditor();
                // Show success message
                const toast = document.createElement('div');
                toast.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3';
                toast.style.zIndex = '11000';
                toast.innerHTML = '<i class="bi bi-check-circle-fill"></i> Anotaciones guardadas exitosamente';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }
        })
        .catch(err => {
            console.error('Error saving annotations:', err);
            alert('Error al guardar anotaciones');
        });
    } else if (currentPhotoIndex !== null) {
        // Saving to new photo (before upload)
        selectedFiles[currentPhotoIndex].annotations = currentAnnotations;
        closePhotoEditor();
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
        toast.style.zIndex = '11000';
        toast.innerHTML = '<i class="bi bi-check-circle-fill"></i> Anotaciones guardadas. Se aplicarán al enviar el formulario.';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
}

// Helper function to redraw annotations on thumbnail canvas
function redrawThumbnail(photoId, annotations) {
    const photoItem = document.querySelector(`[data-photo-id="${photoId}"]`);
    if (!photoItem) return;
    
    const canvas = photoItem.querySelector('.photo-annotations-canvas');
    const img = photoItem.querySelector('img');
    if (!canvas || !img) return;
    
    const ctx = canvas.getContext('2d');
    canvas.width = img.naturalWidth || img.width;
    canvas.height = img.naturalHeight || img.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (!annotations || annotations.length === 0) return;
    
    annotations.forEach(ann => {
        if (ann.type === 'draw') {
            ctx.strokeStyle = ann.color || '#dc2626';
            ctx.lineWidth = ann.lineWidth || 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();
            ann.points.forEach((pt, i) => {
                if (i === 0) ctx.moveTo(pt.x, pt.y);
                else ctx.lineTo(pt.x, pt.y);
            });
            ctx.stroke();
        } else if (ann.type === 'text') {
            ctx.font = `${ann.fontSize || 24}px Arial`;
            ctx.fillStyle = ann.color || '#dc2626';
            ctx.fillText(ann.text, ann.x, ann.y);
        } else if (ann.type === 'arrow') {
            ctx.strokeStyle = ann.color || '#dc2626';
            ctx.lineWidth = ann.lineWidth || 3;
            ctx.fillStyle = ann.color || '#dc2626';
            const headLength = 20;
            const angle = Math.atan2(ann.y2 - ann.y1, ann.x2 - ann.x1);
            ctx.beginPath();
            ctx.moveTo(ann.x1, ann.y1);
            ctx.lineTo(ann.x2, ann.y2);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(ann.x2, ann.y2);
            ctx.lineTo(ann.x2 - headLength * Math.cos(angle - Math.PI / 6), ann.y2 - headLength * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(ann.x2 - headLength * Math.cos(angle + Math.PI / 6), ann.y2 - headLength * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fill();
        }
    });
}

// Initialize thumbnails with annotations on page load
function initThumbnails() {
    document.querySelectorAll('[data-photo-id]').forEach(photoItem => {
        const photoId = photoItem.dataset.photoId;
    const scriptTag = photoItem.querySelector('.photo-annotations-data');
    if (scriptTag && scriptTag.textContent.trim()) {
            let annotations = null;
            try { annotations = JSON.parse(scriptTag.textContent); } catch (e) { annotations = null; console.error('Failed to parse annotations for photo', photoId, e); }
            if (Array.isArray(annotations) && annotations.length > 0) {
                redrawThumbnail(photoId, annotations);
            }
        }
    });
}

// Initialize thumbnails when page loads
window.addEventListener('DOMContentLoaded', initThumbnails);

// Attach event listeners to existing photo buttons
window.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.existing-photo-item .edit-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const photoId = this.getAttribute('data-photo-id');
            const imageUrl = this.getAttribute('data-image-url');
            const photoItem = this.closest('.existing-photo-item');
            const scriptTag = photoItem.querySelector('.photo-annotations-data');
            const annotations = scriptTag ? scriptTag.textContent : '[]';
            openPhotoEditor(imageUrl, photoId, annotations);
        });
    });
    
    document.querySelectorAll('.existing-photo-item .delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const photoId = this.getAttribute('data-photo-id');
            deletePhoto(photoId);
        });
    });
});

function deletePhoto(photoId) {
    if (!confirm('¿Eliminar esta foto permanentemente?')) return;
    
    fetch(`/api/v1/changeorder-photo/${photoId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelector(`[data-photo-id="${photoId}"]`).remove();
        }
    })
    .catch(err => {
        console.error('Error deleting photo:', err);
        alert('Error al eliminar la foto');
    });
}

// Verify functions are available
console.log('Photo editor functions available:', {
    openPhotoEditor: typeof openPhotoEditor,
    deletePhoto: typeof deletePhoto,
    openPhotoEditorNew: typeof openPhotoEditorNew
});

// Ensure functions are globally accessible for inline onclick handlers
window.openPhotoEditor = openPhotoEditor;
window.openPhotoEditorNew = openPhotoEditorNew;
window.deletePhoto = deletePhoto;
window.saveAnnotations = saveAnnotations;
window.closePhotoEditor = closePhotoEditor;
window.setDrawingMode = setDrawingMode;
window.setDrawingColor = setDrawingColor;
window.undoDrawing = undoDrawing;
window.clearDrawing = clearDrawing;
window.removePhoto = removePhoto;
window.updatePhotoDescription = updatePhotoDescription;
console.log('Photo editor functions bound to window');
</script>
{% endblock %}
