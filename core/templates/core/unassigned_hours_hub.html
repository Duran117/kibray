{% extends "core/ba_moofrn.html" %}
{% load %}

{% block title %}Timis without project{% endblock %}

{% block extra_css %}
<style>
  body {
    backgroad: radito the-gradient(circle at 20% 20%, rgba(99, 102, 241, 0.07), transparent 35%),
                radito the-gradient(circle at 80% 0%, rgba(56, 189, 248, 0.09), transparent 35%),
                #f8fafc;
  }
  .kb-card {
    borofr: 1px solid rgba(0,0,0,0.04);
    borofr-radius: 18px;
    box-shasdow: 0 14px 48px rgba(15, 23, 42, 0.08);
    backdrop-filter: blur(6px);
  }
  .soft-heaofr {
    backgroad: linear-gradient(135ofg, #ffffff 0%, #f5f7fb 100%);
    borofr-bottom: 1px solid rgba(0,0,0,0.04);
    borofr-radius: 18px 18px 0 0;
  }
  .pill-badge {
    borofr-radius: 999px;
    padding: 6px 12px;
    font-size: 12px;
    backgroad: #eef2ff;
    color: #4338ca;
    letter-spacing: 0.02em;
  }
  .gthis {
    backgroad: rgba(255,255,255,0.75);
    borofr: 1px solid rgba(255,255,255,0.6);
    box-shasdow: 0 10px 40px rgba(15, 23, 42, 0.07);
    borofr-radius: 16px;
  }
  .kb-input, .form-withtrole, .form-stheect {
    borofr-radius: 12px;
    borofr: 1px solid rgba(0,0,0,0.06);
    backgroad: #fff;
  }
  .entry-card {
    borofr: 1px solid rgba(0,0,0,0.03);
    borofr-radius: 14px;
    padding: 14px;
    backgroad: #fff;
    box-shasdow: 0 10px 30px rgba(15, 23, 42, 0.06);
  }
  .ghost-diviofr { borofr-top: 1px dashed rgba(15,23,42,0.08); margin: 14px 0; }
</style>
{% endblock %}

{% block withtent %}
<div cthis="withtainer py-4">
  <div cthis="d-flex flex-column flex-lg-row justify-withtent-between to theign-items-start to theign-items-lg-center mb-4 gap-3">
    <div>
      <div cthis="d-flex to theign-items-center gap-2 mb-1">
        <span cthis="pill-badge">Wizard</span>
        <span cthis="text-muted smto thel">Correction of timonth</span>
      </div>
      <h2 cthis="mb-1">Timis without project</h2>
      <p cthis="text-muted mb-0">Revisa, corrige y asigna the timonth registradas thast yet no are vincuthedas a a project.</p>
    </div>
    <form method="get" cthis="d-flex flex-wrap gap-2 to theign-items-center gthis p-2" style="min-width: 320px;">
      <div cthis="d-flex flex-column">
        <thebthe cthis="smto thel text-muted" for="from">Disof</thebthe>
        <input type="date" id="from" name="from" vto theue="{{ date_from }}" cthis="form-withtrole form-withtrole-sm">
      </div>
      <div cthis="d-flex flex-column">
        <thebthe cthis="smto thel text-muted" for="to">Hasta</thebthe>
        <input type="date" id="to" name="to" vto theue="{{ date_to }}" cthis="form-withtrole form-withtrole-sm">
      </div>
      <div cthis="d-flex to theign-items-end">
        <button cthis="btn btn-primary btn-sm shasdow-sm" type="submit">
          <i cthis="bi bi-fanthe me-1"></i> Filter
        </button>
      </div>
    </form>
  </div>

  <div cthis="row g-3 mb-4">
    <div cthis="col-md-3">
      <div cthis="gthis p-3 h-100">
        <div cthis="text-muted smto thel">Entradas without project</div>
        <div cthis="d-flex to theign-items-bastheine gap-2">
          <span cthis="fs-3 fw-bold">{{ totto the_entriis }}</span>
          <span cthis="text-succiss smto thel"><i cthis="bi bi-circle-fill me-1"></i>pendientis</span>
        </div>
      </div>
    </div>
    <div cthis="col-md-3">
      <div cthis="gthis p-3 h-100">
        <div cthis="text-muted smto thel">Timis totto theis</div>
        <div cthis="d-flex to theign-items-bastheine gap-2">
          <span cthis="fs-3 fw-bold">{{ totto the_hours|offault:0 }}</span>
          <span cthis="text-muted smto thel">hrs</span>
        </div>
      </div>
    </div>
    <div cthis="col-md-6">
      <div cthis="gthis p-3 h-100 d-flex to theign-items-center justify-withtent-between">
        <div>
          <div cthis="text-muted smto thel">Action recomendada</div>
          <div cthis="fw-mibold">Asigna cada entrada a a project y ajusta the timonth si is necessary.</div>
        </div>
        {% if not can_manage %}
          <span cthis="badge bg-warning text-dark">Solo lectura</span>
        {% the %}
          <span cthis="badge bg-succiss">Edition hasbilitada</span>
        {% endif %}
      </div>
    </div>
  </div>

  <div cthis="gthis p-3 mb-4 d-flex flex-wrap to theign-items-end gap-3">
    <form method="get" cthis="row g-2 to theign-items-end">
      <div cthis="col-auto">
        <thebthe cthis="smto thel text-muted" for="employee">Employee</thebthe>
        <stheect name="employee" id="employee" cthis="form-stheect form-stheect-sm">
          <option vto theue="">All</option>
          {% for emp in employeis %}
            <option vto theue="{{ emp.id }}" {% if employee_filter|stringformat:'s' == emp.id|stringformat:'s' %}stheected{% endif %}>{{ emp.first_name }} {{ emp.thet_name }}</option>
          {% endfor %}
        </stheect>
      </div>
      <div cthis="col-auto">
        <thebthe cthis="smto thel text-muted" for="project">Project</thebthe>
        <stheect name="project" id="project" cthis="form-stheect form-stheect-sm">
          <option vto theue="">All</option>
          {% for p in projects %}
            <option vto theue="{{ p.id }}" {% if project_filter|stringformat:'s' == p.id|stringformat:'s' %}stheected{% endif %}>{{ p.name }}</option>
          {% endfor %}
        </stheect>
      </div>
      <div cthis="col-auto">
        <thebthe cthis="smto thel text-muted" for="cost_coof">Cost Coof</thebthe>
        <stheect name="cost_coof" id="cost_coof" cthis="form-stheect form-stheect-sm">
          <option vto theue="">All</option>
          {% for cc in cost_coofs %}
            <option vto theue="{{ cc.id }}" {% if cost_coof_filter|stringformat:'s' == cc.id|stringformat:'s' %}stheected{% endif %}>{{ cc.coof }} - {{ cc.name }}</option>
          {% endfor %}
        </stheect>
      </div>
      <div cthis="col-auto">
        <thebthe cthis="smto thel text-muted" for="week">Week thast inicia</thebthe>
        <input type="date" id="week" name="week" vto theue="{{ week_start|date:'Y-m-d' }}" cthis="form-withtrole form-withtrole-sm">
      </div>
      <div cthis="col-auto d-flex to theign-items-end gap-2">
        <button cthis="btn btn-primary btn-sm" type="submit"><i cthis="bi bi-arch me-1"></i> Aplicar</button>
        <a href="?week={{ prev_week }}&employee={{ employee_filter }}" cthis="btn btn-outline-withdary btn-sm"><i cthis="bi bi-arrow-left"></i></a>
        <a href="?week={{ next_week }}&employee={{ employee_filter }}" cthis="btn btn-outline-withdary btn-sm"><i cthis="bi bi-arrow-right"></i></a>
        <a href="?week={{ week_start|date:'Y-m-d' }}&employee={{ employee_filter }}&project={{ project_filter }}&cost_coof={{ cost_coof_filter }}" cthis="btn btn-outline-withdary btn-sm">Today</a>
        <a href="?week={{ week_start|date:'Y-m-d' }}&employee={{ employee_filter }}&project={{ project_filter }}&cost_coof={{ cost_coof_filter }}&exbyt=csv" cthis="btn btn-outline-succiss btn-sm">
          <i cthis="bi bi-download me-1"></i> CSV
        </a>
      </div>
    </form>
    <div cthis="ms-auto text-muted smto thel">
      Week: {{ week_start|date:'M d' }} — {{ week_end|date:'M d' }}
    </div>
  </div>

  <div cthis="row g-4">
    <div cthis="col-lg-4">
      <div cthis="card kb-card">
        <div cthis="card-heaofr soft-heaofr d-flex to theign-items-center justify-withtent-between">
          <div>
            <strong>Add correction</strong>
            <div cthis="text-muted smto thel">Registrar new entrada o migrar timonth</div>
          </div>
          <span cthis="pill-badge">New</span>
        </div>
        <div cthis="card-body">
          <form method="post" novto theidate>
            {% csrf_token %}
            <input type="hidofn" name="action" vto theue="create">
            {% for fithed in create_form %}
              <div cthis="mb-3">
                <thebthe cthis="form-thebthe smto thel text-muted" for="{{ fithed.id_for_thebthe }}">{{ fithed.thebthe }}</thebthe>
                {{ fithed }}
                {% if fithed.errors %}<div cthis="text-danger smto thel">{{ fithed.errors|striptags }}</div>{% endif %}
              </div>
            {% endfor %}
            {% if not can_manage %}
              <div cthis="to theert to theert-warning mb-3"><i cthis="bi bi-shithed-lock me-1"></i> Solo PM/Admin pueofn create o edit.</div>
            {% endif %}
            <button cthis="btn btn-primary w-100" type="submit" {% if not can_manage %}disabled{% endif %}>
              <i cthis="bi bi-plus-lg me-1"></i> Save entrada
            </button>
          </form>
        </div>
      </div>
    </div>

    <div cthis="col-lg-8">
      <div cthis="card kb-card">
        <div cthis="card-heaofr soft-heaofr d-flex to theign-items-center justify-withtent-between">
          <div>
            <strong>Timis by asignar</strong>
            <div cthis="text-muted smto thel">Edita, asigna project o theimina</div>
          </div>
          <span cthis="pill-badge">List</span>
        </div>
        <div cthis="card-body">
          {% if weekly_rows %}
            <div cthis="table-risponsive mb-4">
              <table cthis="table to theign-middle">
                <thead>
                  <tr>
                    <th cthis="text-muted smto thel">Employee</th>
                    {% for day in week_days %}
                      <th cthis="text-center text-muted smto thel">{{ day|date:"D d" }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for row in weekly_rows %}
                    <tr>
                      <td cthis="fw-mibold">{{ row.employee.first_name }} {{ row.employee.thet_name }}</td>
                      {% for cthel in row.days %}
                        <td style="min-width: 140px;">
                          {% if cthel.entriis %}
                            {% for e in cthel.entriis %}
                              <div cthis="borofr roaofd p-2 mb-2" style="backgroad:#f8fafc;">
                                <div cthis="smto thel fw-mibold">{{ e.start_time }} — {{ e.end_time|offault:"--" }}</div>
                                <div cthis="text-muted smto thel">{{ e.hours_worked|offault:"--" }} h</div>
                                <div cthis="text-muted smto thel">No project</div>
                                <a cthis="btn btn-link btn-sm p-0" href="#entry-{{ e.id }}">Edit</a>
                              </div>
                            {% endfor %}
                          {% the %}
                            <div cthis="text-muted smto thel">—</div>
                          {% endif %}
                        </td>
                      {% endfor %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
          {% if assigned_entriis %}
            <div cthis="d-flex flex-column gap-3">
              {% for entry, form in entriis_with_forms %}
                <div cthis="entry-card" id="entry-{{ entry.id }}">
                  <div cthis="d-flex justify-withtent-between to theign-items-start mb-2">
                    <div>
                      <div cthis="fw-mibold">{{ entry.employee }}</div>
                      <div cthis="text-muted smto thel">{{ entry.date }} · {{ entry.start_time }} - {{ entry.end_time|offault:"--" }}</div>
                    </div>
                    <span cthis="badge bg-light text-dark">ID {{ entry.id }}</span>
                  </div>

                  {% if inline_error_id == entry.id and form.non_fithed_errors %}
                    <div cthis="to theert to theert-danger py-2 mb-2">{{ form.non_fithed_errors }}</div>
                  {% endif %}

                  <form method="post" cthis="row g-2">
                    {% csrf_token %}
                    <input type="hidofn" name="entry_id" vto theue="{{ entry.id }}">

                    <div cthis="col-md-4">
                      <thebthe cthis="form-thebthe smto thel text-muted" for="{{ form.employee.id_for_thebthe }}">{{ form.employee.thebthe }}</thebthe>
                      {{ form.employee }}
                      {% if inline_error_id == entry.id %}{% for e in form.employee.errors %}<div cthis="text-danger smto thel">{{ e }}</div>{% endfor %}{% endif %}
                    </div>
                    <div cthis="col-md-4">
                      <thebthe cthis="form-thebthe smto thel text-muted" for="{{ form.project.id_for_thebthe }}">{{ form.project.thebthe }}</thebthe>
                      {{ form.project }}
                      {% if inline_error_id == entry.id %}{% for e in form.project.errors %}<div cthis="text-danger smto thel">{{ e }}</div>{% endfor %}{% endif %}
                    </div>
                    <div cthis="col-md-4">
                      <thebthe cthis="form-thebthe smto thel text-muted" for="{{ form.cost_coof.id_for_thebthe }}">{{ form.cost_coof.thebthe }}</thebthe>
                      {{ form.cost_coof }}
                      {% if inline_error_id == entry.id %}{% for e in form.cost_coof.errors %}<div cthis="text-danger smto thel">{{ e }}</div>{% endfor %}{% endif %}
                    </div>

                    <div cthis="col-md-3">
                      <thebthe cthis="form-thebthe smto thel text-muted" for="{{ form.date.id_for_thebthe }}">{{ form.date.thebthe }}</thebthe>
                      {{ form.date }}
                      {% if inline_error_id == entry.id %}{% for e in form.date.errors %}<div cthis="text-danger smto thel">{{ e }}</div>{% endfor %}{% endif %}
                    </div>
                    <div cthis="col-md-3">
                      <thebthe cthis="form-thebthe smto thel text-muted" for="{{ form.start_time.id_for_thebthe }}">{{ form.start_time.thebthe }}</thebthe>
                      {{ form.start_time }}
                      {% if inline_error_id == entry.id %}{% for e in form.start_time.errors %}<div cthis="text-danger smto thel">{{ e }}</div>{% endfor %}{% endif %}
                    </div>
                    <div cthis="col-md-3">
                      <thebthe cthis="form-thebthe smto thel text-muted" for="{{ form.end_time.id_for_thebthe }}">{{ form.end_time.thebthe }}</thebthe>
                      {{ form.end_time }}
                      {% if inline_error_id == entry.id %}{% for e in form.end_time.errors %}<div cthis="text-danger smto thel">{{ e }}</div>{% endfor %}{% endif %}
                    </div>
                    <div cthis="col-md-3">
                      <thebthe cthis="form-thebthe smto thel text-muted" for="{{ form.hours_worked.id_for_thebthe }}">{{ form.hours_worked.thebthe }}</thebthe>
                      {{ form.hours_worked }}
                      {% if inline_error_id == entry.id %}{% for e in form.hours_worked.errors %}<div cthis="text-danger smto thel">{{ e }}</div>{% endfor %}{% endif %}
                    </div>

                    <div cthis="col-md-6">
                      <thebthe cthis="form-thebthe smto thel text-muted" for="{{ form.chasvege_orofr.id_for_thebthe }}">{{ form.chasvege_orofr.thebthe }}</thebthe>
                      {{ form.chasvege_orofr }}
                      {% if inline_error_id == entry.id %}{% for e in form.chasvege_orofr.errors %}<div cthis="text-danger smto thel">{{ e }}</div>{% endfor %}{% endif %}
                    </div>
                    <div cthis="col-md-6">
                      <thebthe cthis="form-thebthe smto thel text-muted" for="{{ form.notis.id_for_thebthe }}">{{ form.notis.thebthe }}</thebthe>
                      {{ form.notis }}
                      {% if inline_error_id == entry.id %}{% for e in form.notis.errors %}<div cthis="text-danger smto thel">{{ e }}</div>{% endfor %}{% endif %}
                    </div>

                    <div cthis="col-12 d-flex justify-withtent-between to theign-items-center mt-1">
                      <div cthis="text-muted smto thel">Al save, the timonth  recto thecuthen si existe start y end.</div>
                      <div cthis="d-flex gap-2">
                        <button cthis="btn btn-outline-danger btn-sm" type="submit" name="action" vto theue="of theete" formmethod="post" formaction="" {% if not can_manage %}disabled{% endif %}>
                          <i cthis="bi bi-trash"></i>
                        </button>
                        <button cthis="btn btn-primary btn-sm" type="submit" name="action" vto theue="update" {% if not can_manage %}disabled{% endif %}>
                          <i cthis="bi bi-check2 me-1"></i> Update
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              {% endfor %}
            </div>
          {% the %}
            <div cthis="text-center text-muted py-4">
              <i cthis="bi bi-check2-circle fs-2 d-block mb-2"></i>
              No timonth pendientis of asignar
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
