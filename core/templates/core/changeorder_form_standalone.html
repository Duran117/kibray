<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if is_edit %}Editar{% else %}Crear{% endif %} Change Order - Kibray</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        /* Modern Gallery Design - Updated 2025-11-14 22:50 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            padding: 2.5rem;
        }

        .header {
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 1.5rem;
        }

        .header h1 {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #64748b;
            font-size: 0.95rem;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #334155;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section-title i {
            color: #667eea;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-group label.required::after {
            content: " *";
            color: #dc2626;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* Color Picker Section */
        .color-picker-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .color-input-group {
            flex: 1;
        }

        .color-preview {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-preview:hover {
            transform: scale(1.05);
        }

        input[type="color"] {
            width: 100%;
            height: 50px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Photo Upload Section */
        .photo-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s;
            cursor: pointer;
        }

        .photo-upload-area:hover {
            border-color: #667eea;
            background: #f1f5ff;
        }

        .photo-upload-area i {
            font-size: 3rem;
            color: #667eea;
            display: block;
            margin-bottom: 1rem;
        }

        .photo-upload-area p {
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .photo-upload-area .upload-hint {
            font-size: 0.85rem;
            color: #94a3b8;
        }

        #photoInput {
            display: none;
        }

        /* ===== PHOTO GALLERY - MODERN DESIGN ===== */
        .photo-preview-grid {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.25rem;
            margin-top: 1.5rem;
        }
        
        .photo-preview-grid.has-photos {
            display: grid;
        }

        .photo-preview-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .photo-preview-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .photo-preview-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }

        .photo-preview-item .photo-info {
            padding: 0.875rem;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }

        .photo-preview-item input.photo-description {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }
        
        .photo-preview-item input.photo-description:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .photo-preview-item .remove-photo {
            position: absolute;
            top: 0.625rem;
            right: 0.625rem;
            background: rgba(220, 38, 38, 0.95);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 600;
            line-height: 1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
            z-index: 10;
        }

        .photo-preview-item .remove-photo:hover {
            background: #991b1b;
            transform: scale(1.1);
        }

        .photo-preview-item .edit-photo-btn {
            position: absolute;
            top: 0.625rem;
            left: 0.625rem;
            background: rgba(102, 126, 234, 0.95);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.2s;
            z-index: 10;
        }

        .photo-preview-item .edit-photo-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }
        
        .photo-preview-item .edit-photo-btn i {
            font-size: 0.9rem;
        }

        /* Existing Photos (Edit Mode) - Card Style */
        .existing-photos {
            margin-bottom: 2rem;
        }
        
        .existing-photos-title {
            font-weight: 600;
            font-size: 1.05rem;
            color: #1e293b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .existing-photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1.25rem;
        }

        .existing-photo-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .existing-photo-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .existing-photo-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            display: block;
        }

        .existing-photo-item .photo-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.75rem;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 100%);
            display: flex;
            gap: 0.5rem;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .existing-photo-item:hover .photo-actions {
            opacity: 1;
        }

        .existing-photo-item button {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
        }

        .existing-photo-item .edit-btn {
            background: rgba(102, 126, 234, 0.9);
        }
        
        .existing-photo-item .edit-btn:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.05);
        }

        .existing-photo-item .delete-btn {
            background: rgba(220, 38, 38, 0.9);
        }
        
        .existing-photo-item .delete-btn:hover {
            background: rgba(220, 38, 38, 1);
            transform: scale(1.05);
        }

        /* Canvas Editor Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: #334155;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            color: #64748b;
            cursor: pointer;
            line-height: 1;
        }

        .canvas-container {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        #drawingCanvas {
            display: block;
            max-width: 100%;
        }

        .drawing-tools {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .drawing-tools button {
            padding: 0.6rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .drawing-tools button:hover {
            background: #f1f5f9;
        }

        .drawing-tools button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .drawing-tools input[type="color"] {
            width: 50px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
        }

        .drawing-tools input[type="range"] {
            width: 150px;
        }

        /* Action Buttons */
        .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e2e8f0;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .errorlist {
            list-style: none;
            color: #dc2626;
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }

            .color-picker-wrapper {
                flex-direction: column;
            }

            .photo-preview-grid {
                grid-template-columns: 1fr;
            }

            .drawing-tools {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="bi bi-file-earmark-text"></i>
                {% if is_edit %}Editar Change Order{% else %}Crear Change Order{% endif %}
            </h1>
            <p>Complete la información del cambio en el proyecto</p>
        </div>

        <form method="post" enctype="multipart/form-data" id="changeOrderForm">
            {% csrf_token %}

            <!-- Basic Information -->
            <div class="form-section">
                <div class="form-section-title">
                    <i class="bi bi-info-circle"></i>
                    Información Básica
                </div>

                <div class="form-group">
                    <label for="{{ form.project.id_for_label }}" class="required">Proyecto</label>
                    {{ form.project }}
                    {{ form.project.errors }}
                </div>

                <div class="form-group">
                    <label for="{{ form.description.id_for_label }}" class="required">Descripción</label>
                    {{ form.description }}
                    {{ form.description.errors }}
                </div>

                <div class="form-group">
                    <label for="{{ form.amount.id_for_label }}" class="required">Monto ($)</label>
                    {{ form.amount }}
                    {{ form.amount.errors }}
                </div>

                <div class="form-group">
                    <label for="{{ form.status.id_for_label }}" class="required">Estado</label>
                    {{ form.status }}
                    {{ form.status.errors }}
                </div>

                <div class="form-group">
                    <label for="{{ form.notes.id_for_label }}">Notas</label>
                    {{ form.notes }}
                    {{ form.notes.errors }}
                </div>
            </div>

            <!-- Color Selection -->
            <div class="form-section">
                <div class="form-section-title">
                    <i class="bi bi-palette"></i>
                    Selección de Color
                </div>

                <div class="color-picker-wrapper">
                    <div class="color-input-group">
                        {# Server-side fallback: show dropdown immediately if approved_colors exist #}
                        <div class="form-group" id="approvedColorsGroup" style="{% if approved_colors %}display:block;{% else %}display:none;{% endif %}">
                            <label for="approvedColorSelect">Colores Aprobados del Proyecto</label>
                            <select id="approvedColorSelect" class="form-control" onchange="selectApprovedColor(this)">
                                <option value="">-- Seleccionar color aprobado --</option>
                                {% for color_sample in approved_colors %}
                                <option value="{{ color_sample.code }}" 
                                        data-brand="{{ color_sample.brand }}"
                                        data-name="{{ color_sample.name }}">
                                    {{ color_sample.code }}{% if color_sample.name %} - {{ color_sample.name }}{% endif %}
                                    {% if color_sample.brand %} ({{ color_sample.brand }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <p style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem;">
                                Seleccione un color aprobado para este proyecto
                            </p>
                        </div>
                        
                        {# Server-side fallback: show message if no approved colors #}
                        <div class="form-group" id="noColorsMessage" style="{% if not approved_colors %}display:block;{% else %}display:none;{% endif %}">
                            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem;">
                                <p style="margin: 0; color: #92400e; font-size: 0.9rem;">
                                    <i class="bi bi-info-circle"></i> 
                                    <strong>Este proyecto no tiene colores aprobados.</strong><br>
                                    Puede usar el selector de color manual a continuación.
                                </p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="{{ form.color.id_for_label }}">Color (Hex) - Manual</label>
                            {{ form.color }}
                            <p style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem;">
                                O escriba un código hex manualmente (ej: #FF5733)
                            </p>
                            {{ form.color.errors }}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.reference_code.id_for_label }}">Código de Referencia o Material</label>
                            {{ form.reference_code }}
                            <p style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem;">
                                Para hacer match con madera, metal u otro material (ej: "Madera X", "Metal Z")
                            </p>
                            {{ form.reference_code.errors }}
                        </div>
                    </div>

                    <div class="color-preview" id="colorPreview" style="background: #ffffff;" title="Vista previa del color"></div>
                </div>
            </div>

            <!-- Photos Section -->
            <div class="form-section">
                <div class="form-section-title">
                    <i class="bi bi-images"></i>
                    Fotos del Proyecto
                    <span style="color: #10b981; font-size: 0.75rem; margin-left: 1rem;">✓ Diseño Moderno v2.0</span>
                </div>

                {% if is_edit and changeorder.photos.all %}
                <div class="existing-photos">
                    <div class="existing-photos-title">
                        <i class="bi bi-images"></i>
                        Fotos Existentes ({{ changeorder.photos.count }})
                    </div>
                    <div class="existing-photos-grid">
                    {% for photo in changeorder.photos.all %}
                    <div class="existing-photo-item" data-photo-id="{{ photo.id }}">
                        <img src="{{ photo.image.url }}" alt="{{ photo.description }}">
                        <div class="photo-actions">
                            <button type="button" class="edit-btn" onclick="openPhotoEditorInNewTab('{{ photo.image.url }}', {{ photo.id }}, '{{ photo.annotations|escapejs }}')">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <button type="button" class="delete-btn" onclick="deletePhoto({{ photo.id }})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        {% if photo.description %}
                        <div style="padding: 0.75rem; font-size: 0.875rem; color: #64748b; background: #f8fafc; border-top: 1px solid #e2e8f0;">
                            {{ photo.description }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                    <i class="bi bi-cloud-upload"></i>
                    <p><strong>Haga clic para subir fotos</strong></p>
                    <p class="upload-hint">Puede seleccionar múltiples archivos (JPG, PNG, HEIC)</p>
                </div>
                {# Photo input: ensure proper attributes; name as photos to allow getlist; add capture for mobile #}
                <input type="file" id="photoInput" name="photos" accept="image/*" multiple capture="environment">
                <div id="photoErrorMessage" style="display:none; color:#b91c1c; font-size:0.85rem; margin-top:0.5rem;"></div>

                <div id="photoPreviewGrid" class="photo-preview-grid"></div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <a href="{% url 'changeorder_board' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> {% if is_edit %}Guardar Cambios{% else %}Crear Change Order{% endif %}
                </button>
            </div>
        </form>
    </div>

    <!-- Photo Editor Modal -->
    <div id="photoEditorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="bi bi-pencil"></i> Editar Foto</h2>
                <button type="button" class="close-modal" onclick="closePhotoEditor()">&times;</button>
            </div>

            <div class="drawing-tools">
                <button type="button" id="drawBtn" class="active" onclick="setDrawingMode('draw')">
                    <i class="bi bi-pencil"></i> Dibujar
                </button>
                <button type="button" id="lineBtn" onclick="setDrawingMode('line')">
                    <i class="bi bi-slash-lg"></i> Línea
                </button>
                <button type="button" id="arrowBtn" onclick="setDrawingMode('arrow')">
                    <i class="bi bi-arrow-right"></i> Flecha
                </button>
                <button type="button" id="circleBtn" onclick="setDrawingMode('circle')">
                    <i class="bi bi-circle"></i> Círculo
                </button>
                <button type="button" id="rectBtn" onclick="setDrawingMode('rect')">
                    <i class="bi bi-square"></i> Rectángulo
                </button>
                <button type="button" id="textBtn" onclick="setDrawingMode('text')">
                    <i class="bi bi-fonts"></i> Texto
                </button>
                <input type="color" id="drawingColor" value="#FF0000" title="Color de dibujo">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    Grosor: <input type="range" id="lineWidth" min="1" max="10" value="3">
                </label>
                <button type="button" onclick="clearCanvas()" style="background: #dc2626; color: white;">
                    <i class="bi bi-eraser"></i> Limpiar
                </button>
                <button type="button" onclick="undoDrawing()" style="background: #f59e0b; color: white;">
                    <i class="bi bi-arrow-counterclockwise"></i> Deshacer
                </button>
            </div>

            <div class="canvas-container">
                <canvas id="drawingCanvas"></canvas>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closePhotoEditor()">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveAnnotations()">
                    <i class="bi bi-check-lg"></i> Guardar Anotaciones
                </button>
            </div>
        </div>
    </div>

    <script>
        // Color preview and approved colors
        const colorInput = document.getElementById('{{ form.color.id_for_label }}');
        const colorPreview = document.getElementById('colorPreview');
        const referenceCodeInput = document.getElementById('{{ form.reference_code.id_for_label }}');
        const projectSelect = document.getElementById('{{ form.project.id_for_label }}');
       
           // DEBUG: Log to verify elements are found
           console.log('=== CHANGE ORDER FORM DEBUG ===');
           console.log('colorInput:', colorInput);
           console.log('colorPreview:', colorPreview);
           console.log('projectSelect:', projectSelect);
           console.log('projectSelect.value:', projectSelect ? projectSelect.value : 'N/A');
        
        // Load approved colors when project changes
        if (projectSelect) {
               console.log('Adding change event listener to projectSelect');
            projectSelect.addEventListener('change', function() {
                const projectId = this.value;
                   console.log('Project changed to:', projectId);
                if (projectId) {
                    loadApprovedColors(projectId);
                } else {
                    // Hide both if no project selected
                    const approvedColorsGroup = document.getElementById('approvedColorsGroup');
                    const noColorsMessage = document.getElementById('noColorsMessage');
                    if (approvedColorsGroup) approvedColorsGroup.style.display = 'none';
                    if (noColorsMessage) noColorsMessage.style.display = 'none';
                }
            });
            
            // Load colors on page load if project is already selected (edit mode)
            if (projectSelect.value) {
                loadApprovedColors(projectSelect.value);
            }
        }
        
        function loadApprovedColors(projectId) {
               console.log('loadApprovedColors called with projectId:', projectId);
            fetch(`/api/projects/${projectId}/approved-colors/`)
                .then(response => response.json())
                .then(data => {
                       console.log('Approved colors received:', data);
                    const approvedColorsGroup = document.getElementById('approvedColorsGroup');
                    const approvedColorSelect = document.getElementById('approvedColorSelect');
                    const noColorsMessage = document.getElementById('noColorsMessage');
                    
                    if (data.colors && data.colors.length > 0) {
                        // Clear and populate select
                        approvedColorSelect.innerHTML = '<option value="">-- Seleccionar color aprobado --</option>';
                        data.colors.forEach(color => {
                            const option = document.createElement('option');
                            option.value = color.code || '';
                            option.setAttribute('data-brand', color.brand || '');
                            option.setAttribute('data-name', color.name || '');
                            option.textContent = color.code || '';
                            if (color.name) option.textContent += ' - ' + color.name;
                            if (color.brand) option.textContent += ' (' + color.brand + ')';
                            approvedColorSelect.appendChild(option);
                        });
                        // Show the group, hide the message
                        if (approvedColorsGroup) approvedColorsGroup.style.display = 'block';
                        if (noColorsMessage) noColorsMessage.style.display = 'none';
                    } else {
                        // Hide dropdown, show message
                        if (approvedColorsGroup) approvedColorsGroup.style.display = 'none';
                        if (noColorsMessage) noColorsMessage.style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error('Error loading approved colors:', err);
                    // On error, show message
                    const approvedColorsGroup = document.getElementById('approvedColorsGroup');
                    const noColorsMessage = document.getElementById('noColorsMessage');
                    if (approvedColorsGroup) approvedColorsGroup.style.display = 'none';
                    if (noColorsMessage) noColorsMessage.style.display = 'block';
                });
        }
        
        // Handle approved color selection
        function selectApprovedColor(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            if (selectedOption.value) {
                const code = selectedOption.value;
                const brand = selectedOption.getAttribute('data-brand');
                const name = selectedOption.getAttribute('data-name');
                
                // Set reference code with brand and name
                let referenceText = code;
                if (brand) referenceText += ' - ' + brand;
                if (name) referenceText += ' (' + name + ')';
                
                if (referenceCodeInput) {
                    referenceCodeInput.value = referenceText;
                }
            }
        }
        
        if (colorInput) {
            colorInput.addEventListener('input', function() {
                colorPreview.style.background = this.value || '#ffffff';
            });

            // Set initial color
            if (colorInput.value) {
                colorPreview.style.background = colorInput.value;
            }
        }

        // Photo preview with immediate editor
        const photoInput = document.getElementById('photoInput');
        const photoPreviewGrid = document.getElementById('photoPreviewGrid');
       
           // DEBUG: Log photo elements
           console.log('photoInput:', photoInput);
           console.log('photoPreviewGrid:', photoPreviewGrid);
       
        let selectedFiles = [];
        let pendingPhotoIndex = null;
        let editedIndices = new Set(); // Track which photos have been edited

        photoInput.addEventListener('change', function(e) {
           console.log('Photo input changed, files:', e.target.files);
           const errorBox = document.getElementById('photoErrorMessage');
           if (errorBox) { errorBox.style.display='none'; errorBox.textContent=''; }
           if (!e.target.files || e.target.files.length === 0) {
               console.warn('No files selected');
               return;
           }
           // Basic validation: size and type
           const validImages = [];
           for (const f of e.target.files) {
               if (!f.type.startsWith('image/')) {
                   console.warn('Skipping non-image file:', f.name);
                   continue;
               }
               if (f.size > 10 * 1024 * 1024) { // 10MB limit
                   console.warn('Skipping large file (>10MB):', f.name);
                   if (errorBox) {
                       errorBox.style.display='block';
                       errorBox.textContent='Algún archivo supera el límite de 10MB y fue omitido.';
                   }
                   continue;
               }
               validImages.push(f);
           }
           if (validImages.length === 0) {
               console.warn('No valid images after filtering');
               return;
           }
            const files = Array.from(e.target.files);
            
            if (files.length === 0) return;
            
            // Add files to selectedFiles array
            validImages.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const newIndex = selectedFiles.length;
                    
                    selectedFiles.push({
                        file: file,
                        dataUrl: e.target.result,
                        description: '',
                        annotations: []
                    });
                    
                    // Render preview immediately
                    renderPhotoPreview();
                    
                    // Open editor for first photo only (optional)
                    if (newIndex === 0 && files.length === 1) {
                        setTimeout(() => {
                            if (confirm('¿Desea editar/anotar esta foto antes de cargarla?')) {
                                openPhotoEditorNew(e.target.result, newIndex, true);
                            }
                        }, 300);
                    }
                };
                reader.readAsDataURL(file);
            });
            
            // Reset input to allow selecting same file again
            photoInput.value = '';
        });

        function renderPhotoPreview() {
            console.log('renderPhotoPreview called, selectedFiles:', selectedFiles.length);
            if (!photoPreviewGrid) {
                console.error('photoPreviewGrid element not found!');
                return;
            }
            
            photoPreviewGrid.innerHTML = '';
            
            // Toggle visibility based on content
            if (selectedFiles.length > 0) {
                photoPreviewGrid.classList.add('has-photos');
            } else {
                photoPreviewGrid.classList.remove('has-photos');
            }
            
            selectedFiles.forEach((fileObj, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview-item';
                div.innerHTML = `
                    <img src="${fileObj.dataUrl}" alt="Preview ${index + 1}" style="display:block;">
                    <button type="button" class="remove-photo" onclick="removePhoto(${index})" title="Eliminar foto">&times;</button>
                    <button type="button" class="edit-photo-btn" onclick="openPhotoEditorNewTab(${index})" title="Editar y anotar">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                    <div class="photo-info">
                        <input type="text" class="photo-description" name="photo_description_${index}" 
                               placeholder="Descripción de la foto..." value="${fileObj.description || ''}"
                               onchange="updatePhotoDescription(${index}, this.value)">
                    </div>
                `;
                photoPreviewGrid.appendChild(div);
                console.log('Added preview for photo', index);
            });
            
            // Update the actual file input
            updateFileInput();
        }

        function updatePhotoDescription(index, description) {
            console.log('updatePhotoDescription:', index, description);
            if (selectedFiles[index]) {
                selectedFiles[index].description = description;
            }
        }

        function removePhoto(index) {
            console.log('removePhoto called for index:', index);
            if (confirm('¿Eliminar esta foto?')) {
                selectedFiles.splice(index, 1);
                renderPhotoPreview();
            }
        }

        function updateFileInput() {
            // Create a new DataTransfer object to hold our files
            const dt = new DataTransfer();
            selectedFiles.forEach(fileObj => {
                if (fileObj.file) {
                    dt.items.add(fileObj.file);
                }
            });
            // Update the input's files
            photoInput.files = dt.files;
        }

        // Canvas Drawing with corrected cursor precision
        let canvas, ctx, isDrawing = false, drawingMode = 'draw';
        let startX, startY, currentAnnotations = [], currentPhotoId = null, currentPhotoIndex = null;
        let drawingHistory = [];
        let currentImageUrl = null;

        function openPhotoEditor(imageUrl, photoId, annotations) {
            currentPhotoId = photoId;
            currentPhotoIndex = null;
            const modal = document.getElementById('photoEditorModal');
            modal.classList.add('active');
            
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            currentImageUrl = imageUrl;
            
            const img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                if (annotations) {
                    try {
                        currentAnnotations = JSON.parse(annotations);
                        redrawAnnotations();
                    } catch(e) {
                        currentAnnotations = [];
                    }
                } else {
                    currentAnnotations = [];
                }
                drawingHistory = [currentAnnotations.slice()];
            };
            img.src = imageUrl;
            
            setupCanvasEvents();
        }

        function openPhotoEditorNew(imageUrl, index, isNewPhoto) {
            currentPhotoId = null;
            currentPhotoIndex = index;
            const modal = document.getElementById('photoEditorModal');
            modal.classList.add('active');
            
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            currentImageUrl = imageUrl;
            
            const img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const fileObj = selectedFiles[index];
                if (fileObj && fileObj.annotations) {
                    currentAnnotations = fileObj.annotations;
                    redrawAnnotations();
                } else {
                    currentAnnotations = [];
                }
                drawingHistory = [currentAnnotations.slice()];
            };
            img.src = imageUrl;
            
            setupCanvasEvents();
        }

        // New tab/window functions
        function openPhotoEditorNewTab(index) {
            console.log('openPhotoEditorNewTab called with index:', index);
            console.log('selectedFiles:', selectedFiles);
            const fileObj = selectedFiles[index];
            if (!fileObj) {
                alert('Error: Foto no encontrada');
                console.error('fileObj not found for index:', index);
                return;
            }
            
            console.log('Opening photo editor for:', fileObj);
            
            // Store data in sessionStorage for new window
            sessionStorage.setItem('photoEditorData', JSON.stringify({
                imageUrl: fileObj.dataUrl,
                photoIndex: index,
                annotations: fileObj.annotations || [],
                isNewPhoto: true
            }));
            
            console.log('Data stored in sessionStorage');
            
            // Open new window/tab with optimal size
            const width = Math.min(1400, window.screen.width * 0.9);
            const height = Math.min(900, window.screen.height * 0.9);
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2;
            
            const newWindow = window.open(
                '/changeorder/photo-editor/',
                'photoEditor',
                `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,location=no,status=no`
            );
            
            if (!newWindow) {
                alert('Por favor permite pop-ups para este sitio');
                console.error('window.open blocked by popup blocker');
            } else {
                console.log('New window opened successfully');
            }
        }

        function openPhotoEditorInNewTab(imageUrl, photoId, annotations) {
            console.log('openPhotoEditorInNewTab called');
            console.log('imageUrl:', imageUrl);
            console.log('photoId:', photoId);
            console.log('annotations (raw):', annotations);
            
            // Parse annotations safely
            let parsedAnnotations = [];
            if (annotations && annotations.trim() !== '') {
                try {
                    parsedAnnotations = typeof annotations === 'string' ? JSON.parse(annotations) : annotations;
                    console.log('Parsed annotations:', parsedAnnotations);
                } catch (e) {
                    console.error('Error parsing annotations:', e);
                    parsedAnnotations = [];
                }
            }
            
            // Store data in sessionStorage for new window
            sessionStorage.setItem('photoEditorData', JSON.stringify({
                imageUrl: imageUrl,
                photoId: photoId,
                annotations: parsedAnnotations,
                isNewPhoto: false
            }));
            
            console.log('Data stored in sessionStorage');
            
            // Open new window/tab with optimal size
            const width = Math.min(1400, window.screen.width * 0.9);
            const height = Math.min(900, window.screen.height * 0.9);
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2;
            
            const newWindow = window.open(
                '/changeorder/photo-editor/',
                'photoEditor',
                `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,location=no,status=no`
            );
            
            if (!newWindow) {
                alert('Por favor permite pop-ups para este sitio');
                console.error('window.open blocked by popup blocker');
            } else {
                console.log('New window opened successfully');
            }
        }

        // Listen for messages from photo editor window
        window.addEventListener('message', function(event) {
            if (event.data.type === 'photoAnnotationsSaved') {
                const { photoIndex, photoId, annotations } = event.data;
                
                if (photoIndex !== null && photoIndex !== undefined) {
                    // Update new photo annotations
                    if (selectedFiles[photoIndex]) {
                        selectedFiles[photoIndex].annotations = annotations;
                        renderPhotoPreview();
                        console.log('✅ Annotations updated for new photo', photoIndex);
                    }
                } else if (photoId) {
                    // Existing photo already saved via API
                    console.log('✅ Annotations saved for photo ID', photoId);
                    // Could refresh the photo or show a checkmark
                }
            }
        });

        function setupCanvasEvents() {
            canvas.onmousedown = startDrawing;
            canvas.onmousemove = draw;
            canvas.onmouseup = stopDrawing;
            canvas.onmouseout = stopDrawing;
            
            // Touch events for mobile
            canvas.ontouchstart = function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            };
            
            canvas.ontouchmove = function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            };
            
            canvas.ontouchend = function(e) {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                canvas.dispatchEvent(mouseEvent);
            };
        }

        function setDrawingMode(mode) {
            drawingMode = mode;
            document.querySelectorAll('.drawing-tools button').forEach(btn => btn.classList.remove('active'));
            const modeBtn = document.getElementById(mode + 'Btn');
            if (modeBtn) modeBtn.classList.add('active');
        }

        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const coords = getCanvasCoordinates(e);
            startX = coords.x;
            startY = coords.y;
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const coords = getCanvasCoordinates(e);
            const currentX = coords.x;
            const currentY = coords.y;
            
            if (drawingMode === 'draw') {
                ctx.strokeStyle = document.getElementById('drawingColor').value;
                ctx.lineWidth = document.getElementById('lineWidth').value;
                ctx.lineCap = 'round';
                
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                
                startX = currentX;
                startY = currentY;
            }
        }

        function stopDrawing(e) {
            if (!isDrawing) return;
            isDrawing = false;
            
            const coords = getCanvasCoordinates(e);
            const endX = coords.x;
            const endY = coords.y;
            
            const annotation = {
                type: drawingMode,
                color: document.getElementById('drawingColor').value,
                width: parseInt(document.getElementById('lineWidth').value),
                x1: startX,
                y1: startY,
                x2: endX,
                y2: endY
            };
            
            if (drawingMode !== 'draw') {
                currentAnnotations.push(annotation);
                drawingHistory.push(currentAnnotations.slice());
                redrawCanvas();
            }
        }

        function redrawCanvas() {
            // Clear and redraw image
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                redrawAnnotations();
            };
            img.src = currentImageUrl;
        }

        function redrawAnnotations() {
            currentAnnotations.forEach(ann => {
                ctx.strokeStyle = ann.color;
                ctx.lineWidth = ann.width;
                ctx.fillStyle = ann.color;
                
                switch(ann.type) {
                    case 'line':
                        ctx.beginPath();
                        ctx.moveTo(ann.x1, ann.y1);
                        ctx.lineTo(ann.x2, ann.y2);
                        ctx.stroke();
                        break;
                    case 'arrow':
                        drawArrow(ann.x1, ann.y1, ann.x2, ann.y2, ann.color, ann.width);
                        break;
                    case 'circle':
                        const radius = Math.sqrt(Math.pow(ann.x2 - ann.x1, 2) + Math.pow(ann.y2 - ann.y1, 2));
                        ctx.beginPath();
                        ctx.arc(ann.x1, ann.y1, radius, 0, 2 * Math.PI);
                        ctx.stroke();
                        break;
                    case 'rect':
                        ctx.strokeRect(ann.x1, ann.y1, ann.x2 - ann.x1, ann.y2 - ann.y1);
                        break;
                }
            });
        }

        function drawArrow(x1, y1, x2, y2, color, width) {
            const headlen = 15;
            const angle = Math.atan2(y2 - y1, x2 - x1);
            
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();
        }

        function clearCanvas() {
            currentAnnotations = [];
            drawingHistory = [[]];
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = canvas.toDataURL();
        }

        function undoDrawing() {
            if (drawingHistory.length > 1) {
                drawingHistory.pop();
                currentAnnotations = drawingHistory[drawingHistory.length - 1].slice();
                redrawCanvas();
            }
        }

        function saveAnnotations() {
            const annotationsJSON = JSON.stringify(currentAnnotations);
            
            if (currentPhotoId) {
                // Save to existing photo via AJAX
                fetch(`/changeorder/photo/${currentPhotoId}/annotations/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ annotations: annotationsJSON })
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          alert('Anotaciones guardadas exitosamente');
                          closePhotoEditor();
                      }
                  });
            } else if (currentPhotoIndex !== null) {
                // Save to new photo file object and show in preview
                selectedFiles[currentPhotoIndex].annotations = currentAnnotations;
                closePhotoEditor();
                renderPhotoPreview();
            }
        }

        function closePhotoEditor() {
            document.getElementById('photoEditorModal').classList.remove('active');
            currentPhotoId = null;
            currentPhotoIndex = null;
            currentAnnotations = [];
            currentImageUrl = null;
        }

        function deletePhoto(photoId) {
            console.log('deletePhoto called with photoId:', photoId);
            if (!confirm('¿Está seguro de eliminar esta foto?')) {
                console.log('User cancelled delete');
                return;
            }
            
            console.log('Sending delete request to:', `/changeorder/photo/${photoId}/delete/`);
            
            fetch(`/changeorder/photo/${photoId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                console.log('Delete response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Delete response data:', data);
                if (data.success) {
                    console.log('Photo deleted successfully, reloading page');
                    location.reload();
                } else {
                    alert('Error al eliminar la foto');
                }
            })
            .catch(error => {
                console.error('Error deleting photo:', error);
                alert('Error al eliminar la foto: ' + error.message);
            });
        }
    </script>
</body>
</html>
