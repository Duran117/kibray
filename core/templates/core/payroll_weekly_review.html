{% extends 'core/base.html' %}
{% load static %}
{% block content %}
<div class="container py-4">
  <h2>Nómina Semanal: {{ week_start }} — {{ week_end }}</h2>

  <div class="d-flex gap-2 my-3">
    <form method="get" class="d-flex gap-2">
      <input type="date" name="week_start" value="{{ week_start }}" class="form-control" />
      <button class="btn btn-outline-primary" type="submit">Ir a semana</button>
    </form>
    <form method="post" class="ms-auto">{% csrf_token %}
      <input type="hidden" name="action" value="approve_period" />
      <button class="btn btn-success" {% if period.status == 'approved' %}disabled{% endif %}>Aprobar Semana</button>
    </form>
  </div>

  <div class="alert alert-info">
    Total Nómina: <strong>${{ total_payroll|floatformat:2 }}</strong> · Pagado: <strong>${{ total_paid|floatformat:2 }}</strong> · Pendiente: <strong>${{ balance_due|floatformat:2 }}</strong>
  </div>

  <form method="post" class="card">{% csrf_token %}
    <input type="hidden" name="action" value="update_records" />
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>Empleado</th>
            <th>Horas calculadas</th>
            <th>Horas (editar)</th>
            <th>Tasa base</th>
            <th>Tasa ajustada</th>
            <th>Total ($)</th>
            <th>Notas</th>
            <th>Pago</th>
          </tr>
        </thead>
        <tbody>
        {% for item in employee_data %}
          {% with emp=item.employee rec=item.record %}
          <tr>
            <td>
              <div class="fw-semibold">{{ emp.first_name }} {{ emp.last_name }}</div>
              <div class="small text-muted">{{ emp.role|default:"Empleado" }}</div>
              <details class="small mt-1">
                <summary>Desglose por Proyecto</summary>
                <ul class="mb-0">
                  {% for pname, hrs in item.hours_by_project.items %}
                    <li>{{ pname }}: {{ hrs|floatformat:2 }}h</li>
                  {% empty %}<li>—</li>{% endfor %}
                </ul>
              </details>
              <details class="small mt-1">
                <summary>Desglose por CO</summary>
                <ul class="mb-0">
                  {% for co_desc, hrs in item.hours_by_co.items %}
                    <li>{{ co_desc }}: {{ hrs|floatformat:2 }}h</li>
                  {% empty %}<li>—</li>{% endfor %}
                </ul>
              </details>
            </td>
            <td>{{ item.calculated_hours|floatformat:2 }} h</td>
            <td style="max-width:120px"><input class="form-control" type="number" step="0.01" name="hours_{{ emp.id }}" value="{{ rec.total_hours|default:item.calculated_hours }}" /></td>
            <td>${{ rec.hourly_rate|floatformat:2 }}</td>
            <td style="max-width:120px"><input class="form-control" type="number" step="0.01" name="rate_{{ emp.id }}" value="{{ rec.adjusted_rate|default:rec.hourly_rate }}" /></td>
            <td>${{ rec.total_pay|floatformat:2 }}</td>
            <td style="max-width:220px"><input class="form-control" type="text" name="notes_{{ emp.id }}" value="{{ rec.notes }}" placeholder="Notas" /></td>
            <td>
              <a href="{% url 'payroll_record_payment' rec.id %}" class="btn btn-sm btn-outline-success">Registrar Pago</a>
              <div class="small text-muted">Pagado: ${{ rec.amount_paid|floatformat:2 }} · Pendiente: ${{ rec.balance_due|floatformat:2 }}</div>
            </td>
          </tr>
          {% endwith %}
        {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="p-3 text-end">
      <button class="btn btn-primary">Guardar Cambios</button>
    </div>
  </form>
</div>
{% endblock %}
