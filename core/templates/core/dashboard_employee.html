{% extends "core/base_modern.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Employee Dashboard" %} | Kibray{% endblock %}

{% block extra_css %}
<style>
/* ===== EMPLOYEE DASHBOARD - ASANA STYLE ===== */
:root {
    --emp-primary: #6366f1;
    --emp-primary-dark: #4f46e5;
    --emp-success: #10b981;
    --emp-warning: #f59e0b;
    --emp-danger: #ef4444;
    --emp-gray-50: #f9fafb;
    --emp-gray-100: #f3f4f6;
    --emp-gray-200: #e5e7eb;
    --emp-gray-300: #d1d5db;
    --emp-gray-500: #6b7280;
    --emp-gray-600: #4b5563;
    --emp-gray-700: #374151;
    --emp-gray-800: #1f2937;
    --emp-gray-900: #111827;
}

.emp-dashboard {
    min-height: calc(100vh - 64px);
    background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
    padding: 24px;
}

/* Header */
.emp-header {
    background: white;
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
}

.emp-greeting {
    display: flex;
    align-items: center;
    gap: 20px;
}

.emp-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--emp-primary) 0%, #8b5cf6 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    font-weight: 700;
    box-shadow: 0 4px 14px rgba(99, 102, 241, 0.4);
}

.emp-greeting h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--emp-gray-900);
    margin: 0;
}

.emp-greeting p {
    color: var(--emp-gray-500);
    margin: 4px 0 0 0;
    font-size: 15px;
}

.emp-time-display {
    text-align: right;
}

.emp-time-display .time {
    font-size: 32px;
    font-weight: 700;
    color: var(--emp-gray-900);
    font-family: 'SF Mono', 'Consolas', monospace;
}

.emp-time-display .date {
    color: var(--emp-gray-500);
    font-size: 14px;
}

/* Weekly Hours Card */
.weekly-hours-card {
    background: linear-gradient(135deg, #059669 0%, #10b981 100%);
    border-radius: 16px;
    padding: 28px 32px;
    margin-bottom: 24px;
    box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
}

.weekly-hours-info {
    display: flex;
    align-items: center;
    gap: 20px;
}

.weekly-hours-icon {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
}

.weekly-hours-text h2 {
    margin: 0;
    font-size: 32px;
    font-weight: 700;
}

.weekly-hours-text p {
    margin: 4px 0 0 0;
    opacity: 0.9;
    font-size: 14px;
}

.weekly-pay-estimate {
    text-align: right;
    background: rgba(255, 255, 255, 0.15);
    padding: 16px 24px;
    border-radius: 12px;
}

.weekly-pay-estimate .label {
    font-size: 12px;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.weekly-pay-estimate .amount {
    font-size: 28px;
    font-weight: 700;
}

.weekly-pay-estimate .note {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 4px;
}

/* Clock Card */
.clock-card {
    background: white;
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    text-align: center;
}

.clock-status {
    margin-bottom: 24px;
}

.clock-status .icon {
    font-size: 64px;
    margin-bottom: 16px;
}

.clock-status.working .icon {
    color: var(--emp-success);
    animation: pulse 2s infinite;
}

.clock-status.not-working .icon {
    color: var(--emp-gray-300);
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.8; }
}

.clock-status h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--emp-gray-900);
    margin: 0 0 8px 0;
}

.clock-status p {
    color: var(--emp-gray-500);
    margin: 0;
}

.clock-project {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--emp-gray-100);
    padding: 8px 16px;
    border-radius: 20px;
    margin-top: 12px;
    font-weight: 500;
    color: var(--emp-gray-700);
}

.clock-btn {
    padding: 16px 48px;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 12px;
}

.clock-btn.clock-in {
    background: linear-gradient(135deg, var(--emp-success) 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
}

.clock-btn.clock-in:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
}

.clock-btn.clock-out {
    background: linear-gradient(135deg, var(--emp-danger) 0%, #dc2626 100%);
    color: white;
    box-shadow: 0 4px 14px rgba(239, 68, 68, 0.4);
}

.clock-btn.clock-out:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
}

/* Clock Form */
.clock-form {
    max-width: 500px;
    margin: 0 auto;
    text-align: left;
}

.clock-form .form-group {
    margin-bottom: 20px;
}

.clock-form label {
    display: block;
    font-weight: 600;
    color: var(--emp-gray-700);
    margin-bottom: 8px;
}

.clock-form label small {
    font-weight: 400;
}

.co-help-text {
    font-size: 12px;
    color: var(--emp-gray-500);
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.co-help-text i {
    color: var(--emp-primary);
}

#change-order-group {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #7dd3fc;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
}

#change-order-group label {
    color: #0369a1;
}

#change-order-group select {
    background: white;
    border-color: #7dd3fc;
}

.clock-form select,
.clock-form textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--emp-gray-200);
    border-radius: 10px;
    font-size: 15px;
    transition: all 0.2s;
}

.clock-form select:focus,
.clock-form textarea:focus {
    outline: none;
    border-color: var(--emp-primary);
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
}

/* Stats Grid */
.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 16px;
}

.stat-card .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.stat-card .stat-icon.blue { background: #dbeafe; color: #2563eb; }
.stat-card .stat-icon.green { background: #d1fae5; color: #059669; }
.stat-card .stat-icon.purple { background: #ede9fe; color: #7c3aed; }
.stat-card .stat-icon.orange { background: #ffedd5; color: #ea580c; }

.stat-card .stat-info h3 {
    font-size: 24px;
    font-weight: 700;
    color: var(--emp-gray-900);
    margin: 0;
}

.stat-card .stat-info p {
    font-size: 13px;
    color: var(--emp-gray-500);
    margin: 4px 0 0 0;
}

/* Main Grid */
.emp-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 24px;
}

/* Section Cards */
.section-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
}

.section-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--emp-gray-100);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.section-header h3 {
    font-size: 16px;
    font-weight: 600;
    color: var(--emp-gray-900);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-header h3 i {
    color: var(--emp-primary);
}

.section-badge {
    background: var(--emp-primary);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.section-body {
    padding: 20px 24px;
}

/* Task List */
.task-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.task-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px 0;
    border-bottom: 1px solid var(--emp-gray-100);
}

.task-item:last-child {
    border-bottom: none;
}

.task-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid var(--emp-gray-300);
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 2px;
    cursor: pointer;
    transition: all 0.2s;
}

.task-checkbox:hover {
    border-color: var(--emp-primary);
}

.task-checkbox.completed {
    background: var(--emp-success);
    border-color: var(--emp-success);
}

.task-content {
    flex: 1;
}

.task-title {
    font-weight: 500;
    color: var(--emp-gray-900);
    margin: 0 0 4px 0;
}

.task-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    color: var(--emp-gray-500);
}

.task-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
}

.task-tag.project {
    background: #dbeafe;
    color: #1d4ed8;
}

.task-tag.touchup {
    background: #fef3c7;
    color: #92400e;
}

/* Schedule List */
.schedule-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 0;
    border-bottom: 1px solid var(--emp-gray-100);
}

.schedule-item:last-child {
    border-bottom: none;
}

.schedule-time {
    background: linear-gradient(135deg, var(--emp-primary) 0%, #8b5cf6 100%);
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
    text-align: center;
    min-width: 60px;
}

.schedule-info h4 {
    font-weight: 600;
    color: var(--emp-gray-900);
    margin: 0 0 4px 0;
}

.schedule-info p {
    font-size: 13px;
    color: var(--emp-gray-500);
    margin: 0;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--emp-gray-500);
}

.empty-state i {
    font-size: 48px;
    opacity: 0.3;
    margin-bottom: 16px;
}

.empty-state p {
    margin: 0;
}

/* Assignment Alert */
.assignment-alert {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border: 1px solid #93c5fd;
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 20px;
}

.assignment-alert h4 {
    font-weight: 600;
    color: #1e40af;
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.assignment-alert ul {
    margin: 0;
    padding-left: 20px;
    color: #1e40af;
}

.assignment-alert li {
    margin: 4px 0;
}

/* No Assignment Warning */
.no-assignment-warning {
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    border: 1px solid #fcd34d;
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 20px;
}

.no-assignment-warning h4 {
    font-weight: 600;
    color: #92400e;
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.no-assignment-warning p {
    color: #92400e;
    margin: 0;
    font-size: 14px;
}

/* Responsive */
@media (max-width: 768px) {
    .emp-dashboard {
        padding: 12px;
    }
    
    .emp-header {
        flex-direction: column;
        text-align: center;
        padding: 20px;
    }
    
    .emp-greeting {
        flex-direction: column;
    }
    
    .emp-time-display {
        text-align: center;
    }
    
    .emp-grid {
        grid-template-columns: 1fr;
    }
    
    .clock-card {
        padding: 20px;
    }
    
    .clock-btn {
        padding: 14px 32px;
        font-size: 16px;
        width: 100%;
        justify-content: center;
    }
    
    .weekly-hours-card {
        flex-direction: column;
        text-align: center;
        padding: 20px;
    }
    
    .weekly-pay-estimate {
        text-align: center;
        width: 100%;
    }
    
    .stats-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .stat-card {
        padding: 16px;
    }
    
    .stat-card .stat-info h3 {
        font-size: 20px;
    }
}

/* ===== SWITCH CONTEXT STYLES ===== */
.switch-context-section {
    margin-top: 24px;
    padding: 20px;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: 16px;
    border: 1px solid #7dd3fc;
}

.switch-context-section h4 {
    font-size: 14px;
    font-weight: 600;
    color: #0369a1;
    margin: 0 0 16px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.switch-options {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
}

.switch-group {
    flex: 1;
    min-width: 200px;
}

.switch-group-title {
    font-size: 11px;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.switch-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 12px 16px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 500;
    color: #334155;
}

.switch-btn:hover {
    border-color: var(--emp-primary);
    background: #f8fafc;
    transform: translateY(-1px);
}

.switch-btn.co-btn {
    border-left: 4px solid #8b5cf6;
}

.switch-btn.co-btn:hover {
    border-color: #8b5cf6;
    background: #faf5ff;
}

.switch-btn.project-btn {
    border-left: 4px solid #10b981;
}

.switch-btn.project-btn:hover {
    border-color: #10b981;
    background: #f0fdf4;
}

.switch-btn.base-btn {
    border-left: 4px solid #6366f1;
}

.switch-btn.base-btn:hover {
    border-color: #6366f1;
    background: #eef2ff;
}

.switch-btn .switch-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
}

.switch-btn.co-btn .switch-icon {
    background: #ede9fe;
    color: #7c3aed;
}

.switch-btn.project-btn .switch-icon {
    background: #d1fae5;
    color: #059669;
}

.switch-btn.base-btn .switch-icon {
    background: #e0e7ff;
    color: #4f46e5;
}

.switch-btn .switch-label {
    flex: 1;
    text-align: left;
}

.switch-btn .switch-label .name {
    font-weight: 600;
    color: #1e293b;
}

.switch-btn .switch-label .type {
    font-size: 11px;
    color: #64748b;
}

.switch-btn .switch-arrow {
    color: #94a3b8;
    font-size: 18px;
}

/* Current context badge */
.current-context-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-top: 8px;
}

.current-context-badge.on-base {
    background: #dbeafe;
    color: #1d4ed8;
}

.current-context-badge.on-co {
    background: #ede9fe;
    color: #7c3aed;
}

@media (max-width: 768px) {
    .switch-context-section {
        margin-top: 16px;
        padding: 16px;
    }
    
    .switch-options {
        flex-direction: column;
    }
    
    .switch-group {
        min-width: 100%;
    }
    
    .switch-btn {
        padding: 14px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="emp-dashboard">
    {% if not employee %}
    <div class="clock-card">
        <div class="empty-state">
            <i class="bi bi-person-x"></i>
            <h2>{% trans "Account Not Linked" %}</h2>
            <p>{% trans "Your user account is not linked to an employee profile. Please contact your administrator." %}</p>
        </div>
    </div>
    {% else %}
    
    <!-- Header -->
    <div class="emp-header">
        <div class="emp-greeting">
            <div class="emp-avatar">
                {{ employee.first_name|slice:":1" }}{{ employee.last_name|slice:":1" }}
            </div>
            <div>
                <h1>{% trans "Hello" %}, {{ employee.first_name }}! üëã</h1>
                <p>{% trans "Welcome to your dashboard" %}</p>
            </div>
        </div>
        <div class="emp-time-display">
            <div class="time" id="currentTime">--:--</div>
            <div class="date">{{ today|date:"l, F d, Y" }}</div>
        </div>
    </div>
    
    <!-- Clock In/Out Card -->
    <div class="clock-card">
        {% if open_entry %}
        <!-- Currently Working -->
        <div class="clock-status working">
            <div class="icon"><i class="bi bi-clock-fill"></i></div>
            <h2>{% trans "Currently Working" %}</h2>
            <p>{% trans "Started at" %} {{ open_entry.start_time|time:"g:i A" }}</p>
            <div class="clock-project">
                <i class="bi bi-building"></i>
                {{ open_entry.project.name }}
                {% if open_entry.change_order %}
                <span class="current-context-badge on-co">
                    <i class="bi bi-file-text"></i>
                    {{ open_entry.change_order.title }}
                </span>
                {% else %}
                <span class="current-context-badge on-base">
                    <i class="bi bi-house"></i>
                    {% trans "Base Work" %}
                </span>
                {% endif %}
            </div>
        </div>
        
        <!-- Clock Out Button -->
        <form method="post" style="margin-top: 24px;">
            {% csrf_token %}
            <input type="hidden" name="action" value="clock_out">
            <button type="submit" class="clock-btn clock-out">
                <i class="bi bi-box-arrow-right"></i>
                {% trans "Clock Out" %}
            </button>
        </form>
        
        <!-- Switch Context Section -->
        {% if switch_options %}
        <div class="switch-context-section">
            <h4><i class="bi bi-arrow-left-right"></i> {% trans "Switch Context" %}</h4>
            
            <div class="switch-options">
                <!-- Change Orders del proyecto actual -->
                {% if switch_options.available_cos %}
                <div class="switch-group">
                    <div class="switch-group-title">üìã {% trans "Change Orders" %} ({{ switch_options.current_project.name }})</div>
                    {% for co in switch_options.available_cos %}
                    <form method="post" style="display: contents;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="switch_context">
                        <input type="hidden" name="switch_type" value="co">
                        <input type="hidden" name="target_id" value="{{ co.id }}">
                        <button type="submit" class="switch-btn co-btn">
                            <div class="switch-icon"><i class="bi bi-file-earmark-text"></i></div>
                            <div class="switch-label">
                                <div class="name">{{ co.title }}</div>
                                <div class="type">{{ co.pricing_label }}</div>
                            </div>
                            <div class="switch-arrow"><i class="bi bi-chevron-right"></i></div>
                        </button>
                    </form>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- Volver a trabajo base (solo si est√° en CO) -->
                {% if switch_options.can_switch_to_base %}
                <div class="switch-group">
                    <div class="switch-group-title">üè† {% trans "Base Work" %}</div>
                    <form method="post" style="display: contents;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="switch_context">
                        <input type="hidden" name="switch_type" value="base">
                        <input type="hidden" name="target_id" value="{{ switch_options.current_project.id }}">
                        <button type="submit" class="switch-btn base-btn">
                            <div class="switch-icon"><i class="bi bi-house"></i></div>
                            <div class="switch-label">
                                <div class="name">{{ switch_options.current_project.name }}</div>
                                <div class="type">{% trans "Contract Base Work" %}</div>
                            </div>
                            <div class="switch-arrow"><i class="bi bi-chevron-right"></i></div>
                        </button>
                    </form>
                </div>
                {% endif %}
                
                <!-- Otros proyectos -->
                {% if switch_options.other_projects %}
                <div class="switch-group">
                    <div class="switch-group-title">üèóÔ∏è {% trans "Other Projects" %} ({{ switch_options.other_projects_count }})</div>
                    {% for proj in switch_options.other_projects %}
                    <form method="post" style="display: contents;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="switch_context">
                        <input type="hidden" name="switch_type" value="project">
                        <input type="hidden" name="target_id" value="{{ proj.id }}">
                        <button type="submit" class="switch-btn project-btn">
                            <div class="switch-icon"><i class="bi bi-building"></i></div>
                            <div class="switch-label">
                                <div class="name">{{ proj.name }}</div>
                                <div class="type">{% trans "Base Work" %}</div>
                            </div>
                            <div class="switch-arrow"><i class="bi bi-chevron-right"></i></div>
                        </button>
                    </form>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% else %}
        <!-- Not Working -->
        <div class="clock-status not-working">
            <div class="icon"><i class="bi bi-clock"></i></div>
            <h2>{% trans "Ready to Start?" %}</h2>
            <p>{% trans "Clock in to begin your workday" %}</p>
        </div>
        
        {% if assignments_today %}
        <div class="assignment-alert">
            <h4><i class="bi bi-calendar-check"></i> {% trans "Today's Assignments" %}</h4>
            <ul>
                {% for a in assignments_today %}
                <li>{{ a.project.name }} ({{ a.get_shift_display }})</li>
                {% endfor %}
            </ul>
        </div>
        {% else %}
        <div class="no-assignment-warning">
            <h4><i class="bi bi-exclamation-triangle"></i> {% trans "No Assignments Today" %}</h4>
            <p>{% trans "Contact your supervisor for project assignment." %}</p>
        </div>
        {% endif %}
        
        <form method="post" class="clock-form" id="clock-in-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="clock_in">
            
            <div class="form-group">
                <label>{% trans "Project" %}</label>
                {{ form.project }}
            </div>
            
            <div class="form-group" id="change-order-group" style="display: none;">
                <label>
                    <i class="bi bi-file-earmark-text"></i>
                    {% trans "Change Order" %} <small style="color: #94a3b8;">({% trans "Optional" %})</small>
                </label>
                {{ form.change_order }}
                <div class="co-help-text">
                    <i class="bi bi-info-circle"></i>
                    {% trans "Select if working on a Change Order. Leave empty for base contract work." %}
                </div>
            </div>
            
            <div class="form-group">
                <label>{% trans "Budget Line" %} ({% trans "Optional" %})</label>
                {{ form.budget_line }}
            </div>
            
            <div class="form-group">
                <label>{% trans "Cost Code" %} ({% trans "Optional" %})</label>
                {{ form.cost_code }}
            </div>
            
            <div class="form-group">
                <label>{% trans "Notes" %} ({% trans "Optional" %})</label>
                {{ form.notes }}
            </div>
            
            <div style="text-align: center; margin-top: 24px;">
                <button type="submit" class="clock-btn clock-in">
                    <i class="bi bi-box-arrow-in-right"></i>
                    {% trans "Clock In" %}
                </button>
            </div>
        </form>
        
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const projectSelect = document.getElementById('id_project');
            const coSelect = document.getElementById('id_change_order');
            const coGroup = document.getElementById('change-order-group');
            
            if (!projectSelect || !coSelect || !coGroup) return;
            
            function updateChangeOrders() {
                const selectedProjectId = projectSelect.value;
                
                if (!selectedProjectId) {
                    coGroup.style.display = 'none';
                    return;
                }
                
                // Show the CO group
                coGroup.style.display = 'block';
                
                // Clear and rebuild options
                coSelect.innerHTML = '<option value="">-- {% trans "None (base work)" %} --</option>';
                
                // Fetch active COs for this project via AJAX
                fetch(`{% url 'changeorders_ajax' %}?project_id=${selectedProjectId}&status=active`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.change_orders && data.change_orders.length > 0) {
                            data.change_orders.forEach(co => {
                                const option = document.createElement('option');
                                option.value = co.id;
                                option.textContent = `${co.title} (${co.pricing_label})`;
                                coSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(err => {
                        console.log('Could not fetch COs:', err);
                    });
            }
            
            projectSelect.addEventListener('change', updateChangeOrders);
            
            // Initial state
            if (projectSelect.value) {
                updateChangeOrders();
            }
        });
        </script>
        {% endif %}
    </div>
    
    <!-- Weekly Hours Summary Card -->
    <div class="weekly-hours-card">
        <div class="weekly-hours-info">
            <div class="weekly-hours-icon">
                <i class="bi bi-clock-history"></i>
            </div>
            <div class="weekly-hours-text">
                <h2>{{ current_week_hours|floatformat:1 }} {% trans "hrs" %}</h2>
                <p>{% trans "Current Week" %} ({{ week_start|date:"M d" }} - {{ week_end|date:"M d" }})</p>
            </div>
        </div>
        {% if estimated_weekly_pay %}
        <div class="weekly-pay-estimate">
            <div class="label">{% trans "Estimated Pay" %}</div>
            <div class="amount">${{ estimated_weekly_pay|floatformat:2 }}</div>
            <div class="note">{% trans "Before taxes & deductions" %}</div>
        </div>
        {% endif %}
    </div>
    
    <!-- Last Week Summary Card -->
    <div class="weekly-hours-card" style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border: 1px solid #cbd5e1;">
        <div class="weekly-hours-info">
            <div class="weekly-hours-icon" style="background: #e2e8f0; color: #64748b;">
                <i class="bi bi-calendar-week"></i>
            </div>
            <div class="weekly-hours-text">
                <h2 style="color: #475569;">{{ last_week_hours|floatformat:1 }} {% trans "hrs" %}</h2>
                <p style="color: #64748b;">{% trans "Last Week" %} ({{ last_week_start|date:"M d" }} - {{ last_week_end|date:"M d" }})</p>
            </div>
        </div>
        {% if estimated_last_week_pay %}
        <div class="weekly-pay-estimate" style="background: rgba(71, 85, 105, 0.1);">
            <div class="label" style="color: #64748b;">{% trans "Last Week Pay" %}</div>
            <div class="amount" style="color: #475569;">${{ estimated_last_week_pay|floatformat:2 }}</div>
            <div class="note" style="color: #94a3b8;">{% trans "Pending payment" %}</div>
        </div>
        {% endif %}
    </div>
    
    <!-- Stats Row -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-icon blue"><i class="bi bi-calendar-check"></i></div>
            <div class="stat-info">
                <h3>{{ my_schedule|length }}</h3>
                <p>{% trans "Today's Schedule" %}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon purple"><i class="bi bi-list-task"></i></div>
            <div class="stat-info">
                <h3>{{ my_activities|length }}</h3>
                <p>{% trans "Activities Assigned" %}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon orange"><i class="bi bi-brush"></i></div>
            <div class="stat-info">
                <h3>{{ my_touchups|length }}</h3>
                <p>{% trans "Touch-ups Pending" %}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon green"><i class="bi bi-building"></i></div>
            <div class="stat-info">
                <h3>{{ assignments_today|length }}</h3>
                <p>{% trans "Projects Today" %}</p>
            </div>
        </div>
    </div>
    
    <!-- Main Grid -->
    <div class="emp-grid">
        <!-- Today's Activities -->
        <div class="section-card">
            <div class="section-header">
                <h3><i class="bi bi-lightning-charge"></i> {% trans "Today's Activities" %}</h3>
                {% if my_activities %}
                <span class="section-badge">{{ my_activities|length }}</span>
                {% endif %}
            </div>
            <div class="section-body">
                {% if my_activities %}
                <ul class="task-list">
                    {% for item in my_activities %}
                    <li class="task-item">
                        <div class="task-checkbox"></div>
                        <div class="task-content">
                            <p class="task-title">{{ item.activity.description }}</p>
                            <div class="task-meta">
                                <span class="task-tag project">
                                    <i class="bi bi-building"></i> {{ item.project.name }}
                                </span>
                                {% if item.activity.start_time %}
                                <span><i class="bi bi-clock"></i> {{ item.activity.start_time|time:"g:i A" }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-clipboard-check"></i>
                    <p>{% trans "No activities assigned for today" %}</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- My Schedule -->
        <div class="section-card">
            <div class="section-header">
                <h3><i class="bi bi-calendar3"></i> {% trans "Today's Schedule" %}</h3>
            </div>
            <div class="section-body">
                {% if my_schedule %}
                {% for s in my_schedule %}
                <div class="schedule-item">
                    <div class="schedule-time">
                        {{ s.start_datetime|time:"g:i A" }}
                    </div>
                    <div class="schedule-info">
                        <h4>{{ s.title }}</h4>
                        <p>{{ s.project.name }}</p>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-calendar-x"></i>
                    <p>{% trans "No scheduled events today" %}</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Touch-ups -->
        <div class="section-card">
            <div class="section-header">
                <h3><i class="bi bi-brush"></i> {% trans "My Touch-ups" %}</h3>
                {% if my_touchups %}
                <span class="section-badge">{{ my_touchups|length }}</span>
                {% endif %}
            </div>
            <div class="section-body">
                {% if my_touchups %}
                <ul class="task-list">
                    {% for task in my_touchups %}
                    <li class="task-item">
                        <div class="task-checkbox {% if task.status == 'Completada' %}completed{% endif %}"></div>
                        <div class="task-content">
                            <p class="task-title">{{ task.title }}</p>
                            <div class="task-meta">
                                <span class="task-tag touchup">
                                    <i class="bi bi-brush"></i> Touch-up
                                </span>
                                <span class="task-tag project">{{ task.project.name }}</span>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-brush"></i>
                    <p>{% trans "No touch-ups assigned" %}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    {% endif %}
</div>

<script>
// Update time display
function updateTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    });
    document.getElementById('currentTime').textContent = timeStr;
}
updateTime();
setInterval(updateTime, 1000);
</script>
{% endblock %}
