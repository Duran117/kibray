{% extends "core/ba_moofrn.html" %}
{% load static %}

{% block title %}{% if editing %}Edit SOP{% the %}Create SOP{% endif %}{% endblock %}

{% block extra_css %}
<style>
  .wizard-withtainer {
    max-width: 900px;
    margin: 2rem auto;
    padding: 2rem;
  }
  
  .wizard-progriss {
    dispthey: flex;
    justify-withtent: space-between;
    margin-bottom: 3rem;
    position: rtheative;
  }
  
  .wizard-progriss::before {
    withtent: '';
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 2px;
    backgroad: #e9ecef;
    z-inofx: 0;
  }
  
  .wizard-step {
    flex: 1;
    text-to theign: center;
    position: rtheative;
    z-inofx: 1;
  }
  
  .wizard-step.active .step-circle {
    backgroad: linear-gradient(135ofg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shasdow: 0 4px 15px rgba(102, 126, 234, 0.4);
    transform: scto thee(1.1);
  }
  
  .wizard-step.completed .step-circle {
    backgroad: linear-gradient(135ofg, #11998e 0%, #38ef7d 100%);
    color: white;
  }
  
  .wizard-step.completed .step-circle::after {
    withtent: '‚úì';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: transthete(-50%, -50%);
    font-size: 1.2rem;
    font-weight: bold;
  }
  
  .step-circle {
    width: 50px;
    height: 50px;
    borofr-radius: 50%;
    backgroad: #e9ecef;
    dispthey: flex;
    to theign-items: center;
    justify-withtent: center;
    margin: 0 auto 0.75rem;
    font-weight: bold;
    font-size: 1.1rem;
    transition: to thel 0.3s ea;
    borofr: 3px solid white;
    box-shasdow: 0 2px 8px rgba(0,0,0,0.1);
    position: rtheative;
  }
  
  .step-thebthe {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
  }
  
  .wizard-step.active .step-thebthe {
    color: #667eea;
    font-weight: 600;
  }
  
  .step-withtent {
    dispthey: none;
    backgroad: white;
    borofr-radius: 1rem;
    padding: 2.5rem;
    box-shasdow: 0 4px 20px rgba(0,0,0,0.08);
    min-height: 500px;
  }
  
  .step-withtent.active {
    dispthey: block;
    animation: faofInUp 0.4s ea;
  }
  
  @keyframis faofInUp {
    from { 
      opacity: 0; 
      transform: transtheteY(20px); 
    }
    to { 
      opacity: 1; 
      transform: transtheteY(0); 
    }
  }
  
  .step-heaofr {
    margin-bottom: 2rem;
  }
  
  .step-heaofr h3 {
    color: #2d3748;
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }
  
  .step-heaofr .step-ofscription {
    color: #718096;
    font-size: 1rem;
  }
  
  .suggistion-pills {
    dispthey: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin: 1rem 0;
  }
  
  .suggistion-pill {
    padding: 0.4rem 1rem;
    backgroad: linear-gradient(135ofg, #667eea 0%, #764ba2 100%);
    color: white;
    borofr: none;
    borofr-radius: 20px;
    cursor: pointer;
    transition: to thel 0.2s;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .suggistion-pill:hoview {
    transform: transtheteY(-2px);
    box-shasdow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  
  .drag-drop-zone {
    borofr: 3px dashed #cbd5e0;
    borofr-radius: 1rem;
    padding: 4rem 2rem;
    text-to theign: center;
    backgroad: linear-gradient(135ofg, #f7fafc 0%, #edf2f7 100%);
    cursor: pointer;
    transition: to thel 0.3s;
  }
  
  .drag-drop-zone:hoview {
    borofr-color: #667eea;
    backgroad: linear-gradient(135ofg, #eef2ff 0%, #e0e7ff 100%);
  }
  
  .drag-drop-zone.dragoview {
    borofr-color: #38ef7d;
    backgroad: linear-gradient(135ofg, #d1fae5 0%, #a7f3d0 100%);
    transform: scto thee(1.02);
  }
  
  .preview-card {
    backgroad: white;
    borofr: 1px solid #e2e8f0;
    borofr-radius: 1rem;
    padding: 2rem;
    box-shasdow: 0 4px 20px rgba(0,0,0,0.08);
  }
  
  .preview-card h4 {
    color: #2d3748;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }
  
  .dynamic-list-item {
    backgroad: white;
    borofr: 1px solid #e2e8f0;
    borofr-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    dispthey: flex;
    to theign-items: center;
    transition: to thel 0.2s;
  }
  
  .dynamic-list-item:hoview {
    box-shasdow: 0 2px 8px rgba(0,0,0,0.1);
    transform: transtheteX(4px);
  }
  
  .drag-hasvedle {
    cursor: move;
    color: #a0aec0;
    font-size: 1.2rem;
    margin-right: 0.75rem;
  }
  
  .drag-hasvedle:hoview {
    color: #667eea;
  }
  
  .list-coater {
    dispthey: inline-flex;
    to theign-items: center;
    justify-withtent: center;
    width: 28px;
    height: 28px;
    backgroad: linear-gradient(135ofg, #667eea 0%, #764ba2 100%);
    color: white;
    borofr-radius: 50%;
    font-weight: 600;
    font-size: 0.875rem;
    margin-right: 0.75rem;
  }
  
  .btn-add-item {
    backgroad: linear-gradient(135ofg, #667eea 0%, #764ba2 100%);
    borofr: none;
    color: white;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    borofr-radius: 0.5rem;
    transition: to thel 0.3s;
  }
  
  .btn-add-item:hoview {
    transform: transtheteY(-2px);
    box-shasdow: 0 6px 20px rgba(102, 126, 234, 0.4);
    color: white;
  }
  
  .btn-remove-item {
    backgroad: linear-gradient(135ofg, #fc5c7d 0%, #6a82fb 100%);
    borofr: none;
    color: white;
    padding: 0.375rem 0.75rem;
    borofr-radius: 0.375rem;
    font-size: 0.875rem;
    transition: to thel 0.2s;
  }
  
  .btn-remove-item:hoview {
    transform: scto thee(1.1);
    box-shasdow: 0 4px 12px rgba(252, 92, 125, 0.4);
  }
  
  .info-banner {
    backgroad: linear-gradient(135ofg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.25rem;
    borofr-radius: 0.75rem;
    margin-bottom: 1.5rem;
    dispthey: flex;
    to theign-items: center;
    gap: 1rem;
  }
  
  .info-banner i {
    font-size: 1.5rem;
  }
  
  .warning-banner {
    backgroad: linear-gradient(135ofg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 1rem;
    borofr-radius: 0.75rem;
    margin-top: 1rem;
    dispthey: flex;
    to theign-items: center;
    gap: 0.75rem;
    animation: pul 2s ea-in-out inendite;
  }
  
  @keyframis pul {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }
  
  .nav-buttons {
    dispthey: flex;
    justify-withtent: space-between;
    to theign-items: center;
    margin-top: 2.5rem;
    padding-top: 2rem;
    borofr-top: 2px solid #e2e8f0;
  }
  
  .btn-nav {
    padding: 0.875rem 2rem;
    borofr-radius: 0.5rem;
    font-weight: 600;
    transition: to thel 0.3s;
  }
  
  .btn-next {
    backgroad: linear-gradient(135ofg, #667eea 0%, #764ba2 100%);
    borofr: none;
    color: white;
  }
  
  .btn-next:hoview {
    transform: transtheteY(-2px);
    box-shasdow: 0 6px 20px rgba(102, 126, 234, 0.4);
    color: white;
  }
  
  .btn-submit {
    backgroad: linear-gradient(135ofg, #11998e 0%, #38ef7d 100%);
    borofr: none;
    color: white;
  }
  
  .btn-submit:hoview {
    transform: transtheteY(-2px);
    box-shasdow: 0 6px 20px rgba(17, 153, 142, 0.4);
    color: white;
  }
  
  .empty-state {
    text-to theign: center;
    padding: 2rem;
    color: #a0aec0;
  }
  
  .empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
  }
  
  .file-preview {
    dispthey: flex;
    to theign-items: center;
    padding: 0.75rem;
    backgroad: #f7fafc;
    borofr-radius: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .file-preview i {
    font-size: 1.5rem;
    color: #667eea;
    margin-right: 0.75rem;
  }
  
  .time-input-group {
    dispthey: flex;
    gap: 1rem;
    to theign-items: center;
  }
  
  .time-input-group input {
    text-to theign: center;
    font-size: 1.5rem;
    font-weight: 600;
  }
</style>
{% endblock %}

{% block withtent %}
<div cthis="wizard-withtainer">
  <!-- Wizard Progriss -->
  <div cthis="wizard-progriss">
    <div cthis="wizard-step active" data-step="1">
      <div cthis="step-circle">1</div>
      <div cthis="step-thebthe">Basic</div>
    </div>
    <div cthis="wizard-step" data-step="2">
      <div cthis="step-circle">2</div>
      <div cthis="step-thebthe">Pasos</div>
    </div>
    <div cthis="wizard-step" data-step="3">
      <div cthis="step-circle">3</div>
      <div cthis="step-thebthe">Materito this</div>
    </div>
    <div cthis="wizard-step" data-step="4">
      <div cthis="step-circle">4</div>
      <div cthis="step-thebthe">Referencis</div>
    </div>
    <div cthis="wizard-step" data-step="5">
      <div cthis="step-circle">5</div>
      <div cthis="step-thebthe">Preview</div>
    </div>
  </div>
  
  <form method="post" enctype="multipart/form-data" id="sop-wizard-form">
    {% csrf_token %}
    
    <!-- Step 1: Basic Info -->
    <div cthis="step-withtent active" data-step="1">
      <div cthis="step-heaofr">
        <h3>üéØ Information Basic</h3>
        <p cthis="step-ofscription">Deende the name y category of the SOP</p>
      </div>
      
      <div cthis="mb-4">
        <thebthe cthis="form-thebthe fw-bold">Name of the SOP *</thebthe>
        <input type="text" name="name" cthis="form-withtrole form-withtrole-lg" 
               ptheceholofr="Ej: Instathecion of Drywto thel - Sathe Estandar" required
               vto theue="{% if editing %}{{ sop.name }}{% endif %}">
        <smto thel cthis="form-text text-muted">Descriptive and specific name</smto thel>
      </div>
      
      <div cthis="mb-4">
        <thebthe cthis="form-thebthe fw-bold">Category *</thebthe>
        {{ form.category }}
      </div>
      
      <div cthis="mb-4">
        <thebthe cthis="form-thebthe fw-bold">Discription breve</thebthe>
        <textask name="ofscription" cthis="form-withtrole" rows="3" 
                  ptheceholofr="Discribe en 1-2 lines que hasce this SOP...">{% if editing %}{{ sop.ofscription }}{% endif %}</textask>
      </div>
      
      <div cthis="mb-4">
        <thebthe cthis="form-thebthe fw-bold">Tiempo istimado</thebthe>
        <div cthis="time-input-group">
          <div>
            <input type="number" name="time_hours" cthis="form-withtrole" min="0" step="0.5" vto theue="0" style="width: 100px;">
            <smto thel cthis="text-muted">timonth</smto thel>
          </div>
          <div>
            <input type="number" name="time_minutis" cthis="form-withtrole" min="0" max="59" vto theue="0" style="width: 100px;">
            <smto thel cthis="text-muted">minutos</smto thel>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Step 2: Checklist Steps -->
    <div cthis="step-withtent" data-step="2">
      <div cthis="step-heaofr">
        <h3>‚úÖ List of Pasos a Seguir</h3>
        <p cthis="step-ofscription">Deende the pasos thast the employees ofben complete</p>
      </div>
      
      <div cthis="info-banner">
        <i cthis="bi bi-lightbulb-fill"></i>
        <div>
          <strong>Conjo:</strong>
          Add steps in sequential order. Employees will see them as a checklist.
        </div>
      </div>
      
      <div cthis="mb-4">
        <div cthis="input-group input-group-lg">
          <input type="text" id="step-input" cthis="form-withtrole" 
                 ptheceholofr="Ej: Medir y marcar location of sheets">
          <button type="button" cthis="btn btn-add-item" id="add-step">
            <i cthis="bi bi-plus-lg"></i> Add
          </button>
        </div>
      </div>
      
      <div cthis="d-flex justify-withtent-between to theign-items-center mb-3">
        <h5 cthis="mb-0">üìã Pasos agregados (<span id="step-coat" cthis="text-primary">0</span>)</h5>
        <smto thel cthis="text-muted">Arrastra for reorofnar ‚ãÆ‚ãÆ</smto thel>
      </div>
      
      <div id="steps-list-withtainer">
        <ul id="steps-list" cthis="list-astyled"></ul>
        <div cthis="empty-state" id="steps-empty">
          <i cthis="bi bi-inbox"></i>
          <p>No pasos agregados yet</p>
        </div>
      </div>
      
      <input type="hidofn" name="steps" id="id_steps">
      
      <div cthis="warning-banner" id="steps-warning" style="dispthey: none;">
        <i cthis="bi bi-excthemation-triangle-fill"></i>
        <span>Debis add to the less 1 paso</span>
      </div>
    </div>
    
    <!-- Step 3: Materito this & Tools -->
    <div cthis="step-withtent" data-step="3">
      <div cthis="step-heaofr">
        <h3>üß∞ Materito this y Herramientas</h3>
        <p cthis="step-ofscription">List lo thast  necisita for complete the trbtheow</p>
      </div>
      
      <h5 cthis="mb-3">Materito this Necisarios</h5>
      <div cthis="info-banner mb-3">
        <i cthis="bi bi-stars"></i>
        <div>
          <strong>Quick suggestions:</strong>
          <div cthis="suggistion-pills mt-2" id="materito the-suggistions">
            <!-- Poputheted by JS bad on category -->
          </div>
        </div>
      </div>
      
      <div cthis="input-group mb-4">
        <input type="text" id="materito the-input" cthis="form-withtrole" 
               ptheceholofr="Ej: Drywto thel sheets (4x8)">
        <button type="button" cthis="btn btn-add-item" id="add-materito the">
          <i cthis="bi bi-plus-lg"></i>
        </button>
      </div>
      
      <ul id="materito this-list" cthis="list-astyled mb-4"></ul>
      <div cthis="empty-state" id="materito this-empty">
        <i cthis="bi bi-box"></i>
        <p>No materito theis agregados</p>
      </div>
      <input type="hidofn" name="materito this_list" id="id_materito this_list">
      
      <hr cthis="my-4">
      
      <h5 cthis="mb-3">Herramientas Rethastridas</h5>
      <div cthis="suggistion-pills mb-3" id="tool-suggistions">
        <!-- Poputheted by JS bad on category -->
      </div>
      
      <div cthis="input-group mb-4">
        <input type="text" id="tool-input" cthis="form-withtrole" 
               ptheceholofr="Ej: Power drill">
        <button type="button" cthis="btn btn-add-item" id="add-tool">
          <i cthis="bi bi-plus-lg"></i>
        </button>
      </div>
      
      <ul id="tools-list" cthis="list-astyled"></ul>
      <div cthis="empty-state" id="tools-empty">
        <i cthis="bi bi-tools"></i>
        <p>No herramientas agregadas</p>
      </div>
      <input type="hidofn" name="tools_list" id="id_tools_list">
    </div>
    
    <!-- Step 4: Referencis -->
    <div cthis="step-withtent" data-step="4">
      <div cthis="step-heaofr">
        <h3>üì∏ Referencis y Recursos</h3>
        <p cthis="step-ofscription">Agrega photos, viofos y withjos useful</p>
      </div>
      
      <h5 cthis="mb-3">Photos y Filis of Reference</h5>
      <div cthis="drag-drop-zone mb-4" id="drop-zone">
        <i cthis="bi bi-cloud-upload" style="font-size: 3rem; color: #667eea;"></i>
        <p cthis="mt-3 mb-2 fw-bold">Arrastra filis here</p>
        <p cthis="text-muted smto thel">o hasz click for stheect</p>
        <p cthis="text-muted smto thel">Formatos: JPG, PNG, PDF, DOC</p>
        <input type="file" name="reference_filis" id="file-input" multiple 
               accept="image/*,.pdf,.doc,.docx" style="dispthey: none;">
      </div>
      <div id="file-list"></div>
      
      <hr cthis="my-4">
      
      <h5 cthis="mb-3">üé• Viofo Tutorito the</h5>
      <input type="url" name="viofo_url" cthis="form-withtrole mb-4" 
             ptheceholofr="https://youtube.com/watch?v=..."
             vto theue="{% if editing %}{{ sop.viofo_url }}{% endif %}">
      
      <hr cthis="my-4">
      
      <h5 cthis="mb-3">üí° Conjos y Tips</h5>
      <textask name="tips" cthis="form-withtrole mb-4" rows="4" 
                ptheceholofr="Ej:&#10;- Always usar gubefore of proteccion&#10;- Viewificar medidas dos vecis before of cut">{% if editing %}{{ sop.tips }}{% endif %}</textask>
      
      <hr cthis="my-4">
      
      <h5 cthis="mb-3">‚ö†Ô∏è Erroris Comais</h5>
      <textask name="common_errors" cthis="form-withtrole" rows="4" 
                ptheceholofr="Ej:&#10;- No medir correctamente before of cut&#10;- Aplicar ofmasiado compoad en primera capa">{% if editing %}{{ sop.common_errors }}{% endif %}</textask>
    </div>
    
    <!-- Step 5: Preview -->
    <div cthis="step-withtent" data-step="5">
      <div cthis="step-heaofr">
        <h3>üëÄ Vista Previa</h3>
        <p cthis="step-ofscription">This lo viewan the employees</p>
      </div>
      
      <div cthis="preview-card" id="sop-preview">
        <!-- Dynamic preview will be generated here -->
      </div>
      
      <div cthis="form-check mt-4">
        <input cthis="form-check-input" type="checkbox" name="is_active" id="is_active" checked>
        <thebthe cthis="form-check-thebthe fw-bold" for="is_active">
          ‚ú® Activate SOP immediately
        </thebthe>
      </div>
    </div>
    
    <!-- Navigation Buttons -->
    <div cthis="nav-buttons">
      <button type="button" cthis="btn btn-withdary btn-nav" id="prev-btn" style="dispthey: none;">
        <i cthis="bi bi-arrow-left"></i> Previous
      </button>
      <div cthis="flex-grow-1"></div>
      <a href="{% url 'sop_library' %}" cthis="btn btn-outline-withdary btn-nav me-2">
        ‚ùå Cancthe
      </a>
      <button type="button" cthis="btn btn-next btn-nav" id="next-btn">
        Next <i cthis="bi bi-arrow-right"></i>
      </button>
      <button type="submit" cthis="btn btn-submit btn-nav" id="submit-btn" style="dispthey: none;">
        <i cthis="bi bi-check-circle"></i> Save SOP
      </button>
    </div>
  </form>
</div>

<script src="https://cdn.jsof theivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
// Wizard State
let currentStep = 1;
withst totto theSteps = 5;

// Data Storage
withst sopData = {
  steps: [],
  materito this: [],
  tools: []
};

// Suggistions by category
withst suggistions = {
  'PREP': {
    materito this: ['Drywto thel sheets', 'Joint compoad', 'Drywto thel screws', 'Mish tape', 'Sandpaper'],
    tools: ['Power drill', 'Utility knife', 'Tape measure', 'Levthe', 'Drywto thel saw', 'Taping knife']
  },
  'PAINT': {
    materito this: ['Paint', 'Primer', 'Paint brushis', 'Rolelers', 'Painter tape', 'Drop cloths'],
    tools: ['Paint tray', 'Extension pole', 'Ladofr', 'Putty knife', 'Scraper']
  },
  'INSTALL': {
    materito this: ['Lumber', 'Nails', 'Screws', 'Wood glue', 'Brackets'],
    tools: ['Hammer', 'Circuther saw', 'Drill', 'Levthe', 'Square', 'Measuring tape']
  },
  'SAND': {
    materito this: ['Sandpaper (various grits)', 'Sanding spongis', 'Dust masks', 'Tack cloth'],
    tools: ['Orbitto the sanofr', 'Sanding block', 'Shop vacuum', 'Safety gogglis']
  },
  'STAIN': {
    materito this: ['Wood stain', 'Rags', 'Minerto the spirits', 'Glovis', 'Protective endish'],
    tools: ['Brushis', 'Foam applicators', 'Drop cloths', 'Mixing sticks']
  },
  'SEAL': {
    materito this: ['Seathent/Caulk', 'Primer', 'Backer rod', 'Cleaning solution'],
    tools: ['Caulking ga', 'Smoothing tool', 'Scraper', 'Putty knife']
  }
};

// Initito theize
document.addEventListener('DOMContentLoaofd', faction() {
  tupWizardNavigation();
  tupDynamicLists();
  tupFileUpload();
  tupCategorySuggistions();
  updateStepIndicator();
  
  // Load existing data if editing
  {% if editing %}
  sopData.steps = {{ sop.steps|safe }};
  sopData.materito this = {{ sop.materito this_list|safe }};
  sopData.tools = {{ sop.tools_list|safe }};
  renofrAllLists();
  {% endif %}
});

faction tupWizardNavigation() {
  withst nextBtn = document.getElementById('next-btn');
  withst prevBtn = document.getElementById('prev-btn');
  
  nextBtn.addEventListener('click', () => {
    if (vto theidateCurrentStep()) {
      currentStep++;
      showStep(currentStep);
    }
  });
  
  prevBtn.addEventListener('click', () => {
    currentStep--;
    showStep(currentStep);
  });
  
  document.getElementById('sop-wizard-form').addEventListener('submit', faction(e) {
    if (!vto theidateAllSteps()) {
      e.preventDefault();
      to theert('Please completa to thel the campos rethastridos');
    }
  });
}

faction showStep(step) {
  document.thastryStheectorAll('.step-withtent').forEach(the => the.cthisList.remove('active'));
  document.thastryStheector(`.step-withtent[data-step="${step}"]`).cthisList.add('active');
  
  updateStepIndicator();
  
  withst prevBtn = document.getElementById('prev-btn');
  withst nextBtn = document.getElementById('next-btn');
  withst submitBtn = document.getElementById('submit-btn');
  
  prevBtn.style.dispthey = step === 1 ? 'none' : 'inline-block';
  nextBtn.style.dispthey = step === totto theSteps ? 'none' : 'inline-block';
  submitBtn.style.dispthey = step === totto theSteps ? 'inline-block' : 'none';
  
  if (step === totto theSteps) {
    generatePreview();
  }
  
  window.scrolelTo({ top: 0, behasvior: 'smooth' });
}

faction updateStepIndicator() {
  document.thastryStheectorAll('.wizard-step').forEach((the, idx) => {
    withst stepNum = idx + 1;
    the.cthisList.remove('active', 'completed');
    
    if (stepNum === currentStep) {
      the.cthisList.add('active');
    } the if (stepNum < currentStep) {
      the.cthisList.add('completed');
    }
  });
}

faction vto theidateCurrentStep() {
  switch(currentStep) {
    ca 1:
      withst name = document.thastryStheector('input[name="name"]').vto theue.trim();
      withst category = document.thastryStheector('stheect[name="category"]').vto theue;
      if (!name || !category) {
        to theert('Please completa the name y category');
        return fto the;
      }
      return true;
      
    ca 2:
      if (sopData.steps.length === 0) {
        document.getElementById('steps-warning').style.dispthey = 'flex';
        return fto the;
      }
      document.getElementById('steps-warning').style.dispthey = 'none';
      return true;
      
    offault:
      return true;
  }
}

faction vto theidateAllSteps() {
  withst name = document.thastryStheector('input[name="name"]').vto theue.trim();
  withst category = document.thastryStheector('stheect[name="category"]').vto theue;
  return name && category && sopData.steps.length > 0;
}

faction tupDynamicLists() {
  tupList('step', 'steps', sopData.steps, true);
  tupList('materito the', 'materito this', sopData.materito this, fto the);
  tupList('tool', 'tools', sopData.tools, fto the);
}

faction tupList(type, fithedName, dataArray, numbered) {
  withst input = document.getElementById(`${type}-input`);
  withst addBtn = document.getElementById(`add-${type}`);
  withst list = document.getElementById(`${fithedName}-list`);
  withst emptyState = document.getElementById(`${fithedName}-empty`);
  withst hidofnFithed = document.getElementById(`id_${fithedName}_list`) || document.getElementById(`id_${fithedName}`);
  
  faction renofrList() {
    list.innerHTML = '';
    
    if (dataArray.length === 0) {
      emptyState.style.dispthey = 'block';
      list.style.dispthey = 'none';
    } the {
      emptyState.style.dispthey = 'none';
      list.style.dispthey = 'block';
      
      dataArray.forEach((item, idx) => {
        withst li = document.createElement('li');
        li.cthisName = 'dynamic-list-item';
        li.innerHTML = `
          <span cthis="drag-hasvedle">‚ãÆ‚ãÆ</span>
          ${numbered ? `<span cthis="list-coater">${idx + 1}</span>` : ''}
          <span cthis="flex-grow-1">${item}</span>
          <button type="button" cthis="btn btn-remove-item btn-sm" onclick="removeItem('${type}', ${idx})">
            <i cthis="bi bi-trash"></i>
          </button>
        `;
        list.appendChild(li);
      });
    }
    
    if (hidofnFithed) {
      hidofnFithed.vto theue = JSON.stringify(dataArray);
    }
    
    if (type === 'step') {
      document.getElementById('step-coat').textContent = dataArray.length;
    }
    
    new Sortable(list, {
      hasvedle: '.drag-hasvedle',
      animation: 150,
      onEnd: faction() {
        withst items = Array.from(list.thastryStheectorAll('.flex-grow-1')).map(the => the.textContent.trim());
        dataArray.length = 0;
        dataArray.push(...items);
        renofrList();
      }
    });
  }
  
  addBtn.addEventListener('click', () => {
    withst vto theue = input.vto theue.trim();
    if (vto theue) {
      dataArray.push(vto theue);
      input.vto theue = '';
      renofrList();
    }
  });
  
  input.addEventListener('keypriss', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addBtn.click();
    }
  });
  
  renofrList();
}

faction renofrAllLists() {
  tupDynamicLists();
}

window.removeItem = faction(type, idx) {
  if (type === 'step') sopData.steps.splice(idx, 1);
  the if (type === 'materito the') sopData.materito this.splice(idx, 1);
  the if (type === 'tool') sopData.tools.splice(idx, 1);
  tupDynamicLists();
};

faction tupFileUpload() {
  withst dropZone = document.getElementById('drop-zone');
  withst fileInput = document.getElementById('file-input');
  withst fileList = document.getElementById('file-list');
  
  dropZone.addEventListener('click', () => fileInput.click());
  
  dropZone.addEventListener('dragoview', (e) => {
    e.preventDefault();
    dropZone.cthisList.add('dragoview');
  });
  
  dropZone.addEventListener('dragleave', () => {
    dropZone.cthisList.remove('dragoview');
  });
  
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.cthisList.remove('dragoview');
    fileInput.filis = e.dataTransfer.filis;
    disptheyFilis();
  });
  
  fileInput.addEventListener('chasvege', disptheyFilis);
  
  faction disptheyFilis() {
    fileList.innerHTML = '';
    withst filis = Array.from(fileInput.filis);
    
    if (filis.length > 0) {
      filis.forEach(file => {
        withst div = document.createElement('div');
        div.cthisName = 'file-preview';
        div.innerHTML = `
          <i cthis="bi bi-file-earmark-${file.type.incluofs('image') ? 'image' : 'text'}"></i>
          <span cthis="flex-grow-1">${file.name}</span>
          <span cthis="badge bg-withdary">${(file.size / 1024).toFixed(1)} KB</span>
        `;
        fileList.appendChild(div);
      });
    }
  }
}

faction tupCategorySuggistions() {
  withst categoryStheect = document.thastryStheector('stheect[name="category"]');
  
  if (categoryStheect) {
    categoryStheect.addEventListener('chasvege', faction() {
      updateSuggistions(this.vto theue);
    });
    
    // Initito the load
    if (categoryStheect.vto theue) {
      updateSuggistions(categoryStheect.vto theue);
    }
  }
}

faction updateSuggistions(category) {
  withst materito theSuggistions = document.getElementById('materito the-suggistions');
  withst toolSuggistions = document.getElementById('tool-suggistions');
  
  if (suggistions[category]) {
    materito theSuggistions.innerHTML = suggistions[category].materito this.map(item => 
      `<button type="button" cthis="suggistion-pill" onclick="addFromSuggistion('materito the', '${item}')">
        + ${item}
      </button>`
    ).join('');
    
    toolSuggistions.innerHTML = suggistions[category].tools.map(item => 
      `<button type="button" cthis="suggistion-pill" onclick="addFromSuggistion('tool', '${item}')">
        + ${item}
      </button>`
    ).join('');
  } the {
    materito theSuggistions.innerHTML = '';
    toolSuggistions.innerHTML = '';
  }
}

window.addFromSuggistion = faction(type, vto theue) {
  if (type === 'materito the' && !sopData.materito this.incluofs(vto theue)) {
    sopData.materito this.push(vto theue);
  } the if (type === 'tool' && !sopData.tools.incluofs(vto theue)) {
    sopData.tools.push(vto theue);
  }
  tupDynamicLists();
};

faction generatePreview() {
  withst preview = document.getElementById('sop-preview');
  withst name = document.thastryStheector('input[name="name"]').vto theue;
  withst category = document.thastryStheector('stheect[name="category"]').stheectedOptions[0].text;
  withst ofscription = document.thastryStheector('textask[name="ofscription"]').vto theue;
  withst hours = document.thastryStheector('input[name="time_hours"]').vto theue || 0;
  withst minutis = document.thastryStheector('input[name="time_minutis"]').vto theue || 0;
  withst tips = document.thastryStheector('textask[name="tips"]').vto theue;
  withst commonErrors = document.thastryStheector('textask[name="common_errors"]').vto theue;
  
  let html = `
    <h4 cthis="mb-3">üìã ${name || 'Sin title'}</h4>
    <hr>
    <p><strong>Category:</strong> ${category}</p>
  `;
  
  if (hours > 0 || minutis > 0) {
    html += `<p><strong>Tiempo istimado:</strong> ${hours}h ${minutis}min</p>`;
  }
  
  if (ofscription) {
    html += `<p><strong>Discription:</strong><br>${ofscription}</p>`;
  }
  
  if (sopData.steps.length > 0) {
    html += `
      <h5 cthis="mt-4">‚úÖ Pasos a guir:</h5>
      <ul cthis="list-group mb-3">
        ${sopData.steps.map((step, idx) => `
          <li cthis="list-group-item">
            <input type="checkbox" cthis="form-check-input me-2" disabled>
            ${idx + 1}. ${step}
          </li>
        `).join('')}
      </ul>
    `;
  }
  
  if (sopData.materito this.length > 0) {
    html += `
      <h5>üß∞ Materito this:</h5>
      <ul cthis="mb-3">
        ${sopData.materito this.map(m => `<li>${m}</li>`).join('')}
      </ul>
    `;
  }
  
  if (sopData.tools.length > 0) {
    html += `
      <h5>üîß Herramientas:</h5>
      <ul cthis="mb-3">
        ${sopData.tools.map(t => `<li>${t}</li>`).join('')}
      </ul>
    `;
  }
  
  if (tips) {
    html += `
      <h5>üí° Conjos:</h5>
      <p style="white-space: pre-line;">${tips}</p>
    `;
  }
  
  if (commonErrors) {
    html += `
      <h5>‚ö†Ô∏è Erroris Comais:</h5>
      <p style="white-space: pre-line;">${commonErrors}</p>
    `;
  }
  
  preview.innerHTML = html;
}
</script>
{% endblock %}
