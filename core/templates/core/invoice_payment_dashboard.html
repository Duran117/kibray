{% extends "core/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}Panel de Pagos - Facturas{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2>üí∞ Panel de Pagos de Facturas</h2>
            <p class="text-muted">Registra pagos de clientes (cheques, transferencias, etc.)</p>
        </div>
    </div>

    <!-- PENDING INVOICES -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üìã Facturas Pendientes de Pago ({{ pending_invoices.count }})</h5>
                </div>
                <div class="card-body">
                    {% if pending_invoices %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Factura #</th>
                                    <th>Proyecto</th>
                                    <th>Cliente</th>
                                    <th>Fecha Emisi√≥n</th>
                                    <th>Vencimiento</th>
                                    <th>Total</th>
                                    <th>Pagado</th>
                                    <th>Saldo</th>
                                    <th>Status</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invoice in pending_invoices %}
                                <tr class="{% if invoice.status == 'OVERDUE' %}table-danger{% elif invoice.status == 'PARTIAL' %}table-warning{% endif %}">
                                    <td><strong>{{ invoice.invoice_number }}</strong></td>
                                    <td>{{ invoice.project.name|truncatewords:5 }}</td>
                                    <td>{{ invoice.project.client|truncatewords:3 }}</td>
                                    <td>{{ invoice.date_issued|date:"M d, Y" }}</td>
                                    <td>{{ invoice.due_date|date:"M d, Y" }}</td>
                                    <td class="text-end">${{ invoice.total_amount|floatformat:2 }}</td>
                                    <td class="text-end text-success">${{ invoice.amount_paid|floatformat:2 }}</td>
                                    <td class="text-end"><strong>${{ invoice.balance_due|floatformat:2 }}</strong></td>
                                    <td><span class="badge bg-{{ invoice.status|lower }}" style="
                                        {% if invoice.status == 'SENT' %}background-color: #0d6efd !important;{% endif %}
                                        {% if invoice.status == 'PARTIAL' %}background-color: #ffc107 !important;{% endif %}
                                        {% if invoice.status == 'OVERDUE' %}background-color: #dc3545 !important;{% endif %}
                                        {% if invoice.status == 'APPROVED' %}background-color: #198754 !important;{% endif %}
                                    ">{{ invoice.get_status_display }}</span></td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#paymentModal{{ invoice.id }}">
                                            üíµ Registrar Pago
                                        </button>
                                        <a href="{% url 'invoice_detail' invoice.id %}" class="btn btn-sm btn-outline-secondary">Ver</a>
                                    </td>
                                </tr>
                                
                                <!-- Payment Modal -->
                                <div class="modal fade" id="paymentModal{{ invoice.id }}" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <form method="post" action="{% url 'record_invoice_payment' invoice.id %}">
                                                {% csrf_token %}
                                                <div class="modal-header bg-success text-white">
                                                    <h5 class="modal-title">üíµ Registrar Pago - {{ invoice.invoice_number }}</h5>
                                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p><strong>Saldo pendiente:</strong> ${{ invoice.balance_due|floatformat:2 }}</p>
                                                    <div class="mb-3">
                                                        <label class="form-label">Monto Recibido *</label>
                                                        <input type="number" step="0.01" name="amount" class="form-control" value="{{ invoice.balance_due }}" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Fecha de Pago *</label>
                                                        <input type="date" name="payment_date" class="form-control" value="{% now 'Y-m-d' %}" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">M√©todo de Pago *</label>
                                                        <select name="payment_method" class="form-select" required>
                                                            <option value="CHECK">Cheque</option>
                                                            <option value="TRANSFER">Transferencia</option>
                                                            <option value="CASH">Efectivo</option>
                                                            <option value="CARD">Tarjeta</option>
                                                            <option value="OTHER">Otro</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Referencia (Check #, Transfer ID, etc.)</label>
                                                        <input type="text" name="reference" class="form-control" placeholder="Ej: Check #12345">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Notas</label>
                                                        <textarea name="notes" class="form-control" rows="2"></textarea>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                    <button type="submit" class="btn btn-success">‚úÖ Registrar Pago</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">‚úÖ No hay facturas pendientes de pago.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- RECENTLY PAID -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">‚úÖ Pagadas Recientemente (√∫ltimas 10)</h5>
                </div>
                <div class="card-body">
                    {% if recently_paid %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Factura #</th>
                                    <th>Proyecto</th>
                                    <th>Cliente</th>
                                    <th>Total</th>
                                    <th>Fecha Pago</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invoice in recently_paid %}
                                <tr>
                                    <td>{{ invoice.invoice_number }}</td>
                                    <td>{{ invoice.project.name|truncatewords:5 }}</td>
                                    <td>{{ invoice.project.client|truncatewords:3 }}</td>
                                    <td>${{ invoice.total_amount|floatformat:2 }}</td>
                                    <td>{{ invoice.paid_date|date:"M d, Y" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No hay facturas pagadas recientemente.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="{% url 'invoice_list' %}" class="btn btn-outline-primary">üìã Ver Todas las Facturas</a>
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">üè† Dashboard</a>
    </div>
</div>
{% endblock %}
