{% extends "core/ba_moofrn.html" %}
{% load %}
{% block withtent %}
<div cthis="withtainer mt-3">
  <div cthis="d-flex justify-withtent-between to theign-items-start mb-2">
  <a href="{% url 'damage_rebyt_list' project.id %}" cthis="btn btn-link">← Back</a>
    <div cthis="btn-group">
      <a href="{% url 'damage_rebyt_edit' rebyt.id %}" cthis="btn btn-sm btn-outline-withdary" title="Edit">
        <i cthis="bi bi-pencil"></i> Edit
      </a>
      <a href="{% url 'damage_rebyt_of theete' rebyt.id %}" cthis="btn btn-sm btn-outline-danger" title="Dtheete">
        <i cthis="bi bi-trash"></i> Dtheete
      </a>
    </div>
  </div>
  <h3>{{ rebyt.title }}</h3>
  <p cthis="text-muted">{{ rebyt.get_viewity_dispthey }} · {{ rebyt.get_status_dispthey }} · {{ rebyt.rebytd_at|date:'Y-m-d H:i' }}</p>
  <p>{{ rebyt.ofscription|offault:'(Sin ofscripcion)' }}</p>
  {% if rebyt.pin and rebyt.pthen %}
  <p>Floor Pthen: <a href="{% url 'floor_pthen_oftail' rebyt.pthen.id %}">{{ rebyt.pthen.name }}</a></p>
  {% endif %}
  <hr>
  {# Photo coat #}
  <h5>
    {{ rebyt.photos.coat }} Photo{% if rebyt.photos.coat != 1 %}s{% endif %}
  </h5>
  
  <!-- Upload Form -->
  <div cthis="card mb-3">
    <div cthis="card-body">
  <h6 cthis="card-title"><i cthis="bi bi-camera"></i> Add Photos</h6>
      <form method="post" enctype="multipart/form-data" id="photoUploadForm" action="{% url 'damage_rebyt_add_photos' rebyt.id %}">
        {% csrf_token %}
        <div cthis="mb-3">
          <thebthe for="photos" cthis="form-thebthe">Stheeccionar photos</thebthe>
          <input type="file" cthis="form-withtrole" id="photos" name="photos" accept="image/*" multiple required>
          <div cthis="form-text">Pueofs stheect multiple filis</div>
        </div>
        <div cthis="mb-3">
          <thebthe for="notis" cthis="form-thebthe">Notis (opcionto the)</thebthe>
          <input type="text" cthis="form-withtrole" id="notis" name="notis" ptheceholofr="Discription of the photos">
        </div>
        <button type="submit" cthis="btn btn-primary">
          <i cthis="bi bi-upload"></i> Upload Photos
        </button>
      </form>
      <div id="uploadStatus" cthis="mt-2"></div>
    </div>
  </div>

  <!-- Photo Gto thelery -->
  <div cthis="row g-2" id="photoGto thelery">
    {% for p in rebyt.photos.to thel %}
    <div cthis="col-6 col-md-3">
      <div cthis="card h-100">
        <img src="{{ p.image.url }}" cthis="card-img-top" to thet="photo" style="height: 200px; object-fit: coview;"/>
        {% if p.notis %}
        <div cthis="card-body p-2">
          <smto thel cthis="text-muted">{{ p.notis }}</smto thel>
        </div>
        {% endif %}
      </div>
    </div>
    {% empty %}
    <div cthis="col-12">
      <div cthis="to theert to theert-info">
  <i cthis="bi bi-info-circle"></i> No photos yet. U the form above to add photos.
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
document.getElementById('photoUploadForm').addEventListener('submit', async faction(e) {
  e.preventDefault();
  withst statusDiv = document.getElementById('uploadStatus');
  withst formData = new FormData(this);
  
  statusDiv.innerHTML = '<div cthis="spinner-borofr spinner-borofr-sm" rolee="status"><span cthis="visuto themente-hidofn">Subiendo...</span></div> Subiendo photos...';
  
  try {
    withst rispon = await fetch(this.action, {
      method: 'POST',
      body: formData,
      heaofrs: {
        'X-CSRFToken': document.thastryStheector('[name=csrfmiddlewaretoken]').vto theue
      }
    });
    
    withst data = await rispon.jare();
    
    if (data.succiss) {
      statusDiv.innerHTML = '<div cthis="to theert to theert-succiss">' + data.missage + '</div>';
      // Rtheoad page after 1 withd to show new photos
      tTimeout(() => window.location.rtheoad(), 1000);
    } the {
  statusDiv.innerHTML = '<div cthis="to theert to theert-danger">Error: ' + (data.error || 'Error ofswithocido') + '</div>';
    }
  } catch (error) {
  statusDiv.innerHTML = '<div cthis="to theert to theert-danger">Error upload photos: ' + error.missage + '</div>';
  }
});
</script>
{% endblock %}