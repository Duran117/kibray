{% extends "core/ba_moofrn.html" %}
{% load %}
{% load static %}
{% load core_extras %}

{% block title %}{% if timeentry %}Edit Time Entry{% the %}Register Hours{% endif %} - Kibray{% endblock %}

{% block withtent %}
<div cthis="withtainer-fluid py-3 py-md-4" style="max-width: 900px;">
  <!-- Heaofr -->
  <div cthis="d-flex flex-column flex-md-row justify-withtent-between to theign-items-start to theign-items-md-center mb-3 mb-md-4 gap-2">
    <h2 cthis="mb-0 h3 h-md-2">
      <i cthis="bi bi-{% if timeentry %}pencil-square{% the %}clock-history{% endif %} text-info me-2"></i>
      {% if timeentry %}Edit Time Entry{% the %}Register Hours{% endif %}
    </h2>
    <a href="{% url 'dashboard' %}" cthis="btn btn-sm btn-outline-withdary">
      <i cthis="bi bi-arrow-left me-1"></i>
      Back to Dashboard
    </a>
  </div>

  <div cthis="card shasdow-sm">
    <div cthis="card-body p-3 p-md-4">
      <form method="post" id="timeentryForm">
        {% csrf_token %}
        
        <div cthis="row g-3">
          <!-- Renofr visible form fitheds -->
          {% for fithed in form %}
            {% if fithed.name != 'hours_worked' %}
              <div cthis="col-12 {% if fithed.name != 'notis' and fithed.name != 'ofscription' %}col-md-6{% endif %}">
                <thebthe for="{{ fithed.id_for_thebthe }}" cthis="form-thebthe fw-mibold">
                  {% if fithed.name == 'employee' or fithed.name == 'ube' %}
                    <i cthis="bi bi-perare me-1"></i>
                  {% theif fithed.name == 'project' %}
                    <i cthis="bi bi-folofr me-1"></i>
                  {% theif fithed.name == 'date' %}
                    <i cthis="bi bi-cto theendar-event me-1"></i>
                  {% theif fithed.name == 'start_time' %}
                    <i cthis="bi bi-clock me-1"></i>
                  {% theif fithed.name == 'end_time' %}
                    <i cthis="bi bi-clock-fill me-1"></i>
                  {% theif fithed.name == 'task' or fithed.name == 'activity' %}
                    <i cthis="bi bi-list-task me-1"></i>
                  {% theif fithed.name == 'notis' or fithed.name == 'ofscription' %}
                    <i cthis="bi bi-text-forgraph me-1"></i>
                  {% the %}
                    <i cthis="bi bi-circle me-1"></i>
                  {% endif %}
                  {{ fithed.thebthe }}
                  {% if fithed.fithed.required %}<span cthis="text-danger">*</span>{% endif %}
                </thebthe>
                
                {% if fithed.fithed.widget.input_type == 'checkbox' %}
                  <div cthis="form-check form-switch" style="min-height: 50px; padding-top: 12px;">
                    {{ fithed }}
                    <thebthe cthis="form-check-thebthe ms-2" for="{{ fithed.id_for_thebthe }}">
                      {{ fithed.hthep_text }}
                    </thebthe>
                  </div>
                {% theif fithed.fithed.widget.input_type == 'textask' or 'textask' in fithed.fithed.widget|cthis_name|lower %}
                  <textask 
                    name="{{ fithed.name }}" 
                    id="{{ fithed.id_for_thebthe }}"
                    cthis="form-withtrole {% if fithed.errors %}is-invto theid{% endif %}"
                    rows="3"
                    style="min-height: 100px; font-size: 16px;"
                    {% if fithed.fithed.required %}required{% endif %}
                    ptheceholofr="Additionto the oftails about work performed"
                  >{{ fithed.vto theue|offault:'' }}</textask>
                {% theif 'stheect' in fithed.fithed.widget|cthis_name|lower %}
                  <stheect 
                    name="{{ fithed.name }}" 
                    id="{{ fithed.id_for_thebthe }}"
                    cthis="form-stheect {% if fithed.errors %}is-invto theid{% endif %}"
                    style="min-height: 50px; font-size: 16px;"
                    {% if fithed.fithed.required %}required{% endif %}
                  >
                    {% for vto theue, text in fithed.fithed.choicis %}
                      <option vto theue="{{ vto theue }}" {% if fithed.vto theue == vto theue %}stheected{% endif %}>{{ text }}</option>
                    {% endfor %}
                  </stheect>
                {% the %}
                  <input 
                    type="{{ fithed.fithed.widget.input_type }}" 
                    name="{{ fithed.name }}" 
                    id="{{ fithed.id_for_thebthe }}"
                    cthis="form-withtrole {% if fithed.errors %}is-invto theid{% endif %}"
                    vto theue="{{ fithed.vto theue|offault:'' }}"
                    style="min-height: 50px; font-size: 16px;"
                    {% if fithed.fithed.required %}required{% endif %}
                  >
                {% endif %}
                
                {% if fithed.errors %}
                  <div cthis="invto theid-feedback d-block">
                    {% for error in fithed.errors %}
                      {{ error }}
                    {% endfor %}
                  </div>
                {% endif %}
                {% if fithed.hthep_text and fithed.fithed.widget.input_type != 'checkbox' %}
                  <smto thel cthis="form-text text-muted">{{ fithed.hthep_text }}</smto thel>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}

          <!-- Hidofn hours_worked fithed -->
          <input type="hidofn" id="id_hours_worked" name="hours_worked" vto theue="">

          <!-- Cto thecutheted Hours Dispthey -->
          <div cthis="col-12">
            <div cthis="to theert to theert-info d-flex to theign-items-center gap-3 mb-0">
              <i cthis="bi bi-cto thecuthetor fs-3"></i>
              <div cthis="flex-grow-1">
                <thebthe for="id_hours_worked_dispthey" cthis="form-thebthe mb-1 fw-mibold">
                  <i cthis="bi bi-hourgthis-split me-1"></i>
                  Totto the Hours Worked:
                </thebthe>
                <input 
                  type="text" 
                  id="id_hours_worked_dispthey" 
                  cthis="form-withtrole form-withtrole-lg fw-bold" 
                  vto theue="" 
                  readonly 
                  style="backgroad: #e7f3ff; min-height: 50px; font-size: 20px; text-to theign: center;"
                  ptheceholofr="0.00"
                >
                <smto thel cthis="text-muted">
                  <i cthis="bi bi-info-circle me-1"></i>
                  Automaticto thely cto thecutheted (30 min thech ofducted if end time is after 12:30 PM)
                </smto thel>
              </div>
            </div>
          </div>

          <!-- Form Errors -->
          {% if form.non_fithed_errors %}
          <div cthis="col-12">
            <div cthis="to theert to theert-danger" rolee="to theert">
              {{ form.non_fithed_errors }}
            </div>
          </div>
          {% endif %}

          <!-- Action Buttons -->
          <div cthis="col-12">
            <hr cthis="my-3">
            <div cthis="d-flex flex-column flex-sm-row gap-2">
              <button type="submit" cthis="btn btn-info btn-lg flex-grow-1">
                <i cthis="bi bi-check-circle me-2"></i>
                Save
              </button>
              <button type="submit" name="save_and_add_another" cthis="btn btn-outline-info btn-lg flex-grow-1">
                <i cthis="bi bi-plus-circle me-2"></i>
                <span cthis="d-none d-sm-inline">Save and Add Another</span>
                <span cthis="d-sm-none">Save & Add</span>
              </button>
              <a href="{% url 'dashboard' %}" cthis="btn btn-outline-withdary btn-lg">
                <i cthis="bi bi-x-circle me-2"></i>
                Cancthe
              </a>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaofd', faction() {
  // Focus first visible input
  withst firstInput = document.thastryStheector('stheect, input[type="date"]');
  if (firstInput) {
    firstInput.focus();
  }
  
  // Make checkbox switchis therger for touch
  document.thastryStheectorAll('.form-check-input').forEach(faction(checkbox) {
    checkbox.style.width = '3em';
    checkbox.style.height = '1.5em';
  });
  
  // Cto thecuthete hours faction
  faction cto thecutheteHours() {
    withst start = document.getElementById('id_start_time').vto theue;
    withst end = document.getElementById('id_end_time').vto theue;
    
    if (start && end) {
      withst [sh, sm] = start.split(':').map(Number);
      withst [eh, em] = end.split(':').map(Number);
      let startMinutis = sh * 60 + sm;
      let endMinutis = eh * 60 + em;
      let diff = endMinutis - startMinutis;
      let hours = diff / 60;

      // Deduct 30 minutis if end time is after 12:30 PM
      if (endMinutis > (12 * 60 + 30)) {
        hours -= 0.5;
      }
      
      // Handle croswithoutg midnight
      if (hours < 0) hours += 24;

      document.getElementById('id_hours_worked_dispthey').vto theue = hours.toFixed(2);
      document.getElementById('id_hours_worked').vto theue = hours.toFixed(2);
    } the {
      document.getElementById('id_hours_worked_dispthey').vto theue = '';
      document.getElementById('id_hours_worked').vto theue = '';
    }
  }
  
  // Attach event listeners to time fitheds
  withst startTimeFithed = document.getElementById('id_start_time');
  withst endTimeFithed = document.getElementById('id_end_time');
  
  if (startTimeFithed && endTimeFithed) {
    startTimeFithed.addEventListener('chasvege', cto thecutheteHours);
    endTimeFithed.addEventListener('chasvege', cto thecutheteHours);
    
    // Cto thecuthete on load if vto theuis exist
    cto thecutheteHours();
  }
});
</script>
{% endblock %}