{% extends "core/base_modern.html" %}
{% load static i18n humanize currency_extras %}

{% block title %}{{ project.name }} - {% trans "Project Overview" %}{% endblock %}

{% block extra_css %}
<style>
    .project-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 30px;
        color: white;
        margin-bottom: 25px;
    }
    .project-header h1 { margin: 0 0 10px 0; font-weight: 700; }
    .project-header .project-address { opacity: 0.9; font-size: 1.1rem; }
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        height: 100%;
        transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-3px); }
    .stat-card .stat-icon {
        width: 50px; height: 50px;
        border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem; margin-bottom: 15px;
    }
    .stat-card .stat-value { font-size: 1.8rem; font-weight: 700; color: #2c3e50; }
    .stat-card .stat-label { color: #7f8c8d; font-size: 0.9rem; }
    .section-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
        margin-bottom: 25px;
    }
    .section-card .card-header {
        background: transparent;
        border-bottom: 1px solid #eee;
        padding: 20px;
        font-weight: 600;
        color: #2c3e50;
    }
    .section-card .card-body { padding: 20px; }
    .progress-section { margin-bottom: 20px; }
    .progress-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
    .progress { height: 12px; border-radius: 6px; background: #e9ecef; }
    .progress-bar { border-radius: 6px; }
    .list-item {
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.2s;
    }
    .list-item:hover { border-color: #667eea; background: #f8f9ff; }
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d4edda; color: #155724; }
    .status-completed { background: #d4edda; color: #155724; }
    .status-in-progress { background: #cce5ff; color: #004085; }
    .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
    .photo-item {
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .photo-item:hover { transform: scale(1.05); }
    .photo-item img { width: 100%; height: 100%; object-fit: cover; }
    .schedule-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
    .schedule-item:last-child { border-bottom: none; }
    .schedule-date { min-width: 80px; font-weight: 600; color: #667eea; font-size: 0.9rem; }
    .btn-action {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white; border: none;
        padding: 8px 16px; border-radius: 8px;
        font-weight: 600; transition: all 0.2s;
    }
    .btn-action:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); color: white; }
    .empty-state { text-align: center; padding: 30px; color: #7f8c8d; }
    .empty-state i { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.5; }
    .financial-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .financial-row:last-child { border-bottom: none; font-weight: 700; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard_client' %}?project_id={{ project.id }}">{% trans "My Projects" %}</a></li>
            <li class="breadcrumb-item active">{{ project.name }}</li>
        </ol>
    </nav>
    
    <!-- Project Header -->
    <div class="project-header">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1>{{ project.name }}</h1>
                {% if project.address %}
                    <p class="project-address mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>{{ project.address }}
                    </p>
                {% endif %}
            </div>
            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                {% if project.status %}
                    <span class="badge bg-light text-dark fs-6">
                        <i class="fas fa-circle text-success me-1"></i>{{ project.get_status_display }}
                    </span>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Stats Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-6 col-lg-3">
            <div class="stat-card">
                <div class="stat-icon" style="background: #e8f5e9; color: #27ae60;">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="stat-value">{{ progress_pct }}%</div>
                <div class="stat-label">{% trans "Progress" %}</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="stat-card">
                <div class="stat-icon" style="background: #e3f2fd; color: #3498db;">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="stat-value">{{ pending_tasks.count }}</div>
                <div class="stat-label">{% trans "Pending Tasks" %}</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="stat-card">
                <div class="stat-icon" style="background: #fff3e0; color: #f39c12;">
                    <i class="fas fa-images"></i>
                </div>
                <div class="stat-value">{{ recent_photos.count }}</div>
                <div class="stat-label">{% trans "Photos" %}</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3">
            <div class="stat-card">
                <div class="stat-icon" style="background: #fce4ec; color: #e74c3c;">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-value">{{ upcoming_schedules|length }}</div>
                <div class="stat-label">{% trans "Upcoming Events" %}</div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Progress Section -->
            <div class="section-card">
                <div class="card-header">
                    <i class="fas fa-chart-line me-2"></i>{% trans "Project Progress" %}
                </div>
                <div class="card-body">
                    <div class="progress-section">
                        <div class="progress-label">
                            <span>{% trans "Overall Completion" %}</span>
                            <span class="fw-bold">{{ progress_pct }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ progress_pct }}%"></div>
                        </div>
                    </div>
                    {% if gantt_progress.completed_items or gantt_progress.total_items %}
                        <div class="mt-3">
                            <small class="text-muted">
                                {{ gantt_progress.completed_items|default:0 }} {% trans "of" %} 
                                {{ gantt_progress.total_items|default:0 }} {% trans "items completed" %}
                            </small>
                        </div>
                    {% endif %}
                    {% if project.start_date or project.end_date %}
                        <div class="row mt-4">
                            {% if project.start_date %}
                                <div class="col-6">
                                    <small class="text-muted">{% trans "Start Date" %}</small>
                                    <p class="mb-0 fw-bold">{{ project.start_date|date:"M d, Y" }}</p>
                                </div>
                            {% endif %}
                            {% if project.end_date %}
                                <div class="col-6">
                                    <small class="text-muted">{% trans "Expected End" %}</small>
                                    <p class="mb-0 fw-bold">{{ project.end_date|date:"M d, Y" }}</p>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Pending Requests Section -->
            {% if pending_requests %}
            <div class="section-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-inbox me-2"></i>{% trans "My Requests" %}</span>
                    <span class="badge bg-warning text-dark">{{ pending_requests.count }} {% trans "pending" %}</span>
                </div>
                <div class="card-body">
                    {% for req in pending_requests %}
                        <div class="list-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ req.title }}</h6>
                                    <small class="text-muted">{{ req.created_at|date:"M d, Y" }}</small>
                                </div>
                                <span class="status-badge status-pending">{% trans "Pending" %}</span>
                            </div>
                            {% if req.description %}
                                <p class="mb-0 mt-2 text-muted small">{{ req.description|truncatewords:20 }}</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Tasks Section -->
            <div class="section-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-tasks me-2"></i>{% trans "Tasks & Touch-ups" %}</span>
                    {% if pending_tasks %}
                        <span class="badge bg-primary">{{ pending_tasks.count }} {% trans "active" %}</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if pending_tasks %}
                        {% for task in pending_tasks|slice:":5" %}
                            <div class="list-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ task.title }}</h6>
                                        <small class="text-muted">
                                            {% if task.assigned_to %}
                                                <i class="fas fa-user me-1"></i>{{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                                            {% endif %}
                                        </small>
                                    </div>
                                    <span class="status-badge {% if task.status == 'In Progress' or task.status == 'En Progreso' %}status-in-progress{% else %}status-pending{% endif %}">
                                        {{ task.get_status_display|default:task.status }}
                                    </span>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <p>{% trans "No pending tasks" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Recent Photos -->
            <div class="section-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-camera me-2"></i>{% trans "Recent Photos" %}</span>
                </div>
                <div class="card-body">
                    {% if recent_photos %}
                        <div class="photo-grid">
                            {% for photo in recent_photos|slice:":8" %}
                                <div class="photo-item" data-bs-toggle="modal" data-bs-target="#photoModal" 
                                     data-photo-url="{{ photo.image.url }}" data-photo-desc="{{ photo.description|default:'' }}">
                                    <img src="{{ photo.image.url }}" alt="{{ photo.description|default:'Photo' }}">
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-images"></i>
                            <p>{% trans "No photos yet" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="section-card">
                <div class="card-header">
                    <i class="fas fa-bolt me-2"></i>{% trans "Quick Actions" %}
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'client_project_calendar' project.pk %}" class="btn btn-action">
                            <i class="fas fa-calendar me-2"></i>{% trans "View Calendar" %}
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Upcoming Schedule -->
            <div class="section-card">
                <div class="card-header">
                    <i class="fas fa-calendar-alt me-2"></i>{% trans "Upcoming Schedule" %}
                </div>
                <div class="card-body">
                    {% if upcoming_schedules %}
                        {% for schedule in upcoming_schedules %}
                            <div class="schedule-item">
                                <div class="schedule-date">
                                    {{ schedule.start_datetime|date:"M d" }}
                                </div>
                                <div>
                                    <div class="fw-bold">{{ schedule.title }}</div>
                                    {% if schedule.status %}
                                    <small class="text-muted">
                                        {% if schedule.status == 'done' %}✓ {% trans "Completed" %}
                                        {% elif schedule.status == 'in_progress' %}↻ {% trans "In Progress" %}
                                        {% else %}○ {% trans "Upcoming" %}{% endif %}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-calendar-check"></i>
                            <p>{% trans "No upcoming events" %}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Contract Breakdown: Quoted vs CO vs Billed -->
            <div class="section-card">
                <div class="card-header">
                    <i class="fas fa-file-contract me-2"></i>{% trans "Contract Breakdown" %}
                </div>
                <div class="card-body p-0">
                    <!-- Visual Progress Bar -->
                    <div class="p-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">{% trans "Payment Progress" %}</small>
                            <small class="fw-bold">
                                {% widthratio total_paid total_contract_value 100 as paid_pct %}
                                {{ paid_pct|default:0 }}% {% trans "Paid" %}
                            </small>
                        </div>
                        <div class="progress" style="height: 12px; border-radius: 6px;">
                            {% if total_contract_value > 0 %}
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {% widthratio total_paid total_contract_value 100 %}%;" 
                                 title="{% trans 'Paid' %}"></div>
                            <div class="progress-bar bg-info" role="progressbar" 
                                 style="width: {% widthratio total_invoiced|add:total_paid|add:0 total_contract_value 100 %}%;"
                                 title="{% trans 'Invoiced (Unpaid)' %}"></div>
                            {% else %}
                            <div class="progress-bar bg-secondary" style="width: 100%"></div>
                            {% endif %}
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-success">■ {% trans "Paid" %}</small>
                            <small class="text-info">■ {% trans "Invoiced" %}</small>
                            <small class="text-secondary">■ {% trans "Remaining" %}</small>
                        </div>
                    </div>
                    
                    <!-- Base Contract -->
                    <div class="p-3 border-bottom bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-file-alt text-primary me-2"></i>
                                <strong>{% trans "Base Contract" %}</strong>
                                {% if latest_estimate %}
                                <span class="badge bg-primary ms-2">v{{ latest_estimate.version }}</span>
                                {% endif %}
                            </div>
                            <span class="fw-bold text-primary">{{ base_contract_total|default:0|currency }}</span>
                        </div>
                        {% if latest_estimate %}
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-check-circle text-success me-1"></i>{% trans "Approved Estimate" %}
                        </small>
                        {% else %}
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-info-circle me-1"></i>{% trans "No approved estimate yet" %}
                        </small>
                        {% endif %}
                    </div>
                    
                    <!-- Approved Change Orders -->
                    <div class="p-3 border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-plus-circle text-success me-2"></i>
                                <strong>{% trans "Approved Change Orders" %}</strong>
                                {% if approved_cos %}
                                <span class="badge bg-success ms-2">{{ approved_cos|length }}</span>
                                {% endif %}
                            </div>
                            <span class="fw-bold text-success">+{{ approved_cos_total|default:0|currency }}</span>
                        </div>
                        {% if approved_cos %}
                        <div class="mt-2">
                            {% for co in approved_cos|slice:":3" %}
                            <a href="{% url 'changeorder_detail' co.id %}" class="d-block small text-decoration-none py-1">
                                <span class="text-muted">#{{ co.id }}</span> {{ co.description|truncatewords:6 }}
                                <span class="float-end">{{ co.amount|currency }}</span>
                            </a>
                            {% endfor %}
                            {% if approved_cos|length > 3 %}
                            <small class="text-muted">+{{ approved_cos|length|add:"-3" }} {% trans "more" %}...</small>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Pending Change Orders -->
                    {% if pending_cos %}
                    <div class="p-3 border-bottom" style="background: #fff9e6;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-clock text-warning me-2"></i>
                                <strong>{% trans "Pending Approval" %}</strong>
                                <span class="badge bg-warning text-dark ms-2">{{ pending_cos|length }}</span>
                            </div>
                            <span class="fw-bold text-warning">{{ pending_cos_total|default:0|currency }}</span>
                        </div>
                        <div class="mt-2">
                            {% for co in pending_cos|slice:":2" %}
                            <a href="{% url 'changeorder_detail' co.id %}" class="d-block small text-decoration-none py-1">
                                <span class="text-muted">#{{ co.id }}</span> {{ co.description|truncatewords:6 }}
                                <span class="float-end">{{ co.amount|currency }}</span>
                            </a>
                            {% endfor %}
                        </div>
                        <small class="text-warning d-block mt-1">
                            <i class="fas fa-pen me-1"></i>{% trans "Awaiting your signature" %}
                        </small>
                    </div>
                    {% endif %}
                    
                    <!-- Total Contract Value -->
                    <div class="p-3 bg-dark text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>{% trans "Total Contract Value" %}</strong>
                            <span class="fs-5 fw-bold">{{ total_contract_value|default:0|currency }}</span>
                        </div>
                        <small class="text-white-50">{% trans "Base Contract + Approved COs" %}</small>
                    </div>
                </div>
            </div>
            
            <!-- Invoice Summary -->
            {% if invoices %}
            <div class="section-card">
                <div class="card-header">
                    <i class="fas fa-file-invoice-dollar me-2"></i>{% trans "Invoice Summary" %}
                </div>
                <div class="card-body">
                    <div class="financial-row">
                        <span>{% trans "Total Invoiced" %}</span>
                        <span>{{ total_invoiced|currency }}</span>
                    </div>
                    <div class="financial-row">
                        <span>{% trans "Total Paid" %}</span>
                        <span class="text-success">{{ total_paid|currency }}</span>
                    </div>
                    <div class="financial-row">
                        <span>{% trans "Balance Due" %}</span>
                        <span class="{% if balance > 0 %}text-danger{% else %}text-success{% endif %}">{{ balance|currency }}</span>
                    </div>
                    
                    <hr>
                    <h6 class="mb-2">{% trans "Recent Invoices" %}</h6>
                    {% for inv in invoices|slice:":3" %}
                    <div class="d-flex justify-content-between small py-1">
                        <span>{{ inv.invoice_number|default:inv.id }}</span>
                        <span>{{ inv.total_amount|currency }}</span>
                        <span class="badge {% if inv.status == 'PAID' %}bg-success{% elif inv.status == 'SENT' %}bg-info{% else %}bg-secondary{% endif %}">
                            {{ inv.get_status_display|default:inv.status }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Color Samples -->
            {% if color_samples %}
            <div class="section-card">
                <div class="card-header">
                    <i class="fas fa-palette me-2"></i>{% trans "Color Samples" %}
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        {% for sample in color_samples %}
                            <div class="col-6">
                                <div class="p-2 border rounded">
                                    {% if sample.color_code %}
                                        <div style="width: 100%; height: 40px; background: {{ sample.color_code }}; border-radius: 4px;"></div>
                                    {% endif %}
                                    <small class="d-block mt-1">{{ sample.name|truncatewords:3 }}</small>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Project Minutes -->
            {% if project_minutes %}
            <div class="section-card">
                <div class="card-header">
                    <i class="fas fa-clipboard-list me-2"></i>{% trans "Recent Updates" %}
                </div>
                <div class="card-body">
                    {% for minute in project_minutes|slice:":5" %}
                        <div class="mb-3 pb-3 border-bottom">
                            <small class="text-muted">{{ minute.event_date|date:"M d, Y" }}</small>
                            <p class="mb-0">{{ minute.content|truncatewords:15 }}</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Project Info -->
            <div class="section-card">
                <div class="card-header">
                    <i class="fas fa-info-circle me-2"></i>{% trans "Project Details" %}
                </div>
                <div class="card-body">
                    {% if project.description %}
                        <p class="text-muted small">{{ project.description|truncatewords:30 }}</p>
                    {% endif %}
                    <ul class="list-unstyled mb-0 small">
                        {% if project.project_manager %}
                            <li class="mb-2">
                                <span class="text-muted">{% trans "Project Manager" %}:</span><br>
                                <span class="fw-bold">{{ project.project_manager.get_full_name|default:project.project_manager.username }}</span>
                            </li>
                        {% endif %}
                        {% if project.company %}
                            <li class="mb-2">
                                <span class="text-muted">{% trans "Company" %}:</span><br>
                                <span class="fw-bold">{{ project.company.name }}</span>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body p-0 position-relative">
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3 bg-white rounded-circle p-2" 
                        data-bs-dismiss="modal"></button>
                <img src="" id="modalPhoto" class="img-fluid w-100" alt="Photo">
                <div id="modalPhotoDesc" class="p-3 bg-light"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const photoModal = document.getElementById('photoModal');
    if (photoModal) {
        photoModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const photoUrl = button.getAttribute('data-photo-url');
            const photoDesc = button.getAttribute('data-photo-desc');
            document.getElementById('modalPhoto').src = photoUrl;
            const descEl = document.getElementById('modalPhotoDesc');
            if (photoDesc) {
                descEl.textContent = photoDesc;
                descEl.style.display = 'block';
            } else {
                descEl.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}
