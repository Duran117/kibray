{% extends "core/base_modern.html" %}

{% block extra_css %}
<style>
    /* ===== MOBILE-FIRST MATERIALS WIZARD ===== */
    .materials-container {
        padding: 12px;
        background: #f8f9fa;
        min-height: 100vh;
    }
    
    @media (min-width: 768px) {
        .materials-container {
            padding: 24px;
        }
    }
    
    /* ===== HEADER ===== */
    .materials-header {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 20px 16px;
        border-radius: 12px 12px 0 0;
        margin-bottom: 0;
    }
    
    .materials-header h1 {
        font-size: 20px;
        margin: 0 0 4px 0;
        font-weight: 700;
    }
    
    .materials-header .project {
        font-size: 14px;
        opacity: 0.9;
    }
    
    /* ===== WIZARD PROGRESS ===== */
    .wizard-progress {
        background: white;
        padding: 16px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .step-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
        z-index: 1;
    }
    
    .step-indicator:not(:last-child)::after {
        content: '';
        position: absolute;
        top: 12px;
        left: 50%;
        width: 100%;
        height: 2px;
        background: #e5e7eb;
        z-index: -1;
    }
    
    .step-indicator.active:not(:last-child)::after {
        background: #f59e0b;
    }
    
    .step-circle {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #e5e7eb;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        margin-bottom: 4px;
        transition: all 0.3s ease;
    }
    
    .step-indicator.active .step-circle {
        background: #f59e0b;
        color: white;
        transform: scale(1.1);
    }
    
    .step-label {
        font-size: 10px;
        color: #6b7280;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .step-indicator.active .step-label {
        color: #f59e0b;
    }
    
    /* ===== FORM CARD ===== */
    .materials-form {
        background: white;
        border-radius: 0 0 12px 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* ===== WIZARD STEPS ===== */
    .wizard-step {
        display: none;
        animation: fadeIn 0.3s ease;
    }
    
    .wizard-step.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* ===== FORM INPUTS (LARGE FOR MOBILE) ===== */
    .materials-form label {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
    }
    
    .materials-form select,
    .materials-form input,
    .materials-form textarea {
        height: 48px;
        font-size: 16px; /* Prevent iOS zoom */
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        transition: border-color 0.2s;
        width: 100%;
        padding: 8px 12px;
    }
    
    .materials-form textarea {
        height: 100px;
        resize: vertical;
    }
    
    .materials-form select:focus,
    .materials-form input:focus,
    .materials-form textarea:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
    }
    
    /* ===== PHOTO UPLOAD (PROMINENT) ===== */
    .photo-upload {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        padding: 30px 20px;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.2s;
        margin-bottom: 16px;
    }
    
    .photo-upload:active {
        transform: scale(0.98);
    }
    
    .photo-upload i {
        font-size: 48px;
        display: block;
        margin-bottom: 8px;
    }
    
    .photo-upload p {
        font-size: 18px;
        font-weight: 700;
        margin: 0;
    }
    
    .photo-preview {
        margin-top: 16px;
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .photo-preview img {
        width: 100%;
        height: auto;
        display: block;
    }
    
    .remove-photo {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    /* ===== QUANTITY CONTROLS ===== */
    .quantity-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .quantity-btn {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
        background: white;
        font-size: 24px;
        color: #374151;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    .quantity-btn:active {
        background: #f3f4f6;
    }
    
    /* ===== NAVIGATION BUTTONS ===== */
    .wizard-nav {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
    }
    
    .nav-btn {
        flex: 1;
        height: 48px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-next {
        background: #f59e0b;
        color: white;
    }
    
    .btn-next:hover {
        background: #d97706;
    }
    
    .btn-prev {
        background: white;
        border: 2px solid #e5e7eb;
        color: #6b7280;
    }
    
    .btn-submit {
        background: #10b981;
        color: white;
    }
    
    /* ===== ALERT MESSAGES ===== */
    .alert {
        border-radius: 8px;
        margin-bottom: 16px;
        padding: 12px 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="materials-container">
    <!-- Header -->
    <div class="materials-header">
        <h1><i class="bi bi-box-seam"></i> Solicitar Materiales</h1>
        <div class="project">
            <i class="bi bi-building"></i> {{ project.name }}
        </div>
    </div>
    
    <!-- Wizard Progress -->
    <div class="wizard-progress">
        <div class="step-indicator active" data-step="1">
            <div class="step-circle">1</div>
            <div class="step-label">Selección</div>
        </div>
        <div class="step-indicator" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">Detalles</div>
        </div>
        <div class="step-indicator" data-step="3">
            <div class="step-circle">3</div>
            <div class="step-label">Evidencia</div>
        </div>
        <div class="step-indicator" data-step="4">
            <div class="step-circle">4</div>
            <div class="step-label">Revisar</div>
        </div>
    </div>
    
    <!-- Form -->
    <form method="post" enctype="multipart/form-data" class="materials-form" id="materialsForm">
        {% csrf_token %}
        
        <!-- Messages -->
        {% for m in messages %}
        <div class="alert alert-{{ m.tags }}">{{ m }}</div>
        {% endfor %}
        
        <!-- STEP 1: SELECTION -->
        <div class="wizard-step active" id="step1">
            <h5 class="mb-3 text-muted">¿Qué necesitas?</h5>
            
            <!-- Quick Catalog Select -->
            <div class="mb-4">
                <label class="form-label">
                    <i class="bi bi-bookmark-star"></i> {{ form.catalog_item.label }}
                </label>
                {{ form.catalog_item }}
                <div class="form-text">Selecciona un material guardado o llena los campos manualmente</div>
            </div>
            
            <!-- Quick Shortcuts -->
            <div class="mb-3">
                <label class="form-label">Accesos Rápidos</label>
                <div class="row g-2">
                    <div class="col-6">
                        {{ form.approved_color }}
                    </div>
                    <div class="col-6">
                        {{ form.product_preset }}
                    </div>
                </div>
            </div>
            
            <!-- Category & Brand -->
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="form-label">{{ form.category.label }}</label>
                    {{ form.category }}
                </div>
                <div class="col-6">
                    <label class="form-label">{{ form.brand.label }}</label>
                    {{ form.brand }}
                </div>
            </div>
            
            <div class="mb-3" id="brand-other-wrap" style="display:none">
                <label class="form-label">{{ form.brand_other.label }}</label>
                {{ form.brand_other }}
            </div>
            
            <!-- Product Name -->
            <div class="mb-3">
                <label class="form-label">{{ form.product_name.label }}</label>
                {{ form.product_name }}
            </div>
            
            <div class="wizard-nav">
                <a class="nav-btn btn-prev" href="{% url 'dashboard_pm' %}">Cancelar</a>
                <button type="button" class="nav-btn btn-next" onclick="nextStep(2)">Siguiente <i class="bi bi-arrow-right"></i></button>
            </div>
        </div>
        
        <!-- STEP 2: DETAILS -->
        <div class="wizard-step" id="step2">
            <h5 class="mb-3 text-muted">Especificaciones</h5>
            
            <!-- Quantity (Large) -->
            <div class="mb-4">
                <label class="form-label">¿Cuánto necesitas?</label>
                <div class="quantity-group">
                    <button type="button" class="quantity-btn" onclick="adjustQuantity(-1)">−</button>
                    {{ form.quantity }}
                    <button type="button" class="quantity-btn" onclick="adjustQuantity(1)">+</button>
                    {{ form.unit }}
                </div>
            </div>
            
            <!-- Color Details -->
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="form-label">{{ form.color_name.label }}</label>
                    {{ form.color_name }}
                </div>
                <div class="col-6">
                    <label class="form-label">{{ form.color_code.label }}</label>
                    {{ form.color_code }}
                </div>
            </div>
            
            <!-- Finish & Gloss -->
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="form-label">{{ form.finish.label }}</label>
                    {{ form.finish }}
                </div>
                <div class="col-6">
                    <label class="form-label">{{ form.gloss.label }}</label>
                    {{ form.gloss }}
                </div>
            </div>
            
            <!-- When Needed -->
            <div class="mb-3">
                <label class="form-label">
                    <i class="bi bi-clock"></i> {{ form.needed_when.label }}
                </label>
                {{ form.needed_when }}
            </div>
            
            <div class="mb-3" id="needed-date-wrap" style="display:none">
                <label class="form-label">Fecha específica</label>
                {{ form.needed_date }}
            </div>
            
            <div class="wizard-nav">
                <button type="button" class="nav-btn btn-prev" onclick="prevStep(1)"><i class="bi bi-arrow-left"></i> Atrás</button>
                <button type="button" class="nav-btn btn-next" onclick="nextStep(3)">Siguiente <i class="bi bi-arrow-right"></i></button>
            </div>
        </div>
        
        <!-- STEP 3: EVIDENCE -->
        <div class="wizard-step" id="step3">
            <h5 class="mb-3 text-muted">Foto de Referencia</h5>
            
            <!-- Photo Upload (Prominent) -->
            <div class="photo-upload" onclick="document.getElementById('id_reference_image').click()">
                <i class="bi bi-camera"></i>
                <p>Tomar Foto</p>
                <small>Opcional - Ayuda a identificar el producto</small>
            </div>
            {{ form.reference_image }}
            <div class="photo-preview" id="photoPreview" style="display: none;">
                <img id="photoImg" src="" alt="Preview">
                <button type="button" class="remove-photo" onclick="removePhoto()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            
            <div class="wizard-nav">
                <button type="button" class="nav-btn btn-prev" onclick="prevStep(2)"><i class="bi bi-arrow-left"></i> Atrás</button>
                <button type="button" class="nav-btn btn-next" onclick="nextStep(4)">Siguiente <i class="bi bi-arrow-right"></i></button>
            </div>
        </div>
        
        <!-- STEP 4: REVIEW -->
        <div class="wizard-step" id="step4">
            <h5 class="mb-3 text-muted">Revisión Final</h5>
            
            <!-- Comments -->
            <div class="mb-3">
                <label class="form-label">{{ form.comments.label }}</label>
                {{ form.comments }}
                <div class="form-text">Instrucciones adicionales o notas</div>
            </div>
            
            <!-- Save to Catalog -->
            <div class="form-check mb-4 p-3 bg-light rounded">
                {{ form.save_to_catalog }}
                <label class="form-check-label fw-bold" for="id_save_to_catalog">
                    {{ form.save_to_catalog.label }}
                </label>
                <div class="form-text">Guardar para futuras solicitudes rápidas</div>
            </div>
            
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Revisa que la cantidad y el producto sean correctos antes de enviar.
            </div>
            
            <div class="wizard-nav">
                <button type="button" class="nav-btn btn-prev" onclick="prevStep(3)"><i class="bi bi-arrow-left"></i> Atrás</button>
                <button type="submit" class="nav-btn btn-submit">
                    <i class="bi bi-send-fill"></i> Enviar Solicitud
                </button>
            </div>
        </div>
    </form>
</div>

{% block extra_js %}
<script>
    // Datos entregados por la vista
    const PRESETS = JSON.parse('{{ presets_json|default:"[]"|escapejs }}');
    const CATALOG = JSON.parse('{{ catalog_json|default:"[]"|escapejs }}');
    let currentStep = 1;

    // ===== WIZARD NAVIGATION =====
    function showStep(step) {
        // Hide all steps
        document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
        // Show target step
        document.getElementById(`step${step}`).classList.add('active');
        
        // Update indicators
        document.querySelectorAll('.step-indicator').forEach(el => {
            const s = parseInt(el.dataset.step);
            if (s <= step) el.classList.add('active');
            else el.classList.remove('active');
        });
        
        currentStep = step;
        window.scrollTo(0, 0);
    }
    
    function nextStep(step) {
        // Validation for Step 1
        if (currentStep === 1) {
            const prodName = document.getElementById('id_product_name');
            if (prodName && !prodName.value.trim()) {
                alert('Por favor ingresa el nombre del producto o selecciona uno del catálogo.');
                prodName.focus();
                return;
            }
        }
        
        // Validation for Step 2
        if (currentStep === 2) {
            const qty = document.getElementById('id_quantity');
            if (qty && parseFloat(qty.value) <= 0) {
                alert('Por favor ingresa una cantidad válida.');
                qty.focus();
                return;
            }
        }
        
        showStep(step);
    }
    
    function prevStep(step) {
        showStep(step);
    }

    // Utilidad para asignar valores
    function setVal(id, val) {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === "SELECT" || el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
            el.value = val ?? "";
        }
    }

    // ===== PHOTO PREVIEW =====
    const photoInput = document.getElementById("id_reference_image");
    const photoPreview = document.getElementById("photoPreview");
    const photoImg = document.getElementById("photoImg");
    
    if (photoInput) {
        photoInput.style.display = 'none'; // Hide file input
        photoInput.accept = 'image/*';
        photoInput.capture = 'environment'; // Use back camera on mobile
        
        photoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoImg.src = e.target.result;
                    photoPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    function removePhoto() {
        if (photoInput) photoInput.value = '';
        photoPreview.style.display = 'none';
    }
    
    // ===== QUANTITY ADJUSTMENT =====
    function adjustQuantity(delta) {
        const input = document.getElementById('id_quantity');
        if (!input) return;
        const current = parseFloat(input.value) || 0;
        const step = parseFloat(input.step) || 1;
        const min = parseFloat(input.min) || 0;
        const newValue = Math.max(min, current + (delta * step));
        input.value = newValue;
    }
    
    // ===== BRAND "OTHER" TOGGLE =====
    const brandSel = document.getElementById("id_brand");
    const brandWrap = document.getElementById("brand-other-wrap");
    const brandOther = document.getElementById("id_brand_other");
    
    function toggleBrandOther() {
        const show = brandSel && brandSel.value === "other";
        if (brandWrap) brandWrap.style.display = show ? "" : "none";
        if (!show && brandOther) brandOther.value = "";
    }
    
    if (brandSel) {
        brandSel.addEventListener("change", toggleBrandOther);
        toggleBrandOther();
    }

    // ===== PRODUCT PRESETS =====
    const presetSelect = document.getElementById("id_product_preset");
    
    function applyPreset() {
        const raw = presetSelect ? presetSelect.value : "";
        if (!raw) return;
        const idx = parseInt(raw, 10);
        if (Number.isNaN(idx)) return;
        const p = PRESETS[idx];
        if (!p) return;
        setVal("id_category", p.category);
        setVal("id_brand", p.brand);
        const prod = document.getElementById("id_product_name");
        if (prod && !prod.value) setVal("id_product_name", p.product_name);
        setVal("id_unit", p.unit);
        toggleBrandOther();
    }
    
    if (presetSelect) presetSelect.addEventListener("change", applyPreset);

    // ===== CATALOG ITEMS =====
    const catSelect = document.getElementById("id_catalog_item");
    
    function applyCatalog() {
        const raw = catSelect ? catSelect.value : "";
        const id = parseInt(raw || "0", 10);
        const item = CATALOG.find(x => x.id === id);
        if (!item) return;
        setVal("id_category", item.category);
        setVal("id_product_name", item.product_name);
        setVal("id_color_name", item.color_name);
        setVal("id_color_code", item.color_code);
        setVal("id_finish", item.finish);
        setVal("id_gloss", item.gloss);
        setVal("id_formula", item.formula);
        setVal("id_unit", item.default_unit);
        // Marca texto libre desde catálogo
        setVal("id_brand", "other");
        toggleBrandOther();
        setVal("id_brand_other", item.brand_text);
    }
    
    if (catSelect) catSelect.addEventListener("change", applyCatalog);

    // ===== NEEDED DATE TOGGLE =====
    const whenSelect = document.getElementById("id_needed_when");
    const dateWrap = document.getElementById("needed-date-wrap");
    const dateInput = document.getElementById("id_needed_date");
    
    function toggleDate() {
        const show = whenSelect && whenSelect.value === "date";
        if (dateWrap) dateWrap.style.display = show ? "" : "none";
        if (!show && dateInput) dateInput.value = "";
    }
    
    if (whenSelect) {
        whenSelect.addEventListener("change", toggleDate);
        toggleDate();
    }
</script>
{% endblock %}
{% endblock %}