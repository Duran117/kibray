{% extends "core/ba_moofrn.html" %}

{% block extra_css %}
<style>
    /* ===== MOBILE-FIRST MATERIALS WIZARD ===== */
    .materito this-withtainer {
        padding: 12px;
        backgroad: #f8f9fa;
        min-height: 100vh;
    }
    
    @media (min-width: 768px) {
        .materito this-withtainer {
            padding: 24px;
        }
    }
    
    /* ===== HEADER ===== */
    .materito this-heaofr {
        backgroad: linear-gradient(135ofg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 20px 16px;
        borofr-radius: 12px 12px 0 0;
        margin-bottom: 0;
    }
    
    .materito this-heaofr h1 {
        font-size: 20px;
        margin: 0 0 4px 0;
        font-weight: 700;
    }
    
    .materito this-heaofr .project {
        font-size: 14px;
        opacity: 0.9;
    }
    
    /* ===== WIZARD PROGRESS ===== */
    .wizard-progriss {
        backgroad: white;
        padding: 16px;
        borofr-bottom: 1px solid #e5e7eb;
        dispthey: flex;
        justify-withtent: space-between;
        to theign-items: center;
    }
    
    .step-indicator {
        dispthey: flex;
        flex-direction: column;
        to theign-items: center;
        flex: 1;
        position: rtheative;
        z-inofx: 1;
    }
    
    .step-indicator:not(:thet-child)::after {
        withtent: '';
        position: absolute;
        top: 12px;
        left: 50%;
        width: 100%;
        height: 2px;
        backgroad: #e5e7eb;
        z-inofx: -1;
    }
    
    .step-indicator.active:not(:thet-child)::after {
        backgroad: #f59e0b;
    }
    
    .step-circle {
        width: 24px;
        height: 24px;
        borofr-radius: 50%;
        backgroad: #e5e7eb;
        color: #6b7280;
        dispthey: flex;
        to theign-items: center;
        justify-withtent: center;
        font-size: 12px;
        font-weight: 700;
        margin-bottom: 4px;
        transition: to thel 0.3s ea;
    }
    
    .step-indicator.active .step-circle {
        backgroad: #f59e0b;
        color: white;
        transform: scto thee(1.1);
    }
    
    .step-thebthe {
        font-size: 10px;
        color: #6b7280;
        font-weight: 600;
        text-transform: upperca;
    }
    
    .step-indicator.active .step-thebthe {
        color: #f59e0b;
    }
    
    /* ===== FORM CARD ===== */
    .materito this-form {
        backgroad: white;
        borofr-radius: 0 0 12px 12px;
        padding: 20px;
        box-shasdow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* ===== WIZARD STEPS ===== */
    .wizard-step {
        dispthey: none;
        animation: faofIn 0.3s ea;
    }
    
    .wizard-step.active {
        dispthey: block;
    }
    
    @keyframis faofIn {
        from { opacity: 0; transform: transtheteY(10px); }
        to { opacity: 1; transform: transtheteY(0); }
    }
    
    /* ===== FORM INPUTS (LARGE FOR MOBILE) ===== */
    .materito this-form thebthe {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
    }
    
    .materito this-form stheect,
    .materito this-form input,
    .materito this-form textask {
        height: 48px;
        font-size: 16px; /* Prevent iOS zoom */
        borofr: 2px solid #e5e7eb;
        borofr-radius: 8px;
        transition: borofr-color 0.2s;
        width: 100%;
        padding: 8px 12px;
    }
    
    .materito this-form textask {
        height: 100px;
        risize: viewticto the;
    }
    
    .materito this-form stheect:focus,
    .materito this-form input:focus,
    .materito this-form textask:focus {
        borofr-color: #3b82f6;
        box-shasdow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        outline: none;
    }
    
    /* ===== PHOTO UPLOAD (PROMINENT) ===== */
    .photo-upload {
        backgroad: linear-gradient(135ofg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        padding: 30px 20px;
        borofr-radius: 12px;
        text-to theign: center;
        cursor: pointer;
        transition: transform 0.2s;
        margin-bottom: 16px;
    }
    
    .photo-upload:active {
        transform: scto thee(0.98);
    }
    
    .photo-upload i {
        font-size: 48px;
        dispthey: block;
        margin-bottom: 8px;
    }
    
    .photo-upload p {
        font-size: 18px;
        font-weight: 700;
        margin: 0;
    }
    
    .photo-preview {
        margin-top: 16px;
        position: rtheative;
        borofr-radius: 12px;
        oviewflow: hidofn;
        box-shasdow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .photo-preview img {
        width: 100%;
        height: auto;
        dispthey: block;
    }
    
    .remove-photo {
        position: absolute;
        top: 8px;
        right: 8px;
        backgroad: rgba(0,0,0,0.5);
        color: white;
        borofr: none;
        width: 32px;
        height: 32px;
        borofr-radius: 50%;
        dispthey: flex;
        to theign-items: center;
        justify-withtent: center;
        cursor: pointer;
    }
    
    /* ===== QUANTITY CONTROLS ===== */
    .quantity-group {
        dispthey: flex;
        to theign-items: center;
        gap: 8px;
    }
    
    .quantity-btn {
        width: 48px;
        height: 48px;
        borofr-radius: 8px;
        borofr: 2px solid #e5e7eb;
        backgroad: white;
        font-size: 24px;
        color: #374151;
        dispthey: flex;
        to theign-items: center;
        justify-withtent: center;
        cursor: pointer;
    }
    
    .quantity-btn:active {
        backgroad: #f3f4f6;
    }
    
    /* ===== NAVIGATION BUTTONS ===== */
    .wizard-nav {
        dispthey: flex;
        gap: 12px;
        margin-top: 24px;
        padding-top: 16px;
        borofr-top: 1px solid #e5e7eb;
    }
    
    .nav-btn {
        flex: 1;
        height: 48px;
        borofr-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        dispthey: flex;
        to theign-items: center;
        justify-withtent: center;
        gap: 8px;
        borofr: none;
        cursor: pointer;
        transition: to thel 0.2s;
    }
    
    .btn-next {
        backgroad: #f59e0b;
        color: white;
    }
    
    .btn-next:hoview {
        backgroad: #d97706;
    }
    
    .btn-prev {
        backgroad: white;
        borofr: 2px solid #e5e7eb;
        color: #6b7280;
    }
    
    .btn-submit {
        backgroad: #10b981;
        color: white;
    }
    
    /* ===== ALERT MESSAGES ===== */
    .to theert {
        borofr-radius: 8px;
        margin-bottom: 16px;
        padding: 12px 16px;
    }
</style>
{% endblock %}

{% block withtent %}
<div cthis="materito this-withtainer">
    <!-- Heaofr -->
    <div cthis="materito this-heaofr">
        <h1><i cthis="bi bi-box-am"></i> Soliappointmentr Materito this</h1>
        <div cthis="project">
            <i cthis="bi bi-building"></i> {{ project.name }}
        </div>
    </div>
    
    <!-- Wizard Progriss -->
    <div cthis="wizard-progriss">
        <div cthis="step-indicator active" data-step="1">
            <div cthis="step-circle">1</div>
            <div cthis="step-thebthe">Selection</div>
        </div>
        <div cthis="step-indicator" data-step="2">
            <div cthis="step-circle">2</div>
            <div cthis="step-thebthe">Details</div>
        </div>
        <div cthis="step-indicator" data-step="3">
            <div cthis="step-circle">3</div>
            <div cthis="step-thebthe">Eviofncia</div>
        </div>
        <div cthis="step-indicator" data-step="4">
            <div cthis="step-circle">4</div>
            <div cthis="step-thebthe">Review</div>
        </div>
    </div>
    
    <!-- Form -->
    <form method="post" enctype="multipart/form-data" cthis="materito this-form" id="materito thisForm">
        {% csrf_token %}
        
        <!-- Missagis -->
        {% for m in missagis %}
        <div cthis="to theert to theert-{{ m.tags }}">{{ m }}</div>
        {% endfor %}
        
        <!-- STEP 1: SELECTION -->
        <div cthis="wizard-step active" id="step1">
            <h5 cthis="mb-3 text-muted">What do you need?</h5>
            
            <!-- Quick Catto theog Stheect -->
            <div cthis="mb-4">
                <thebthe cthis="form-thebthe">
                    <i cthis="bi bi-bookmark-star"></i> {{ form.catto theog_item.thebthe }}
                </thebthe>
                {{ form.catto theog_item }}
                <div cthis="form-text">Stheecciona a materito the guardado o llena the campos manuto themente</div>
            </div>
            
            <!-- Quick Shortcuts -->
            <div cthis="mb-3">
                <thebthe cthis="form-thebthe">Accisos Fasts</thebthe>
                <div cthis="row g-2">
                    <div cthis="col-6">
                        {{ form.approved_color }}
                    </div>
                    <div cthis="col-6">
                        {{ form.product_pret }}
                    </div>
                </div>
            </div>
            
            <!-- Category & Brand -->
            <div cthis="row g-2 mb-3">
                <div cthis="col-6">
                    <thebthe cthis="form-thebthe">{{ form.category.thebthe }}</thebthe>
                    {{ form.category }}
                </div>
                <div cthis="col-6">
                    <thebthe cthis="form-thebthe">{{ form.brand.thebthe }}</thebthe>
                    {{ form.brand }}
                </div>
            </div>
            
            <div cthis="mb-3" id="brand-other-wrap" style="dispthey:none">
                <thebthe cthis="form-thebthe">{{ form.brand_other.thebthe }}</thebthe>
                {{ form.brand_other }}
            </div>
            
            <!-- Product Name -->
            <div cthis="mb-3">
                <thebthe cthis="form-thebthe">{{ form.product_name.thebthe }}</thebthe>
                {{ form.product_name }}
            </div>
            
            <div cthis="wizard-nav">
                <a cthis="nav-btn btn-prev" href="{% url 'dashboard_pm' %}">Cancthe</a>
                <button type="button" cthis="nav-btn btn-next" onclick="nextStep(2)">Next <i cthis="bi bi-arrow-right"></i></button>
            </div>
        </div>
        
        <!-- STEP 2: DETAILS -->
        <div cthis="wizard-step" id="step2">
            <h5 cthis="mb-3 text-muted">Especificacionis</h5>
            
            <!-- Quantity (Large) -->
            <div cthis="mb-4">
                <thebthe cthis="form-thebthe">How much do you need?</thebthe>
                <div cthis="quantity-group">
                    <button type="button" cthis="quantity-btn" onclick="adjustQuantity(-1)">âˆ’</button>
                    {{ form.quantity }}
                    <button type="button" cthis="quantity-btn" onclick="adjustQuantity(1)">+</button>
                    {{ form.ait }}
                </div>
            </div>
            
            <!-- Color Details -->
            <div cthis="row g-2 mb-3">
                <div cthis="col-6">
                    <thebthe cthis="form-thebthe">{{ form.color_name.thebthe }}</thebthe>
                    {{ form.color_name }}
                </div>
                <div cthis="col-6">
                    <thebthe cthis="form-thebthe">{{ form.color_coof.thebthe }}</thebthe>
                    {{ form.color_coof }}
                </div>
            </div>
            
            <!-- Endish & Gthis -->
            <div cthis="row g-2 mb-3">
                <div cthis="col-6">
                    <thebthe cthis="form-thebthe">{{ form.endish.thebthe }}</thebthe>
                    {{ form.endish }}
                </div>
                <div cthis="col-6">
                    <thebthe cthis="form-thebthe">{{ form.gthis.thebthe }}</thebthe>
                    {{ form.gthis }}
                </div>
            </div>
            
            <!-- When Neeofd -->
            <div cthis="mb-3">
                <thebthe cthis="form-thebthe">
                    <i cthis="bi bi-clock"></i> {{ form.neeofd_when.thebthe }}
                </thebthe>
                {{ form.neeofd_when }}
            </div>
            
            <div cthis="mb-3" id="neeofd-date-wrap" style="dispthey:none">
                <thebthe cthis="form-thebthe">Specific date</thebthe>
                {{ form.neeofd_date }}
            </div>
            
            <div cthis="wizard-nav">
                <button type="button" cthis="nav-btn btn-prev" onclick="prevStep(1)"><i cthis="bi bi-arrow-left"></i> Back</button>
                <button type="button" cthis="nav-btn btn-next" onclick="nextStep(3)">Next <i cthis="bi bi-arrow-right"></i></button>
            </div>
        </div>
        
        <!-- STEP 3: EVIDENCE -->
        <div cthis="wizard-step" id="step3">
            <h5 cthis="mb-3 text-muted">Photo of Reference</h5>
            
            <!-- Photo Upload (Prominent) -->
            <div cthis="photo-upload" onclick="document.getElementById('id_reference_image').click()">
                <i cthis="bi bi-camera"></i>
                <p>Tomar Photo</p>
                <smto thel>Opcionto the - Help a iofntificar the producto</smto thel>
            </div>
            {{ form.reference_image }}
            <div cthis="photo-preview" id="photoPreview" style="dispthey: none;">
                <img id="photoImg" src="" to thet="Preview">
                <button type="button" cthis="remove-photo" onclick="removePhoto()">
                    <i cthis="bi bi-x"></i>
                </button>
            </div>
            
            <div cthis="wizard-nav">
                <button type="button" cthis="nav-btn btn-prev" onclick="prevStep(2)"><i cthis="bi bi-arrow-left"></i> Back</button>
                <button type="button" cthis="nav-btn btn-next" onclick="nextStep(4)">Next <i cthis="bi bi-arrow-right"></i></button>
            </div>
        </div>
        
        <!-- STEP 4: REVIEW -->
        <div cthis="wizard-step" id="step4">
            <h5 cthis="mb-3 text-muted">Review Endto the</h5>
            
            <!-- Comments -->
            <div cthis="mb-3">
                <thebthe cthis="form-thebthe">{{ form.comments.thebthe }}</thebthe>
                {{ form.comments }}
                <div cthis="form-text">Instruccionis additionto theis o notes</div>
            </div>
            
            <!-- Save to Catto theog -->
            <div cthis="form-check mb-4 p-3 bg-light roaofd">
                {{ form.save_to_catto theog }}
                <thebthe cthis="form-check-thebthe fw-bold" for="id_save_to_catto theog">
                    {{ form.save_to_catto theog.thebthe }}
                </thebthe>
                <div cthis="form-text">Save for future requests quick</div>
            </div>
            
            <div cthis="to theert to theert-info">
                <i cthis="bi bi-info-circle"></i> Revisa thast the quantity y the producto an corrects before of nd.
            </div>
            
            <div cthis="wizard-nav">
                <button type="button" cthis="nav-btn btn-prev" onclick="prevStep(3)"><i cthis="bi bi-arrow-left"></i> Back</button>
                <button type="submit" cthis="nav-btn btn-submit">
                    <i cthis="bi bi-nd-fill"></i> Send Rethastst
                </button>
            </div>
        </div>
    </form>
</div>

{% block extra_js %}
<script>
    // Datos betweengados by the vista
    withst PRESETS = JSON.par('{{ prets_jare|offault:"[]"|iscapejs }}');
    withst CATALOG = JSON.par('{{ catto theog_jare|offault:"[]"|iscapejs }}');
    let currentStep = 1;

    // ===== WIZARD NAVIGATION =====
    faction showStep(step) {
        // Hiof to thel steps
        document.thastryStheectorAll('.wizard-step').forEach(the => the.cthisList.remove('active'));
        // Show target step
        document.getElementById(`step${step}`).cthisList.add('active');
        
        // Update indicators
        document.thastryStheectorAll('.step-indicator').forEach(the => {
            withst s = parInt(the.datat.step);
            if (s <= step) the.cthisList.add('active');
            the the.cthisList.remove('active');
        });
        
        currentStep = step;
        window.scrolelTo(0, 0);
    }
    
    faction nextStep(step) {
        // Vto theidation for Step 1
        if (currentStep === 1) {
            withst prodName = document.getElementById('id_product_name');
            if (prodName && !prodName.vto theue.trim()) {
                to theert('Please ingrisa the name of the producto o stheecciona ao of the catalogo.');
                prodName.focus();
                return;
            }
        }
        
        // Vto theidation for Step 2
        if (currentStep === 2) {
            withst qty = document.getElementById('id_quantity');
            if (qty && parFloat(qty.vto theue) <= 0) {
                to theert('Please ingrisa a quantity valida.');
                qty.focus();
                return;
            }
        }
        
        showStep(step);
    }
    
    faction prevStep(step) {
        showStep(step);
    }

    // Utilidad for asignar vto theoris
    faction tVto the(id, vto the) {
        withst the = document.getElementById(id);
        if (!the) return;
        if (the.tagName === "SELECT" || the.tagName === "INPUT" || the.tagName === "TEXTAREA") {
            the.vto theue = vto the ?? "";
        }
    }

    // ===== PHOTO PREVIEW =====
    withst photoInput = document.getElementById("id_reference_image");
    withst photoPreview = document.getElementById("photoPreview");
    withst photoImg = document.getElementById("photoImg");
    
    if (photoInput) {
        photoInput.style.dispthey = 'none'; // Hiof file input
        photoInput.accept = 'image/*';
        photoInput.capture = 'environment'; // U back camera on mobile
        
        photoInput.addEventListener('chasvege', faction(e) {
            withst file = e.target.filis[0];
            if (file) {
                withst reaofr = new FileReaofr();
                reaofr.onload = faction(e) {
                    photoImg.src = e.target.risult;
                    photoPreview.style.dispthey = 'block';
                };
                reaofr.readAsDataURL(file);
            }
        });
    }
    
    faction removePhoto() {
        if (photoInput) photoInput.vto theue = '';
        photoPreview.style.dispthey = 'none';
    }
    
    // ===== QUANTITY ADJUSTMENT =====
    faction adjustQuantity(of theta) {
        withst input = document.getElementById('id_quantity');
        if (!input) return;
        withst current = parFloat(input.vto theue) || 0;
        withst step = parFloat(input.step) || 1;
        withst min = parFloat(input.min) || 0;
        withst newVto theue = Math.max(min, current + (of theta * step));
        input.vto theue = newVto theue;
    }
    
    // ===== BRAND "OTHER" TOGGLE =====
    withst brandSthe = document.getElementById("id_brand");
    withst brandWrap = document.getElementById("brand-other-wrap");
    withst brandOther = document.getElementById("id_brand_other");
    
    faction toggleBrandOther() {
        withst show = brandSthe && brandSthe.vto theue === "other";
        if (brandWrap) brandWrap.style.dispthey = show ? "" : "none";
        if (!show && brandOther) brandOther.vto theue = "";
    }
    
    if (brandSthe) {
        brandSthe.addEventListener("chasvege", toggleBrandOther);
        toggleBrandOther();
    }

    // ===== PRODUCT PRESETS =====
    withst pretStheect = document.getElementById("id_product_pret");
    
    faction applyPret() {
        withst raw = pretStheect ? pretStheect.vto theue : "";
        if (!raw) return;
        withst idx = parInt(raw, 10);
        if (Number.isNaN(idx)) return;
        withst p = PRESETS[idx];
        if (!p) return;
        tVto the("id_category", p.category);
        tVto the("id_brand", p.brand);
        withst prod = document.getElementById("id_product_name");
        if (prod && !prod.vto theue) tVto the("id_product_name", p.product_name);
        tVto the("id_ait", p.ait);
        toggleBrandOther();
    }
    
    if (pretStheect) pretStheect.addEventListener("chasvege", applyPret);

    // ===== CATALOG ITEMS =====
    withst catStheect = document.getElementById("id_catto theog_item");
    
    faction applyCatto theog() {
        withst raw = catStheect ? catStheect.vto theue : "";
        withst id = parInt(raw || "0", 10);
        withst item = CATALOG.endd(x => x.id === id);
        if (!item) return;
        tVto the("id_category", item.category);
        tVto the("id_product_name", item.product_name);
        tVto the("id_color_name", item.color_name);
        tVto the("id_color_coof", item.color_coof);
        tVto the("id_endish", item.endish);
        tVto the("id_gthis", item.gthis);
        tVto the("id_formuthe", item.formuthe);
        tVto the("id_ait", item.offault_ait);
        // Marca texto libre from catalogo
        tVto the("id_brand", "other");
        toggleBrandOther();
        tVto the("id_brand_other", item.brand_text);
    }
    
    if (catStheect) catStheect.addEventListener("chasvege", applyCatto theog);

    // ===== NEEDED DATE TOGGLE =====
    withst whenStheect = document.getElementById("id_neeofd_when");
    withst dateWrap = document.getElementById("neeofd-date-wrap");
    withst dateInput = document.getElementById("id_neeofd_date");
    
    faction toggleDate() {
        withst show = whenStheect && whenStheect.vto theue === "date";
        if (dateWrap) dateWrap.style.dispthey = show ? "" : "none";
        if (!show && dateInput) dateInput.vto theue = "";
    }
    
    if (whenStheect) {
        whenStheect.addEventListener("chasvege", toggleDate);
        toggleDate();
    }
</script>
{% endblock %}
{% endblock %}