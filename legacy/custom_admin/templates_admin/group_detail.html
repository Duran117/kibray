{% extends "core/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{{ group.name }} - {% trans "Grupo" %} - Kibray{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Botón de regreso -->
  <div class="mb-3">
    <a href="{% url 'admin_groups_list' %}" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-arrow-left me-1"></i>
      {% trans "Volver a Grupos" %}
    </a>
  </div>

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">
        <i class="bi bi-diagram-3-fill text-primary me-2"></i>
        {{ group.name }}
      </h2>
      <p class="text-muted small mb-0">
        {{ users.count }} {% trans "usuarios" %} | {{ group.permissions.count }} {% trans "permisos" %}
      </p>
    </div>
  </div>

  <div class="row g-4">
    <!-- Información del grupo -->
    <div class="col-lg-4">
      <div class="card shadow-sm mb-3">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>
            {% trans "Información del Grupo" %}
          </h5>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_name">
            
            <div class="mb-3">
              <label class="form-label small fw-bold">{% trans "Nombre del Grupo" %}</label>
              <input type="text" name="name" class="form-control" value="{{ group.name }}" required>
            </div>

            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-check-circle me-1"></i>
              {% trans "Actualizar Nombre" %}
            </button>
          </form>
        </div>
      </div>

      <!-- Usuarios en este grupo -->
      <div class="card shadow-sm">
        <div class="card-header bg-info bg-opacity-10">
          <h5 class="mb-0">
            <i class="bi bi-people-fill me-2"></i>
            {% trans "Usuarios" %} ({{ users.count }})
          </h5>
        </div>
        <div class="card-body">
          {% if users %}
            <div class="list-group list-group-flush">
              {% for user in users %}
              <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                <div>
                  <strong>{{ user.username }}</strong>
                  {% if user.first_name or user.last_name %}
                    <br><small class="text-muted">{{ user.get_full_name }}</small>
                  {% endif %}
                </div>
                <a href="{% url 'admin_user_detail' user.id %}" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-eye"></i>
                </a>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted text-center mb-0">
              <i class="bi bi-inbox fs-1 d-block mb-2"></i>
              {% trans "No hay usuarios en este grupo" %}
            </p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Gestión de Permisos -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-shield-check me-2"></i>
            {% trans "Gestión de Permisos" %}
          </h5>
        </div>
        <div class="card-body">
          <form method="post" id="permissionsForm">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_permissions">
            
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <p class="text-muted small mb-0">
                  {% trans "Selecciona los permisos que tendrá este grupo" %}
                </p>
                <div>
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAll()">
                    {% trans "Seleccionar todo" %}
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
                    {% trans "Deseleccionar todo" %}
                  </button>
                </div>
              </div>
            </div>

            <div class="accordion" id="permissionsAccordion">
              {% for model_name, model_data in permissions_by_model.items %}
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                  <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}">
                    <strong>{{ model_data.label }}</strong>
                    <span class="badge bg-primary ms-2">{{ model_data.permissions|length }}</span>
                  </button>
                </h2>
                <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" data-bs-parent="#permissionsAccordion">
                  <div class="accordion-body">
                    <div class="row">
                      {% for perm in model_data.permissions %}
                      <div class="col-md-6 mb-2">
                        <div class="form-check">
                          <input 
                            class="form-check-input" 
                            type="checkbox" 
                            name="permissions" 
                            value="{{ perm.id }}" 
                            id="perm{{ perm.id }}"
                            {% if perm.has_permission %}checked{% endif %}
                          >
                          <label class="form-check-label" for="perm{{ perm.id }}">
                            {{ perm.name }}
                            <small class="text-muted">({{ perm.codename }})</small>
                          </label>
                        </div>
                      </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>

            <div class="mt-4 d-grid">
              <button type="submit" class="btn btn-success btn-lg">
                <i class="bi bi-check-circle me-2"></i>
                {% trans "Guardar Permisos" %}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function selectAll() {
  document.querySelectorAll('#permissionsForm input[type="checkbox"]').forEach(cb => cb.checked = true);
}

function deselectAll() {
  document.querySelectorAll('#permissionsForm input[type="checkbox"]').forEach(cb => cb.checked = false);
}
</script>
{% endblock %}
