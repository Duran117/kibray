# Kibray Production Deployment Guide

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Environment Setup](#environment-setup)
3. [Platform-Specific Deployment](#platform-specific-deployment)
4. [Post-Deployment Tasks](#post-deployment-tasks)
5. [Monitoring & Maintenance](#monitoring--maintenance)
6. [Troubleshooting](#troubleshooting)

## Prerequisites

### Required Accounts

- [ ] GitHub account (for CI/CD)
- [ ] Deployment platform account (Railway/Render/Heroku)
- [ ] AWS account (for S3 media storage)
- [ ] Sentry account (for error tracking)
- [ ] Firebase account (for push notifications)
- [ ] Domain registrar (for custom domain)

### Required Tools

```bash
# Install required CLI tools
# Railway CLI
npm install -g @railway/cli

# Or Render CLI
brew install render

# Or Heroku CLI
brew tap heroku/brew && brew install heroku

# PostgreSQL client (for backups)
brew install postgresql

# Redis client (for debugging)
brew install redis
```

## Environment Setup

### 1. Generate Secret Key

```bash
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
```

### 2. Create `.env.production` File

Copy from `.env.example` and fill in production values:

```bash
cp .env.example .env.production
```

Key variables to set:
```env
DJANGO_ENV=production
SECRET_KEY=<generated-above>
ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com
DATABASE_URL=<will-be-auto-generated>
REDIS_URL=<will-be-auto-generated>
AWS_ACCESS_KEY_ID=<from-aws-console>
AWS_SECRET_ACCESS_KEY=<from-aws-console>
AWS_STORAGE_BUCKET_NAME=kibray-media-prod
SENTRY_DSN=<from-sentry-io>
```

### 3. AWS S3 Setup

1. Create S3 bucket:
```bash
aws s3 mb s3://kibray-media-prod --region us-east-1
```

2. Set CORS policy (`s3-cors.json`):
```json
[
    {
        "AllowedHeaders": ["*"],
        "AllowedMethods": ["GET", "PUT", "POST", "DELETE"],
        "AllowedOrigins": ["https://yourdomain.com"],
        "ExposeHeaders": ["ETag"]
    }
]
```

```bash
aws s3api put-bucket-cors --bucket kibray-media-prod --cors-configuration file://s3-cors.json
```

3. Create IAM user with S3 access only

4. Get access keys and add to environment variables

### 4. Firebase Setup (Push Notifications)

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Create new project: `kibray-prod`
3. Add web app
4. Get config values:
   - API Key
   - Project ID
   - Messaging Sender ID
   - App ID
5. Generate VAPID keys (Cloud Messaging → Web Push certificates)
6. Download service account JSON (Project Settings → Service Accounts)

## Platform-Specific Deployment

### Option 1: Railway (Recommended)

#### Initial Setup

```bash
# Install Railway CLI
npm install -g @railway/cli

# Login
railway login

# Link project
railway link

# Or create new project
railway init
```

#### Add Services

```bash
# Add PostgreSQL
railway add postgresql

# Add Redis
railway add redis

# Deploy application
railway up
```

#### Configure Environment Variables

```bash
# Set variables from .env.production
railway variables set DJANGO_ENV=production
railway variables set SECRET_KEY="your-secret-key"
railway variables set ALLOWED_HOSTS="your-domain.com"
# ... (repeat for all variables)
```

#### Custom Domain

1. Go to Railway dashboard → Settings → Domains
2. Add custom domain: `api.kibray.com`
3. Add DNS record at your registrar:
   ```
   CNAME api.kibray.com railway.app.
   ```
4. SSL certificate auto-generated by Railway

#### Deployment

```bash
# Deploy
railway up

# View logs
railway logs

# Open in browser
railway open
```

### Option 2: Render

#### Initial Setup

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Click **New → Web Service**
3. Connect GitHub repository
4. Configure:
   - **Name**: kibray-backend
   - **Environment**: Python 3
   - **Build Command**: `pip install -r requirements.txt && python manage.py collectstatic --noinput && python manage.py migrate --noinput`
   - **Start Command**: `gunicorn kibray_backend.wsgi:application --config gunicorn.conf.py`

#### Add Services

1. **PostgreSQL**:
   - New → PostgreSQL
   - Name: kibray-db
   - Instance type: Starter ($7/month)

2. **Redis**:
   - New → Redis
   - Name: kibray-redis
   - Instance type: Starter ($10/month)

#### Environment Variables

Add in Render dashboard:
- Auto-generated: `DATABASE_URL`, `REDIS_URL`
- Manual: Copy from `.env.production`

#### Custom Domain

1. Go to Settings → Custom Domain
2. Add: `api.kibray.com`
3. Add DNS record:
   ```
   CNAME api.kibray.com kibray-backend.onrender.com
   ```

### Option 3: Heroku

#### Initial Setup

```bash
# Login
heroku login

# Create app
heroku create kibray-backend

# Add buildpack
heroku buildpacks:set heroku/python
```

#### Add Services

```bash
# PostgreSQL
heroku addons:create heroku-postgresql:mini

# Redis
heroku addons:create heroku-redis:mini

# Verify
heroku addons
```

#### Configure Environment

```bash
# Set variables
heroku config:set DJANGO_ENV=production
heroku config:set SECRET_KEY="your-secret-key"
# ... (repeat for all variables)

# Verify
heroku config
```

#### Deploy

```bash
# Deploy
git push heroku main

# Run migrations
heroku run python manage.py migrate

# Collect static files
heroku run python manage.py collectstatic --noinput

# Create superuser
heroku run python manage.py createsuperuser

# View logs
heroku logs --tail
```

#### Custom Domain

```bash
heroku domains:add api.kibray.com
```

Add DNS record at registrar.

## Post-Deployment Tasks

### 1. Database Setup

```bash
# Run migrations
python manage.py migrate

# Create superuser
python manage.py createsuperuser

# Load initial data (if any)
python manage.py loaddata initial_costcodes.json
```

### 2. Static Files

```bash
# Collect static files
python manage.py collectstatic --noinput

# Verify static files accessible
curl https://yourdomain.com/static/logo.png
```

### 3. Health Check

```bash
# Test health endpoint
curl https://yourdomain.com/api/v1/health/detailed/

# Expected response:
{
  "status": "healthy",
  "checks": {
    "database": "healthy",
    "cache": "healthy",
    "static_files": "healthy"
  }
}
```

### 4. Smoke Tests

```bash
# Test authentication
curl -X POST https://yourdomain.com/api/v1/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"testpass"}'

# Test API endpoints (with token)
curl https://yourdomain.com/api/v1/projects/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 5. SSL Verification

```bash
# Check SSL certificate
curl -vI https://yourdomain.com 2>&1 | grep -i "SSL"

# Verify HSTS header
curl -I https://yourdomain.com | grep -i "strict-transport"
```

### 6. Setup Monitoring

#### Sentry

1. Create project at [sentry.io](https://sentry.io/)
2. Copy DSN
3. Add to environment: `SENTRY_DSN=https://xxx@sentry.io/xxx`
4. Trigger test error:
   ```python
   from sentry_sdk import capture_message
   capture_message("Test from production", level="info")
   ```

#### Google Analytics (Optional)

Add to frontend:
```html
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-XXXXXXXXXX');
</script>
```

### 7. Setup Backups

```bash
# Test manual backup
python manage.py backup_database --upload-s3

# Setup automated backups (cron)
crontab -e

# Add line:
0 2 * * * /path/to/kibray/scripts/backup_cron.sh
```

Or use platform-specific backup:
- **Railway**: Manual snapshots in dashboard
- **Render**: Automatic daily backups
- **Heroku**: `heroku pg:backups:schedule DATABASE_URL --at '02:00 America/Los_Angeles'`

### 8. Configure Celery Workers

If using background tasks:

```bash
# Railway: Add worker service
railway add

# Render: Add Background Worker
# - Build Command: pip install -r requirements.txt
# - Start Command: celery -A kibray_backend worker --loglevel=info

# Heroku: Scale worker
heroku ps:scale worker=1
```

## Monitoring & Maintenance

### Daily Checks

```bash
# Check application health
curl https://yourdomain.com/api/v1/health/detailed/

# Check error rate in Sentry
# Visit https://sentry.io/organizations/your-org/issues/

# Check logs
railway logs  # or heroku logs --tail
```

### Weekly Tasks

- [ ] Review Sentry errors
- [ ] Check database size and indexes
- [ ] Review slow queries in PostgreSQL
- [ ] Check Redis memory usage
- [ ] Review security advisories for dependencies

### Monthly Tasks

- [ ] Update dependencies (`pip list --outdated`)
- [ ] Review and optimize slow endpoints
- [ ] Database VACUUM and ANALYZE (auto on managed services)
- [ ] Review access logs for anomalies
- [ ] Test backup restoration

### Quarterly Tasks

- [ ] Rotate SECRET_KEY (requires user re-login)
- [ ] Rotate database passwords
- [ ] Full security audit
- [ ] Load testing
- [ ] Disaster recovery drill

## Troubleshooting

### Application Won't Start

```bash
# Check logs
railway logs  # or platform-specific command

# Common issues:
# 1. Missing environment variable → Set in dashboard
# 2. Migration failed → Run manually: railway run python manage.py migrate
# 3. Static files not collected → Run: railway run python manage.py collectstatic
```

### 500 Internal Server Error

```bash
# Check Sentry for error details
# Enable DEBUG temporarily (NOT in production!)
railway variables set DEBUG=True
railway logs

# Check database connection
railway run python manage.py dbshell
# Try: SELECT 1;

# Check Redis connection
railway run redis-cli -u $REDIS_URL
# Try: PING
```

### Database Connection Errors

```bash
# Verify DATABASE_URL format
echo $DATABASE_URL
# Should be: postgresql://user:pass@host:5432/db

# Test connection
psql $DATABASE_URL -c "SELECT version();"

# Check connection pool
# In Django shell:
from django.db import connection
connection.ensure_connection()
print(connection.is_usable())
```

### Redis Connection Errors

```bash
# Verify REDIS_URL
echo $REDIS_URL

# Test connection
redis-cli -u $REDIS_URL ping

# Check Redis memory
redis-cli -u $REDIS_URL INFO memory
```

### Static Files Not Loading

```bash
# Verify STATIC_ROOT
python manage.py findstatic logo.png --verbosity 2

# Collect static files again
python manage.py collectstatic --noinput --clear

# Check WhiteNoise middleware order (should be after SecurityMiddleware)
```

### Slow Performance

```bash
# Check database query performance
python manage.py shell
>>> from django.db import connection, reset_queries
>>> from django.conf import settings
>>> settings.DEBUG = True  # Only for debugging
>>> # Run your query
>>> print(len(connection.queries))  # Number of queries
>>> print(connection.queries)  # Query details

# Check Redis performance
redis-cli -u $REDIS_URL --latency

# Run load test
locust -f locustfile.py --host=https://yourdomain.com --users=10 --spawn-rate=2 --run-time=1m --headless
```

### Memory Issues

```bash
# Check memory usage (Railway dashboard)
railway status

# Increase Gunicorn workers
railway variables set WEB_CONCURRENCY=2  # Reduce if memory is limited

# Enable Gunicorn max_requests (already in gunicorn.conf.py)
# Workers restart after 1000 requests to prevent memory leaks
```

## Rollback Procedure

### Quick Rollback (Railway)

```bash
# List deployments
railway deployments

# Rollback to previous deployment
railway rollback
```

### Manual Rollback (Git)

```bash
# Find last working commit
git log --oneline

# Revert to last working version
git revert <commit-hash>
git push origin main

# Or force push (DANGEROUS)
git reset --hard <commit-hash>
git push --force origin main
```

### Database Rollback

```bash
# Restore from backup
python manage.py restore_database --file=backups/kibray_backup_20250101_120000.sql.gz --confirm
```

## Security Checklist

Before going live:

- [ ] `DEBUG = False`
- [ ] Strong `SECRET_KEY` (50+ characters)
- [ ] `ALLOWED_HOSTS` configured
- [ ] HTTPS enabled
- [ ] HSTS enabled
- [ ] Secure cookies enabled
- [ ] CORS configured for specific origins only
- [ ] Database SSL required
- [ ] Redis password set
- [ ] Admin panel protected (custom URL or IP whitelist)
- [ ] Rate limiting enabled
- [ ] File upload limits configured
- [ ] Sentry error tracking active
- [ ] Automated backups running
- [ ] Security headers verified (Mozilla Observatory)

Run security check:
```bash
python manage.py check --deploy
```

## Performance Checklist

- [ ] Database indexes created (see `DATABASE_OPTIMIZATION.md`)
- [ ] Redis caching enabled
- [ ] Static files compressed (WhiteNoise)
- [ ] Frontend bundled and minified
- [ ] Gunicorn with appropriate workers (4-8)
- [ ] Database connection pooling enabled
- [ ] CDN for static files (optional)
- [ ] Load tested (500 concurrent users)
- [ ] Response times < 200ms (95th percentile)

## Support & Resources

- **Deployment Platforms**:
  - [Railway Docs](https://docs.railway.app/)
  - [Render Docs](https://render.com/docs)
  - [Heroku Docs](https://devcenter.heroku.com/)

- **Django**:
  - [Deployment Checklist](https://docs.djangoproject.com/en/5.0/howto/deployment/checklist/)
  - [Security Best Practices](https://docs.djangoproject.com/en/5.0/topics/security/)

- **Monitoring**:
  - [Sentry Documentation](https://docs.sentry.io/)
  - [Locust Documentation](https://docs.locust.io/)

- **Project Documentation**:
  - `README.md` - General overview
  - `ENVIRONMENT_VARIABLES.md` - All environment variables
  - `SECURITY_CHECKLIST.md` - Security configuration
  - `LOAD_TESTING.md` - Performance testing
  - `DATABASE_OPTIMIZATION.md` - Database tuning
  - `SENTRY_SETUP.md` - Error tracking setup

## Need Help?

- Check logs first: `railway logs` or platform-specific
- Search issues on GitHub: [github.com/your-org/kibray/issues](https://github.com)
- Contact DevOps team: devops@kibray.com
