# üéØ Executive Priming 80/20 - Gu√≠a Completa

> **Principio de Pareto**: El 20% de tus esfuerzos genera el 80% de tus resultados

## üìÖ **Fecha de Creaci√≥n**: Diciembre 3, 2025

---

## üéØ **QU√â ES EXECUTIVE PRIMING 80/20**

### **Definici√≥n**
Sistema de preparaci√≥n mental y operativa que te permite:
- ‚úÖ **Priming**: Preparar tu mente para m√°xima productividad (15 min/d√≠a)
- ‚úÖ **80/20**: Identificar el 20% de tareas cr√≠ticas que generan 80% resultados
- ‚úÖ **Executive**: Enfoque en decisiones estrat√©gicas vs. operativas

### **Objetivo**
Pasar de "ocupado trabajando 12 horas/d√≠a" a "productivo trabajando 4 horas/d√≠a en lo que importa"

---

## üß† **FASE 1: PRIMING MATUTINO (15 minutos)**

### **Rutina Diaria 6:00 AM - 6:15 AM**

#### **1. Hydration + Breath (3 min)**
```
‚îú‚îÄ Beber 500ml agua con lim√≥n
‚îú‚îÄ Respiraci√≥n 4-7-8 (3 ciclos)
‚îÇ  ‚îî‚îÄ Inhala 4 seg ‚Üí Ret√©n 7 seg ‚Üí Exhala 8 seg
‚îî‚îÄ Despertar al sistema nervioso
```

#### **2. Movement (5 min)**
```
‚îú‚îÄ 20 jumping jacks
‚îú‚îÄ 10 push-ups
‚îú‚îÄ 10 air squats
‚îú‚îÄ Estiramientos b√°sicos
‚îî‚îÄ Activar energ√≠a f√≠sica
```

#### **3. Gratitude + Vision (3 min)**
```
‚îú‚îÄ 3 cosas por las que est√°s agradecido hoy
‚îú‚îÄ Visualizar: ¬øC√≥mo luce el √©xito HOY?
‚îÇ  ‚îî‚îÄ "Hoy cierro contrato con cliente X"
‚îÇ  ‚îî‚îÄ "Proyecto Y queda perfecto"
‚îî‚îÄ Afirmaci√≥n: "Hoy ejecuto con excelencia"
```

#### **4. 80/20 Planning (4 min)**
```
‚îú‚îÄ Abrir Kibray Morning Briefing
‚îú‚îÄ Identificar: ¬øCu√°l es mi ONE THING hoy?
‚îÇ  ‚îî‚îÄ La tarea que si SOLO hago esto, el d√≠a fue exitoso
‚îú‚îÄ Elegir 2-3 tareas cr√≠ticas m√°ximo
‚îî‚îÄ Ignorar el resto hasta terminar estas
```

**Resultado**: Entras al trabajo con **claridad, energ√≠a y enfoque**

---

## üìä **FASE 2: IDENTIFICAR TU 80/20**

### **A. An√°lisis de Actividades Actuales**

#### **Auditor√≠a de 1 Semana** (Track todo lo que hagas)

| Hora | Actividad | Tiempo | ¬øGenera $? | ¬øEstrat√©gico? | Score |
|------|-----------|--------|-----------|---------------|-------|
| 8:00 | Revisar emails | 45 min | ‚ùå | ‚ùå | 1/10 |
| 9:00 | Reuni√≥n PM | 60 min | ‚úÖ | ‚úÖ | 8/10 |
| 10:00 | Aprobar materiales | 30 min | ‚ö†Ô∏è | ‚ùå | 3/10 |
| 11:00 | Cotizar nuevo proyecto | 90 min | ‚úÖ | ‚úÖ | 9/10 |
| 1:00 | Almuerzo networking | 60 min | ‚úÖ | ‚úÖ | 7/10 |
| 2:00 | Arreglar problema de pintura | 120 min | ‚ùå | ‚ùå | 2/10 |
| 4:00 | Llamada con cliente VIP | 45 min | ‚úÖ | ‚úÖ | 10/10 |

**An√°lisis**:
- ‚úÖ **High Value (20%)**: Cotizaciones, reuniones PM, clientes VIP = **$$$**
- ‚ùå **Low Value (80%)**: Emails, micromanagement, apagar fuegos = **$**

---

### **B. Categor√≠as de Tareas**

#### **CUADRANTE EISENHOWER**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     URGENTE    ‚îÇ    NO URGENTE              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  IMPORTANTE                                                 ‚îÇ
‚îÇ  ‚îú‚îÄ Q1: CRISIS                ‚îÇ  Q2: ESTRAT√âGICO ‚≠ê        ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Apagar fuegos            ‚îÇ  ‚Ä¢ Planificaci√≥n          ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Problemas de obra        ‚îÇ  ‚Ä¢ Cotizaciones           ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Reclamos cliente         ‚îÇ  ‚Ä¢ Desarrollo equipo      ‚îÇ
‚îÇ  ‚îÇ  ‚ö†Ô∏è Minimizar (10%)         ‚îÇ  ‚úÖ Maximizar (70%)       ‚îÇ
‚îÇ  ‚îÇ                             ‚îÇ                            ‚îÇ
‚îÇ  NO IMPORTANTE                                              ‚îÇ
‚îÇ  ‚îú‚îÄ Q3: INTERRUPCIONES        ‚îÇ  Q4: DISTRACCI√ìN          ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Emails no cr√≠ticos       ‚îÇ  ‚Ä¢ Scroll social media    ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Llamadas rutina          ‚îÇ  ‚Ä¢ YouTube                ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Juntas innecesarias      ‚îÇ  ‚Ä¢ Chisme                 ‚îÇ
‚îÇ  ‚îÇ  üóëÔ∏è Delegar (15%)           ‚îÇ  üö´ Eliminar (5%)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**TU OBJETIVO**: Vivir en Q2 (80% de tu tiempo)

---

### **C. Las 3 Actividades 80/20 de un Construction Owner**

#### **1. VENTAS & COTIZACIONES (40% del tiempo)**
```
üéØ Impacto: $100K - $500K por contrato

Actividades:
‚îú‚îÄ Reuniones con clientes potenciales
‚îú‚îÄ Site visits para estimados
‚îú‚îÄ Crear propuestas profesionales
‚îú‚îÄ Follow-up de propuestas enviadas
‚îî‚îÄ Negociar contratos

Delegable: ‚ùå (Eres la cara del negocio)
ROI: 10X (Cada hora invertida = $1,000+ potencial)
```

#### **2. SUPERVISI√ìN ESTRAT√âGICA (30% del tiempo)**
```
üéØ Impacto: Prevenir p√©rdidas de $20K - $50K

Actividades:
‚îú‚îÄ Site visits cr√≠ticos (1x por proyecto/semana)
‚îú‚îÄ Reuniones PM semanales (30 min c/u)
‚îú‚îÄ Revisar fotos de progreso diario
‚îú‚îÄ Aprobar change orders >$5K
‚îî‚îÄ Resolver problemas complejos solo t√∫ puedes

Delegable: ‚ö†Ô∏è Parcial (Entrena a PMs para autonom√≠a)
ROI: 5X (Cada hora = $500 ahorrados en errores)
```

#### **3. RELACIONES CLAVE (20% del tiempo)**
```
üéØ Impacto: Referrals = 60% de nuevos clientes

Actividades:
‚îú‚îÄ Llamadas check-in con clientes VIP
‚îú‚îÄ Networking events (2x/mes)
‚îú‚îÄ Almuerzos con referral partners
‚îú‚îÄ Agradecer referidos con detalle
‚îî‚îÄ Construir relaci√≥n con proveedores TOP

Delegable: ‚ùå (Relaciones personales)
ROI: 8X (Un referral = $50K - $200K proyecto)
```

**Total**: 90% de tu tiempo en estas 3 cosas = **M√°xima rentabilidad**

---

### **D. Lo Que DEBES Delegar (80% de tareas)**

#### **‚ùå OPERACIONES DIARIAS** ‚Üí Delegar a PM/Superintendente
```
- ‚ùå Comprar materiales
- ‚ùå Coordinar entregas
- ‚ùå Manejar schedule diario
- ‚ùå Resolver problemas peque√±os (<$1K)
- ‚ùå Comunicaci√≥n diaria con crew
```

#### **‚ùå ADMINISTRATIVO** ‚Üí Delegar a Office Manager/VA
```
- ‚ùå Data entry en Kibray
- ‚ùå Contestar emails rutina
- ‚ùå Agendar citas
- ‚ùå Procesar facturas
- ‚ùå Filing documentos
```

#### **‚ùå CONTABILIDAD** ‚Üí Delegar a Bookkeeper/CPA
```
- ‚ùå Payroll semanal
- ‚ùå QuickBooks entries
- ‚ùå Reconciliaci√≥n bancaria
- ‚ùå Tax prep
```

**Regla de Oro**: Si alguien puede hacerlo 80% tan bien que t√∫, **DELEGA**.

---

## üèóÔ∏è **FASE 3: IMPLEMENTACI√ìN EN KIBRAY**

### **NUEVA FUNCIONALIDAD: Executive Dashboard 80/20**

#### **Morning Briefing Mejorado con 80/20**

```python
# /core/views.py - Nueva funci√≥n

@login_required
def executive_priming_dashboard(request):
    """
    Dashboard 80/20 para Owner/Executive con enfoque en tareas cr√≠ticas
    """
    if not request.user.profile.role in ['admin', 'owner']:
        return HttpResponseForbidden()
    
    # 1. SECCI√ìN: TU ONE THING HOY
    one_thing = get_most_critical_task_today(request.user)
    
    # 2. SECCI√ìN: TOP 3 PRIORIDADES (80/20)
    top_priorities = [
        {
            'category': 'VENTAS',
            'task': 'Follow-up propuesta ABC Corp ($120K)',
            'impact_score': 10,
            'time_estimate': '45 min',
            'deadline': 'Hoy 2:00 PM'
        },
        {
            'category': 'RELACIONES',
            'task': 'Llamar cliente VIP - Proyecto Referral',
            'impact_score': 9,
            'time_estimate': '20 min',
            'deadline': 'Hoy 4:00 PM'
        },
        {
            'category': 'ESTRAT√âGICO',
            'task': 'Site visit proyecto problem√°tico',
            'impact_score': 8,
            'time_estimate': '60 min',
            'deadline': 'Ma√±ana 9:00 AM'
        }
    ]
    
    # 3. M√âTRICAS 80/20
    metrics = {
        'revenue_this_month': calculate_revenue(),
        'active_proposals': Proposal.objects.filter(status='sent').count(),
        'high_value_clients': Client.objects.filter(lifetime_value__gte=50000),
        'projects_at_risk': get_projects_spi_below_threshold(),
        'pending_approvals': get_items_requiring_owner_approval()
    }
    
    # 4. DISTRACCIONES A IGNORAR
    distractions = {
        'low_priority_emails': Email.objects.filter(priority='low').count(),
        'routine_tasks_delegated': Task.objects.filter(
            assigned_to__role='pm', 
            status='pending'
        ).count(),
    }
    
    context = {
        'one_thing': one_thing,
        'top_priorities': top_priorities,
        'metrics': metrics,
        'distractions': distractions,
        'priming_complete': check_if_priming_done_today(request.user)
    }
    
    return render(request, 'core/executive_priming_dashboard.html', context)


def get_most_critical_task_today(user):
    """
    AI-powered: Identifica la tarea M√ÅS cr√≠tica del d√≠a
    Criterios: Impacto $ + Urgencia + Dependencias
    """
    tasks = Task.objects.filter(
        assigned_to=user,
        status='pending',
        due_date__lte=timezone.now() + timedelta(days=1)
    )
    
    # Score cada tarea
    scored_tasks = []
    for task in tasks:
        score = calculate_impact_score(task)
        scored_tasks.append((task, score))
    
    # Retornar la de mayor score
    if scored_tasks:
        return max(scored_tasks, key=lambda x: x[1])[0]
    return None


def calculate_impact_score(task):
    """
    Score 1-10 basado en impacto potencial
    """
    score = 0
    
    # +5 si es relacionado a ventas/revenue
    if task.category in ['sales', 'proposal', 'client_vip']:
        score += 5
    
    # +3 si previene p√©rdidas grandes
    if task.related_project and task.related_project.budget > 50000:
        score += 3
    
    # +2 si afecta relaciones cr√≠ticas
    if task.client and task.client.lifetime_value > 100000:
        score += 2
    
    # -3 si es operacional/delegable
    if task.category in ['admin', 'materials', 'routine']:
        score -= 3
    
    return max(0, min(10, score))  # Clamp entre 0-10
```

---

### **TEMPLATE: Executive Dashboard**

```html
<!-- /core/templates/core/executive_priming_dashboard.html -->

{% extends 'base.html' %}
{% block content %}

<div class="container-fluid mt-4">
    <!-- PRIMING CHECK -->
    <div class="row mb-4">
        <div class="col-12">
            {% if not priming_complete %}
            <div class="alert alert-warning">
                <h4>‚ö†Ô∏è No has completado tu Priming Matutino</h4>
                <p>15 minutos de preparaci√≥n = 4 horas de productividad</p>
                <button class="btn btn-primary" onclick="startPriming()">
                    Iniciar Priming Ahora
                </button>
            </div>
            {% else %}
            <div class="alert alert-success">
                ‚úÖ Priming completado - Est√°s listo para ejecutar
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ONE THING -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h3>üéØ TU ONE THING HOY</h3>
                    <p class="mb-0">Si SOLO haces esto, el d√≠a fue exitoso</p>
                </div>
                <div class="card-body">
                    {% if one_thing %}
                    <h4>{{ one_thing.title }}</h4>
                    <p class="text-muted">{{ one_thing.description }}</p>
                    <div class="d-flex gap-3">
                        <span class="badge bg-primary">
                            Impacto: {{ one_thing.impact_score }}/10
                        </span>
                        <span class="badge bg-info">
                            Tiempo: {{ one_thing.time_estimate }}
                        </span>
                        <span class="badge bg-warning">
                            Deadline: {{ one_thing.deadline }}
                        </span>
                    </div>
                    <button class="btn btn-success btn-lg mt-3" 
                            onclick="startFocusMode('{{ one_thing.id }}')">
                        üöÄ EMPEZAR AHORA (Modo Focus)
                    </button>
                    {% else %}
                    <p>‚úÖ No hay tareas cr√≠ticas pendientes hoy</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- TOP 3 PRIORITIES (80/20) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4>üéØ TOP 3 PRIORIDADES (El 20% que genera 80%)</h4>
                </div>
                <div class="card-body">
                    {% for priority in top_priorities %}
                    <div class="priority-card mb-3 p-3 border rounded">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="badge bg-{{ priority.category|lower }}">
                                    {{ priority.category }}
                                </span>
                                <h5 class="mt-2">{{ priority.task }}</h5>
                                <small class="text-muted">
                                    ‚è±Ô∏è {{ priority.time_estimate }} | 
                                    üìÖ {{ priority.deadline }}
                                </small>
                            </div>
                            <div class="impact-meter">
                                <div class="circular-progress" data-value="{{ priority.impact_score }}">
                                    <span>{{ priority.impact_score }}/10</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2">
                            Ver Detalles
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- M√âTRICAS EJECUTIVAS -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Revenue Este Mes</h6>
                    <h2 class="text-success">
                        ${{ metrics.revenue_this_month|floatformat:0 }}K
                    </h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Propuestas Activas</h6>
                    <h2 class="text-primary">{{ metrics.active_proposals }}</h2>
                    <small>Valor potencial: ${{ metrics.proposals_value }}K</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Clientes VIP</h6>
                    <h2 class="text-info">{{ metrics.high_value_clients.count }}</h2>
                    <small>LTV: ${{ metrics.total_vip_value }}K</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h6 class="text-muted">Proyectos en Riesgo</h6>
                    <h2 class="text-warning">{{ metrics.projects_at_risk.count }}</h2>
                    {% if metrics.projects_at_risk.count > 0 %}
                    <button class="btn btn-sm btn-warning">Ver Detalles</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- DISTRACCTIONS TO IGNORE -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-header">
                    <h5>üö´ IGNORA ESTO (Ya est√° delegado o puede esperar)</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li>
                            ‚úÖ {{ distractions.low_priority_emails }} emails no urgentes 
                            (Tu asistente los manejar√°)
                        </li>
                        <li>
                            ‚úÖ {{ distractions.routine_tasks_delegated }} tareas de rutina 
                            (PMs las tienen cubiertas)
                        </li>
                        <li>
                            ‚úÖ Reportes autom√°ticos gener√°ndose en background
                        </li>
                    </ul>
                    <p class="text-success mb-0">
                        <strong>üí° Tu equipo tiene esto cubierto. 
                        Enf√≥cate en TU 20%</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- PRIMING TIMER -->
    <div class="modal" id="primingModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h4>üß† Priming Matutino (15 min)</h4>
                </div>
                <div class="modal-body">
                    <!-- Hydration -->
                    <div class="priming-step" data-duration="180">
                        <h5>üíß Paso 1: Hidrataci√≥n + Respiraci√≥n (3 min)</h5>
                        <ul>
                            <li>‚úÖ Beber 500ml agua</li>
                            <li>‚úÖ 3 ciclos de respiraci√≥n 4-7-8</li>
                        </ul>
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Movement -->
                    <div class="priming-step" data-duration="300">
                        <h5>üèÉ Paso 2: Movimiento (5 min)</h5>
                        <ul>
                            <li>20 jumping jacks</li>
                            <li>10 push-ups</li>
                            <li>10 air squats</li>
                        </ul>
                    </div>

                    <!-- Gratitude -->
                    <div class="priming-step" data-duration="180">
                        <h5>üôè Paso 3: Gratitud + Visualizaci√≥n (3 min)</h5>
                        <textarea class="form-control mb-2" 
                                  placeholder="3 cosas por las que estoy agradecido...">
                        </textarea>
                        <textarea class="form-control" 
                                  placeholder="C√≥mo luce el √©xito HOY...">
                        </textarea>
                    </div>

                    <!-- 80/20 Planning -->
                    <div class="priming-step" data-duration="240">
                        <h5>üéØ Paso 4: Planning 80/20 (4 min)</h5>
                        <p><strong>¬øCu√°l es tu ONE THING hoy?</strong></p>
                        <input type="text" class="form-control" 
                               placeholder="La tarea que si SOLO hago esto...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" onclick="completePriming()">
                        ‚úÖ Priming Completado
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function startPriming() {
    $('#primingModal').modal('show');
    // Timer logic aqu√≠
}

function startFocusMode(taskId) {
    // Bloquear notificaciones
    // Modo pantalla completa
    // Timer Pomodoro 45 min
    alert('Focus Mode activado - 45 minutos sin interrupciones');
}

function completePriming() {
    $.post('/api/priming/complete/', {
        'completed_at': new Date().toISOString()
    }).done(function() {
        location.reload();
    });
}
</script>

<style>
.priority-card {
    transition: all 0.3s;
}
.priority-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}
.impact-meter {
    width: 60px;
    height: 60px;
}
.circular-progress {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: conic-gradient(
        #28a745 0% calc(var(--progress) * 1%), 
        #e9ecef calc(var(--progress) * 1%) 100%
    );
}
</style>

{% endblock %}
```

---

## ü§ñ **FASE 4: GENERAR SOPs CON AI**

### **AI-Powered SOP Generator**

```python
# /core/ai_sop_generator.py

from openai import OpenAI
import json

def generate_sop_with_ai(task_description, category='general'):
    """
    Genera un SOP completo usando GPT-4 basado en descripci√≥n breve
    
    Args:
        task_description (str): "Instalar drywall en sala de 12x15 pies"
        category (str): prep, paint, sand, caulk, cleanup, etc.
    
    Returns:
        dict: SOP estructurado listo para guardar en ActivityTemplate
    """
    client = OpenAI(api_key=settings.OPENAI_API_KEY)
    
    prompt = f"""
    Eres un experto en construcci√≥n y pintura con 20 a√±os de experiencia.
    Genera un Standard Operating Procedure (SOP) profesional para:
    
    TAREA: {task_description}
    CATEGOR√çA: {category}
    
    Formato de respuesta (JSON):
    {{
        "name": "T√≠tulo descriptivo del SOP",
        "description": "Descripci√≥n breve (1-2 l√≠neas)",
        "tips": "Consejos profesionales separados por \\n",
        "steps": [
            "Paso 1: Acci√≥n espec√≠fica",
            "Paso 2: Acci√≥n espec√≠fica",
            ...
        ],
        "materials_list": [
            "Material 1 con cantidad",
            "Material 2 con cantidad",
            ...
        ],
        "tools_list": [
            "Herramienta 1",
            "Herramienta 2",
            ...
        ],
        "common_errors": "Errores comunes separados por \\n",
        "time_estimate": 120,  // minutos
        "safety_warnings": "Advertencias de seguridad"
    }}
    
    IMPORTANTE:
    - Pasos detallados pero concisos
    - Cantidades espec√≠ficas de materiales
    - Tips basados en experiencia real
    - Errores comunes que novatos cometen
    - Tiempo realista considerando setup + cleanup
    """
    
    response = client.chat.completions.create(
        model="gpt-4",
        messages=[
            {"role": "system", "content": "Eres un construction expert generando SOPs profesionales"},
            {"role": "user", "content": prompt}
        ],
        response_format={"type": "json_object"},
        temperature=0.7
    )
    
    sop_data = json.loads(response.choices[0].message.content)
    
    # Validar estructura
    required_fields = ['name', 'description', 'steps', 'materials_list', 'tools_list']
    for field in required_fields:
        if field not in sop_data:
            raise ValueError(f"AI response missing required field: {field}")
    
    return sop_data


def improve_existing_sop(sop_id, feedback):
    """
    Mejora un SOP existente basado en feedback de campo
    
    Args:
        sop_id (int): ID del ActivityTemplate
        feedback (str): "Los pasos 3-4 son confusos, falta herramienta X"
    
    Returns:
        dict: SOP mejorado
    """
    sop = ActivityTemplate.objects.get(id=sop_id)
    
    client = OpenAI(api_key=settings.OPENAI_API_KEY)
    
    prompt = f"""
    Tienes un SOP existente que necesita mejorarse basado en feedback real.
    
    SOP ACTUAL:
    Nombre: {sop.name}
    Pasos: {json.dumps(sop.steps)}
    Materiales: {json.dumps(sop.materials_list)}
    Herramientas: {json.dumps(sop.tools_list)}
    
    FEEDBACK DE CAMPO:
    {feedback}
    
    Genera una versi√≥n mejorada del SOP que resuelva el feedback.
    Mant√©n lo que funciona, mejora lo que no.
    """
    
    response = client.chat.completions.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}],
        response_format={"type": "json_object"}
    )
    
    improved_sop = json.loads(response.choices[0].message.content)
    
    # Guardar versi√≥n mejorada
    sop.steps = improved_sop['steps']
    sop.materials_list = improved_sop['materials_list']
    sop.tools_list = improved_sop['tools_list']
    sop.tips = improved_sop.get('tips', sop.tips)
    sop.save()
    
    return improved_sop


# VIEW: SOP Generator Wizard con AI
@login_required
def sop_ai_generator(request):
    """
    Wizard para generar SOPs con AI en 3 pasos
    """
    if request.method == 'POST':
        step = request.POST.get('step')
        
        if step == '1':
            # Usuario describe la tarea
            task_description = request.POST.get('task_description')
            category = request.POST.get('category')
            
            # AI genera SOP completo
            try:
                sop_data = generate_sop_with_ai(task_description, category)
                request.session['ai_sop_draft'] = sop_data
                return JsonResponse({'success': True, 'sop': sop_data})
            except Exception as e:
                return JsonResponse({'error': str(e)}, status=500)
        
        elif step == '2':
            # Usuario revisa y edita
            edited_sop = json.loads(request.POST.get('sop_data'))
            request.session['ai_sop_final'] = edited_sop
            return JsonResponse({'success': True})
        
        elif step == '3':
            # Guardar en BD
            sop_data = request.session.get('ai_sop_final')
            
            sop = ActivityTemplate.objects.create(
                name=sop_data['name'],
                category=sop_data.get('category', 'OTHER'),
                description=sop_data['description'],
                tips=sop_data.get('tips', ''),
                common_errors=sop_data.get('common_errors', ''),
                steps=sop_data['steps'],
                materials_list=sop_data['materials_list'],
                tools_list=sop_data['tools_list'],
                time_estimate=sop_data.get('time_estimate'),
                created_by=request.user,
                is_active=True,
                ai_generated=True  # Flag para trackear SOPs generados por AI
            )
            
            messages.success(request, f"‚ú® SOP '{sop.name}' generado con AI exitosamente!")
            return redirect('sop_library')
    
    return render(request, 'core/sop_ai_generator.html')
```

---

### **TEMPLATE: AI SOP Generator**

```html
<!-- /core/templates/core/sop_ai_generator.html -->

{% extends 'base.html' %}
{% block content %}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-gradient-primary text-white">
                    <h3>ü§ñ Generador de SOPs con AI</h3>
                    <p class="mb-0">Describe la tarea, AI crea el SOP completo</p>
                </div>
                <div class="card-body">
                    <!-- STEP 1: Describir Tarea -->
                    <div id="step1" class="wizard-step">
                        <h4>Paso 1: Describe la tarea</h4>
                        <p class="text-muted">
                            Ejemplo: "Instalar drywall en sala de 12x15 pies con techo de 9 pies"
                        </p>
                        
                        <div class="mb-3">
                            <label>Descripci√≥n de la tarea:</label>
                            <textarea id="taskDescription" 
                                      class="form-control" 
                                      rows="3" 
                                      placeholder="Describe la tarea en detalle...">
                            </textarea>
                        </div>

                        <div class="mb-3">
                            <label>Categor√≠a:</label>
                            <select id="category" class="form-control">
                                <option value="PREP">Preparaci√≥n</option>
                                <option value="PAINT">Pintura</option>
                                <option value="SAND">Lijado</option>
                                <option value="STAIN">Te√±ido</option>
                                <option value="CAULK">Calafateo</option>
                                <option value="CLEANUP">Limpieza</option>
                                <option value="OTHER">Otro</option>
                            </select>
                        </div>

                        <button class="btn btn-primary btn-lg" onclick="generateSOP()">
                            üöÄ Generar SOP con AI
                        </button>
                        <div id="loading" class="mt-3" style="display:none;">
                            <div class="spinner-border text-primary"></div>
                            <p>AI generando SOP profesional... (10-15 seg)</p>
                        </div>
                    </div>

                    <!-- STEP 2: Revisar y Editar -->
                    <div id="step2" class="wizard-step" style="display:none;">
                        <h4>Paso 2: Revisar y Editar</h4>
                        <p class="text-muted">
                            AI gener√≥ este SOP. Revisa y edita si es necesario.
                        </p>

                        <div class="sop-preview" id="sopPreview">
                            <!-- Populated by JS -->
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            <button class="btn btn-outline-secondary" onclick="backToStep1()">
                                ‚Üê Volver
                            </button>
                            <button class="btn btn-success" onclick="saveSOPDraft()">
                                Guardar SOP ‚Üí
                            </button>
                            <button class="btn btn-warning" onclick="regenerateSOPWithFeedback()">
                                üîÑ Regenerar con Cambios
                            </button>
                        </div>
                    </div>

                    <!-- STEP 3: Confirmaci√≥n -->
                    <div id="step3" class="wizard-step" style="display:none;">
                        <div class="text-center py-5">
                            <i class="fas fa-check-circle fa-5x text-success mb-3"></i>
                            <h3>‚úÖ SOP Guardado Exitosamente</h3>
                            <p>El SOP est√° ahora disponible en la biblioteca</p>
                            <div class="d-flex gap-2 justify-content-center mt-4">
                                <a href="{% url 'sop_library' %}" class="btn btn-primary">
                                    Ver Biblioteca de SOPs
                                </a>
                                <button class="btn btn-outline-primary" onclick="createAnother()">
                                    Crear Otro SOP
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Tips Section -->
            <div class="card mt-4 bg-light">
                <div class="card-body">
                    <h5>üí° Tips para mejores resultados:</h5>
                    <ul>
                        <li>‚úÖ S√© espec√≠fico: "Sala 12x15 pies" mejor que "sala peque√±a"</li>
                        <li>‚úÖ Menciona condiciones: "pared con textura" vs "pared lisa"</li>
                        <li>‚úÖ Incluye contexto: "primera capa" vs "touch-up"</li>
                        <li>‚úÖ AI aprende de tus ediciones para mejorar futuras generaciones</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function generateSOP() {
    const taskDescription = document.getElementById('taskDescription').value;
    const category = document.getElementById('category').value;
    
    if (!taskDescription.trim()) {
        alert('Por favor describe la tarea');
        return;
    }
    
    // Show loading
    document.getElementById('loading').style.display = 'block';
    
    try {
        const response = await fetch('/planning/sop/ai-generate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `step=1&task_description=${encodeURIComponent(taskDescription)}&category=${category}`
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Populate Step 2 with AI-generated SOP
            populateSOPPreview(data.sop);
            
            // Switch to Step 2
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error generando SOP: ' + error);
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

function populateSOPPreview(sop) {
    const preview = document.getElementById('sopPreview');
    
    let html = `
        <div class="sop-section">
            <h5>üìù Nombre</h5>
            <input type="text" class="form-control" id="sopName" 
                   value="${sop.name}">
        </div>
        
        <div class="sop-section">
            <h5>üìÑ Descripci√≥n</h5>
            <textarea class="form-control" id="sopDescription" rows="2">
${sop.description}</textarea>
        </div>
        
        <div class="sop-section">
            <h5>‚úÖ Pasos (${sop.steps.length})</h5>
            <ol id="sopSteps">
                ${sop.steps.map((step, i) => `
                    <li class="mb-2">
                        <input type="text" class="form-control" 
                               value="${step}" 
                               data-step="${i}">
                    </li>
                `).join('')}
            </ol>
            <button class="btn btn-sm btn-outline-primary" onclick="addStep()">
                + Agregar Paso
            </button>
        </div>
        
        <div class="sop-section">
            <h5>üõ†Ô∏è Materiales (${sop.materials_list.length})</h5>
            <ul id="sopMaterials">
                ${sop.materials_list.map(m => `<li>${m}</li>`).join('')}
            </ul>
        </div>
        
        <div class="sop-section">
            <h5>üîß Herramientas (${sop.tools_list.length})</h5>
            <ul id="sopTools">
                ${sop.tools_list.map(t => `<li>${t}</li>`).join('')}
            </ul>
        </div>
        
        <div class="sop-section">
            <h5>üí° Tips</h5>
            <textarea class="form-control" id="sopTips" rows="3">
${sop.tips || ''}</textarea>
        </div>
        
        <div class="sop-section">
            <h5>‚ö†Ô∏è Errores Comunes</h5>
            <textarea class="form-control" id="sopErrors" rows="2">
${sop.common_errors || ''}</textarea>
        </div>
        
        <div class="sop-section">
            <h5>‚è±Ô∏è Tiempo Estimado</h5>
            <input type="number" class="form-control" id="sopTime" 
                   value="${sop.time_estimate || 60}" 
                   min="5" step="5">
            <small class="text-muted">Minutos</small>
        </div>
    `;
    
    preview.innerHTML = html;
}

async function saveSOPDraft() {
    // Collect edited data
    const sopData = {
        name: document.getElementById('sopName').value,
        description: document.getElementById('sopDescription').value,
        steps: Array.from(document.querySelectorAll('#sopSteps input')).map(i => i.value),
        materials_list: Array.from(document.querySelectorAll('#sopMaterials li')).map(li => li.textContent),
        tools_list: Array.from(document.querySelectorAll('#sopTools li')).map(li => li.textContent),
        tips: document.getElementById('sopTips').value,
        common_errors: document.getElementById('sopErrors').value,
        time_estimate: parseInt(document.getElementById('sopTime').value),
        category: document.getElementById('category').value
    };
    
    // Save via AJAX
    const response = await fetch('/planning/sop/ai-generate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `step=3&sop_data=${encodeURIComponent(JSON.stringify(sopData))}`
    });
    
    if (response.ok) {
        // Show success
        document.getElementById('step2').style.display = 'none';
        document.getElementById('step3').style.display = 'block';
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.sop-section {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #dee2e6;
}
.sop-section:last-child {
    border-bottom: none;
}
</style>

{% endblock %}
```

---

## üìä **RESULTADOS ESPERADOS**

### **Antes (Sin 80/20)**
```
Jornada t√≠pica:
‚îú‚îÄ 12 horas trabajadas
‚îú‚îÄ 8 horas en "apagar fuegos"
‚îú‚îÄ 2 horas en emails/admin
‚îú‚îÄ 1 hora en reuniones
‚îú‚îÄ 1 hora en trabajo estrat√©gico
‚îî‚îÄ Resultado: Exhausto, poco progreso real
```

### **Despu√©s (Con 80/20)**
```
Jornada optimizada:
‚îú‚îÄ 6 horas trabajadas (enfocado)
‚îú‚îÄ 3 horas en ventas/cotizaciones (40%)
‚îú‚îÄ 2 horas en supervisi√≥n estrat√©gica (30%)
‚îú‚îÄ 1 hora en relaciones clave (20%)
‚îú‚îÄ 0 horas en operaciones (delegado)
‚îî‚îÄ Resultado: 2X revenue, 50% menos estr√©s
```

---

## üéØ **IMPLEMENTACI√ìN 30 D√çAS**

### **Semana 1: Auditor√≠a**
- [ ] Trackear todas tus actividades por 7 d√≠as
- [ ] Identificar tu 20% actual
- [ ] Calcular ROI por hora de cada actividad

### **Semana 2: Delegar**
- [ ] Contratar/entrenar PM para operaciones
- [ ] Contratar VA para admin (Upwork: $8-15/hr)
- [ ] Crear SOPs con AI para tareas delegables

### **Semana 3: Optimizar**
- [ ] Bloquear calendario: 3 horas/d√≠a para tu 20%
- [ ] Implementar Priming matutino
- [ ] Usar Executive Dashboard en Kibray

### **Semana 4: Escalar**
- [ ] Medir: Revenue vs horas trabajadas
- [ ] Ajustar: Qu√© m√°s puedes delegar
- [ ] Repetir: Hasta que 80% de tu tiempo = tu 20%

---

## üìû **SOPORTE**

¬øNecesitas ayuda implementando 80/20?
- Revisa: `FOCUS_WORKFLOW_COMPLETE.md` (ya existe en Kibray)
- Dashboard: `/planning/focus/` (para One Thing diario)
- SOPs: `/planning/sop/library/` (biblioteca completa)

---

**Creado por**: AI Assistant  
**Fecha**: Diciembre 3, 2025  
**Versi√≥n**: 1.0  
**Pr√≥xima revisi√≥n**: 30 d√≠as post-implementaci√≥n
